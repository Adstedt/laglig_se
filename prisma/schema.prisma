// Prisma Schema for Laglig.se
// Database: Supabase PostgreSQL with pgvector extension

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector]
}

// ============================================================================
// CORE MODELS - Epic 1: Foundation
// ============================================================================

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  name           String?
  avatar_url     String?
  password_hash  String?   // NULL for OAuth users (future), Supabase Auth manages passwords
  email_verified Boolean   @default(false)
  created_at     DateTime  @default(now())
  last_login_at  DateTime?

  // Relations
  workspace_members WorkspaceMember[]
  owned_workspaces  Workspace[]       @relation("WorkspaceOwner")

  @@index([email])
  @@map("users")
}

model Workspace {
  id       String @id @default(uuid())
  name     String
  slug     String @unique
  owner_id String
  owner    User   @relation("WorkspaceOwner", fields: [owner_id], references: [id], onDelete: Cascade)

  // Company data from Bolagsverket (populated in Story 4.2)
  org_number         String? @unique
  company_legal_name String?
  sni_code           String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  members WorkspaceMember[]

  @@index([owner_id])
  @@index([org_number])
  @@map("workspaces")
}

model WorkspaceMember {
  id           String @id @default(uuid())
  user_id      String
  workspace_id String
  role         String @default("MEMBER") // OWNER, ADMIN, MEMBER

  user      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  joined_at DateTime @default(now())

  @@unique([user_id, workspace_id])
  @@index([workspace_id])
  @@map("workspace_members")
}

// ============================================================================
// LEGAL CONTENT MODELS - Epic 1: Story 1.5
// ============================================================================

model LegalDocument {
  id               String         @id @default(uuid())
  content_type     ContentType
  document_number  String         @unique // "SFS 1977:1160", "NJA 2023 s. 45"
  title            String
  slug             String         @unique
  summary          String?        @db.Text // AI-generated summary
  full_text        String?        @db.Text // Plain text for RAG, search, embeddings
  html_content     String?        @db.Text // Original HTML for rendering law pages
  effective_date   DateTime?
  publication_date DateTime?
  status           DocumentStatus @default(ACTIVE)
  source_url       String
  metadata         Json? // Type-specific metadata storage (includes filbilaga if present)
  search_vector    Unsupported("tsvector")? // Full-text search
  embedding        Unsupported("vector(1536)")? // Semantic search
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  // Relations
  court_case            CourtCase?
  eu_document           EuDocument?
  source_references     CrossReference[]    @relation("SourceDocument")
  target_references     CrossReference[]    @relation("TargetDocument")
  base_amendments       Amendment[]         @relation("BaseDocument")
  amending_amendments   Amendment[]         @relation("AmendingDocument")
  subjects              DocumentSubject[]
  versions              DocumentVersion[]
  change_events         ChangeEvent[]

  @@index([document_number])
  @@index([slug])
  @@index([content_type])
  @@index([status])
  @@index([search_vector])
  // Story 2.19: Composite indexes for optimized catalogue queries
  @@index([content_type, status, effective_date(sort: Desc)], name: "idx_browse_composite")
  @@index([content_type, effective_date(sort: Desc)], name: "idx_browse_content_date")
  @@index([publication_date(sort: Desc)], name: "idx_publication_date")
  @@map("legal_documents")
}

enum ContentType {
  SFS_LAW
  SFS_AMENDMENT      // Story 2.13: Amendment documents (ändringsförfattningar)
  COURT_CASE_AD
  COURT_CASE_HD
  COURT_CASE_HOVR
  COURT_CASE_HFD
  COURT_CASE_MOD
  COURT_CASE_MIG
  EU_REGULATION
  EU_DIRECTIVE
}

enum DocumentStatus {
  ACTIVE
  REPEALED
  DRAFT
  ARCHIVED
}

enum SummaryGeneratedBy {
  GPT_4
  HUMAN
  SFSR
  RIKSDAGEN
}

enum AmendmentDetectedMethod {
  RIKSDAGEN_TEXT_PARSING
  LAGEN_NU_SCRAPING
  SFSR_REGISTER
  LAGRUMMET_RINFO
}

enum ReferenceType {
  CITES
  IMPLEMENTS
  AMENDS
  REFERENCES
  RELATED
}

enum ChangeType {
  NEW_LAW
  AMENDMENT
  REPEAL
  METADATA_UPDATE
  NEW_RULING
}

// ============================================================================
// TYPE-SPECIFIC TABLES - Epic 2: Story 2.1
// ============================================================================

model CourtCase {
  id            String        @id @default(uuid())
  document_id   String        @unique
  court_name    String // "Högsta domstolen", "Hovrätten över Skåne och Blekinge"
  case_number   String // "B 1234-23"
  lower_court   String?
  decision_date DateTime
  parties       Json? // {plaintiff: "...", defendant: "..."}

  // Relations
  document LegalDocument @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@map("court_cases")
}

model EuDocument {
  id                               String        @id @default(uuid())
  document_id                      String        @unique
  celex_number                     String        @unique // "32016R0679" (GDPR)
  eut_reference                    String? // "L 119/1" (Official Journal reference)
  national_implementation_measures Json? // Swedish implementing laws

  // Relations
  document LegalDocument @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@index([celex_number])
  @@map("eu_documents")
}

model CrossReference {
  id                 String        @id @default(uuid())
  source_document_id String // Document making the reference
  target_document_id String // Document being referenced
  reference_type     ReferenceType
  context            String?       @db.Text // Snippet: "This case interprets § 7 regarding..."
  created_at         DateTime      @default(now())

  // Relations
  source_document LegalDocument @relation("SourceDocument", fields: [source_document_id], references: [id], onDelete: Cascade)
  target_document LegalDocument @relation("TargetDocument", fields: [target_document_id], references: [id], onDelete: Cascade)

  @@index([source_document_id])
  @@index([target_document_id])
  @@map("cross_references")
}

model Amendment {
  id                       String                    @id @default(uuid())
  base_document_id         String // Law being amended (FK to legal_documents)
  amending_document_id     String? // Amending law (FK to legal_documents) - NULL for detected amendments where amending law doesn't exist as separate doc

  // 7 competitive-feature fields
  amending_law_title       String // "Lag (2025:732) om ändring i arbetsrättslagstiftningen"
  publication_date         DateTime? // When amending law was published
  effective_date           DateTime? // When amendment takes effect (can be future)
  affected_sections_raw    String? // Notisum format: "ändr. 6 kap. 17 §; upph. 8 kap. 4 §"
  affected_sections        Json? // Parsed: {amended: ["6:17"], repealed: ["8:4"], new: [], renumbered: []}
  summary                  String?                   @db.Text // 2-3 sentence GPT-4 generated plain language summary (Swedish)
  summary_generated_by     SummaryGeneratedBy?

  // Additional implementation fields
  detected_method          AmendmentDetectedMethod?
  detected_from_version_id String? // FK to DocumentVersion that captured this amendment
  metadata                 Json? // Debugging/additional data

  created_at               DateTime                  @default(now())
  updated_at               DateTime                  @updatedAt

  // Relations
  base_document          LegalDocument    @relation("BaseDocument", fields: [base_document_id], references: [id], onDelete: Cascade)
  amending_document      LegalDocument?   @relation("AmendingDocument", fields: [amending_document_id], references: [id], onDelete: Cascade)
  detected_from_version  DocumentVersion? @relation(fields: [detected_from_version_id], references: [id])

  @@index([base_document_id])
  @@index([amending_document_id])
  @@index([effective_date])
  @@map("amendments")
}

model DocumentSubject {
  id           String   @id @default(uuid())
  document_id  String
  subject_code String // "ARBETSRATT", "DATASKYDD"
  subject_name String // "Arbetsrätt", "Dataskydd & GDPR"
  created_at   DateTime @default(now())

  // Relations
  document LegalDocument @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@unique([document_id, subject_code])
  @@index([document_id])
  @@index([subject_code])
  @@map("document_subjects")
}

// ============================================================================
// AMENDMENT PDF DOCUMENTS - Epic 2: Story 2.13
// ============================================================================

// Stores the amendment document (PDF) itself - one row per SFS amendment number
model AmendmentDocument {
  id              String      @id @default(cuid())
  sfs_number      String      @unique // "2022:1109"

  // Storage
  storage_path    String      // Supabase: "2022/SFS2022-1109.pdf"
  original_url    String      // Source URL for reference
  file_size       Int?        // Bytes

  // Base law reference
  base_law_sfs    String      // "1977:1160" - the law being amended
  base_law_name   String?     // "arbetsmiljölagen"

  // Document metadata
  title           String?     // "Lag om ändring i arbetsmiljölagen (1977:1160)"
  effective_date  DateTime?   // When changes take effect
  publication_date DateTime?  // When published (Utfärdad)

  // Full text for search
  full_text       String?     @db.Text

  // Processing status
  parse_status    ParseStatus @default(PENDING)
  parse_error     String?
  parsed_at       DateTime?
  confidence      Float?      // LLM confidence score (0-1)

  // Timestamps
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  // Relations
  section_changes SectionChange[]

  @@index([base_law_sfs])
  @@index([effective_date])
  @@index([parse_status])
  @@map("amendment_documents")
}

// Individual section changes within an amendment
model SectionChange {
  id              String      @id @default(cuid())
  amendment_id    String

  // Section reference
  chapter         String?     // "7" for "7 kap." or null
  section         String      // "15" or "2a"

  // Change details
  change_type     SectionChangeType
  old_number      String?     // For renumbering: original number
  description     String?     // Brief description of change

  // Text content (extracted from PDF)
  old_text        String?     @db.Text  // Previous text (if available)
  new_text        String?     @db.Text  // New text content

  // Ordering within the amendment
  sort_order      Int         @default(0)

  // Relations
  amendment       AmendmentDocument @relation(fields: [amendment_id], references: [id], onDelete: Cascade)

  @@unique([amendment_id, chapter, section, change_type])
  @@index([amendment_id])
  @@map("section_changes")
}

enum ParseStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  NEEDS_REVIEW
}

enum SectionChangeType {
  AMENDED       // "ska ha följande lydelse"
  REPEALED      // "upphävs", "upphöra att gälla"
  NEW           // "nya paragrafer", "införas"
  RENUMBERED    // "X § blir Y §"
}

// ============================================================================
// VERSION HISTORY & CHANGE TRACKING - Epic 2: Story 2.11
// ============================================================================

model DocumentVersion {
  id               String        @id @default(cuid())
  document_id      String
  version_number   Int
  full_text        String        @db.Text
  html_content     String?       @db.Text
  amendment_sfs    String? // "SFS 2025:732" - which amendment created this version
  source_systemdatum DateTime? // API systemdatum at time of capture
  changed_sections Json? // ["7 §", "12 §"] - sections modified
  created_at       DateTime      @default(now())

  // Relations
  document   LegalDocument @relation(fields: [document_id], references: [id], onDelete: Cascade)
  amendments Amendment[] // Amendments detected from this version

  @@unique([document_id, version_number])
  @@index([document_id])
  @@map("document_versions")
}

model ChangeEvent {
  id                  String      @id @default(cuid())
  document_id         String
  content_type        ContentType
  change_type         ChangeType
  amendment_sfs       String? // "SFS 2025:732"
  previous_version_id String?
  new_version_id      String?
  old_value           String?     @db.Text // For metadata changes
  new_value           String?     @db.Text // For metadata changes
  diff_summary        String?     @db.Text // Unified diff or structured summary
  changed_sections    Json? // Sections that were modified
  ai_summary          String?     @db.Text // GPT-4 generated summary
  ai_summary_generated_at DateTime?
  detected_at         DateTime    @default(now())
  processed_at        DateTime?
  notification_sent   Boolean     @default(false)

  // Relations
  document LegalDocument @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@index([document_id])
  @@index([content_type])
  @@index([change_type])
  @@index([detected_at])
  @@map("change_events")
}
