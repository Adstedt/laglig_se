# Amendment PDF Structure Analysis

## Overview

This document contains the analysis of 12 sample amendment PDFs from Swedish legal sources, conducted as part of Story 2.13 Task 1.1.

**Analysis Date:** 2025-12-11

## Sources Analyzed

### svenskforfattningssamling.se (2018+)

The modern source for Swedish statutes. PDFs are:
- Digitally signed
- Text-based (not scanned)
- Consistently formatted
- ~300-500KB average size

> **Note:** SFS 2018:1653 was removed from fixtures - it was "Lag om företagsnamn" (a NEW law, not an amendment). Only amendment documents (ändringsförfattningar) are in scope for this analysis.


#### 2019:614
- **File:** SFS2019-614.pdf
- **Pages:** 1
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2019-11-15
- **Sections affected:** 2 kap. 8 § (amended)
- **Sample text:** `1 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160) Utfärdad den 10 oktober 2019 Enligt riksdagens beslut1 föreskrivs att 2 kap. 8 § arbetsmiljölagen (1977:1160)2 ska ha följand...`


#### 2020:449
- **File:** SFS2020-449.pdf
- **Pages:** 1
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2020-07-01
- **Sections affected:** 6 kap. 17 § (amended)
- **Sample text:** `1 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160) Utfärdad den 4 juni 2020 Enligt riksdagens beslut1 föreskrivs att 6 kap. 17 § arbetsmiljölagen (1977:1160)2 ska ha följande l...`


#### 2022:1109
- **File:** SFS2022-1109.pdf
- **Pages:** 3
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2022-07-25
- **Sections affected:** *(Complex patterns not yet detected)*
  - Actual: 1 kap. 2 § (amended), 9 kap. 2 § (amended), 9 kap. 5 § (amended), 7 kap. 15-20 §§ (new)
  - Pattern: `1 kap. 2 § och 9 kap. 2 och 5 §§ ska ha följande lydelse` + `nya paragrafer, 7 kap. 15–20 §§`
- **Sample text:** `1 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160) Utfärdad den 22 juni 2022 Enligt riksdagens beslut 1 föreskrivs i fråga om arbetsmilj...`


#### 2023:349
- **File:** SFS2023-349.pdf
- **Pages:** 1
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2023-07-02
- **Sections affected:** 6 kap. 17 § (amended)
- **Sample text:** `11 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160) Utfärdad den 1 juni 2023 Enligt riksdagens beslut1 föreskrivs att 6 kap. 17 § arbetsmi...`


#### 2024:804
- **File:** SFS2024-804.pdf
- **Pages:** 1
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2024-11-08
- **Sections affected:** 8 kap. 4 § (repealed via "ska upphöra att gälla")
- **Sample text:** `1 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160) Utfärdad den 4 oktober 2024 Enligt riksdagens beslut1 föreskrivs i fråga om arbetsmiljölagen (1977:1160)2 dels att 8 kap. 4 §...`


#### 2025:1458
- **File:** SFS2025-1458.pdf
- **Pages:** 3
- **Base law:** miljötillsynsförordningen (2011:13)
- **Effective date:** 2026-01-15
- **Sections affected:** None detected
- **Sample text:** `11 2 3 4 5 6 7 8 9 0 : ; 1 2 3 4 5 6 7 8 9 0 : ; Svensk författningssamling Förordning om ändring i miljötillsynsförordningen (2011:13) Utfärdad den 4 december 2025 Regeringen föreskriver att 2 kap. 1...`


#### 2025:1461
- **File:** SFS2025-1461.pdf
- **Pages:** 14
- **Base law:** lagen (2023:875)
- **Effective date:** 2026-01-01
- **Sections affected:** 27 § (amended)
- **Sample text:** `11 2 3 4 5 6 7 8 9 0 : ; 1 2 3 4 5 6 7 8 9 0 : ; Svensk författningssamling Lag om ändring i lagen (2023:875) om tilläggsskatt Utfärdad den 4 december 2025 Enligt riksdagens beslut1 föreskrivs i fråga...`


### rkrattsdb.gov.se (1998-2018)

The historical archive. PDFs are:
- Smaller file sizes
- May be scanned (older documents)
- Variable formatting


#### 2000:764
- **File:** SFS2000-764-rkrattsdb.pdf
- **Pages:** 2
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2001-01-01
- **Sections affected:** 9 kap. 1 § (repealed)
- **Sample text:** `1 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160); utfärdad den 26 oktober 2000. Enligt riksdagens beslut 1 föreskrivs i fråga om arbetsmiljölagen (1977:1160) 2 , dels att 7 k...`


#### 2003:365
- **File:** SFS2003-365-rkrattsdb.pdf
- **Pages:** 8
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2003-07-21
- **Sections affected:** 9 kap. 3 § (amended)
- **Sample text:** `1 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160); utfärdad den 5 juni 2003. Enligt riksdagens beslut 1 föreskrivs i fråga om arbetsmiljölagen (1977:1160) dels att 1 kap. 2 oc...`


#### 2008:934
- **File:** SFS2008-934-rkrattsdb.pdf
- **Pages:** 6
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2009-01-01
- **Sections affected:** 3 kap. 14 § (repealed), 3 kap. 6 § (new)
- **Sample text:** `1 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160); utfärdad den 20 november 2008. Enligt riksdagens beslut 1 föreskrivs 2 i fråga om arbetsmiljölagen (1977:1160) 3 dels att 3 ...`


#### 2010:1225
- **File:** SFS2010-1225-rkrattsdb.pdf
- **Pages:** 2
- **Base law:** arbetsmiljölagen (1977:1160)
- **Effective date:** 2011-01-01
- **Sections affected:** 3 kap. 2a § (amended)
- **Sample text:** `1 Svensk författningssamling Lag om ändring i arbetsmiljölagen (1977:1160); utfärdad den 18 november 2010. Enligt riksdagens beslut 1 föreskrivs att 3 kap. 2 a § arbetsmiljölagen (1977:1160)2 ska ha f...`


## Common Structure Patterns

### Ingress (Opening Statement)

Most amendment documents begin with:
```
Härigenom föreskrivs [i fråga om / att / om] ...
```

This pattern identifies:
1. The type of legal instrument (lag/förordning)
2. The base law being amended
3. The nature of the changes

### Section Changes

Amendments use specific Swedish legal language:

| Pattern | Meaning |
|---------|---------|
| "X § ska ha följande lydelse" | Section X shall read as follows |
| "X § upphävs" | Section X is repealed |
| "ny X §" / "ny paragraf" | New section X inserted |
| "X kap." | Chapter X |

### Effective Date (Ikraftträdande)

Located at the end of the document:
```
Denna lag träder i kraft den [DATE].
```

Or in transition provisions (Övergångsbestämmelser).

## Regex Patterns for Parsing

### Base Law Detection
```regex
i\s+([^(]+)\s*\((?:SFS\s*)?(\d{4}:\d+)\)
```

### Section Amendment Detection
```regex
(\d+(?:\s*[a-z])?)\s*§\s*ska\s+ha\s+följande\s+lydelse
```

### Section Repeal Detection
```regex
(\d+(?:\s*[a-z])?)\s*§\s*upphävs
```

### Effective Date Detection
```regex
träder\s+i\s+kraft\s+(?:den\s+)?(\d{1,2})\s+(\w+)\s+(\d{4})
```

## Key Findings

1. **Text Extraction Quality:** Modern PDFs (2018+) have excellent text extraction. Older PDFs vary.

2. **Structure Consistency:** Amendment documents follow a consistent structure:
   - Header/metadata
   - Ingress statement
   - Section changes
   - Transition provisions

3. **Detection Challenges:**
   - Complex amendments affecting multiple chapters
   - Renumbered sections
   - References to other laws

4. **Recommendations:**
   - Use pdf-parse for text extraction
   - Implement regex patterns above for structured parsing
   - Consider OCR (tesseract.js) for pre-2000 scanned PDFs
   - Store raw text alongside parsed structures for debugging

## Next Steps

- Task 1.2: Add SFS_AMENDMENT to ContentType enum ✅ DONE
- Task 1.3: Prototype PDF parsing pipeline ✅ DONE
- Task 1.4: Research SE-Lex patterns for additional insights ✅ DONE

---

## Task 1.4: SE-Lex and External Source Research

### SE-Lex Project Overview

The [SE-Lex project](https://github.com/se-lex) provides Swedish legal documents as Git history, where each commit represents an amendment. Key insights:

1. **Repository Structure:** Year-based directories (1821-2025) containing markdown files
2. **File Naming:** `sfs-{year}-{number}.md` pattern
3. **Version Control:** Uses Git commits to track changes over time
4. **License:** MIT - patterns can be referenced (no data import per Architect Decision)

### ELI (European Legislation Identifier) Standard

From the [EU ELI documentation](https://eur-lex.europa.eu/eli-register/what_is_eli.html):

1. **Amendment Support:** ELI handles "modified resources, such as codes, amendments, consolidations and repealed acts"
2. **Impact Tracking:** Publishers can describe "how amendments impact the original text or the most recent consolidated version"
3. **RDF Formats:** Supports RDFa, JSON-LD, and RDF/XML serializations
4. **Swedish Implementation:** Sweden is listed as an ELI implementer

### Relevant Resources

| Resource | URL | Use Case |
|----------|-----|----------|
| N-Lex | https://n-lex.europa.eu/n-lex/info/info-sv/index | EU portal to Swedish law |
| EUR-Lex Technical Info | https://eur-lex.europa.eu/eli-register/technical_information.html | ELI implementation |
| Swedish Parliament API | https://www.riksdagen.se/en/documents-and-laws/ | Official document source |

### Parsing Patterns Derived from Research

Based on analysis of actual PDFs and industry standards:

#### 1. Amendment Document Title Pattern
\`\`\`regex
(?:Lag|Förordning)\s+om\s+ändring\s+i\s+[^(]+\([^)]+\)
\`\`\`

#### 2. Section Change Indicators

| Swedish Pattern | English Meaning | Regex |
|-----------------|-----------------|-------|
| "ska ha följande lydelse" | shall read as follows | \`ska\\s+ha\\s+följande\\s+lydelse\` |
| "upphävs" | is repealed | \`§\\s*upphävs\` |
| "införs" / "tillkommer" | is inserted | \`införs\|tillkommer\` |
| "ändras" | is amended | \`ändras\` |
| "utgår" | is deleted | \`utgår\` |

#### 3. Structural Markers

| Element | Pattern | Example |
|---------|---------|---------|
| Chapter | \`(\d+)\s*kap\.\` | "6 kap." |
| Section | \`(\d+(?:\s*[a-z])?)\s*§\` | "17 §", "2 a §" |
| Effective Date | \`träder\s+i\s+kraft\s+den\s+(\d{1,2}\s+\w+\s+\d{4})\` | "träder i kraft den 1 juli 2028" |
| Publication Date | \`[Uu]tfärdad\s+den\s+(\d{1,2}\s+\w+\s+\d{4})\` | "Utfärdad den 4 december 2025" |

#### 4. Amendment Structure Types

From ELI-DL (ELI for Draft Legislation) ontology:
- **Textual amendments:** Direct text changes to sections
- **Non-textual amendments:** Changes to dates, numbering, references
- **Consolidation:** Merging amendments into base text

### Recommendations for Our Pipeline

1. **PDF Text Extraction:** Use `unpdf` library (proven to work with Swedish PDFs)
2. **Pattern Matching:** Apply regex patterns documented above
3. **Structured Storage:** Store parsed data in `affected_sections` JSON field
4. **Version Reconstruction:** Implement "undo" algorithm for historical versions
5. **Markdown Output:** Generate SE-Lex-compatible markdown for RAG

---

## Amendment Discovery Strategy

### The Problem

Given a base law (e.g., arbetsmiljölagen 1977:1160), how do we find ALL amendments that have been made to it historically?

### Solution: PDF Crawl + Parse Approach

Since amendment PDFs contain the base law reference in their text (e.g., "Lag om ändring i arbetsmiljölagen (1977:1160)"), we can:

1. **Crawl all amendment PDFs** from official sources
2. **Parse each PDF** to extract the `baseLaw` field
3. **Build a relationship mapping**: `amendment_sfs → base_law_sfs`
4. **Store PDFs locally** for reliability and offline access

### Source Crawling Strategy

#### svenskforfattningssamling.se (2018+)

- **Search API:** `https://svenskforfattningssamling.se/sok/?q={year}&type=sfs`
- **Pagination:** 15 results per page, use `&page=N`
- **Document page:** `https://svenskforfattningssamling.se/doc/{sfs_number}.html`
- **PDF URL pattern:** `https://svenskforfattningssamling.se/sites/default/files/sfs/{year-month}/SFS{year}-{number}.pdf`
- **Volume:** ~2,773 documents in 2024 alone

Example PDF URL: `https://svenskforfattningssamling.se/sites/default/files/sfs/2019-10/SFS2019-614.pdf`

#### rkrattsdb.gov.se (1998-2018)

- Historical archive for older documents
- Different URL structure (to be researched)
- May require different crawling approach

### Data Storage Requirements

For each amendment PDF, store:
1. **PDF binary** - Original file for archival/backup
2. **Parsed metadata** - SFS number, base law, effective date, sections affected
3. **Full text** - Extracted text for search/RAG

### Database Schema Additions (proposed)

```prisma
model AmendmentPdf {
  id            String   @id @default(cuid())
  sfsNumber     String   @unique  // e.g., "2019:614"
  baseLawSfs    String   // e.g., "1977:1160"
  baseLawName   String?  // e.g., "arbetsmiljölagen"
  effectiveDate DateTime?
  publicationDate DateTime?
  pdfUrl        String   // Original source URL
  pdfBlob       Bytes    // Stored PDF binary
  fullText      String   // Extracted text
  affectedSections Json  // Parsed sections array
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relation to base law
  baseLaw       LegalDocument? @relation(fields: [baseLawSfs], references: [sfsNumber])
}
```

### Crawl Pipeline Steps

1. **For each year (2018-2025):**
   - Query search: `?q={year}&type=sfs`
   - Paginate through all results
   - Extract document URLs

2. **For each document:**
   - Fetch HTML page
   - Extract PDF URL
   - Download PDF binary
   - Parse with `parsePdf()`
   - Check if title contains "ändring" (is amendment)
   - If amendment: store with base law reference

3. **Build relationship index:**
   - Group amendments by `baseLawSfs`
   - Order by `effectiveDate`
   - Link to `LegalDocument` records

### Estimated Volume

- ~2,500-3,000 documents per year
- ~7 years on svenskforfattningssamling.se = ~17,500-21,000 documents
- Not all are amendments (maybe 60-70% are)
- Estimated ~12,000-15,000 amendment PDFs to process

---

## Supabase Storage Strategy

### Storage Architecture

Store PDFs in Supabase Storage for:
- **Reliability**: No dependency on third-party availability
- **User downloads**: Signed URLs for authenticated access
- **Archival**: Permanent record of historical amendments

### Bucket Structure

```
sfs-amendments/
├── 2018/
│   ├── SFS2018-001.pdf
│   ├── SFS2018-002.pdf
│   └── ...
├── 2019/
│   ├── SFS2019-614.pdf
│   └── ...
└── ...
```

### Database Schema (Updated)

```prisma
model AmendmentDocument {
  id              String   @id @default(cuid())
  sfsNumber       String   @unique  // e.g., "2019:614"

  // Storage
  storagePath     String   // e.g., "sfs-amendments/2019/SFS2019-614.pdf"
  originalUrl     String   // Original source URL for reference
  fileSize        Int      // Bytes

  // Parsed metadata (from LLM)
  baseLawSfs      String   // e.g., "1977:1160"
  baseLawName     String?  // e.g., "arbetsmiljölagen"
  title           String?  // Full title
  effectiveDate   DateTime?
  publicationDate DateTime?

  // Structured changes (from LLM)
  affectedSections Json    // Array of section changes with full details
  fullText        String   // Extracted text @db.Text

  // Processing status
  parseStatus     ParseStatus @default(PENDING)
  parseError      String?
  parsedAt        DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  baseLaw         LegalDocument? @relation(fields: [baseLawSfs], references: [sfsNumber])
}

enum ParseStatus {
  PENDING      // Downloaded, not yet parsed
  PROCESSING   // Currently being parsed by LLM
  COMPLETED    // Successfully parsed
  FAILED       // Parse failed (see parseError)
  NEEDS_REVIEW // Parsed but flagged for human review
}
```

### Supabase Storage Setup

```sql
-- Create bucket for amendment PDFs
INSERT INTO storage.buckets (id, name, public)
VALUES ('sfs-amendments', 'sfs-amendments', false);

-- Policy: Allow authenticated users to read
CREATE POLICY "Authenticated users can download amendments"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'sfs-amendments');

-- Policy: Service role can upload (for crawler)
CREATE POLICY "Service role can upload amendments"
ON storage.objects FOR INSERT
TO service_role
WITH CHECK (bucket_id = 'sfs-amendments');
```

---

## LLM-Assisted Parsing Pipeline

### Why LLM Parsing?

Regex-based parsing has limitations with complex Swedish legal documents:

| Challenge | Regex Limitation | LLM Solution |
|-----------|------------------|--------------|
| Multi-section lists | `1 kap. 2 § och 9 kap. 2 och 5 §§` | Understands conjunctions |
| Section ranges | `7 kap. 15–20 §§` | Expands to individual sections |
| Renumbering | "X § blir Y §" | Understands semantic meaning |
| Transitional rules | Complex temporal logic | Extracts conditions |
| Cross-references | References to other laws | Identifies relationships |

### Hybrid Pipeline Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     PDF Processing Pipeline                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. DOWNLOAD & STORE                                         │
│     ├─ Fetch PDF from source                                │
│     ├─ Upload to Supabase Storage                           │
│     └─ Create AmendmentDocument record (PENDING)            │
│                                                              │
│  2. TEXT EXTRACTION (Fast, Local)                           │
│     ├─ Extract text with unpdf                              │
│     ├─ Extract SFS number from filename                     │
│     └─ Store fullText in database                           │
│                                                              │
│  3. LLM PARSING (Accurate, Thorough)                        │
│     ├─ Send text to Claude API                              │
│     ├─ Structured output with tool_use                      │
│     └─ Parse all amendment details                          │
│                                                              │
│  4. VALIDATION & STORAGE                                    │
│     ├─ Validate LLM output schema                           │
│     ├─ Flag uncertain cases for review                      │
│     └─ Update database with parsed data                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### LLM Parsing Prompt

```typescript
const AMENDMENT_PARSE_PROMPT = `
You are a Swedish legal document parser. Analyze this amendment document (ändringsförfattning) and extract structured data.

<document>
{fullText}
</document>

Extract the following information:

1. **Base Law**: The law being amended
   - Name (e.g., "arbetsmiljölagen")
   - SFS number (e.g., "1977:1160")

2. **Effective Date**: When the amendment takes effect
   - Date in ISO format (YYYY-MM-DD)
   - Note any delayed effectiveness for specific sections

3. **Affected Sections**: ALL changes made by this amendment
   For each change, identify:
   - Chapter (kap.) if applicable
   - Section (§) number
   - Change type: "amended" | "repealed" | "new" | "renumbered"
   - For renumbering: old number → new number
   - Brief description of the change

4. **Transitional Provisions**: Any övergångsbestämmelser
   - Conditions
   - Time limits
   - Special rules

Return as structured JSON.
`;
```

### LLM Tool Schema

```typescript
const parseAmendmentTool = {
  name: "parse_amendment",
  description: "Parse a Swedish amendment document",
  input_schema: {
    type: "object",
    properties: {
      baseLaw: {
        type: "object",
        properties: {
          name: { type: "string" },
          sfsNumber: { type: "string", pattern: "^\\d{4}:\\d+$" }
        },
        required: ["sfsNumber"]
      },
      effectiveDate: {
        type: "string",
        format: "date"
      },
      affectedSections: {
        type: "array",
        items: {
          type: "object",
          properties: {
            chapter: { type: "string", nullable: true },
            section: { type: "string" },
            changeType: {
              type: "string",
              enum: ["amended", "repealed", "new", "renumbered"]
            },
            oldNumber: { type: "string", nullable: true },
            description: { type: "string" }
          },
          required: ["section", "changeType"]
        }
      },
      transitionalProvisions: {
        type: "array",
        items: {
          type: "object",
          properties: {
            condition: { type: "string" },
            effectiveUntil: { type: "string", nullable: true }
          }
        }
      },
      confidence: {
        type: "number",
        minimum: 0,
        maximum: 1,
        description: "Confidence score for the parse quality"
      }
    },
    required: ["baseLaw", "affectedSections"]
  }
};
```

### Cost Estimation

Using Claude 3.5 Haiku for parsing:
- Average amendment PDF: ~2,000 tokens input
- Structured output: ~500 tokens
- Cost per document: ~$0.002

For 15,000 amendments: **~$30 total**

### Processing Strategy

1. **Batch processing**: Process in batches of 100 with rate limiting
2. **Retry logic**: Exponential backoff for API failures
3. **Confidence threshold**: Flag documents with confidence < 0.8 for review
4. **Caching**: Store raw LLM responses for debugging/reprocessing
