# Story 6.2: Create Kanban Compliance Workspace

## Status
Draft

## Story

**As a** user,
**I want** to organize laws in a Kanban board,
**so that** I track progress from "Not Started" to "Compliant".

## Acceptance Criteria

1. Kanban page created at `/workspace`
2. Five columns: Not Started, In Progress, Blocked, Review, Compliant
3. Each law in user's law list displayed as card in appropriate column
4. Law cards show: title, category badge, priority (High/Medium/Low), assigned employee (if any)
5. Drag-and-drop to move cards between columns
6. Column headers show count: "In Progress (5)"
7. Cards persist position after refresh
8. "Add Law" button in each column
9. Empty state: "No laws in this column yet"
10. Mobile: Horizontal scroll for columns, or vertical stack with section headers

## Tasks / Subtasks

- [ ] Create Kanban workspace page at `/workspace`
- [ ] Implement 5-column layout with responsive design
- [ ] Build law card component with all required fields
- [ ] Fetch laws grouped by status
- [ ] Implement drag-and-drop functionality (Story 6.5)
- [ ] Add column headers with law counts
- [ ] Implement "Add Law" button per column
- [ ] Create empty state for columns with no laws
- [ ] Test mobile horizontal scroll and vertical stack layouts
- [ ] Persist card positions after page refresh

## Dev Notes

**Kanban Workspace Page:**
```typescript
// app/workspace/page.tsx
import { Suspense } from 'react'
import { KanbanBoard } from '@/components/kanban/kanban-board'
import { KanbanToolbar } from '@/components/kanban/kanban-toolbar'
import { KanbanSkeleton } from '@/components/kanban/kanban-skeleton'

export default function WorkspacePage() {
  return (
    <div className="h-screen flex flex-col bg-gray-50">
      {/* Toolbar */}
      <KanbanToolbar />

      {/* Kanban Board */}
      <div className="flex-1 overflow-hidden">
        <Suspense fallback={<KanbanSkeleton />}>
          <KanbanBoard />
        </Suspense>
      </div>
    </div>
  )
}
```

**Kanban Board Component:**
```typescript
// components/kanban/kanban-board.tsx
import { getWorkspaceLawsByStatus } from '@/lib/kanban/get-laws-by-status'
import { KanbanColumn } from './kanban-column'

const COLUMNS = [
  { id: 'not_started', label: 'Not Started', color: 'gray' },
  { id: 'in_progress', label: 'In Progress', color: 'blue' },
  { id: 'blocked', label: 'Blocked', color: 'red' },
  { id: 'review', label: 'Review', color: 'yellow' },
  { id: 'compliant', label: 'Compliant', color: 'green' }
] as const

export async function KanbanBoard() {
  const lawsByStatus = await getWorkspaceLawsByStatus()

  return (
    <div className="h-full p-6 overflow-x-auto">
      {/* Desktop: Horizontal columns */}
      <div className="hidden md:flex gap-4 h-full min-w-max">
        {COLUMNS.map((column) => (
          <KanbanColumn
            key={column.id}
            id={column.id}
            label={column.label}
            color={column.color}
            laws={lawsByStatus[column.id] || []}
          />
        ))}
      </div>

      {/* Mobile: Vertical stack with section headers */}
      <div className="md:hidden space-y-6">
        {COLUMNS.map((column) => (
          <div key={column.id} className="bg-white rounded-lg shadow">
            {/* Section Header */}
            <div className={`px-4 py-3 border-b border-${column.color}-200 bg-${column.color}-50`}>
              <h2 className="font-semibold text-gray-900">
                {column.label}
                <span className="ml-2 text-sm text-gray-600">
                  ({lawsByStatus[column.id]?.length || 0})
                </span>
              </h2>
            </div>

            {/* Laws in Section */}
            <div className="p-4 space-y-3">
              {lawsByStatus[column.id]?.length === 0 ? (
                <p className="text-sm text-gray-500 text-center py-8">
                  No laws in this column yet
                </p>
              ) : (
                lawsByStatus[column.id]?.map((law) => (
                  <LawCard key={law.id} law={law} />
                ))
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
```

**Kanban Column Component:**
```typescript
// components/kanban/kanban-column.tsx
'use client'

import { useState } from 'react'
import { LawCard } from './law-card'
import { AddLawButton } from './add-law-button'

interface KanbanColumnProps {
  id: string
  label: string
  color: string
  laws: any[]
}

export function KanbanColumn({ id, label, color, laws }: KanbanColumnProps) {
  return (
    <div className="flex flex-col w-80 bg-gray-100 rounded-lg flex-shrink-0">
      {/* Column Header */}
      <div className="p-4 border-b border-gray-200">
        <div className="flex items-center justify-between mb-2">
          <h2 className="font-semibold text-gray-900">
            {label}
          </h2>
          <span className={`px-2 py-1 text-sm font-medium rounded bg-${color}-100 text-${color}-700`}>
            {laws.length}
          </span>
        </div>

        {/* Add Law Button */}
        <AddLawButton columnId={id} />
      </div>

      {/* Column Body - Scrollable */}
      <div className="flex-1 p-3 space-y-3 overflow-y-auto">
        {laws.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <svg
              className="w-12 h-12 text-gray-300 mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <p className="text-sm text-gray-500">
              No laws in this column yet
            </p>
          </div>
        ) : (
          laws.map((law) => (
            <LawCard
              key={law.id}
              law={law}
            />
          ))
        )}
      </div>

      {/* Column Footer - Optional Stats */}
      {laws.length > 0 && (
        <div className="p-3 border-t border-gray-200 bg-white rounded-b-lg">
          <p className="text-xs text-gray-600">
            {laws.filter((l) => l.priority === 'high').length} high priority
          </p>
        </div>
      )}
    </div>
  )
}
```

**Law Card Component:**
```typescript
// components/kanban/law-card.tsx
'use client'

import { useState } from 'react'
import Link from 'next/link'

interface LawCardProps {
  law: {
    id: string
    lawId: string
    lawTitle: string
    lawSfsNumber: string
    category: string
    priority: 'high' | 'medium' | 'low' | null
    assignedEmployees: {
      id: string
      name: string
      email: string
    }[]
    taskProgress?: {
      completed: number
      total: number
    }
  }
}

export function LawCard({ law }: LawCardProps) {
  const [isHovered, setIsHovered] = useState(false)

  const priorityColors = {
    high: 'bg-red-100 text-red-700 border-red-200',
    medium: 'bg-yellow-100 text-yellow-700 border-yellow-200',
    low: 'bg-gray-100 text-gray-700 border-gray-200'
  }

  const categoryColors = {
    'Arbetsrätt': 'bg-blue-100 text-blue-700',
    'Arbetsmiljö': 'bg-green-100 text-green-700',
    'GDPR': 'bg-purple-100 text-purple-700',
    'Skatt': 'bg-orange-100 text-orange-700',
    'Övrigt': 'bg-gray-100 text-gray-700'
  }

  return (
    <div
      className={`bg-white rounded-lg border-2 ${
        isHovered ? 'border-blue-300 shadow-lg' : 'border-gray-200'
      } p-4 cursor-pointer transition-all hover:shadow-md`}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      onClick={() => {
        // Will open modal in Story 6.3
        console.log('Open law modal:', law.id)
      }}
    >
      {/* Priority & Category Badges */}
      <div className="flex items-center gap-2 mb-3">
        {law.priority && (
          <span
            className={`px-2 py-1 text-xs font-medium rounded border ${
              priorityColors[law.priority]
            }`}
          >
            {law.priority === 'high' ? 'High' : law.priority === 'medium' ? 'Med' : 'Low'}
          </span>
        )}

        <span
          className={`px-2 py-1 text-xs font-medium rounded ${
            categoryColors[law.category as keyof typeof categoryColors] || categoryColors['Övrigt']
          }`}
        >
          {law.category}
        </span>
      </div>

      {/* Law Title */}
      <h3 className="font-semibold text-gray-900 mb-2 line-clamp-2">
        {law.lawTitle}
      </h3>

      {/* SFS Number */}
      <p className="text-xs text-gray-500 mb-3">
        {law.lawSfsNumber}
      </p>

      {/* Task Progress */}
      {law.taskProgress && law.taskProgress.total > 0 && (
        <div className="mb-3">
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs text-gray-600">Tasks</span>
            <span className="text-xs text-gray-600">
              {law.taskProgress.completed}/{law.taskProgress.total}
            </span>
          </div>
          <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
            <div
              className="h-full bg-blue-500 transition-all duration-300"
              style={{
                width: `${(law.taskProgress.completed / law.taskProgress.total) * 100}%`
              }}
            />
          </div>
        </div>
      )}

      {/* Assigned Employees */}
      {law.assignedEmployees.length > 0 && (
        <div className="flex items-center gap-2">
          <div className="flex -space-x-2">
            {law.assignedEmployees.slice(0, 3).map((employee) => (
              <div
                key={employee.id}
                className="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-semibold border-2 border-white"
                title={employee.name || employee.email}
              >
                {(employee.name || employee.email)[0].toUpperCase()}
              </div>
            ))}
          </div>
          {law.assignedEmployees.length > 3 && (
            <span className="text-xs text-gray-600">
              +{law.assignedEmployees.length - 3}
            </span>
          )}
        </div>
      )}

      {/* Quick Actions (show on hover) */}
      {isHovered && (
        <div className="mt-3 pt-3 border-t border-gray-200 flex gap-2">
          <button
            onClick={(e) => {
              e.stopPropagation()
              // Open in new tab
              window.open(`/laws/${law.lawId}`, '_blank')
            }}
            className="flex-1 text-xs text-blue-600 hover:text-blue-700 font-medium"
          >
            View Details
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation()
              // Open chat with law context
              window.location.href = `/dashboard?open=chat&lawId=${law.lawId}`
            }}
            className="flex-1 text-xs text-blue-600 hover:text-blue-700 font-medium"
          >
            Ask AI
          </button>
        </div>
      )}
    </div>
  )
}
```

**Add Law Button Component:**
```typescript
// components/kanban/add-law-button.tsx
'use client'

import { useRouter } from 'next/navigation'

interface AddLawButtonProps {
  columnId: string
}

export function AddLawButton({ columnId }: AddLawButtonProps) {
  const router = useRouter()

  return (
    <button
      onClick={() => router.push(`/laws/add?status=${columnId}`)}
      className="w-full flex items-center justify-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-white rounded border border-dashed border-gray-300 hover:border-gray-400 transition-colors"
    >
      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M12 6v6m0 0v6m0-6h6m-6 0H6"
        />
      </svg>
      Add Law
    </button>
  )
}
```

**Get Laws By Status Helper:**
```typescript
// lib/kanban/get-laws-by-status.ts
import { prisma } from '@/lib/prisma'
import { withWorkspace } from '@/lib/auth/with-workspace'

export async function getWorkspaceLawsByStatus() {
  return withWorkspace(async ({ workspaceId }) => {
    // Fetch all workspace laws with related data
    const laws = await prisma.workspaceLaw.findMany({
      where: { workspaceId },
      include: {
        law: {
          include: {
            categories: {
              include: {
                category: true
              },
              take: 1
            }
          }
        },
        assignedEmployees: {
          include: {
            employee: {
              select: {
                id: true,
                name: true,
                email: true
              }
            }
          }
        },
        tasks: {
          select: {
            id: true,
            completed: true
          }
        }
      },
      orderBy: [
        { priority: 'desc' }, // high > medium > low
        { addedAt: 'desc' }
      ]
    })

    // Group laws by status
    const grouped: Record<string, any[]> = {
      not_started: [],
      in_progress: [],
      blocked: [],
      review: [],
      compliant: []
    }

    laws.forEach((wl) => {
      const status = wl.status || 'not_started'

      grouped[status].push({
        id: wl.id,
        lawId: wl.lawId,
        lawTitle: wl.law.title,
        lawSfsNumber: wl.law.sfsNumber,
        category: wl.law.categories[0]?.category.name || 'Övrigt',
        priority: wl.priority,
        assignedEmployees: wl.assignedEmployees.map((ae) => ({
          id: ae.employee.id,
          name: ae.employee.name,
          email: ae.employee.email
        })),
        taskProgress: {
          completed: wl.tasks.filter((t) => t.completed).length,
          total: wl.tasks.length
        }
      })
    })

    return grouped
  })
}
```

**Kanban Toolbar:**
```typescript
// components/kanban/kanban-toolbar.tsx
'use client'

import { useState } from 'react'
import Link from 'next/link'

export function KanbanToolbar() {
  return (
    <div className="bg-white border-b border-gray-200 px-6 py-4">
      <div className="flex items-center justify-between">
        {/* Left: Title */}
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Compliance Workspace</h1>
          <p className="text-sm text-gray-600 mt-1">
            Manage your compliance progress
          </p>
        </div>

        {/* Right: Actions */}
        <div className="flex items-center gap-3">
          {/* Filter Button (Story 6.6) */}
          <button className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
              />
            </svg>
            <span className="text-sm font-medium">Filters</span>
          </button>

          {/* Export Button (Story 6.10) */}
          <button className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
              />
            </svg>
            <span className="text-sm font-medium">Export</span>
          </button>

          {/* Add Law Button */}
          <Link
            href="/laws/add"
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              />
            </svg>
            <span className="text-sm font-medium">Add Law</span>
          </Link>
        </div>
      </div>
    </div>
  )
}
```

**Kanban Skeleton:**
```typescript
// components/kanban/kanban-skeleton.tsx
export function KanbanSkeleton() {
  return (
    <div className="h-full p-6 overflow-x-auto">
      <div className="flex gap-4 h-full min-w-max">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="w-80 bg-gray-100 rounded-lg flex-shrink-0 animate-pulse">
            {/* Column Header */}
            <div className="p-4 border-b border-gray-200">
              <div className="h-6 w-32 bg-gray-300 rounded mb-2"></div>
              <div className="h-8 bg-gray-300 rounded"></div>
            </div>

            {/* Column Body */}
            <div className="p-3 space-y-3">
              {[...Array(3)].map((_, j) => (
                <div key={j} className="h-40 bg-gray-300 rounded"></div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
```

**Database Schema Updates:**
```prisma
model WorkspaceLaw {
  id           String   @id @default(uuid())
  workspaceId  String
  lawId        String
  status       String   @default("not_started") // not_started, in_progress, blocked, review, compliant
  priority     String?  // high, medium, low
  notes        String?  @db.Text
  dueDate      DateTime?
  tags         String[] // Custom tags
  addedAt      DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace          Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  law                Law       @relation(fields: [lawId], references: [id])
  assignedEmployees  WorkspaceLawEmployee[]
  tasks              LawTask[]

  @@unique([workspaceId, lawId])
  @@index([workspaceId, status])
  @@index([workspaceId, priority])
  @@map("workspace_laws")
}

model WorkspaceLawEmployee {
  workspaceLawId String
  employeeId     String
  assignedAt     DateTime @default(now())

  workspaceLaw WorkspaceLaw @relation(fields: [workspaceLawId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@id([workspaceLawId, employeeId])
  @@map("workspace_law_employees")
}

model LawTask {
  id             String   @id @default(uuid())
  workspaceLawId String
  title          String
  description    String?  @db.Text
  assignedTo     String?  // Employee ID
  dueDate        DateTime?
  completed      Boolean  @default(false)
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspaceLaw WorkspaceLaw @relation(fields: [workspaceLawId], references: [id], onDelete: Cascade)

  @@index([workspaceLawId])
  @@index([assignedTo])
  @@map("law_tasks")
}
```

**Mobile-Responsive Styles:**
```css
/* For horizontal scroll on mobile (alternative to vertical stack) */
@media (max-width: 768px) {
  .kanban-board-mobile-scroll {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
    scroll-snap-type: x mandatory;
  }

  .kanban-column-mobile {
    min-width: 85vw;
    scroll-snap-align: start;
  }
}
```

**Reference:** PRD Epic 6 Story 6.2, Architecture Section 14 (Compliance Workspace)

## Testing

**Unit Tests:**
- `getWorkspaceLawsByStatus()` groups laws correctly by status
- Empty columns return empty array
- Task progress calculation is accurate
- Laws prioritized correctly within each column

**Integration Tests:**
- Create laws with different statuses, verify correct column placement
- Assign employees to law, verify avatars appear on card
- Add tasks to law, verify progress bar shows correct percentage
- Click "Add Law" button, verify navigates to add law page with status pre-filled
- Mobile view stacks columns vertically or enables horizontal scroll

**Manual Testing:**
- Add 10+ laws across all 5 columns, verify layout
- Verify law cards show all required information (title, SFS, category, priority, employees)
- Test empty state in columns with no laws
- Hover over card, verify quick actions appear
- Test mobile layout on phone (horizontal scroll or vertical stack)
- Verify card positions persist after page refresh
- Test with 100+ laws, verify performance

**Performance Testing:**
- Kanban loads <500ms with 100 laws
- No layout shift during loading (skeleton prevents CLS)
- Smooth scrolling in columns with many cards

**Accessibility Testing:**
- Keyboard navigation works (Tab through cards)
- Screen reader announces column names and card counts
- Color contrast meets WCAG AA standards
- Focus indicators visible on cards

**Test File:** `__tests__/features/kanban/board.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Organize laws into appropriate columns
- Update law status by dragging between columns (Story 6.5)
- Assign employees to laws for accountability
- Review and update law priorities

**Developer Responsibility:**
- Group laws by status accurately
- Persist card positions after refresh
- Optimize for smooth scrolling with many cards
- Implement responsive mobile layout
- Provide clear empty states
- Show accurate task progress on cards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
