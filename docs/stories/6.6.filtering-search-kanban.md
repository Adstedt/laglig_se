# Story 6.6: Add Filtering and Search to Kanban

## Status

Draft

## Story

**As a** user,
**I want** to filter laws on the Kanban board,
**so that** I focus on specific categories or priorities.

## Acceptance Criteria

1. Filter bar above Kanban board
2. Filters available:
   - Category (multi-select dropdown)
   - Priority (High/Medium/Low)
   - Assigned employee (dropdown)
   - Tags (multi-select)
3. Search input filters by law title
4. Filters stack (AND logic): Category=Arbetsrätt AND Priority=High
5. Filtered results shown immediately (client-side filtering)
6. Clear filters button
7. Filter state persisted in URL query params
8. Mobile: Filters in collapsible section

## Tasks / Subtasks

- [ ] Create filter bar component above Kanban
- [ ] Implement category multi-select filter
- [ ] Implement priority filter
- [ ] Implement assigned employee filter
- [ ] Implement tags multi-select filter
- [ ] Add search input for law title
- [ ] Implement AND logic for stacked filters
- [ ] Create "Clear filters" button
- [ ] Persist filter state in URL query params
- [ ] Implement mobile collapsible filter section
- [ ] Test filter combinations

## Dev Notes

**Filter Bar Component:**

```typescript
// components/kanban/filter-bar.tsx
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { MultiSelect } from '@/components/ui/multi-select'

interface FilterBarProps {
  categories: string[]
  employees: { id: string; name: string }[]
  allTags: string[]
}

export function FilterBar({ categories, employees, allTags }: FilterBarProps) {
  const router = useRouter()
  const searchParams = useSearchParams()
  const [isExpanded, setIsExpanded] = useState(true)

  // Initialize filters from URL
  const [searchQuery, setSearchQuery] = useState(searchParams.get('search') || '')
  const [selectedCategories, setSelectedCategories] = useState<string[]>(
    searchParams.get('categories')?.split(',').filter(Boolean) || []
  )
  const [selectedPriority, setSelectedPriority] = useState(searchParams.get('priority') || '')
  const [selectedEmployee, setSelectedEmployee] = useState(searchParams.get('employee') || '')
  const [selectedTags, setSelectedTags] = useState<string[]>(
    searchParams.get('tags')?.split(',').filter(Boolean) || []
  )

  // Update URL when filters change
  useEffect(() => {
    const params = new URLSearchParams()

    if (searchQuery) params.set('search', searchQuery)
    if (selectedCategories.length > 0) params.set('categories', selectedCategories.join(','))
    if (selectedPriority) params.set('priority', selectedPriority)
    if (selectedEmployee) params.set('employee', selectedEmployee)
    if (selectedTags.length > 0) params.set('tags', selectedTags.join(','))

    const queryString = params.toString()
    const newUrl = queryString ? `/workspace?${queryString}` : '/workspace'

    router.replace(newUrl, { scroll: false })
  }, [searchQuery, selectedCategories, selectedPriority, selectedEmployee, selectedTags])

  function clearFilters() {
    setSearchQuery('')
    setSelectedCategories([])
    setSelectedPriority('')
    setSelectedEmployee('')
    setSelectedTags([])
  }

  const hasActiveFilters =
    searchQuery ||
    selectedCategories.length > 0 ||
    selectedPriority ||
    selectedEmployee ||
    selectedTags.length > 0

  return (
    <div className="bg-white border-b border-gray-200 px-6 py-4">
      {/* Mobile: Collapsible Filter Toggle */}
      <div className="md:hidden mb-4">
        <button
          onClick={() => setIsExpanded(!isExpanded)}
          className="flex items-center justify-between w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
        >
          <div className="flex items-center gap-2">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
              />
            </svg>
            <span className="text-sm font-medium">Filters</span>
            {hasActiveFilters && (
              <span className="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full">
                {[
                  searchQuery ? 1 : 0,
                  selectedCategories.length,
                  selectedPriority ? 1 : 0,
                  selectedEmployee ? 1 : 0,
                  selectedTags.length
                ]
                  .filter(Boolean)
                  .reduce((a, b) => a + b, 0)}
              </span>
            )}
          </div>
          <svg
            className={`w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''}`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </button>
      </div>

      {/* Filters */}
      <div
        className={`${
          isExpanded ? 'block' : 'hidden md:block'
        } grid grid-cols-1 md:grid-cols-6 gap-3`}
      >
        {/* Search */}
        <div className="md:col-span-2">
          <div className="relative">
            <svg
              className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search laws..."
              className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>

        {/* Category Filter */}
        <div>
          <MultiSelect
            options={categories.map((cat) => ({ value: cat, label: cat }))}
            value={selectedCategories}
            onChange={setSelectedCategories}
            placeholder="Category"
          />
        </div>

        {/* Priority Filter */}
        <div>
          <select
            value={selectedPriority}
            onChange={(e) => setSelectedPriority(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Priorities</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>

        {/* Assigned Employee Filter */}
        <div>
          <select
            value={selectedEmployee}
            onChange={(e) => setSelectedEmployee(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Employees</option>
            {employees.map((emp) => (
              <option key={emp.id} value={emp.id}>
                {emp.name}
              </option>
            ))}
          </select>
        </div>

        {/* Tags Filter */}
        <div>
          <MultiSelect
            options={allTags.map((tag) => ({ value: tag, label: tag }))}
            value={selectedTags}
            onChange={setSelectedTags}
            placeholder="Tags"
          />
        </div>

        {/* Clear Filters Button */}
        {hasActiveFilters && (
          <div className="md:col-span-6 flex justify-end">
            <button
              onClick={clearFilters}
              className="px-4 py-2 text-sm text-gray-700 hover:text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
              Clear Filters
            </button>
          </div>
        )}
      </div>
    </div>
  )
}
```

**Multi-Select Component:**

```typescript
// components/ui/multi-select.tsx
'use client'

import { useState, useRef, useEffect } from 'react'

interface MultiSelectProps {
  options: { value: string; label: string }[]
  value: string[]
  onChange: (value: string[]) => void
  placeholder: string
}

export function MultiSelect({ options, value, onChange, placeholder }: MultiSelectProps) {
  const [isOpen, setIsOpen] = useState(false)
  const dropdownRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  function toggleOption(optionValue: string) {
    if (value.includes(optionValue)) {
      onChange(value.filter((v) => v !== optionValue))
    } else {
      onChange([...value, optionValue])
    }
  }

  return (
    <div ref={dropdownRef} className="relative">
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="w-full px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center justify-between text-left"
      >
        <span className="text-sm truncate">
          {value.length === 0
            ? placeholder
            : value.length === 1
            ? value[0]
            : `${value.length} selected`}
        </span>
        <svg
          className={`w-4 h-4 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
          {options.map((option) => (
            <label
              key={option.value}
              className="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer"
            >
              <input
                type="checkbox"
                checked={value.includes(option.value)}
                onChange={() => toggleOption(option.value)}
                className="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <span className="text-sm text-gray-900">{option.label}</span>
            </label>
          ))}
        </div>
      )}
    </div>
  )
}
```

**Client-Side Filtering Logic:**

```typescript
// components/kanban/kanban-board-filtered.tsx
'use client'

import { useMemo } from 'react'
import { useSearchParams } from 'next/navigation'
import { KanbanBoardClient } from './kanban-board'

interface KanbanBoardFilteredProps {
  initialLawsByStatus: any
}

export function KanbanBoardFiltered({ initialLawsByStatus }: KanbanBoardFilteredProps) {
  const searchParams = useSearchParams()

  // Get filter values from URL
  const searchQuery = searchParams.get('search') || ''
  const selectedCategories = searchParams.get('categories')?.split(',').filter(Boolean) || []
  const selectedPriority = searchParams.get('priority') || ''
  const selectedEmployee = searchParams.get('employee') || ''
  const selectedTags = searchParams.get('tags')?.split(',').filter(Boolean) || []

  // Apply filters (client-side)
  const filteredLawsByStatus = useMemo(() => {
    const filtered: Record<string, any[]> = {}

    for (const status in initialLawsByStatus) {
      filtered[status] = initialLawsByStatus[status].filter((law: any) => {
        // Search filter (law title)
        if (searchQuery && !law.lawTitle.toLowerCase().includes(searchQuery.toLowerCase())) {
          return false
        }

        // Category filter (AND logic for multi-select)
        if (
          selectedCategories.length > 0 &&
          !selectedCategories.includes(law.category)
        ) {
          return false
        }

        // Priority filter
        if (selectedPriority && law.priority !== selectedPriority) {
          return false
        }

        // Assigned employee filter
        if (
          selectedEmployee &&
          !law.assignedEmployees.some((emp: any) => emp.id === selectedEmployee)
        ) {
          return false
        }

        // Tags filter (AND logic for multi-select)
        if (
          selectedTags.length > 0 &&
          !selectedTags.every((tag) => law.tags?.includes(tag))
        ) {
          return false
        }

        return true
      })
    }

    return filtered
  }, [
    initialLawsByStatus,
    searchQuery,
    selectedCategories,
    selectedPriority,
    selectedEmployee,
    selectedTags
  ])

  return <KanbanBoardClient initialLawsByStatus={filteredLawsByStatus} />
}
```

**Updated Kanban Page with Filters:**

```typescript
// app/workspace/page.tsx (updated)
import { Suspense } from 'react'
import { KanbanBoardFiltered } from '@/components/kanban/kanban-board-filtered'
import { FilterBar } from '@/components/kanban/filter-bar'
import { KanbanToolbar } from '@/components/kanban/kanban-toolbar'
import { KanbanSkeleton } from '@/components/kanban/kanban-skeleton'
import { getWorkspaceLawsByStatus } from '@/lib/kanban/get-laws-by-status'
import { getFilterOptions } from '@/lib/kanban/get-filter-options'

export default async function WorkspacePage() {
  const lawsByStatus = await getWorkspaceLawsByStatus()
  const filterOptions = await getFilterOptions()

  return (
    <div className="h-screen flex flex-col bg-gray-50">
      {/* Toolbar */}
      <KanbanToolbar />

      {/* Filter Bar */}
      <FilterBar
        categories={filterOptions.categories}
        employees={filterOptions.employees}
        allTags={filterOptions.allTags}
      />

      {/* Kanban Board */}
      <div className="flex-1 overflow-hidden">
        <Suspense fallback={<KanbanSkeleton />}>
          <KanbanBoardFiltered initialLawsByStatus={lawsByStatus} />
        </Suspense>
      </div>
    </div>
  )
}
```

**Get Filter Options Helper:**

```typescript
// lib/kanban/get-filter-options.ts
import { prisma } from '@/lib/prisma'
import { withWorkspace } from '@/lib/auth/with-workspace'

export async function getFilterOptions() {
  return withWorkspace(async ({ workspaceId }) => {
    // Get all unique categories from workspace laws
    const lawsWithCategories = await prisma.workspaceLaw.findMany({
      where: { workspaceId },
      include: {
        law: {
          include: {
            categories: {
              include: {
                category: true,
              },
            },
          },
        },
      },
    })

    const categories = [
      ...new Set(
        lawsWithCategories.flatMap((wl) =>
          wl.law.categories.map((c) => c.category.name)
        )
      ),
    ].sort()

    // Get all employees in workspace
    const employees = await prisma.employee.findMany({
      where: { workspaceId },
      select: {
        id: true,
        name: true,
        email: true,
      },
      orderBy: { name: 'asc' },
    })

    // Get all unique tags from workspace laws
    const allLaws = await prisma.workspaceLaw.findMany({
      where: { workspaceId },
      select: { tags: true },
    })

    const allTags = [...new Set(allLaws.flatMap((l) => l.tags || []))].sort()

    return {
      categories,
      employees: employees.map((e) => ({
        id: e.id,
        name: e.name || e.email,
      })),
      allTags,
    }
  })
}
```

**Empty State for Filtered Results:**

```typescript
// components/kanban/kanban-board-filtered.tsx (updated)
export function KanbanBoardFiltered({ initialLawsByStatus }: KanbanBoardFilteredProps) {
  // ... filtering logic ...

  const totalFilteredLaws = Object.values(filteredLawsByStatus).reduce(
    (sum, laws) => sum + laws.length,
    0
  )

  if (totalFilteredLaws === 0) {
    return (
      <div className="flex items-center justify-center h-full p-6">
        <div className="text-center">
          <svg
            className="w-16 h-16 text-gray-300 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <h3 className="text-lg font-semibold text-gray-900 mb-2">No laws found</h3>
          <p className="text-sm text-gray-600 mb-4">
            Try adjusting your filters to see more results.
          </p>
          <button
            onClick={() => {
              window.location.href = '/workspace'
            }}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Clear all filters
          </button>
        </div>
      </div>
    )
  }

  return <KanbanBoardClient initialLawsByStatus={filteredLawsByStatus} />
}
```

**Reference:** PRD Epic 6 Story 6.6, Architecture Section 14 (Compliance Workspace)

## Testing

**Unit Tests:**

- Filter by category, verify only matching laws shown
- Filter by priority, verify only matching laws shown
- Filter by employee, verify only laws assigned to that employee shown
- Search by law title, verify only matching laws shown
- Stack filters (category + priority), verify AND logic works
- Clear filters, verify all laws shown again

**Integration Tests:**

- Set filters in UI, verify URL updates with query params
- Reload page with query params, verify filters applied
- Filter to 0 results, verify empty state shown
- Clear filters button, verify resets all filters and URL

**Manual Testing:**

- Apply each filter individually, verify works
- Stack multiple filters, verify AND logic
- Search for law title, verify instant results
- Test on mobile, verify collapsible filter section
- Verify filter state persists in URL (shareable filtered view)
- Test "Clear filters" button

**Performance Testing:**

- Filtering 100 laws completes <100ms (client-side)
- No lag when typing in search input
- Filter state updates URL without full page reload

**Accessibility Testing:**

- Keyboard navigation through filter dropdowns (Tab, Enter, Arrow keys)
- Screen reader announces filter selections
- Focus indicators visible on all filter controls
- Mobile: Collapse/expand filter section accessible

**Test File:** `__tests__/features/kanban/filtering.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Apply filters to focus on specific laws
- Combine filters to narrow results (e.g., High priority Arbetsrätt laws)
- Clear filters when done
- Share filtered views via URL

**Developer Responsibility:**

- Implement instant client-side filtering (no server round-trip)
- Persist filter state in URL for shareability
- Provide clear empty state when no results
- Support AND logic for multi-select filters
- Optimize filter performance for 100+ laws
- Make filters accessible on mobile (collapsible section)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
