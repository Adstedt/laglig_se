# Story 6.7: Implement Kanban Column Customization

## Status

Draft

## Story

**As a** user,
**I want** to customize Kanban columns,
**so that** I match my compliance workflow.

## Acceptance Criteria

1. Settings → Workspace → "Customize Kanban" section
2. User can rename columns (default: Not Started, In Progress, Blocked, Review, Compliant)
3. User can add new columns (max 8 columns)
4. User can reorder columns (drag-and-drop)
5. User can delete custom columns (laws move to "Not Started")
6. Column customization saved per workspace
7. Default columns cannot be deleted (only renamed)

## Tasks / Subtasks

- [ ] Add "Customize Kanban" section to workspace settings
- [ ] Create column customization UI
- [ ] Implement column rename functionality
- [ ] Add "Add Column" button (max 8 columns)
- [ ] Implement column reordering via drag-and-drop
- [ ] Add column deletion with law reassignment
- [ ] Save column customization to database
- [ ] Load custom columns in Kanban board
- [ ] Prevent deletion of default columns
- [ ] Test column customization workflow

## Dev Notes

**Database Schema:**

```prisma
model WorkspaceKanbanColumn {
  id          String   @id @default(uuid())
  workspaceId String
  columnId    String   // not_started, in_progress, blocked, review, compliant, custom_1, custom_2, etc.
  label       String   // User-defined label
  color       String   // Color for badge
  position    Int      // Column order (0, 1, 2, ...)
  isDefault   Boolean  @default(false) // Cannot be deleted if true
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, columnId])
  @@index([workspaceId, position])
  @@map("workspace_kanban_columns")
}
```

**Customize Kanban Settings Section:**

```typescript
// components/settings/customize-kanban.tsx
'use client'

import { useState, useEffect } from 'react'
import { DndContext, DragEndEvent, closestCenter } from '@dnd-kit/core'
import { SortableContext, arrayMove, verticalListSortingStrategy } from '@dnd-kit/sortable'
import { SortableColumnItem } from './sortable-column-item'

interface Column {
  id: string
  columnId: string
  label: string
  color: string
  position: number
  isDefault: boolean
}

export function CustomizeKanban() {
  const [columns, setColumns] = useState<Column[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isSaving, setIsSaving] = useState(false)

  useEffect(() => {
    fetchColumns()
  }, [])

  async function fetchColumns() {
    setIsLoading(true)
    try {
      const response = await fetch('/api/workspace/kanban-columns')
      const data = await response.json()
      setColumns(data.columns)
    } catch (error) {
      console.error('Failed to fetch columns:', error)
    } finally {
      setIsLoading(false)
    }
  }

  async function saveColumns() {
    setIsSaving(true)
    try {
      const response = await fetch('/api/workspace/kanban-columns', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ columns })
      })

      if (response.ok) {
        alert('Columns saved successfully!')
      } else {
        alert('Failed to save columns')
      }
    } catch (error) {
      alert('Failed to save columns')
    } finally {
      setIsSaving(false)
    }
  }

  function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event

    if (!over || active.id === over.id) return

    const oldIndex = columns.findIndex((col) => col.id === active.id)
    const newIndex = columns.findIndex((col) => col.id === over.id)

    const reordered = arrayMove(columns, oldIndex, newIndex).map((col, index) => ({
      ...col,
      position: index
    }))

    setColumns(reordered)
  }

  function addColumn() {
    if (columns.length >= 8) {
      alert('Maximum 8 columns allowed')
      return
    }

    const newColumn: Column = {
      id: `temp_${Date.now()}`,
      columnId: `custom_${Date.now()}`,
      label: 'New Column',
      color: 'gray',
      position: columns.length,
      isDefault: false
    }

    setColumns([...columns, newColumn])
  }

  function updateColumn(id: string, updates: Partial<Column>) {
    setColumns(columns.map((col) => (col.id === id ? { ...col, ...updates } : col)))
  }

  function deleteColumn(id: string) {
    const column = columns.find((col) => col.id === id)
    if (!column) return

    if (column.isDefault) {
      alert('Default columns cannot be deleted')
      return
    }

    if (
      !confirm(
        'Are you sure? Laws in this column will be moved to "Not Started".'
      )
    ) {
      return
    }

    setColumns(columns.filter((col) => col.id !== id))
  }

  if (isLoading) {
    return <div className="animate-pulse h-64 bg-gray-200 rounded"></div>
  }

  return (
    <div className="bg-white rounded-lg shadow p-6">
      <h2 className="text-lg font-semibold mb-4">Customize Kanban Board</h2>
      <p className="text-sm text-gray-600 mb-6">
        Customize your Kanban columns to match your compliance workflow.
      </p>

      <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
        <SortableContext items={columns.map((c) => c.id)} strategy={verticalListSortingStrategy}>
          <div className="space-y-3 mb-6">
            {columns.map((column) => (
              <SortableColumnItem
                key={column.id}
                column={column}
                onUpdate={(updates) => updateColumn(column.id, updates)}
                onDelete={() => deleteColumn(column.id)}
              />
            ))}
          </div>
        </SortableContext>
      </DndContext>

      {/* Add Column Button */}
      <button
        onClick={addColumn}
        disabled={columns.length >= 8}
        className="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 hover:bg-gray-50 text-gray-600 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Add Column {columns.length >= 8 && '(Max reached)'}
      </button>

      {/* Save Button */}
      <div className="mt-6 flex justify-end">
        <button
          onClick={saveColumns}
          disabled={isSaving}
          className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          {isSaving ? 'Saving...' : 'Save Changes'}
        </button>
      </div>
    </div>
  )
}
```

**Sortable Column Item:**

```typescript
// components/settings/sortable-column-item.tsx
'use client'

import { useSortable } from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'

interface SortableColumnItemProps {
  column: any
  onUpdate: (updates: any) => void
  onDelete: () => void
}

export function SortableColumnItem({ column, onUpdate, onDelete }: SortableColumnItemProps) {
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({
    id: column.id
  })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1
  }

  const colorOptions = [
    { value: 'gray', label: 'Gray', class: 'bg-gray-100 text-gray-700' },
    { value: 'blue', label: 'Blue', class: 'bg-blue-100 text-blue-700' },
    { value: 'green', label: 'Green', class: 'bg-green-100 text-green-700' },
    { value: 'yellow', label: 'Yellow', class: 'bg-yellow-100 text-yellow-700' },
    { value: 'red', label: 'Red', class: 'bg-red-100 text-red-700' },
    { value: 'purple', label: 'Purple', class: 'bg-purple-100 text-purple-700' }
  ]

  return (
    <div
      ref={setNodeRef}
      style={style}
      className="flex items-center gap-3 p-4 border border-gray-200 rounded-lg bg-white"
    >
      {/* Drag Handle */}
      <div
        {...listeners}
        {...attributes}
        className="cursor-grab active:cursor-grabbing text-gray-400 hover:text-gray-600"
      >
        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M7 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 2zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 14zm6-8a2 2 0 1 0-.001-4.001A2 2 0 0 0 13 6zm0 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 14z" />
        </svg>
      </div>

      {/* Column Label Input */}
      <input
        type="text"
        value={column.label}
        onChange={(e) => onUpdate({ label: e.target.value })}
        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        placeholder="Column name"
      />

      {/* Color Picker */}
      <select
        value={column.color}
        onChange={(e) => onUpdate({ color: e.target.value })}
        className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      >
        {colorOptions.map((option) => (
          <option key={option.value} value={option.value}>
            {option.label}
          </option>
        ))}
      </select>

      {/* Preview Badge */}
      <div className={`px-3 py-1 text-sm font-medium rounded ${colorOptions.find((o) => o.value === column.color)?.class}`}>
        {column.label}
      </div>

      {/* Delete Button */}
      <button
        onClick={onDelete}
        disabled={column.isDefault}
        className="p-2 text-gray-400 hover:text-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
        title={column.isDefault ? 'Default columns cannot be deleted' : 'Delete column'}
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </button>
    </div>
  )
}
```

**Get Kanban Columns API:**

```typescript
// app/api/workspace/kanban-columns/route.ts
export async function GET(request: Request) {
  return withWorkspace(async ({ workspaceId }) => {
    // Check if workspace has custom columns
    let columns = await prisma.workspaceKanbanColumn.findMany({
      where: { workspaceId },
      orderBy: { position: 'asc' },
    })

    // If no custom columns, create defaults
    if (columns.length === 0) {
      const defaults = [
        {
          columnId: 'not_started',
          label: 'Not Started',
          color: 'gray',
          position: 0,
          isDefault: true,
        },
        {
          columnId: 'in_progress',
          label: 'In Progress',
          color: 'blue',
          position: 1,
          isDefault: true,
        },
        {
          columnId: 'blocked',
          label: 'Blocked',
          color: 'red',
          position: 2,
          isDefault: true,
        },
        {
          columnId: 'review',
          label: 'Review',
          color: 'yellow',
          position: 3,
          isDefault: true,
        },
        {
          columnId: 'compliant',
          label: 'Compliant',
          color: 'green',
          position: 4,
          isDefault: true,
        },
      ]

      columns = await Promise.all(
        defaults.map((col) =>
          prisma.workspaceKanbanColumn.create({
            data: {
              workspaceId,
              ...col,
            },
          })
        )
      )
    }

    return NextResponse.json({ columns })
  })
}
```

**Save Kanban Columns API:**

```typescript
// app/api/workspace/kanban-columns/route.ts (PUT)
export async function PUT(request: Request) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_WORKSPACE_SETTINGS)

    const { columns } = await request.json()

    // Validate max 8 columns
    if (columns.length > 8) {
      return NextResponse.json(
        { error: 'Maximum 8 columns allowed' },
        { status: 400 }
      )
    }

    // Delete removed columns and reassign laws to "not_started"
    const existingColumns = await prisma.workspaceKanbanColumn.findMany({
      where: { workspaceId },
    })

    const newColumnIds = columns.map((c: any) => c.id)
    const deletedColumns = existingColumns.filter(
      (c) => !newColumnIds.includes(c.id)
    )

    for (const deletedCol of deletedColumns) {
      // Move laws from deleted column to "not_started"
      await prisma.workspaceLaw.updateMany({
        where: {
          workspaceId,
          status: deletedCol.columnId,
        },
        data: {
          status: 'not_started',
        },
      })

      // Delete column
      await prisma.workspaceKanbanColumn.delete({
        where: { id: deletedCol.id },
      })
    }

    // Upsert columns
    for (const column of columns) {
      if (column.id.startsWith('temp_')) {
        // Create new column
        await prisma.workspaceKanbanColumn.create({
          data: {
            workspaceId,
            columnId: column.columnId,
            label: column.label,
            color: column.color,
            position: column.position,
            isDefault: false,
          },
        })
      } else {
        // Update existing column
        await prisma.workspaceKanbanColumn.update({
          where: { id: column.id },
          data: {
            label: column.label,
            color: column.color,
            position: column.position,
          },
        })
      }
    }

    return NextResponse.json({ success: true })
  })
}
```

**Load Custom Columns in Kanban:**

```typescript
// lib/kanban/get-columns.ts
import { prisma } from '@/lib/prisma'
import { withWorkspace } from '@/lib/auth/with-workspace'

export async function getKanbanColumns() {
  return withWorkspace(async ({ workspaceId }) => {
    const columns = await prisma.workspaceKanbanColumn.findMany({
      where: { workspaceId },
      orderBy: { position: 'asc' },
    })

    return columns.map((col) => ({
      id: col.columnId,
      label: col.label,
      color: col.color,
    }))
  })
}
```

**Updated Kanban Board to Use Custom Columns:**

```typescript
// components/kanban/kanban-board.tsx (updated)
export async function KanbanBoard() {
  const lawsByStatus = await getWorkspaceLawsByStatus()
  const columns = await getKanbanColumns() // Load custom columns

  return (
    <div className="h-full p-6 overflow-x-auto">
      <div className="hidden md:flex gap-4 h-full min-w-max">
        {columns.map((column) => (
          <KanbanColumn
            key={column.id}
            id={column.id}
            label={column.label}
            color={column.color}
            laws={lawsByStatus[column.id] || []}
          />
        ))}
      </div>
    </div>
  )
}
```

**Reference:** PRD Epic 6 Story 6.7, Architecture Section 14 (Compliance Workspace)

## Testing

**Unit Tests:**

- Add column, verify added to list
- Rename column, verify label updated
- Reorder columns via drag, verify position updated
- Delete custom column, verify removed from list
- Attempt to delete default column, verify blocked
- Attempt to add 9th column, verify blocked (max 8)

**Integration Tests:**

- Save columns, verify persisted to database
- Delete column with laws, verify laws moved to "not_started"
- Load Kanban board, verify custom columns displayed
- Drag law to custom column, verify status updated to custom columnId

**Manual Testing:**

- Add 3 custom columns, reorder via drag, save
- Rename "Not Started" to "Backlog", verify updated on Kanban
- Delete custom column, verify laws moved to "Not Started"
- Try to delete default column, verify blocked with message
- Add 8 columns, try to add 9th, verify blocked

**Performance Testing:**

- Saving 8 columns completes <500ms
- Reordering columns smooth (no lag)

**Accessibility Testing:**

- Keyboard navigation for column reorder (Space to pick up, Arrow keys to move, Space to drop)
- Screen reader announces column reorder
- Focus indicators visible on all controls

**Test File:** `__tests__/features/kanban/column-customization.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Customize columns to match workflow
- Rename columns with clear labels
- Choose appropriate colors for visual distinction
- Delete unused custom columns

**Developer Responsibility:**

- Persist column customization per workspace
- Prevent deletion of default columns (only allow rename)
- Reassign laws from deleted columns to "not_started"
- Enforce max 8 columns limit
- Load custom columns in Kanban board
- Support column reordering via drag-and-drop

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
