# Story 12.9: Template Detail & Preview Page

## Status

Draft

## Story

**As a** logged-in workspace member,
**I want** to preview a template's full structure before adopting it,
**so that** I can evaluate whether it covers my compliance needs.

## Acceptance Criteria

1. Authenticated route: `/laglistor/{slug}` (e.g., `/laglistor/arbetsmiljo`) — behind auth, not public
2. Template header: name, description, target audience, regulatory bodies, doc/section counts
3. Section accordion view: each section shows name, description, document count; expand to see list of laws (title, SFS number, source type badge); first 2-3 compliance summaries shown as preview (rest behind "Visa alla")
4. CTA: "Använd denna mall" (Adopt this template) — triggers adoption flow (Story 12.10)
5. Tjänsteföretag toggle (if variant exists): "Visa version för tjänsteföretag" — filters view to show only relevant items, re-numbers sections
6. Stats bar: "112 lagar | 9 kategorier | Senast uppdaterad: 2026-02-10"

## Tasks / Subtasks

- [ ] **Task 1: Create detail route** (AC: 1)
  - [ ] Create `app/(authenticated)/laglistor/[slug]/page.tsx` (Server Component, auth-gated)
  - [ ] Fetch template by slug (including sections and items)
  - [ ] For variant slugs, use the variant query API (from Story 12.6)
  - [ ] Add Next.js metadata export (title, description)
- [ ] **Task 2: Build template header** (AC: 2, 6)
  - [ ] Create `components/features/templates/template-header.tsx`
  - [ ] Display: name, description, target audience, regulatory body badges
  - [ ] Stats bar: doc count, section count, last updated date
- [ ] **Task 3: Build section accordion** (AC: 3)
  - [ ] Create `components/features/templates/template-sections-accordion.tsx`
  - [ ] Use shadcn/ui Accordion component
  - [ ] Each section: name, description, document count badge
  - [ ] Expanded: law list table (title, SFS number, source type badge)
  - [ ] Show first 2-3 compliance summaries as preview
  - [ ] "Visa alla" button to expand remaining summaries
- [ ] **Task 4: Build adopt CTA** (AC: 4)
  - [ ] Create `components/features/templates/template-adopt-cta.tsx`
  - [ ] "Använd denna mall" button (prominent, sticky sidebar or top banner)
  - [ ] Link to adoption flow (Story 12.10) — user is always authenticated on this page
- [ ] **Task 5: Implement variant toggle** (AC: 5)
  - [ ] Show toggle if template has variant children
  - [ ] Toggle updates page content to show variant view (55 items, 7 sections)
  - [ ] Could be: URL change to `/laglistor/arbetsmiljo-tjansteforetag` or client-side filter
- [ ] **Task 6: Create not-found handling** (AC: 1)
  - [ ] If slug doesn't match any PUBLISHED template, show 404
  - [ ] `app/(authenticated)/laglistor/[slug]/not-found.tsx`
- [ ] **Task 7: Write tests** (AC: all)
  - [ ] Component test: header renders all fields
  - [ ] Component test: accordion expands/collapses sections
  - [ ] Component test: compliance summary preview shows 2-3 then "Visa alla"
  - [ ] Component test: adopt CTA shows different actions based on auth state
  - [ ] E2E test: full page load with real template data

## Dev Notes

### Implementation Context (Decision B — FE First with Mock Data)

This story is built **before** templates are seeded. Use mock/stub template data during development and testing. Per Decision A (single-section pivot), the accordion view may initially render a single expanded section — this is expected and should be handled gracefully. Real multi-section templates appear once section groupings are designed.

### Route Structure

`app/(authenticated)/laglistor/[slug]/page.tsx` — dynamic route under the authenticated group. Template catalog is a logged-in feature, not a public/SEO page.

### Data Fetching

Fetch template + sections + items server-side. For variant templates, use the variant query (Story 12.6) which joins parent items with `is_service_company_relevant = true`.

```typescript
// Simplified data flow
const template = await getPublishedTemplate(slug)
if (!template) notFound()
const sections = await getTemplateSections(template.id)
// For each section, items are loaded lazily or all at once
```

### Accordion Component

Use `components/ui/accordion.tsx` (shadcn/ui). If not yet installed:
```bash
pnpm dlx shadcn@latest add accordion
```

### Relevant Source Tree

```
app/(authenticated)/laglistor/[slug]/page.tsx               # New detail page (auth-gated)
app/(authenticated)/laglistor/[slug]/not-found.tsx          # 404 handling
components/features/templates/template-header.tsx            # New component
components/features/templates/template-sections-accordion.tsx # New component
components/features/templates/template-adopt-cta.tsx         # New component
lib/db/queries/template.ts                                   # Extend with detail query
```

### Testing

- **Test framework:** Vitest 1.4+ with React Testing Library, Playwright for E2E
- **Test location:** `tests/unit/components/features/templates/`, `tests/e2e/`
- **Tests needed:**
  - Header displays correct template info
  - Accordion sections show correct item counts
  - Compliance summary preview shows 2-3 items, "Visa alla" shows rest
  - CTA: links to adoption flow
  - Variant toggle switches between parent and variant views
  - 404 for non-existent or non-published template slugs

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Added mock data context per Decision B, single-section note per Decision A | Sarah (PO) |
| 2026-02-09 | 1.2     | Moved from public to authenticated route — template detail is logged-in only, removed SEO/structured data, simplified CTA (no unauthenticated path) | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
