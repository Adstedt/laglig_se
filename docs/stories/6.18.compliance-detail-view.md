# Story 6.18: Compliance Detail View (Efterlevnad)

## Status

**Approved**

## Story

**As a** Compliance Officer reviewing our law list,
**I want** a dedicated "Efterlevnad" view that shows compliance substance (business impact and compliance actions) directly in the list,
**so that** I can scan 50+ laws quickly during audit preparation without opening modals for each one.

## Acceptance Criteria

### Functional Requirements

1. **View Toggle Extension**
   - Toolbar shows three view options: "Kort" (card) | "Tabell" (table) | "Efterlevnad" (compliance)
   - User's view preference is persisted (existing pattern)
   - Efterlevnad view uses table layout as base

2. **New Database Field**
   - Add `compliance_actions` field (TEXT, nullable) to `LawListItem` model
   - Field stores "Hur efterlever vi kraven?" content
   - Migration is additive (no breaking changes)

3. **Modal Accordion Section**
   - New accordion section "Hur efterlever vi kraven?" in legal document modal
   - Positioned after "Hur påverkar denna lag oss?" (BusinessContext)
   - Uses same RichTextEditor pattern as BusinessContext
   - Shows last updated timestamp and author

4. **Compliance View Columns**
   - Column: Dokument (law title, links to modal)
   - Column: "Hur påverkar denna lag oss?" (truncated to 2 lines)
   - Column: "Hur efterlever vi kraven?" (truncated to 2 lines)
   - Column: Status (compact badge)
   - Column: Prioritet (compact badge)
   - Column: Ansvarig (avatar only)
   - Column: Expand chevron (⌄/⌃)

5. **Hover Tooltip**
   - Hovering truncated text shows full content in tooltip
   - Tooltip includes: header, full text, "Senast uppdaterad" date, author name
   - Appropriate hover delay (200-300ms)

6. **Row Expansion**
   - Chevron click expands row inline showing both fields in full
   - Expanded view shows comfortable reading layout
   - Each field shows metadata (updated date, author)
   - Only one row expanded at a time (accordion behavior)

7. **Empty State Handling**
   - "Ej tillämplig" status: show `—` for both fields
   - Empty fields: show `Lägg till →` link (opens modal with editor focused)

### Integration Requirements

8. Existing group accordion structure preserved in Efterlevnad view
9. Same filtering, search, and sorting functionality as table view
10. Drag-and-drop within groups works as expected
11. Click on document title opens modal (existing behavior)

### Quality Requirements

12. Responsive layout (truncation adjusts to available width)
13. Keyboard accessible (tab navigation, Enter to expand)
14. No performance regression with 100+ items (virtual scrolling if needed)

## Tasks / Subtasks

- [x] **Task 1: Database Schema Update** (AC: 2)
  - [x] Add `compliance_actions` TEXT field to LawListItem in Prisma schema
  - [x] Add `compliance_actions_updated_at` DateTime field
  - [x] Add `compliance_actions_updated_by` String field
  - [x] Run migration: `npx prisma db push` (used db push due to shadow DB issues)
  - [x] Update TypeScript types in `app/actions/legal-document-modal.ts`

- [x] **Task 2: Modal Accordion Section** (AC: 3)
  - [x] Create `ComplianceActions` component (copy BusinessContext pattern)
  - [x] Add to modal left panel after BusinessContext
  - [x] Implement save action with SWR cache invalidation
  - [x] Show metadata (updated date, author) below editor

- [x] **Task 3: View Toggle Extension** (AC: 1)
  - [x] Extend `ViewMode` type: `'card' | 'table' | 'compliance'`
  - [x] Add third toggle option using `ClipboardList` icon from lucide-react
  - [x] Update `document-list-page-content.tsx` to render compliance view

- [x] **Task 4: Compliance Table Component** (AC: 4, 8, 9, 10)
  - [x] Create `compliance-detail-table.tsx` based on `document-list-table.tsx`
  - [x] Define column configuration for compliance view
  - [x] Implement 2-line truncation with CSS
  - [x] Integrate with existing group accordion structure
  - [x] Ensure filtering/search/sort work correctly

- [x] **Task 5: Hover Tooltip Component** (AC: 5)
  - [x] Create `TruncatedTextCell` component with Radix Tooltip (inline in compliance-detail-table.tsx)
  - [x] Design tooltip layout: header, body, metadata, author
  - [x] Use `delayDuration={250}` on TooltipProvider for consistent 250ms delay
  - [x] Handle empty content gracefully (don't show tooltip if content is empty)

- [x] **Task 6: Row Expansion** (AC: 6)
  - [x] Add chevron column to compliance table
  - [x] Create `ExpandedRowContent` component (inline in compliance-detail-table.tsx)
  - [x] Implement accordion behavior (single expanded row)
  - [x] Style expanded content with comfortable reading layout

- [x] **Task 7: Empty State & Actions** (AC: 7, 11)
  - [x] Implement "Ej tillämplig" display logic (show `—`)
  - [x] Create `Lägg till →` link component
  - [x] Link click opens modal with appropriate accordion expanded

- [ ] **Task 8: Testing & Polish** (AC: 12, 13, 14)
  - [ ] Test responsive behavior at various widths
  - [ ] Verify keyboard navigation (tab, Enter, Escape)
  - [ ] Performance test with 100+ items
  - [ ] Cross-browser testing

## Dev Notes

### Relevant Source Tree

```
components/features/document-list/
├── view-toggle.tsx                    # Extend with 'compliance' mode
├── document-list-page-content.tsx     # Add compliance view rendering
├── document-list-table.tsx            # Reference for table patterns
├── grouped-document-list-table.tsx    # Reference for grouped table
├── legal-document-modal/
│   ├── index.tsx                      # Add new accordion section
│   ├── business-context.tsx           # Pattern to copy for ComplianceActions
│   └── details-box.tsx                # Reference for metadata display

components/ui/
├── accordion.tsx                      # Radix accordion primitive
├── collapsible.tsx                    # Radix collapsible primitive
├── tooltip.tsx                        # Radix tooltip primitive
└── unified-toolbar.tsx                # Toolbar zone layout

prisma/schema.prisma                   # Add compliance_actions field (line ~200)
app/actions/legal-document-modal.ts    # Update ListItemDetails interface
```

### Existing Patterns to Follow

1. **BusinessContext Accordion** (`business-context.tsx`):
   - RichTextEditor with click-to-edit
   - Save/Cancel with SWR cache invalidation
   - Optimistic UI updates

2. **Table Column Definition** (`document-list-table.tsx`):
   - TanStack Table column helpers
   - Cell renderers with truncation
   - Inline editors pattern

3. **Tooltip Usage** (`view-toggle.tsx`, `details-box.tsx`):
   - TooltipProvider wrapping
   - TooltipTrigger + TooltipContent pattern

4. **Collapsible Rows** (`grouped-document-list.tsx`):
   - State: `expandedGroups: Record<string, boolean>`
   - Collapsible component with trigger

### Data Model Reference

```typescript
// LawListItem additions needed (prisma/schema.prisma)
compliance_actions            String?   @db.Text
compliance_actions_updated_at DateTime?
compliance_actions_updated_by String?
```

### Server Action Pattern

Follow the existing `updateBusinessContext` pattern in `app/actions/legal-document-modal.ts`:

```typescript
// Add to app/actions/legal-document-modal.ts
export async function updateComplianceActions(
  listItemId: string,
  content: string
): Promise<{ success: boolean; error?: string }> {
  const session = await getServerSession()
  if (!session?.user?.id) {
    return { success: false, error: 'Unauthorized' }
  }

  await prisma.lawListItem.update({
    where: { id: listItemId },
    data: {
      compliance_actions: content,
      compliance_actions_updated_at: new Date(),
      compliance_actions_updated_by: session.user.id,
    },
  })

  revalidateTag(`list-item-${listItemId}`)
  return { success: true }
}
```

### Testing

- **Test Location:** `tests/unit/components/features/document-list/`
- **Framework:** Vitest + React Testing Library
- **Existing Test References:**
  - `view-toggle.test.tsx` - Pattern for toggle tests
  - `business-context.test.tsx` - Pattern for accordion editor tests
- **Key Tests:**
  - View toggle switches correctly between all three modes
  - Tooltip appears on hover after 250ms delay
  - Row expansion works with accordion behavior
  - Empty states render correctly ("—" for Ej tillämplig, "Lägg till →" for empty)
  - Modal accordion saves data via server action

## Change Log

| Date       | Version | Description                                                                                          | Author     |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------- | ---------- |
| 2026-01-29 | 0.1     | Initial draft from brainstorming session                                                             | Sarah (PO) |
| 2026-01-29 | 0.2     | Validation fixes: corrected test path, added server action pattern, specified icon and tooltip delay | Sarah (PO) |
| 2026-01-29 | 1.0     | Story approved for implementation                                                                    | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Prisma migration failed with P3006 shadow database error; resolved using `npx prisma db push`
- Fixed TS2739 missing properties in use-list-item-details.ts by adding complianceActions fields
- Fixed TS2375 exactOptionalPropertyTypes for ComplianceActionsProps by adding `| undefined`
- Fixed TS6192/TS6133 unused imports and variables in compliance-detail-table.tsx
- Fixed TS2375 onRowClick type mismatch in compliance-detail-table.tsx
- Fixed TS2375 onAddContent type mismatch in compliance-group-section.tsx by adding `| undefined`

### Completion Notes List

- Tasks 1-7 implemented and build passes successfully
- Compliance view accessible via third toggle option (ClipboardList icon)
- Modal accordion "Hur efterlever vi kraven?" added after BusinessContext
- Compliance table includes: Dokument, Business Context, Compliance Actions, Status, Priority, Responsible columns
- Row expansion with accordion behavior (single row expanded at a time)
- Hover tooltips with 250ms delay showing full content and metadata
- Empty state handling: "—" for Ej tillämplig, "Lägg till →" for empty fields
- UI aligned: Compliance view now uses same grouped accordion structure as normal table view (GroupedComplianceTable + ComplianceGroupSection)

### File List

**New Files:**

- `components/features/document-list/legal-document-modal/compliance-actions.tsx` - ComplianceActions accordion component
- `components/features/document-list/compliance-detail-table.tsx` - Compliance detail table with tooltips, row expansion
- `components/features/document-list/grouped-compliance-table.tsx` - Grouped accordion wrapper for compliance view (matches normal table design)
- `components/features/document-list/compliance-group-section.tsx` - Group section component for compliance view accordion

**Modified Files:**

- `prisma/schema.prisma` - Added compliance_actions, compliance_actions_updated_at, compliance_actions_updated_by fields
- `app/actions/legal-document-modal.ts` - Added ListItemDetails fields, updateListItemComplianceActions action
- `app/actions/document-list.ts` - Added complianceActions fields to DocumentListItem interface and query
- `lib/hooks/use-list-item-details.ts` - Added complianceActions fields to initialDataToListItem and extraFields
- `lib/stores/document-list-store.ts` - Extended ViewMode type, added fields to optimistic item creation
- `components/features/document-list/view-toggle.tsx` - Extended ViewMode, added ClipboardList toggle option
- `components/features/document-list/document-list-page-content.tsx` - Added GroupedComplianceTable and ComplianceDetailTable rendering for compliance view
- `components/features/document-list/legal-document-modal/left-panel.tsx` - Added ComplianceActions import and rendering
- `components/features/document-list/legal-document-modal/index.tsx` - Added complianceActionsUpdatedByName resolution

## QA Results

_To be filled by QA agent_
