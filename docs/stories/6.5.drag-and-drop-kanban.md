# Story 6.5: Implement Drag-and-Drop for Kanban Board

## Status
Draft

## Story

**As a** user,
**I want** to drag law cards between columns,
**so that** I update compliance status visually.

## Acceptance Criteria

1. Law cards draggable using `@dnd-kit` or `react-beautiful-dnd`
2. Columns are drop zones
3. Dragging card shows visual feedback (card follows cursor, drop zone highlights)
4. Dropping card in new column → Backend updates law status
5. Smooth animation on drop
6. Optimistic UI update (card moves immediately, rollback if API fails)
7. Keyboard accessibility: Arrow keys + Enter to move cards
8. Touch support for mobile (drag with finger)
9. Performance: Smooth with 100+ law cards

## Tasks / Subtasks

- [ ] Install and configure @dnd-kit library
- [ ] Make law cards draggable
- [ ] Make columns droppable
- [ ] Add visual feedback during drag (ghost card, drop zone highlight)
- [ ] Implement drop handler to update law status
- [ ] Create API endpoint to update law status
- [ ] Implement optimistic UI updates
- [ ] Add rollback on API failure
- [ ] Implement keyboard navigation for drag-and-drop
- [ ] Add touch support for mobile devices
- [ ] Test performance with 100+ cards
- [ ] Add smooth animations

## Dev Notes

**Install @dnd-kit:**
```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**Kanban Board with DnD:**
```typescript
// components/kanban/kanban-board.tsx (updated)
'use client'

import { useState } from 'react'
import {
  DndContext,
  DragEndEvent,
  DragOverlay,
  DragStartEvent,
  PointerSensor,
  KeyboardSensor,
  TouchSensor,
  useSensor,
  useSensors,
  closestCorners
} from '@dnd-kit/core'
import { useRouter } from 'next/navigation'
import { KanbanColumn } from './kanban-column'
import { LawCard } from './law-card'

const COLUMNS = [
  { id: 'not_started', label: 'Not Started', color: 'gray' },
  { id: 'in_progress', label: 'In Progress', color: 'blue' },
  { id: 'blocked', label: 'Blocked', color: 'red' },
  { id: 'review', label: 'Review', color: 'yellow' },
  { id: 'compliant', label: 'Compliant', color: 'green' }
] as const

export function KanbanBoardClient({ initialLawsByStatus }: { initialLawsByStatus: any }) {
  const router = useRouter()
  const [lawsByStatus, setLawsByStatus] = useState(initialLawsByStatus)
  const [activeLaw, setActiveLaw] = useState<any>(null)

  // Configure sensors for drag
  const pointerSensor = useSensor(PointerSensor, {
    activationConstraint: {
      distance: 8 // Require 8px movement before drag starts
    }
  })
  const keyboardSensor = useSensor(KeyboardSensor)
  const touchSensor = useSensor(TouchSensor, {
    activationConstraint: {
      delay: 250, // 250ms delay before touch drag
      tolerance: 5
    }
  })

  const sensors = useSensors(pointerSensor, keyboardSensor, touchSensor)

  function handleDragStart(event: DragStartEvent) {
    const { active } = event
    const lawId = active.id

    // Find the law being dragged
    let foundLaw = null
    for (const status in lawsByStatus) {
      const law = lawsByStatus[status].find((l: any) => l.id === lawId)
      if (law) {
        foundLaw = law
        break
      }
    }

    setActiveLaw(foundLaw)
  }

  async function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event
    setActiveLaw(null)

    if (!over) return

    const lawId = active.id as string
    const newStatus = over.id as string

    // Find current status
    let currentStatus = ''
    for (const status in lawsByStatus) {
      if (lawsByStatus[status].find((l: any) => l.id === lawId)) {
        currentStatus = status
        break
      }
    }

    // No change
    if (currentStatus === newStatus) return

    // Optimistic update
    const draggedLaw = lawsByStatus[currentStatus].find((l: any) => l.id === lawId)
    if (!draggedLaw) return

    const optimisticUpdate = {
      ...lawsByStatus,
      [currentStatus]: lawsByStatus[currentStatus].filter((l: any) => l.id !== lawId),
      [newStatus]: [...lawsByStatus[newStatus], draggedLaw]
    }

    setLawsByStatus(optimisticUpdate)

    // Update backend
    try {
      const response = await fetch(`/api/workspace-laws/${lawId}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      })

      if (!response.ok) {
        throw new Error('Failed to update status')
      }

      // Refresh to get latest data
      router.refresh()
    } catch (error) {
      console.error('Failed to update law status:', error)

      // Rollback on error
      setLawsByStatus(initialLawsByStatus)
      alert('Failed to update law status. Please try again.')
    }
  }

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCorners}
      onDragStart={handleDragStart}
      onDragEnd={handleDragEnd}
    >
      <div className="h-full p-6 overflow-x-auto">
        <div className="hidden md:flex gap-4 h-full min-w-max">
          {COLUMNS.map((column) => (
            <KanbanColumn
              key={column.id}
              id={column.id}
              label={column.label}
              color={column.color}
              laws={lawsByStatus[column.id] || []}
            />
          ))}
        </div>
      </div>

      {/* Drag Overlay - Shows card being dragged */}
      <DragOverlay>
        {activeLaw ? (
          <div className="rotate-3 opacity-90 scale-105 transition-transform">
            <LawCard law={activeLaw} isDragging />
          </div>
        ) : null}
      </DragOverlay>
    </DndContext>
  )
}
```

**Kanban Column as Droppable:**
```typescript
// components/kanban/kanban-column.tsx (updated)
'use client'

import { useDroppable } from '@dnd-kit/core'
import { LawCard } from './law-card'
import { AddLawButton } from './add-law-button'

interface KanbanColumnProps {
  id: string
  label: string
  color: string
  laws: any[]
}

export function KanbanColumn({ id, label, color, laws }: KanbanColumnProps) {
  const { isOver, setNodeRef } = useDroppable({
    id: id
  })

  return (
    <div
      ref={setNodeRef}
      className={`flex flex-col w-80 rounded-lg flex-shrink-0 transition-colors ${
        isOver ? 'bg-blue-100 ring-2 ring-blue-400' : 'bg-gray-100'
      }`}
    >
      {/* Column Header */}
      <div className="p-4 border-b border-gray-200">
        <div className="flex items-center justify-between mb-2">
          <h2 className="font-semibold text-gray-900">{label}</h2>
          <span
            className={`px-2 py-1 text-sm font-medium rounded bg-${color}-100 text-${color}-700`}
          >
            {laws.length}
          </span>
        </div>
        <AddLawButton columnId={id} />
      </div>

      {/* Column Body - Scrollable */}
      <div className="flex-1 p-3 space-y-3 overflow-y-auto">
        {laws.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <svg
              className="w-12 h-12 text-gray-300 mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <p className="text-sm text-gray-500">
              {isOver ? 'Drop here' : 'No laws in this column yet'}
            </p>
          </div>
        ) : (
          laws.map((law) => <LawCard key={law.id} law={law} />)
        )}
      </div>

      {/* Column Footer */}
      {laws.length > 0 && (
        <div className="p-3 border-t border-gray-200 bg-white rounded-b-lg">
          <p className="text-xs text-gray-600">
            {laws.filter((l) => l.priority === 'high').length} high priority
          </p>
        </div>
      )}
    </div>
  )
}
```

**Law Card as Draggable:**
```typescript
// components/kanban/law-card.tsx (updated)
'use client'

import { useDraggable } from '@dnd-kit/core'
import { CSS } from '@dnd-kit/utilities'

interface LawCardProps {
  law: any
  isDragging?: boolean
}

export function LawCard({ law, isDragging = false }: LawCardProps) {
  const { attributes, listeners, setNodeRef, transform, isDragging: isDraggingActive } = useDraggable({
    id: law.id
  })

  const style = {
    transform: CSS.Translate.toString(transform)
  }

  // Don't apply drag listeners if this is the drag overlay
  const dragProps = isDragging ? {} : { ...listeners, ...attributes }

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...dragProps}
      className={`bg-white rounded-lg border-2 p-4 cursor-grab active:cursor-grabbing transition-all ${
        isDraggingActive
          ? 'opacity-50 border-blue-400 shadow-lg scale-105'
          : isDragging
          ? 'border-blue-400 shadow-xl'
          : 'border-gray-200 hover:border-blue-300 hover:shadow-md'
      }`}
      onClick={() => {
        // Open modal only if not dragging
        if (!isDraggingActive) {
          console.log('Open modal:', law.id)
        }
      }}
    >
      {/* Priority & Category Badges */}
      <div className="flex items-center gap-2 mb-3">
        {law.priority && (
          <span
            className={`px-2 py-1 text-xs font-medium rounded border ${getPriorityColor(
              law.priority
            )}`}
          >
            {law.priority === 'high' ? 'High' : law.priority === 'medium' ? 'Med' : 'Low'}
          </span>
        )}
        <span className={`px-2 py-1 text-xs font-medium rounded ${getCategoryColor(law.category)}`}>
          {law.category}
        </span>
      </div>

      {/* Law Title */}
      <h3 className="font-semibold text-gray-900 mb-2 line-clamp-2">{law.lawTitle}</h3>

      {/* SFS Number */}
      <p className="text-xs text-gray-500 mb-3">{law.lawSfsNumber}</p>

      {/* Task Progress */}
      {law.taskProgress && law.taskProgress.total > 0 && (
        <div className="mb-3">
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs text-gray-600">Tasks</span>
            <span className="text-xs text-gray-600">
              {law.taskProgress.completed}/{law.taskProgress.total}
            </span>
          </div>
          <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
            <div
              className={`h-full transition-all duration-300 ${
                law.taskProgress.completed === law.taskProgress.total ? 'bg-green-500' : 'bg-blue-500'
              }`}
              style={{
                width: `${(law.taskProgress.completed / law.taskProgress.total) * 100}%`
              }}
            />
          </div>
        </div>
      )}

      {/* Assigned Employees */}
      {law.assignedEmployees.length > 0 && (
        <div className="flex items-center gap-2">
          <div className="flex -space-x-2">
            {law.assignedEmployees.slice(0, 3).map((employee: any) => (
              <div
                key={employee.id}
                className="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-semibold border-2 border-white"
                title={employee.name || employee.email}
              >
                {(employee.name || employee.email)[0].toUpperCase()}
              </div>
            ))}
          </div>
          {law.assignedEmployees.length > 3 && (
            <span className="text-xs text-gray-600">+{law.assignedEmployees.length - 3}</span>
          )}
        </div>
      )}

      {/* Drag Handle Icon (only show when not dragging) */}
      {!isDraggingActive && !isDragging && (
        <div className="absolute top-2 right-2 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
          <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M7 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 2zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 14zm6-8a2 2 0 1 0-.001-4.001A2 2 0 0 0 13 6zm0 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 14z" />
          </svg>
        </div>
      )}
    </div>
  )
}

function getPriorityColor(priority: string) {
  const colors: Record<string, string> = {
    high: 'bg-red-100 text-red-700 border-red-200',
    medium: 'bg-yellow-100 text-yellow-700 border-yellow-200',
    low: 'bg-gray-100 text-gray-700 border-gray-200'
  }
  return colors[priority] || colors.low
}

function getCategoryColor(category: string) {
  const colors: Record<string, string> = {
    'Arbetsrätt': 'bg-blue-100 text-blue-700',
    'Arbetsmiljö': 'bg-green-100 text-green-700',
    'GDPR': 'bg-purple-100 text-purple-700',
    'Skatt': 'bg-orange-100 text-orange-700',
    'Övrigt': 'bg-gray-100 text-gray-700'
  }
  return colors[category] || colors['Övrigt']
}
```

**Update Law Status API:**
```typescript
// app/api/workspace-laws/[id]/status/route.ts
export async function PATCH(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_LAWS)

    const { status } = await request.json()

    // Verify law belongs to workspace
    const existingLaw = await prisma.workspaceLaw.findFirst({
      where: {
        id: params.id,
        workspaceId
      },
      include: {
        law: {
          select: {
            title: true
          }
        }
      }
    })

    if (!existingLaw) {
      return NextResponse.json({ error: 'Law not found' }, { status: 404 })
    }

    // Validate status
    const validStatuses = ['not_started', 'in_progress', 'blocked', 'review', 'compliant']
    if (!validStatuses.includes(status)) {
      return NextResponse.json({ error: 'Invalid status' }, { status: 400 })
    }

    // Update status
    const updated = await prisma.workspaceLaw.update({
      where: { id: params.id },
      data: {
        status,
        updatedAt: new Date()
      }
    })

    // Log activity
    await logActivity({
      workspaceId,
      userId,
      action: ActivityAction.LAW_STATUS_CHANGED,
      resourceType: 'law',
      resourceId: existingLaw.lawId,
      metadata: {
        lawTitle: existingLaw.law.title,
        oldStatus: existingLaw.status,
        newStatus: status
      }
    })

    return NextResponse.json({ success: true, status: updated.status })
  })
}
```

**Keyboard Navigation Custom Hook:**
```typescript
// lib/kanban/use-keyboard-navigation.ts
import { KeyboardEvent } from 'react'

export function useKeyboardNavigation(
  lawId: string,
  currentStatus: string,
  onStatusChange: (newStatus: string) => void
) {
  const statusOrder = ['not_started', 'in_progress', 'blocked', 'review', 'compliant']

  function handleKeyDown(e: KeyboardEvent) {
    const currentIndex = statusOrder.indexOf(currentStatus)

    if (e.key === 'ArrowRight') {
      e.preventDefault()
      const nextIndex = Math.min(currentIndex + 1, statusOrder.length - 1)
      if (nextIndex !== currentIndex) {
        onStatusChange(statusOrder[nextIndex])
      }
    } else if (e.key === 'ArrowLeft') {
      e.preventDefault()
      const prevIndex = Math.max(currentIndex - 1, 0)
      if (prevIndex !== currentIndex) {
        onStatusChange(statusOrder[prevIndex])
      }
    }
  }

  return { handleKeyDown }
}
```

**Performance Optimization:**
```typescript
// components/kanban/kanban-board.tsx (optimizations)

// Use React.memo for law cards to prevent unnecessary re-renders
export const LawCard = React.memo(function LawCard({ law }: LawCardProps) {
  // ... component implementation
})

// Use virtualization for columns with many cards
import { useVirtualizer } from '@tanstack/react-virtual'

export function KanbanColumn({ id, label, color, laws }: KanbanColumnProps) {
  const parentRef = useRef<HTMLDivElement>(null)

  const virtualizer = useVirtualizer({
    count: laws.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 160, // Estimated card height
    overscan: 5
  })

  // Only render visible cards
  const virtualItems = virtualizer.getVirtualItems()

  return (
    <div className="flex flex-col w-80 bg-gray-100 rounded-lg flex-shrink-0">
      {/* ... header ... */}

      <div ref={parentRef} className="flex-1 p-3 overflow-y-auto">
        <div
          style={{
            height: `${virtualizer.getTotalSize()}px`,
            position: 'relative'
          }}
        >
          {virtualItems.map((virtualItem) => (
            <div
              key={virtualItem.key}
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                transform: `translateY(${virtualItem.start}px)`
              }}
            >
              <LawCard law={laws[virtualItem.index]} />
            </div>
          ))}
        </div>
      </div>
    </div>
  )
}
```

**Reference:** PRD Epic 6 Story 6.5, @dnd-kit documentation

## Testing

**Unit Tests:**
- Dragging card updates status in state
- Dropping in same column doesn't trigger API call
- API failure rolls back optimistic update
- Keyboard navigation moves cards correctly (ArrowLeft/Right)

**Integration Tests:**
- Drag law from "Not Started" to "In Progress", verify status updated in database
- Drag law between all 5 columns, verify persists correctly
- Simulate API failure, verify card returns to original column
- Use keyboard to move card, verify status changes
- Drag on mobile with touch, verify works correctly

**Manual Testing:**
- Drag law card between columns, verify smooth animation
- Verify drop zone highlights when hovering
- Verify dragged card follows cursor
- Press ESC while dragging, verify cancels drag
- Use arrow keys + Enter to move card, verify works
- Test on mobile with touch, verify drag works
- Test with 100+ cards, verify no lag during drag

**Performance Testing:**
- Kanban with 100 laws: drag-and-drop remains smooth (<16ms frame time)
- No memory leaks during repeated drag operations
- Virtual scrolling renders only visible cards

**Accessibility Testing:**
- Keyboard navigation works (Arrow keys to move, Enter to confirm)
- Screen reader announces drag start/end
- Focus indicator visible during keyboard navigation
- Touch targets large enough (44x44px minimum)

**Test File:** `__tests__/features/kanban/drag-and-drop.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Drag laws to appropriate columns based on compliance status
- Use keyboard shortcuts for faster navigation (Arrow keys)
- Understand column meanings (Not Started vs In Progress vs Compliant)

**Developer Responsibility:**
- Implement smooth, responsive drag-and-drop
- Provide visual feedback during drag (ghost card, drop zone highlight)
- Handle optimistic updates with rollback on error
- Support keyboard and touch navigation
- Optimize performance for 100+ cards
- Prevent accidental drags (8px threshold before drag starts)
- Ensure accessibility for keyboard-only users

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
