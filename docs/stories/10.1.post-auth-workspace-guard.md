# Story 10.1: Post-Auth Workspace Guard & Onboarding Routing

## Status

Draft

## Story

**As a** newly registered user,
**I want** to be directed to workspace setup after login instead of seeing an error,
**so that** I can create my workspace and start using the platform.

## Acceptance Criteria

**Core Routing:**

1. When an authenticated user with no `WorkspaceMember` record accesses any `(workspace)` route, they are redirected to `/onboarding` instead of getting an unhandled error
2. The redirect preserves the originally requested URL as a `?redirect=` query parameter so the user can be sent there after workspace creation
3. Users with an existing active workspace are completely unaffected - normal routing continues
4. The `/onboarding` route is accessible only to authenticated users (unauthenticated users redirect to `/login`)
5. Users who already have an active workspace and visit `/onboarding` are redirected to `/dashboard`

**Error Handling:**

6. The `NO_WORKSPACE` error from `getWorkspaceContext()` is caught in the workspace layout and triggers a redirect rather than an unhandled exception
7. The client-side `useWorkspace` hook's `noWorkspaceRedirect` is updated from `/select-workspace` to `/onboarding`
8. The workspace context API endpoint (`/api/workspace/context`) continues to return 403 with code `NO_WORKSPACE` for API consumers

**Edge Cases:**

9. Users with a DELETED workspace see a dedicated "Workspace raderat" message page with option to create a new workspace
10. Users with a PAUSED workspace see a "Workspace pausat" banner with reactivation option (for owners) or contact-owner message (for members)

**Onboarding Layout:**

11. The `/onboarding` route group has its own layout with authentication check but no workspace shell (no sidebar, no workspace switcher)
12. The onboarding layout includes the Laglig.se logo linking to `/`, matching the auth pages' brand styling (warm background, Card wrapper)
13. The layout is responsive across desktop and mobile breakpoints

## Tasks / Subtasks

- [ ] **Task 1: Catch NO_WORKSPACE in workspace layout** (AC: 1, 6)
  - [ ] In `app/(workspace)/layout.tsx`, wrap the `getCurrentUser()` / workspace rendering in a try-catch
  - [ ] Import `getWorkspaceContext` and call it in the layout to detect workspace state
  - [ ] On `WorkspaceAccessError` with code `NO_WORKSPACE`, redirect to `/onboarding` using `redirect()` from `next/navigation`
  - [ ] On `WorkspaceAccessError` with code `WORKSPACE_DELETED`, redirect to `/onboarding?state=deleted`
  - [ ] Let other errors propagate to the error boundary as before

- [ ] **Task 2: Preserve redirect URL** (AC: 2)
  - [ ] When redirecting from workspace layout to `/onboarding`, include the original path as `?redirect=` query parameter
  - [ ] Example: user visits `/laws` → redirected to `/onboarding?redirect=%2Flaws`
  - [ ] Use `encodeURIComponent()` for the redirect URL

- [ ] **Task 3: Update client-side workspace hook** (AC: 7)
  - [ ] In `lib/hooks/use-workspace.tsx`, change `noWorkspaceRedirect` default from `/select-workspace` to `/onboarding`
  - [ ] Verify the hook's 403 handling with `NO_WORKSPACE` code redirects correctly

- [ ] **Task 4: Create onboarding layout** (AC: 4, 5, 11, 12, 13)
  - [ ] Create `app/onboarding/layout.tsx` as a Server Component
  - [ ] Check authentication via `getCurrentUser()` — redirect to `/login` if not authenticated
  - [ ] Check if user already has a workspace via a lightweight query (`WorkspaceMember.findFirst` for user) — redirect to `/dashboard` if workspace exists
  - [ ] Render layout with: Laglig.se logo (link to `/`), warm background (`bg-section-warm`), centered Card container matching auth pages pattern
  - [ ] Do NOT include workspace shell (sidebar, header, workspace switcher)
  - [ ] Ensure layout is responsive

- [ ] **Task 5: Create onboarding page placeholder** (AC: 1, 4, 5)
  - [ ] Create `app/onboarding/page.tsx` as a Server Component
  - [ ] This page will be fully implemented in Story 10.2 — for now, render a simple "Skapa din workspace" heading inside the Card
  - [ ] Accept `?redirect=` and `?state=` query params (pass to child components later)
  - [ ] Export metadata: `title: 'Skapa workspace | Laglig.se'`, `description: 'Skapa din workspace för att komma igång'`

- [ ] **Task 6: Handle deleted and paused workspace states** (AC: 9, 10)
  - [ ] If `?state=deleted` is present on `/onboarding`, show a "Ditt workspace har raderats" message with option to create a new one
  - [ ] For PAUSED workspace: modify workspace layout to catch `WORKSPACE_PAUSED` state (from workspace context `workspaceStatus`) and render a banner instead of redirecting — owners see "Återaktivera" button, members see "Kontakta ägaren"
  - [ ] Paused workspace users should still see the workspace shell (read-only), not be redirected to onboarding

- [ ] **Task 7: Verify existing API endpoint behavior** (AC: 8)
  - [ ] Confirm `app/api/workspace/context/route.ts` still returns 403 with `{ code: 'NO_WORKSPACE' }` — no changes needed to this endpoint
  - [ ] Verify that API consumers (if any) are not broken by layout-level redirect

- [ ] **Task 8: Regression testing** (AC: 3)
  - [ ] Verify existing users with active workspaces can access all workspace routes without any change in behavior
  - [ ] Verify workspace switcher still works for users with multiple workspaces
  - [ ] Verify `CreateWorkspaceModal` in workspace switcher still functions

## Dev Notes

### Architecture Sources

- **Auth & Session**: NextAuth JWT strategy with 30-day max age. `getCurrentUser()` from `lib/auth/session.ts` returns user object or null [Source: architecture/17-coding-standards.md#17.6]
- **Workspace Context**: `getWorkspaceContext()` from `lib/auth/workspace-context.ts` — cached with `React.cache()`, Redis-backed (5-min TTL), throws `WorkspaceAccessError` with typed codes [Source: architecture/p0-workflows-blocking-required-for-basic-functionality.md#8.3b]
- **Component Standards**: shadcn/ui mandatory for all UI components, Radix UI primitives for accessibility [Source: architecture/17-coding-standards.md#17.3]
- **Project Structure**: Auth routes under `app/(auth)/`, workspace routes under `app/(workspace)/`, onboarding should be at `app/onboarding/` (top-level route group, no parenthetical grouping needed) [Source: architecture/12-unified-project-structure.md#12.2]
- **Error Handling**: Use typed `AppError` / `WorkspaceAccessError` pattern with error codes [Source: architecture/17-coding-standards.md#17.5]

### Relevant Source Tree

```
app/(workspace)/
  layout.tsx                         # MODIFY: Add try-catch for NO_WORKSPACE, redirect to /onboarding
  dashboard/page.tsx                 # NO CHANGE: Example workspace page that calls getWorkspaceContext()

app/onboarding/
  layout.tsx                         # NEW: Auth-only layout, no workspace shell, brand styling
  page.tsx                           # NEW: Placeholder page (fully built in Story 10.2)

lib/auth/
  workspace-context.ts               # READ ONLY: Understand WorkspaceAccessError codes
    - Line 44-51: WorkspaceErrorCode type = 'UNAUTHORIZED' | 'NO_WORKSPACE' | 'WORKSPACE_DELETED' | 'ACCESS_DENIED'
    - Line 53-149: getWorkspaceContextInternal() — throws at line 105 when no WorkspaceMember found
    - Line 261-269: setActiveWorkspace() — sets httpOnly cookie

  session.ts                         # READ ONLY: getCurrentUser() function

lib/hooks/
  use-workspace.tsx                  # MODIFY: Change noWorkspaceRedirect from '/select-workspace' to '/onboarding'
    - Line where noWorkspaceRedirect is defined: update default value

app/api/workspace/context/route.ts   # NO CHANGE: Verify 403 + NO_WORKSPACE still works
    - Lines 24-43: Error handling returns 403 for NO_WORKSPACE

app/(auth)/layout.tsx                # REFERENCE: Brand styling pattern to replicate for onboarding layout
    - Uses bg-section-warm, logo, Card wrapper, animate-fade-up

components/features/workspace/
  create-workspace-modal.tsx          # NO CHANGE: Verify it still works in workspace switcher
```

### Key Implementation Details

1. **Workspace layout change is the critical fix.** Currently `app/(workspace)/layout.tsx` calls `getCurrentUser()` but does NOT call `getWorkspaceContext()` — it relies on individual pages to call it. The fix should either:
   - (a) Add `getWorkspaceContext()` call to the layout itself (catches the error for ALL workspace pages), OR
   - (b) Add an error boundary at the layout level that catches `WorkspaceAccessError`

   Option (a) is preferred — it's simpler and more explicit. The workspace context is already cached per request via `React.cache()`, so calling it in layout AND in pages won't result in duplicate queries.

2. **The onboarding route must be OUTSIDE the `(workspace)` route group** — otherwise it would be wrapped in the workspace layout that requires a workspace, creating a circular dependency.

3. **Do NOT modify the auth callback redirect.** The current flow (auth callback → `/dashboard` → detect no workspace → redirect to `/onboarding`) is fine. Changing the callback to redirect directly to `/onboarding` would require knowing the user's workspace state at callback time, which adds complexity for no benefit.

4. **The `useWorkspace` hook in `lib/hooks/use-workspace.tsx`** makes client-side API calls to `/api/workspace/context` and handles 403 responses. Update its redirect target but keep the error handling logic intact.

### Coding Standards

- Server Components by default — only add `'use client'` when interactivity needed [Source: architecture/17-coding-standards.md#17.3]
- Use `redirect()` from `next/navigation` for server-side redirects [Source: Next.js App Router]
- Import path aliases: `@/lib/auth/workspace-context`, `@/lib/auth/session` [Source: architecture/12-unified-project-structure.md#12.5]
- TypeScript strict mode — all new code fully typed [Source: architecture/17-coding-standards.md#17.2]
- shadcn/ui Card for the onboarding layout wrapper [Source: architecture/17-coding-standards.md#17.3]

### Testing

- **Test approach**: Manual regression testing for routing changes. Verify all paths:
  1. New user (no workspace) → any workspace route → redirected to `/onboarding`
  2. Existing user (has workspace) → any workspace route → normal behavior
  3. User with deleted workspace → redirect to `/onboarding?state=deleted`
  4. User with paused workspace → workspace loads with paused banner
  5. Unauthenticated user → `/onboarding` → redirected to `/login`
  6. User with workspace → `/onboarding` → redirected to `/dashboard`
- **Test file location (if unit tests added later)**: `tests/unit/app/onboarding/` and `tests/integration/workspace-routing/`
- **Testing framework**: Vitest + React Testing Library [Source: architecture/17-coding-standards.md]

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-01-30 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled by development agent_

### Debug Log References

_To be filled by development agent_

### Completion Notes List

_To be filled by development agent_

### File List

_To be filled by development agent_

## QA Results

_To be filled by QA agent_
