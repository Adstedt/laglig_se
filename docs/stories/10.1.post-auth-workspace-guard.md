# Story 10.1: Post-Auth Workspace Guard & Onboarding Routing

## Status

Ready for Review

## Story

**As a** newly registered user,
**I want** to be directed to workspace setup after login instead of seeing an error,
**so that** I can create my workspace and start using the platform.

## Acceptance Criteria

**Core Routing:**

1. When an authenticated user with no `WorkspaceMember` record accesses any `(workspace)` route, they are redirected to `/onboarding` instead of getting an unhandled error
2. The redirect preserves the originally requested URL as a `?redirect=` query parameter so the user can be sent there after workspace creation
3. Users with an existing active workspace are completely unaffected - normal routing continues
4. The `/onboarding` route is accessible only to authenticated users (unauthenticated users redirect to `/login`)
5. Users who already have an active workspace and visit `/onboarding` are redirected to `/dashboard`

**Error Handling:**

6. The `NO_WORKSPACE` error from `getWorkspaceContext()` is caught in the workspace layout and triggers a redirect rather than an unhandled exception
7. The client-side `useWorkspace` hook's `noWorkspaceRedirect` is updated from `/select-workspace` to `/onboarding`
8. The workspace context API endpoint (`/api/workspace/context`) continues to return 403 with code `NO_WORKSPACE` for API consumers

**Edge Cases:**

9. Users with a DELETED workspace see a dedicated "Workspace raderat" message with option to create a new workspace
10. Users with a PAUSED workspace see a "Workspace pausat" banner with reactivation option (for owners) or contact-owner message (for members)

**Onboarding Layout:**

11. The `/onboarding` route group has its own layout with authentication check but no workspace shell (no sidebar, no workspace switcher)
12. The onboarding layout replicates the auth pages' brand styling exactly: `bg-section-warm` background, Laglig.se logo linking to `/`, shadcn/ui `Card` with `animate-fade-up rounded-xl bg-card p-8 shadow-lg`, `font-safiro` for headings
13. The layout is responsive across desktop and mobile breakpoints

## Tasks / Subtasks

- [x] **Task 1: Catch NO_WORKSPACE in workspace layout** (AC: 1, 6)
  - [x] In `app/(workspace)/layout.tsx`, import `getWorkspaceContext` and `WorkspaceAccessError` from `@/lib/auth/workspace-context`
  - [x] After the existing `getCurrentUser()` check, add a try-catch block that calls `await getWorkspaceContext()`
  - [x] On `WorkspaceAccessError` with code `NO_WORKSPACE`, redirect to `/onboarding` using `redirect()` from `next/navigation`
  - [x] On `WorkspaceAccessError` with code `WORKSPACE_DELETED`, redirect to `/onboarding?state=deleted`
  - [x] Let other errors (UNAUTHORIZED, ACCESS_DENIED) propagate to the error boundary as before
  - [x] Note: `getWorkspaceContext()` is wrapped in `React.cache()` so calling it in the layout AND in downstream pages will NOT trigger duplicate DB/Redis queries

- [x] **Task 2: Preserve redirect URL** (AC: 2)
  - [x] Access the request pathname in the workspace layout (use `headers()` from `next/headers` to read the `x-pathname` header, or accept the path as a layout parameter)
  - [x] When redirecting from workspace layout to `/onboarding`, include the original path as `?redirect=` query parameter
  - [x] Example: user visits `/laws` → redirected to `/onboarding?redirect=%2Flaws`
  - [x] Use `encodeURIComponent()` for the redirect URL
  - [x] For deleted state, combine params: `/onboarding?state=deleted&redirect=%2Flaws`

- [x] **Task 3: Update client-side workspace hook** (AC: 7)
  - [x] In `lib/hooks/use-workspace.tsx:54`, change `noWorkspaceRedirect` default value from `'/select-workspace'` to `'/onboarding'`
  - [x] Also update the JSDoc comment on line 47 to reflect the new default path
  - [x] The 403 handling logic at line 88 (`errorData.code === 'NO_WORKSPACE'`) remains unchanged — only the redirect target changes

- [x] **Task 4: Create onboarding layout** (AC: 4, 5, 11, 12, 13)
  - [x] Create `app/onboarding/layout.tsx` as a Server Component (NO `'use client'`)
  - [x] Export metadata: `title: 'Onboarding | Laglig.se'`, `description: 'Skapa din workspace för att komma igång'`
  - [x] Check authentication via `getCurrentUser()` from `@/lib/auth/session` — if `null`, call `redirect('/login')`
  - [x] Check if user already has a workspace: query `prisma.workspaceMember.findFirst({ where: { user_id: user.id } })` (need to resolve user ID from email via `prisma.user.findUnique`) — if workspace exists, call `redirect('/dashboard')`
  - [x] **Replicate the auth layout styling exactly from `app/(auth)/layout.tsx`:**
    - Outer wrapper: `<div className="flex min-h-screen items-center justify-center bg-section-warm px-4 py-12 sm:px-6 lg:px-8">`
    - Content container: `<div className="w-full max-w-md space-y-8">`
    - Logo: `<Link href="/" className="transition-opacity hover:opacity-90"><Image src="/images/logo-final.png" alt="Laglig.se" width={176} height={67} className="h-8 w-auto invert dark:invert-0" priority /></Link>` centered with `<div className="flex justify-center">`
    - Card wrapper: `<Card className="animate-fade-up rounded-xl bg-card p-8 shadow-lg">{children}</Card>`
  - [x] Do NOT include any workspace shell elements (sidebar, header, workspace switcher)
  - [x] Import: `Image` from `next/image`, `Link` from `next/link`, `Card` from `@/components/ui/card`, `redirect` from `next/navigation`

- [x] **Task 5: Create onboarding page placeholder** (AC: 1, 4, 5)
  - [x] Create `app/onboarding/page.tsx` as a Server Component (NO `'use client'`)
  - [x] This page will be fully replaced in Story 10.2 — for now, render a simple placeholder:
    - Heading: `<h2 className="font-safiro text-2xl font-semibold tracking-tight text-center">Skapa din workspace</h2>`
    - Paragraph: `<p className="mt-2 text-center text-sm text-muted-foreground">Din workspace skapas i nästa steg.</p>`
  - [x] Accept `searchParams` prop (Next.js App Router pattern: `searchParams: Promise<{ redirect?: string; state?: string }>`)
  - [x] If `state=deleted`, render a different message (see Task 6)
  - [x] Export page-specific metadata overriding layout: `title: 'Skapa workspace | Laglig.se'`, `description: 'Skapa din workspace för att komma igång'`

- [x] **Task 6: Handle deleted and paused workspace states** (AC: 9, 10)
  - [x] **Deleted workspace** (in onboarding page): If `?state=deleted` is present on `/onboarding`:
    - Show heading: `<h2 className="font-safiro text-2xl font-semibold tracking-tight text-center">Ditt workspace har raderats</h2>`
    - Show description: `<p className="mt-2 text-center text-sm text-muted-foreground">Du kan skapa ett nytt workspace nedan.</p>`
    - Show CTA placeholder (will be wired in Story 10.2): `<Button className="mt-6 w-full shadow-lg shadow-primary/25 hover:shadow-xl hover:shadow-primary/30">Skapa nytt workspace</Button>`
    - Use shadcn/ui `Button` from `@/components/ui/button`
  - [x] **Paused workspace** (in workspace layout): In `app/(workspace)/layout.tsx`, after successfully getting workspace context, check if `workspaceStatus === 'PAUSED'`:
    - Do NOT redirect — render the workspace shell normally but with a banner at the top
    - Banner uses warning styling: `<div className="bg-amber-50 border-b border-amber-200 px-4 py-3 text-center text-sm text-amber-800">`
    - Owner message: "Ditt workspace är pausat. " + `<Button variant="link">Återaktivera</Button>`
    - Member message: "Ditt workspace är pausat. Kontakta ägaren för att återaktivera."
    - Determine owner vs member by calling `getWorkspaceContext()` and checking `context.role === 'OWNER'`

- [x] **Task 7: Verify existing API endpoint behavior** (AC: 8)
  - [x] Confirm `app/api/workspace/context/route.ts` still returns 403 with `{ code: 'NO_WORKSPACE' }` — no changes needed to this endpoint
  - [x] Verify the endpoint's error handling at lines 24-43 remains intact (returns structured JSON with `error`, `code`, `message` fields)
  - [x] Verify that API consumers (if any) are not broken by the layout-level redirect (layout redirect is server-side and does not affect API route responses)

- [x] **Task 8: Regression testing** (AC: 3)
  - [x] Verify existing users with active workspaces can access all workspace routes without any change in behavior
  - [x] Verify workspace switcher still works for users with multiple workspaces
  - [x] Verify `CreateWorkspaceModal` in workspace switcher still functions (it's inside the workspace shell which now has the guard)
  - [x] Verify `/api/workspace/context` returns expected responses for all user states

## Dev Notes

### Previous Story Insights

**From Story 6.21 (Auth Pages Brand Refresh)** — most recent completed story, directly relevant:

- Auth pages were split into **Server Component** (`page.tsx` exports metadata) + **Client Component** (underscore-prefixed `_form.tsx` file) because `metadata` cannot be exported from `'use client'` components in Next.js. For Story 10.1 this is less relevant since the onboarding placeholder has no interactive form yet — keep everything as Server Components. Story 10.2 will need the split pattern when adding the wizard form.
- The auth layout at `app/(auth)/layout.tsx` is the **canonical reference** for the brand styling that the onboarding layout must replicate. Copy the exact structure, classes, and logo implementation.
- Color tokens use CSS variables from the theme system — NEVER hardcode hex values like `text-gray-900` or `bg-blue-600`. Use semantic tokens: `primary`, `destructive`, `muted`, `muted-foreground`, `card`, `card-foreground`, etc.

### Architecture Sources

- **Auth & Session**: `getCurrentUser()` from `lib/auth/session.ts:16-19` — returns `session?.user || null`. Uses NextAuth `getServerSession()` internally [Source: architecture/17-coding-standards.md#17.6]
- **Workspace Context**: `getWorkspaceContext()` from `lib/auth/workspace-context.ts:160` — wrapped in `React.cache()` for request-level deduplication. Redis-backed with 5-min TTL. Throws `WorkspaceAccessError` with typed codes: `UNAUTHORIZED`, `NO_WORKSPACE`, `WORKSPACE_DELETED`, `ACCESS_DENIED` [Source: lib/auth/workspace-context.ts]
- **WorkspaceAccessError**: Defined at `lib/auth/workspace-context.ts:34-42`. Has `code: WorkspaceErrorCode` property. The `NO_WORKSPACE` throw happens at line 105 when `prisma.workspaceMember.findFirst()` returns null
- **Component Standards**: shadcn/ui mandatory for all UI components [Source: architecture/17-coding-standards.md#17.3]
- **Project Structure**: Auth routes under `app/(auth)/`, workspace routes under `app/(workspace)/`, onboarding at `app/onboarding/` (top-level, no parenthetical grouping) [Source: architecture/12-unified-project-structure.md#12.2]
- **Error Handling**: Use typed `WorkspaceAccessError` pattern with error codes [Source: architecture/17-coding-standards.md#17.5]

### Brand Styling Reference

All brand styling utilities are defined in `app/globals.css` and `tailwind.config.ts`. Use these existing utilities — do NOT create new ones or hardcode hex values.

The **auth layout** (`app/(auth)/layout.tsx`) is the canonical pattern to replicate:

```tsx
// Exact structure from app/(auth)/layout.tsx — replicate for onboarding
<div className="flex min-h-screen items-center justify-center bg-section-warm px-4 py-12 sm:px-6 lg:px-8">
  <div className="w-full max-w-md space-y-8">
    <div className="flex justify-center">
      <Link href="/" className="transition-opacity hover:opacity-90">
        <Image
          src="/images/logo-final.png"
          alt="Laglig.se"
          width={176}
          height={67}
          className="h-8 w-auto invert dark:invert-0"
          priority
        />
      </Link>
    </div>
    <Card className="animate-fade-up rounded-xl bg-card p-8 shadow-lg">
      {children}
    </Card>
  </div>
</div>
```

Key styling tokens:

- **Warm background**: `bg-section-warm` — defined in `globals.css:126-128` using `hsl(var(--section-warm))` where `--section-warm: 45 30% 96%`
- **Safiro font**: `font-safiro` class — for primary headings only. Defined in `globals.css:121-123` loading `safiro-medium-webfont.woff2`
- **Card**: shadcn/ui `Card` with `animate-fade-up rounded-xl bg-card p-8 shadow-lg`
- **Entrance animation**: `animate-fade-up` — `globals.css:136-138`, 0.6s ease-out fade + translate-y
- **Button glow** (for CTAs): `shadow-lg shadow-primary/25 hover:shadow-xl hover:shadow-primary/30`
- **Text muted**: `text-muted-foreground` for secondary text
- **Error states**: `bg-destructive/10 text-destructive`
- **Success states**: `bg-emerald-50 text-emerald-800`
- **Warning states** (paused banner): `bg-amber-50 border-amber-200 text-amber-800`

### Relevant Source Tree

```
app/(workspace)/
  layout.tsx                         # MODIFY: Add try-catch for NO_WORKSPACE + WORKSPACE_DELETED
    - Line 1-3: Imports (getCurrentUser, redirect, WorkspaceShell)
    - Line 6: export const dynamic = 'force-dynamic'
    - Line 8-20: WorkspaceLayout — calls getCurrentUser(), redirects to /login if null, renders WorkspaceShell
    - CHANGE: After getCurrentUser() check, add try-catch calling getWorkspaceContext()

app/onboarding/
  layout.tsx                         # NEW: Auth-only layout, replicate auth layout brand styling
  page.tsx                           # NEW: Placeholder page (fully built in Story 10.2)

app/(auth)/layout.tsx                # REFERENCE ONLY: Canonical brand styling to replicate
  - Line 17: bg-section-warm, centered flex layout
  - Line 20-29: Logo with Image/Link, hover:opacity-90
  - Line 31: Card with animate-fade-up rounded-xl bg-card p-8 shadow-lg

lib/auth/
  workspace-context.ts               # READ ONLY: Understand WorkspaceAccessError codes
    - Line 28-32: WorkspaceErrorCode type union
    - Line 34-42: WorkspaceAccessError class with code property
    - Line 53-149: getWorkspaceContextInternal() — throws at line 105 for NO_WORKSPACE, line 111 for WORKSPACE_DELETED
    - Line 160: getWorkspaceContext = cache(getWorkspaceContextInternal)
    - Line 261-269: setActiveWorkspace() — sets httpOnly cookie

  session.ts                         # READ ONLY: getCurrentUser() at line 16-19

lib/hooks/
  use-workspace.tsx                  # MODIFY: Change noWorkspaceRedirect default value
    - Line 47-48: JSDoc comment for noWorkspaceRedirect param
    - Line 54: noWorkspaceRedirect = '/select-workspace' → change to '/onboarding'
    - Line 88-90: 403 + NO_WORKSPACE handling uses noWorkspaceRedirect

app/api/workspace/context/route.ts   # NO CHANGE: Verify only
    - Lines 24-43: Error handling returns 401 for UNAUTHORIZED, 403 for NO_WORKSPACE/WORKSPACE_DELETED

components/features/workspace/
  create-workspace-modal.tsx          # NO CHANGE: Verify it still works in workspace switcher

components/ui/
  card.tsx                           # EXISTING: shadcn/ui Card component (use for onboarding layout)
  button.tsx                         # EXISTING: shadcn/ui Button component (use for CTAs)
```

### Key Implementation Details

1. **Workspace layout change is the critical fix.** Currently `app/(workspace)/layout.tsx` (line 8-20) calls `getCurrentUser()` but does NOT call `getWorkspaceContext()` — it relies on individual pages to call it. The fix adds `getWorkspaceContext()` to the layout itself (option a), catching the error for ALL workspace pages. The workspace context is already cached per request via `React.cache()`, so calling it in layout AND in pages will NOT result in duplicate queries.

2. **The onboarding route must be OUTSIDE the `(workspace)` route group** — otherwise it would be wrapped in the workspace layout that requires a workspace, creating a circular dependency. Place at `app/onboarding/` (top-level).

3. **Do NOT modify the auth callback redirect.** The current flow (auth callback → `/dashboard` → detect no workspace → redirect to `/onboarding`) is fine. Changing the callback to redirect directly to `/onboarding` would require knowing the user's workspace state at callback time, which adds complexity for no benefit.

4. **The `useWorkspace` hook in `lib/hooks/use-workspace.tsx`** makes client-side API calls to `/api/workspace/context` and handles 403 responses at line 88. Update its redirect target (line 54) but keep the error handling logic intact.

5. **Onboarding layout should check workspace existence via a lightweight query**, NOT by calling `getWorkspaceContext()` (which would throw). Query `prisma.workspaceMember.findFirst({ where: { user_id: userId } })` directly. First resolve the user from their session email: `prisma.user.findUnique({ where: { email: session.user.email } })`.

6. **PAUSED workspace handling is in the workspace layout, NOT in onboarding.** Paused users still have a workspace — they should see the workspace shell (read-only) with a banner, not be kicked to onboarding.

### Coding Standards

- Server Components by default — only add `'use client'` when interactivity needed [Source: architecture/17-coding-standards.md#17.3]
- Use `redirect()` from `next/navigation` for server-side redirects
- Import path aliases: `@/lib/auth/workspace-context`, `@/lib/auth/session`, `@/components/ui/card` [Source: architecture/12-unified-project-structure.md#12.5]
- TypeScript strict mode — all new code fully typed [Source: architecture/17-coding-standards.md#17.2]
- shadcn/ui components only — no raw HTML form elements [Source: architecture/17-coding-standards.md#17.3]
- Use theme color tokens (CSS variables), NEVER hardcode hex values [Source: Story 6.21 Dev Notes]
- Lucide Icons for any iconography: `import { ... } from 'lucide-react'` [Source: architecture/3-tech-stack.md#3.1]
- All user-facing text in Swedish [Source: Story 6.21]

### Testing

- **Test approach**: Manual regression testing for routing changes. Verify all paths:
  1. New user (no workspace) → any workspace route → redirected to `/onboarding`
  2. Existing user (has workspace) → any workspace route → normal behavior unchanged
  3. User with deleted workspace → redirect to `/onboarding?state=deleted` → sees "Ditt workspace har raderats"
  4. User with paused workspace → workspace loads with amber paused banner (owner sees "Återaktivera", member sees "Kontakta ägaren")
  5. Unauthenticated user → `/onboarding` → redirected to `/login`
  6. User with workspace → `/onboarding` → redirected to `/dashboard`
  7. Redirect URL preservation: user visits `/laws` without workspace → `/onboarding?redirect=%2Flaws`
- **Test file location (if unit tests added later)**: `tests/unit/app/onboarding/` and `tests/integration/workspace-routing/`
- **Testing framework**: Vitest + React Testing Library [Source: architecture/3-tech-stack.md#3.1]
- **Responsive**: Verify at 320px mobile and 1280px+ desktop — Card should scale within `max-w-md` container

## Change Log

| Date       | Version | Description                                                                                                                            | Author     |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2026-01-30 | 1.0     | Initial story creation                                                                                                                 | Sarah (PO) |
| 2026-01-30 | 1.1     | SM enrichment: Added brand styling reference from Story 6.21, accurate line numbers, design language specifics, implementation details | Bob (SM)   |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered during implementation.

### Completion Notes List

- **Post-QA fix**: Deleted `middleware.ts` — Next.js 16 uses `proxy.ts` convention, having both caused route 404s and server restart loops. The `x-pathname` header logic was merged into `proxy.ts` `handleAuthAndRouting()` by another dev agent.
- Workspace layout now calls `getWorkspaceContext()` in try-catch — `NO_WORKSPACE` and `WORKSPACE_DELETED` errors redirect to `/onboarding` with `?redirect=` param
- Paused workspace banner extracted to `PausedWorkspaceBanner` client component (needs interactivity for reactivation button)
- Client-side `useWorkspace` hook redirect updated from `/select-workspace` to `/onboarding`
- Onboarding layout replicates auth layout brand styling exactly (bg-section-warm, logo, Card with animate-fade-up)
- Onboarding layout checks auth (redirects to /login) and existing workspace (redirects to /dashboard)
- Onboarding page handles `?state=deleted` with dedicated Swedish messaging and CTA placeholder
- TypeScript type-check passes clean, ESLint 0 errors (23 pre-existing warnings unchanged)
- All 19 failing tests are pre-existing (redis, caching, auth signup) — zero new failures introduced

### File List

- `middleware.ts` — DELETED: Conflicted with Next.js 16 `proxy.ts` convention. Logic merged into `proxy.ts`.
- `proxy.ts` — MODIFIED: Added `x-pathname` request header forwarding in `handleAuthAndRouting()`
- `app/(workspace)/layout.tsx` — MODIFIED: Added workspace context guard with NO_WORKSPACE/WORKSPACE_DELETED redirect, paused banner
- `components/features/workspace/paused-workspace-banner.tsx` — NEW: Client component for paused workspace warning banner
- `lib/hooks/use-workspace.tsx` — MODIFIED: Changed noWorkspaceRedirect default from `/select-workspace` to `/onboarding`
- `app/onboarding/layout.tsx` — NEW: Auth-only layout with brand styling, workspace redirect check
- `app/onboarding/page.tsx` — NEW: Placeholder page with deleted workspace state handling
- `docs/stories/10.1.post-auth-workspace-guard.md` — MODIFIED: Task checkboxes, Dev Agent Record

## QA Results

### Review Date: 2026-01-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Solid implementation. All 13 acceptance criteria are met. Code follows project coding standards (TypeScript strict, shadcn/ui, semantic color tokens, Server Components). The workspace guard correctly catches `NO_WORKSPACE` and `WORKSPACE_DELETED` errors and redirects to `/onboarding` with URL preservation. Brand styling on the onboarding layout is an exact match of the auth layout. Two code quality issues were found and fixed during review.

**Risk signals detected:** Auth/routing files touched + 13 ACs → deep review performed.

### Refactoring Performed

- **File**: `middleware.ts`
  - **Change**: Added `config.matcher` to scope middleware execution
  - **Why**: Without a matcher, middleware ran on ALL requests including `_next/static/*`, images, API routes — unnecessary overhead for a header only needed in workspace layout
  - **How**: Added negative-lookahead matcher excluding `api`, `_next/static`, `_next/image`, and static files

- **File**: `app/(workspace)/layout.tsx`
  - **Change**: Extracted `getWorkspaceContextSafe()` helper function
  - **Why**: Original code had `let workspaceContext` that was possibly `undefined` after try/catch, causing TypeScript errors. Also improves separation of concerns — error-to-redirect mapping is isolated from the layout's rendering logic
  - **How**: Helper wraps `getWorkspaceContext()` with redirect logic and returns `WorkspaceContext` (guaranteed non-undefined), keeping the layout component clean

### Compliance Check

- Coding Standards: ✓ TypeScript strict, shadcn/ui components, semantic tokens, Server Components default
- Project Structure: ✓ `app/onboarding/` top-level (outside workspace group), components in `components/features/workspace/`
- Testing Strategy: ✓ Story specifies manual regression testing for routing changes — appropriate for this scope
- All ACs Met: ✓ All 13 acceptance criteria verified against implementation

### Improvements Checklist

- [x] Added middleware `config.matcher` to prevent running on static assets/API routes (`middleware.ts`)
- [x] Extracted `getWorkspaceContextSafe()` helper for clean TypeScript narrowing and separation of concerns (`app/(workspace)/layout.tsx`)
- [ ] Consider adding integration tests for workspace routing redirects in a future story
- [ ] Consider caching onboarding layout DB queries (`prisma.user.findUnique` + `prisma.workspaceMember.findFirst`) if the page sees higher traffic

### Security Review

No security concerns found. Auth checks are present at all entry points:

- Workspace layout: `getCurrentUser()` → redirect to `/login` if null
- Onboarding layout: `getCurrentUser()` → redirect to `/login` if null
- Onboarding layout: workspace existence check → redirect to `/dashboard` if workspace exists (prevents re-onboarding)
- API endpoint: unchanged, continues to return 403 with structured error codes

### Performance Considerations

- **Middleware**: Now scoped with matcher — no longer runs on static assets (fixed during review)
- **Workspace context**: Uses `React.cache()` — layout + page calls share a single DB/Redis query per request
- **Onboarding layout**: Two uncached Prisma queries (`findUnique` + `findFirst`) per request. Acceptable for a low-traffic page (only new users without workspaces). Not worth caching now.

### Files Modified During Review

- `middleware.ts` — Added `config.matcher` export
- `app/(workspace)/layout.tsx` — Extracted `getWorkspaceContextSafe()` helper function

Dev should update File List to note these QA modifications.

### Gate Status

Gate: PASS → docs/qa/gates/10.1-post-auth-workspace-guard.yml

### Recommended Status

✓ Ready for Done — All ACs met, refactoring applied, type-check and lint clean.
