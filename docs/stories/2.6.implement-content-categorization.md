# Story 2.6: Implement Content Type-Specific Categorization

## Status

Draft

## Story

**As a** visitor,
**I want** to browse legal content by category and content type,
**so that** I can discover relevant laws, court cases, and EU regulations for my needs.

## Acceptance Criteria

1. 10 top-level subject categories defined: Arbetsrätt, Dataskydd, Skatterätt, Bolagsrätt, Miljö & Bygg, Livsmedel & Hälsa, Finans, Immaterialrätt, Konsumentskydd, Transport & Logistik
2. AI categorization script uses GPT-4 to classify ALL document types
3. Categorization prompt adapted per content type (SFS: title + first 500 chars, Court cases: summary + decision, EU: title + recitals)
4. Categories stored in `document_subjects` table
5. Category pages created for each content type: `/lagar/kategorier/arbetsratt`, `/rattsfall/kategorier/arbetsratt`, `/eu/kategorier/arbetsratt`
6. Document count shown per category per type
7. Category pages SEO-optimized with meta tags
8. Verification: All 170,000+ documents have assigned categories
9. Manual review of 100 random categorizations shows >90% accuracy
10. Content type filter on category pages

## Tasks / Subtasks

- [ ] Define category taxonomy (AC: 1)
  - [ ] Create 10 top-level categories
  - [ ] Define category descriptions
  - [ ] Add to database as seed data

- [ ] Create AI categorization script (AC: 2, 3)
  - [ ] Create `scripts/categorize-documents.ts`
  - [ ] Implement GPT-4 categorization per content type
  - [ ] Custom prompts for SFS laws, court cases, EU docs
  - [ ] Rate limiting for OpenAI API

- [ ] Store categories (AC: 4)
  - [ ] Insert into `document_subjects` table
  - [ ] Link documents to categories (many-to-many)

- [ ] Create category pages (AC: 5, 6, 7)
  - [ ] Dynamic route: `/lagar/kategorier/[category]/page.tsx`
  - [ ] Dynamic route: `/rattsfall/kategorier/[category]/page.tsx`
  - [ ] Dynamic route: `/eu/kategorier/[category]/page.tsx`
  - [ ] Display document list per category
  - [ ] Show document counts
  - [ ] SEO meta tags

- [ ] Add content type filter (AC: 10)
  - [ ] Filter UI on category pages
  - [ ] Toggle between Laws/Cases/EU
  - [ ] Update URL params on filter change

- [ ] Verify and test (AC: 8, 9)
  - [ ] Check all documents categorized
  - [ ] Random sample accuracy test (100 documents)
  - [ ] Adjust prompts if accuracy <90%

## Dev Notes

### Category Taxonomy

```typescript
const CATEGORIES = [
  {
    code: 'arbetsratt',
    name: 'Arbetsrätt',
    description: 'Employment law, labor relations, workplace safety',
  },
  {
    code: 'dataskydd',
    name: 'Dataskydd',
    description: 'Data protection, GDPR, privacy regulations',
  },
  {
    code: 'skatteratt',
    name: 'Skatterätt',
    description: 'Tax law, VAT, income tax, corporate tax',
  },
  {
    code: 'bolagsratt',
    name: 'Bolagsrätt',
    description: 'Corporate law, company formation, board duties',
  },
  {
    code: 'miljo-bygg',
    name: 'Miljö & Bygg',
    description: 'Environmental law, building permits, construction',
  },
  {
    code: 'livsmedel-halsa',
    name: 'Livsmedel & Hälsa',
    description: 'Food safety, health regulations, medical devices',
  },
  {
    code: 'finans',
    name: 'Finans',
    description: 'Financial services, banking, payment services',
  },
  {
    code: 'immaterialratt',
    name: 'Immaterialrätt',
    description: 'Intellectual property, patents, trademarks, copyright',
  },
  {
    code: 'konsumentskydd',
    name: 'Konsumentskydd',
    description: 'Consumer protection, e-commerce, warranties',
  },
  {
    code: 'transport-logistik',
    name: 'Transport & Logistik',
    description: 'Transportation, logistics, shipping regulations',
  },
]
```

### AI Categorization Script

**scripts/categorize-documents.ts:**

```typescript
import { prisma } from '@/lib/prisma'
import { openai } from '@/lib/openai'
import pLimit from 'p-limit'

const limit = pLimit(50) // 50 concurrent OpenAI requests

async function categorizeAllDocuments() {
  const documents = await prisma.legalDocument.findMany({
    where: {
      subjectTags: {
        none: {}, // Only uncategorized documents
      },
    },
    select: {
      id: true,
      contentType: true,
      title: true,
      summary: true,
      fullText: true,
    },
  })

  console.log(`Categorizing ${documents.length} documents...`)

  const promises = documents.map((doc) => limit(() => categorizeDocument(doc)))

  await Promise.all(promises)

  console.log('✅ Categorization complete')
}

async function categorizeDocument(doc: any) {
  let prompt = ''

  // Adapt prompt based on content type
  switch (doc.contentType) {
    case 'SFS_LAW':
      prompt = `Categorize this Swedish law into ONE of these categories:
- Arbetsrätt (employment law)
- Dataskydd (data protection)
- Skatterätt (tax law)
- Bolagsrätt (corporate law)
- Miljö & Bygg (environmental/construction)
- Livsmedel & Hälsa (food/health)
- Finans (financial services)
- Immaterialrätt (IP)
- Konsumentskydd (consumer protection)
- Transport & Logistik (transportation)

Law title: ${doc.title}
First 500 characters: ${doc.fullText?.substring(0, 500)}

Also classify if this law applies to:
- B2B (business-to-business)
- Private (individuals/consumers)
- Both

Respond in JSON format: {"category": "arbetsratt", "businessType": "B2B"}`
      break

    case 'HD_SUPREME_COURT':
    case 'HOVR_COURT_APPEAL':
    case 'HFD_ADMIN_SUPREME':
      prompt = `Categorize this Swedish court case into ONE category:
[same category list]

Case: ${doc.title}
Summary: ${doc.summary}

Respond in JSON format: {"category": "arbetsratt"}`
      break

    case 'EU_REGULATION':
    case 'EU_DIRECTIVE':
      prompt = `Categorize this EU legislation into ONE category:
[same category list]

Title: ${doc.title}
First 500 characters: ${doc.fullText?.substring(0, 500)}

Respond in JSON format: {"category": "dataskydd"}`
      break
  }

  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 50,
      temperature: 0.3,
    })

    const result = JSON.parse(response.choices[0].message.content!)

    // Create subject tag
    await prisma.documentSubject.create({
      data: {
        documentId: doc.id,
        subjectCode: result.category,
        subjectName:
          CATEGORIES.find((c) => c.code === result.category)?.name || '',
        metadata: {
          businessType: result.businessType,
        },
      },
    })
  } catch (error) {
    console.error(`Failed to categorize document ${doc.id}:`, error)
  }
}
```

### Category Page Implementation

**app/lagar/kategorier/[category]/page.tsx:**

```typescript
import { prisma } from '@/lib/prisma'
import { notFound } from 'next/navigation'

export async function generateStaticParams() {
  return CATEGORIES.map((cat) => ({ category: cat.code }))
}

export async function generateMetadata({ params }: { params: { category: string } }) {
  const cat = CATEGORIES.find((c) => c.code === params.category)

  if (!cat) return {}

  return {
    title: `${cat.name} - Lagar | Laglig.se`,
    description: `Alla svenska lagar inom ${cat.name.toLowerCase()}. ${cat.description}`,
  }
}

export default async function CategoryPage({
  params,
  searchParams,
}: {
  params: { category: string }
  searchParams: { type?: string }
}) {
  const category = CATEGORIES.find((c) => c.code === params.category)

  if (!category) notFound()

  // Fetch laws in this category
  const laws = await prisma.legalDocument.findMany({
    where: {
      contentType: 'SFS_LAW',
      subjectTags: {
        some: {
          subjectCode: params.category,
        },
      },
    },
    include: {
      subjectTags: true,
    },
    orderBy: {
      publicationDate: 'desc',
    },
  })

  // Count documents by type
  const counts = await prisma.documentSubject.groupBy({
    by: ['subjectCode'],
    where: {
      subjectCode: params.category,
    },
    _count: {
      documentId: true,
    },
  })

  return (
    <div className="max-w-6xl mx-auto p-6">
      <h1 className="text-4xl font-bold mb-2">{category.name}</h1>
      <p className="text-gray-600 mb-6">{category.description}</p>

      {/* Content type filter */}
      <div className="flex gap-4 mb-8 border-b">
        <a
          href={`/lagar/kategorier/${params.category}`}
          className="px-4 py-2 border-b-2 border-primary"
        >
          Lagar ({counts.find((c) => c.subjectCode === params.category)?._count.documentId || 0})
        </a>
        <a
          href={`/rattsfall/kategorier/${params.category}`}
          className="px-4 py-2 text-gray-600 hover:text-gray-900"
        >
          Rättsfall
        </a>
        <a
          href={`/eu/kategorier/${params.category}`}
          className="px-4 py-2 text-gray-600 hover:text-gray-900"
        >
          EU-lagstiftning
        </a>
      </div>

      {/* Law list */}
      <div className="space-y-4">
        {laws.map((law) => (
          <a
            key={law.id}
            href={`/lagar/${law.slug}`}
            className="block p-4 border rounded-lg hover:bg-gray-50"
          >
            <h3 className="font-semibold text-lg">{law.title}</h3>
            <p className="text-sm text-gray-600">{law.documentNumber}</p>
            {law.summary && (
              <p className="text-sm text-gray-700 mt-2 line-clamp-2">
                {law.summary}
              </p>
            )}
          </a>
        ))}
      </div>
    </div>
  )
}
```

### Cost Analysis

**GPT-4 Categorization:**

- 170,000 documents
- ~100 tokens per categorization
- Input: $0.03/1K tokens, Output: $0.06/1K tokens
- Total: ~$510 one-time cost

**Storage:**

- ~170,000 DocumentSubject records
- Minimal storage impact (~10MB)

### Important Architecture References

**From Section 4 (Data Models):**

- document_subjects table design
- Many-to-many relationships

**From Feature Spec 04 (Law Pages):**

- Category browsing UX
- Filter patterns

### Testing

**Test File:** `tests/integration/categorization/ai-categorization.test.ts`

```typescript
describe('AI Categorization', () => {
  it('categorizes SFS law correctly', async () => {
    const law = await createTestLaw({
      title: 'Arbetsmiljölagen',
      fullText: 'Denna lag gäller arbetsmiljöarbete...',
    })

    await categorizeDocument(law)

    const subject = await prisma.documentSubject.findFirst({
      where: { documentId: law.id },
    })

    expect(subject?.subjectCode).toBe('arbetsratt')
  })

  it('achieves >90% accuracy on random sample', async () => {
    // Manual verification test
    const sample = await prisma.legalDocument.findMany({
      take: 100,
      orderBy: { createdAt: 'desc' },
      include: { subjectTags: true },
    })

    let correct = 0
    for (const doc of sample) {
      // Manual review would happen here
      // For automated testing, use known categorizations
      if (isCorrectlyCateg orized(doc)) correct++
    }

    const accuracy = correct / sample.length
    expect(accuracy).toBeGreaterThan(0.9)
  })
})
```

### User Responsibilities

- None for this story

### Developer Responsibilities

- Run categorization script on all documents
- Manually verify accuracy on sample
- Adjust prompts if accuracy insufficient
- Monitor OpenAI API costs

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
