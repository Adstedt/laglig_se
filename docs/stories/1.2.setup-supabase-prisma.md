# Story 1.2: Set Up Supabase PostgreSQL with Prisma ORM

## Status
Draft

## Story

**As a** developer,
**I want** to connect to Supabase PostgreSQL and configure Prisma ORM,
**so that** I have a type-safe database layer for all data operations.

## Acceptance Criteria

1. Supabase project created (free tier) with PostgreSQL database
2. Prisma installed and initialized
3. Database connection string configured in `.env.local`
4. Initial Prisma schema created with User and Workspace models
5. First migration generated and applied successfully
6. Prisma Client generated with TypeScript types
7. Database connection tested successfully
8. pgvector extension enabled in Supabase

## Tasks / Subtasks

- [ ] Create Supabase project (AC: 1)
  - [ ] Sign up at supabase.com (free tier)
  - [ ] Create new project: "laglig-se-dev"
  - [ ] Note project URL and anon key
  - [ ] Wait for project provisioning to complete

- [ ] Install and initialize Prisma (AC: 2)
  - [ ] Install Prisma: `npm install prisma --save-dev`
  - [ ] Install Prisma Client: `npm install @prisma/client`
  - [ ] Initialize Prisma: `npx prisma init`
  - [ ] Verify `prisma/schema.prisma` created

- [ ] Configure database connection (AC: 3)
  - [ ] Get connection string from Supabase dashboard (Settings → Database → Connection string → Transaction mode)
  - [ ] Add to `.env.local`:
    ```
    DATABASE_URL="postgresql://postgres.[ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true"
    DIRECT_URL="postgresql://postgres.[ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres"
    ```
  - [ ] Verify `.env.local` is in `.gitignore`

- [ ] Create initial Prisma schema (AC: 4)
  - [ ] Define `User` model (id, email, name, createdAt, updatedAt)
  - [ ] Define `Workspace` model (id, name, ownerId, createdAt, updatedAt)
  - [ ] Add relation: User.workspaces ↔ Workspace.owner
  - [ ] Configure PostgreSQL provider and pgvector preview feature

- [ ] Enable pgvector extension (AC: 8)
  - [ ] Go to Supabase SQL Editor
  - [ ] Run: `CREATE EXTENSION IF NOT EXISTS vector;`
  - [ ] Verify extension enabled: `SELECT * FROM pg_extension WHERE extname = 'vector';`

- [ ] Generate and apply first migration (AC: 5)
  - [ ] Run: `npx prisma migrate dev --name init`
  - [ ] Verify migration created in `prisma/migrations/`
  - [ ] Verify tables exist in Supabase Table Editor

- [ ] Generate Prisma Client (AC: 6)
  - [ ] Run: `npx prisma generate`
  - [ ] Verify TypeScript types generated in `node_modules/.prisma/client`
  - [ ] Create `lib/prisma.ts` singleton instance

- [ ] Test database connection (AC: 7)
  - [ ] Create test API route: `app/api/health/db/route.ts`
  - [ ] Query Prisma: `await prisma.user.count()`
  - [ ] Test endpoint: `curl http://localhost:3000/api/health/db`
  - [ ] Verify returns `{"status": "ok", "database": "connected"}`

## Dev Notes

### Supabase Configuration

**Project Settings:**
- **Region:** Choose closest to target users (EU for Swedish users)
- **Database Password:** Use strong password, store securely
- **Pause Project:** Free tier pauses after 1 week inactivity (acceptable for MVP)

**Connection Pooling:**
- **Transaction Mode (Port 6543):** Use for Prisma migrations and short-lived connections
- **Session Mode (Port 5432):** Use for long-lived connections and LISTEN/NOTIFY
- **DATABASE_URL:** Uses pgbouncer (port 6543) for connection pooling
- **DIRECT_URL:** Direct connection (port 5432) for migrations

### Prisma Schema Template

```prisma
// prisma/schema.prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector]
}

model User {
  id         String      @id @default(uuid()) @db.Uuid
  email      String      @unique
  name       String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  workspaces Workspace[]

  @@map("users")
}

model Workspace {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  ownerId   String   @db.Uuid
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workspaces")
}
```

### Prisma Client Singleton

**lib/prisma.ts:**
```typescript
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
})

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

**Why Singleton?**
- Next.js hot-reloading creates multiple Prisma instances in dev
- Singleton prevents "too many connections" errors
- Production: Single instance per deployment

### Important Architecture References

**From Section 9 (Database Schema):**
- Full 29-entity schema defined
- User and Workspace are foundational entities
- pgvector required for AI embeddings (Story 3.x)

**From Section 11.3 (Backend Architecture):**
- Supabase connection pooling strategy
- Direct URL for migrations, pooled URL for app queries
- Connection limits: Free tier = 60 connections

**From Section 13.3 (Local Development):**
- Alternative: Use Supabase CLI for local database
- Command: `supabase start` (starts local PostgreSQL)
- Benefits: Offline development, faster iteration

### Testing

**Test File:** `tests/integration/database/connection.test.ts`

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import { prisma } from '@/lib/prisma'

describe('Database Connection', () => {
  afterAll(async () => {
    await prisma.$disconnect()
  })

  it('connects to database successfully', async () => {
    const result = await prisma.$queryRaw`SELECT 1 as result`
    expect(result).toBeDefined()
  })

  it('can create and query User', async () => {
    const user = await prisma.user.create({
      data: {
        email: 'test@example.com',
        name: 'Test User',
      },
    })

    expect(user.id).toBeDefined()
    expect(user.email).toBe('test@example.com')

    await prisma.user.delete({ where: { id: user.id } })
  })

  it('pgvector extension enabled', async () => {
    const result = await prisma.$queryRaw`
      SELECT * FROM pg_extension WHERE extname = 'vector'
    `
    expect(result).toHaveLength(1)
  })
})
```

**Testing Standards:**
- **Framework:** Vitest
- **Test Location:** `tests/integration/database/`
- **Run:** `npm run test:integration`
- **Database:** Use test database or transactions to avoid pollution

### Dependencies

```json
{
  "dependencies": {
    "@prisma/client": "^5.7.0"
  },
  "devDependencies": {
    "prisma": "^5.7.0"
  }
}
```

### User Responsibilities
- Create Supabase account
- Provide database credentials to development team securely (use password manager)

### Developer Responsibilities
- Install and configure Prisma
- Create and apply migrations
- Test database connectivity
- Document connection string format for team

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-11 | 1.0 | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
