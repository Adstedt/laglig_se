# Story 14.11: Compliance Partner Chat Interface

## Status

Draft

## Story

As a workspace member, I want to ask the compliance partner general questions about laws and my company's compliance posture, so that I have an always-available expert advisor beyond the change assessment flow.

## Context & Dependencies

**Why this story exists:** While Story 14.10 provides the focused assessment experience for specific changes, this story provides the general-purpose compliance chat. Users can ask any compliance question: "Vilka krav ställer AFS 2023:1 på oss?", "Visa alla ändringar senaste månaden", "Hur har vi hanterat liknande ändringar tidigare?". The agent has full tool access and draws on all knowledge sources.

This enhances or replaces the basic chat UI from Story 3.3.

**Builds on:** Story 14.10 (assessment flow — reusable components: ToolConfirmationCard, message formatting patterns)

**Depends on:**
- Story 14.7 (agent tools — read + write)
- Story 14.8 (RAG pipeline)
- Story 14.9 (system prompt with company context)

**Depended on by:** Nothing — this is the final story in the epic.

## Acceptance Criteria

### Chat Interface

1. Route: `/laglistor/compliance-partner` (or `/compliance-partner` — accessible from workspace navigation)
2. Full-page chat interface with message history
3. Uses Vercel AI SDK `useChat()` hook with streaming
4. Agent has access to ALL tools from Story 14.7 (both read and write)
5. Swedish UI labels: "Skriv ett meddelande...", "Skicka"

### Navigation

6. New navigation item in left sidebar: "Compliance Partner" with a distinct icon (e.g., MessageCircle or Bot from Lucide)
7. Accessible from both desktop and mobile sidebar

### Conversation Persistence

8. Conversations stored in `WorkspaceConversation` model (from Story 14.5) with type = AD_HOC
9. Conversation history loaded on page revisit (within same session/day — exact persistence strategy TBD)
10. "Ny konversation" button to start fresh

### Tool Use Visibility

11. When the agent uses a tool, show a collapsible "Agent söker..." panel with tool name and parameters
12. When tool results return, show a brief summary (e.g., "Hittade 8 relevanta avsnitt i 3 lagar")
13. Write tool confirmation UI (reuse from Story 14.10)

### Onboarding Nudge

14. If WorkspaceProfile.profileCompleteness < 30, show a banner: "Vill du berätta om ert företag? Jag kan ge bättre råd med mer kontext." with link to onboarding flow (Story 14.5)

### API Route

15. API route: `app/api/agent/chat/route.ts` using `streamText()` with full tool access
16. System prompt from Story 14.9 with company context injected

### Testing

17. At least 10 unit tests covering chat rendering, tool visibility, onboarding nudge, navigation

## Tasks / Subtasks

- [ ] **Task 1: API route** (AC: 15-16)
  - [ ] Create `app/api/agent/chat/route.ts`
  - [ ] Load WorkspaceProfile for company context
  - [ ] Construct system prompt from Story 14.9 base + company context
  - [ ] Configure `streamText()` with all tools from Story 14.7
  - [ ] Handle conversation context (pass conversationId for persistence)

- [ ] **Task 2: Chat page** (AC: 1-5)
  - [ ] Create `app/(workspace)/compliance-partner/page.tsx`
  - [ ] Server component wrapper that loads workspace context
  - [ ] Load existing conversation if present
  - [ ] Render client chat component

- [ ] **Task 3: Chat component** (AC: 2-5)
  - [ ] Create `components/features/compliance-partner/compliance-chat.tsx`
  - [ ] Configure `useChat()` with `/api/agent/chat` endpoint
  - [ ] Message list with streaming support
  - [ ] Input field with Swedish placeholder: "Skriv ett meddelande..."
  - [ ] Send button with Swedish label: "Skicka"
  - [ ] Reuse message formatting patterns from Story 14.10
  - [ ] Handle empty state with suggested prompts

- [ ] **Task 4: Navigation** (AC: 6-7)
  - [ ] Add "Compliance Partner" navigation item to `components/layout/left-sidebar.tsx`
  - [ ] Use distinct Lucide icon (MessageCircle, Bot, or Sparkles)
  - [ ] Add matching item to `components/layout/mobile-sidebar.tsx`
  - [ ] Ensure isActive href matching works for the new route

- [ ] **Task 5: Conversation persistence** (AC: 8-10)
  - [ ] On first message, create WorkspaceConversation with type = AD_HOC
  - [ ] On subsequent messages, update the conversation transcript
  - [ ] On page load, check for recent conversation and load message history
  - [ ] "Ny konversation" button that clears state and starts fresh
  - [ ] Server action: `getOrCreateConversation()`, `updateConversation()`

- [ ] **Task 6: Tool visibility** (AC: 11-13)
  - [ ] Create `components/features/compliance-partner/tool-activity-panel.tsx`
  - [ ] Collapsible panel showing tool name and parameters during execution
  - [ ] Brief result summary after tool completes
  - [ ] Use `toolInvocations` from Vercel AI SDK message parts
  - [ ] Reuse ToolConfirmationCard from Story 14.10 for write tool confirmation

- [ ] **Task 7: Onboarding nudge** (AC: 14)
  - [ ] Create onboarding nudge banner component
  - [ ] Check WorkspaceProfile.profileCompleteness on load
  - [ ] Show banner if completeness < 30
  - [ ] Link to onboarding flow (Story 14.5)
  - [ ] Dismiss on close, store in sessionStorage to avoid repeated display

- [ ] **Task 8: Tests** (AC: 17)
  - [ ] Test chat component renders empty state
  - [ ] Test chat component renders message list
  - [ ] Test input field has Swedish placeholder
  - [ ] Test send button has Swedish label
  - [ ] Test tool activity panel shows during tool execution
  - [ ] Test tool activity panel hides after completion
  - [ ] Test onboarding nudge appears when profileCompleteness < 30
  - [ ] Test onboarding nudge hidden when profileCompleteness >= 30
  - [ ] Test navigation item renders in left sidebar
  - [ ] Test navigation item renders in mobile sidebar
  - [ ] Reach minimum 10 unit tests

## Dev Notes

- The existing chat UI from Story 3.3 at `app/(workspace)/chat/` can be referenced for patterns but this is a NEW page with a different purpose (compliance-specific, has tools).
- Reuse components from Story 14.10 where possible: ToolConfirmationCard, message formatting.
- Left sidebar pattern: add between existing items. Reference `components/layout/left-sidebar.tsx` for the navigation pattern with `isActive` href matching.
- Mobile sidebar: mirror desktop sidebar changes in `components/layout/mobile-sidebar.tsx`.
- Conversation persistence: on first message, create a WorkspaceConversation with type=AD_HOC. On subsequent messages, update the transcript. On page load, check for recent conversation and load it.
- Tool activity panel: similar to GitHub Copilot's "thinking" indicator. Shows tool name, parameters (collapsed), and result summary. Uses Vercel AI SDK's `onToolCall` callback or `toolInvocations` from message parts.
- Onboarding nudge: simple Alert component from shadcn/ui. Only show once per session (use sessionStorage or state).
- `useChat()` hook config:
  ```typescript
  const { messages, input, handleInputChange, handleSubmit } = useChat({
    api: '/api/agent/chat',
    body: { conversationId },
  })
  ```
- Source tree:
  - `app/(workspace)/compliance-partner/page.tsx` (new)
  - `components/features/compliance-partner/compliance-chat.tsx` (new)
  - `components/features/compliance-partner/tool-activity-panel.tsx` (new)
  - `app/api/agent/chat/route.ts` (new)
- Existing patterns to follow:
  - Story 3.3 chat: `app/(workspace)/chat/page.tsx`
  - Left sidebar: `components/layout/left-sidebar.tsx`
  - Mobile sidebar: `components/layout/mobile-sidebar.tsx`
  - Workspace scoping: `withWorkspace()` from `lib/auth/workspace-context.ts`
- Lucide icons for navigation: `MessageCircle`, `Bot`, or `Sparkles`

## Testing

- **Test files:**
  - `tests/unit/components/features/compliance-partner/compliance-chat.test.ts`
  - `tests/unit/components/features/compliance-partner/tool-activity-panel.test.ts`
- **What to test:**
  - Chat component renders with empty state and suggested prompts
  - Chat component renders message list with user and agent messages
  - Input field has correct Swedish placeholder text
  - Send button has correct Swedish label
  - Tool activity panel shows collapsible panel during tool execution
  - Tool activity panel displays result summary after completion
  - Onboarding nudge appears when profileCompleteness < 30
  - Onboarding nudge is hidden when profileCompleteness >= 30
  - Navigation item renders in left sidebar with correct icon and label
  - Navigation item renders in mobile sidebar
- **Patterns:** Vitest + React Testing Library. Mock `useChat()` hook from `@ai-sdk/react`. Mock server actions for conversation persistence.

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2026-02-18 | 0.1     | Initial draft              | Claude |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
