# Story 3.13: Workspace Legal Sources Integration

## Status

Ready for Review

## Story

**As a** logged-in user,
**I want** to browse legal sources (Rättskällor, Lagar, Rättsfall, EU-rätt) within my workspace context,
**so that** I stay within the authenticated experience without jumping to public pages.

## Context

Currently, the sidebar links to `/rattskallor` which is a public route under `app/(public)/`. When users click these links, they leave the workspace context (no sidebars, no workspace-scoped experience). This creates a disjointed UX.

This story:

1. Creates workspace routes that render the same catalogue components within workspace layout
2. Restructures sidebar navigation to match the landing page's "Lagar" dropdown structure
3. Removes duplicate/confusing navigation entries

**Related Stories:**

- Story 3.0: Authenticated App Shell Layout (established the sidebar structure)
- Story 2.12: Rättskällor Catalogue Page (created the public catalogue pages)

## Acceptance Criteria

1. Workspace routes exist for legal sources:
   - `/browse/rattskallor` → Browse all legal sources (within workspace layout)
   - `/browse/lagar` → Swedish laws catalogue
   - `/browse/rattsfall` → Court cases catalogue
   - `/browse/eu` → EU legislation catalogue

   **Note:** Routes use `/browse/` prefix to avoid conflicts with existing public SEO routes.

2. Workspace routes render existing catalogue components (`CatalogueResults`, `CatalogueFilters`, `CatalogueSearchBar`) within workspace layout

3. Page header follows workspace page pattern:
   - Title (h1) and description matching dashboard/settings style
   - Breadcrumbs work correctly for workspace routes

4. Left sidebar "Rättskällor" is an accordion with subcategories:
   - Bläddra alla → `/browse/rattskallor`
   - Svenska lagar → `/browse/lagar`
   - Rättsfall → `/browse/rattsfall`
   - EU-rätt → `/browse/eu`

5. Left sidebar "Laglistor" accordion updated:
   - Keep "Mina laglistor" → `/laglistor`
   - Remove "Alla lagar" (duplicate, now under Rättskällor)

6. Mobile sidebar mirrors the desktop sidebar changes (accordion for Rättskällor)

7. All workspace legal source routes are protected by authentication middleware

8. Clicking individual law/case links from results opens the detail page (can remain public routes for SEO, or workspace routes if detail pages exist)

## Tasks / Subtasks

- [x] **Task 1: Create workspace route structure** (AC: 1, 2, 7)
  - [x] Create `app/(workspace)/rattskallor/page.tsx` - imports and renders catalogue components
  - [x] Create `app/(workspace)/rattskallor/loading.tsx` - skeleton loader
  - [x] Create `app/(workspace)/lagar/page.tsx` - Swedish laws filtered view
  - [x] Create `app/(workspace)/rattsfall/page.tsx` - Court cases filtered view
  - [x] Create `app/(workspace)/eu/page.tsx` - EU legislation filtered view
  - [x] Ensure routes are covered by existing workspace layout authentication

- [x] **Task 2: Implement workspace page headers** (AC: 3)
  - [x] Each page has consistent header with title + description
  - [x] Follow pattern from `dashboard/page.tsx` (h1 + muted-foreground description)
  - [x] Verify breadcrumbs render correctly via existing `breadcrumbs.tsx`

- [x] **Task 3: Update left sidebar navigation** (AC: 4, 5)
  - [x] Modify `components/layout/left-sidebar.tsx`:
    - [x] Change "Rättskällor" from direct link to accordion
    - [x] Add subItems: Bläddra alla, Svenska lagar, Rättsfall, EU-rätt
    - [x] Remove "Alla lagar" from "Laglistor" accordion
  - [x] Update NavItem type if needed to support nested accordions

- [x] **Task 4: Update mobile sidebar navigation** (AC: 6)
  - [x] Modify `components/layout/mobile-sidebar.tsx`:
    - [x] Mirror desktop changes for Rättskällor accordion
    - [x] Remove "Alla lagar" from Laglistor
    - [x] Ensure touch-friendly accordion behavior

- [x] **Task 5: Update breadcrumbs mapping** (AC: 3)
  - [x] Add entries to `components/layout/breadcrumbs.tsx` for new routes:
    - `lagar: 'Lagar'`
    - `rattsfall: 'Rättsfall'`
    - `eu: 'EU-rätt'`

- [x] **Task 6: Write tests** (AC: 1-7)
  - [x] Unit tests for updated left-sidebar.tsx (accordion behavior, correct links)
  - [x] Unit tests for updated mobile-sidebar.tsx
  - [x] Unit tests for breadcrumbs route labels

## Dev Notes

### Relevant Source Tree

```
app/
├── (workspace)/
│   ├── layout.tsx          # Existing workspace layout with auth protection
│   ├── dashboard/page.tsx  # Reference for page header pattern
│   ├── settings/page.tsx   # Reference for page header pattern
│   └── [NEW] rattskallor/  # New workspace route
│   └── [NEW] lagar/        # New workspace route
│   └── [NEW] rattsfall/    # New workspace route
│   └── [NEW] eu/           # New workspace route
├── (public)/
│   └── rattskallor/        # Existing public routes (keep for SEO)
│       ├── page.tsx        # Has CatalogueResults, CatalogueFilters components
│       ├── lagar/page.tsx
│       ├── rattsfall/page.tsx
│       └── eu-ratt/page.tsx

components/
├── layout/
│   ├── left-sidebar.tsx    # Update: Rättskällor accordion, remove duplicate
│   ├── mobile-sidebar.tsx  # Update: Mirror desktop changes
│   └── breadcrumbs.tsx     # Update: Add route mappings
├── features/
│   └── catalogue/
│       ├── catalogue-results.tsx      # Reuse in workspace routes
│       ├── catalogue-filters.tsx      # Reuse in workspace routes
│       ├── catalogue-search-bar.tsx   # Reuse in workspace routes
│       └── mobile-filter-drawer.tsx   # Reuse in workspace routes
```

[Source: docs/architecture/12-unified-project-structure.md]

### Page Header Pattern

Reference `dashboard/page.tsx` for consistent workspace page headers:

```tsx
<div className="space-y-6">
  <div>
    <h1 className="text-2xl font-semibold">Page Title</h1>
    <p className="mt-1 text-sm text-muted-foreground">Page description</p>
  </div>
  {/* Page content */}
</div>
```

### Sidebar NavItem Structure

Current structure in `left-sidebar.tsx`:

```tsx
interface NavItem {
  title: string
  icon: React.ComponentType<{ className?: string }>
  href: string
  isToggle?: boolean
  isAccordion?: boolean
  disabled?: boolean
  lockedReason?: string
  subItems?: { title: string; href: string }[]
}
```

Transform Rättskällor from:

```tsx
{
  title: 'Rättskällor',
  icon: BookOpen,
  href: '/rattskallor',
}
```

To:

```tsx
{
  title: 'Rättskällor',
  icon: BookOpen,
  href: '#',
  isAccordion: true,
  subItems: [
    { title: 'Bläddra alla', href: '/rattskallor' },
    { title: 'Svenska lagar', href: '/lagar' },
    { title: 'Rättsfall', href: '/rattsfall' },
    { title: 'EU-rätt', href: '/eu' },
  ],
}
```

### Catalogue Component Reuse

The workspace pages should import and compose existing catalogue components:

```tsx
// app/(workspace)/rattskallor/page.tsx
import { CatalogueResults } from '@/components/features/catalogue/catalogue-results'
import { CatalogueFilters } from '@/components/features/catalogue/catalogue-filters'
import { CatalogueSearchBar } from '@/components/features/catalogue/catalogue-search-bar'
import { MobileFilterDrawer } from '@/components/features/catalogue/mobile-filter-drawer'

export default async function WorkspaceRattskallor({ searchParams }) {
  // Same logic as public page, different layout wrapper
}
```

### Breadcrumbs Update

Add to `breadcrumbs.tsx` pathTitles map:

```tsx
const pathTitles: Record<string, string> = {
  // existing...
  rattskallor: 'Rättskällor',
  lagar: 'Lagar',
  rattsfall: 'Rättsfall',
  eu: 'EU-rätt',
}
```

### Authentication

Workspace routes under `app/(workspace)/` are automatically protected by the workspace layout's auth check. No additional middleware configuration needed.

[Source: docs/architecture/12-unified-project-structure.md - middleware.ts section]

### Testing

**Test file locations:**

- `tests/unit/components/layout/left-sidebar.test.tsx`
- `tests/unit/components/layout/mobile-sidebar.test.tsx`
- `tests/integration/workspace/legal-sources.test.ts`

**Test patterns:**

- Use Vitest + React Testing Library
- Mock next/navigation for route testing
- Test accordion expand/collapse behavior
- Verify correct hrefs for all navigation items

[Source: docs/architecture/17-coding-standards.md]

## Change Log

| Date       | Version | Description                                             | Author      |
| ---------- | ------- | ------------------------------------------------------- | ----------- |
| 2025-12-21 | 1.0     | Initial draft                                           | Bob (SM)    |
| 2025-12-21 | 1.1     | Implementation complete - all tasks done, tests passing | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes

- Created 5 new workspace routes under `app/(workspace)/` for legal source browsing within authenticated context
- Each workspace page follows the dashboard header pattern (`text-2xl font-semibold` h1 + `text-sm text-muted-foreground` description)
- Sidebar navigation updated to use accordion for Rättskällor with 4 sub-items (Bläddra alla, Svenska lagar, Rättsfall, EU-rätt)
- Removed "Alla lagar" from Laglistor accordion (was duplicate)
- Both desktop and mobile sidebars updated with identical navigation structure
- Breadcrumbs extended with route labels for `rattsfall` and `eu`
- All 26 new tests pass (11 for left-sidebar, 8 for mobile-sidebar, 7 for breadcrumbs)
- TypeScript compiles without errors
- Existing catalogue components (CatalogueResults, CatalogueFilters, CatalogueSearchBar, MobileFilterDrawer) reused without modification

### File List

**New Files:**

- `app/(workspace)/browse/rattskallor/page.tsx` - Workspace catalogue page for all legal sources
- `app/(workspace)/browse/rattskallor/loading.tsx` - Skeleton loader for rattskallor page
- `app/(workspace)/browse/lagar/page.tsx` - Workspace catalogue page for Swedish laws (SFS)
- `app/(workspace)/browse/rattsfall/page.tsx` - Workspace catalogue page for court cases
- `app/(workspace)/browse/eu/page.tsx` - Workspace catalogue page for EU legislation
- `tests/unit/components/layout/left-sidebar.test.tsx` - Unit tests for left sidebar accordion
- `tests/unit/components/layout/mobile-sidebar.test.tsx` - Unit tests for mobile sidebar accordion
- `tests/unit/components/layout/breadcrumbs.test.tsx` - Unit tests for breadcrumb labels

**Modified Files:**

- `components/layout/left-sidebar.tsx` - Changed Rättskällor to accordion with `/browse/` paths, removed Alla lagar from Laglistor
- `components/layout/mobile-sidebar.tsx` - Mirror changes from left-sidebar
- `components/layout/breadcrumbs.tsx` - Added route labels for browse, rattsfall, and eu

## QA Results

### Review Date: 2025-12-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is well-executed with consistent patterns throughout. All workspace route pages follow the established dashboard header pattern (`text-2xl font-semibold` + `text-sm text-muted-foreground`). Catalogue components are properly reused without modification. Sidebar accordion behavior is correctly implemented with proper state management for expand/collapse.

### Requirements Traceability

| AC                                | Status | Test Coverage                                                                                   |
| --------------------------------- | ------ | ----------------------------------------------------------------------------------------------- |
| AC 1 (Workspace routes)           | ✓ Met  | `left-sidebar.test.tsx:81-104`, `mobile-sidebar.test.tsx:75-98` verify correct `/browse/` hrefs |
| AC 2 (Catalogue components)       | ✓ Met  | Route files import CatalogueResults, CatalogueFilters, CatalogueSearchBar, MobileFilterDrawer   |
| AC 3 (Page headers + breadcrumbs) | ✓ Met  | `breadcrumbs.test.tsx:30-56` verify route labels; pages follow dashboard pattern                |
| AC 4 (Rättskällor accordion)      | ✓ Met  | `left-sidebar.test.tsx:60-118` tests accordion expand/collapse and subItems                     |
| AC 5 (Laglistor updated)          | ✓ Met  | `left-sidebar.test.tsx:121-146` verifies "Alla lagar" removed                                   |
| AC 6 (Mobile sidebar)             | ✓ Met  | `mobile-sidebar.test.tsx` full coverage, mirrors desktop                                        |
| AC 7 (Auth protection)            | ✓ Met  | `app/(workspace)/layout.tsx:10-13` - getCurrentUser() check with redirect                       |
| AC 8 (Detail page links)          | ✓ Met  | Uses existing CatalogueResults component link behavior                                          |

### Refactoring Performed

None required. Code quality is good as-is.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode compliant, proper component patterns
- Project Structure: ✓ Files placed in correct locations under `app/(workspace)/browse/`
- Testing Strategy: ✓ Unit tests for sidebar components and breadcrumbs (26 tests passing)
- All ACs Met: ✓ All 8 acceptance criteria validated

### Improvements Checklist

- [x] All acceptance criteria implemented correctly
- [x] Unit tests cover sidebar accordion behavior
- [x] Breadcrumb route labels configured
- [x] Authentication protection via workspace layout
- [ ] Consider extracting `CatalogueResultsSkeleton` to shared component (low priority, future improvement)
- [ ] Add `aria-describedby` to Sheet component for better accessibility (minor)

### Security Review

**Status: PASS**

- Authentication properly enforced via workspace layout (`getCurrentUser()` check)
- No sensitive data exposure
- Uses existing middleware protection

### Performance Considerations

**Status: PASS**

- Uses `Suspense` boundaries for loading states
- Skeleton loaders provide good UX during data fetching
- Component reuse avoids code duplication
- No unnecessary client-side rendering

### Files Modified During Review

None - no refactoring was necessary.

### Gate Status

Gate: **PASS** → `docs/qa/gates/3.13-workspace-legal-sources-integration.yml`

### Recommended Status

✓ Ready for Done

All acceptance criteria are met, tests pass, and code follows established patterns.
