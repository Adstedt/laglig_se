# Story 2.4b: EU Legislation Comprehensive Ingestion & Relationship Tracking

## Status

Planning

## Executive Summary

This plan covers the complete ingestion of ~65,000 EU documents with:

- Full HTML content for page rendering
- Complete relationship data (citations, legal basis, amendments)
- Daily sync for ongoing change tracking
- Cross-reference linking for relationship visualization

---

## Current State Analysis

### Database Statistics

| Model                    | Count  | Notes                        |
| ------------------------ | ------ | ---------------------------- |
| SFS Laws                 | 10,927 | Full text + HTML             |
| SFS Amendments (tracked) | 13,725 | Via `Amendment` table        |
| Document Versions        | 11,109 | Version history              |
| Cross References         | 13,036 | All type `CITES` (court→SFS) |
| EU Regulations           | 6,136  | 4,608 with HTML (75%)        |
| EU Directives            | 44     | 0 with HTML                  |
| EU with citations        | 0      | Not populated!               |

### Root Cause: Empty Relationship Data

Investigation revealed:

1. **SPARQL API has relationship data** - regulations have up to 125 citations each
2. **Our query returns empty** - the `GROUP_CONCAT` on multi-valued relationships isn't working
3. **Work URIs needed** - relationships are stored as Work URIs, not CELEX numbers directly

**Example: A regulation with citations:**

```
32024R2509: 125 citations
32018R1046: 108 citations
32020R0852: 93 citations
```

---

## Architecture Comparison: SFS vs EU

### SFS Law Change Tracking

```
┌─────────────────────────────────────────────────────────────────┐
│                    SFS Law (e.g., Arbetsmiljölagen)             │
│                         legal_documents                          │
└───────────────────────────────┬─────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────────┐
        │                       │                           │
        ▼                       ▼                           ▼
┌───────────────┐     ┌─────────────────┐         ┌─────────────────┐
│  Amendment    │     │ DocumentVersion │         │ CrossReference  │
│  (tracking)   │     │  (snapshots)    │         │  (citations)    │
├───────────────┤     ├─────────────────┤         ├─────────────────┤
│ SFS 2022:1109 │     │ Version 1       │         │ CITES: SFS →    │
│ SFS 2020:432  │     │ Version 2       │         │   court cases   │
│ SFS 2019:100  │     │ ...             │         └─────────────────┘
└───────────────┘     └─────────────────┘

Key: Amendments don't exist as separate docs - detected from text changes
```

### EU Document Relationships (Target State)

```
┌─────────────────────────────────────────────────────────────────┐
│                  EU Regulation (e.g., GDPR)                      │
│               legal_documents + eu_documents                     │
└───────────────────────────────┬─────────────────────────────────┘
                                │
    ┌───────────────────────────┼───────────────────────────────┐
    │                           │                               │
    ▼                           ▼                               ▼
┌─────────────────┐   ┌─────────────────┐           ┌─────────────────┐
│ CrossReference  │   │ CrossReference  │           │ CrossReference  │
│ (LEGAL_BASIS)   │   │ (CITES)         │           │ (AMENDS)        │
├─────────────────┤   ├─────────────────┤           ├─────────────────┤
│ Treaty articles │   │ Other regs/dirs │           │ Previous acts   │
│ TFEU Art 16     │   │ 32016R0679 →    │           │ being amended   │
└─────────────────┘   │   32018R1725    │           └─────────────────┘
                      └─────────────────┘

                              +
                              │
                              ▼
                    ┌─────────────────┐
                    │ EU Consolidated │
                    │ Versions        │
                    │ (02016R0679-*)  │
                    └─────────────────┘

Key: Unlike SFS, EU amendments ARE separate documents with own CELEX
```

---

## Implementation Plan

### Phase 1: Fix Relationship Data Ingestion

**Problem:** Current SPARQL query with `GROUP_CONCAT` on relationships returns empty.

**Solution:** Separate query for relationship data, post-process after main document fetch.

#### Task 1.1: Create Relationship Fetch Function

```typescript
// lib/external/eurlex.ts

/**
 * Fetches relationship data for a batch of CELEX numbers.
 * Separate from main metadata query to avoid GROUP_CONCAT issues.
 */
export async function fetchDocumentRelationships(
  celexNumbers: string[]
): Promise<Map<string, DocumentRelationships>> {
  const query = `
PREFIX cdm: <http://publications.europa.eu/ontology/cdm#>

SELECT ?celex ?relationType ?targetCelex
WHERE {
  VALUES ?celex { ${celexNumbers.map((c) => `"${c}"`).join(' ')} }

  ?work cdm:resource_legal_id_celex ?celex .

  {
    ?work cdm:work_cites_work ?target .
    ?target cdm:resource_legal_id_celex ?targetCelex .
    BIND("CITES" AS ?relationType)
  } UNION {
    ?work cdm:resource_legal_based_on_resource_legal ?target .
    ?target cdm:resource_legal_id_celex ?targetCelex .
    BIND("LEGAL_BASIS" AS ?relationType)
  } UNION {
    ?work cdm:resource_legal_amends_resource_legal ?target .
    ?target cdm:resource_legal_id_celex ?targetCelex .
    BIND("AMENDS" AS ?relationType)
  }
}
`
  // Execute and aggregate by CELEX
}
```

#### Task 1.2: Update Ingestion Script

Modify `scripts/ingest-eu-by-year.ts`:

1. Fetch documents in batches of 100
2. After inserting documents, fetch relationships for the batch
3. Store relationships in `cites_celex`, `legal_basis_celex` arrays
4. Create `CrossReference` records for linkable documents

---

### Phase 2: Create CrossReference Records for EU

**Goal:** Enable relationship visualization between EU documents.

#### Task 2.1: Extend ReferenceType Enum

```prisma
enum ReferenceType {
  CITES
  IMPLEMENTS        // Directive → SFS (national implementation)
  AMENDS           // NEW: EU doc amends another EU doc
  REFERENCES
  RELATED
  LEGAL_BASIS      // NEW: Document's legal foundation
  CONSOLIDATED_OF  // NEW: Consolidated version of base act
}
```

#### Task 2.2: Create EU CrossReference Builder

```typescript
// lib/sync/eu-crossref-builder.ts

/**
 * Creates CrossReference records from EU document relationships.
 * Only creates references when BOTH source and target exist in DB.
 */
export async function buildEuCrossReferences(
  documentId: string,
  citesCelex: string[],
  legalBasisCelex: string[],
  amendsCelex: string[]
): Promise<void> {
  // Lookup target documents by CELEX
  const targetDocs = await prisma.euDocument.findMany({
    where: {
      celex_number: { in: [...citesCelex, ...legalBasisCelex, ...amendsCelex] },
    },
    select: { document_id: true, celex_number: true },
  })

  const celexToDocId = new Map(
    targetDocs.map((d) => [d.celex_number, d.document_id])
  )

  // Create CrossReferences for found targets
  const crossRefs = []

  for (const celex of citesCelex) {
    const targetId = celexToDocId.get(celex)
    if (targetId) {
      crossRefs.push({
        source_document_id: documentId,
        target_document_id: targetId,
        reference_type: 'CITES',
      })
    }
  }
  // ... similar for LEGAL_BASIS, AMENDS

  await prisma.crossReference.createMany({
    data: crossRefs,
    skipDuplicates: true,
  })
}
```

#### Task 2.3: Post-Ingestion CrossReference Build

After all documents are ingested, run a script to build CrossReferences:

```bash
pnpm tsx scripts/build-eu-crossrefs.ts
```

This ensures all target documents exist before creating references.

---

### Phase 3: Content Backfill

**Problem:** 25% of ingested EU docs have no HTML content.

#### Task 3.1: Create Content Backfill Script

```typescript
// scripts/backfill-eu-content.ts

/**
 * Fetches HTML content for EU documents missing it.
 */
async function backfillContent() {
  const docsWithoutContent = await prisma.legalDocument.findMany({
    where: {
      content_type: { in: ['EU_REGULATION', 'EU_DIRECTIVE'] },
      html_content: null,
    },
    include: { eu_document: true },
  })

  for (const doc of docsWithoutContent) {
    const content = await fetchDocumentContentViaCellar(
      doc.eu_document!.celex_number
    )
    if (content) {
      await prisma.legalDocument.update({
        where: { id: doc.id },
        data: {
          html_content: content.html,
          full_text: content.plainText,
        },
      })
    }
  }
}
```

---

### Phase 4: Daily Sync for EU Documents

**Goal:** Detect new and modified EU documents daily.

#### Task 4.1: EUR-Lex Change Detection Strategy

Unlike Riksdagen (which has `systemdatum`), EUR-Lex provides:

- `cdm:cmr#lastModificationDate` - Last modification timestamp
- New documents appear with recent publication dates

```sparql
# Documents modified in last 7 days
PREFIX cdm: <http://publications.europa.eu/ontology/cdm#>

SELECT ?celex ?lastModified
WHERE {
  ?work cdm:resource_legal_id_celex ?celex .
  ?work <http://publications.europa.eu/ontology/cdm/cmr#lastModificationDate> ?lastModified .

  FILTER(?lastModified > "2025-12-12"^^xsd:date)
}
```

#### Task 4.2: Create EU Daily Sync Script

```typescript
// scripts/sync-eu-daily.ts

/**
 * Daily sync for EU legislation:
 * 1. Query for documents modified in last 7 days
 * 2. For new: INSERT with full content
 * 3. For existing: UPDATE if lastModified > stored
 * 4. Create ChangeEvent for tracking
 */

// Configuration
const LOOKBACK_DAYS = 7 // Query last 7 days for safety

async function syncEuDaily() {
  const cutoffDate = new Date()
  cutoffDate.setDate(cutoffDate.getDate() - LOOKBACK_DAYS)

  // Fetch recently modified documents
  const recentDocs = await fetchRecentlyModifiedDocuments(cutoffDate)

  for (const doc of recentDocs) {
    const existing = await prisma.euDocument.findUnique({
      where: { celex_number: doc.celex },
    })

    if (!existing) {
      // New document - insert
      await insertEuDocument(doc)
      await createChangeEvent(doc.id, 'NEW_LAW')
    } else if (doc.lastModified > existing.updated_at) {
      // Updated document - archive version, update
      await archiveEuDocumentVersion(existing.document_id)
      await updateEuDocument(existing, doc)
      await createChangeEvent(existing.document_id, 'AMENDMENT')
    }
  }
}
```

#### Task 4.3: Cron Configuration

```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/sync-eu",
      "schedule": "0 6 * * *" // Daily at 06:00 UTC
    }
  ]
}
```

---

### Phase 5: Consolidated Versions (Future Enhancement)

EU documents have consolidated versions with CELEX like `02016R0679-20160504`.

**For now:** Skip consolidated versions (they duplicate base act content).

**Future:** Store consolidated versions for historical law-as-of-date viewing.

---

### Phase 6: Page Rendering with Relationships

#### Task 6.1: EU Document Page Component

```tsx
// components/eu-document-page.tsx

export function EuDocumentPage({ document, relationships }: Props) {
  return (
    <div>
      <DocumentHeader document={document} />

      <DocumentContent html={document.html_content} />

      <RelationshipsPanel>
        {/* Legal Basis */}
        <RelationshipSection
          title="Rättslig grund"
          type="LEGAL_BASIS"
          references={relationships.legalBasis}
        />

        {/* Amends */}
        <RelationshipSection
          title="Ändrar"
          type="AMENDS"
          references={relationships.amends}
        />

        {/* Amended By */}
        <RelationshipSection
          title="Ändrad av"
          type="AMENDED_BY"
          references={relationships.amendedBy}
        />

        {/* Citations */}
        <RelationshipSection
          title="Hänvisar till"
          type="CITES"
          references={relationships.cites}
          collapsible
        />

        {/* Cited By */}
        <RelationshipSection
          title="Hänvisad av"
          type="CITED_BY"
          references={relationships.citedBy}
          collapsible
        />
      </RelationshipsPanel>
    </div>
  )
}
```

#### Task 6.2: API Endpoint for Relationships

```typescript
// app/api/documents/[id]/relationships/route.ts

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const document = await prisma.legalDocument.findUnique({
    where: { id: params.id },
    include: {
      source_references: {
        include: {
          target_document: {
            select: { id: true, document_number: true, title: true },
          },
        },
      },
      target_references: {
        include: {
          source_document: {
            select: { id: true, document_number: true, title: true },
          },
        },
      },
    },
  })

  // Group by reference type
  const relationships = {
    cites: document.source_references.filter(
      (r) => r.reference_type === 'CITES'
    ),
    citedBy: document.target_references.filter(
      (r) => r.reference_type === 'CITES'
    ),
    legalBasis: document.source_references.filter(
      (r) => r.reference_type === 'LEGAL_BASIS'
    ),
    amends: document.source_references.filter(
      (r) => r.reference_type === 'AMENDS'
    ),
    amendedBy: document.target_references.filter(
      (r) => r.reference_type === 'AMENDS'
    ),
  }

  return Response.json(relationships)
}
```

---

## Execution Order

### Immediate (Story 2.4b Phase 1)

1. **Fix relationship SPARQL queries** - Separate query for relationships
2. **Complete 2020 ingestion with relationships** - Test end-to-end
3. **Backfill missing HTML content** - For existing documents

### Next (Story 2.4b Phase 2)

4. **Full ingestion: Remaining years** - ~55,000 regulations, ~4,700 directives
5. **Build CrossReference records** - After all documents exist
6. **Create daily sync cron job** - `/api/cron/sync-eu`

### Later (Story 2.4b Phase 3)

7. **Page rendering components** - Relationship visualization
8. **User law lists integration** - Track changes for user-saved EU docs

---

## Storage Estimates

| Data            | Size per Year           | Total       |
| --------------- | ----------------------- | ----------- |
| Regulations     | ~1,500/year × 40KB avg  | ~2.5 GB     |
| Directives      | ~100/year × 50KB avg    | ~350 MB     |
| CrossReferences | ~50 per doc × 100 bytes | ~350 MB     |
| **Total**       |                         | **~3.2 GB** |

Well within Supabase limits.

---

## Success Criteria

- [ ] ~60,887 EU Regulations ingested with HTML content
- [ ] ~4,734 EU Directives ingested with HTML content
- [ ] Relationship data populated (`cites_celex`, `legal_basis_celex`)
- [ ] CrossReference records created for intra-EU links
- [ ] Daily sync detecting new/modified documents
- [ ] ChangeEvent records for all EU document changes
- [ ] Relationship visualization on document pages

---

## Dependencies

- **Requires:** Story 2.4 Phase 1 complete (basic ingestion working)
- **Blocks:** Epic 8 EU integration (change monitoring for users)
- **Related:** Story 2.11 (SFS change tracking pattern)

---

## Change Log

| Date       | Version | Description                | Author    |
| ---------- | ------- | -------------------------- | --------- |
| 2025-12-19 | 1.0     | Initial comprehensive plan | Dev Agent |
