# Story 13.3: ELI Pillar 4 — Legislation Sitemaps & Atom Feeds

## Status

Draft

## Story

**As a** legal data aggregator (EUR-Lex N-Lex, lagen.nu), AI training pipeline, or search engine,
**I want** structured legislation sitemaps and Atom feeds from Laglig.se,
**so that** I can automatically discover, sync, and index Swedish legislation without scraping.

## Context

ELI Pillar 4 defines a protocol for legislation discovery via:

1. **Sitemaps** — XML sitemaps listing all legislation with ELI URIs and last-modified timestamps
2. **Atom feeds** — Syndication feeds of recently published/updated legislation for real-time monitoring

Laglig.se already has a general sitemap (`app/sitemap.ts`) covering all document pages. This story adds a **legislation-specific** ELI sitemap and Atom feed that use ELI URIs and follow the [ELI Pillar 4 protocol specification](https://eur-lex.europa.eu/content/eli-register/ELI-Pillar-IV-protocol-specification-v1.2.pdf).

### Why Separate from Existing Sitemap?

The existing `app/sitemap.ts` serves Google/Bing with canonical page URLs. The ELI sitemap serves a different audience (legal data aggregators) with different URLs (ELI URIs) and richer metadata. They coexist — Google uses both.

## Acceptance Criteria

### AC1: ELI Legislation Sitemap

1. A route at `/eli/sitemap.xml` returns a valid XML sitemap following the [sitemaps.org protocol](https://www.sitemaps.org/protocol.html)
2. Each entry uses the ELI URI as `<loc>` (not the canonical page URL)
3. Each entry includes `<lastmod>` derived from the document's `updated_at` timestamp
4. Sitemap covers all legislation document types: SFS laws, SFS amendments, agency regulations, EU regulations, EU directives
5. Court cases are excluded (not legislation)
6. Sitemap is paginated (sitemap index with child sitemaps) if total entries exceed 50,000 (sitemaps.org limit)

### AC2: Atom Feed for Recent Legislation

7. A route at `/eli/feed.atom` returns a valid Atom feed (RFC 4287)
8. Feed contains the most recent 100 published or updated legislation documents
9. Each entry includes: `<id>` (ELI URI), `<title>`, `<updated>`, `<link>` (canonical page URL), `<summary>` (document_number + content_type)
10. Feed is sorted by `updated_at` descending (most recent first)
11. Court cases are excluded

### AC3: Registration and Discovery

12. The ELI sitemap URL is registered in `app/robots.ts` (as an additional `sitemap` entry alongside the existing one)
13. The Atom feed is discoverable via `<link rel="alternate" type="application/atom+xml">` in the site's `<head>` (layout or root)

### AC4: Performance & Caching

14. Both routes use ISR caching (`revalidate`) to avoid regenerating on every request
15. Sitemap generation uses efficient database queries (select only `document_number`, `slug`, `content_type`, `updated_at`)
16. Response time is under 5 seconds for full sitemap generation

### AC5: Testing

17. Unit tests verify XML sitemap structure and ELI URI format for sample entries
18. Unit tests verify Atom feed structure and entry format
19. Tests verify court case exclusion
20. Tests verify pagination logic triggers at 50,000 entry threshold

## Tasks / Subtasks

- [ ] **Task 1: Create ELI sitemap route** (AC: 1-6)
  - [ ] Create `app/eli/sitemap.xml/route.ts` as a Route Handler returning XML
  - [ ] Query `LegalDocument` for all legislation types (exclude court cases), select `document_number`, `slug`, `content_type`, `updated_at`
  - [ ] Generate ELI URI for each document using `buildEliUri()` from Story 13.1
  - [ ] Format as sitemaps.org XML with `<loc>` and `<lastmod>`
  - [ ] Implement sitemap index pagination if count > 50,000 (split into child sitemaps by content_type or alphabetical range)
  - [ ] Add `Cache-Control` / ISR revalidation (e.g., revalidate every 6 hours)

- [ ] **Task 2: Create Atom feed route** (AC: 7-11)
  - [ ] Create `app/eli/feed.atom/route.ts` as a Route Handler returning `application/atom+xml`
  - [ ] Query `LegalDocument` for legislation types, order by `updated_at DESC`, limit 100
  - [ ] Generate Atom XML with proper namespace, feed metadata, and entry elements
  - [ ] Each entry: `<id>` = ELI URI, `<title>` = document title, `<updated>` = updated_at ISO, `<link href="canonical_url"/>`, `<summary>` = document_number
  - [ ] Add `Cache-Control` / ISR revalidation (e.g., revalidate every 1 hour)

- [ ] **Task 3: Register sitemap and feed for discovery** (AC: 12-13)
  - [ ] Update `app/robots.ts` to include `/eli/sitemap.xml` as additional sitemap
  - [ ] Add `<link rel="alternate" type="application/atom+xml" title="Laglig.se Legislation Feed" href="/eli/feed.atom">` to root layout or `<head>` metadata

- [ ] **Task 4: Write tests** (AC: 17-20)
  - [ ] Unit tests for sitemap XML generation (structure, ELI URIs, lastmod format)
  - [ ] Unit tests for Atom feed generation (structure, entries, sorting)
  - [ ] Test court case exclusion in both sitemap and feed
  - [ ] Test pagination threshold logic

## Dev Notes

### Relevant Source Tree

```
app/eli/sitemap.xml/route.ts        — NEW: ELI legislation sitemap
app/eli/feed.atom/route.ts          — NEW: Atom syndication feed
app/sitemap.ts                      — EXISTING: General sitemap (reference pattern, do NOT modify)
app/robots.ts                       — MODIFY: Add ELI sitemap reference
app/layout.tsx                      — MODIFY: Add Atom feed <link> discovery tag
lib/eli/build-eli-uri.ts            — FROM STORY 13.1: URI generation (reuse)
lib/eli/index.ts                    — FROM STORY 13.1: Barrel export
```

### Existing Sitemap Pattern (Reference)

`app/sitemap.ts` already does a similar database query and URL generation. Key patterns to follow:

```typescript
// From existing sitemap.ts — use same query pattern
const documents = await prisma.legalDocument.findMany({
  select: { slug: true, content_type: true, updated_at: true, document_number: true },
  where: { /* filter for legislation only */ },
})
```

Content types to INCLUDE (legislation):
- `SFS_LAW`, `SFS_AMENDMENT`
- `AGENCY_REGULATION`
- `EU_REGULATION`, `EU_DIRECTIVE`

Content types to EXCLUDE (not legislation):
- `COURT_CASE_HD`, `COURT_CASE_HOVR`, `COURT_CASE_HFD`, `COURT_CASE_AD`, `COURT_CASE_MOD`, `COURT_CASE_MIG`

### Sitemap XML Format

```xml
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>https://laglig.se/eli/se/sfs/2005/551</loc>
    <lastmod>2026-01-15T10:30:00Z</lastmod>
  </url>
  <!-- ... -->
</urlset>
```

### Sitemap Index (if > 50,000 entries)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <sitemap>
    <loc>https://laglig.se/eli/sitemap-sfs.xml</loc>
    <lastmod>2026-02-13T00:00:00Z</lastmod>
  </sitemap>
  <sitemap>
    <loc>https://laglig.se/eli/sitemap-eu.xml</loc>
    <lastmod>2026-02-13T00:00:00Z</lastmod>
  </sitemap>
</sitemapindex>
```

Current document count: ~60,000 total but only ~47,000 legislation (excluding ~12,000 court cases). This is close to the 50,000 limit — implement pagination proactively.

### Atom Feed Format

```xml
<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Laglig.se — Swedish Legislation</title>
  <link href="https://laglig.se/eli/feed.atom" rel="self" type="application/atom+xml"/>
  <link href="https://laglig.se" rel="alternate" type="text/html"/>
  <id>https://laglig.se/eli/feed.atom</id>
  <updated>2026-02-13T10:00:00Z</updated>
  <author><name>Laglig.se</name></author>
  <entry>
    <id>https://laglig.se/eli/se/sfs/2005/551</id>
    <title>Aktiebolagslag (2005:551)</title>
    <link href="https://laglig.se/lagar/aktiebolagslag-2005-551" rel="alternate" type="text/html"/>
    <updated>2026-01-15T10:30:00Z</updated>
    <summary>SFS 2005:551 — SFS_LAW</summary>
  </entry>
</feed>
```

### Route Handler Response Pattern

```typescript
// app/eli/sitemap.xml/route.ts
import { NextResponse } from 'next/server'

export const revalidate = 21600 // 6 hours

export async function GET() {
  const xml = await generateSitemapXml()
  return new NextResponse(xml, {
    headers: { 'Content-Type': 'application/xml; charset=utf-8' },
  })
}
```

### robots.ts Update

```typescript
// Add second sitemap entry
return {
  rules: [ /* ... existing rules ... */ ],
  sitemap: [
    `${baseUrl}/sitemap.xml`,
    `${baseUrl}/eli/sitemap.xml`,
  ],
}
```

Note: Next.js `MetadataRoute.Robots` `sitemap` field accepts `string | string[]`.

### Depends On

- **Story 13.1** — for `buildEliUri()` function
- **Story 13.2** — ELI URIs should be resolvable before being advertised in sitemaps

### Testing

- **Test location**: `tests/unit/lib/eli/`
- **Framework**: Vitest
- **Key test files**:
  - `sitemap-generator.test.ts` — XML structure, ELI URI generation, court case exclusion, pagination threshold
  - `atom-feed-generator.test.ts` — Feed structure, entry format, sorting, court case exclusion
- **Test patterns**: Extract XML/Atom generation logic into pure functions in `lib/eli/`, test those. Route handlers are thin wrappers.
- **Integration testing**: Manual — `curl https://laglig.se/eli/sitemap.xml | head -20` and validate with [XML Sitemap Validator](https://www.xml-sitemaps.com/validate-xml-sitemap.html)

## Dev Agent Record

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

_To be filled during implementation_

## QA Results

_To be populated by QA agent after implementation review._

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-02-13 | 1.0 | Initial story draft | Sarah (PO) |
