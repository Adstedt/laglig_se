# Story 13.1: Enhance JSON-LD with ELI Properties & Centralize Helper

## Status

Draft

## Story

**As a** search engine or AI agent crawling Laglig.se,
**I want** rich, ELI-compliant structured data embedded in every public document page,
**so that** legislation is correctly classified in search results, eligible for rich snippets, and machine-readable for European legal data interoperability.

## Context

Three of four public document page types already emit basic `schema.org/Legislation` or `schema.org/LegalCase` JSON-LD. However:

1. **Föreskrifter pages have no JSON-LD at all** — 100+ agency regulation pages are invisible to structured data consumers
2. **Existing JSON-LD is minimal** — missing ELI-standard properties like `legislationLegalForce`, `spatialCoverage`, `encoding` (LegislationObject), and `@id` (ELI URI)
3. **Code duplication** — `toISOStringOrUndefined()` helper is copy-pasted across 3 page files; JSON-LD construction logic is repeated with minor variations
4. **No ELI URI as `@id`** — the `@id` field (which becomes the canonical identifier in knowledge graphs) is missing entirely

Sweden has not officially implemented ELI. Adding ELI-compatible structured data positions Laglig.se as the first Swedish legal information source with ELI compliance.

### Reference: schema.org/Legislation Properties

The [schema.org Legislation extension](https://schema.org/Legislation) was derived from the ELI ontology. Key properties to add:

| Property | Type | Description |
|----------|------|-------------|
| `@id` | URI | ELI URI — canonical identifier for knowledge graphs |
| `legislationLegalForce` | Text | "InForce", "NotInForce", or "PartiallyInForce" |
| `spatialCoverage` | Country | Jurisdiction (Sweden for SFS/agency, EU for EU docs) |
| `encoding` | LegislationObject | Physical manifestation (HTML page URL, format, language) |
| `legislationDateVersion` | Date | Date of the specific version being shown |
| `isPartOf` | Legislation | Parent document (for chapter-split föreskrifter) |

## Acceptance Criteria

### AC1: Centralized JSON-LD Builder

1. A `lib/eli/build-jsonld.ts` module exists with typed builder functions for each document category
2. Shared utilities (`toISOStringOrUndefined`, base URL resolution) are extracted from page files into this module — no duplication
3. Builder functions accept a `LegalDocument` (or relevant subset) and return a typed JSON-LD object
4. Unit tests verify JSON-LD output structure for each document type

### AC2: Enhanced SFS Law JSON-LD

5. SFS law pages emit JSON-LD with all existing properties PLUS: `@id` (ELI URI format), `legislationLegalForce`, `spatialCoverage` (Sweden), `encoding` (LegislationObject with `contentUrl`, `encodingFormat`, `inLanguage`)
6. `legislationLegalForce` is derived from existing metadata: "InForce" (default), "NotInForce" (if `repealedDate` is set or `metadata.status === 'revoked'`)
7. The `@id` follows ELI URI pattern: `https://laglig.se/eli/se/sfs/{year}/{number}`

### AC3: Enhanced EU Legislation JSON-LD

8. EU regulation/directive pages emit enhanced JSON-LD with: `@id` (ELI URI), `legislationLegalForce`, `spatialCoverage` (European Union), `encoding`
9. EU `@id` uses EUR-Lex ELI pattern where CELEX is available: `http://data.europa.eu/eli/reg/{year}/{number}/oj` or falls back to `https://laglig.se/eli/eu/{type}/{year}/{number}`

### AC4: Enhanced Court Case JSON-LD

10. Court case pages retain `schema.org/LegalCase` type (court cases are NOT legislation — no ELI URI)
11. Enhanced with: `spatialCoverage` (Sweden), `encoding` (LegislationObject)
12. No `@id` change needed (court cases don't participate in ELI)

### AC5: New Föreskrifter JSON-LD

13. Föreskrifter pages emit `schema.org/Legislation` JSON-LD with: `@id` (ELI URI), `name`, `identifier` (document_number), `legislationIdentifier`, `datePublished`, `inLanguage`, `legislationType` ("Regulation"), `legislationLegalForce`, `spatialCoverage` (Sweden), `publisher` (issuing agency), `encoding`
14. Agency name for `publisher` is derived from the document_number prefix (e.g., "AFS" → "Arbetsmiljöverket")
15. Chapter-split documents include `isPartOf` pointing to the parent document's ELI URI

### AC6: Validation

16. JSON-LD output passes [Google Rich Results Test](https://search.google.com/test/rich-results) for Legislation type on sample pages
17. No regression: existing structured data properties are preserved (only additions)

## Tasks / Subtasks

- [ ] **Task 1: Create centralized JSON-LD builder module** (AC: 1-3)
  - [ ] Create `lib/eli/build-jsonld.ts` with typed interfaces for JSON-LD output
  - [ ] Extract `toISOStringOrUndefined()` into this module
  - [ ] Implement `buildSfsLawJsonLd(doc)` — returns enhanced JSON-LD for SFS laws
  - [ ] Implement `buildCourtCaseJsonLd(doc, courtInfo)` — returns enhanced JSON-LD for court cases
  - [ ] Implement `buildEuLegislationJsonLd(doc, euDoc, type)` — returns enhanced JSON-LD for EU docs
  - [ ] Implement `buildAgencyRegulationJsonLd(doc)` — returns enhanced JSON-LD for föreskrifter
  - [ ] Create `lib/eli/agency-publisher-map.ts` — maps document_number prefix → agency name (AC: 14)
  - [ ] Create barrel export `lib/eli/index.ts`
  - [ ] Write unit tests for all builder functions

- [ ] **Task 2: Implement ELI URI minting helper** (AC: 7, 9)
  - [ ] Create `lib/eli/build-eli-uri.ts` with `buildEliUri(doc)` function
  - [ ] Parse `document_number` to extract year/number components for URI construction
  - [ ] Handle all document types: SFS (`/eli/se/sfs/{year}/{number}`), agency regs (`/eli/se/{prefix}/{year}/{number}`), EU (`/eli/eu/{type}/{year}/{number}`)
  - [ ] Unit tests for URI generation across all document types

- [ ] **Task 3: Update SFS law page** (AC: 5-7)
  - [ ] Replace inline JSON-LD construction in `app/(public)/lagar/[id]/page.tsx` with `buildSfsLawJsonLd()` call
  - [ ] Remove duplicated `toISOStringOrUndefined()` from page file
  - [ ] Verify output matches enhanced structure

- [ ] **Task 4: Update court case page** (AC: 10-12)
  - [ ] Replace inline JSON-LD in `app/(public)/rattsfall/[court]/[id]/page.tsx` with `buildCourtCaseJsonLd()` call
  - [ ] Remove duplicated `toISOStringOrUndefined()` from page file

- [ ] **Task 5: Update EU legislation page** (AC: 8-9)
  - [ ] Replace inline JSON-LD in `app/(public)/eu/[type]/[id]/page.tsx` with `buildEuLegislationJsonLd()` call
  - [ ] Remove duplicated `toISOStringOrUndefined()` from page file

- [ ] **Task 6: Add JSON-LD to föreskrifter page** (AC: 13-15)
  - [ ] Add `buildAgencyRegulationJsonLd()` call and `<script type="application/ld+json">` to `app/(public)/foreskrifter/[slug]/page.tsx`
  - [ ] Handle `isPartOf` for chapter-split documents (check `metadata.parentDocumentNumber` or similar)

- [ ] **Task 7: Validation** (AC: 16-17)
  - [ ] Manual validation with Google Rich Results Test on sample pages (lagar, rattsfall, eu, foreskrifter)
  - [ ] Verify no regression on existing structured data

## Dev Notes

### Relevant Source Tree

```
app/(public)/lagar/[id]/page.tsx              — SFS law page (has JSON-LD at line 326)
app/(public)/rattsfall/[court]/[id]/page.tsx  — Court case page (has JSON-LD at line 239)
app/(public)/eu/[type]/[id]/page.tsx          — EU legislation page (has JSON-LD at line 222)
app/(public)/foreskrifter/[slug]/page.tsx     — Föreskrifter page (NO JSON-LD — add here)
lib/eli/                                      — NEW: ELI utilities (to be created)
lib/prefetch/get-document-url.ts              — URL routing utility (reference for content type → URL mapping)
```

### Existing JSON-LD Code (to be replaced)

All three pages have near-identical patterns:

```typescript
// Duplicated in 3 files — extract to lib/eli/build-jsonld.ts
function toISOStringOrUndefined(date: Date | string | null | undefined): string | undefined {
  if (!date) return undefined
  if (typeof date === 'string') return date
  if (date instanceof Date) return date.toISOString()
  return undefined
}

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Legislation',
  name: law.title,
  // ... per-type fields
}
```

And render identically:
```tsx
<script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }} />
```

### ELI URI Format

The `@id` for each document type:

| Type | ELI URI Pattern | Example |
|------|----------------|---------|
| SFS Law | `{baseUrl}/eli/se/sfs/{year}/{number}` | `https://laglig.se/eli/se/sfs/2005/551` |
| SFS Amendment | `{baseUrl}/eli/se/sfs/{year}/{number}` | `https://laglig.se/eli/se/sfs/2009/38` |
| Agency Reg | `{baseUrl}/eli/se/{prefix}/{year}/{number}` | `https://laglig.se/eli/se/afs/2001/1` |
| EU Regulation | `http://data.europa.eu/eli/reg/{year}/{number}/oj` | `http://data.europa.eu/eli/reg/2016/679/oj` |
| EU Directive | `http://data.europa.eu/eli/dir/{year}/{number}/oj` | `http://data.europa.eu/eli/dir/2006/123/oj` |
| Court Case | N/A (not legislation) | — |

For EU documents, prefer the official EUR-Lex ELI URI when a CELEX number is available. Extract year/number from CELEX (e.g., `32016R0679` → year=2016, number=679, type=reg).

### Agency Publisher Map

Map document_number prefixes to agency names for the `publisher` field:

```typescript
const AGENCY_PUBLISHER_MAP: Record<string, string> = {
  'AFS': 'Arbetsmiljöverket',
  'MSBFS': 'Myndigheten för samhällsskydd och beredskap',
  'NFS': 'Naturvårdsverket',
  'TSFS': 'Transportstyrelsen',
  'ELSÄK-FS': 'Elsäkerhetsverket',
  'BFS': 'Boverket',
  'KIFS': 'Kemikalieinspektionen',
  'SKVFS': 'Skatteverket',
  'STAFS': 'Styrelsen för ackreditering och teknisk kontroll',
  'SSMFS': 'Strålsäkerhetsmyndigheten',
  'SCB-FS': 'Statistiska centralbyrån',
  'SRVFS': 'Sjöfartsverket',
}
```

### Legal Force Derivation

Determine `legislationLegalForce` from existing data:
- **SFS laws**: Check `metadata.repealedDate` or `metadata.status` — if repealed → "NotInForce", else "InForce"
- **Agency regs**: Default "InForce" (we only ingest active regulations currently)
- **EU docs**: Default "InForce"
- Court cases: Not applicable (LegalCase type doesn't have this property)

### Testing

- **Test location**: `tests/unit/lib/eli/`
- **Framework**: Vitest
- **Key test files**:
  - `build-jsonld.test.ts` — builder functions for each document type, property completeness, edge cases
  - `build-eli-uri.test.ts` — URI generation for all document types, CELEX parsing
- **Test patterns**: Mock document objects with relevant fields, assert JSON-LD output structure and values
- **No integration tests needed** — JSON-LD is pure function (document data in, JSON object out)

## Dev Agent Record

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

_To be filled during implementation_

## QA Results

_To be populated by QA agent after implementation review._

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-02-13 | 1.0 | Initial story draft | Sarah (PO) |
