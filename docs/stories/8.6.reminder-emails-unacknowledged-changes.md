# Story 8.6: Implement Reminder Emails for Unacknowledged Changes

## Status

Draft (v2 — rewritten to align with actual data model and email infrastructure)

## Story

**As a** workspace member with unacknowledged law changes,
**I want** to receive reminder emails after 3 and 7 days,
**so that** critical amendments aren't missed due to inattention.

## Context & Dependencies

**Builds on:**

- Story 8.4 (Email Notifications) — initial email digest cron, Resend infrastructure
- `ChangeEvent` model — detected amendments with `detected_at`
- `LawListItem.last_change_acknowledged_at` — acknowledgment tracking
- `NotificationPreference` model — per-workspace email preferences
- `lib/email/cron-notifications.ts` — existing Resend email infrastructure
- `CronJobRun` model — existing cron execution tracking

**Depends on:**

- Story 8.4 (initial notification email must exist first)
- Story 8.3 (acknowledgment mechanism must be implemented)

## Acceptance Criteria

### Reminder Cron

1. New cron endpoint at `/api/cron/send-amendment-reminders` runs daily at 08:00 UTC (09:00 CET / 10:00 CEST)
2. `maxDuration = 300` with 30s timeout buffer (same pattern as other crons)

### Day 3 Reminder

3. Find ChangeEvents where:
   - `detected_at` is between 3-4 days ago
   - Still unacknowledged (via LawListItem.last_change_acknowledged_at check)
   - `notification_sent = true` (initial notification was sent)
4. Subject: "Paminnelse: Olaesta lagaendringar"
5. Friendly tone, lists all unacknowledged amendments with summering
6. CTA button: "Granska aendringar nu" → links to Changes tab

### Day 7 Reminder

7. Find ChangeEvents where:
   - `detected_at` is between 7-8 days ago
   - Still unacknowledged
   - Day 3 reminder was already sent (track via metadata or separate flag)
8. Subject: "Viktigt: Lagaendringar kraever din uppmaerksamhet"
9. More urgent tone, red header, highlights high-priority changes
10. CTA button: "Granska akuta aendringar" → links to Changes tab

### Smart Skip Logic

11. Skip reminder if user acknowledged ANY change in their workspace in the last 24 hours (shows engagement)
12. Skip if user's `NotificationPreference.email_enabled = false`
13. Skip workspaces with no active members

### Tracking

14. Log reminder emails to `ActivityLog` (entity_type: 'email', action: 'reminder_sent')
15. Track in `CronJobRun`: day3EmailsSent, day7EmailsSent, skipped, duration
16. Admin notification email with cron run stats (reuse `sendSfsSyncEmail` pattern)

## Tasks / Subtasks

- [ ] **Task 1: Create reminder cron route** (AC: 1, 2)
  - [ ] Create `app/api/cron/send-amendment-reminders/route.ts`
  - [ ] Add to `vercel.json` crons: `"0 8 * * *"` (08:00 UTC daily)
  - [ ] Auth check + timeout protection
- [ ] **Task 2: Build unacknowledged ChangeEvent query** (AC: 3, 7)
  - [ ] Query ChangeEvents by age window (3-4 days, 7-8 days)
  - [ ] Join through LawListItem → LawList → Workspace → WorkspaceMember → User
  - [ ] Check LawListItem.last_change_acknowledged_at for unacknowledged status
- [ ] **Task 3: Smart skip logic** (AC: 11, 12, 13)
  - [ ] Check recent acknowledgment activity
  - [ ] Check NotificationPreference.email_enabled
- [ ] **Task 4: Build Day 3 email template** (AC: 4, 5, 6)
  - [ ] HTML email with amendment list, summering for each
  - [ ] Unsubscribe link → notification preferences page
- [ ] **Task 5: Build Day 7 email template** (AC: 8, 9, 10)
  - [ ] More urgent styling (red header)
  - [ ] Same structure but stronger tone
- [ ] **Task 6: Send emails + tracking** (AC: 14, 15, 16)
  - [ ] Send via Resend
  - [ ] Log to ActivityLog
  - [ ] Create CronJobRun record
  - [ ] Send admin summary email

## Dev Notes

### Source Tree (relevant files)

```
app/api/cron/notify-amendment-changes/       — Story 8.4 notification cron (pattern to follow)
lib/email/cron-notifications.ts              — Resend email infrastructure + admin email patterns
prisma/schema.prisma                         — ChangeEvent, LawListItem, NotificationPreference, CronJobRun
```

### Key Data Models

```
Reminder eligibility:
  ChangeEvent.detected_at → age calculation (3 days, 7 days)
  ChangeEvent.notification_sent = true → initial notification was sent
  LawListItem.last_change_acknowledged_at → null or < ChangeEvent.detected_at means unacknowledged

Recipient chain (same as Story 8.4):
  ChangeEvent.document_id → LegalDocument (base law)
    → LawListItem.document_id
      → LawList.workspace_id
        → WorkspaceMember.user_id → User.email

NotificationPreference
  ├─ email_enabled: Boolean      ← check this
  └─ (future: reminder_enabled toggle from Story 8.11)
```

### Timing Budget (5 min total)

- Unacknowledged queries: <5s
- Email rendering + sending: ~1s per email x max ~100 = ~100s
- Admin summary email: <5s
- Buffer: 30s
- Total: well within 300s

### Email Template Pattern

Follow HTML email pattern from Story 8.4. Key differences:
- **Day 3**: Blue header, friendly tone, "Det aer viktigt att granska..."
- **Day 7**: Red header, urgent tone, "Du har X olaesta lagaendringar som har vaentat i 7 dagar"

## Testing

**Test location:** `tests/unit/lib/cron/send-amendment-reminders.test.ts`

**Test framework:** Vitest with `vi.mock()` for Prisma, Resend

**Unit tests:**
- Day 3 query finds ChangeEvents 3-4 days old that are unacknowledged
- Day 7 query finds ChangeEvents 7-8 days old that are unacknowledged
- Skip logic: user who acknowledged yesterday is skipped
- Skip logic: user with email_enabled=false is skipped
- Email rendering produces valid HTML
- CronJobRun record created with correct stats

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with ChangeEvent, LawListItem, Resend email infra, CronJobRun | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
