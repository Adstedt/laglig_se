# Story 8.6: Implement Reminder Emails for Unacknowledged Changes

## Status

Draft

## Story

**As a** product owner,
**I want** to send reminder emails to users with unacknowledged changes,
**so that** critical updates aren't missed.

## Acceptance Criteria

1. **Day 3 Reminder:**
   - Subject: "Påminnelse: Olästa lagändringar"
   - Sent to users with changes unacknowledged for 3 days
   - Friendly tone, emphasizes importance of review
   - Lists all unacknowledged changes (grouped by priority)
   - CTA: "Granska ändringar nu"

2. **Day 7 Reminder:**
   - Subject: "Viktigt: Lagändringar kräver din uppmärksamhet"
   - Sent to users with changes unacknowledged for 7 days
   - More urgent tone
   - Highlights high-priority changes first
   - CTA: "Granska akuta ändringar"

3. Track engagement:
   - Email opens (via tracking pixel)
   - Click-through rate on CTA button
   - Log reminder emails sent to workspace activity

4. Users can disable reminders in settings (with warning modal)

5. Cron job runs daily at 09:00 CET

6. Skip reminder if user acknowledged any change in last 24 hours (shows engagement)

7. Reminder emails respect user notification preferences

## Tasks / Subtasks

- [ ] Create Day 3 reminder email template
- [ ] Create Day 7 reminder email template
- [ ] Implement cron job to find changes at 3 and 7 days
- [ ] Build email sending logic with engagement tracking
- [ ] Add user preference toggle for reminders
- [ ] Create warning modal for disabling reminders
- [ ] Log reminder emails to workspace activity
- [ ] Skip logic if user recently engaged
- [ ] Test reminder email rendering
- [ ] Test cron job execution
- [ ] Verify engagement tracking works

## Dev Notes

**Day 3 Reminder Email Template:**

```typescript
// emails/day-3-reminder.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Button,
  Hr
} from '@react-email/components'

interface Day3ReminderProps {
  userName: string
  changeCount: number
  highPriorityCount: number
  changesUrl: string
  unsubscribeUrl: string
}

export function Day3Reminder({
  userName,
  changeCount,
  highPriorityCount,
  changesUrl,
  unsubscribeUrl
}: Day3ReminderProps) {
  return (
    <Html>
      <Head />
      <Body style={{ fontFamily: 'sans-serif', backgroundColor: '#f9fafb' }}>
        <Container style={{ maxWidth: '600px', margin: '0 auto', backgroundColor: '#ffffff' }}>
          {/* Header */}
          <Section style={{ backgroundColor: '#3b82f6', padding: '24px', textAlign: 'center' }}>
            <Text style={{ color: '#ffffff', fontSize: '24px', fontWeight: 'bold', margin: '0' }}>
              Laglig.se
            </Text>
          </Section>

          {/* Content */}
          <Section style={{ padding: '32px 24px' }}>
            <Text style={{ fontSize: '16px', color: '#111827', margin: '0 0 16px 0' }}>
              Hej {userName},
            </Text>
            <Text style={{ fontSize: '14px', color: '#374151', lineHeight: '1.6', margin: '0 0 16px 0' }}>
              Du har <strong>{changeCount}</strong> olästa lagändringar som har väntat i 3 dagar.
              {highPriorityCount > 0 && (
                <> Varav <strong className="text-red-600">{highPriorityCount}</strong> är markerade som högprioriterade.</>
              )}
            </Text>
            <Text style={{ fontSize: '14px', color: '#374151', lineHeight: '1.6', margin: '0 0 24px 0' }}>
              Det är viktigt att du granskar dessa ändringar för att säkerställa att ditt företag följer gällande regelverk.
            </Text>

            {/* CTA Button */}
            <Button
              href={changesUrl}
              style={{
                backgroundColor: '#3b82f6',
                color: '#ffffff',
                padding: '12px 32px',
                borderRadius: '8px',
                textDecoration: 'none',
                fontSize: '14px',
                fontWeight: '600',
                display: 'inline-block'
              }}
            >
              Granska ändringar nu
            </Button>

            <Text style={{ fontSize: '13px', color: '#6b7280', marginTop: '24px' }}>
              Behöver du hjälp? Svara på detta mejl så hjälper vi dig.
            </Text>
          </Section>

          <Hr style={{ borderColor: '#e5e7eb', margin: '0 24px' }} />

          {/* Footer */}
          <Section style={{ padding: '16px 24px', fontSize: '12px', color: '#6b7280', textAlign: 'center' }}>
            <Text style={{ margin: '0 0 8px 0' }}>
              Detta är en påminnelse från Laglig.se
            </Text>
            <a href={unsubscribeUrl} style={{ color: '#3b82f6', textDecoration: 'none' }}>
              Stäng av påminnelser
            </a>
          </Section>
        </Container>
      </Body>
    </Html>
  )
}
```

**Day 7 Reminder Email Template:**

```typescript
// emails/day-7-reminder.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Button,
  Hr
} from '@react-email/components'

interface Day7ReminderProps {
  userName: string
  changeCount: number
  highPriorityCount: number
  changesUrl: string
  unsubscribeUrl: string
}

export function Day7Reminder({
  userName,
  changeCount,
  highPriorityCount,
  changesUrl,
  unsubscribeUrl
}: Day7ReminderProps) {
  return (
    <Html>
      <Head />
      <Body style={{ fontFamily: 'sans-serif', backgroundColor: '#f9fafb' }}>
        <Container style={{ maxWidth: '600px', margin: '0 auto', backgroundColor: '#ffffff' }}>
          {/* Header - Red for urgency */}
          <Section style={{ backgroundColor: '#dc2626', padding: '24px', textAlign: 'center' }}>
            <Text style={{ color: '#ffffff', fontSize: '24px', fontWeight: 'bold', margin: '0' }}>
              ⚠️ Viktigt
            </Text>
          </Section>

          {/* Content */}
          <Section style={{ padding: '32px 24px' }}>
            <Text style={{ fontSize: '16px', color: '#111827', margin: '0 0 16px 0', fontWeight: 'bold' }}>
              Hej {userName},
            </Text>
            <Text style={{ fontSize: '14px', color: '#374151', lineHeight: '1.6', margin: '0 0 16px 0' }}>
              Du har <strong style={{ color: '#dc2626' }}>{changeCount}</strong> olästa lagändringar som har väntat i <strong>7 dagar</strong>.
              {highPriorityCount > 0 && (
                <>
                  {' '}
                  <span style={{ color: '#dc2626', fontWeight: 'bold' }}>
                    {highPriorityCount} av dessa är högprioriterade
                  </span>{' '}
                  och kräver din omedelbara uppmärksamhet.
                </>
              )}
            </Text>
            <Text style={{ fontSize: '14px', color: '#374151', lineHeight: '1.6', margin: '0 0 24px 0' }}>
              <strong>Varför är det viktigt?</strong>
              <br />
              Olästa lagändringar kan innebära att ditt företag omedvetet bryter mot gällande regelverk, vilket kan leda till sanktioner eller böter.
            </Text>

            {/* Urgent CTA Button */}
            <Button
              href={changesUrl}
              style={{
                backgroundColor: '#dc2626',
                color: '#ffffff',
                padding: '14px 40px',
                borderRadius: '8px',
                textDecoration: 'none',
                fontSize: '16px',
                fontWeight: '700',
                display: 'inline-block'
              }}
            >
              Granska akuta ändringar →
            </Button>

            <Text style={{ fontSize: '13px', color: '#6b7280', marginTop: '24px', lineHeight: '1.6' }}>
              Behöver du hjälp med att förstå ändringarna? Använd vår AI-assistent eller kontakta oss direkt.
            </Text>
          </Section>

          <Hr style={{ borderColor: '#e5e7eb', margin: '0 24px' }} />

          {/* Footer */}
          <Section style={{ padding: '16px 24px', fontSize: '12px', color: '#6b7280', textAlign: 'center' }}>
            <Text style={{ margin: '0 0 8px 0' }}>
              Detta är en viktig påminnelse från Laglig.se
            </Text>
            <a href={unsubscribeUrl} style={{ color: '#3b82f6', textDecoration: 'none' }}>
              Stäng av påminnelser
            </a>
          </Section>
        </Container>
      </Body>
    </Html>
  )
}
```

**Reminder Cron Job:**

```typescript
// app/api/cron/send-change-reminders/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { sendEmail } from '@/lib/email/send-email'
import { Day3Reminder } from '@/emails/day-3-reminder'
import { Day7Reminder } from '@/emails/day-7-reminder'

export async function GET(request: Request) {
  // Verify Vercel Cron secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const now = new Date()
  const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000)
  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
  const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000)

  let day3EmailsSent = 0
  let day7EmailsSent = 0
  let skipped = 0

  try {
    // Find workspaces with unacknowledged changes at 3 days
    const workspacesDay3 = await prisma.workspace.findMany({
      include: {
        owner: {
          select: { id: true, name: true, email: true },
        },
        workspaceLaws: {
          include: {
            law: {
              include: {
                lawChanges: {
                  where: {
                    detectedAt: {
                      gte: new Date(threeDaysAgo.getTime() - 60 * 60 * 1000), // 3 days ± 1 hour window
                      lte: new Date(threeDaysAgo.getTime() + 60 * 60 * 1000),
                    },
                    acknowledgedAt: null,
                  },
                },
              },
            },
          },
        },
      },
    })

    // Find workspaces with unacknowledged changes at 7 days
    const workspacesDay7 = await prisma.workspace.findMany({
      include: {
        owner: {
          select: { id: true, name: true, email: true },
        },
        workspaceLaws: {
          include: {
            law: {
              include: {
                lawChanges: {
                  where: {
                    detectedAt: {
                      gte: new Date(sevenDaysAgo.getTime() - 60 * 60 * 1000), // 7 days ± 1 hour window
                      lte: new Date(sevenDaysAgo.getTime() + 60 * 60 * 1000),
                    },
                    acknowledgedAt: null,
                  },
                },
              },
            },
          },
        },
      },
    })

    // Send Day 3 Reminders
    for (const workspace of workspacesDay3) {
      const changes = workspace.workspaceLaws.flatMap((wl) => wl.law.lawChanges)
      if (changes.length === 0) continue

      // Check user preferences
      const preferences = await prisma.userNotificationPreferences.findUnique({
        where: { userId: workspace.owner.id },
      })

      if (preferences && !preferences.emailReminders) {
        skipped++
        continue
      }

      // Skip if user acknowledged any change in last 24 hours (shows engagement)
      const recentAcknowledgment = await prisma.lawChange.findFirst({
        where: {
          law: {
            workspaceLaws: {
              some: { workspaceId: workspace.id },
            },
          },
          acknowledgedBy: workspace.owner.id,
          acknowledgedAt: { gte: oneDayAgo },
        },
      })

      if (recentAcknowledgment) {
        skipped++
        continue
      }

      // Count high-priority changes
      const highPriorityCount = changes.filter(
        (c) => c.priority === 'high'
      ).length

      try {
        await sendEmail({
          to: workspace.owner.email,
          subject: 'Påminnelse: Olästa lagändringar',
          react: Day3Reminder({
            userName: workspace.owner.name || 'där',
            changeCount: changes.length,
            highPriorityCount,
            changesUrl: `https://laglig.se/laws/changes?utm_source=email&utm_medium=reminder&utm_campaign=day3_reminder`,
            unsubscribeUrl: `https://laglig.se/settings/notifications?unsubscribe=reminders`,
          }),
        })

        // Log activity
        await prisma.workspaceActivity.create({
          data: {
            workspaceId: workspace.id,
            userId: workspace.owner.id,
            action: 'reminder_email_sent',
            resourceType: 'email',
            resourceId: null,
            metadata: {
              reminderType: 'day_3',
              changeCount: changes.length,
            },
          },
        })

        day3EmailsSent++
      } catch (error) {
        console.error(
          `Failed to send Day 3 reminder to ${workspace.owner.email}:`,
          error
        )
      }
    }

    // Send Day 7 Reminders
    for (const workspace of workspacesDay7) {
      const changes = workspace.workspaceLaws.flatMap((wl) => wl.law.lawChanges)
      if (changes.length === 0) continue

      // Check user preferences
      const preferences = await prisma.userNotificationPreferences.findUnique({
        where: { userId: workspace.owner.id },
      })

      if (preferences && !preferences.emailReminders) {
        skipped++
        continue
      }

      // Skip if user acknowledged any change in last 24 hours
      const recentAcknowledgment = await prisma.lawChange.findFirst({
        where: {
          law: {
            workspaceLaws: {
              some: { workspaceId: workspace.id },
            },
          },
          acknowledgedBy: workspace.owner.id,
          acknowledgedAt: { gte: oneDayAgo },
        },
      })

      if (recentAcknowledgment) {
        skipped++
        continue
      }

      // Count high-priority changes
      const highPriorityCount = changes.filter(
        (c) => c.priority === 'high'
      ).length

      try {
        await sendEmail({
          to: workspace.owner.email,
          subject: 'Viktigt: Lagändringar kräver din uppmärksamhet',
          react: Day7Reminder({
            userName: workspace.owner.name || 'där',
            changeCount: changes.length,
            highPriorityCount,
            changesUrl: `https://laglig.se/laws/changes?utm_source=email&utm_medium=reminder&utm_campaign=day7_reminder`,
            unsubscribeUrl: `https://laglig.se/settings/notifications?unsubscribe=reminders`,
          }),
        })

        // Log activity
        await prisma.workspaceActivity.create({
          data: {
            workspaceId: workspace.id,
            userId: workspace.owner.id,
            action: 'reminder_email_sent',
            resourceType: 'email',
            resourceId: null,
            metadata: {
              reminderType: 'day_7',
              changeCount: changes.length,
            },
          },
        })

        day7EmailsSent++
      } catch (error) {
        console.error(
          `Failed to send Day 7 reminder to ${workspace.owner.email}:`,
          error
        )
      }
    }

    return NextResponse.json({
      success: true,
      day3EmailsSent,
      day7EmailsSent,
      skipped,
    })
  } catch (error) {
    console.error('Reminder cron job failed:', error)
    return NextResponse.json(
      {
        error: 'Cron job failed',
        message: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    )
  }
}
```

**Vercel Cron Configuration:**

```json
// vercel.json (add to existing crons)
{
  "crons": [
    {
      "path": "/api/cron/send-change-reminders",
      "schedule": "0 9 * * *"
    }
  ]
}
```

**User Preferences - Disable Reminders:**

```typescript
// components/settings/notification-preferences.tsx (excerpt)
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

export function NotificationPreferences({ preferences }: any) {
  const [showWarning, setShowWarning] = useState(false)
  const router = useRouter()

  async function handleToggleReminders(enabled: boolean) {
    if (!enabled) {
      // Show warning modal before disabling
      setShowWarning(true)
    } else {
      // Enable directly
      await updatePreference('emailReminders', true)
    }
  }

  async function confirmDisableReminders() {
    await updatePreference('emailReminders', false)
    setShowWarning(false)
    router.refresh()
  }

  async function updatePreference(key: string, value: boolean) {
    await fetch('/api/user/notification-preferences', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ [key]: value })
    })
  }

  return (
    <>
      <div className="flex items-center justify-between py-4">
        <div>
          <h4 className="font-medium">Reminder Emails</h4>
          <p className="text-sm text-gray-600">
            Receive reminders for unacknowledged changes after 3 and 7 days
          </p>
        </div>
        <label className="relative inline-flex items-center cursor-pointer">
          <input
            type="checkbox"
            checked={preferences.emailReminders}
            onChange={(e) => handleToggleReminders(e.target.checked)}
            className="sr-only peer"
          />
          <div className="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
        </label>
      </div>

      {/* Warning Modal */}
      {showWarning && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg w-full max-w-md p-6">
            <h2 className="text-xl font-bold mb-4 text-red-600">⚠️ Varning</h2>
            <p className="text-sm text-gray-700 mb-6">
              Genom att stänga av påminnelser riskerar du att missa kritiska lagändringar som kan påverka ditt företag. Är du säker på att du vill fortsätta?
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowWarning(false)}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Avbryt
              </button>
              <button
                onClick={confirmDisableReminders}
                className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
              >
                Stäng av påminnelser
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  )
}
```

**Reference:** PRD Epic 8 Story 8.6

## Testing

**Unit Tests:**

- Day 3 reminder template renders correctly
- Day 7 reminder template renders correctly
- High-priority count displays correctly
- Unsubscribe link present in both templates

**Integration Tests:**

- Cron job finds changes at exactly 3 days old
- Cron job finds changes at exactly 7 days old
- Skips users with emailReminders = false
- Skips users who acknowledged any change in last 24 hours
- Logs reminder email to workspace activity
- Sends both Day 3 and Day 7 reminders in same run

**Manual Testing:**

- Create change, wait 3 days (or manipulate detectedAt), trigger cron
- Verify Day 3 email received with correct count
- Wait 4 more days, verify Day 7 email received
- Acknowledge a change, verify no reminder sent
- Disable reminders in settings, verify no email sent
- Enable reminders, verify emails resume

**Deliverability Testing:**

- Test both email templates in Gmail, Outlook, Apple Mail
- Verify urgent styling (red header) renders correctly in Day 7 email
- Check spam score for both templates

**Performance Testing:**

- Cron job completes <5 minutes for 1000 workspaces
- Email sending completes <1 second per email

**Edge Cases:**

- User with no unacknowledged changes (skip)
- User who acknowledged all changes yesterday (skip)
- Very high change count (100+) (renders correctly)
- Missing user name (fallback to "där")

**Test File:** `__tests__/features/email-notifications/reminder-emails.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Respond to reminder emails by reviewing changes
- Configure notification preferences if reminders are unwanted
- Understand risk of disabling reminders (compliance issues)

**Developer Responsibility:**

- Send reminders at appropriate intervals (Day 3 and Day 7)
- Make Day 7 email more urgent (visual design, copy)
- Respect user notification preferences
- Skip reminders if user recently engaged (avoid spam)
- Track engagement metrics (opens, clicks)
- Log all reminder emails for audit trail
- Provide clear warning when disabling reminders
- Make unsubscribe process simple
- Handle email sending failures gracefully
- Optimize cron job for large user volumes
- Ensure emails render correctly across clients
- Use appropriate tone (friendly Day 3, urgent Day 7)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
