# Story 2.3: Ingest Swedish Court Cases from Domstolsverket API

## Status

Draft

## Story

**As a** developer,
**I want** to fetch court cases from AD, HFD, HD, and HovR courts using the Domstolsverket PUH API,
**so that** we have comprehensive Swedish case law precedent with a competitive advantage in employment law (AD).

## Acceptance Criteria

1. Integration with Domstolsverket PUH API (`/api/v1/publiceringar` and `/api/v1/sok`)
2. Node script fetches cases from 4 priority courts: AD (Labour Court), HFD (Admin Supreme), HD (Supreme Court), HovR (Courts of Appeal)
3. For each case extract: case number, decision date, court name, summary, full text (HTML preserved), ECLI number, lower court, parties, keywords, legal areas, PDF attachment metadata
4. Data stored in `legal_documents` table with appropriate content_type enum per court
5. Court-specific metadata stored in `court_cases` table (one-to-one with legal_documents)
   5a. Full text stored as HTML (NOT stripped) - preserve original formatting, links, and structure
   5b. PDF attachment metadata stored in `metadata.attachments` JSONB field with `fillagringId` and `filnamn` for future download
6. Case numbering formats preserved (AD YYYY nr N, NJA references, RH series, etc.)
7. Extract cross-references to SFS laws from `lagrumLista` field and create `cross_references` records
8. Rate limiting (5 req/sec) with exponential backoff retry logic
9. Progress logging per court with ETA calculation
10. Error handling: Retry failed requests 3x, log errors, continue processing
11. Script completes in <12 hours for all 4 courts
12. Verification: 10,000-20,000 cases in database across all courts
13. **Competitive advantage: AD (Arbetsdomstolen) data working** - Notisum's AD coverage is broken (empty case pages), giving us unique market advantage for employment law

## Tasks / Subtasks

- [ ] **Task 0: Review Prerequisites from Story 2.1 and 2.2** (AC: 4, 5)
  - [ ] Verify `legal_documents` table supports court case content types
  - [ ] Verify `court_cases` table exists with all required fields
  - [ ] Verify `cross_references` table exists for SFS law citations
  - [ ] Verify ContentType enum includes: `AD_LABOUR_COURT`, `HFD_ADMIN_SUPREME`, `HD_SUPREME_COURT`, `HOVR_COURT_APPEAL`
  - [ ] Verify Prisma client generated and database connection working
  - [ ] Confirm SFS laws from Story 2.2 are in database (needed for cross-references)

- [ ] **Task 1: Create Domstolsverket API Client Library** (AC: 1, 8)
  - [ ] Create `lib/external/domstolsverket.ts` with TypeScript interfaces
  - [ ] Implement `fetchPubliceringar()` for GET /api/v1/publiceringar with pagination
  - [ ] Implement `searchPubliceringar()` for POST /api/v1/sok with advanced filters
  - [ ] Implement `fetchPubliceringById()` for GET /api/v1/publiceringar/{id}
  - [ ] Add rate limiting: 5 requests/second using p-limit
  - [ ] Add retry logic: 3 attempts with exponential backoff (1s, 2s, 4s)
  - [ ] Add TypeScript interfaces for PubliceringDTO, LagrumDTO, DomstolDTO
  - [ ] Add error handling with custom `DomstolsverketApiError` class

- [ ] **Task 2: Create Multi-Court Ingestion Script** (AC: 2, 11)
  - [ ] Create `scripts/ingest-court-cases.ts`
  - [ ] Define court priority order: AD â†’ HFD â†’ HD â†’ HovR (per competitive analysis)
  - [ ] Implement `ingestAllCourts()` main function
  - [ ] Implement `ingestCourtType()` with pagination for each court
  - [ ] Use search filters to target specific courts (domstolKodLista)
  - [ ] Handle court-specific field variations (arbetsdomstolenDomsnummer for AD)
  - [ ] Estimated volumes per court (from API analysis):
    - AD: ~2,000-3,000 cases
    - HFD: ~5,000 cases
    - HD: ~3,000 cases
    - HovR: ~8,000 cases

- [ ] **Task 3: Parse and Store Court Cases in Database** (AC: 3, 4, 5, 5a, 5b, 6)
  - [ ] Implement `processCourtCase()` function
  - [ ] Map API response to `LegalDocument` fields:
    - `contentType` â† court-specific enum (AD_LABOUR_COURT, etc.)
    - `documentNumber` â† combine from malNummerLista[0] or referatNummerLista[0]
    - `title` â† benamning or generate from court + case number
    - `summary` â† sammanfattning (may be null)
    - `fullText` â† innehall (âš ï¸ **PRESERVE HTML** - do NOT strip tags)
    - `publicationDate` â† avgorandedatum
    - `sourceUrl` â† API URL or construct from ECLI
    - `metadata` â† JSONB: {ecliNummer, typ, arVagledande, nyckelordLista, rattsomradeLista, attachments}
  - [ ] **Store PDF attachment metadata in metadata.attachments array:**
    - Extract `bilagaLista` from API response
    - For each attachment: Store `{fillagringId, filnamn, downloadUrl: null}`
    - This enables future PDF download via `/api/v1/bilagor/{fillagringId}`
  - [ ] Generate slug from title and case number (reuse generateSlug utility)
  - [ ] Insert into `court_cases` table:
    - `document_id` â† FK to created LegalDocument
    - `court_name` â† domstol.domstolNamn
    - `case_number` â† malNummerLista[0]
    - `lower_court` â† parse from metadata if appeal
    - `decision_date` â† avgorandedatum
    - `parties` â† JSONB: {plaintiff, defendant, counsels} (parse from text if available)
  - [ ] Handle duplicate detection: Skip if documentNumber already exists

- [ ] **Task 4: Extract and Link SFS Law Cross-References** (AC: 7)
  - [ ] Parse `lagrumLista` array from API response
  - [ ] For each LagrumDTO:
    - Extract `sfsNummer` (e.g., "SFS 1977:1160")
    - Extract `referens` (e.g., "3 kap. 2 Â§")
  - [ ] Look up SFS law in database by documentNumber
  - [ ] If SFS law exists, create CrossReference record:
    - `source_document_id` â† court case document ID
    - `target_document_id` â† SFS law document ID
    - `reference_type` â† "CASE_CITES_LAW"
    - `context` â† referens field (specific section cited)
  - [ ] Log stats: "Court case T 1234-22 cites 5 SFS laws"
  - [ ] Handle missing SFS laws gracefully (log warning, continue)

- [ ] **Task 5: Implement Progress Logging and Error Handling** (AC: 9, 10)
  - [ ] Add progress logging per court:
    - "Starting AD (Arbetsdomstolen) ingestion..."
    - "AD: Processed 500/2,500 cases (20%) - ETA: 12 minutes"
    - "âœ… AD complete: 2,487 cases inserted, 13 skipped (duplicates)"
  - [ ] Calculate ETA based on average processing time
  - [ ] Log error details without stopping ingestion:
    - "âš ï¸ Failed to fetch case AD 2023 nr 45 after 3 retries: [error]"
    - Continue to next case
  - [ ] Final summary stats:
    - Total cases inserted per court
    - Total cross-references created
    - Total execution time
    - Error count

- [ ] **Task 6: Verify Completion and Data Quality** (AC: 12, 13)
  - [ ] Query database counts per content type:
    - `SELECT COUNT(*) FROM legal_documents WHERE content_type = 'AD_LABOUR_COURT'`
    - Repeat for HFD, HD, HovR
  - [ ] Verify total: 10,000-20,000 cases
  - [ ] Verify cross-references created:
    - `SELECT COUNT(*) FROM cross_references WHERE reference_type = 'CASE_CITES_LAW'`
  - [ ] Sample quality check:
    - Query 10 random AD cases
    - Verify fullText is populated (NOT empty like Notisum)
    - Verify cross-references link to actual SFS laws
    - Verify metadata fields populated correctly
  - [ ] Document AD competitive advantage verification:
    - Confirm AD case full text is accessible (proves Notisum gap filled)

- [ ] **Task 7: Create Integration Tests** (AC: All)
  - [ ] Create test file: `tests/integration/ingestion/court-cases.test.ts`
  - [ ] Test: Fetch single court case from API and parse correctly
  - [ ] Test: Store court case with all required fields in database
  - [ ] Test: Create CourtCase metadata record linked to LegalDocument
  - [ ] Test: Extract SFS law references from lagrumLista
  - [ ] Test: Create CrossReference records linking case â†’ SFS laws
  - [ ] Test: Handle duplicate detection (skip existing cases)
  - [ ] Test: Parse court-specific fields (AD arbetsdomstolenDomsnummer)
  - [ ] Test: Query cases by content_type and court_name
  - [ ] Run tests: `pnpm test tests/integration/ingestion/`

## Dev Notes

### Previous Story Insights (Story 2.2)

[Source: docs/stories/2.2.ingest-sfs-laws-riksdagen.md - Dev Agent Record + QA Results]

**Key Learnings:**

- **Test Environment Fixed:** vitest.config.mts now properly loads .env.local before Prisma initialization (CRITICAL for database tests)
- **Package Manager:** `pnpm` (NOT npm) - all package commands must use pnpm
- **Database Strategy:** Single development database for MVP (Supabase EU: Frankfurt). Will create separate prod database pre-launch.
- **SFS Laws Loaded:** 11,351 SFS laws in database from Story 2.2 (PREREQUISITE for cross-references)
- **Prisma Client Patterns:**
  - Use `findUnique` for duplicate detection (indexed queries)
  - JSONB metadata for flexible schema evolution
  - Proper connection cleanup with `$disconnect`
- **Error Handling Pattern:**
  - Retry logic with exponential backoff (3 attempts)
  - Graceful error recovery (continue on individual failures)
  - Non-blocking errors (log and continue)
- **Progress Monitoring Pattern:**
  - Log every 100 documents with percentage
  - ETA calculation based on average processing time
  - Final summary with execution time and stats

### Domstolsverket PUH API Integration

[Source: docs/external-apis/domstolsverket-api-comprehensive-analysis.md - Sections 1-4]

**API Overview:**

- **Base URL:** `/api/v1/` (production host: likely `https://api.domstol.se/puh`)
- **Authentication:** Public API (no auth required in OpenAPI spec)
- **Format:** JSON (REST API)
- **Coverage:** Swedish court cases from multiple courts with rich metadata

**Key Endpoints:**

1. **GET /api/v1/publiceringar** - List all publications
   - Query params: `page`, `pagesize`, `domstolkod`, `malnummer`, `sortorder`, `asc`
   - Returns: `PubliceringDTO[]` array
   - Use for: Simple pagination through all cases

2. **POST /api/v1/sok** - Advanced search
   - Request body: `SokRequestDTO` with complex filters
   - Returns: `SokResponseDTO` with `{total, publiceringLista}`
   - Use for: Filtering by court, date range, SFS references, legal areas

3. **GET /api/v1/publiceringar/{id}** - Get single case
   - Returns: Full `PubliceringDTO` with all metadata
   - Use for: Fetching detailed case data

**Rate Limiting:**

- Recommended: 5 req/sec (conservative, respectful to government API)
- Implementation: Use `p-limit` library (already installed from Story 2.2)

**Data Model (TypeScript):**

```typescript
interface PubliceringDTO {
  // Core identifiers
  id: string                            // Unique publication ID
  gruppKorrelationsnummer: string       // Group correlation number
  ecliNummer?: string                   // European Case Law Identifier

  // Court information
  domstol: DomstolDTO                   // Court that issued decision

  // Case metadata
  typ: string                           // "Dom", "Beslut"
  malNummerLista: string[]              // Case numbers (e.g., ["Ã– 1234-22"])
  avgorandedatum: string                // Decision date (ISO string)
  publiceringstid: string               // Publication timestamp

  // Content
  sammanfattning?: string               // Summary (may be null)
  innehall?: string                     // Full text content (HTML - PRESERVE!)
  benamning?: string                    // Case name/title
  arVagledande: boolean                 // Is guiding precedent?

  // References and categorization
  referatNummerLista: string[]          // NJA, RH series references
  arbetsdomstolenDomsnummer?: string    // AD-specific case number
  lagrumLista: LagrumDTO[]              // Cited SFS laws (CRITICAL!)
  nyckelordLista: string[]              // Keywords
  rattsomradeLista: string[]            // Legal areas

  // Related cases and attachments
  hanvisadePubliceringarLista: PubliceringsgruppHanvisningDTO[]
  bilagaLista: PubliceringBilagaDTO[]   // PDF attachments (CRITICAL!)

interface PubliceringBilagaDTO {
  fillagringId: string                  // Storage ID for /api/v1/bilagor/{id}
  filnamn: string                       // Filename: "AD_2023_nr_45.pdf"
}
}

interface DomstolDTO {
  domstolKod: string                    // "HD", "HovR-Stockholm"
  domstolNamn: string                   // "HÃ¶gsta domstolen"
}

interface LagrumDTO {
  sfsNummer: string                     // "SFS 1977:1160" (CRITICAL FOR CROSS-REFS!)
  referens?: string                     // "3 kap. 2 Â§"
}
```

**Search Strategy for Multi-Court Ingestion:**

```typescript
// Priority order: AD â†’ HFD â†’ HD â†’ HovR
const courts = [
  { code: 'AD', name: 'Arbetsdomstolen', contentType: 'AD_LABOUR_COURT' },
  {
    code: 'HFD',
    name: 'HÃ¶gsta fÃ¶rvaltningsdomstolen',
    contentType: 'HFD_ADMIN_SUPREME',
  },
  { code: 'HD', name: 'HÃ¶gsta domstolen', contentType: 'HD_SUPREME_COURT' },
  // HovR requires multiple codes: HovR-Stockholm, HovR-GÃ¶teborg, etc.
  { code: 'HovR', name: 'HovrÃ¤tterna', contentType: 'HOVR_COURT_APPEAL' },
]

// Use advanced search to filter by court
async function fetchCourtCases(courtCode: string, page: number) {
  const response = await domstolsverketClient.search({
    sidIndex: page,
    antalPerSida: 100,
    sortorder: 'avgorandedatum',
    asc: false,
    filter: {
      domstolKodLista: [courtCode],
    },
  })
  return response
}
```

**Estimated Volumes per Court:**

[Source: docs/external-apis/domstolsverket-api-comprehensive-analysis.md - Section 4]

| Court                                  | Code    | Content Type      | Estimated Cases   | Business Impact                |
| -------------------------------------- | ------- | ----------------- | ----------------- | ------------------------------ |
| **AD** (Arbetsdomstolen)               | AD      | AD_LABOUR_COURT   | 2,000-3,000       | **CRITICAL** - All employers   |
| **HFD** (HÃ¶gsta fÃ¶rvaltningsdomstolen) | HFD     | HFD_ADMIN_SUPREME | ~5,000            | **Very High** - Tax/admin law  |
| **HD** (HÃ¶gsta domstolen)              | HD      | HD_SUPREME_COURT  | ~3,000            | High - Supreme Court precedent |
| **HovR** (HovrÃ¤tterna)                 | HovR-\* | HOVR_COURT_APPEAL | ~8,000            | High - Practical precedent     |
| **Total**                              |         |                   | **~18,000 cases** |                                |

**Total estimated ingestion time:**

- 18,000 cases Ã· 5 req/sec = 3,600 seconds = ~1 hour (API fetch)
- - Parsing and database insertion: ~2-3 hours
- - Cross-reference extraction: ~1 hour
- **Total: ~4-5 hours** (well under 12 hour AC)

### Competitive Advantage: AD (Arbetsdomstolen)

[Source: docs/external-apis/domstolsverket-api-comprehensive-analysis.md - Section 6 + Analyst Review 2025-11-27]

**ğŸ† WHY AD IS THE MOST CRITICAL COMPETITIVE ADVANTAGE:**

**Notisum's Broken AD Coverage:**

- Individual AD case detail pages show only "- - -" (empty)
- Full judgment text NOT accessible
- Links broken
- List view works (summaries only) but full text unavailable

**Our Advantage:**

- Domstolsverket PUH API has **working AD data** with full text (`innehall` field)
- Field `arbetsdomstolenDomsnummer` confirms AD support in API
- This fills a MAJOR gap in Notisum's offering

**Business Impact:**

- **100% of Swedish employers** need employment law guidance (~850,000 companies)
- Employment law violations are common and expensive
- AD covers: hiring, firing, discrimination, workplace conditions, collective agreements
- **ALL businesses with employees** need AD precedent (unlike tax law HFD which is also 100%, but AD is more frequent)

**Real-world AD use cases:**

- Can I fire someone for poor performance? (AD precedent)
- Is this hiring practice discriminatory? (AD precedent)
- What notice period for dismissal? (AD precedent)
- Can I monitor employee emails? (AD precedent)

**Verification Strategy (Task 6):**
After ingestion, verify AD advantage by:

1. Query 10 random AD cases
2. Confirm `fullText` is populated (NOT null or empty)
3. Document that we have working AD data while Notisum doesn't

This is a **genuine competitive moat** for SMB customers.

### Database Schema (CourtCase Model)

[Source: docs/architecture/4-data-models.md - Section 4.6]

**Table:** `court_cases` (one-to-one with `legal_documents`)

**Purpose:** Type-specific metadata for court case documents. Extends `LegalDocument` with case-specific fields.

**Schema:**

```prisma
model CourtCase {
  id            String        @id @default(uuid())
  documentId    String        @unique @map("document_id") // FK to LegalDocument
  courtName     String        @map("court_name")         // "HÃ¶gsta domstolen"
  caseNumber    String        @map("case_number")        // "B 1234-23"
  lowerCourt    String?       @map("lower_court")        // Previous court if appeal
  decisionDate  DateTime      @map("decision_date")      // Verdict date
  parties       Json?                                    // JSONB: {plaintiff, defendant, counsels}

  // Relationships
  document      LegalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("court_cases")
}
```

**TypeScript Interface:**

```typescript
interface CourtCase {
  id: string
  documentId: string // FK to LegalDocument
  courtName: string // From domstol.domstolNamn
  caseNumber: string // From malNummerLista[0]
  lowerCourt: string | null // Parse from metadata if appeal
  decisionDate: Date // From avgorandedatum
  parties: {
    // JSONB
    plaintiff?: string
    defendant?: string
    plaintiff_counsel?: string
    defendant_counsel?: string
  } | null
}
```

**Design Decisions:**

- One-to-one with `LegalDocument` (not polymorphic columns)
- Only created when `LegalDocument.content_type` is a court case type
- `parties` as JSONB handles varying structures (criminal vs civil vs administrative)

### HTML Preservation and PDF Attachment Storage

**CRITICAL REQUIREMENTS:**

1. **Preserve Full HTML:**
   - âš ï¸ **DO NOT strip HTML tags** from `innehall` field
   - Store complete HTML in `fullText` field as-is
   - Preserves: Formatting, links, structure, emphasis, lists, tables
   - Frontend will sanitize HTML when rendering (use DOMPurify or similar)

2. **Store PDF Attachment Metadata:**
   - Extract `bilagaLista` array from API response
   - Store in `metadata.attachments` JSONB array
   - Each attachment: `{fillagringId, filnamn, downloadUrl: null}`
   - Future story will download PDFs using `/api/v1/bilagor/{fillagringId}`

**Example:**

```typescript
await prisma.legalDocument.create({
  data: {
    contentType: 'AD_LABOUR_COURT',
    documentNumber: 'AD 2023 nr 45',
    title: 'ArbetsmiljÃ¶ansvar vid distansarbete',
    summary: dto.sammanfattning,
    fullText: dto.innehall, // âœ… PRESERVE HTML - do NOT strip!
    publicationDate: new Date(dto.publiceringstid),
    sourceUrl: `https://api.domstol.se/publiceringar/${dto.id}`,
    metadata: {
      ecliNummer: dto.ecliNummer,
      typ: dto.typ,
      arVagledande: dto.arVagledande,
      nyckelordLista: dto.nyckelordLista,
      rattsomradeLista: dto.rattsomradeLista,
      // âœ… STORE PDF ATTACHMENT METADATA
      attachments:
        dto.bilagaLista?.map((bilaga) => ({
          fillagringId: bilaga.fillagringId, // Use this to download PDF
          filnamn: bilaga.filnamn, // e.g., "AD_2023_nr_45.pdf"
          downloadUrl: null, // Will be populated after download
        })) || [],
    },
  },
})
```

**Why Preserve HTML:**

- Court judgments include formatted text, section headers, emphasis
- Internal links to other documents or sections
- Tables of data or comparisons
- Lists of cited cases or laws
- Proper paragraph structure
- **Stripping HTML would lose critical structural information**

**PDF Download Strategy (Future Story):**

```typescript
// Future: Download PDFs and populate downloadUrl
for (const attachment of courtCase.metadata.attachments) {
  const pdfBlob = await fetch(`/api/v1/bilagor/${attachment.fillagringId}`)
  const { data } = await supabase.storage
    .from('court-case-attachments')
    .upload(`${attachment.fillagringId}/${attachment.filnamn}`, pdfBlob)

  // Update downloadUrl in metadata
  await prisma.legalDocument.update({
    where: { id: courtCase.id },
    data: {
      metadata: {
        ...courtCase.metadata,
        attachments: courtCase.metadata.attachments.map((att) =>
          att.fillagringId === attachment.fillagringId
            ? { ...att, downloadUrl: data.publicUrl }
            : att
        ),
      },
    },
  })
}
```

---

### CrossReference Model (For SFS Law Citations)

[Source: docs/architecture/4-data-models.md - Section 4.8]

**Table:** `cross_references`

**Purpose:** Links between documents (court case cites SFS law, law amends another law, etc.)

**Schema:**

```prisma
model CrossReference {
  id                String        @id @default(uuid())
  sourceDocumentId  String        @map("source_document_id")  // FK to LegalDocument (court case)
  targetDocumentId  String        @map("target_document_id")  // FK to LegalDocument (SFS law)
  referenceType     ReferenceType @map("reference_type")      // "CASE_CITES_LAW"
  context           String?       @db.Text                    // Specific section cited (e.g., "3 kap. 2 Â§")

  // Relationships
  sourceDocument    LegalDocument @relation("SourceReferences", fields: [sourceDocumentId], references: [id], onDelete: Cascade)
  targetDocument    LegalDocument @relation("TargetReferences", fields: [targetDocumentId], references: [id], onDelete: Cascade)

  @@map("cross_references")
  @@index([sourceDocumentId])
  @@index([targetDocumentId])
  @@index([referenceType])
}

enum ReferenceType {
  CASE_CITES_LAW
  CITES
  AMENDS
  IMPLEMENTS
  REPEALS
  RELATED
}
```

**Usage for Court Cases:**

```typescript
// Extract SFS references from lagrumLista
for (const lagrum of apiResponse.lagrumLista) {
  const sfsLaw = await prisma.legalDocument.findUnique({
    where: { documentNumber: lagrum.sfsNummer },
  })

  if (sfsLaw) {
    await prisma.crossReference.create({
      data: {
        sourceDocumentId: courtCaseDoc.id,
        targetDocumentId: sfsLaw.id,
        referenceType: 'CASE_CITES_LAW',
        context: lagrum.referens, // e.g., "3 kap. 2 Â§"
      },
    })
  }
}
```

### ContentType Enum (Court Case Types)

[Source: docs/architecture/4-data-models.md - Section 4.5 + PRD Story 2.1]

**Prisma Enum:**

```prisma
enum ContentType {
  SFS_LAW                  // From Story 2.2
  AD_LABOUR_COURT          // NEW - Arbetsdomstolen
  HFD_ADMIN_SUPREME        // NEW - HÃ¶gsta fÃ¶rvaltningsdomstolen
  HD_SUPREME_COURT         // NEW - HÃ¶gsta domstolen
  HOVR_COURT_APPEAL        // NEW - HovrÃ¤tterna
  MOD_ENVIRONMENT_COURT    // Future - Mark- och miljÃ¶Ã¶verdomstolen
  MIG_MIGRATION_COURT      // Future - MigrationsÃ¶verdomstolen
  EU_REGULATION            // Future - EU regulations
  EU_DIRECTIVE             // Future - EU directives
}
```

**Mapping Court Codes to Content Types:**

```typescript
function mapCourtCodeToContentType(courtCode: string): ContentType {
  if (courtCode === 'AD') return 'AD_LABOUR_COURT'
  if (courtCode === 'HFD') return 'HFD_ADMIN_SUPREME'
  if (courtCode === 'HD') return 'HD_SUPREME_COURT'
  if (courtCode.startsWith('HovR')) return 'HOVR_COURT_APPEAL'
  throw new Error(`Unknown court code: ${courtCode}`)
}
```

### File Locations

[Source: docs/architecture/12-unified-project-structure.md + Story 2.1]

```
laglig_se/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ external/
â”‚       â”œâ”€â”€ riksdagen.ts                    # EXISTING - From Story 2.2
â”‚       â””â”€â”€ domstolsverket.ts               # NEW - API client library
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ ingest-sfs-laws.ts                  # EXISTING - From Story 2.2
â”‚   â””â”€â”€ ingest-court-cases.ts               # NEW - Multi-court ingestion
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma                       # EXISTING - Schema from Story 2.1
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ integration/
â”‚       â””â”€â”€ ingestion/
â”‚           â”œâ”€â”€ sfs-laws.test.ts            # EXISTING - From Story 2.2
â”‚           â””â”€â”€ court-cases.test.ts         # NEW - Court case ingestion tests
â””â”€â”€ .env.local                              # EXISTING - Database credentials
```

### Script Execution Order

**Prerequisites:**

1. âœ… Story 2.1 complete (database schema created)
2. âœ… Story 2.2 complete (11,351 SFS laws in database - needed for cross-references)
3. âœ… Database connection working (verified in Story 2.2)

**Execution:**

```bash
# Run court case ingestion
pnpm tsx scripts/ingest-court-cases.ts
```

**Expected Output:**

```
Starting court case ingestion (4 courts: AD, HFD, HD, HovR)...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ›ï¸  AD (Arbetsdomstolen) - Labour Court
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Fetching cases from Domstolsverket API...
AD: Processed 500/2,487 cases (20%) - ETA: 12 minutes
AD: Processed 1,000/2,487 cases (40%) - ETA: 8 minutes
...
AD: Processed 2,487/2,487 cases (100%)
âœ… AD complete: 2,487 cases inserted, 13 skipped (duplicates)
ğŸ“Š Cross-references: 12,435 links to SFS laws created

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ›ï¸  HFD (HÃ¶gsta fÃ¶rvaltningsdomstolen) - Admin Supreme
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Fetching cases from Domstolsverket API...
HFD: Processed 1,000/5,123 cases (20%) - ETA: 25 minutes
...

[... similar for HD and HovR ...]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š FINAL SUMMARY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total courts: 4
Total cases ingested: 18,234
  - AD (Labour Court): 2,487 cases
  - HFD (Admin Supreme): 5,123 cases
  - HD (Supreme Court): 2,876 cases
  - HovR (Courts of Appeal): 7,748 cases

Total cross-references created: 89,456 (case â†’ SFS law links)
Execution time: 4 hours 37 minutes
Errors: 23 (logged, non-blocking)

âœ… Court case ingestion complete!
ğŸ† Competitive advantage verified: AD cases have full text (Notisum's AD is broken)
```

### Coding Standards

[Source: docs/architecture/17-coding-standards.md - Section 17.4]

**Error Handling Pattern (reuse from Story 2.2):**

```typescript
async function fetchWithRetry(url: string, maxRetries = 3): Promise<Response> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await fetch(url)
      if (response.ok) return response

      if (i < maxRetries - 1) {
        await sleep(Math.pow(2, i) * 1000) // Exponential backoff: 1s, 2s, 4s
        continue
      }
    } catch (error) {
      if (i === maxRetries - 1) throw error
      await sleep(Math.pow(2, i) * 1000)
    }
  }
  throw new Error(`Failed to fetch ${url} after ${maxRetries} retries`)
}
```

**Progress Logging Pattern (reuse from Story 2.2):**

```typescript
let processed = 0
const total = estimatedCases

console.log(`Starting ${courtName} ingestion: ~${total} cases`)

for (const courtCase of cases) {
  await processCourtCase(courtCase)
  processed++

  if (processed % 100 === 0) {
    const percent = Math.round((processed / total) * 100)
    const eta = calculateETA(startTime, processed, total)
    console.log(
      `${courtCode}: Processed ${processed}/${total} cases (${percent}%) - ETA: ${eta}`
    )
  }
}

console.log(`âœ… ${courtName} complete: ${processed} cases inserted`)
```

### Testing Strategy

[Source: docs/architecture/testing-strategy.md + Story 2.2 patterns]

**Test File:** `tests/integration/ingestion/court-cases.test.ts`

**Test Coverage:**

1. **API Integration:** Fetch single court case from Domstolsverket API
2. **Data Parsing:** Parse PubliceringDTO to LegalDocument fields
3. **Database Insertion:** Insert court case + CourtCase metadata
4. **HTML Preservation:** Verify fullText contains HTML tags (not stripped)
5. **PDF Attachment Metadata:** Verify metadata.attachments array populated with fillagringId and filnamn
6. **Cross-Reference Extraction:** Parse lagrumLista and create CrossReference records
7. **Duplicate Detection:** Skip cases with existing documentNumber
8. **Court-Specific Fields:** Parse arbetsdomstolenDomsnummer for AD cases
9. **JSONB Handling:** Store parties field correctly
10. **Error Handling:** Simulate API failures, verify retry logic

**Test Pattern:**

```typescript
import { describe, it, expect, afterAll, beforeEach } from 'vitest'
import { PrismaClient, ContentType } from '@prisma/client'

const prisma = new PrismaClient()

describe('Court Case Ingestion', () => {
  beforeEach(async () => {
    // Clean up test data
    await prisma.crossReference.deleteMany({})
    await prisma.courtCase.deleteMany({})
    await prisma.legalDocument.deleteMany({
      where: { contentType: 'AD_LABOUR_COURT' },
    })
  })

  afterAll(async () => {
    await prisma.$disconnect()
  })

  it('fetches and stores AD court case correctly with HTML preserved', async () => {
    const testCase = {
      documentNumber: 'AD 2023 nr 45',
      title: 'Test AD Case',
      contentType: ContentType.AD_LABOUR_COURT,
      fullText:
        '<h1>Domslut</h1><p>Arbetsgivaren ska betala <strong>skadestÃ¥nd</strong>.</p>', // HTML preserved!
      publicationDate: new Date('2023-06-15'),
      status: 'ACTIVE',
      sourceUrl: 'https://api.domstol.se/...',
      metadata: {
        ecliNummer: 'ECLI:SE:AD:2023:45',
        arVagledande: true,
        attachments: [
          {
            fillagringId: 'xyz789-storage-id',
            filnamn: 'AD_2023_nr_45.pdf',
            downloadUrl: null,
          },
        ],
      },
    }

    const doc = await prisma.legalDocument.create({ data: testCase })

    const courtCase = await prisma.courtCase.create({
      data: {
        documentId: doc.id,
        courtName: 'Arbetsdomstolen',
        caseNumber: '2023 nr 45',
        decisionDate: new Date('2023-06-15'),
        parties: {
          plaintiff: 'IF Metall',
          defendant: 'Acme AB',
        },
      },
    })

    // Verify HTML is preserved
    expect(doc.fullText).toContain('<h1>')
    expect(doc.fullText).toContain('<strong>')
    expect(doc.fullText).not.toBe(
      'Domslut Arbetsgivaren ska betala skadestÃ¥nd.'
    ) // NOT stripped!

    // Verify PDF attachment metadata
    expect(doc.metadata.attachments).toBeDefined()
    expect(doc.metadata.attachments.length).toBe(1)
    expect(doc.metadata.attachments[0]).toMatchObject({
      fillagringId: 'xyz789-storage-id',
      filnamn: 'AD_2023_nr_45.pdf',
      downloadUrl: null,
    })

    expect(courtCase).toBeDefined()
    expect(courtCase.courtName).toBe('Arbetsdomstolen')
  })

  it('creates cross-references to SFS laws', async () => {
    // Create test SFS law first
    const sfsLaw = await prisma.legalDocument.create({
      data: {
        documentNumber: 'SFS 1982:80',
        title: 'AnstÃ¤llningsskyddslag (1982:80)',
        contentType: ContentType.SFS_LAW,
        status: 'ACTIVE',
        slug: 'anstallningsskyddslag-1982-80',
      },
    })

    // Create test court case
    const courtCase = await prisma.legalDocument.create({
      data: {
        documentNumber: 'AD 2023 nr 45',
        title: 'Test AD Case',
        contentType: ContentType.AD_LABOUR_COURT,
        status: 'ACTIVE',
        slug: 'ad-2023-nr-45',
      },
    })

    // Create cross-reference
    const crossRef = await prisma.crossReference.create({
      data: {
        sourceDocumentId: courtCase.id,
        targetDocumentId: sfsLaw.id,
        referenceType: 'CASE_CITES_LAW',
        context: '7 Â§',
      },
    })

    expect(crossRef).toBeDefined()
    expect(crossRef.referenceType).toBe('CASE_CITES_LAW')
    expect(crossRef.context).toBe('7 Â§')

    // Verify relationship
    const caseWithRefs = await prisma.legalDocument.findUnique({
      where: { id: courtCase.id },
      include: {
        sourceReferences: {
          include: { targetDocument: true },
        },
      },
    })

    expect(caseWithRefs?.sourceReferences.length).toBe(1)
    expect(
      caseWithRefs?.sourceReferences[0].targetDocument.documentNumber
    ).toBe('SFS 1982:80')
  })
})
```

**Run Tests:**

```bash
# Run integration tests
pnpm test tests/integration/ingestion/

# Run with coverage
pnpm test:coverage tests/integration/ingestion/
```

### Environment Variables

[Source: docs/database-setup.md + Story 2.2]

**Required in `.env.local`:**

```bash
# Supabase Database (Transaction Mode - Port 6543)
DATABASE_URL="postgresql://postgres.PROJECT:PASSWORD@aws-1-eu-north-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"

# Supabase Database (Session Mode - Port 5432)
DIRECT_URL="postgresql://postgres.PROJECT:PASSWORD@aws-1-eu-north-1.pooler.supabase.com:5432/postgres"
```

**Security:**

- âœ… `.env.local` is gitignored
- âŒ NEVER commit API keys to git
- âœ… Production credentials stored in Vercel environment variables only

### Next Stories Dependencies

**This story is a BLOCKER for:**

- Story 2.5: Generate SEO Pages (requires court case data)
- Story 2.6: Content Categorization (requires cases to categorize)
- Story 2.7: Multi-Content-Type Search (requires searchable court cases)
- Story 2.10: RAG Implementation (requires court case embeddings)

**This story DEPENDS ON:**

- âœ… Story 2.1: Multi-Content-Type Data Model (COMPLETE)
- âœ… Story 2.2: Ingest SFS Laws (COMPLETE - needed for cross-references)

**Ensure Story 2.2 is FULLY COMPLETE before starting this story.**

### Performance Expectations

[Source: AC 11, 12 + API analysis]

**Ingestion Timeline:**

| Phase        | Operation          | Cases             | Rate      | Estimated Time  |
| ------------ | ------------------ | ----------------- | --------- | --------------- |
| 1            | Fetch AD cases     | 2,500             | 5 req/sec | ~8 minutes      |
| 2            | Fetch HFD cases    | 5,000             | 5 req/sec | ~17 minutes     |
| 3            | Fetch HD cases     | 3,000             | 5 req/sec | ~10 minutes     |
| 4            | Fetch HovR cases   | 8,000             | 5 req/sec | ~27 minutes     |
| **Subtotal** | **API Fetching**   | **18,500**        |           | **~62 minutes** |
| 5            | Parse + Insert     | 18,500            | ~50/min   | ~6 hours        |
| 6            | Extract Cross-Refs | 18,500 cases      | ~100/min  | ~3 hours        |
| **Total**    | **Full Ingestion** | **~18,500 cases** |           | **~10 hours**   |

**Well under 12 hour AC âœ…**

**Database Impact:**

- **Court Cases:** 18,500 Ã— ~15KB avg = ~277MB
- **CourtCase Metadata:** 18,500 Ã— ~500 bytes = ~9MB
- **Cross-References:** ~90,000 Ã— ~200 bytes = ~18MB
- **Total:** ~304MB additional storage
- **Current Dev DB:** Supabase Free tier (500MB limit) - **Will exceed limit after this story**
  - After Story 2.2: ~158MB (SFS laws + amendments)
  - After Story 2.3: ~462MB (SFS + court cases)
  - **Recommendation:** Upgrade to Supabase Pro tier ($25/month) or start pre-launch prod database setup

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Author     |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Sarah (PO) |
| 2025-11-27 | 2.0     | Comprehensive enrichment with full architecture context, Domstolsverket PUH API integration details (Section 1-4 from comprehensive analysis), competitive advantage analysis (AD vs Notisum), court priority strategy (ADâ†’HFDâ†’HDâ†’HovR), complete data model specifications (CourtCase, CrossReference, ContentType enum), testing requirements, and complete technical guidance. Documented AD competitive moat (working full text vs Notisum's broken pages). Added storage impact warning (will exceed 500MB free tier).                                                                                          | Bob (SM)   |
| 2025-11-27 | 2.1     | **CRITICAL UPDATE:** Added explicit requirements to preserve full HTML in fullText field (AC 5a) and store PDF attachment metadata in metadata.attachments JSONB array (AC 5b). Updated Task 3 to extract bilagaLista from API response and store {fillagringId, filnamn, downloadUrl: null} for future PDF download via /api/v1/bilagor/{lagringId} endpoint. Added comprehensive Dev Notes section on HTML preservation rationale and PDF download strategy. Updated test coverage to verify HTML tags preserved and attachment metadata stored. Added PubliceringBilagaDTO interface to data model documentation. | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
