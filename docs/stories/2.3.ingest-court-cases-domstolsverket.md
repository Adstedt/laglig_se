# Story 2.3: Ingest Swedish Court Cases from Domstolsverket API

## Status

Draft

## Story

**As a** developer,
**I want** to fetch court cases from AD, HFD, HD, and HovR courts,
**so that** we have comprehensive Swedish case law precedent.

## Acceptance Criteria

1. Integration with Domstolsverket PUH API
2. Node script fetches cases from 4 courts (priority: AD, HFD, HD, HovR)
3. For each case: case number, decision date, court name, summary, full text, lower court, parties
4. Data stored in `legal_documents` with appropriate content_type
5. Court-specific metadata in `court_cases` table
6. Case numbering formats preserved (AD YYYY nr N, etc.)
7. Extract cross-references to SFS laws from `lagrumLista`
8. Rate limiting (5 req/sec)
9. Progress logging per court
10. Error handling with retry
11. Script completes in <12 hours
12. Verification: 10,000-20,000 cases in database
13. Competitive advantage: AD data working (Notisum's AD is broken)

## Tasks / Subtasks

- [ ] Configure Domstolsverket API access
  - [ ] Verify API endpoint availability
  - [ ] Test authentication if required
  - [ ] Document API structure

- [ ] Create multi-court ingestion script
  - [ ] Priority order: AD → HFD → HD → HovR
  - [ ] Parse response for each court type
  - [ ] Handle court-specific fields

- [ ] Store in database
  - [ ] Insert into `legal_documents`
  - [ ] Set appropriate content_type per court
  - [ ] Insert court metadata into `court_cases`

- [ ] Extract SFS law cross-references
  - [ ] Parse `lagrumLista` field
  - [ ] Create `cross_references` records
  - [ ] Link cases → laws bidirectionally

- [ ] Implement rate limiting and error handling
  - [ ] 5 requests/second
  - [ ] Retry failed requests 3x
  - [ ] Log progress per court

- [ ] Verify completion
  - [ ] Check case counts by court
  - [ ] Verify cross-references created
  - [ ] Sample quality check

## Dev Notes

### Domstolsverket API Structure

**API Endpoint:** (from domstolsverket-api-comprehensive-analysis.md)

```
https://api.domstol.se/puh/v1/...
```

**Script Example:**

```typescript
// scripts/ingest-court-cases.ts
async function ingestCourtCases() {
  const courts = [
    { name: 'AD', type: 'AD_LABOUR_COURT', priority: 1 },
    { name: 'HFD', type: 'HFD_ADMIN_SUPREME', priority: 2 },
    { name: 'HD', type: 'HD_SUPREME_COURT', priority: 3 },
    { name: 'HovR', type: 'HOVR_COURT_APPEAL', priority: 4 },
  ]

  for (const court of courts) {
    console.log(`Ingesting ${court.name} cases...`)
    await ingestCourtType(court)
  }
}

async function ingestCourtType(court: any) {
  let page = 1
  let totalProcessed = 0

  while (true) {
    const cases = await fetchCourtCases(court.name, page)
    if (!cases.length) break

    for (const caseData of cases) {
      await processCourtCase(caseData, court.type)
      totalProcessed++

      if (totalProcessed % 100 === 0) {
        console.log(`${court.name}: ${totalProcessed} cases processed`)
      }
    }

    page++
    await sleep(200) // Rate limiting
  }
}

async function processCourtCase(data: any, contentType: string) {
  // Create legal document
  const doc = await prisma.legalDocument.create({
    data: {
      contentType,
      documentNumber: data.malnummer,
      title: data.rubrik || data.malnummer,
      summary: data.sammanfattning,
      fullText: data.avgorande,
      publicationDate: new Date(data.avgdatum),
      sourceUrl: data.url,
    },
  })

  // Create court case metadata
  await prisma.courtCase.create({
    data: {
      documentId: doc.id,
      courtName: data.domstol,
      caseNumber: data.malnummer,
      decisionDate: new Date(data.avgdatum),
      lowerCourt: data.underinstans,
      parties: data.parter, // JSONB
    },
  })

  // Extract and create cross-references to laws
  if (data.lagrumLista) {
    for (const lawRef of data.lagrumLista) {
      const referencedLaw = await findLawByReference(lawRef)

      if (referencedLaw) {
        await prisma.crossReference.create({
          data: {
            sourceDocumentId: doc.id,
            targetDocumentId: referencedLaw.id,
            referenceType: 'CASE_CITES_LAW',
            context: extractCitationContext(data.avgorande, lawRef),
          },
        })
      }
    }
  }
}
```

### Important Architecture References

**From docs/external-apis/domstolsverket-api-comprehensive-analysis.md:**

- Section 3: API structure
- Section 4: Court-by-court data analysis
- Section 6: Competitive intelligence (AD advantage)
- Section 10: Implementation guide

**Competitive Advantage:**
AD (Arbetsdomstolen) is CRITICAL for employment law. Notisum's AD coverage is broken (empty case pages). Domstolsverket PUH API has working AD data, giving us unique market advantage.

### Testing

**Test File:** `tests/integration/ingestion/court-cases.test.ts`

Verify cases from each court type ingested correctly, cross-references created, metadata stored properly.

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
