# Story 3.9: Add Citation Verification and Hallucination Detection

## Status

Draft

## Story

**As a** product owner,
**I want** to verify that AI responses are grounded in retrieved chunks,
**so that** we minimize hallucinations and maintain trust.

## Acceptance Criteria

1. Backend logs every AI response with: query, retrieved chunks, LLM response
2. Post-processing script checks if answer contains claims not in retrieved chunks
3. Hallucination detection uses keyword matching (v1) or LLM-based verification (v2)
4. If hallucination detected, flag response for manual review
5. Dashboard shows hallucination rate: Target <5%
6. Prompt engineering iteration to reduce hallucinations
7. System instruction enforced: "If you cannot answer from provided sources, respond 'Jag har inte tillrÃ¤cklig information...'"
8. Test with 50 edge case questions (manual review confirms >95% grounded)

## Tasks / Subtasks

- [ ] Implement response logging
- [ ] Create hallucination detection script
- [ ] Build review dashboard
- [ ] Refine system prompts
- [ ] Test with edge cases

## Dev Notes

**Logging Structure:**

```typescript
await prisma.chatLog.create({
  data: {
    query: userQuery,
    retrievedChunks: JSON.stringify(chunks),
    llmResponse: answer,
    timestamp: new Date(),
    hallucinationScore: null, // computed post-hoc
  },
})
```

**Simple Hallucination Detection:**

```typescript
function detectHallucination(answer: string, chunks: string[]): boolean {
  // Extract factual claims from answer
  const claims = extractClaims(answer)

  // Check if each claim is supported by chunks
  for (const claim of claims) {
    const supported = chunks.some((chunk) =>
      chunk.toLowerCase().includes(claim.toLowerCase())
    )

    if (!supported) return true // hallucination detected
  }

  return false
}
```

**Reference:** Architecture Section 18 (Error Handling), Section 19 (Monitoring)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
