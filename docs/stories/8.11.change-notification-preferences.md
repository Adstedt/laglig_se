# Story 8.11: Implement Change Notification Preferences

## Status

Draft

## Story

**As a** user,
**I want** to customize which change notifications I receive,
**so that** I'm not overwhelmed.

## Acceptance Criteria

1. **Workspace Settings → Notifications tab**

2. **Email Preferences:**
   - Daily digest (On/Off)
   - Weekly digest (On/Off)
   - Reminders (On/Off)
   - Frequency: Instant / Daily / Weekly / Off

3. **In-App Preferences:**
   - Notification bell (On/Off)
   - Desktop notifications (On/Off) - Browser API

4. **Change Type Filters:**
   - Amendments (On/Off)
   - New sections (On/Off)
   - Repeals (On/Off)
   - Metadata changes (On/Off)

5. **Priority Filters:**
   - High priority only
   - High + Medium
   - All priorities (default)

6. **Preferences saved per user** (not workspace-wide)

7. **Default settings: All enabled** (except desktop notifications)

8. **Warning modal when disabling critical notifications:**
   - "Disabling high-priority notifications may cause you to miss important changes. Continue?"

9. **Preview email** button to test email settings

10. **Preferences applied to:**
    - Email sending (cron jobs check preferences)
    - In-app notification bell (hides if disabled)
    - Changes tab filtering (optional)

11. **Unsubscribe links in emails** redirect to preferences page

## Tasks / Subtasks

- [ ] Create Notifications tab in Settings page
- [ ] Build NotificationPreferences component
- [ ] Create database schema for user preferences
- [ ] Add toggles for email preferences
- [ ] Add toggles for in-app preferences
- [ ] Add checkboxes for change type filters
- [ ] Add radio buttons for priority filters
- [ ] Implement warning modal for disabling critical settings
- [ ] Add "Preview Email" button
- [ ] Update email cron jobs to check preferences
- [ ] Update notification bell to respect preferences
- [ ] Handle unsubscribe links from emails
- [ ] Test preference saving and loading
- [ ] Test email sending respects preferences

## Dev Notes

**Database Schema:**

```prisma
model UserNotificationPreferences {
  id                    String  @id @default(uuid())
  userId                String  @unique

  // Email preferences
  emailDailyDigest      Boolean @default(true)
  emailWeeklyDigest     Boolean @default(true)
  emailReminders        Boolean @default(true)
  emailFrequency        String  @default("daily") // instant, daily, weekly, off

  // In-app preferences
  inAppBell             Boolean @default(true)
  desktopPush           Boolean @default(false)

  // Change type filters
  notifyAmendments      Boolean @default(true)
  notifyNewSections     Boolean @default(true)
  notifyRepeals         Boolean @default(true)
  notifyMetadata        Boolean @default(false)

  // Priority filter
  priorityFilter        String  @default("all") // high, high_medium, all

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("user_notification_preferences")
}
```

**Notifications Settings Page:**

```typescript
// app/settings/notifications/page.tsx
import { withAuth } from '@/lib/auth/with-auth'
import { prisma } from '@/lib/prisma'
import { NotificationPreferences } from '@/components/settings/notification-preferences'

export default async function NotificationsSettingsPage() {
  return withAuth(async ({ userId }) => {
    // Get or create preferences
    let preferences = await prisma.userNotificationPreferences.findUnique({
      where: { userId }
    })

    if (!preferences) {
      // Create default preferences
      preferences = await prisma.userNotificationPreferences.create({
        data: { userId }
      })
    }

    return (
      <div className="max-w-3xl mx-auto p-6">
        <div className="mb-6">
          <h1 className="text-2xl font-bold">Notification Preferences</h1>
          <p className="text-sm text-gray-600 mt-1">
            Customize how you want to be notified about law changes
          </p>
        </div>

        <NotificationPreferences preferences={preferences} />
      </div>
    )
  })
}
```

**Notification Preferences Component:**

```typescript
// components/settings/notification-preferences.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface NotificationPreferencesProps {
  preferences: any
}

export function NotificationPreferences({ preferences }: NotificationPreferencesProps) {
  const [prefs, setPrefs] = useState(preferences)
  const [showWarning, setShowWarning] = useState<string | null>(null)
  const [isSaving, setIsSaving] = useState(false)
  const [showPreview, setShowPreview] = useState(false)
  const router = useRouter()

  async function handleToggle(key: string, value: boolean) {
    // Check if this is a critical setting
    const criticalSettings = ['emailDailyDigest', 'emailReminders', 'notifyAmendments']
    if (criticalSettings.includes(key) && !value) {
      setShowWarning(key)
      return
    }

    await updatePreference(key, value)
  }

  async function confirmDisable(key: string) {
    await updatePreference(key, false)
    setShowWarning(null)
  }

  async function updatePreference(key: string, value: any) {
    setIsSaving(true)
    try {
      const response = await fetch('/api/user/notification-preferences', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [key]: value })
      })

      if (response.ok) {
        const updated = await response.json()
        setPrefs(updated)
        router.refresh()
      }
    } catch (error) {
      console.error('Failed to update preferences:', error)
    } finally {
      setIsSaving(false)
    }
  }

  async function handlePreviewEmail() {
    setShowPreview(true)
    try {
      await fetch('/api/user/notification-preferences/preview-email', {
        method: 'POST'
      })
      alert('Preview email sent to your inbox!')
    } catch (error) {
      console.error('Failed to send preview email:', error)
      alert('Failed to send preview email')
    } finally {
      setShowPreview(false)
    }
  }

  return (
    <>
      <div className="bg-white rounded-lg shadow-sm border border-gray-200">
        {/* Email Preferences */}
        <div className="p-6 border-b border-gray-200">
          <h2 className="text-lg font-semibold mb-4">Email Notifications</h2>

          <div className="space-y-4">
            <ToggleRow
              label="Daily Digest"
              description="Receive a daily email with unacknowledged changes"
              checked={prefs.emailDailyDigest}
              onChange={(value) => handleToggle('emailDailyDigest', value)}
              disabled={isSaving}
            />

            <ToggleRow
              label="Weekly Digest"
              description="Receive a weekly email with industry updates and recommendations"
              checked={prefs.emailWeeklyDigest}
              onChange={(value) => handleToggle('emailWeeklyDigest', value)}
              disabled={isSaving}
            />

            <ToggleRow
              label="Reminders"
              description="Receive reminder emails for unacknowledged changes after 3 and 7 days"
              checked={prefs.emailReminders}
              onChange={(value) => handleToggle('emailReminders', value)}
              disabled={isSaving}
            />

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Email Frequency
              </label>
              <select
                value={prefs.emailFrequency}
                onChange={(e) => updatePreference('emailFrequency', e.target.value)}
                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                disabled={isSaving}
              >
                <option value="instant">Instant (as changes occur)</option>
                <option value="daily">Daily (8:00 AM)</option>
                <option value="weekly">Weekly (Sunday 6:00 PM)</option>
                <option value="off">Off (no emails)</option>
              </select>
            </div>

            <button
              onClick={handlePreviewEmail}
              disabled={showPreview || isSaving}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm disabled:bg-gray-300"
            >
              {showPreview ? 'Sending...' : 'Send Preview Email'}
            </button>
          </div>
        </div>

        {/* In-App Preferences */}
        <div className="p-6 border-b border-gray-200">
          <h2 className="text-lg font-semibold mb-4">In-App Notifications</h2>

          <div className="space-y-4">
            <ToggleRow
              label="Notification Bell"
              description="Show notification bell with unacknowledged change count"
              checked={prefs.inAppBell}
              onChange={(value) => handleToggle('inAppBell', value)}
              disabled={isSaving}
            />

            <ToggleRow
              label="Desktop Notifications"
              description="Show browser notifications when new changes are detected"
              checked={prefs.desktopPush}
              onChange={(value) => handleToggle('desktopPush', value)}
              disabled={isSaving}
            />
          </div>
        </div>

        {/* Change Type Filters */}
        <div className="p-6 border-b border-gray-200">
          <h2 className="text-lg font-semibold mb-4">Change Types</h2>
          <p className="text-sm text-gray-600 mb-4">
            Select which types of changes you want to be notified about
          </p>

          <div className="space-y-3">
            <CheckboxRow
              label="Amendments"
              description="Changes to existing law sections"
              checked={prefs.notifyAmendments}
              onChange={(value) => handleToggle('notifyAmendments', value)}
              disabled={isSaving}
            />

            <CheckboxRow
              label="New Sections"
              description="New sections added to laws"
              checked={prefs.notifyNewSections}
              onChange={(value) => handleToggle('notifyNewSections', value)}
              disabled={isSaving}
            />

            <CheckboxRow
              label="Repeals"
              description="Sections that have been removed"
              checked={prefs.notifyRepeals}
              onChange={(value) => handleToggle('notifyRepeals', value)}
              disabled={isSaving}
            />

            <CheckboxRow
              label="Metadata Changes"
              description="Minor updates like title changes or reference corrections"
              checked={prefs.notifyMetadata}
              onChange={(value) => handleToggle('notifyMetadata', value)}
              disabled={isSaving}
            />
          </div>
        </div>

        {/* Priority Filter */}
        <div className="p-6">
          <h2 className="text-lg font-semibold mb-4">Priority Filter</h2>
          <p className="text-sm text-gray-600 mb-4">
            Select which priority levels you want to be notified about
          </p>

          <div className="space-y-2">
            <RadioRow
              name="priorityFilter"
              value="high"
              label="High Priority Only"
              description="Only notify about high-priority changes"
              checked={prefs.priorityFilter === 'high'}
              onChange={() => updatePreference('priorityFilter', 'high')}
              disabled={isSaving}
            />

            <RadioRow
              name="priorityFilter"
              value="high_medium"
              label="High + Medium Priority"
              description="Notify about high and medium priority changes"
              checked={prefs.priorityFilter === 'high_medium'}
              onChange={() => updatePreference('priorityFilter', 'high_medium')}
              disabled={isSaving}
            />

            <RadioRow
              name="priorityFilter"
              value="all"
              label="All Priorities (Recommended)"
              description="Notify about all changes regardless of priority"
              checked={prefs.priorityFilter === 'all'}
              onChange={() => updatePreference('priorityFilter', 'all')}
              disabled={isSaving}
            />
          </div>
        </div>
      </div>

      {/* Warning Modal */}
      {showWarning && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg w-full max-w-md p-6">
            <h2 className="text-xl font-bold mb-4 text-red-600">⚠️ Varning</h2>
            <p className="text-sm text-gray-700 mb-6">
              {showWarning === 'emailDailyDigest' &&
                'Genom att stänga av daglig sammanfattning riskerar du att missa kritiska lagändringar. Du kommer fortfarande att kunna se ändringar i appen.'}
              {showWarning === 'emailReminders' &&
                'Genom att stänga av påminnelser riskerar du att missa kritiska lagändringar som kan påverka ditt företag.'}
              {showWarning === 'notifyAmendments' &&
                'Lagändringar är den vanligaste typen av ändring. Genom att stänga av dessa notifieringar kommer du att missa de flesta uppdateringar.'}
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowWarning(null)}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Avbryt
              </button>
              <button
                onClick={() => confirmDisable(showWarning)}
                className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
              >
                Fortsätt
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  )
}

// Helper components
function ToggleRow({ label, description, checked, onChange, disabled }: any) {
  return (
    <div className="flex items-center justify-between py-3">
      <div className="flex-1">
        <h4 className="font-medium text-gray-900">{label}</h4>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
      <label className="relative inline-flex items-center cursor-pointer ml-4">
        <input
          type="checkbox"
          checked={checked}
          onChange={(e) => onChange(e.target.checked)}
          disabled={disabled}
          className="sr-only peer"
        />
        <div className="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 peer-disabled:opacity-50"></div>
      </label>
    </div>
  )
}

function CheckboxRow({ label, description, checked, onChange, disabled }: any) {
  return (
    <label className="flex items-start gap-3 cursor-pointer py-2">
      <input
        type="checkbox"
        checked={checked}
        onChange={(e) => onChange(e.target.checked)}
        disabled={disabled}
        className="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 disabled:opacity-50"
      />
      <div className="flex-1">
        <h4 className="font-medium text-gray-900">{label}</h4>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
    </label>
  )
}

function RadioRow({ name, value, label, description, checked, onChange, disabled }: any) {
  return (
    <label className="flex items-start gap-3 cursor-pointer py-2">
      <input
        type="radio"
        name={name}
        value={value}
        checked={checked}
        onChange={onChange}
        disabled={disabled}
        className="mt-1 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 disabled:opacity-50"
      />
      <div className="flex-1">
        <h4 className="font-medium text-gray-900">{label}</h4>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
    </label>
  )
}
```

**API Endpoint for Updating Preferences:**

```typescript
// app/api/user/notification-preferences/route.ts
import { NextResponse } from 'next/server'
import { withAuth } from '@/lib/auth/with-auth'
import { prisma } from '@/lib/prisma'

export async function GET(request: Request) {
  return withAuth(async ({ userId }) => {
    let preferences = await prisma.userNotificationPreferences.findUnique({
      where: { userId },
    })

    if (!preferences) {
      preferences = await prisma.userNotificationPreferences.create({
        data: { userId },
      })
    }

    return NextResponse.json(preferences)
  })
}

export async function PATCH(request: Request) {
  return withAuth(async ({ userId }) => {
    const updates = await request.json()

    const preferences = await prisma.userNotificationPreferences.upsert({
      where: { userId },
      update: updates,
      create: {
        userId,
        ...updates,
      },
    })

    return NextResponse.json(preferences)
  })
}
```

**Preview Email Endpoint:**

```typescript
// app/api/user/notification-preferences/preview-email/route.ts
import { NextResponse } from 'next/server'
import { withAuth } from '@/lib/auth/with-auth'
import { sendEmail } from '@/lib/email/send-email'
import { DailyChangeDigest } from '@/emails/daily-change-digest'

export async function POST(request: Request) {
  return withAuth(async ({ userId }) => {
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { name: true, email: true },
    })

    if (!user) {
      return NextResponse.json({ error: 'User not found' }, { status: 404 })
    }

    // Send preview email with sample data
    await sendEmail({
      to: user.email,
      subject: '[PREVIEW] Lagändringar: 2 nya ändringar i din laglista',
      react: DailyChangeDigest({
        userName: user.name || 'där',
        workspaceName: 'Demo Workspace',
        changes: [
          {
            id: 'sample-1',
            priority: 'high',
            lawTitle: 'Arbetsmiljölagen',
            lawSfsNummer: 'SFS 1977:1160',
            aiSummary:
              'Detta är en exempeländring för att visa hur mejlet ser ut.',
            businessImpact: 'Åtgärd krävs senast 2025-03-01',
            diffUrl: 'https://laglig.se',
            officialUrl: 'https://riksdagen.se',
          },
        ],
        unsubscribeUrl: 'https://laglig.se/settings/notifications',
      }),
    })

    return NextResponse.json({ success: true })
  })
}
```

**Update Email Cron Jobs to Check Preferences:**

```typescript
// app/api/cron/send-daily-change-digest/route.ts (excerpt)

// Before sending email, check preferences
const preferences = await prisma.userNotificationPreferences.findUnique({
  where: { userId: workspace.owner.id }
})

// Skip if disabled
if (preferences && !preferences.emailDailyDigest) {
  skipped++
  continue
}

// Filter changes by type preferences
const filteredChanges = changes.filter((change) => {
  if (change.changeType === 'amendment' && preferences && !preferences.notifyAmendments) return false
  if (change.changeType === 'new_section' && preferences && !preferences.notifyNewSections) return false
  if (change.changeType === 'repeal' && preferences && !preferences.notifyRepeals) return false
  if (change.changeType === 'metadata' && preferences && !preferences.notifyMetadata) return false

  // Priority filter
  if (preferences && preferences.priorityFilter === 'high' && change.priority !== 'high') return false
  if (preferences && preferences.priorityFilter === 'high_medium' && change.priority === 'low') return false

  return true
})

// Skip if no changes after filtering
if (filteredChanges.length === 0) {
  skipped++
  continue
}

// Send email with filtered changes
await sendEmail({ ... })
```

**Handle Unsubscribe Links:**

```typescript
// app/settings/notifications/page.tsx (add query param handling)

export default async function NotificationsSettingsPage({
  searchParams
}: {
  searchParams: { unsubscribe?: string }
}) {
  return withAuth(async ({ userId }) => {
    let preferences = await prisma.userNotificationPreferences.findUnique({
      where: { userId }
    })

    if (!preferences) {
      preferences = await prisma.userNotificationPreferences.create({
        data: { userId }
      })
    }

    // Handle unsubscribe
    if (searchParams.unsubscribe) {
      const key = searchParams.unsubscribe
      const updateData: any = {}

      if (key === 'daily_digest') updateData.emailDailyDigest = false
      if (key === 'weekly_digest') updateData.emailWeeklyDigest = false
      if (key === 'reminders') updateData.emailReminders = false

      preferences = await prisma.userNotificationPreferences.update({
        where: { userId },
        data: updateData
      })
    }

    return (
      <div className="max-w-3xl mx-auto p-6">
        {searchParams.unsubscribe && (
          <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p className="text-sm text-green-800">
              ✓ You have been unsubscribed from {searchParams.unsubscribe.replace('_', ' ')}.
            </p>
          </div>
        )}

        {/* Rest of component */}
      </div>
    )
  })
}
```

**Reference:** PRD Epic 8 Story 8.11

## Testing

**Unit Tests:**

- Toggle switches update preferences correctly
- Warning modal appears for critical settings
- Preview email sends successfully
- Checkboxes for change types work
- Radio buttons for priority filter work

**Integration Tests:**

- Preferences saved to database
- Email cron jobs check preferences before sending
- Notification bell hides if disabled
- Filtered changes respect type and priority preferences
- Unsubscribe links update preferences correctly

**Manual Testing:**

- Toggle daily digest off, verify no emails received
- Toggle notification bell off, verify bell hidden in header
- Select "High Priority Only", verify only high-priority emails received
- Uncheck "Amendments", verify no amendment notifications
- Click "Send Preview Email", verify received in inbox
- Click unsubscribe link from email, verify redirected to settings

**Warning Modal Testing:**

- Disable daily digest, verify warning modal appears
- Disable reminders, verify warning modal appears
- Disable amendments, verify warning modal appears
- Click "Cancel", verify preference not changed
- Click "Continue", verify preference disabled

**Edge Cases:**

- New user with no preferences (create defaults)
- User disables all notifications (allowed but warned)
- User re-enables notifications (works correctly)
- Invalid unsubscribe parameter (ignored gracefully)

**Test File:** `__tests__/features/settings/notification-preferences.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Configure notification preferences according to workflow
- Understand risk of disabling critical notifications
- Test preferences with preview email
- Re-enable notifications if missing important updates

**Developer Responsibility:**

- Provide granular control over notification settings
- Show warning modals for disabling critical settings
- Respect user preferences in all notification channels
- Filter changes by type and priority preferences
- Provide preview email functionality for testing
- Handle unsubscribe links from emails
- Store preferences per user (not workspace-wide)
- Set sensible defaults (all enabled except desktop)
- Make UI clear and intuitive
- Update notification bell visibility based on preferences
- Document what each preference does clearly

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
