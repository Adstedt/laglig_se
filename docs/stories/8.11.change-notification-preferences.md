# Story 8.11: Implement Change Notification Preferences

## Status

Draft (v2 — rewritten to align with actual NotificationPreference model and workspace-scoped preferences)

## Story

**As a** workspace member,
**I want** to customize which law change notifications I receive and how,
**so that** I get relevant alerts without being overwhelmed.

## Context & Dependencies

**Builds on:**

- `NotificationPreference` model — existing per-workspace, per-user preferences with channel toggles and per-type toggles
- `NotificationType` enum — existing types (TASK_ASSIGNED, TASK_DUE_SOON, etc.) plus LAW_CHANGE (added by Story 8.5)
- `Notification` model — in-app notifications with read_at tracking
- Stories 8.4, 8.5, 8.6, 8.7 — all notification consumers that check preferences before sending

**Depends on:**

- Story 8.4 (daily email digest references NotificationPreference)
- Story 8.5 (notification bell references NotificationPreference)

**Key insight:** The `NotificationPreference` model is **per-workspace, per-user** (unique on `[user_id, workspace_id]`), not global per-user. This is correct — a user may want different notification settings for different workspaces. The v1 story proposed a fictional `UserNotificationPreferences` with wrong fields. This story extends the existing model with law-change-specific toggles.

**What already exists on NotificationPreference:**

- `email_enabled` — global email channel toggle
- `push_enabled` — global push channel toggle
- `task_assigned_enabled`, `task_due_soon_enabled`, `task_overdue_enabled` — task toggles
- `comment_added_enabled`, `mention_enabled`, `status_changed_enabled` — collaboration toggles
- `weekly_digest_enabled` — weekly digest toggle

**What needs to be added (schema migration):**

- `law_change_enabled` — master toggle for all law change notifications
- `amendment_daily_digest_enabled` — Story 8.4 daily email
- `amendment_reminder_enabled` — Story 8.6 reminder emails
- `amendment_weekly_digest_enabled` — Story 8.7 weekly industry digest
- `change_type_filter` — JSON array of ChangeType values to receive (default: all)
- `priority_filter` — minimum priority level: 'all' | 'high_medium' | 'high'

## Acceptance Criteria

### Preferences UI

1. Workspace Settings → "Notifieringar" tab showing per-user preferences for the current workspace
2. **Section: "Lagaendringar"** (new section alongside existing task/collaboration toggles):
   - Master toggle: "Lagaendringsnotifieringar" (law_change_enabled)
   - Daily digest: "Daglig sammanfattning av aendringar" (amendment_daily_digest_enabled)
   - Reminders: "Paminnelser foer olaesta aendringar" (amendment_reminder_enabled)
   - Weekly digest: "Veckovis branschoeversikt" (amendment_weekly_digest_enabled)
3. **Section: "Aendringstyper"** — checkboxes for which ChangeTypes to receive:
   - Amendments (AMENDMENT) — default ON
   - New laws (NEW_LAW) — default ON
   - Repeals (REPEAL) — default ON
   - Metadata changes (METADATA_UPDATE) — default OFF
   - New rulings (NEW_RULING) — default ON
4. **Section: "Kanaler"** (existing):
   - Email toggle (email_enabled) — already exists
   - Push toggle (push_enabled) — already exists, controls in-app bell

### Warning on Critical Disable

5. AlertDialog when disabling `law_change_enabled`: "Om du staenger av lagaendringsnotifieringar riskerar du att missa viktiga aendringar. Vill du fortsaetta?"
6. AlertDialog when disabling `amendment_daily_digest_enabled` with text explaining impact

### Server Actions

7. Server action `updateNotificationPreferences` with Zod validation
8. Upsert pattern: create default preferences if none exist for workspace+user
9. ActivityLog entry when preferences changed

### Consumer Integration

10. Story 8.4 daily digest cron checks `amendment_daily_digest_enabled` AND `email_enabled` AND `law_change_enabled`
11. Story 8.5 notification bell checks `law_change_enabled` AND `push_enabled`
12. Story 8.6 reminder cron checks `amendment_reminder_enabled` AND `email_enabled` AND `law_change_enabled`
13. Story 8.7 weekly digest cron checks `amendment_weekly_digest_enabled` AND `email_enabled`
14. All consumers filter by `change_type_filter` when set

### Email Unsubscribe

15. Unsubscribe links in all law change emails → workspace notification preferences page
16. Quick-unsubscribe: URL param `?unsubscribe=amendment_daily_digest` auto-disables that toggle
17. Sonner toast confirmation: "Daglig sammanfattning har staengts av"

## Tasks / Subtasks

- [ ] **Task 1: Schema migration — add law change preference fields** (AC: 2, 3)
  - [ ] Add `law_change_enabled`, `amendment_daily_digest_enabled`, `amendment_reminder_enabled`, `amendment_weekly_digest_enabled` Boolean fields (default true)
  - [ ] Add `change_type_filter` Json? field (default null = all types)
  - [ ] Add `priority_filter` String field (default "all")
  - [ ] Run migration
- [ ] **Task 2: Build preferences UI — law change section** (AC: 1, 2, 3, 4)
  - [ ] Add "Lagaendringar" section to workspace notification preferences page
  - [ ] shadcn/ui Switch for each toggle
  - [ ] shadcn/ui Checkbox for change type filters
  - [ ] Master toggle disables sub-toggles when OFF
- [ ] **Task 3: Warning dialogs** (AC: 5, 6)
  - [ ] shadcn/ui AlertDialog for critical setting disable
  - [ ] Swedish-language warning text
- [ ] **Task 4: Server action for preferences update** (AC: 7, 8, 9)
  - [ ] Zod schema for preference updates
  - [ ] Upsert pattern with workspace_id + user_id
  - [ ] ActivityLog entry on change
- [ ] **Task 5: Update notification consumers** (AC: 10, 11, 12, 13, 14)
  - [ ] Add preference checks to Stories 8.4, 8.5, 8.6, 8.7 query logic
  - [ ] Filter by change_type_filter
  - [ ] Helper: `shouldNotifyUser(userId, workspaceId, notificationType)` utility
- [ ] **Task 6: Email unsubscribe handling** (AC: 15, 16, 17)
  - [ ] Add unsubscribe URL to all law change emails
  - [ ] Handle `?unsubscribe=` query param on preferences page
  - [ ] Sonner toast confirmation

## Dev Notes

### Source Tree (relevant files)

```
prisma/schema.prisma                         — NotificationPreference model, NotificationType enum
app/[workspace]/settings/                    — Workspace settings pages (where preferences UI lives)
lib/email/cron-notifications.ts              — Email infrastructure (consumers of preferences)
```

### Key Data Models

```
NotificationPreference (existing, to be extended)
  ├─ user_id + workspace_id (unique compound key)
  ├─ email_enabled: Boolean (existing channel toggle)
  ├─ push_enabled: Boolean (existing channel toggle)
  ├─ law_change_enabled: Boolean (NEW — master toggle)
  ├─ amendment_daily_digest_enabled: Boolean (NEW)
  ├─ amendment_reminder_enabled: Boolean (NEW)
  ├─ amendment_weekly_digest_enabled: Boolean (NEW)
  ├─ change_type_filter: Json? (NEW — null = all, or ["AMENDMENT", "REPEAL"])
  └─ priority_filter: String (NEW — "all" | "high_medium" | "high")

Consumer preference check flow:
  Cron job (e.g., 8.4 daily digest)
    → Find workspaces with relevant ChangeEvents
      → For each workspace member:
        → Load NotificationPreference for (user_id, workspace_id)
        → Check: law_change_enabled AND amendment_daily_digest_enabled AND email_enabled
        → Filter ChangeEvents by change_type_filter
        → Send email (or skip)
```

### Helper Utility Pattern

```typescript
// lib/notifications/preference-check.ts
export async function shouldSendLawChangeEmail(
  userId: string,
  workspaceId: string,
  emailType: 'daily_digest' | 'reminder' | 'weekly_digest',
  changeTypes?: ChangeType[]
): Promise<boolean> {
  const pref = await prisma.notificationPreference.findUnique({
    where: { user_id_workspace_id: { user_id: userId, workspace_id: workspaceId } }
  })

  if (!pref) return true // Default: all enabled

  if (!pref.email_enabled || !pref.law_change_enabled) return false

  if (emailType === 'daily_digest' && !pref.amendment_daily_digest_enabled) return false
  if (emailType === 'reminder' && !pref.amendment_reminder_enabled) return false
  if (emailType === 'weekly_digest' && !pref.amendment_weekly_digest_enabled) return false

  // Check change type filter if provided
  if (changeTypes && pref.change_type_filter) {
    const allowedTypes = pref.change_type_filter as string[]
    if (!changeTypes.some(ct => allowedTypes.includes(ct))) return false
  }

  return true
}
```

### UI Standards

- shadcn/ui Switch, Checkbox, AlertDialog, Separator, Card
- Server component for data fetching, client component for interactive toggles
- Server actions for mutations (not API routes)
- Sonner for toast notifications on save

## Testing

**Test location:** `tests/unit/lib/notifications/preference-check.test.ts`

**Test framework:** Vitest

**Unit tests:**
- `shouldSendLawChangeEmail` returns true when all toggles enabled
- Returns false when `law_change_enabled` is false
- Returns false when `email_enabled` is false
- Returns false when specific email type disabled (e.g., `amendment_daily_digest_enabled = false`)
- `change_type_filter` correctly filters ChangeTypes
- Returns true when no preference record exists (default = all enabled)
- Upsert creates default preferences for new workspace+user

**Integration tests:**
- Preferences page loads with current settings
- Toggle saves and persists on refresh
- Warning dialog appears for critical settings
- Unsubscribe URL param auto-disables correct toggle
- Cron jobs respect updated preferences

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with actual NotificationPreference model (per-workspace), extend for law change toggles, remove fictional UserNotificationPreferences | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
