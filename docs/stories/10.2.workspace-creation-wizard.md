# Story 10.2: Workspace Creation Wizard

## Status

Draft

## Story

**As a** new user without a workspace,
**I want** to set up my company workspace through a guided multi-step form,
**so that** I can start using the platform with my company's context.

**Dependency:** Requires Story 10.1 (Post-Auth Workspace Guard & Onboarding Routing) — Done. Story 10.1 establishes the `/onboarding` route, layout with auth guard, and redirect logic that this story builds upon.

## Acceptance Criteria

**Wizard Structure:**

1. Multi-step wizard at `/onboarding` with a visual step indicator showing current step and total steps (Step 1 av 2, Step 2 av 2)
2. Wizard architecture supports inserting additional steps in the future (e.g., law list generator between company info and confirmation) without structural changes to the wizard container or step management logic
3. Form state persists between steps — navigating back/forward does not lose entered data
4. All user-facing text is in Swedish

**Step 1 - Företagsinformation (Company Info):**

5. Form fields:
   - Företagsnamn (company name) — required, 1-100 characters
   - Organisationsnummer — required, format validated (XXXXXX-XXXX Swedish org number)
   - Gatuadress (street address) — optional
   - Postnummer (postal code) — optional, format validated (XXX XX)
   - Ort (city) — optional
   - Bransch / SNI-kod — optional, text input (dropdown with common codes deferred)
   - Juridisk form — optional, dropdown with options: AB, HB, KB, EF, Ideell förening, Stiftelse, Övrigt
   - Antal anställda — optional, numeric input
6. "Nästa" button advances to Step 2
7. Form validation runs on submit attempt — errors shown inline in Swedish
8. Org number validation: regex `/^\d{6}-?\d{4}$/` with error message "Ogiltigt format. Ange XXXXXX-XXXX"

**Step 2 - Bekräfta & Skapa (Review & Confirm):**

9. Displays summary of all entered company info in a readable card layout
10. Shows "Din 14-dagars provperiod börjar nu" messaging with trial end date
11. "Tillbaka" button returns to Step 1 with form data preserved
12. "Skapa workspace" CTA button triggers workspace creation

**Workspace Creation:**

13. On submit: creates Workspace (TRIAL tier, 14-day trial) + CompanyProfile + WorkspaceMember (OWNER role) in a single Prisma transaction
14. Sets `active_workspace_id` cookie after successful creation
15. Invalidates user's workspace context cache in Redis
16. Redirects to `/dashboard` on success, or to the URL in `?redirect=` query parameter if present (from Story 10.1). The redirect URL must be validated as a relative path (starts with `/`) to prevent open redirect attacks
17. If org number already exists in database, show error: "Detta organisationsnummer är redan registrerat"

**UX & Quality:**

18. Loading state on "Skapa workspace" button during submission — button disabled, shows spinner and "Skapar workspace..."
19. Server errors show a toast notification with "Ett fel uppstod. Försök igen."
20. Responsive design — wizard works on mobile (320px) and desktop (1280px+)
21. Keyboard navigation works correctly through all form elements

## Tasks / Subtasks

- [ ] **Task 0: Run CompanyProfile schema migration** (AC: 13)
  - [ ] The schema at `prisma/schema.prisma:129-142` already has `sni_code`, `legal_form`, and `employee_count` as optional (`String?`, `String?`, `Int?`)
  - [ ] Run `pnpm prisma migrate dev --name make-company-profile-fields-optional` to create and apply the migration
  - [ ] Run `pnpm prisma generate` to update the Prisma client types
  - [ ] This is required because the wizard form treats these fields as optional — without this migration, the database columns may still have NOT NULL constraints from an earlier state

- [ ] **Task 1: Mount Toaster and build wizard container** (AC: 1, 2, 3, 19)
  - [ ] Modify `app/onboarding/page.tsx` — keep as Server Component, read `searchParams` (`redirect`, `state`), export page metadata, render the wizard client component + `<Toaster />`
  - [ ] Pass `redirect` and `state` as props to the wizard: `<OnboardingWizard redirect={redirect} state={state} />`
  - [ ] Follow the Server Component + Client Component split pattern from Story 6.21: `page.tsx` exports metadata (Server Component), renders the `'use client'` wizard component
  - [ ] Keep existing metadata: `title: 'Skapa workspace | Laglig.se'`, `description: 'Skapa din workspace för att komma igång'`
  - [ ] **Mount `<Toaster />` from `@/components/ui/sonner`** in the page to enable toast notifications (it is NOT currently mounted in any layout). Import: `import { Toaster } from '@/components/ui/sonner'` and render `<Toaster position="top-right" richColors />` alongside the wizard component (props match `workspace-shell.tsx:59` for consistency)
  - [ ] Create `app/onboarding/_components/onboarding-wizard.tsx` — `'use client'` component managing wizard state
  - [ ] Import `useRouter` from `next/navigation` for client-side redirect after creation
  - [ ] Implement step management with `useState` for `currentStep` (number) and `formData` (object holding all field values across steps)
  - [ ] Define steps array: `[{ id: 'company-info', component: CompanyInfoStep }, { id: 'confirm', component: ConfirmStep }]` — future steps can be inserted into this array before the confirm step
  - [ ] Create `app/onboarding/_components/wizard-stepper.tsx` — visual step indicator component showing step numbers with labels (e.g., "Steg 1 av 2")

- [ ] **Task 2: Build Step 1 - Company Info form** (AC: 4, 5, 6, 7, 8)
  - [ ] Create `app/onboarding/_components/company-info-step.tsx` — `'use client'` component
  - [ ] Use React Hook Form with Zod resolver for validation (pattern from `components/features/workspace/create-workspace-modal.tsx:50-57`). Note: `@hookform/resolvers` is already installed (v5.2.2 in `package.json:34`) — no additional dependency needed
  - [ ] Create Zod schema `WorkspaceOnboardingSchema` in `lib/validation/workspace.ts` (Swedish error messages following pattern from `lib/validation/auth.ts`):
    ```typescript
    export const WorkspaceOnboardingSchema = z.object({
      companyName: z
        .string()
        .min(1, 'Företagsnamn krävs')
        .max(100, 'Max 100 tecken'),
      orgNumber: z
        .string()
        .regex(/^\d{6}-?\d{4}$/, 'Ogiltigt format. Ange XXXXXX-XXXX'),
      streetAddress: z.string().optional(),
      postalCode: z
        .string()
        .regex(/^\d{3}\s?\d{2}$/, 'Ogiltigt format. Ange XXX XX')
        .optional()
        .or(z.literal('')),
      city: z.string().optional(),
      sniCode: z.string().optional(),
      legalForm: z
        .enum(['AB', 'HB', 'KB', 'EF', 'IDEELL', 'STIFTELSE', 'OVRIGT', ''])
        .optional(),
      employeeCount: z.preprocess(
        (val) => (val === '' || val === undefined ? undefined : val),
        z.coerce.number().int().min(0).optional()
      ),
    })
    ```
  - [ ] Use shadcn/ui components: `Input`, `Label`, `Select`, `Button`
  - [ ] Heading: `<h2 className="font-safiro text-2xl font-semibold tracking-tight">Företagsinformation</h2>`
  - [ ] Use `text-muted-foreground` for field descriptions and helper text
  - [ ] All labels and placeholders in Swedish
  - [ ] "Nästa" button validates form, on success calls `onNext(data)` callback to advance wizard

- [ ] **Task 3: Build Step 2 - Review & Confirm** (AC: 9, 10, 11, 12)
  - [ ] Create `app/onboarding/_components/confirm-step.tsx` — `'use client'` component
  - [ ] Heading: `<h2 className="font-safiro text-2xl font-semibold tracking-tight">Bekräfta & Skapa</h2>`
  - [ ] Display all entered data in a summary card using `dl`/`dt`/`dd` or a simple key-value layout. Use `text-muted-foreground` for labels, `text-foreground` for values
  - [ ] Show trial info: "Din 14-dagars provperiod börjar nu" with calculated end date (today + 14 days, formatted as YYYY-MM-DD). Use `bg-emerald-50 text-emerald-800` for the trial info callout
  - [ ] "Tillbaka" button: `<Button variant="outline" onClick={onBack}>Tillbaka</Button>`
  - [ ] "Skapa workspace" CTA button with brand glow: `<Button className="w-full shadow-lg shadow-primary/25 hover:shadow-xl hover:shadow-primary/30">Skapa workspace</Button>`

- [ ] **Task 4: Extend createWorkspace server action** (AC: 13, 14, 15, 16, 17)
  - [ ] In `app/actions/workspace.ts`, modify `createWorkspace()` (lines 55-132) to read additional optional fields from FormData: `orgNumber`, `streetAddress`, `postalCode`, `city`, `sniCode`, `legalForm`, `employeeCount`
  - [ ] **Schema strategy for backwards compatibility:** Keep the existing `createWorkspaceSchema` (lines 26-28) validating only `name`. Read the new fields via `formData.get()` and validate them conditionally — only process them if they're present. This ensures `CreateWorkspaceModal` (`components/features/workspace/create-workspace-modal.tsx`) which only sends `name` continues to work unchanged
  - [ ] Note: `createWorkspaceAndRedirect()` exists at lines 138-149 — it wraps `createWorkspace()` and redirects. The wizard does NOT use it — it calls `createWorkspace()` directly and handles redirect client-side via `router.push()`. Do not modify `createWorkspaceAndRedirect()`
  - [ ] Inside the Prisma transaction (lines 95-117), extend the workspace create to include:
    - `org_number` on Workspace (if provided, normalized to XXXXXX-XXXX format) — field at `schema.prisma:65`
    - `company_legal_name` on Workspace (same as company name) — field at `schema.prisma:66`
    - `sni_code` on Workspace (if provided) — field at `schema.prisma:67`
  - [ ] Inside the same transaction, conditionally create a `CompanyProfile` if any company fields beyond name are provided:
    - `company_name`: required (same as workspace name) — field at `schema.prisma:132`
    - `sni_code`: optional — field at `schema.prisma:133`
    - `legal_form`: optional — field at `schema.prisma:134`
    - `employee_count`: optional — field at `schema.prisma:135`
    - `address`: concatenate street + postal + city into single string (e.g., "Storgatan 1, 123 45 Stockholm") or `null` if none provided — field at `schema.prisma:136`
  - [ ] Handle unique constraint violation on `org_number` — catch Prisma error P2002 and return `{ success: false, error: 'Detta organisationsnummer är redan registrerat' }`
  - [ ] After transaction: `setActiveWorkspace(workspaceId)` (line 120) and `invalidateUserCache()` (line 123) calls remain as-is
  - [ ] **Redirect URL validation:** When the wizard passes a redirect URL, validate it starts with `/` before using it. Reject absolute URLs to prevent open redirect attacks

- [ ] **Task 5: Wire up form submission and redirect** (AC: 16, 18, 19)
  - [ ] In `onboarding-wizard.tsx`, call `createWorkspace()` server action on confirm step submit
  - [ ] Build `FormData` from the wizard's accumulated form state, appending all fields
  - [ ] Show loading state: disable button, show Lucide `LoaderCircle` spinner icon with `animate-spin` + "Skapar workspace..."
  - [ ] On success: validate the redirect URL (must start with `/` or be empty), then `router.push(validatedRedirectUrl || '/dashboard')`
  - [ ] On error: call `toast.error()` from `sonner` with the server action's error message, or fallback "Ett fel uppstod. Försök igen."
  - [ ] For duplicate org number error specifically: show the error inline on the confirm step (not just a toast) and keep the user on Step 2 — display a `<Button variant="link" onClick={() => setCurrentStep(0)}>Ändra organisationsnummer</Button>` link to navigate back to Step 1

- [ ] **Task 6: Handle deleted workspace state** (AC: from Story 10.1)
  - [ ] If `?state=deleted` query param is present, show a message above the wizard: "Ditt tidigare workspace har raderats. Skapa ett nytt för att fortsätta."
  - [ ] Use shadcn/ui `Alert` component with info variant

- [ ] **Task 7: Responsive and accessibility verification** (AC: 20, 21)
  - [ ] Verify wizard renders correctly at 320px and 1280px+
  - [ ] Verify tab order through all form fields and buttons
  - [ ] Verify focus rings on all interactive elements
  - [ ] Verify error messages are associated with inputs via `aria-describedby`
  - [ ] Verify toast notifications appear and are readable

## Dev Notes

### Previous Story Insights

**From Story 10.1 (Post-Auth Workspace Guard & Onboarding Routing) — Done:**

- The onboarding layout at `app/onboarding/layout.tsx` (lines 1-64) already handles authentication (`getCurrentUser()` → redirect to `/login` if null) and workspace check (redirect to `/dashboard` if workspace exists, unless workspace is DELETED). The wizard page does NOT need to re-check these.
- Query params `?redirect=` and `?state=` are established by the workspace layout guard in Story 10.1. The wizard page receives these via `searchParams` prop (typed as `Promise<{ redirect?: string; state?: string }>` per Next.js 16 pattern — see `app/onboarding/page.tsx:12`).
- The layout replicates the auth layout brand styling: `bg-section-warm` background, logo, `Card` with `animate-fade-up rounded-xl bg-card p-8 shadow-lg` (layout line 58). The wizard renders INSIDE this Card — it should not add its own Card wrapper.
- The layout uses `max-w-md` container width (layout line 45). All wizard content must fit within this width constraint.
- **`middleware.ts` was deleted during 10.1** — Next.js 16 uses `proxy.ts` convention. The `x-pathname` header logic was merged into `proxy.ts` `handleAuthAndRouting()`. Do NOT create a `middleware.ts` file.
- **`getSafeRedirectUrl()`** already exists at `lib/utils.ts:13` (added during Story 10.1, used by `app/select-workspace/`). Import it from `@/lib/utils` for the wizard's redirect handling — do NOT redefine it.
- 19 pre-existing failing tests (redis, caching, auth signup) — zero new failures introduced by 10.1. Do not be alarmed if these tests fail during development.

**From Story 6.21 (Auth Pages Brand Refresh) — design patterns:**

- Pages with `'use client'` forms must be split: Server Component `page.tsx` exports metadata, renders a Client Component (underscore-prefixed `_components/` directory). This is because `metadata` cannot be exported from `'use client'` components in Next.js.
- Color tokens use CSS variables — NEVER hardcode hex values. Use semantic tokens: `primary`, `destructive`, `muted-foreground`, `card`, etc.

### Architecture Sources

- **Server Actions**: Mutations use server actions in `app/actions/` — return `{ success: boolean, error?: string }` pattern. Never throw from server actions [Source: architecture/17-coding-standards.md#17.5]
- **Forms**: React Hook Form 7.51+ with Zod 3.22+ resolver. shadcn/ui form components [Source: architecture/3-tech-stack.md#3.1]
- **Database**: Prisma transactions for multi-table operations. Workspace isolation on all queries [Source: architecture/17-coding-standards.md#17.4]
- **Caching**: Redis cache invalidation via `invalidateUserCache(userId, ['context'])` from `@/lib/cache/workspace-cache` after workspace mutations [Source: app/actions/workspace.ts:123]
- **Component Standards**: shadcn/ui mandatory. Tailwind for styling. No hardcoded hex values [Source: architecture/17-coding-standards.md#17.3]
- **Toast**: `Toaster` component from `@/components/ui/sonner` (wraps the `sonner` library). Must be mounted in the component tree for `toast()` calls to work. Use `import { toast } from 'sonner'` for imperative calls [Source: components/ui/sonner.tsx]
- **Validation pattern**: Swedish Zod error messages, see `lib/validation/auth.ts` for patterns (e.g., `'Ogiltig e-postadress'`, `'Lösenordet måste vara minst 12 tecken'`) [Source: lib/validation/auth.ts]

### Brand Styling Reference

The wizard renders inside the onboarding layout's Card (from Story 10.1), so it inherits the warm background and card styling. For content within the wizard, apply these patterns:

- **Headings**: `font-safiro text-2xl font-semibold tracking-tight` — Safiro font for primary headings, defined in `globals.css`
- **Secondary text**: `text-muted-foreground` for descriptions, helper text, form labels
- **CTA buttons**: `shadow-lg shadow-primary/25 hover:shadow-xl hover:shadow-primary/30` — brand glow effect from Story 6.21
- **Outline buttons**: `<Button variant="outline">` for secondary actions (Tillbaka)
- **Error states**: `bg-destructive/10 text-destructive` for inline error displays (see `create-workspace-modal.tsx:114`)
- **Success states**: `bg-emerald-50 text-emerald-800` for positive info callouts (trial messaging)
- **Color tokens**: Use CSS variable-based semantic colors — `primary`, `destructive`, `muted`, `muted-foreground`, `card-foreground`, etc. NEVER hardcode hex values like `text-gray-900` or `bg-blue-600`
- **Icons**: Lucide Icons only — `import { LoaderCircle, ... } from 'lucide-react'` [Source: architecture/3-tech-stack.md#3.1]

### Relevant Source Tree

```
app/onboarding/
  layout.tsx                          # FROM STORY 10.1: Auth-only layout with brand styling (DO NOT MODIFY)
                                      #   Line 19: getCurrentUser() auth check
                                      #   Line 26-41: Workspace existence check → redirect /dashboard
                                      #   Line 44-63: Brand styling wrapper (bg-section-warm, Card with animate-fade-up)
                                      #   Line 45: max-w-md container width
  page.tsx                            # MODIFY: Replace placeholder with wizard, read query params, mount Toaster
                                      #   Line 4-7: Metadata export (keep as-is)
                                      #   Line 9-12: Server Component props with searchParams: Promise<...>
                                      #   Line 14: Await searchParams to access state/redirect params
  _components/
    onboarding-wizard.tsx             # NEW: 'use client' wizard container, step management, form state
    wizard-stepper.tsx                # NEW: Visual step indicator (Steg 1 av 2)
    company-info-step.tsx             # NEW: 'use client' form with React Hook Form + Zod
    confirm-step.tsx                  # NEW: 'use client' review card + submit button

lib/validation/
  workspace.ts                       # NEW: WorkspaceOnboardingSchema Zod schema
  auth.ts                            # REFERENCE: Pattern for Swedish Zod error messages (lines 1-41)

app/actions/
  workspace.ts                       # MODIFY: Extend createWorkspace() with company profile fields
    - Lines 26-28: createWorkspaceSchema — validates only 'name'. Keep as-is for backwards compat
    - Lines 37-49: generateSlug() helper — reuse as-is
    - Lines 55-132: createWorkspace() — accepts FormData, returns { success, error?, workspaceId? }
    - Lines 90-92: Trial end date calculation — reuse as-is
    - Lines 95-117: Prisma transaction (workspace + member) — extend with CompanyProfile + company fields
    - Line 120: setActiveWorkspace() call — keep as-is
    - Line 123: invalidateUserCache() call — keep as-is
    - Lines 138-149: createWorkspaceAndRedirect() — DO NOT MODIFY, wizard does not use this

prisma/schema.prisma
    - Lines 57-101: Workspace model — has org_number (String? @unique, line 65), company_legal_name (String?, line 66), sni_code (String?, line 67)
    - Lines 129-142: CompanyProfile model — company_name (String, line 132), sni_code (String?, line 133), legal_form (String?, line 134), employee_count (Int?, line 135), address (String?, line 136)
    - NOTE: sni_code, legal_form, employee_count, address are already optional in the schema

components/features/workspace/
  create-workspace-modal.tsx          # NO CHANGE: Verify backwards compatibility — only sends 'name' in FormData
                                      #   Lines 59-84: onSubmit builds FormData with only 'name' field
                                      #   Uses createWorkspace() from app/actions/workspace (line 26)

components/ui/
  sonner.tsx                         # EXISTING: Toaster component (wraps sonner). Must be mounted for toasts to work
                                      #   Lines 1-42: 'use client', exports Toaster with Lucide icons
  card.tsx                           # EXISTING: Card component (used by onboarding layout)
  button.tsx                         # EXISTING: Button component
  input.tsx                          # EXISTING: Input component
  label.tsx                          # EXISTING: Label component
  select.tsx                         # EXISTING: Select component
  alert.tsx                          # EXISTING: Alert component (for deleted workspace message)
```

### Key Implementation Details

1. **Wizard state management.** Use a single `useState<WizardData>` object in the wizard container to hold all form values across steps. Each step receives the current data and an `onNext(data)` / `onBack()` callback. This keeps steps decoupled and allows inserting future steps by just adding an entry to the steps array.

2. **Extending createWorkspace() safely.** The existing `CreateWorkspaceModal` (`components/features/workspace/create-workspace-modal.tsx:64-65`) only sends `name` in the FormData. The extended action reads new fields via `formData.get('orgNumber')` etc. — they will be `null` when not present (from the modal). The existing `createWorkspaceSchema` at lines 26-28 only validates `name` and is NOT extended. New fields are read and processed conditionally after the schema validation passes. Only create a `CompanyProfile` if company-specific fields are present. This ensures full backwards compatibility.

3. **CompanyProfile address field.** The Prisma schema has `address` as a single `String?` (`schema.prisma:136`). For now, concatenate street address + postal code + city into this field (e.g., "Storgatan 1, 123 45 Stockholm"). When Bolagsverket integration comes (Story 4.2), the schema will be migrated to structured address fields.

4. **Org number normalization.** Before saving, normalize the org number to include the hyphen (XXXXXX-XXXX format). If user enters without hyphen, insert it: `orgNumber.replace(/^(\d{6})(\d{4})$/, '$1-$2')`.

5. **Prisma error P2002** is thrown on unique constraint violations. Catch specifically:

   ```typescript
   if (
     error instanceof Prisma.PrismaClientKnownRequestError &&
     error.code === 'P2002'
   ) {
     const target = error.meta?.target as string[]
     if (target?.includes('org_number')) {
       return {
         success: false,
         error: 'Detta organisationsnummer är redan registrerat',
       }
     }
   }
   ```

6. **Future extensibility.** The wizard steps array pattern:

   ```typescript
   const WIZARD_STEPS = [
     { id: 'company-info', component: CompanyInfoStep },
     // Future: { id: 'law-list', component: LawListGeneratorStep },
     { id: 'confirm', component: ConfirmStep },
   ]
   ```

   The confirm step should always be last. New steps insert before it.

7. **Redirect URL security.** Before using `?redirect=` for post-creation navigation, validate:

   ```typescript
   function getSafeRedirectUrl(redirect: string | undefined): string {
     if (!redirect) return '/dashboard'
     // Only allow relative paths — prevent open redirect
     if (redirect.startsWith('/') && !redirect.startsWith('//')) return redirect
     return '/dashboard'
   }
   ```

8. **Duplicate org number UX.** When the server action returns the duplicate org number error, the user stays on Step 2 (confirm step). The error is shown inline (not just as a toast) with a link to navigate back to Step 1 to edit the org number. This avoids losing the user's other form data.

9. **Next.js 16 searchParams.** In Next.js 16 (App Router), `searchParams` is a `Promise` in Server Components. The existing `app/onboarding/page.tsx:12` already types this correctly. Use `await searchParams` to access query parameters.

10. **Toaster mounting.** The `<Toaster />` from `@/components/ui/sonner` is NOT mounted in the root layout or in the onboarding layout. It must be mounted in `page.tsx` alongside the wizard component for `toast()` calls to work. Since `Toaster` is a `'use client'` component, it can be directly rendered in a Server Component.

### Coding Standards

- `'use client'` only on interactive components (wizard, form steps) — page.tsx stays Server Component [Source: architecture/17-coding-standards.md#17.3]
- React Hook Form with Zod resolver for all form validation [Source: architecture/3-tech-stack.md#3.1]
- shadcn/ui components: `Input`, `Label`, `Button`, `Select`, `Card`, `Alert` [Source: architecture/17-coding-standards.md#17.3]
- Import path aliases: `@/components/ui/button`, `@/lib/validation/workspace`, `@/app/actions/workspace` [Source: architecture/12-unified-project-structure.md#12.5]
- TypeScript strict mode — all props interfaces explicitly typed [Source: architecture/17-coding-standards.md#17.2]
- Error handling: return `{ success, error }` from server actions, never throw [Source: architecture/17-coding-standards.md#17.5]
- Use theme color tokens (CSS variables), NEVER hardcode hex values [Source: Story 6.21]
- All user-facing text in Swedish [Source: Story 6.21]
- Lucide Icons for any iconography [Source: architecture/3-tech-stack.md#3.1]

### Testing

- **Test approach**: Manual testing of the full wizard flow plus backwards compatibility verification
- **Critical flows to verify**:
  1. Fill Step 1 → Nästa → Review in Step 2 → Tillbaka → data preserved → Nästa → Skapa → workspace created → redirect to dashboard
  2. Step 1 validation: empty company name, invalid org number format, invalid postal code → inline Swedish errors
  3. Duplicate org number → error shown inline on Step 2 with link to go back and edit
  4. Existing `CreateWorkspaceModal` still works (only sends name, no company profile fields — no CompanyProfile created)
  5. After creation: workspace context loads correctly, dashboard renders, workspace appears in switcher
  6. Mobile layout: form usable on 320px screen
  7. Toast notification appears on generic server error (disconnect network, try to submit)
  8. Redirect URL validation: `?redirect=/laws` works, `?redirect=https://evil.com` is rejected (redirects to `/dashboard`)
- **Test file location (if unit tests added)**: `tests/unit/app/onboarding/` for components, `tests/integration/actions/workspace.test.ts` for action
- **Testing framework**: Vitest + React Testing Library [Source: architecture/3-tech-stack.md#3.1]
- **Responsive**: Verify at 320px mobile and 1280px+ desktop
- **Pre-existing failures**: 19 tests fail before this story (redis, caching, auth signup) — zero new failures expected

## Change Log

| Date       | Version | Description                                                                                                                                                                                               | Author     |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2026-01-31 | 1.0     | Full re-draft incorporating Story 10.1 completion context, verified source line numbers, accurate architecture references, Next.js 16 patterns, proxy.ts note                                             | Bob (SM)   |
| 2026-01-31 | 1.1     | PO validation fixes: Zod employeeCount empty-string preprocess, explicit redirect/state prop passing, Toaster props consistency (position="top-right" richColors), @hookform/resolvers pre-installed note | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled by development agent_

### Debug Log References

_To be filled by development agent_

### Completion Notes List

_To be filled by development agent_

### File List

_To be filled by development agent_

## QA Results

_To be filled by QA agent_
