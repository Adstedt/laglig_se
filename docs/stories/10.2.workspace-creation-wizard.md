# Story 10.2: Workspace Creation Wizard

## Status

Draft

## Story

**As a** new user without a workspace,
**I want** to set up my company workspace through a guided multi-step form,
**so that** I can start using the platform with my company's context.

## Acceptance Criteria

**Wizard Structure:**

1. Multi-step wizard at `/onboarding` with a visual step indicator showing current step and total steps (Step 1 av 2, Step 2 av 2)
2. Wizard architecture supports inserting additional steps in the future (e.g., law list generator between company info and confirmation) without structural changes to the wizard container or step management logic
3. Form state persists between steps — navigating back/forward does not lose entered data
4. All user-facing text is in Swedish

**Step 1 - Företagsinformation (Company Info):**

5. Form fields:
   - Företagsnamn (company name) — required, 1-100 characters
   - Organisationsnummer — required, format validated (XXXXXX-XXXX Swedish org number)
   - Gatuadress (street address) — optional
   - Postnummer (postal code) — optional, format validated (XXX XX)
   - Ort (city) — optional
   - Bransch / SNI-kod — optional, text input (dropdown with common codes deferred)
   - Juridisk form — optional, dropdown with options: AB, HB, KB, EF, Ideell förening, Stiftelse, Övrigt
   - Antal anställda — optional, numeric input
6. "Nästa" button advances to Step 2
7. Form validation runs on submit attempt — errors shown inline in Swedish
8. Org number validation: regex `/^\d{6}-?\d{4}$/` with error message "Ogiltigt format. Ange XXXXXX-XXXX"

**Step 2 - Bekräfta & Skapa (Review & Confirm):**

9. Displays summary of all entered company info in a readable card layout
10. Shows "Din 14-dagars provperiod börjar nu" messaging with trial end date
11. "Tillbaka" button returns to Step 1 with form data preserved
12. "Skapa workspace" CTA button triggers workspace creation

**Workspace Creation:**

13. On submit: creates Workspace (TRIAL tier, 14-day trial) + CompanyProfile + WorkspaceMember (OWNER role) in a single Prisma transaction
14. Sets `active_workspace_id` cookie after successful creation
15. Invalidates user's workspace context cache in Redis
16. Redirects to `/dashboard` on success, or to the URL in `?redirect=` query parameter if present (from Story 10.1)
17. If org number already exists in database, show error: "Detta organisationsnummer är redan registrerat"

**UX & Quality:**

18. Loading state on "Skapa workspace" button during submission — button disabled, shows spinner and "Skapar workspace..."
19. Server errors show a toast notification with "Ett fel uppstod. Försök igen."
20. Responsive design — wizard works on mobile (320px) and desktop (1280px+)
21. Keyboard navigation works correctly through all form elements

## Tasks / Subtasks

- [ ] **Task 1: Build wizard container with step management** (AC: 1, 2, 3)
  - [ ] Create `app/onboarding/page.tsx` — Server Component that reads query params (`redirect`, `state`) and renders the wizard client component
  - [ ] Create `app/onboarding/_components/onboarding-wizard.tsx` — `'use client'` component managing wizard state
  - [ ] Implement step management with `useState` for `currentStep` (number) and `formData` (object holding all field values across steps)
  - [ ] Define steps array: `[{ id: 'company-info', title: 'Företagsinformation' }, { id: 'confirm', title: 'Bekräfta & Skapa' }]` — future steps can be inserted into this array
  - [ ] Create `app/onboarding/_components/wizard-stepper.tsx` — visual step indicator component showing step dots/numbers with labels

- [ ] **Task 2: Build Step 1 - Company Info form** (AC: 4, 5, 6, 7, 8)
  - [ ] Create `app/onboarding/_components/company-info-step.tsx` — client component
  - [ ] Use React Hook Form with Zod resolver for validation
  - [ ] Create Zod schema `WorkspaceOnboardingSchema` in `lib/validation/workspace.ts`:
    ```typescript
    const WorkspaceOnboardingSchema = z.object({
      companyName: z
        .string()
        .min(1, 'Företagsnamn krävs')
        .max(100, 'Max 100 tecken'),
      orgNumber: z
        .string()
        .regex(/^\d{6}-?\d{4}$/, 'Ogiltigt format. Ange XXXXXX-XXXX'),
      streetAddress: z.string().optional(),
      postalCode: z
        .string()
        .regex(/^\d{3}\s?\d{2}$/, 'Ogiltigt format. Ange XXX XX')
        .optional()
        .or(z.literal('')),
      city: z.string().optional(),
      sniCode: z.string().optional(),
      legalForm: z
        .enum(['AB', 'HB', 'KB', 'EF', 'IDEELL', 'STIFTELSE', 'OVRIGT', ''])
        .optional(),
      employeeCount: z.coerce.number().int().min(0).optional(),
    })
    ```
  - [ ] Use shadcn/ui components: `Input`, `Label`, `Select`, `Button`
  - [ ] All labels and placeholders in Swedish
  - [ ] "Nästa" button validates form, on success calls `onNext(data)` callback to advance wizard

- [ ] **Task 3: Build Step 2 - Review & Confirm** (AC: 9, 10, 11, 12)
  - [ ] Create `app/onboarding/_components/confirm-step.tsx` — client component
  - [ ] Display all entered data in a summary card using `dl`/`dt`/`dd` or a simple key-value layout
  - [ ] Show trial info: "Din 14-dagars provperiod börjar nu" with calculated end date (today + 14 days, formatted as YYYY-MM-DD)
  - [ ] "Tillbaka" button calls `onBack()` callback to return to Step 1
  - [ ] "Skapa workspace" CTA button calls the server action

- [ ] **Task 4: Extend createWorkspace server action** (AC: 13, 14, 15, 17)
  - [ ] In `app/actions/workspace.ts`, modify `createWorkspace()` to accept additional fields: `orgNumber`, `streetAddress`, `postalCode`, `city`, `sniCode`, `legalForm`, `employeeCount`
  - [ ] Keep the existing `FormData` interface — add new fields as optional so existing callers (CreateWorkspaceModal) are not broken
  - [ ] Inside the Prisma transaction, add:
    - Set `org_number` on Workspace (if provided)
    - Set `company_legal_name` on Workspace (same as company name)
    - Set `sni_code` on Workspace (if provided)
    - Create `CompanyProfile` record with: `company_name`, `sni_code`, `legal_form`, `employee_count`, `address` (concatenate street + postal + city into single string for now)
  - [ ] Handle unique constraint violation on `org_number` — catch Prisma error P2002 and return `{ success: false, error: 'Detta organisationsnummer är redan registrerat' }`
  - [ ] After transaction: call `setActiveWorkspace(workspaceId)`, call `invalidateUserCache()` for the user

- [ ] **Task 5: Wire up form submission and redirect** (AC: 16, 18, 19)
  - [ ] In `onboarding-wizard.tsx`, call `createWorkspace()` server action on confirm step submit
  - [ ] Show loading state: disable button, show spinner icon + "Skapar workspace..."
  - [ ] On success: `router.push(redirectUrl || '/dashboard')`
  - [ ] On error: show toast via shadcn/ui `toast()` — "Ett fel uppstod. Försök igen." or the specific error message from the server action
  - [ ] For duplicate org number error, show inline on the confirm step with a link back to Step 1 to edit

- [ ] **Task 6: Handle deleted workspace state** (AC: from Story 10.1)
  - [ ] If `?state=deleted` query param is present, show a message above the wizard: "Ditt tidigare workspace har raderats. Skapa ett nytt för att fortsätta."
  - [ ] Use shadcn/ui `Alert` component with info variant

- [ ] **Task 7: Responsive and accessibility verification** (AC: 20, 21)
  - [ ] Verify wizard renders correctly at 320px and 1280px+
  - [ ] Verify tab order through all form fields and buttons
  - [ ] Verify focus rings on all interactive elements
  - [ ] Verify error messages are associated with inputs via `aria-describedby`

## Dev Notes

### Architecture Sources

- **Server Actions**: Mutations use server actions in `app/actions/` — return `{ success: boolean, error?: string }` pattern [Source: architecture/17-coding-standards.md#17.3]
- **Forms**: React Hook Form 7.51+ with Zod 3.22+ resolver. shadcn/ui form components [Source: architecture/3-tech-stack.md#3.1]
- **Database**: Prisma transactions for multi-table operations. Workspace isolation on all queries [Source: architecture/17-coding-standards.md#17.4]
- **Caching**: Redis cache invalidation via `invalidateUserCache()` after workspace mutations [Source: lib/auth/workspace-context.ts]
- **Component Standards**: shadcn/ui mandatory. Tailwind for styling. No hardcoded hex values [Source: architecture/17-coding-standards.md#17.3]

### Relevant Source Tree

```
app/onboarding/
  layout.tsx                          # FROM STORY 10.1: Auth-only layout with brand styling
  page.tsx                            # MODIFY: Replace placeholder with wizard, read query params
  _components/
    onboarding-wizard.tsx             # NEW: 'use client' wizard container, step management, form state
    wizard-stepper.tsx                # NEW: Visual step indicator (Step 1 av 2)
    company-info-step.tsx             # NEW: 'use client' form with React Hook Form + Zod
    confirm-step.tsx                  # NEW: 'use client' review card + submit button

lib/validation/
  workspace.ts                       # NEW: WorkspaceOnboardingSchema Zod schema
  auth.ts                            # REFERENCE: Pattern for Swedish Zod error messages

app/actions/
  workspace.ts                       # MODIFY: Extend createWorkspace() with company profile fields
    - Line 55-132: Current createWorkspace() — accepts FormData with just 'name'
    - Line 79-86: Slug generation logic — reuse as-is
    - Line 88-92: Trial end date calculation — reuse as-is
    - Line 94-119: Transaction (workspace + member creation) — extend with CompanyProfile
    - Line 120: setActiveWorkspace() call — keep as-is
    - Line 121-124: Cache invalidation — keep as-is

prisma/schema.prisma
    - Lines 57-101: Workspace model — has org_number (unique, optional), company_legal_name, sni_code
    - Lines 129-142: CompanyProfile model — has company_name, sni_code, legal_form, employee_count, address

components/features/workspace/
  create-workspace-modal.tsx          # NO CHANGE: Verify backwards compatibility — only sends 'name'

app/(auth)/layout.tsx                 # REFERENCE: Brand styling pattern (bg-section-warm, Card, logo)
```

### Key Implementation Details

1. **Wizard state management.** Use a single `useState<WizardData>` object in the wizard container to hold all form values across steps. Each step receives the current data and an `onNext(data)` / `onBack()` callback. This keeps steps decoupled and allows inserting future steps by just adding an entry to the steps array.

2. **Extending createWorkspace() safely.** The existing `CreateWorkspaceModal` only sends `name` in the FormData. The extended action must treat all new fields as optional — only set them on the Workspace/CompanyProfile if they're present. Test that the modal still works after changes.

3. **CompanyProfile address field.** The current Prisma schema has `address` as a single `String?`. For now, concatenate street address + postal code + city into this field (e.g., "Storgatan 1, 123 45 Stockholm"). When Bolagsverket integration comes (Story 4.2), the schema will be migrated to structured address fields.

4. **Org number normalization.** Before saving, normalize the org number to include the hyphen (XXXXXX-XXXX format). If user enters without hyphen, insert it: `orgNumber.replace(/^(\d{6})(\d{4})$/, '$1-$2')`.

5. **Prisma error P2002** is thrown on unique constraint violations. Catch specifically:

   ```typescript
   if (
     error instanceof Prisma.PrismaClientKnownRequestError &&
     error.code === 'P2002'
   ) {
     const target = error.meta?.target as string[]
     if (target?.includes('org_number')) {
       return {
         success: false,
         error: 'Detta organisationsnummer är redan registrerat',
       }
     }
   }
   ```

6. **Future extensibility.** The wizard steps array pattern:
   ```typescript
   const WIZARD_STEPS = [
     { id: 'company-info', component: CompanyInfoStep },
     // Future: { id: 'law-list', component: LawListGeneratorStep },
     { id: 'confirm', component: ConfirmStep },
   ]
   ```
   The confirm step should always be last. New steps insert before it.

### Coding Standards

- `'use client'` only on interactive components (wizard, form steps) — page.tsx stays Server Component [Source: architecture/17-coding-standards.md#17.3]
- React Hook Form with Zod resolver for all form validation [Source: architecture/3-tech-stack.md#3.1]
- shadcn/ui components: `Input`, `Label`, `Button`, `Select`, `Card`, `Alert` [Source: architecture/17-coding-standards.md#17.3]
- Import path aliases: `@/components/ui/button`, `@/lib/validation/workspace`, `@/app/actions/workspace` [Source: architecture/12-unified-project-structure.md#12.5]
- TypeScript strict mode — all props interfaces explicitly typed [Source: architecture/17-coding-standards.md#17.2]
- Error handling: return `{ success, error }` from server actions, never throw [Source: architecture/17-coding-standards.md#17.5]

### Testing

- **Test approach**: Manual testing of the full wizard flow plus backwards compatibility verification
- **Critical flows to verify**:
  1. Fill Step 1 → Nästa → Review in Step 2 → Tillbaka → data preserved → Nästa → Skapa → workspace created → redirect to dashboard
  2. Step 1 validation: empty company name, invalid org number format, invalid postal code → inline Swedish errors
  3. Duplicate org number → clear error message after submission
  4. Existing `CreateWorkspaceModal` still works (only sends name, no company profile fields)
  5. After creation: workspace context loads correctly, dashboard renders, workspace appears in switcher
  6. Mobile layout: form usable on 320px screen
- **Test file location (if unit tests added)**: `tests/unit/app/onboarding/` for components, `tests/integration/actions/workspace.test.ts` for action
- **Testing framework**: Vitest + React Testing Library [Source: architecture/17-coding-standards.md]

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-01-30 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled by development agent_

### Debug Log References

_To be filled by development agent_

### Completion Notes List

_To be filled by development agent_

### File List

_To be filled by development agent_

## QA Results

_To be filled by QA agent_
