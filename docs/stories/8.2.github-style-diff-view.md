# Story 8.2: Implement GitHub-Style Diff View

## Status

Draft

## Story

**As a** user,
**I want** to see exactly what changed in a law,
**so that** I understand the impact.

## Acceptance Criteria

1. Clicking "View Details" on change card opens diff modal
2. **Diff view shows:**
   - Law title, SFS number
   - Change type, detected date
   - **Side-by-side comparison:** Old version | New version (GitHub-style)
   - **Changed sections highlighted:** Red background for removed text, green for added
   - Line numbers for reference
   - **Contextual explanation:** "§ 26 was modified - this section handles X"
3. **AI summary at top** (2-3 sentences in plain Swedish):
   - "Summary: Sick pay procedure references updated to align with new Försäkringskassan guidelines"
   - "Impact: Low - Administrative reference update, no action required"
4. "Mark as Reviewed" button in modal
5. **"View Full Law" link** → Opens individual law page
6. **Link to official source:** "Riksdagen PDF" link
7. Mobile: Stack old/new versions vertically instead of side-by-side
8. Diff library: Use `diff` npm package or similar

## Tasks / Subtasks

- [ ] Create diff modal component
- [ ] Install and integrate diff library (diff or diff2html)
- [ ] Build side-by-side comparison view
- [ ] Implement syntax highlighting for changes
- [ ] Add contextual explanation for changed sections
- [ ] Display AI summary at top of modal
- [ ] Add "Mark as Reviewed" button
- [ ] Add links to full law and official source
- [ ] Make mobile-responsive (vertical stacking)
- [ ] Test with various diff scenarios
- [ ] Test keyboard navigation (ESC to close)

## Dev Notes

**Install Diff Library:**

```bash
npm install diff
npm install @types/diff --save-dev
# Or use react-diff-viewer for pre-built component
npm install react-diff-viewer-continued
```

**Diff Modal Component:**

```typescript
// components/laws/diff-modal.tsx
'use client'

import { useEffect } from 'react'
import { useRouter } from 'next/navigation'
import ReactDiffViewer from 'react-diff-viewer-continued'

interface DiffModalProps {
  change: any
  isOpen: boolean
  onClose: () => void
}

export function DiffModal({ change, isOpen, onClose }: DiffModalProps) {
  const router = useRouter()

  useEffect(() => {
    function handleEsc(e: KeyboardEvent) {
      if (e.key === 'Escape') onClose()
    }
    window.addEventListener('keydown', handleEsc)
    return () => window.removeEventListener('keydown', handleEsc)
  }, [onClose])

  async function handleMarkAsReviewed() {
    const response = await fetch(`/api/law-changes/${change.id}/acknowledge`, {
      method: 'POST'
    })

    if (response.ok) {
      onClose()
      router.refresh()
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg w-full max-w-7xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
          <div className="flex items-start justify-between">
            <div className="flex-1">
              <h2 className="text-xl font-bold text-gray-900">
                {change.law.sfsNummer}: {change.law.rubrik}
              </h2>
              <div className="flex items-center gap-3 mt-2">
                <span className="text-sm text-gray-600">
                  Detected {new Date(change.detectedAt).toLocaleDateString('sv-SE')}
                </span>
                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  {change.changeType}
                </span>
              </div>
            </div>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        {/* AI Summary Section */}
        <div className="p-6 border-b border-gray-200 bg-blue-50">
          <h3 className="font-semibold text-blue-900 mb-2">Summary</h3>
          <p className="text-sm text-blue-800 mb-3">{change.aiSummary}</p>
          <p className="text-sm text-blue-900">
            <span className="font-semibold">Impact:</span> {change.businessImpact}
          </p>
        </div>

        {/* Contextual Explanation */}
        {change.contextualExplanation && (
          <div className="p-4 bg-yellow-50 border-b border-yellow-200">
            <p className="text-sm text-yellow-900">
              <span className="font-semibold">Context:</span> {change.contextualExplanation}
            </p>
          </div>
        )}

        {/* Diff View */}
        <div className="p-6">
          <h3 className="font-semibold text-gray-900 mb-4">Changes</h3>

          {/* Desktop: Side-by-side */}
          <div className="hidden md:block">
            <ReactDiffViewer
              oldValue={change.oldContent}
              newValue={change.newContent}
              splitView={true}
              useDarkTheme={false}
              leftTitle="Previous Version"
              rightTitle="New Version"
              styles={{
                variables: {
                  light: {
                    diffViewerBackground: '#fff',
                    addedBackground: '#e6ffec',
                    addedColor: '#24292e',
                    removedBackground: '#ffeef0',
                    removedColor: '#24292e',
                    wordAddedBackground: '#acf2bd',
                    wordRemovedBackground: '#fdb8c0',
                    addedGutterBackground: '#cdffd8',
                    removedGutterBackground: '#ffdce0',
                    gutterBackground: '#f6f8fa',
                    gutterBackgroundDark: '#f3f4f6',
                    highlightBackground: '#fffbdd',
                    highlightGutterBackground: '#fff5b1',
                  }
                },
                line: {
                  padding: '10px 2px',
                  fontSize: '14px',
                  lineHeight: '1.6'
                }
              }}
            />
          </div>

          {/* Mobile: Stacked */}
          <div className="md:hidden space-y-6">
            <div>
              <h4 className="font-medium text-gray-900 mb-2">Previous Version</h4>
              <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                <pre className="text-sm text-gray-900 whitespace-pre-wrap">{change.oldContent}</pre>
              </div>
            </div>
            <div>
              <h4 className="font-medium text-gray-900 mb-2">New Version</h4>
              <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                <pre className="text-sm text-gray-900 whitespace-pre-wrap">{change.newContent}</pre>
              </div>
            </div>
          </div>
        </div>

        {/* Footer with Actions */}
        <div className="sticky bottom-0 bg-white border-t border-gray-200 p-6 flex flex-wrap gap-3">
          <button
            onClick={handleMarkAsReviewed}
            className="flex-1 min-w-[200px] px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Mark as Reviewed
          </button>
          <a
            href={`/laws/${change.lawId}`}
            target="_blank"
            className="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-center"
          >
            View Full Law
          </a>
          <a
            href={change.officialSourceUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-center"
          >
            Riksdagen PDF ↗
          </a>
        </div>
      </div>
    </div>
  )
}
```

**Diff View Page (Alternative to Modal):**

```typescript
// app/laws/[lawId]/changes/[changeId]/page.tsx
import { notFound } from 'next/navigation'
import { prisma } from '@/lib/prisma'
import { DiffView } from '@/components/laws/diff-view'

interface PageProps {
  params: { lawId: string; changeId: string }
}

export default async function LawChangeDiffPage({ params }: PageProps) {
  const change = await prisma.lawChange.findUnique({
    where: { id: params.changeId },
    include: {
      law: {
        select: {
          id: true,
          sfsNummer: true,
          rubrik: true
        }
      }
    }
  })

  if (!change) {
    notFound()
  }

  return (
    <div className="max-w-7xl mx-auto p-6">
      <DiffView change={change} />
    </div>
  )
}
```

**Custom Diff Rendering (Alternative):**

```typescript
// lib/diff/render-diff.ts
import * as Diff from 'diff'

export interface DiffLine {
  type: 'added' | 'removed' | 'unchanged'
  content: string
  lineNumber: { old?: number; new?: number }
}

export function generateDiff(oldText: string, newText: string): DiffLine[] {
  const changes = Diff.diffLines(oldText, newText)
  const lines: DiffLine[] = []
  let oldLineNum = 1
  let newLineNum = 1

  for (const change of changes) {
    const content = change.value
    const lineCount = content.split('\n').length - 1

    if (change.added) {
      for (let i = 0; i < lineCount; i++) {
        lines.push({
          type: 'added',
          content: content.split('\n')[i],
          lineNumber: { new: newLineNum++ },
        })
      }
    } else if (change.removed) {
      for (let i = 0; i < lineCount; i++) {
        lines.push({
          type: 'removed',
          content: content.split('\n')[i],
          lineNumber: { old: oldLineNum++ },
        })
      }
    } else {
      for (let i = 0; i < lineCount; i++) {
        lines.push({
          type: 'unchanged',
          content: content.split('\n')[i],
          lineNumber: { old: oldLineNum++, new: newLineNum++ },
        })
      }
    }
  }

  return lines
}
```

**Custom Diff Component:**

```typescript
// components/laws/custom-diff-view.tsx
import { generateDiff, DiffLine } from '@/lib/diff/render-diff'

interface CustomDiffViewProps {
  oldContent: string
  newContent: string
}

export function CustomDiffView({ oldContent, newContent }: CustomDiffViewProps) {
  const diffLines = generateDiff(oldContent, newContent)

  return (
    <div className="border border-gray-300 rounded-lg overflow-hidden">
      <table className="w-full text-sm font-mono">
        <thead className="bg-gray-50 border-b border-gray-300">
          <tr>
            <th className="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">Old</th>
            <th className="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">New</th>
            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500">Content</th>
          </tr>
        </thead>
        <tbody>
          {diffLines.map((line, index) => (
            <tr
              key={index}
              className={
                line.type === 'added'
                  ? 'bg-green-50'
                  : line.type === 'removed'
                  ? 'bg-red-50'
                  : 'bg-white'
              }
            >
              <td className="px-2 py-1 text-gray-500 text-right border-r border-gray-200">
                {line.lineNumber.old || ''}
              </td>
              <td className="px-2 py-1 text-gray-500 text-right border-r border-gray-200">
                {line.lineNumber.new || ''}
              </td>
              <td className="px-4 py-1">
                <span
                  className={
                    line.type === 'added'
                      ? 'bg-green-200'
                      : line.type === 'removed'
                      ? 'bg-red-200'
                      : ''
                  }
                >
                  {line.type === 'added' && '+ '}
                  {line.type === 'removed' && '- '}
                  {line.content}
                </span>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}
```

**Contextual Explanation Generator:**

```typescript
// lib/law-changes/generate-contextual-explanation.ts
import OpenAI from 'openai'

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

export async function generateContextualExplanation(
  sectionNumber: string,
  sectionContent: string,
  lawTitle: string
): Promise<string> {
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      {
        role: 'system',
        content: `You are an expert in Swedish law. Provide a brief explanation of what a specific section of a law handles, in Swedish.`,
      },
      {
        role: 'user',
        content: `Law: ${lawTitle}\nSection: ${sectionNumber}\nContent: ${sectionContent}\n\nExplain in one sentence what this section handles.`,
      },
    ],
    temperature: 0.3,
    max_tokens: 100,
  })

  return (
    response.choices[0].message.content ||
    'Denna paragraf hanterar specifika regler.'
  )
}
```

**Reference:** PRD Epic 8 Story 8.2, GitHub diff view design, react-diff-viewer documentation

## Testing

**Unit Tests:**

- Diff rendering displays added lines in green
- Diff rendering displays removed lines in red
- Unchanged lines display without highlighting
- Line numbers increment correctly

**Integration Tests:**

- Open diff modal from change card, verify displays correctly
- Click "Mark as Reviewed", verify modal closes and change removed from list
- Click "View Full Law", verify opens law page in new tab
- Click "Riksdagen PDF", verify opens official source
- Press ESC key, verify modal closes

**Manual Testing:**

- View diff with small change (1-2 lines), verify clear
- View diff with large change (50+ lines), verify scrollable
- View diff on mobile, verify stacks vertically
- Compare diff to Notisum's grey box, verify better UX
- Test with Swedish characters (å, ä, ö), verify renders correctly
- Test with legal notation (§, ändr., upph.), verify displays correctly

**Visual Regression Testing:**

- Diff highlighting matches GitHub style
- Side-by-side layout clean and readable
- Mobile stacked layout doesn't overflow
- Line numbers align correctly

**Performance Testing:**

- Diff rendering for 100-line change <500ms
- Modal opens smoothly (no lag)
- Scrolling diff view smooth (60fps)

**Accessibility Testing:**

- Keyboard navigation works (Tab, ESC)
- Screen reader announces change summary
- Color contrast meets WCAG AA (red/green backgrounds with sufficient contrast)

**Test File:** `__tests__/features/law-changes/diff-view.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Review diffs carefully to understand exact changes
- Use contextual explanation to grasp section purpose
- Mark as reviewed only after understanding impact
- Access official source if clarification needed

**Developer Responsibility:**

- Render diffs clearly with GitHub-style highlighting
- Provide side-by-side comparison for easy scanning
- Generate accurate contextual explanations for sections
- Ensure diff view works on mobile (vertical stacking)
- Handle large diffs gracefully (performance optimization)
- Link to official sources for transparency
- Make modal keyboard-accessible (ESC to close, Tab navigation)
- Provide clear AI summary at top of modal
- Optimize diff algorithm for Swedish legal text (handle special characters, formatting)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
