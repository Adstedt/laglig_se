# Story 8.2: Implement GitHub-Style Diff View

## Status

Draft (v2 — rewritten to align with actual data model and amendment pipeline)

## Story

**As a** workspace member reviewing a law change,
**I want** to see exactly what changed in a side-by-side diff view with AI-generated context,
**so that** I understand the specific impact of an amendment without reading raw legal text.

## Context & Dependencies

**Builds on:**

- Story 8.1 (Changes Tab) — "View Details" button navigates here
- `SectionChange` model — stores per-section diffs (chapter, section, change_type, old_text, new_text)
- `AmendmentDocument` — stores full parsed amendment text (markdown_content, full_text)
- `LegalDocument` (amendment) — stores summering + kommentar
- Story 12.3 content generation pipeline — provides summering/kommentar for AI context

**Depends on:**

- Story 8.1 (provides navigation entry point)
- Story 8.8 (ensures amendment LegalDocuments have summering + kommentar)

## Acceptance Criteria

1. Clicking "View Details" on a change card opens a diff page (not modal — full page for readability)
2. Diff page header shows:
   - Base law title + document number
   - Amendment SFS number + title
   - Change type badge, detected date
3. AI summary section at top:
   - Summering (neutral, 2-3 sentences from amendment LegalDocument.summary)
   - Kommentar (compliance-focused, "Vi ska..." from amendment LegalDocument.kommentar)
4. Section-level diff display using `SectionChange` records:
   - Each changed section shown as a diff card
   - Section identifier: "7 kap. 15 §" with change type badge (AMENDED/NEW/REPEALED/RENUMBERED)
   - Side-by-side comparison: old_text | new_text with GitHub-style highlighting (red removed, green added)
   - Line numbers for reference
5. Contextual help tooltips for Swedish legal notation:
   - "ändr." → "Ändrad bestämmelse"
   - "upph." → "Upphävd bestämmelse"
   - "nya" → "Ny bestämmelse"
6. "Mark as Reviewed" button (wired by Story 8.3)
7. "View Full Law" link → opens base law page (`/lagar/{slug}`)
8. "Riksdagen PDF" link → opens amendment's `source_url` or `AmendmentDocument.original_url`
9. Mobile: Stack old/new versions vertically instead of side-by-side on `<768px`

## Tasks / Subtasks

- [ ] **Task 1: Create diff page route** (AC: 1, 2)
  - [ ] Route: `app/(main)/lagar/[slug]/changes/[changeEventId]/page.tsx`
  - [ ] Server component: fetch ChangeEvent, base law LegalDocument, amendment LegalDocument, SectionChange records
- [ ] **Task 2: Build diff page header** (AC: 2, 3)
  - [ ] Display law + amendment identification
  - [ ] Summering + Kommentar section in highlighted card
- [ ] **Task 3: Build section-level diff view** (AC: 4, 5)
  - [ ] Iterate `SectionChange` records from `AmendmentDocument`
  - [ ] Render side-by-side diff for each section (old_text vs new_text)
  - [ ] Use `diff` npm library for word-level highlighting within sections
  - [ ] Add change_type badge per section (AMENDED, NEW, REPEALED, RENUMBERED)
  - [ ] Add legal notation tooltips
- [ ] **Task 4: Action buttons and links** (AC: 6, 7, 8)
  - [ ] "Mark as Reviewed" button placeholder (Story 8.3 wires)
  - [ ] "View Full Law" link to base law page
  - [ ] "Riksdagen PDF" external link
- [ ] **Task 5: Mobile responsive layout** (AC: 9)
  - [ ] Stack old/new vertically on mobile

## Dev Notes

### Source Tree (relevant files)

```
app/api/cron/sync-sfs-updates/route.ts     — Creates SectionChange records during PDF parsing
lib/sfs/amendment-llm-prompt.ts             — PDF parsing prompt (produces section data)
lib/transforms/html-to-json.ts              — Derives section structure from parsed HTML
prisma/schema.prisma                        — SectionChange, AmendmentDocument, ChangeEvent
```

### Key Data Models

```
SectionChange (from AmendmentDocument parsing)
  ├─ amendment_id → AmendmentDocument
  ├─ chapter: "7"
  ├─ section: "15"
  ├─ change_type: AMENDED | NEW | REPEALED | RENUMBERED
  ├─ old_text (previous section content, if available)
  ├─ new_text (new section content)
  ├─ description: "Ändrad lydelse"
  └─ sort_order

ChangeEvent
  ├─ document_id → LegalDocument (base law)
  ├─ amendment_sfs → links to AmendmentDocument.sfs_number
  └─ diff_summary (text summary of changes)

AmendmentDocument
  ├─ sfs_number, base_law_sfs
  ├─ original_url (Riksdagen PDF link)
  ├─ section_changes: SectionChange[]
  └─ parse_status: COMPLETED
```

### Query Pattern

```typescript
// Fetch all data for the diff page
const changeEvent = await prisma.changeEvent.findUnique({
  where: { id: changeEventId },
  include: { document: true }
})

const amendment = await prisma.amendmentDocument.findFirst({
  where: { sfs_number: changeEvent.amendment_sfs.replace('SFS ', '') },
  include: { section_changes: { orderBy: { sort_order: 'asc' } } }
})

const amendmentLegalDoc = await prisma.legalDocument.findFirst({
  where: { document_number: changeEvent.amendment_sfs, content_type: 'SFS_AMENDMENT' }
})
```

### Diff Rendering

Use `diff` npm package for word-level diff within each `SectionChange`:
- `old_text` vs `new_text` for AMENDED sections
- Only `new_text` (all green) for NEW sections
- Only `old_text` (all red) for REPEALED sections

### UI Standards

- shadcn/ui Card, Badge, Tooltip components
- Server component for data fetching
- Client component for diff rendering (needs `diff` library in browser)

## Testing

**Test location:** `tests/unit/components/laws/diff-view.test.tsx`

**Test framework:** Vitest with React Testing Library

**Unit tests:**
- Diff view renders section changes with correct highlighting
- AMENDED sections show side-by-side with red/green
- NEW sections show only green (new_text)
- REPEALED sections show only red (old_text)
- Legal notation tooltips display on hover
- Summering and Kommentar display from amendment LegalDocument

**Integration tests:**
- Full page loads with ChangeEvent → AmendmentDocument → SectionChange chain
- Links to base law page work correctly
- Riksdagen PDF link opens external URL

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with SectionChange model, AmendmentDocument, Claude not OpenAI | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
