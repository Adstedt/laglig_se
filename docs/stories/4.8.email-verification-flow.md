# Story 4.8: Build Email Verification Flow

## Status
Draft

## Story

**As a** new user,
**I want** to verify my email with a 6-digit code,
**so that** the system confirms my email is valid.

## Acceptance Criteria

1. After signup, 6-digit verification code sent via email (Resend or SendGrid)
2. Email template includes: code, company name, "Verify your email" CTA
3. Verification page displays: "Check your email for a 6-digit code"
4. Input field for 6-digit code
5. Client-side validation: Exactly 6 digits
6. Submit code → Backend validates → Account marked as verified
7. Redirect to Dashboard on success
8. Error handling: Invalid code, expired code (30-minute expiry)
9. "Resend code" option (max 3 resends per hour)
10. Email sent from no-reply@laglig.se with branded template

## Tasks / Subtasks

- [ ] Create verification page UI
- [ ] Build 6-digit code input component
- [ ] Create verification API endpoint
- [ ] Implement code expiry logic (30 minutes)
- [ ] Add resend code functionality with rate limiting
- [ ] Create branded email template
- [ ] Handle invalid/expired code errors
- [ ] Redirect to Dashboard on success
- [ ] Test with Resend email service

## Dev Notes

**Verification Page Component:**
```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'

export default function VerifyEmailPage() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const email = searchParams.get('email')

  const [code, setCode] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [resendCount, setResendCount] = useState(0)
  const [canResend, setCanResend] = useState(true)

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setError(null)

    if (code.length !== 6 || !/^\d{6}$/.test(code)) {
      setError('Ange en giltig 6-siffrig kod')
      return
    }

    setIsLoading(true)

    try {
      const response = await fetch('/api/auth/verify-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, code })
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message)
      }

      // Verification successful - redirect to dashboard
      router.push('/dashboard')
    } catch (error: any) {
      setError(error.message || 'Ogiltig eller utgången kod. Försök igen.')
    } finally {
      setIsLoading(false)
    }
  }

  async function handleResendCode() {
    if (resendCount >= 3) {
      setError('Maximalt antal försök uppnådda. Försök igen om en timme.')
      return
    }

    setCanResend(false)
    setError(null)

    try {
      const response = await fetch('/api/auth/resend-verification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message)
      }

      setResendCount((prev) => prev + 1)
      alert('En ny kod har skickats till din e-post')

      // Allow resend again after 60 seconds
      setTimeout(() => setCanResend(true), 60000)
    } catch (error: any) {
      setError(error.message || 'Kunde inte skicka ny kod. Försök igen.')
      setCanResend(true)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
            <svg
              className="w-8 h-8 text-blue-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
          </div>
          <h1 className="text-2xl font-bold text-gray-900 mb-2">
            Verifiera din e-post
          </h1>
          <p className="text-gray-600">
            Vi har skickat en 6-siffrig kod till
          </p>
          <p className="font-semibold text-gray-900">{email}</p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label
              htmlFor="code"
              className="block text-sm font-medium text-gray-700 mb-2"
            >
              Verifieringskod
            </label>
            <input
              type="text"
              id="code"
              value={code}
              onChange={(e) => {
                const value = e.target.value.replace(/\D/g, '').slice(0, 6)
                setCode(value)
              }}
              className="w-full px-4 py-3 text-center text-2xl font-mono border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="000000"
              maxLength={6}
              autoComplete="off"
              autoFocus
            />
            {error && <p className="mt-2 text-sm text-red-600">{error}</p>}
          </div>

          <button
            type="submit"
            disabled={isLoading || code.length !== 6}
            className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
          >
            {isLoading ? 'Verifierar...' : 'Verifiera e-post'}
          </button>
        </form>

        <div className="mt-6 text-center">
          <button
            onClick={handleResendCode}
            disabled={!canResend}
            className="text-sm text-blue-600 hover:underline disabled:text-gray-400 disabled:no-underline"
          >
            {canResend
              ? 'Skicka ny kod'
              : 'Vänta 60 sekunder innan du skickar igen'}
          </button>
          {resendCount > 0 && (
            <p className="text-xs text-gray-500 mt-2">
              {resendCount}/3 försök använda
            </p>
          )}
        </div>

        <p className="mt-6 text-xs text-center text-gray-500">
          Koden går ut om 30 minuter
        </p>
      </div>
    </div>
  )
}
```

**Verification API Endpoint:**
```typescript
// app/api/auth/verify-email/route.ts
export async function POST(request: Request) {
  const { email, code } = await request.json()

  // Find user by email
  const user = await prisma.user.findUnique({
    where: { email }
  })

  if (!user) {
    return NextResponse.json(
      { message: 'Användare hittades inte' },
      { status: 404 }
    )
  }

  // Find valid verification code
  const verificationCode = await prisma.verificationCode.findFirst({
    where: {
      userId: user.id,
      code,
      expiresAt: {
        gt: new Date()
      },
      usedAt: null
    }
  })

  if (!verificationCode) {
    return NextResponse.json(
      { message: 'Ogiltig eller utgången kod' },
      { status: 400 }
    )
  }

  // Mark code as used
  await prisma.verificationCode.update({
    where: { id: verificationCode.id },
    data: { usedAt: new Date() }
  })

  // Mark user as verified
  await prisma.user.update({
    where: { id: user.id },
    data: { emailVerified: true }
  })

  // Create session (using NextAuth or custom session)
  // ... session creation logic

  return NextResponse.json({
    success: true,
    message: 'E-post verifierad'
  })
}
```

**Resend Code API Endpoint:**
```typescript
// app/api/auth/resend-verification/route.ts
export async function POST(request: Request) {
  const { email } = await request.json()

  // Find user
  const user = await prisma.user.findUnique({
    where: { email }
  })

  if (!user) {
    return NextResponse.json(
      { message: 'Användare hittades inte' },
      { status: 404 }
    )
  }

  // Check rate limit: max 3 codes per hour
  const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000)
  const recentCodes = await prisma.verificationCode.count({
    where: {
      userId: user.id,
      createdAt: {
        gt: oneHourAgo
      }
    }
  })

  if (recentCodes >= 3) {
    return NextResponse.json(
      { message: 'För många försök. Försök igen om en timme.' },
      { status: 429 }
    )
  }

  // Generate new code
  const verificationCode = Math.floor(100000 + Math.random() * 900000).toString()

  // Store new code
  await prisma.verificationCode.create({
    data: {
      userId: user.id,
      code: verificationCode,
      expiresAt: new Date(Date.now() + 30 * 60 * 1000) // 30 minutes
    }
  })

  // Get company name for email
  const workspace = await prisma.workspace.findFirst({
    where: { ownerId: user.id },
    select: { name: true }
  })

  // Send email
  await sendVerificationEmail(email, verificationCode, workspace?.name || 'Laglig.se')

  return NextResponse.json({
    success: true,
    message: 'Ny kod har skickats'
  })
}
```

**Verification Email Template (React Email):**
```typescript
// components/emails/verification-email.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Heading,
  Button,
  Hr
} from '@react-email/components'

export function VerificationEmail({
  code,
  companyName
}: {
  code: string
  companyName: string
}) {
  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>Välkommen till Laglig.se!</Heading>

          <Text style={styles.text}>Hej {companyName},</Text>

          <Text style={styles.text}>
            Tack för att du registrerade dig för Laglig.se. Din 14-dagars
            gratisperiod har startat.
          </Text>

          <Text style={styles.text}>
            För att aktivera ditt konto, använd följande verifieringskod:
          </Text>

          <Section style={styles.codeSection}>
            <Text style={styles.code}>{code}</Text>
          </Section>

          <Text style={styles.smallText}>
            Denna kod går ut om 30 minuter.
          </Text>

          <Hr style={styles.hr} />

          <Text style={styles.smallText}>
            Om du inte registrerade dig för Laglig.se kan du ignorera detta
            e-postmeddelande.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

const styles = {
  body: {
    backgroundColor: '#f6f9fc',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
  },
  container: {
    margin: '0 auto',
    padding: '40px 20px',
    maxWidth: '600px'
  },
  heading: {
    fontSize: '24px',
    fontWeight: 'bold',
    color: '#1a202c',
    marginBottom: '20px'
  },
  text: {
    fontSize: '16px',
    color: '#4a5568',
    lineHeight: '1.6',
    marginBottom: '16px'
  },
  codeSection: {
    backgroundColor: '#fff',
    border: '2px dashed #cbd5e0',
    borderRadius: '8px',
    padding: '24px',
    textAlign: 'center' as const,
    margin: '24px 0'
  },
  code: {
    fontSize: '32px',
    fontWeight: 'bold',
    letterSpacing: '8px',
    color: '#2d3748',
    fontFamily: 'monospace'
  },
  smallText: {
    fontSize: '14px',
    color: '#718096',
    lineHeight: '1.5'
  },
  hr: {
    borderColor: '#e2e8f0',
    margin: '24px 0'
  }
}
```

**Database Schema:**
```prisma
model VerificationCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code])
  @@map("verification_codes")
}
```

**Reference:** PRD Epic 4 Story 4.6, Architecture Section 9 (Authentication), Resend email service documentation

## Testing

**Unit Tests:**
- Code input validates 6 digits only
- Expired codes rejected
- Invalid codes rejected
- Used codes cannot be reused
- Rate limiting works (max 3 resends per hour)

**Integration Tests:**
- Complete verification flow from signup to dashboard
- Email sent with correct 6-digit code
- Code expires after 30 minutes
- Resend code generates new code
- User marked as verified in database
- Session created after verification

**Manual Testing:**
- Test with valid code (redirects to dashboard)
- Test with invalid code (shows error)
- Test with expired code (shows error)
- Test resend code functionality
- Test rate limiting (3 resends max)
- Verify email template displays correctly
- Test on mobile devices

**Security Testing:**
- Codes expire after 30 minutes
- Used codes cannot be reused
- Rate limiting prevents abuse
- Email validation prevents enumeration

**Test File:** `__tests__/features/auth/email-verification.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**
- Check email for verification code
- Enter 6-digit code correctly
- Request new code if expired
- Complete verification within 30 minutes

**Developer Responsibility:**
- Send verification email immediately after signup
- Validate code format (6 digits)
- Enforce 30-minute expiry
- Implement rate limiting (max 3 resends per hour)
- Mark user as verified in database
- Create session after successful verification
- Handle edge cases (expired codes, invalid codes)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
