# Story 14.7: Agent Tool Definitions

## Status

Draft

## Story

As a compliance partner agent, I want well-defined tools to interact with the application, so that I can search laws, access company context, and take actions on behalf of the user.

## Context & Dependencies

Following Anthropic's "Building Effective Agents" guide, tools are the agent's interface to the app. Each tool needs comprehensive descriptions (same rigor as prompts), clear parameter schemas, and high-signal responses. Tools are split into read-only (run freely) and write (require user confirmation).

- **Builds on:** Epic 14 Phase 2 — ContentChunk model (14.2) provides the searchable vector store, WorkspaceProfile (14.4) provides company context
- **Depends on:** 14.2 (ContentChunk for search), 14.4 (WorkspaceProfile for company context)
- **Depended on by:** 14.8 (RAG pipeline uses search tools), 14.9 (system prompt references tools), 14.10 + 14.11 (UX uses tools)

## Acceptance Criteria

### Read-Only Tools

1. `search_laws` — semantic search across legal document chunks. Parameters: query (string), contentType (optional filter), limit (default 10). Returns: relevant passages with contextualHeader, documentNumber, similarity score
2. `get_document_details` — full content for a specific legal document. Parameters: documentId OR documentNumber. Returns: title, documentNumber, contentType, status, summary, kommentar, markdown_content (truncated to ~4000 tokens)
3. `get_change_details` — ChangeEvent details with amendment context. Parameters: changeEventId. Returns: changeType, amendment text, affected sections (from SectionChange), ai_summary, detected_at, base law info
4. `get_company_context` — WorkspaceProfile + compliance posture. Parameters: none (uses workspace from context). Returns: all profile fields, list of tracked law lists with item counts, recent assessment summary
5. `search_company_files` — semantic search across workspace file chunks. Parameters: query (string), limit (default 5). Returns: matching file passages with filename, documentCategory, similarity score
6. `get_compliance_history` — past assessments and actions for a specific law. Parameters: documentId. Returns: past ChangeAssessments, related tasks, compliance status timeline

### Write Tools

7. `create_task` — create a workspace task. Parameters: title (string), description (string), relatedDocumentId (optional), priority (optional). Returns: created task with ID. Requires user confirmation.
8. `update_compliance_status` — update a LawListItem's compliance status. Parameters: lawListItemId, newStatus (enum), reason (string). Returns: updated status. Requires user confirmation.
9. `save_assessment` — persist a ChangeAssessment record. Parameters: changeEventId, lawListItemId, status, impactLevel, analysis, recommendations, userNotes. Returns: saved assessment ID. Requires user confirmation.
10. `add_context_note` — add a note to a LawListItem. Parameters: lawListItemId, note (string). Returns: success. Requires user confirmation.

### Tool Infrastructure

11. All tools defined as Vercel AI SDK tool definitions with Zod parameter schemas
12. Tool descriptions written like comprehensive docstrings: purpose, when to use, example usage, edge cases
13. Write tools return a `confirmation_required: true` flag — the UI layer handles confirmation flow
14. Tool responses use semantic identifiers (document title, not just UUID)
15. Tool responses support `concise` and `detailed` modes via optional `responseFormat` parameter
16. Error responses include specific, actionable guidance (not generic error messages)
17. At least 12 unit tests covering all tools

## Tasks / Subtasks

- [ ] **Task 1: Tool type definitions** (AC: 11-12)
  - [ ] Create `lib/agent/tools/types.ts` with shared types
  - [ ] Define tool registry pattern
  - [ ] Define Zod schemas for shared parameters (responseFormat, confirmation flags)
  - [ ] Define `ToolResponse<T>` wrapper type with `_meta` field

- [ ] **Task 2: Read-only tools** (AC: 1-6)
  - [ ] Create `lib/agent/tools/search-laws.ts` — pgvector similarity search across ContentChunks
  - [ ] Create `lib/agent/tools/get-document-details.ts` — fetch full LegalDocument by ID or documentNumber
  - [ ] Create `lib/agent/tools/get-change-details.ts` — fetch ChangeEvent with SectionChange context
  - [ ] Create `lib/agent/tools/get-company-context.ts` — assemble WorkspaceProfile + law list summary + assessment stats
  - [ ] Create `lib/agent/tools/search-company-files.ts` — pgvector search filtered to USER_FILE source type
  - [ ] Create `lib/agent/tools/get-compliance-history.ts` — fetch past assessments and tasks for a document

- [ ] **Task 3: Write tools** (AC: 7-10)
  - [ ] Create `lib/agent/tools/create-task.ts` — return action proposal for task creation
  - [ ] Create `lib/agent/tools/update-compliance-status.ts` — return action proposal for status update
  - [ ] Create `lib/agent/tools/save-assessment.ts` — return action proposal for assessment persistence
  - [ ] Create `lib/agent/tools/add-context-note.ts` — return action proposal for note addition

- [ ] **Task 4: Tool registry** (AC: 11, 13-16)
  - [ ] Create `lib/agent/tools/index.ts` — exports all tools as a unified registry
  - [ ] Implement response format handling (concise vs detailed)
  - [ ] Mark write tools with `confirmation_required` flag
  - [ ] Add `_meta` to all tool responses (tool name, executionTime, chunksSearched)
  - [ ] Implement actionable error response formatting

- [ ] **Task 5: Tests** (AC: 17)
  - [ ] Create `tests/unit/agent/tools/search-laws.test.ts`
  - [ ] Create `tests/unit/agent/tools/get-document-details.test.ts`
  - [ ] Create `tests/unit/agent/tools/get-change-details.test.ts`
  - [ ] Create `tests/unit/agent/tools/get-company-context.test.ts`
  - [ ] Create `tests/unit/agent/tools/search-company-files.test.ts`
  - [ ] Create `tests/unit/agent/tools/get-compliance-history.test.ts`
  - [ ] Create `tests/unit/agent/tools/write-tools.test.ts` (covers all 4 write tools)
  - [ ] Mock Prisma client and pgvector queries
  - [ ] Test parameter validation, response format, confirmation flags, error handling

## Dev Notes

- Vercel AI SDK tool definition pattern:
```typescript
import { tool } from 'ai'
import { z } from 'zod'

export const searchLaws = tool({
  description: 'Search legal documents by semantic similarity...',
  parameters: z.object({ query: z.string(), limit: z.number().optional() }),
  execute: async ({ query, limit }) => { /* implementation */ }
})
```
- pgvector similarity search SQL:
```sql
SELECT *, embedding <=> $1::vector AS distance
FROM content_chunks
WHERE ...
ORDER BY distance
LIMIT $2
```
- For `search_laws`, combine vector similarity with workspace scoping: `WHERE (workspace_id IS NULL OR workspace_id = $workspaceId)`
- For `search_company_files`, filter by `source_type = 'USER_FILE' AND workspace_id = $workspaceId`
- `get_company_context` is the richest tool — it assembles profile + law list summary + recent assessment stats
- Write tools should NOT execute directly — they should return a structured action proposal that the UI can present for confirmation
- Tool response design: include `_meta: { tool, executionTime, chunksSearched }` for transparency
- Source tree: `lib/agent/tools/` (new directory), references `app/actions/` for existing server actions, `prisma/schema.prisma` for models

## Testing

- Test files in `tests/unit/agent/tools/`
- Mock Prisma client and pgvector queries
- Test parameter validation (invalid IDs, missing required fields)
- Test response format (concise vs detailed)
- Test write tool confirmation flag
- Vitest

## Change Log

| Date       | Version | Description                     | Author     |
| ---------- | ------- | ------------------------------- | ---------- |
| 2026-02-18 | 0.1     | Initial draft — story creation  | Dev Agent  |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
