# Story 14.7: Agent Tool Definitions

## Status

Draft

## Story

**As a** compliance partner agent,
**I want** well-defined tools to interact with the application,
**so that** I can search laws, access company context, and take actions on behalf of the user.

## Context & Dependencies

Following Anthropic's "Building Effective Agents" guide, tools are the agent's interface to the app. Each tool needs comprehensive descriptions (same rigor as prompts), clear Zod parameter schemas, and high-signal responses. Tools are split into read-only (run freely, no confirmation) and write (require user confirmation via UI).

**Key existing infrastructure:**

- **AI SDK 6.0** (`ai: ^6.0.50`): The `tool()` function from the `ai` package defines tools with Zod schemas. Already used in `app/api/chat/route.ts` via `streamText()` — currently with NO tools. This story adds them. [Source: package.json, app/api/chat/route.ts]
- **Chat route** (Story 3.3): `app/api/chat/route.ts` uses `streamText()` with `@ai-sdk/openai` and `@ai-sdk/anthropic`. Has rate limiting, auth, and mock RAG. The `tools` parameter needs to be added to `streamText()`. [Source: app/api/chat/route.ts]
- **Chat UI** (Story 14.11 — Done): `lib/hooks/use-chat-interface.ts` uses `useChat()` from `@ai-sdk/react` with `UIMessage` parts format, transport-based API. Supports `conversation_id` grouping. [Source: lib/hooks/use-chat-interface.ts]
- **ContentChunk table** (Story 14.2 — Done): 228,778 chunks with pgvector HNSW index, workspace scoping. [Source: prisma/schema.prisma]
- **Retrieval pipeline** (Story 14.8): `retrieveContext(query, workspaceId, options)` in `lib/agent/retrieval.ts` — provides the backend for `search_laws` and `search_company_files` tools. Returns chunks with relevance scores after two-stage vector+rerank pipeline. [Source: docs/stories/14.8.rag-retrieval-pipeline.md]
- **Existing server actions**: Task CRUD (`app/actions/tasks.ts`), change events (`app/actions/change-events.ts`), company profile (`app/actions/company-profile.ts`), files (`app/actions/files.ts`) — tools wrap these existing functions. [Source: app/actions/]

**Depends on:** 14.2 (ContentChunk for search), 14.8 (retrieval pipeline for search tools)

**Soft dependency:** 14.4 (WorkspaceProfile — not yet built). The `get_company_context` tool uses existing `Workspace` model fields (`org_number`, `company_legal_name`, `sni_code`) and `getCompanyProfile()` action. When 14.4 adds the full `WorkspaceProfile`, the tool response is enriched — no code changes needed, just richer data.

**Deferred models:** `ChangeAssessment` (Story 14.10 — not yet built). The `save_assessment` and `get_compliance_history` tools return stub responses noting the model doesn't exist yet. They will be implemented fully when 14.10 creates the model.

**Depended on by:** 14.8 (retrieval pipeline referenced by search tools), 14.9 (system prompt references tool behaviors), 14.10 (assessment flow uses tools), 14.11 (chat UI surfaces tool results)

## Acceptance Criteria

### Read-Only Tools

1. `search_laws` — semantic search across legal document chunks. Parameters: `query` (string, required), `contentType` (optional: `SFS_LAW`, `AGENCY_REGULATION`, etc.), `limit` (optional, default 5). Calls `retrieveContext()` from Story 14.8. Returns: relevant passages with `contextualHeader`, `documentNumber`, `relevanceScore`, `path`
2. `get_document_details` — full content for a specific legal document. Parameters: `documentId` OR `documentNumber` (one required). Returns: `title`, `documentNumber`, `contentType`, `status`, `summary`, `kommentar`, `markdown_content` (truncated to ~4000 tokens if needed)
3. `get_change_details` — ChangeEvent details with amendment context. Parameters: `changeEventId` (string, required). Returns: `changeType`, `amendmentSfs`, `aiSummary`, `detectedAt`, affected sections (from SectionChange join), base law title and document number
4. `get_company_context` — company profile + compliance posture. Parameters: none (workspace from session context). Returns: workspace fields (`companyLegalName`, `orgNumber`, `sniCode`), tracked law list names with item counts, compliance status distribution, recent unacknowledged change count
5. `search_company_files` — semantic search across workspace file chunks. Parameters: `query` (string, required), `limit` (optional, default 5). Calls `retrieveContext()` from Story 14.8 with `sourceType: 'USER_FILE'`. Returns: matching file passages with filename, similarity score
6. `get_compliance_history` — past actions for a specific law in this workspace. Parameters: `documentId` (string, required). Returns: related tasks (from `TaskListItemLink`), compliance status on `LawListItem`, `complianceActions` field, `lastChangeAcknowledgedAt`. (Note: `ChangeAssessment` data deferred to Story 14.10)

### Write Tools

7. `create_task` — create a workspace task linked to a law. Parameters: `title` (string), `description` (string, optional), `relatedDocumentId` (optional), `priority` (optional: `LOW`|`MEDIUM`|`HIGH`|`CRITICAL`), `execute` (boolean, default false). Wraps existing `createTask()` from `app/actions/tasks.ts`. When `execute` is false (or omitted), returns action proposal with `confirmation_required: true`. When `execute` is true, performs the action and returns the result.
8. `update_compliance_status` — update a LawListItem's compliance status. Parameters: `lawListItemId` (string), `newStatus` (enum: `EJ_PABORJAD`|`PAGAENDE`|`UPPFYLLD`|`EJ_UPPFYLLD`|`EJ_TILLAMPLIG`), `reason` (string), `execute` (boolean, default false). When `execute` is false, returns action proposal with `confirmation_required: true`. When `execute` is true, performs the update.
9. `save_assessment` — persist a change assessment. Parameters: `changeEventId`, `lawListItemId`, `impactLevel` (`HIGH`|`MEDIUM`|`LOW`|`NONE`), `analysis` (string), `recommendations` (string), `execute` (boolean, default false). When `execute` is false, returns action proposal. (Note: `ChangeAssessment` model deferred — this tool is a stub until Story 14.10)
10. `add_context_note` — add a note explaining why a law matters to this company. Parameters: `lawListItemId` (string), `note` (string), `execute` (boolean, default false). Updates `LawListItem.business_context` field. When `execute` is false, returns action proposal with `confirmation_required: true`. When `execute` is true, performs the update.

### Tool Infrastructure

11. All tools defined using Vercel AI SDK `tool()` function with Zod parameter schemas [Source: ai ^6.0.50]
12. Tool descriptions written as comprehensive docstrings: purpose, when to use, what it returns, edge cases — because the LLM reads these to decide which tool to call
13. Write tools do NOT execute immediately — they return a structured action proposal (`{ confirmation_required: true, action, params, preview }`) that the UI presents for user confirmation
14. Tool responses use semantic identifiers (document title + number, not just UUID)
15. Tool responses include `_meta: { tool: string, executionTimeMs: number, resultCount: number }` for transparency
16. Error responses include specific, actionable guidance (e.g., "Dokumentet hittades inte. Kontrollera att dokumentnumret är korrekt, t.ex. 'SFS 1977:1160'.")
17. Tools registered in the chat route: add `tools` parameter to `streamText()` in `app/api/chat/route.ts`
18. At least 12 unit tests covering tool parameter validation, response shapes, error handling, and confirmation flags

## Tasks / Subtasks

- [ ] **Task 1: Tool types and shared infrastructure** (AC: 11-12, 14-16)
  - [ ] Create `lib/agent/tools/types.ts` with shared types:
    - `ToolMeta` — `{ tool: string, executionTimeMs: number, resultCount: number }`
    - `ToolResponse<T>` — `{ data: T, _meta: ToolMeta }`
    - `WriteToolResponse<T>` — `{ confirmation_required: true, action: string, params: Record<string, unknown>, preview: string, _meta: ToolMeta }`
    - `ToolError` — `{ error: true, message: string, guidance: string, _meta: ToolMeta }`
  - [ ] Create `lib/agent/tools/utils.ts` with shared helpers:
    - `wrapToolResponse(tool, data, startTime)` — builds `ToolResponse` with `_meta` timing
    - `wrapWriteToolResponse(tool, action, params, preview, startTime)` — builds write proposal
    - `wrapToolError(tool, message, guidance, startTime)` — builds error response
    - `truncateMarkdown(content, maxTokens)` — truncate markdown to approximate token budget (chars/4). Default budget ~4000 tokens (~16K chars) — leaves room for other tool results and conversation within the model's context window.

- [ ] **Task 2: Read-only tools** (AC: 1-6)
  - [ ] Create `lib/agent/tools/search-laws.ts`
    - Import `retrieveContext` from `lib/agent/retrieval.ts` (Story 14.8)
    - Call `retrieveContext(query, workspaceId, { sourceType: 'LEGAL_DOCUMENT', contentType, topK: limit })`
    - Map results to response shape: `{ contextualHeader, documentNumber, relevanceScore, path, snippet }`
  - [ ] Create `lib/agent/tools/get-document-details.ts`
    - Query `prisma.legalDocument.findFirst()` by `id` or `document_number`
    - Return title, documentNumber, contentType, status, summary, kommentar, markdown_content (truncated)
    - Error if not found: guidance to check document number format
  - [ ] Create `lib/agent/tools/get-change-details.ts`
    - Query `prisma.changeEvent.findUnique()` with `include: { document: true }`
    - Join SectionChange via indirect path: `changeEvent.amendment_sfs` → `prisma.legalDocument.findFirst({ where: { document_number: amendmentSfs } })` → `prisma.sectionChange.findMany({ where: { amendment_id: amendmentDoc.id } })`
    - Return change type, amendment SFS, ai_summary, detected_at, affected sections, base law info
  - [ ] Create `lib/agent/tools/get-company-context.ts`
    - Call existing `getCompanyProfile()` from `app/actions/company-profile.ts`
    - Query workspace law lists with item counts and compliance status distribution
    - Query `getUnacknowledgedChangeCount()` from `app/actions/change-events.ts`
    - Assemble into response: company info + law list summary + compliance stats + pending changes
  - [ ] Create `lib/agent/tools/search-company-files.ts`
    - Import `retrieveContext` from `lib/agent/retrieval.ts` (Story 14.8)
    - Call `retrieveContext(query, workspaceId, { sourceType: 'USER_FILE', topK: limit })`
    - Map results to response shape: `{ filename, relevanceScore, snippet }`
  - [ ] Create `lib/agent/tools/get-compliance-history.ts`
    - Query `LawListItem` by document_id + workspace_id — return compliance_status, compliance_actions, business_context
    - Query related tasks via `TaskListItemLink` join
    - Note: ChangeAssessment data deferred (return empty array with note)

- [ ] **Task 3: Write tools** (AC: 7-10, 13)
  - [ ] Create `lib/agent/tools/create-task.ts`
    - Validate parameters against existing `createTask()` signature in `app/actions/tasks.ts`
    - Return `WriteToolResponse` with preview: "Skapa uppgift: '{title}' med prioritet {priority}"
    - Include `executeAction()` method that calls `createTask()` when confirmed
  - [ ] Create `lib/agent/tools/update-compliance-status.ts`
    - Validate `lawListItemId` exists, validate `newStatus` against `ComplianceStatus` enum
    - Return `WriteToolResponse` with preview showing old → new status
    - Include `executeAction()` that updates `LawListItem.compliance_status` and logs reason
  - [ ] Create `lib/agent/tools/save-assessment.ts`
    - Stub implementation — return `WriteToolResponse` noting ChangeAssessment model not yet available (Story 14.10)
    - Define full parameter schema now so the tool interface is ready when 14.10 builds the model
  - [ ] Create `lib/agent/tools/add-context-note.ts`
    - Validate `lawListItemId` exists
    - Return `WriteToolResponse` with preview showing the note
    - Include `executeAction()` that updates `LawListItem.business_context`

- [ ] **Task 4: Tool registry and chat route wiring** (AC: 17)
  - [ ] Create `lib/agent/tools/index.ts` — barrel export of all tools + registry object
    ```typescript
    export const agentTools = {
      search_laws: searchLawsTool,
      get_document_details: getDocumentDetailsTool,
      get_change_details: getChangeDetailsTool,
      get_company_context: getCompanyContextTool,
      search_company_files: searchCompanyFilesTool,
      get_compliance_history: getComplianceHistoryTool,
      create_task: createTaskTool,
      update_compliance_status: updateComplianceStatusTool,
      save_assessment: saveAssessmentTool,
      add_context_note: addContextNoteTool,
    }
    ```
  - [ ] Modify `app/api/chat/route.ts`:
    - Import `agentTools` from `lib/agent/tools`
    - Add `tools: agentTools` to the `streamText()` call
    - Add `maxSteps: 5` to allow multi-step tool usage (agent calls tool, reads result, responds)
    - Remove mock RAG response function (replaced by real tools)
    - Pass `workspaceId` through tool context (via closure or AI SDK tool context pattern)

- [ ] **Task 5: Tests** (AC: 18)
  - [ ] Create `tests/unit/agent/tools/search-laws.test.ts` — mock `retrieveContext`, verify response shape
  - [ ] Create `tests/unit/agent/tools/get-document-details.test.ts` — mock Prisma, test ID and documentNumber lookup, test not-found error
  - [ ] Create `tests/unit/agent/tools/get-change-details.test.ts` — mock Prisma, test SectionChange join
  - [ ] Create `tests/unit/agent/tools/get-company-context.test.ts` — mock `getCompanyProfile()` and Prisma
  - [ ] Create `tests/unit/agent/tools/search-company-files.test.ts` — mock `retrieveContext` with sourceType filter
  - [ ] Create `tests/unit/agent/tools/get-compliance-history.test.ts` — mock Prisma, test deferred assessment stub
  - [ ] Create `tests/unit/agent/tools/write-tools.test.ts` — test all 4 write tools: parameter validation, confirmation flag, preview text, error on invalid ID
  - [ ] Verify `npx tsc --noEmit` passes
  - [ ] Verify all existing tests still pass (3171+ tests)

## Dev Notes

### Previous Story Insights

**From Story 14.3 (Embedding Generation Pipeline — Done):**

- **Prisma `Unsupported` type:** Cannot use Prisma ORM to read/write `embedding` or query by it. Must use `$queryRaw` for vector operations. However, search tools in this story delegate to `retrieveContext()` (14.8) which handles this internally — tools don't do raw SQL themselves. [Source: Story 14.3 dev notes]
- **Database state:** 228,778 chunks fully embedded, HNSW index active. [Source: Story 14.3 operational notes]

**From Story 14.11 (Chat-First Dashboard — Done):**

- Chat route at `app/api/chat/route.ts` uses `streamText()` with model selection (OpenAI/Anthropic) and rate limiting. Currently has mock RAG — this story replaces it with real tools.
- Client-side `useChatInterface()` hook handles `UIMessage` parts format, conversation persistence, and `conversation_id` grouping. The hook does NOT need changes — AI SDK tool results are handled transparently in the streaming protocol.
- `ChatMessage` model has `conversation_id` for grouping archived conversations. [Source: prisma/schema.prisma]

**From Story 14.8 (RAG Retrieval Pipeline — Draft):**

- `retrieveContext(query, workspaceId, options)` returns `RetrievalResult[]` with fields: `id, content, contextualHeader, contextPrefix, path, sourceType, sourceId, documentNumber, similarity, relevanceScore, metadata`
- Options include: `topK`, `sourceType`, `contentType`, `overFetchMultiplier`, `minRelevanceScore`
- Handles vector search + Cohere Rerank v4 + workspace scoping internally
- Search tools in this story are thin wrappers — they call `retrieveContext()` and map the response to the tool's output shape

### AI SDK 6.0 Tool Pattern

```typescript
import { tool } from 'ai'
import { z } from 'zod'

export const searchLawsTool = tool({
  description: `Search Swedish legal documents by semantic similarity.
Use this tool when the user asks about a legal topic, regulation, or compliance requirement.
Returns the most relevant passages from laws (SFS), agency regulations (AFS, BFS, etc.), and EU legislation.
The search understands Swedish legal terminology and natural language queries.

Example queries:
- "arbetsgivarens skyldigheter för skyddsutrustning"
- "regler för kemikaliehantering"
- "GDPR-krav för personuppgifter"

Returns up to {limit} results ranked by relevance.`,
  parameters: z.object({
    query: z.string().describe('The search query in Swedish'),
    contentType: z.enum(['SFS_LAW', 'AGENCY_REGULATION', 'EU_REGULATION', 'EU_DIRECTIVE'])
      .optional()
      .describe('Filter to a specific document type'),
    limit: z.number().min(1).max(20).default(5)
      .describe('Number of results to return'),
  }),
  execute: async ({ query, contentType, limit }) => {
    // implementation calls retrieveContext()
  },
})
```

[Source: Vercel AI SDK docs — `ai ^6.0.50`]

### Chat Route Modification

The existing `app/api/chat/route.ts` needs these changes:

```typescript
// BEFORE (Story 3.3 — mock RAG):
const result = streamText({
  model,
  system: systemPrompt,
  messages: messages.map(m => ({ ... })),
})

// AFTER (Story 14.7 — real tools):
import { agentTools } from '@/lib/agent/tools'

const result = streamText({
  model,
  system: systemPrompt,  // Story 14.9 will enrich this
  messages,              // Pass UIMessage[] directly (AI SDK 6.0 handles parts)
  tools: agentTools,
  maxSteps: 5,           // Allow multi-step tool use
})
```

The `workspaceId` must be available inside tool `execute()` functions. Two approaches:
1. **Closure:** Create tools as a factory function `createAgentTools(workspaceId)` that returns the tools object with workspaceId captured in closure
2. **AI SDK context:** Use the `toolContext` option if available in AI SDK 6.0

Recommend approach #1 (factory function) — simpler, no SDK-specific API dependency.

**WorkspaceId extraction:** The chat route already resolves the active workspace from the session. Extract it and pass to the factory:

```typescript
// In app/api/chat/route.ts POST handler (session already available):
const workspaceId = session.user.activeWorkspaceId
const tools = createAgentTools(workspaceId)

const result = streamText({
  model,
  system: systemPrompt,
  messages,
  tools,
  maxSteps: 5,
})
```

[Source: app/api/chat/route.ts]

### Existing Server Actions (Reuse, Don't Reinvent)

| Tool | Existing Action | File | Notes |
|---|---|---|---|
| `create_task` | `createTask()` | `app/actions/tasks.ts` | Wraps existing — needs column_id, workspace_id |
| `get_company_context` | `getCompanyProfile()` | `app/actions/company-profile.ts` | Returns workspace + org fields |
| `get_company_context` | `getUnacknowledgedChangeCount()` | `app/actions/change-events.ts` | Pending amendment count |
| `update_compliance_status` | — | — | Direct Prisma update on LawListItem |
| `add_context_note` | — | — | Direct Prisma update on LawListItem.business_context |

[Source: app/actions/]

### Key Prisma Models (Verified)

**ContentChunk** — `source_type` (SourceType enum), `source_id`, `workspace_id`, `path`, `contextual_header`, `content`, `content_role`, `context_prefix`, `embedding` (vector), `token_count`, `metadata` [Source: prisma/schema.prisma]

**LegalDocument** — `content_type` (ContentType enum), `document_number` (unique), `title`, `slug`, `summary`, `kommentar`, `markdown_content`, `status` (DocumentStatus), `metadata` [Source: prisma/schema.prisma]

**ChangeEvent** — `document_id`, `content_type`, `change_type`, `amendment_sfs`, `ai_summary`, `detected_at`, `changed_sections` (JSON) [Source: prisma/schema.prisma]

**SectionChange** — `amendment_id`, `chapter`, `section`, `change_type`, `old_text`, `new_text`, `description` [Source: prisma/schema.prisma]

**LawListItem** — `document_id`, `compliance_status` (ComplianceStatus enum: `EJ_PABORJAD`|`PAGAENDE`|`UPPFYLLD`|`EJ_UPPFYLLD`|`EJ_TILLAMPLIG`), `business_context`, `compliance_actions`, `notes`, `priority` [Source: prisma/schema.prisma]

**Task** — `workspace_id`, `column_id`, `title`, `description`, `assignee_id`, `priority` (TaskPriority), `due_date`, `position` [Source: prisma/schema.prisma]

**ComplianceStatus enum:** `EJ_PABORJAD`, `PAGAENDE`, `UPPFYLLD`, `EJ_UPPFYLLD`, `EJ_TILLAMPLIG` [Source: prisma/schema.prisma]

**ContentType enum:** `SFS_LAW`, `SFS_AMENDMENT`, `COURT_CASE_*`, `EU_REGULATION`, `EU_DIRECTIVE`, `AGENCY_REGULATION` [Source: prisma/schema.prisma]

### Source Tree

```
lib/agent/tools/
  ├── types.ts                  — NEW — ToolResponse, WriteToolResponse, ToolError, ToolMeta
  ├── utils.ts                  — NEW — wrapToolResponse, wrapWriteToolResponse, wrapToolError, truncateMarkdown
  ├── search-laws.ts            — NEW — searchLawsTool (calls retrieveContext)
  ├── get-document-details.ts   — NEW — getDocumentDetailsTool (Prisma query)
  ├── get-change-details.ts     — NEW — getChangeDetailsTool (Prisma query + SectionChange join)
  ├── get-company-context.ts    — NEW — getCompanyContextTool (wraps existing actions)
  ├── search-company-files.ts   — NEW — searchCompanyFilesTool (calls retrieveContext)
  ├── get-compliance-history.ts — NEW — getComplianceHistoryTool (Prisma query, assessment stub)
  ├── create-task.ts            — NEW — createTaskTool (wraps existing createTask action)
  ├── update-compliance-status.ts — NEW — updateComplianceStatusTool (Prisma update)
  ├── save-assessment.ts        — NEW — saveAssessmentTool (stub until 14.10)
  ├── add-context-note.ts       — NEW — addContextNoteTool (Prisma update)
  └── index.ts                  — NEW — barrel exports + agentTools registry

lib/agent/
  ├── retrieval.ts              — FROM Story 14.8 — retrieveContext() used by search tools
  ├── context-assembly.ts       — FROM Story 14.8
  └── legal-ref-detector.ts     — FROM Story 14.8

app/api/chat/
  └── route.ts                  — MODIFIED — add tools to streamText(), remove mock RAG

tests/unit/agent/tools/
  ├── search-laws.test.ts       — NEW
  ├── get-document-details.test.ts — NEW
  ├── get-change-details.test.ts — NEW
  ├── get-company-context.test.ts — NEW
  ├── search-company-files.test.ts — NEW
  ├── get-compliance-history.test.ts — NEW
  └── write-tools.test.ts       — NEW (all 4 write tools)
```

[Source: architecture/12-unified-project-structure.md — lib/ for business logic, tests/unit/ mirroring lib/]

### Write Tool Confirmation Pattern

Write tools do NOT execute on first call. They return a proposal:

```typescript
// Tool returns this to the LLM:
{
  confirmation_required: true,
  action: 'create_task',
  params: { title: 'Uppdatera kemikalieförteckning', priority: 'HIGH' },
  preview: 'Skapa uppgift: "Uppdatera kemikalieförteckning" med prioritet Hög',
  _meta: { tool: 'create_task', executionTimeMs: 5, resultCount: 0 }
}
```

The LLM presents this to the user: "Jag föreslår att vi skapar uppgiften 'Uppdatera kemikalieförteckning' med hög prioritet. Ska jag göra det?"

When the user confirms, the LLM calls the tool again with an `execute: true` flag, and the tool runs the actual server action. This pattern is handled in the tool's `execute()` function:

```typescript
execute: async ({ title, description, priority, execute }) => {
  if (!execute) {
    // Return proposal
    return wrapWriteToolResponse('create_task', 'create_task', { title, priority },
      `Skapa uppgift: "${title}" med prioritet ${priority}`)
  }
  // Execute the action
  const result = await createTask({ title, description, priority, ... })
  return wrapToolResponse('create_task', { taskId: result.id, title }, startTime)
}
```

### Tool Description Quality

Tool descriptions are critical — the LLM reads them to decide which tool to call. Write them like comprehensive docstrings:

- **What it does** (first line, Swedish context)
- **When to use it** (trigger conditions)
- **What it returns** (field descriptions)
- **Edge cases** (what happens on error, no results)
- **Example queries** (for search tools)

Bad: `"Search laws"` — too vague, LLM won't know when to use it
Good: `"Search Swedish legal documents by semantic similarity. Use when the user asks about regulations, compliance requirements, or legal obligations..."` — clear, contextual

## Testing

**Test location:** `tests/unit/agent/tools/` [mirroring `lib/agent/tools/` source structure] [Source: architecture/12-unified-project-structure.md]

**Test framework:** Vitest with `vi.mock()`. [Source: architecture/3-tech-stack.md — Vitest 1.4+]

**Mocking strategy:**

```typescript
// Mock retrieval pipeline (for search tools)
vi.mock('@/lib/agent/retrieval', () => ({
  retrieveContext: vi.fn(),
}))

// Mock Prisma (for data tools)
vi.mock('@/lib/prisma', () => ({
  prisma: {
    legalDocument: { findFirst: vi.fn(), findUnique: vi.fn() },
    changeEvent: { findUnique: vi.fn() },
    sectionChange: { findMany: vi.fn() },
    lawListItem: { findFirst: vi.fn(), update: vi.fn() },
    $queryRaw: vi.fn(),
  },
}))

// Mock existing server actions (for write tools)
vi.mock('@/app/actions/tasks', () => ({
  createTask: vi.fn(),
}))
vi.mock('@/app/actions/company-profile', () => ({
  getCompanyProfile: vi.fn(),
}))
vi.mock('@/app/actions/change-events', () => ({
  getUnacknowledgedChangeCount: vi.fn(),
}))
```

**Key test scenarios:**

- Read tools: verify response shape matches `ToolResponse<T>`, verify `_meta` fields present
- Search tools: verify `retrieveContext` called with correct sourceType filter
- Data tools: verify Prisma called with correct query, verify not-found returns `ToolError`
- Write tools: verify `confirmation_required: true` on first call, verify action executes on `execute: true`
- All tools: verify Zod parameter validation rejects invalid input
- Error handling: verify `ToolError` includes actionable Swedish guidance text

## Change Log

| Date       | Version | Description                     | Author     |
| ---------- | ------- | ------------------------------- | ---------- |
| 2026-02-18 | 0.1     | Initial draft — story creation  | Dev Agent  |
| 2026-03-01 | 1.0     | Full redraft: updated for AI SDK 6.0 (^6.0.50), referenced actual chat route and hook, verified Prisma models against schema, search tools delegate to retrieveContext() from 14.8, wraps existing server actions, factory function for workspaceId, write tool confirmation pattern, deferred ChangeAssessment stub, comprehensive dev notes with model fields | Bob (SM) |
| 2026-03-01 | 1.1     | PO validation fixes: added workspaceId extraction snippet in chat route section, added `execute` flag to all write tool AC parameter lists, added token budget rationale for truncateMarkdown, clarified SectionChange indirect join path | Bob (SM) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
