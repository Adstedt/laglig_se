# Story 12.6: Derive Arbetsmiljö för Tjänsteföretag Variant

## Status

**Deferred** — Depends on Story 12.4 (parent template). Per Epic 12 Decision B, seeding stories execute after ingestion is working. Per Decision A, variant will initially use single placeholder section; the 7-section structure is deferred. The variant still works since it filters on `is_service_company_relevant`, not sections.

## Story

**As a** product owner,
**I want** the Arbetsmiljö för tjänsteföretag template derived as a filtered view of the Arbetsmiljö parent template,
**so that** service-company users get a focused 55-law template without maintaining a separate data structure.

## Acceptance Criteria

1. `LawListTemplate` record created with `parent_template_id` pointing to Arbetsmiljö template, `is_variant = true`, `variant_filter_field = "is_service_company_relevant"`, `document_count = 55`, `section_count = 7`
2. **No TemplateItem records created** — variant queries parent's items at runtime (per Decision 2)
3. 7 `TemplateSection` records created on the variant template:
   - 01: Grundläggande regelverk (6 docs — parent Section 01 minus AFS 2023:15)
   - 02: Arbetsrätt och personalförvaltning (21 docs — parent Section 02 + Utstationeringslagen promoted from 09)
   - 03: Arbetsplatsens utformning (10 docs — parent Section 03 unchanged)
   - 04: Maskiner och utrustning (5 docs — parent Section 05 reduced)
   - 05: Brand och explosion (6 docs — parent Section 06 reduced)
   - 06: Elsäkerhet (3 docs — parent Section 07 reduced)
   - 07: Kemiska risker (4 docs — parent Section 08 unchanged)
   - Parent Sections 04 and 09 dropped entirely
4. 2 promoted items on the parent template have `variant_section_override` set (moved from parent Section 09 to variant Section 02)
5. Variant API endpoint resolves correctly: `GET /api/templates/arbetsmiljo-tjansteforetag` returns 55 items across 7 sections
6. Adoption of the variant creates a workspace LawList with 55 items and 7 groups
7. Verify: editing a parent item's compliance summary is immediately reflected when querying the variant

## Tasks / Subtasks

- [ ] **Task 1: Create variant LawListTemplate record** (AC: 1)
  - [ ] Create seed script or extend `scripts/seed-arbetsmiljo-template.ts`
  - [ ] Insert with `parent_template_id` = Arbetsmiljö template ID
  - [ ] Set `is_variant = true`, `variant_filter_field = "is_service_company_relevant"`
  - [ ] Set slug: "arbetsmiljo-tjansteforetag"
  - [ ] Set denormalized counts: `document_count = 55`, `section_count = 7`
- [ ] **Task 2: Create 7 TemplateSection records** (AC: 3)
  - [ ] Map variant sections to parent sections per AC 3 table
  - [ ] Note: variant section numbering is sequential (01-07), different from parent
  - [ ] Set position and item_count per section
- [ ] **Task 3: Set variant_section_override on parent items** (AC: 4)
  - [ ] Identify the 2 promoted items (Utstationeringslagen + 1 other) from analysis file 02
  - [ ] Update their `variant_section_override` field on the **parent** template's TemplateItem records
  - [ ] These items move from parent Section 09 to variant Section 02
- [ ] **Task 4: Build variant query API** (AC: 5)
  - [ ] Create `app/api/templates/[slug]/route.ts` (or extend existing template API)
  - [ ] For variant templates, implement query logic:
    1. Read variant's TemplateSection records (7 sections)
    2. Join parent's TemplateItem records WHERE `is_service_company_relevant = true`
    3. Apply `variant_section_override` for promoted items
    4. Return combined result as if standalone template
  - [ ] For non-variant templates, return items directly
- [ ] **Task 5: Verify data consistency** (AC: 6, 7)
  - [ ] Test API returns exactly 55 items across 7 sections
  - [ ] Test that modifying a parent item's compliance_summary is reflected in variant query
  - [ ] Test that adoption creates correct LawList structure (55 items, 7 groups)
- [ ] **Task 6: Write tests** (AC: all)
  - [ ] Unit test: variant query logic filters correctly
  - [ ] Unit test: variant_section_override applies correctly
  - [ ] Integration test: API endpoint returns correct structure
  - [ ] Integration test: parent edit propagates to variant view

## Dev Notes

### Variant Architecture (Epic 12 Decision 2)

A variant template is a **metadata-only record** with no TemplateItem records of its own. All items live on the parent template. The variant is rendered at query time by:

1. Fetching parent's TemplateItem records WHERE the filter field is true
2. Applying `variant_section_override` for ~2 promoted items
3. Re-numbering sections sequentially (dropping empty parent sections)

This ensures:
- **No data duplication** — items exist once on the parent
- **Automatic consistency** — updating a compliance summary on parent propagates to variant
- **Lightweight variant records** — only TemplateSection records on variant

### Section Mapping (Parent → Variant)

| Parent Section | Parent Name | Variant Section | Variant Name | Notes |
|---|---|---|---|---|
| 01 | Grundläggande regelverk | 01 | Grundläggande regelverk | Minus 1 doc (AFS 2023:15) |
| 02 | Arbetsrätt och personalförvaltning | 02 | Arbetsrätt och personalförvaltning | Plus Utstationeringslagen from 09 |
| 03 | Arbetsplatsens utformning | 03 | Arbetsplatsens utformning | Unchanged |
| 04 | Fysisk belastning | — | _dropped_ | All items irrelevant |
| 05 | Maskiner och utrustning | 04 | Maskiner och utrustning | Reduced |
| 06 | Brand och explosion | 05 | Brand och explosion | Reduced |
| 07 | Elsäkerhet | 06 | Elsäkerhet | Reduced |
| 08 | Kemiska risker | 07 | Kemiska risker | Unchanged |
| 09 | Kompletterande | — | _dropped_ | Items distributed or dropped |

### API Endpoint

Create or extend: `app/api/templates/[slug]/route.ts`

The endpoint should handle both variant and non-variant templates transparently. Consumers see a unified response regardless of whether it's a variant.

### Dependencies

- **Blocked by:** Story 12.4 (parent Arbetsmiljö template must exist)
- **Blocked by:** Story 12.2 (schema must exist)

### Data Source

**Primary:** `data/notisum-amnesfokus/analysis/02-arbetsmiljo-tjansteforetag.md`

### Relevant Source Tree

```
scripts/seed-arbetsmiljo-template.ts        # Extend or create separate script
app/api/templates/[slug]/route.ts           # New API endpoint
prisma/schema.prisma                         # TemplateItem.variant_section_override
```

### Testing

- **Test framework:** Vitest 1.4+
- **Test location:** `tests/unit/lib/`, `tests/integration/api/`
- **Tests needed:**
  - Variant query returns exactly 55 items
  - Variant sections are correctly numbered 01-07
  - variant_section_override correctly moves items to different sections
  - Parent compliance_summary edit propagates to variant view
  - No TemplateItem records exist for variant template

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Status changed to Deferred per Decision B — depends on 12.4, seeding after ingestion fix. Single-section approach per Decision A | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
