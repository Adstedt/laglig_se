# Story 12.10: Adopt Template into Workspace

## Status

Draft

## Story

**As a** workspace member,
**I want** to adopt a template into my workspace as a new law list,
**so that** I get a pre-built compliance checklist I can customize.

## Acceptance Criteria

1. "Använd denna mall" button on template preview page
2. If user has multiple workspaces, workspace selector shown
3. Adoption creates:
   - New `LawList` in target workspace with name = template name
   - `LawListGroup` records for each template section (name, position)
   - `LawListItem` records for each template item with: document_id, commentary = compliance summary, ai_commentary = expert commentary, category = section name, group_id = corresponding LawListGroup, status = NOT_STARTED, source = TEMPLATE (new enum value), position from SSDD index
4. For tjänsteföretag variant adoption: only service-company-relevant items copied
5. Post-adoption redirect to workspace law list view
6. Toast notification: "Mallen 'Arbetsmiljö' har lagts till med 112 lagar"
7. Adopted list is fully independent — editing doesn't affect template
8. If workspace already has a list with same name, append " (2)" suffix
9. `LawListItemSource` enum extended with `TEMPLATE` value

## Tasks / Subtasks

- [ ] **Task 1: Extend LawListItemSource enum** (AC: 9)
  - [ ] Add `TEMPLATE` to `LawListItemSource` enum in `prisma/schema.prisma`
  - [ ] Run Prisma migration
  - [ ] Verify no breaking changes to existing code using this enum
- [ ] **Task 2: Build adoption server action** (AC: 3, 4, 7, 8)
  - [ ] Create `app/actions/template-adoption.ts`
  - [ ] `adoptTemplate(templateId, workspaceId)` action:
    1. Fetch template with sections and items (or variant-resolved items)
    2. Check for duplicate list name → append " (2)" if needed
    3. Create `LawList` record
    4. Create `LawListGroup` records from sections
    5. Bulk-create `LawListItem` records from template items
    6. Store template provenance: `LawList.metadata = { source_template_id, source_template_version }`
  - [ ] For variant templates: query parent items filtered by `is_service_company_relevant`
  - [ ] Use Prisma transaction for atomicity
  - [ ] Performance: complete in <3 seconds for 112 items
- [ ] **Task 3: Build workspace selector** (AC: 2)
  - [ ] If user belongs to multiple workspaces, show selector dialog
  - [ ] Create `components/features/templates/workspace-selector-dialog.tsx`
  - [ ] Use shadcn/ui Dialog + Select components
  - [ ] Default to current workspace if only one
- [ ] **Task 4: Implement adoption flow UI** (AC: 1, 5, 6)
  - [ ] "Använd denna mall" button triggers adoption
  - [ ] Show loading state during bulk insert
  - [ ] On success: redirect to `/dashboard` or workspace law list view
  - [ ] Toast: "Mallen '{name}' har lagts till med {count} lagar"
  - [ ] Use shadcn/ui Toast component
- [ ] **Task 5: Handle duplicate list names** (AC: 8)
  - [ ] Query existing law lists in workspace for name collision
  - [ ] If "Arbetsmiljö" exists, create "Arbetsmiljö (2)", then "(3)", etc.
- [ ] **Task 6: Field mapping** (AC: 3)
  - [ ] Map template fields to LawListItem fields:
    - `compliance_summary` → `commentary` (reused field — semantic intent differs by `source`)
    - `expert_commentary` → `ai_commentary` (semantically consistent)
    - `section.name` → `category`
    - `item.position` → `position`
    - `section.id` → `group_id` (via created LawListGroup)
    - `source` = `TEMPLATE`
    - `status` = `NOT_STARTED`
    - `compliance_status` = `EJ_PABORJAD`
- [ ] **Task 7: Write tests** (AC: all)
  - [ ] Unit test: adoption creates correct number of records (1 list, 9 groups, 112 items)
  - [ ] Unit test: field mapping is correct (commentary = compliance_summary, etc.)
  - [ ] Unit test: variant adoption creates 55 items (not 112)
  - [ ] Unit test: duplicate name handling appends suffix
  - [ ] Unit test: adopted list is independent (modifying doesn't affect template)
  - [ ] Integration test: full adoption flow with redirect
  - [ ] Performance test: 112-item adoption completes in <3 seconds

## Dev Notes

### Implementation Context (Decision B — FE First with Mock Data)

This story is built **before** templates are seeded. Use mock/stub template data during development and testing. Per Decision A (single-section pivot), adoption will initially create 1 LawListGroup instead of 9 — the UI should handle this gracefully. Once section groupings are added to templates, adoption automatically creates the correct number of groups.

### Existing LawList Models

**LawList** (`prisma/schema.prisma` line 171):
- Workspace-scoped with `workspace_id`
- No `metadata` field currently — need to add JSONB `metadata` field to store template provenance
- Or use existing `description` field for provenance info

**LawListGroup** (`prisma/schema.prisma` line 191):
- `law_list_id`, `name`, `position` (float)
- Unique constraint on `[law_list_id, name]`

**LawListItem** (`prisma/schema.prisma` line 206):
- `commentary` (String?) — reused for compliance summary from templates
- `ai_commentary` (String?) — used for expert commentary (semantically consistent)
- `source` (`LawListItemSource`) — currently: ONBOARDING, MANUAL, IMPORT → add TEMPLATE
- `category` (String?) — used for section name
- `group_id` (String?) — FK to LawListGroup

### LawList Metadata Field

Need to add `metadata Json?` to `LawList` model to store:
```json
{
  "source_template_id": "uuid",
  "source_template_version": 1
}
```
This enables future "template updated" notifications (Phase 2 roadmap).

### Performance: Bulk Insert

Use `prisma.lawListItem.createMany()` for bulk insert of 112 items. This is significantly faster than individual creates.

```typescript
await prisma.$transaction(async (tx) => {
  const lawList = await tx.lawList.create({ data: { ... } })
  const groups = await Promise.all(
    sections.map(s => tx.lawListGroup.create({ data: { law_list_id: lawList.id, name: s.name, position: s.position } }))
  )
  await tx.lawListItem.createMany({
    data: items.map(item => ({
      law_list_id: lawList.id,
      document_id: item.document_id,
      commentary: item.compliance_summary,
      ai_commentary: item.expert_commentary,
      category: item.section_name,
      group_id: groupMap[item.section_id],
      position: item.position,
      source: 'TEMPLATE',
      status: 'NOT_STARTED',
      compliance_status: 'EJ_PABORJAD',
    }))
  })
})
```

### Design Note: Content Inheritance from LegalDocument (from 12.9 UX review)

Currently `TemplateItem` stores its own `compliance_summary` and `expert_commentary` as standalone text fields. This duplicates content that already exists on `LegalDocument` after the Story 12.3 AI generation pipeline:

- `LegalDocument.kommentar` — "Vi ska..." compliance actions (= current `compliance_summary`)
- `LegalDocument.summary` — Neutral law description (= current `expert_commentary`)

**Proposed change:** Template items should inherit summary + kommentar from the document by default, and add a **new contextual commentary field** on `TemplateItem` for domain-specific perspective. For example, the same Arbetsmiljölag document would get a workplace safety angle on an arbetsmiljö template, but an environmental compliance angle on a miljö template.

**Data model impact:**
- Remove (or deprecate) `TemplateItem.compliance_summary` and `TemplateItem.expert_commentary`
- Add `TemplateItem.contextual_commentary` (String?) — domain-specific perspective, unique per template
- Query joins `LegalDocument.kommentar` + `LegalDocument.summary` for the base content
- Adoption field mapping changes:
  - `LegalDocument.kommentar` → `LawListItem.commentary` (was: `TemplateItem.compliance_summary`)
  - `LegalDocument.summary` → `LawListItem.ai_commentary` (was: `TemplateItem.expert_commentary`)
  - `TemplateItem.contextual_commentary` → new field or appended to commentary

**UI impact (template preview):**
- "Sammanfattning" section shows `LegalDocument.kommentar` (inherited)
- "Om lagen" section shows `LegalDocument.summary` (inherited)
- Optional third section for domain-specific context from the template item

**Decision needed before 12.10:** Should this refactor happen in 12.10 or as a separate story? If deferred, current field mapping (Task 6) works but copies redundant data.

### Relevant Source Tree

```
prisma/schema.prisma                                    # Extend LawListItemSource, add LawList.metadata
app/actions/template-adoption.ts                         # New server action
components/features/templates/workspace-selector-dialog.tsx # New component
app/(authenticated)/laglistor/[slug]/page.tsx            # CTA triggers adoption (auth-gated)
lib/db/queries/template.ts                               # Template data fetching
```

### Testing

- **Test framework:** Vitest 1.4+
- **Test location:** `tests/unit/actions/`, `tests/integration/`
- **Tests needed:**
  - Adoption creates 1 LawList + N LawListGroups + M LawListItems
  - Field mapping: commentary = compliance_summary from template
  - Variant adoption: only 55 items created
  - Duplicate name: "Arbetsmiljö (2)" created when "Arbetsmiljö" exists
  - Template provenance stored in LawList metadata
  - Performance: <3 seconds for 112 items

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Added mock data context per Decision B, single-group note per Decision A | Sarah (PO) |
| 2026-02-09 | 1.2     | Updated source tree to reflect authenticated template route (per 12.8/12.9 change) | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
