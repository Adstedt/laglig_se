# Story 8.4: Implement Email Notifications for Law Changes

## Status

Draft

## Story

**As a** user,
**I want** to receive email notifications when laws in my list change,
**so that** I'm alerted even when not using the app.

## Acceptance Criteria

1. Daily Digest Email sent between 08:00-09:00 CET
2. Email structure includes:
   - Greeting with user's name
   - List of changed laws with AI summaries
   - Business impact assessment for each change
   - CTA button "Review Changes" â†’ Links to Changes tab
3. Priority badges (ðŸŸ¢/ðŸŸ¡/ðŸ”´) for each change
4. Dual links for each change:
   - [View on Laglig.se] â†’ Opens diff view
   - [Official Riksdagen PDF] â†’ Opens official source
5. Multiple law lists â†’ Send separate email per list (workspace-scoped)
6. React Email for templates with branded design
7. Unsubscribe link in footer
8. Track email opens using UTM parameters
9. Email sent only if â‰¥1 change detected in last 24 hours
10. From address: "Laglig.se <notifications@laglig.se>"
11. Subject line: "LagÃ¤ndringar: [N] nya Ã¤ndringar i din laglista"

## Tasks / Subtasks

- [ ] Install React Email and Resend SDK
- [ ] Create daily digest email template component
- [ ] Implement Vercel Cron job for daily sending (08:00 CET)
- [ ] Build email sending API endpoint
- [ ] Query unacknowledged changes from last 24 hours
- [ ] Group changes by workspace
- [ ] Generate UTM parameters for tracking
- [ ] Add unsubscribe functionality
- [ ] Test email rendering across clients (Gmail, Outlook, Apple Mail)
- [ ] Configure SPF, DKIM, DMARC records
- [ ] Test deliverability and spam score
- [ ] Add error handling and retry logic

## Dev Notes

**Install Dependencies:**

```bash
npm install @react-email/components resend
npm install @react-email/render
```

**Email Template Component:**

```typescript
// emails/daily-change-digest.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Button,
  Link,
  Hr
} from '@react-email/components'

interface Change {
  id: string
  priority: 'high' | 'medium' | 'low'
  lawTitle: string
  lawSfsNummer: string
  aiSummary: string
  businessImpact: string
  diffUrl: string
  officialUrl: string
}

interface DailyChangeDigestProps {
  userName: string
  workspaceName: string
  changes: Change[]
  unsubscribeUrl: string
}

export function DailyChangeDigest({
  userName,
  workspaceName,
  changes,
  unsubscribeUrl
}: DailyChangeDigestProps) {
  const PRIORITY_EMOJI = {
    high: 'ðŸ”´',
    medium: 'ðŸŸ¡',
    low: 'ðŸŸ¢'
  }

  return (
    <Html>
      <Head />
      <Body style={{ fontFamily: 'sans-serif', backgroundColor: '#f9fafb' }}>
        <Container style={{ maxWidth: '600px', margin: '0 auto', backgroundColor: '#ffffff', padding: '0' }}>
          {/* Header */}
          <Section style={{ backgroundColor: '#3b82f6', padding: '24px', textAlign: 'center' }}>
            <Text style={{ color: '#ffffff', fontSize: '24px', fontWeight: 'bold', margin: '0' }}>
              Laglig.se
            </Text>
          </Section>

          {/* Greeting */}
          <Section style={{ padding: '24px' }}>
            <Text style={{ fontSize: '16px', color: '#111827', margin: '0 0 16px 0' }}>
              Hej {userName},
            </Text>
            <Text style={{ fontSize: '14px', color: '#6b7280', margin: '0' }}>
              FÃ¶ljande lagar i din lista <strong>{workspaceName}</strong> har Ã¤ndrats de senaste 24 timmarna:
            </Text>
          </Section>

          {/* Changes List */}
          {changes.map((change) => (
            <Section
              key={change.id}
              style={{
                margin: '0 24px 16px 24px',
                borderLeft: '4px solid #3b82f6',
                padding: '16px',
                backgroundColor: '#f9fafb',
                borderRadius: '8px'
              }}
            >
              {/* Priority + Title */}
              <Text style={{ fontSize: '14px', fontWeight: 'bold', color: '#111827', margin: '0 0 8px 0' }}>
                {PRIORITY_EMOJI[change.priority]} {change.lawSfsNummer}: {change.lawTitle}
              </Text>

              {/* AI Summary */}
              <Text style={{ fontSize: '14px', color: '#374151', margin: '0 0 12px 0' }}>
                {change.aiSummary}
              </Text>

              {/* Business Impact */}
              <Text
                style={{
                  fontSize: '13px',
                  color: '#1e40af',
                  backgroundColor: '#dbeafe',
                  padding: '8px 12px',
                  borderRadius: '6px',
                  margin: '0 0 12px 0'
                }}
              >
                <strong>PÃ¥verkan:</strong> {change.businessImpact}
              </Text>

              {/* Action Links */}
              <div style={{ display: 'flex', gap: '12px' }}>
                <Button
                  href={change.diffUrl}
                  style={{
                    backgroundColor: '#3b82f6',
                    color: '#ffffff',
                    padding: '10px 16px',
                    borderRadius: '6px',
                    textDecoration: 'none',
                    fontSize: '13px',
                    fontWeight: '500'
                  }}
                >
                  Granska Ã¤ndring
                </Button>
                <Link
                  href={change.officialUrl}
                  style={{
                    color: '#3b82f6',
                    padding: '10px 16px',
                    textDecoration: 'none',
                    fontSize: '13px'
                  }}
                >
                  Riksdagen PDF â†—
                </Link>
              </div>
            </Section>
          ))}

          {/* CTA Button */}
          <Section style={{ padding: '24px', textAlign: 'center' }}>
            <Button
              href={`https://laglig.se/laws/changes?utm_source=email&utm_medium=daily_digest&utm_campaign=change_notification`}
              style={{
                backgroundColor: '#3b82f6',
                color: '#ffffff',
                padding: '12px 24px',
                borderRadius: '8px',
                textDecoration: 'none',
                fontSize: '14px',
                fontWeight: '600',
                display: 'inline-block'
              }}
            >
              Granska alla Ã¤ndringar
            </Button>
          </Section>

          <Hr style={{ borderColor: '#e5e7eb', margin: '0 24px' }} />

          {/* Footer */}
          <Section style={{ padding: '16px 24px', fontSize: '12px', color: '#6b7280', textAlign: 'center' }}>
            <Text style={{ margin: '0 0 8px 0' }}>
              Detta Ã¤r en automatisk notifiering frÃ¥n Laglig.se
            </Text>
            <Link href={unsubscribeUrl} style={{ color: '#3b82f6', textDecoration: 'none' }}>
              AvbestÃ¤ll daglig sammanfattning
            </Link>
          </Section>
        </Container>
      </Body>
    </Html>
  )
}
```

**Email Sending Service:**

```typescript
// lib/email/send-email.ts
import { Resend } from 'resend'
import { render } from '@react-email/render'

const resend = new Resend(process.env.RESEND_API_KEY)

interface SendEmailOptions {
  to: string
  subject: string
  react: React.ReactElement
}

export async function sendEmail({ to, subject, react }: SendEmailOptions) {
  try {
    const html = render(react)

    const { data, error } = await resend.emails.send({
      from: 'Laglig.se <notifications@laglig.se>',
      to,
      subject,
      html,
    })

    if (error) {
      console.error('Failed to send email:', error)
      throw new Error(`Email send failed: ${error.message}`)
    }

    console.log('Email sent successfully:', data?.id)
    return data
  } catch (error) {
    console.error('Email sending error:', error)
    throw error
  }
}
```

**Daily Digest Cron Job:**

```typescript
// app/api/cron/send-daily-change-digest/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { sendEmail } from '@/lib/email/send-email'
import { DailyChangeDigest } from '@/emails/daily-change-digest'

export async function GET(request: Request) {
  // Verify Vercel Cron secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const startTime = Date.now()
  const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000)

  try {
    // Get all workspaces with unacknowledged changes from last 24 hours
    const workspaces = await prisma.workspace.findMany({
      include: {
        owner: {
          select: { id: true, name: true, email: true },
        },
        workspaceLaws: {
          include: {
            law: {
              include: {
                lawChanges: {
                  where: {
                    detectedAt: { gte: yesterday },
                    acknowledgedAt: null,
                  },
                  orderBy: [{ priority: 'desc' }, { detectedAt: 'desc' }],
                },
              },
            },
          },
        },
      },
    })

    let emailsSent = 0
    let emailsFailed = 0

    for (const workspace of workspaces) {
      // Collect all changes for this workspace
      const changes = workspace.workspaceLaws.flatMap((wl) =>
        wl.law.lawChanges.map((change) => ({
          id: change.id,
          priority: change.priority as 'high' | 'medium' | 'low',
          lawTitle: wl.law.rubrik,
          lawSfsNummer: wl.law.sfsNummer,
          aiSummary:
            change.aiSummary ||
            'Ã„ndring upptÃ¤ckt. Se detaljer fÃ¶r mer information.',
          businessImpact: change.businessImpact || 'KrÃ¤ver granskning',
          diffUrl: `https://laglig.se/laws/${wl.law.id}/changes/${change.id}?utm_source=email&utm_medium=daily_digest&utm_campaign=change_notification`,
          officialUrl:
            change.officialSourceUrl ||
            `https://www.riksdagen.se/sv/dokument-och-lagar/dokument/svensk-forfattningssamling/${wl.law.sfsNummer}`,
        }))
      )

      // Skip if no changes
      if (changes.length === 0) continue

      // Check user's notification preferences
      const preferences = await prisma.userNotificationPreferences.findUnique({
        where: { userId: workspace.owner.id },
      })

      if (preferences && !preferences.emailDailyDigest) {
        console.log(
          `Skipping email for ${workspace.owner.email} - disabled in preferences`
        )
        continue
      }

      // Send email
      try {
        await sendEmail({
          to: workspace.owner.email,
          subject: `LagÃ¤ndringar: ${changes.length} nya Ã¤ndringar i din laglista`,
          react: DailyChangeDigest({
            userName: workspace.owner.name || 'dÃ¤r',
            workspaceName: workspace.name,
            changes,
            unsubscribeUrl: `https://laglig.se/settings/notifications?unsubscribe=daily_digest`,
          }),
        })

        emailsSent++
      } catch (error) {
        console.error(
          `Failed to send email to ${workspace.owner.email}:`,
          error
        )
        emailsFailed++
      }
    }

    const duration = Date.now() - startTime

    return NextResponse.json({
      success: true,
      emailsSent,
      emailsFailed,
      durationMs: duration,
    })
  } catch (error) {
    console.error('Daily digest cron job failed:', error)
    return NextResponse.json(
      {
        error: 'Cron job failed',
        message: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    )
  }
}
```

**Vercel Cron Configuration:**

```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/send-daily-change-digest",
      "schedule": "0 8 * * *"
    }
  ]
}
```

**Environment Variables:**

```bash
# .env.local
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxx
CRON_SECRET=your_secure_random_string_here
```

**Email Deliverability Setup:**

1. **Domain Configuration:**
   - Add DNS records provided by Resend
   - SPF: `v=spf1 include:_spf.resend.com ~all`
   - DKIM: Provided by Resend (auto-configured)
   - DMARC: `v=DMARC1; p=none; rua=mailto:admin@laglig.se`

2. **Unsubscribe Functionality:**

```typescript
// app/settings/notifications/route.ts
import { NextResponse } from 'next/server'
import { withAuth } from '@/lib/auth/with-auth'
import { prisma } from '@/lib/prisma'

export async function POST(request: Request) {
  return withAuth(async ({ userId }) => {
    const { unsubscribe } = await request.json()

    if (unsubscribe === 'daily_digest') {
      await prisma.userNotificationPreferences.upsert({
        where: { userId },
        update: { emailDailyDigest: false },
        create: {
          userId,
          emailDailyDigest: false,
          emailWeeklyDigest: true,
          emailReminders: true,
        },
      })

      return NextResponse.json({
        success: true,
        message: 'Daily digest unsubscribed',
      })
    }

    return NextResponse.json(
      { error: 'Invalid unsubscribe type' },
      { status: 400 }
    )
  })
}
```

**Reference:** PRD Epic 8 Story 8.4, React Email documentation, Resend API docs

## Testing

**Unit Tests:**

- Email template renders correctly with change data
- Priority emoji displays for high/medium/low
- UTM parameters appended to all links
- Unsubscribe link present in footer
- Handles empty changes array gracefully

**Integration Tests:**

- Cron job queries changes from last 24 hours
- Groups changes by workspace correctly
- Skips workspaces with no changes
- Respects user notification preferences
- Email sent successfully via Resend API
- Error handling for failed sends

**Manual Testing:**

- Preview email template in React Email dev server (`npm run email:dev`)
- Send test email to personal inbox
- Verify rendering in Gmail, Outlook, Apple Mail
- Click all links to verify UTM tracking
- Test unsubscribe functionality
- Check spam score using mail-tester.com (aim for >8/10)
- Verify SPF/DKIM/DMARC pass with mail headers

**Deliverability Testing:**

- Test inbox placement in major providers (Gmail, Outlook, Yahoo)
- Verify no broken links
- Check mobile responsiveness
- Validate HTML structure (no unclosed tags)
- Test with 1, 5, 20 changes in email

**Performance Testing:**

- Email generation completes <1 second
- Cron job sends 100 emails <5 minutes
- Resend API response time <500ms

**Edge Cases:**

- User with no email address (skip)
- Workspace with no owner (skip)
- Very long law titles (truncate or wrap)
- Very long AI summaries (truncate to 200 chars)
- Missing AI summary (fallback text)
- Invalid email addresses (catch error, log)

**Test File:** `__tests__/features/email-notifications/daily-digest.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Check email regularly for law change notifications
- Update email address in profile if it changes
- Configure notification preferences if overwhelming
- Mark changes as reviewed to clear from next digest

**Developer Responsibility:**

- Send emails reliably at consistent time (08:00 CET)
- Generate accurate AI summaries for changes
- Render emails correctly across all major clients
- Provide unsubscribe functionality (CAN-SPAM compliance)
- Track email opens for engagement metrics
- Handle email sending failures gracefully with retry
- Respect user notification preferences
- Optimize email delivery for large volumes
- Monitor deliverability and spam scores
- Ensure links work and track correctly
- Provide clear call-to-action buttons
- Make email content scannable and actionable

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
