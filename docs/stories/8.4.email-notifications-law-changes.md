# Story 8.4: Email Notifications for Amendment Changes

## Status

Draft (v2 — rewritten to align with actual data model and amendment pipeline)

## Story

**As a** workspace member with laws in my law list,
**I want** to receive a daily email digest when amendments affect laws I track,
**so that** I'm alerted to compliance-relevant changes even when not using the app.

## Context & Dependencies

**Builds on:**

- `sync-sfs-updates` cron (runs 4:30 AM UTC) — detects amendments, parses PDFs, creates `AmendmentDocument` + `SectionChange` + `LegalDocument` records
- Story 12.3 content generation pipeline — proven summering/kommentar prompts + hallucination checking via `lib/ai/prompts/document-content.ts`
- Existing `ChangeEvent.notification_sent` field (already in schema)
- Existing `NotificationPreference` model (per workspace, already in schema)
- Existing Resend email infrastructure (`lib/email/cron-notifications.ts`)

**Supersedes/Updates:**

- Story 8.8 (AI Change Summaries) — the summering/kommentar pipeline from Story 12.3 replaces the OpenAI-based approach entirely. The "business impact" concept maps to the Kommentar voice ("Vi ska...", "Vi behöver...").

**Deferred to separate stories:**

- Story 8.5: In-app notification bell (needs same data model alignment)
- Story 8.11: Notification preferences UI (needs same data model alignment)

## Acceptance Criteria

### Core Notification Cron

1. New cron endpoint at `/api/cron/notify-amendment-changes` runs daily at 07:00 UTC (08:00 CET / 09:00 CEST)
2. Finds `AmendmentDocument` records with `parse_status = COMPLETED` that have not yet been notified (via `ChangeEvent.notification_sent = false`)
3. For each un-notified amendment, generates summering + kommentar using Story 12.3 prompts if the amendment's `LegalDocument` lacks them
4. Groups amendments by base law, then by workspace (via `LawList → LawListItem → LegalDocument` path)
5. Sends one digest email per workspace containing all relevant amendments from the last 48 hours
6. Marks `ChangeEvent.notification_sent = true` after successful email delivery
7. `maxDuration = 300` with 30s timeout buffer (same pattern as other crons)

### Content Generation

8. Uses `buildSystemPrompt()` and `buildDocumentContext()` from `lib/ai/prompts/document-content.ts` to generate `summering` + `kommentar` for amendment LegalDocuments that don't have them yet
9. Uses Anthropic Claude (Sonnet for speed within cron timeout, not Opus Batch API) for inline generation
10. Falls back to structured section data from `SectionChange` records if LLM generation fails or times out
11. Stores generated summering/kommentar on the amendment's `LegalDocument` record for reuse

### Email Content

12. Email structure per amendment:
    - Amendment title (e.g., "Lag om ändring i arbetsmiljölagen (1977:1160)")
    - SFS number + effective date
    - Summering (neutral, 2-3 sentences: what this amendment does)
    - Kommentar (compliance-focused, "Vi ska..." voice: what you need to do)
    - Section changes list (from `SectionChange` records: "7 kap. 15 § — amended", "2 kap. 5 a § — new")
    - Link to amendment page on Laglig.se (`/lagar/sfs-{year}-{number}`)
    - Link to official Riksdagen PDF
13. Email wrapper:
    - Subject: `Lagändringar: {N} ändringar i lagar du bevakar`
    - From: `Laglig.se <notifications@laglig.se>`
    - Greeting with user name and workspace name
    - Unsubscribe link → notification preferences page
14. Email sent only if ≥1 un-notified amendment exists for that workspace
15. Skips users whose `NotificationPreference` has email disabled (check `email_enabled` and relevant type flags)

### Recipient Resolution

16. Query path: `AmendmentDocument.base_law_sfs` → `LegalDocument.document_number = "SFS {base_law_sfs}"` → `LawListItem.document_id` → `LawList.workspace_id` → `Workspace.members` → `User.email`
17. Deduplicate: if a user is in multiple workspaces that all track the same law, they get one email per workspace (not duplicates)
18. Skip workspaces with no active members

### Reliability

19. Email send failures are logged but don't block processing of other workspaces
20. LLM generation failures fall back to section change list (no summering/kommentar in that email)
21. Cron returns JSON stats: `{ emailsSent, emailsFailed, amendmentsProcessed, contentGenerated, duration }`
22. Admin notification email (existing `sendSfsSyncEmail` pattern) sent with summary stats

## Tasks / Subtasks

- [ ] **Task 1: Create cron route** (AC: 1, 7)
  - [ ] Create `app/api/cron/notify-amendment-changes/route.ts`
  - [ ] Add to `vercel.json` crons: `"0 7 * * *"` (07:00 UTC daily)
  - [ ] Implement auth check, timeout protection, stats tracking
- [ ] **Task 2: Build recipient resolution query** (AC: 16, 17, 18)
  - [ ] Query un-notified amendments via `ChangeEvent` where `notification_sent = false` and `change_type = AMENDMENT`
  - [ ] Join through `LegalDocument` → `LawListItem` → `LawList` → `Workspace` → `WorkspaceMember` → `User`
  - [ ] Group by workspace, deduplicate users
  - [ ] Check `NotificationPreference` for each user (AC: 15)
- [ ] **Task 3: Inline content generation** (AC: 8, 9, 10, 11)
  - [ ] For amendments whose `LegalDocument` has no `summary`/`kommentar`, generate inline using Sonnet
  - [ ] Reuse `buildSystemPrompt()` + `buildDocumentContext()` from `lib/ai/prompts/document-content.ts`
  - [ ] Store results on `LegalDocument.summary` and `LegalDocument.kommentar`
  - [ ] Fallback: skip content generation, email includes only section change list
- [ ] **Task 4: Build email template** (AC: 12, 13, 14)
  - [ ] Create HTML email template (extend existing pattern in `lib/email/cron-notifications.ts`)
  - [ ] Render amendment cards with summering, kommentar, section changes, links
  - [ ] Include unsubscribe link
  - [ ] Test rendering in Gmail/Outlook
- [ ] **Task 5: Wire up end-to-end + mark as notified** (AC: 2, 4, 5, 6)
  - [ ] Main loop: for each workspace batch, render email, send via Resend, mark `ChangeEvent.notification_sent = true`
  - [ ] Error handling per workspace (AC: 19, 20)
  - [ ] Return stats JSON (AC: 21)
- [ ] **Task 6: Admin summary notification** (AC: 22)
  - [ ] Send admin email with cron run stats (reuse `sendSfsSyncEmail` pattern)

## Dev Notes

### Source Tree (relevant files)

```
app/api/cron/sync-sfs-updates/route.ts     — Creates amendments (runs before this cron)
app/api/cron/notify-amendment-changes/      — NEW: this story's cron
lib/ai/prompts/document-content.ts          — buildSystemPrompt(), buildDocumentContext()
lib/email/cron-notifications.ts             — Existing email infra (Resend)
lib/sfs/amendment-to-legal-document.ts      — createLegalDocumentFromAmendment
lib/external/llm-amendment-parser.ts        — parseAmendmentPdf (upstream)
lib/transforms/html-to-markdown.ts          — htmlToMarkdown, htmlToPlainText
lib/transforms/html-to-json.ts             — htmlToJson (SectionChange derivation)
```

### Key Data Models

```
AmendmentDocument
  ├─ sfs_number: "2026:145"
  ├─ base_law_sfs: "1977:1160"        ← join key to find who tracks this law
  ├─ title, effective_date
  ├─ parse_status: COMPLETED
  ├─ full_text, markdown_content
  └─ section_changes: SectionChange[]
       ├─ chapter, section, change_type (AMENDED/NEW/REPEALED)
       ├─ description, new_text

ChangeEvent
  ├─ document_id → LegalDocument (base law)
  ├─ change_type: AMENDMENT
  ├─ amendment_sfs: "SFS 2026:145"
  ├─ notification_sent: false          ← our query filter
  └─ diff_summary

LegalDocument (amendment, content_type=SFS_AMENDMENT)
  ├─ document_number: "SFS 2026:145"
  ├─ html_content, markdown_content, json_content, full_text
  ├─ summary (summering)              ← generated by this cron if missing
  └─ kommentar                        ← generated by this cron if missing

Recipient chain:
  LegalDocument(base law).id
    → LawListItem.document_id
      → LawList.workspace_id
        → Workspace.members[]
          → WorkspaceMember.user_id → User.email
```

### Recipient Resolution Query Pattern

```typescript
// Find workspaces tracking a specific base law
const workspaces = await prisma.workspace.findMany({
  where: {
    law_lists: {
      some: {
        items: {
          some: { document_id: baseLawLegalDocId }
        }
      }
    }
  },
  include: {
    members: {
      include: {
        user: { select: { id: true, email: true, name: true } }
      }
    }
  }
})
```

### Content Generation (inline, Sonnet for speed)

```typescript
import Anthropic from '@anthropic-ai/sdk'
import { buildSystemPrompt, buildDocumentContext } from '@/lib/ai/prompts/document-content'

// For each amendment LegalDocument missing summering/kommentar:
const response = await client.messages.create({
  model: 'claude-sonnet-4-20250514',  // Sonnet for speed (not Opus Batch)
  max_tokens: 2048,
  system: buildSystemPrompt(),
  messages: [{ role: 'user', content: buildDocumentContext(docContext) }],
})
// Parse JSON response → { summering, kommentar }
// Store on LegalDocument.summary + LegalDocument.kommentar
```

### Timing Budget (5 min total)

- Content generation: ~10s per amendment (Sonnet) × max ~15 amendments = ~150s
- Recipient queries: <5s
- Email rendering + sending: ~1s per workspace × max ~50 = ~50s
- Buffer: 30s
- Total: well within 300s

### Email Template Pattern

Follow existing HTML email pattern from `lib/email/cron-notifications.ts`. Key sections:

1. **Header**: Laglig.se branding
2. **Per-amendment card**:
   - Title + SFS number + effective date badge
   - Summering paragraph (if generated)
   - Kommentar paragraph with "Vi ska..." voice (if generated)
   - Section changes as compact list
   - Two links: [Granska på Laglig.se] + [Riksdagen PDF ↗]
3. **Footer**: Unsubscribe link

### Notification Preference Check

```typescript
// Existing model: NotificationPreference (per workspace)
const pref = await prisma.notificationPreference.findFirst({
  where: { user_id: user.id, workspace_id: workspace.id }
})
if (pref && !pref.email_enabled) continue // skip
```

### Testing

**Test location:** `lib/__tests__/notify-amendment-changes.test.ts`

**Test framework:** Vitest with `vi.mock()` for Anthropic, Prisma, Resend

**Unit tests:**
- Recipient resolution: given amendment with `base_law_sfs`, correctly finds workspaces + users
- Content generation: mocked Claude returns `{ summering, kommentar }`, stored on LegalDocument
- Content fallback: when LLM fails, email renders with section changes only (no summering/kommentar)
- Email rendering: given amendment data, produces valid HTML with all required sections
- Notification tracking: `ChangeEvent.notification_sent` set to `true` after send
- Timeout protection: loop breaks when approaching maxDuration
- Deduplication: user in 2 workspaces tracking same law gets 1 email per workspace
- Preference check: user with `email_enabled = false` is skipped

**Integration test (manual):**
```bash
curl -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/cron/notify-amendment-changes
```

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with actual data model, amendment pipeline, Story 12.3 content generation. Supersedes original implementation details. | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
