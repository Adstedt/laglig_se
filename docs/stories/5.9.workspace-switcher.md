# Story 5.9: Build Workspace Switcher (Multi-Workspace Support)

## Status
Draft

## Story

**As a** user,
**I want** to switch between workspaces if I belong to multiple,
**so that** I can manage different companies or act as an auditor.

## Acceptance Criteria

1. Top navigation includes workspace switcher dropdown
2. Dropdown shows all workspaces user belongs to
3. Current workspace highlighted
4. Clicking workspace â†’ Switches context, reloads page
5. Workspace context stored in session (cookie)
6. All queries scoped to active workspace
7. Auditor role can access multiple client workspaces (read-only)
8. "Create New Workspace" option in dropdown
9. Mobile: Workspace switcher in hamburger menu

## Tasks / Subtasks

- [ ] Create workspace switcher dropdown component
- [ ] Fetch all user workspaces
- [ ] Implement workspace switch functionality
- [ ] Store active workspace in cookie
- [ ] Update middleware to use active workspace from cookie
- [ ] Add "Create New Workspace" option
- [ ] Test switching between multiple workspaces
- [ ] Implement mobile version in hamburger menu

## Dev Notes

**Workspace Switcher Component:**
```typescript
// components/navigation/workspace-switcher.tsx
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'

export function WorkspaceSwitcher() {
  const [workspaces, setWorkspaces] = useState<any[]>([])
  const [currentWorkspace, setCurrentWorkspace] = useState<any>(null)
  const [isOpen, setIsOpen] = useState(false)
  const router = useRouter()

  useEffect(() => {
    async function fetchWorkspaces() {
      const response = await fetch('/api/workspaces')
      const data = await response.json()
      setWorkspaces(data.workspaces)
      setCurrentWorkspace(data.current)
    }

    fetchWorkspaces()
  }, [])

  async function switchWorkspace(workspaceId: string) {
    // Set cookie with active workspace
    document.cookie = `active_workspace_id=${workspaceId}; path=/; max-age=31536000` // 1 year

    // Reload page to apply new workspace context
    window.location.reload()
  }

  if (!currentWorkspace) return null

  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors"
      >
        {/* Workspace logo or initial */}
        <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-semibold">
          {currentWorkspace.companyLogo ? (
            <img
              src={currentWorkspace.companyLogo}
              alt={currentWorkspace.name}
              className="w-full h-full rounded-lg object-cover"
            />
          ) : (
            currentWorkspace.name[0].toUpperCase()
          )}
        </div>

        {/* Workspace name */}
        <div className="hidden md:block text-left">
          <p className="text-sm font-medium text-gray-900 max-w-[150px] truncate">
            {currentWorkspace.name}
          </p>
          <p className="text-xs text-gray-500 capitalize">
            {currentWorkspace.role}
          </p>
        </div>

        {/* Dropdown arrow */}
        <svg
          className={`w-4 h-4 text-gray-500 transition-transform ${
            isOpen ? 'rotate-180' : ''
          }`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19 9l-7 7-7-7"
          />
        </svg>
      </button>

      {/* Dropdown */}
      {isOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-10"
            onClick={() => setIsOpen(false)}
          />

          {/* Dropdown menu */}
          <div className="absolute top-full mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 z-20 max-h-96 overflow-y-auto">
            {/* Current workspace */}
            <div className="p-3 border-b border-gray-200">
              <p className="text-xs text-gray-500 mb-2">Current Workspace</p>
              <WorkspaceItem
                workspace={currentWorkspace}
                isCurrent={true}
                onClick={() => setIsOpen(false)}
              />
            </div>

            {/* Other workspaces */}
            {workspaces.filter((w) => w.id !== currentWorkspace.id).length >
              0 && (
              <div className="p-3 border-b border-gray-200">
                <p className="text-xs text-gray-500 mb-2">Switch To</p>
                <div className="space-y-1">
                  {workspaces
                    .filter((w) => w.id !== currentWorkspace.id)
                    .map((workspace) => (
                      <WorkspaceItem
                        key={workspace.id}
                        workspace={workspace}
                        isCurrent={false}
                        onClick={() => switchWorkspace(workspace.id)}
                      />
                    ))}
                </div>
              </div>
            )}

            {/* Create new workspace */}
            <div className="p-3">
              <button
                onClick={() => router.push('/workspace/create')}
                className="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-left"
              >
                <div className="w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center">
                  <svg
                    className="w-5 h-5 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                </div>
                <span className="text-sm font-medium text-gray-700">
                  Create New Workspace
                </span>
              </button>
            </div>
          </div>
        </>
      )}
    </div>
  )
}

function WorkspaceItem({
  workspace,
  isCurrent,
  onClick
}: {
  workspace: any
  isCurrent: boolean
  onClick: () => void
}) {
  return (
    <button
      onClick={onClick}
      className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ${
        isCurrent ? 'bg-blue-50' : 'hover:bg-gray-50'
      }`}
    >
      {/* Logo or initial */}
      <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-semibold flex-shrink-0">
        {workspace.companyLogo ? (
          <img
            src={workspace.companyLogo}
            alt={workspace.name}
            className="w-full h-full rounded-lg object-cover"
          />
        ) : (
          workspace.name[0].toUpperCase()
        )}
      </div>

      {/* Workspace info */}
      <div className="flex-1 text-left min-w-0">
        <p className="text-sm font-medium text-gray-900 truncate">
          {workspace.name}
        </p>
        <p className="text-xs text-gray-500 capitalize">{workspace.role}</p>
      </div>

      {/* Current indicator */}
      {isCurrent && (
        <svg
          className="w-5 h-5 text-blue-600 flex-shrink-0"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fillRule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
            clipRule="evenodd"
          />
        </svg>
      )}
    </button>
  )
}
```

**Fetch User Workspaces API:**
```typescript
// app/api/workspaces/route.ts
export async function GET(request: Request) {
  const session = await getServerSession(authOptions)

  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // Get all workspaces user belongs to
  const memberships = await prisma.workspaceMember.findMany({
    where: {
      userId: session.user.id
    },
    include: {
      workspace: {
        select: {
          id: true,
          name: true,
          companyLogo: true,
          status: true
        }
      }
    },
    orderBy: {
      joinedAt: 'desc'
    }
  })

  const workspaces = memberships.map((m) => ({
    id: m.workspace.id,
    name: m.workspace.name,
    companyLogo: m.workspace.companyLogo,
    status: m.workspace.status,
    role: m.role
  }))

  // Get current active workspace from cookie
  const cookies = request.headers.get('cookie')
  const activeWorkspaceId = cookies
    ?.split('; ')
    .find((c) => c.startsWith('active_workspace_id='))
    ?.split('=')[1]

  const current =
    workspaces.find((w) => w.id === activeWorkspaceId) || workspaces[0]

  return NextResponse.json({
    workspaces,
    current
  })
}
```

**Updated Workspace Context Middleware:**
```typescript
// middleware/workspace-context.ts (updated)
export async function workspaceMiddleware(request: NextRequest) {
  const session = await getSession(request)

  if (!session) {
    return NextResponse.redirect('/login')
  }

  // Get workspace ID from cookie
  let workspaceId = request.cookies.get('active_workspace_id')?.value

  // If no workspace in cookie, get user's first workspace
  if (!workspaceId) {
    const membership = await prisma.workspaceMember.findFirst({
      where: {
        userId: session.userId
      },
      include: {
        workspace: {
          where: {
            status: 'active'
          }
        }
      },
      orderBy: {
        joinedAt: 'desc'
      }
    })

    if (!membership) {
      return NextResponse.redirect('/onboarding')
    }

    workspaceId = membership.workspaceId

    // Set cookie for future requests
    const response = NextResponse.next()
    response.cookies.set('active_workspace_id', workspaceId, {
      maxAge: 31536000, // 1 year
      path: '/'
    })

    return response
  }

  // Verify user has access to this workspace
  const member = await prisma.workspaceMember.findUnique({
    where: {
      workspaceId_userId: {
        workspaceId,
        userId: session.userId
      }
    }
  })

  if (!member) {
    // User doesn't have access - clear cookie and redirect
    const response = NextResponse.redirect('/workspaces')
    response.cookies.delete('active_workspace_id')
    return response
  }

  // Add workspace context to headers
  const response = NextResponse.next()
  response.headers.set('X-Workspace-Id', workspaceId)
  response.headers.set('X-Workspace-Role', member.role)

  return response
}
```

**Create Workspace Page:**
```typescript
// app/workspace/create/page.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'

export default function CreateWorkspacePage() {
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()
  const { register, handleSubmit, formState: { errors } } = useForm()

  async function onSubmit(data: { name: string }) {
    setIsLoading(true)

    try {
      const response = await fetch('/api/workspace/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })

      if (response.ok) {
        const { workspaceId } = await response.json()

        // Set as active workspace
        document.cookie = `active_workspace_id=${workspaceId}; path=/; max-age=31536000`

        // Redirect to dashboard
        router.push('/dashboard')
      } else {
        alert('Failed to create workspace')
      }
    } catch (error) {
      alert('Failed to create workspace')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
        <h1 className="text-2xl font-bold mb-6">Create New Workspace</h1>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">
              Workspace Name
            </label>
            <input
              type="text"
              {...register('name', { required: 'Workspace name is required' })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
              placeholder="Acme Corporation"
            />
            {errors.name && (
              <p className="mt-1 text-sm text-red-600">{errors.name.message}</p>
            )}
          </div>

          <div className="flex gap-3">
            <button
              type="button"
              onClick={() => router.back()}
              className="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={isLoading}
              className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
            >
              {isLoading ? 'Creating...' : 'Create Workspace'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

**Create Workspace API:**
```typescript
// app/api/workspace/create/route.ts
export async function POST(request: Request) {
  const session = await getServerSession(authOptions)

  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { name } = await request.json()

  // Create workspace
  const workspace = await prisma.workspace.create({
    data: {
      name,
      ownerId: session.user.id,
      subscriptionTier: 'trial',
      trialEndsAt: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000), // 14 days
      status: 'active'
    }
  })

  // Add owner as member
  await prisma.workspaceMember.create({
    data: {
      workspaceId: workspace.id,
      userId: session.user.id,
      role: 'owner',
      joinedAt: new Date()
    }
  })

  return NextResponse.json({ workspaceId: workspace.id })
}
```

**Mobile Version:**
```typescript
// Add to mobile hamburger menu
<div className="md:hidden">
  <WorkspaceSwitcher />
</div>
```

**Reference:** PRD Epic 5 Story 5.9, Architecture Section 12 (Multi-Tenancy)

## Testing

**Unit Tests:**
- Fetch workspaces returns all user memberships
- Active workspace stored in cookie correctly
- Workspace switch updates cookie

**Integration Tests:**
- Create 2 workspaces, switch between them
- Verify data isolated per workspace
- Auditor role can access multiple workspaces (read-only)
- Create new workspace from switcher

**Manual Testing:**
- Join 3 workspaces, switch between them
- Verify correct workspace data shown after switch
- Test "Create New Workspace" flow
- Test on mobile (hamburger menu)
- Verify cookie persists across sessions

**Security Testing:**
- Cannot switch to workspace user doesn't belong to
- Cookie tampering doesn't grant unauthorized access

**Test File:** `__tests__/features/workspace/switcher.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**
- Switch between workspaces as needed
- Understand which workspace is currently active
- Create new workspaces when managing multiple companies

**Developer Responsibility:**
- Store active workspace in cookie
- Scope all queries to active workspace
- Verify user has access to requested workspace
- Provide clear indication of current workspace
- Support auditor role (multi-workspace read-only access)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
