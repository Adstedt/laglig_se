# Story 6.10: Add Export Kanban Board as PDF/Image

## Status
Draft

## Story

**As a** user,
**I want** to export my Kanban board,
**so that** I share it with stakeholders or print for audits.

## Acceptance Criteria

1. Export button in Kanban toolbar
2. Export options: PDF, PNG
3. **PDF export:**
   - Renders Kanban board as multi-page PDF
   - Each column on separate page or single wide page
   - Includes workspace logo, date, "Generated by Laglig.se"
4. **PNG export:**
   - Captures visible Kanban board as image
   - High resolution (2x for retina)
5. Download triggered automatically
6. Filename: `Kanban-Board-[Workspace-Name]-[Date].pdf`
7. Watermark: "Laglig.se Compliance Workspace"

## Tasks / Subtasks

- [ ] Add export button to Kanban toolbar
- [ ] Install PDF generation library (jsPDF or similar)
- [ ] Implement PDF export functionality
- [ ] Install screenshot library (html2canvas)
- [ ] Implement PNG export functionality
- [ ] Add workspace logo and branding to exports
- [ ] Add date and watermark to exports
- [ ] Generate appropriate filename
- [ ] Trigger automatic download
- [ ] Test PDF export with multi-page layout
- [ ] Test PNG export with high resolution

## Dev Notes

**Install Libraries:**
```bash
npm install jspdf html2canvas
npm install @types/jspdf --save-dev
```

**Export Button in Toolbar:**
```typescript
// components/kanban/kanban-toolbar.tsx (updated)
'use client'

import { useState } from 'react'
import { ExportMenu } from './export-menu'

export function KanbanToolbar() {
  const [showExportMenu, setShowExportMenu] = useState(false)

  return (
    <div className="bg-white border-b border-gray-200 px-6 py-4">
      <div className="flex items-center justify-between">
        {/* Left: Title */}
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Compliance Workspace</h1>
          <p className="text-sm text-gray-600 mt-1">Manage your compliance progress</p>
        </div>

        {/* Right: Actions */}
        <div className="flex items-center gap-3">
          {/* ... other buttons ... */}

          {/* Export Button */}
          <div className="relative">
            <button
              onClick={() => setShowExportMenu(!showExportMenu)}
              className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
              </svg>
              <span className="text-sm font-medium">Export</span>
            </button>

            {showExportMenu && (
              <ExportMenu onClose={() => setShowExportMenu(false)} />
            )}
          </div>
        </div>
      </div>
    </div>
  )
}
```

**Export Menu Component:**
```typescript
// components/kanban/export-menu.tsx
'use client'

import { useRef, useEffect } from 'react'
import { exportKanbanAsPDF, exportKanbanAsPNG } from '@/lib/kanban/export'

interface ExportMenuProps {
  onClose: () => void
}

export function ExportMenu({ onClose }: ExportMenuProps) {
  const menuRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        onClose()
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [onClose])

  async function handleExportPDF() {
    onClose()
    try {
      await exportKanbanAsPDF()
    } catch (error) {
      console.error('Failed to export PDF:', error)
      alert('Failed to export PDF. Please try again.')
    }
  }

  async function handleExportPNG() {
    onClose()
    try {
      await exportKanbanAsPNG()
    } catch (error) {
      console.error('Failed to export PNG:', error)
      alert('Failed to export PNG. Please try again.')
    }
  }

  return (
    <div
      ref={menuRef}
      className="absolute right-0 top-full mt-2 w-48 bg-white border border-gray-300 rounded-lg shadow-lg z-10"
    >
      <button
        onClick={handleExportPDF}
        className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 first:rounded-t-lg"
      >
        <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
          />
        </svg>
        <div>
          <p className="text-sm font-medium text-gray-900">Export as PDF</p>
          <p className="text-xs text-gray-500">Multi-page document</p>
        </div>
      </button>

      <button
        onClick={handleExportPNG}
        className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 last:rounded-b-lg"
      >
        <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
          />
        </svg>
        <div>
          <p className="text-sm font-medium text-gray-900">Export as PNG</p>
          <p className="text-xs text-gray-500">High-resolution image</p>
        </div>
      </button>
    </div>
  )
}
```

**PDF Export Function:**
```typescript
// lib/kanban/export.ts
import jsPDF from 'jspdf'
import html2canvas from 'html2canvas'

export async function exportKanbanAsPDF() {
  // Show loading indicator
  const loadingEl = document.createElement('div')
  loadingEl.className =
    'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
  loadingEl.innerHTML = `
    <div class="bg-white rounded-lg p-6 text-center">
      <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-700">Generating PDF...</p>
    </div>
  `
  document.body.appendChild(loadingEl)

  try {
    // Get Kanban board element
    const kanbanBoard = document.querySelector('.kanban-board-container') as HTMLElement
    if (!kanbanBoard) {
      throw new Error('Kanban board not found')
    }

    // Capture Kanban board as canvas
    const canvas = await html2canvas(kanbanBoard, {
      scale: 2, // High resolution
      useCORS: true,
      logging: false
    })

    // Create PDF
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    })

    // Calculate dimensions
    const imgWidth = 297 // A4 landscape width in mm
    const imgHeight = (canvas.height * imgWidth) / canvas.width

    // Add image to PDF
    const imgData = canvas.toDataURL('image/png')
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight)

    // Add header
    pdf.setFontSize(16)
    pdf.setTextColor(31, 41, 55) // gray-800
    pdf.text('Compliance Workspace', 10, 10)

    // Add date
    pdf.setFontSize(10)
    pdf.setTextColor(107, 114, 128) // gray-500
    pdf.text(`Generated on ${new Date().toLocaleDateString()}`, 10, 16)

    // Add watermark
    pdf.setFontSize(8)
    pdf.setTextColor(156, 163, 175) // gray-400
    pdf.text('Generated by Laglig.se', 10, imgHeight + 5)

    // Get workspace name for filename
    const workspaceName = getWorkspaceName() || 'Workspace'
    const date = new Date().toISOString().split('T')[0]
    const filename = `Kanban-Board-${workspaceName}-${date}.pdf`

    // Download PDF
    pdf.save(filename)
  } finally {
    // Remove loading indicator
    document.body.removeChild(loadingEl)
  }
}
```

**PNG Export Function:**
```typescript
// lib/kanban/export.ts (continued)
export async function exportKanbanAsPNG() {
  // Show loading indicator
  const loadingEl = document.createElement('div')
  loadingEl.className =
    'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
  loadingEl.innerHTML = `
    <div class="bg-white rounded-lg p-6 text-center">
      <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-700">Generating image...</p>
    </div>
  `
  document.body.appendChild(loadingEl)

  try {
    // Get Kanban board element
    const kanbanBoard = document.querySelector('.kanban-board-container') as HTMLElement
    if (!kanbanBoard) {
      throw new Error('Kanban board not found')
    }

    // Capture Kanban board as canvas
    const canvas = await html2canvas(kanbanBoard, {
      scale: 2, // High resolution (2x for retina)
      useCORS: true,
      logging: false,
      backgroundColor: '#F9FAFB' // gray-50
    })

    // Convert canvas to blob
    canvas.toBlob((blob) => {
      if (!blob) {
        throw new Error('Failed to generate image')
      }

      // Create download link
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      const workspaceName = getWorkspaceName() || 'Workspace'
      const date = new Date().toISOString().split('T')[0]
      link.download = `Kanban-Board-${workspaceName}-${date}.png`
      link.href = url
      link.click()

      // Cleanup
      URL.revokeObjectURL(url)
    })
  } finally {
    // Remove loading indicator
    document.body.removeChild(loadingEl)
  }
}

function getWorkspaceName(): string {
  // Get workspace name from page or context
  const titleEl = document.querySelector('h1')
  return titleEl?.textContent?.replace(/[^a-zA-Z0-9-]/g, '-') || 'Workspace'
}
```

**Updated Kanban Board Container:**
```typescript
// components/kanban/kanban-board.tsx (updated)
export async function KanbanBoard() {
  const lawsByStatus = await getWorkspaceLawsByStatus()
  const columns = await getKanbanColumns()

  return (
    <div className="kanban-board-container h-full p-6 overflow-x-auto" data-export="true">
      <div className="hidden md:flex gap-4 h-full min-w-max">
        {columns.map((column) => (
          <KanbanColumn
            key={column.id}
            id={column.id}
            label={column.label}
            color={column.color}
            laws={lawsByStatus[column.id] || []}
          />
        ))}
      </div>
    </div>
  )
}
```

**Alternative: Server-Side PDF Generation (for better quality):**
```typescript
// app/api/workspace/export-kanban-pdf/route.ts
import puppeteer from 'puppeteer'

export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, workspace }) => {
    // Launch headless browser
    const browser = await puppeteer.launch()
    const page = await browser.newPage()

    // Set viewport to capture full board
    await page.setViewport({ width: 1920, height: 1080 })

    // Navigate to Kanban board (with authentication)
    const kanbanUrl = `${process.env.NEXT_PUBLIC_APP_URL}/workspace?export=true`
    await page.goto(kanbanUrl, { waitUntil: 'networkidle0' })

    // Generate PDF
    const pdf = await page.pdf({
      format: 'A4',
      landscape: true,
      printBackground: true,
      margin: {
        top: '20mm',
        right: '10mm',
        bottom: '20mm',
        left: '10mm'
      }
    })

    await browser.close()

    // Return PDF as download
    return new Response(pdf, {
      headers: {
        'Content-Type': 'application/pdf',
        'Content-Disposition': `attachment; filename="Kanban-Board-${workspace.name}-${Date.now()}.pdf"`
      }
    })
  })
}
```

**Export-Friendly Styles:**
```css
/* For clean export without interactive elements */
@media print {
  .kanban-board-container {
    overflow: visible !important;
  }

  .kanban-column {
    page-break-inside: avoid;
  }

  /* Hide interactive elements during export */
  button,
  .drag-handle,
  .checkbox {
    display: none !important;
  }
}

[data-export='true'] button,
[data-export='true'] .checkbox {
  display: none !important;
}
```

**Reference:** PRD Epic 6 Story 6.10, jsPDF documentation, html2canvas documentation

## Testing

**Unit Tests:**
- Export button opens menu
- Menu closes on click outside
- Filename generated correctly with workspace name and date

**Integration Tests:**
- Export as PDF, verify PDF downloaded with correct filename
- Export as PNG, verify PNG downloaded with correct filename
- PDF includes workspace logo and date
- PNG captures board at high resolution (2x)

**Manual Testing:**
- Click Export → PDF, verify PDF downloaded
- Open PDF, verify board rendered correctly
- Click Export → PNG, verify PNG downloaded
- Open PNG, verify high resolution (no blurriness)
- Verify watermark "Laglig.se Compliance Workspace" visible
- Test with 100+ law cards, verify all captured

**Performance Testing:**
- PDF generation completes <10 seconds for 100 cards
- PNG generation completes <5 seconds
- No memory leaks during export

**Browser Compatibility:**
- Test PDF export in Chrome, Firefox, Safari
- Test PNG export in Chrome, Firefox, Safari
- Verify automatic download triggered in all browsers

**Test File:** `__tests__/features/kanban/export.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Choose export format (PDF or PNG)
- Share exported files with stakeholders
- Print PDF for audits or meetings

**Developer Responsibility:**
- Generate high-quality PDF/PNG exports
- Include branding (logo, watermark)
- Add date and workspace name to exports
- Trigger automatic download
- Hide interactive elements in exports (buttons, checkboxes)
- Optimize export performance (<10 seconds)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
