# Story 6.8: Implement Evidence Upload System

## Status

Draft

## Story

**As a** user,
**I want** to attach evidence files to tasks,
**so that** I can prove compliance work was completed.

## Acceptance Criteria

1. Evidence upload in Task Modal right panel
2. Drag-and-drop zone + "Valj fil" button
3. **Accepted file types:** PDF, PNG, JPG, JPEG, GIF, DOC, DOCX, XLS, XLSX, PPT, PPTX
4. **Max file size:** 25MB per file
5. **Max files per task:** 20
6. Files uploaded to Supabase Storage
7. Progress indicator during upload
8. File metadata stored: filename, size, type, uploader, upload_date, task_id
9. Preview capability:
   - Images: Inline preview
   - PDFs: Thumbnail + open in new tab
   - Office docs: Icon + download
10. Download button for all files
11. Delete button (with confirmation, only uploader or admin)
12. Evidence list shows in Legal Document Modal -> Bevis tab (aggregated from all tasks)

**Storage Organization:**

13. Path: `/{workspace_id}/evidence/{task_id}/{filename}`
14. Access control via Supabase RLS (workspace members only)

## Tasks / Subtasks

_To be detailed during sprint planning_

- [ ] Create evidence table in database
- [ ] Configure Supabase Storage bucket with RLS
- [ ] Build drag-and-drop upload zone component
- [ ] Implement file type validation
- [ ] Add upload progress indicator
- [ ] Build file preview components (image, PDF, Office)
- [ ] Implement download functionality
- [ ] Add delete with confirmation
- [ ] Aggregate evidence in Legal Document Modal

## Dev Notes

### Data Model

```sql
evidence
  - id UUID PRIMARY KEY
  - task_id UUID REFERENCES tasks(id)
  - filename VARCHAR(255)
  - storage_path VARCHAR(500)
  - file_size INTEGER
  - mime_type VARCHAR(100)
  - uploaded_by_id UUID REFERENCES users(id)
  - created_at TIMESTAMP
```

### Supabase Storage Setup

```sql
-- Create bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('evidence', 'evidence', false);

-- RLS policy: workspace members only
CREATE POLICY "Workspace members can access evidence"
ON storage.objects FOR ALL
USING (
  bucket_id = 'evidence' AND
  (storage.foldername(name))[1] IN (
    SELECT id::text FROM workspaces
    WHERE id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  )
);
```

### File Locations

```
components/features/tasks/
  evidence-upload/
    dropzone.tsx
    file-preview.tsx
    evidence-list.tsx
lib/storage/
  evidence.ts  -- upload, download, delete helpers
```

## Testing

- Unit tests for file validation
- E2E tests for upload flow
- Test RLS access control
- Test preview for different file types

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-01-08 | 1.0     | Initial story creation | Sarah (PO) |
