# Story 6.10: Implement Audit Trail & Change Log

## Status

Draft

## Story

**As a** user,
**I want** a complete audit trail of all compliance activities,
**so that** I can demonstrate accountability during audits.

## Acceptance Criteria

**List Item History (Legal Document Modal -> Historik):**

1. Log entries for:
   - Status changes (old -> new)
   - Responsible person changes
   - Business context edits
   - Task created/completed/deleted
   - Evidence uploaded/deleted
2. Entry format: User + Action + Details + Timestamp

**Task History (Task Modal -> Historik tab):**

3. Log entries for:
   - Status changes
   - Assignee changes
   - Due date changes
   - Priority changes
   - Description edits (diff optional)
   - Evidence added/removed
   - Linked laws added/removed

**Global Activity Log:**

4. Admin page: `/workspace/activity`
5. Filterable by: user, action type, date range, list/law
6. Exportable as CSV for audit purposes
7. Retention: 2 years minimum

**Database Schema:**

8. `activity_log` table: id, workspace_id, user_id, entity_type, entity_id, action, old_value, new_value, created_at
9. Indexed for fast querying by workspace + date range

## Tasks / Subtasks

_To be detailed during sprint planning_

- [ ] Create activity_log table with proper indexes
- [ ] Build activity logging service/utility
- [ ] Instrument all compliance actions to log
- [ ] Create history display component for modals
- [ ] Build global activity log page
- [ ] Add filters (user, action type, date range)
- [ ] Implement CSV export
- [ ] Set up data retention policy

## Dev Notes

### Data Model

```sql
activity_log
  - id UUID PRIMARY KEY
  - workspace_id UUID REFERENCES workspaces(id)
  - user_id UUID REFERENCES users(id)
  - entity_type VARCHAR(50)  -- 'list_item', 'task', 'comment', 'evidence'
  - entity_id UUID
  - action VARCHAR(50)  -- 'created', 'updated', 'deleted', 'status_changed', etc.
  - old_value JSONB
  - new_value JSONB
  - created_at TIMESTAMP

-- Indexes for query performance
CREATE INDEX idx_activity_log_workspace_date ON activity_log(workspace_id, created_at DESC);
CREATE INDEX idx_activity_log_entity ON activity_log(entity_type, entity_id);
```

### Logging Service Pattern

```typescript
// lib/services/activity-logger.ts
export async function logActivity(params: {
  workspaceId: string
  userId: string
  entityType: 'list_item' | 'task' | 'comment' | 'evidence'
  entityId: string
  action: string
  oldValue?: Record<string, unknown>
  newValue?: Record<string, unknown>
}) {
  // Insert into activity_log table
}
```

### File Locations

```
app/(workspace)/workspace/activity/
  page.tsx
components/features/activity/
  activity-log-table.tsx
  activity-filters.tsx
  activity-entry.tsx
lib/services/
  activity-logger.ts
```

## Testing

- Unit tests for logging service
- E2E tests for activity log page
- Test CSV export
- Test filter combinations

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-01-08 | 1.0     | Initial story creation | Sarah (PO) |
