# Story 5.6: Build Add-On Purchase System

## Status

Draft

## Story

**As a** user,
**I want** to purchase add-ons instead of upgrading my entire tier,
**so that** I can grow incrementally.

## Context & Dependencies

- **Depends on:** Story 5.4 (Stripe billing) — needs active Stripe subscription
- **Depends on:** Story 5.5 (usage limits) — add-ons extend these limits
- **Note:** Uses `requirePermission('workspace:billing')` for billing operations.

## Acceptance Criteria

1. Add-ons defined:
   - +10 employees: EUR 100/month
   - +5GB storage: EUR 50/month
2. Billing page shows "Tillagg" section
3. User can toggle add-ons on/off
4. Clicking "Lagg till" -> Stripe creates additional subscription item
5. Add-on pricing prorated (charged immediately for current billing period)
6. Add-ons included in usage limit calculations (via `getEffectiveLimits()`)
7. Example: Team tier (50 employees) + 2x add-ons = 70 employee limit
8. Stripe webhook updates add-on status
9. Invoice line items show base tier + add-ons separately

## Tasks / Subtasks

- [ ] Create Stripe Products for add-ons
- [ ] Create `WorkspaceAddOn` Prisma model
- [ ] Build add-ons UI section on billing page
- [ ] Implement add-on purchase API
- [ ] Implement add-on removal API
- [ ] Update usage limit calculations to include add-ons (`getEffectiveLimits`)
- [ ] Handle proration in Stripe
- [ ] Sync add-on status via webhooks
- [ ] Test add-on purchase and removal lifecycle

## Dev Notes

**Database Schema:**

```prisma
model WorkspaceAddOn {
  id              String   @id @default(uuid())
  workspaceId     String
  addOnId         String   // employees_10, storage_5gb
  quantity        Int      @default(1)
  stripeItemId    String?  // Stripe subscription item ID
  activatedAt     DateTime @default(now())
  deactivatedAt   DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, addOnId])
  @@map("workspace_addons")
}
```

**Add-On Config:**

```typescript
// lib/addons/config.ts
export interface AddOn {
  id: string
  name: string
  description: string
  priceMonthly: number
  stripePriceId: string
  benefit: { type: 'employees' | 'storage'; amount: number }
}

export const AVAILABLE_ADDONS: AddOn[] = [
  {
    id: 'employees_10',
    name: '+10 anstallda',
    description: 'Lagg till kapacitet for 10 fler anstallda',
    priceMonthly: 100,
    stripePriceId: process.env.STRIPE_ADDON_EMPLOYEES_PRICE_ID!,
    benefit: { type: 'employees', amount: 10 },
  },
  {
    id: 'storage_5gb',
    name: '+5GB lagring',
    description: 'Lagg till 5GB extra lagring',
    priceMonthly: 50,
    stripePriceId: process.env.STRIPE_ADDON_STORAGE_PRICE_ID!,
    benefit: { type: 'storage', amount: 5 },
  },
]
```

**Add-On Purchase API:**

```typescript
// app/api/billing/addons/route.ts
import { NextResponse } from 'next/server'
import { getWorkspaceContext } from '@/lib/auth/workspace-context'
import { requirePermission } from '@/lib/api/require-permission'
import { stripe } from '@/lib/stripe/config'
import { prisma } from '@/lib/prisma'
import { AVAILABLE_ADDONS } from '@/lib/addons/config'

export async function GET() {
  const context = await getWorkspaceContext()

  const addons = await prisma.workspaceAddOn.findMany({
    where: { workspaceId: context.workspaceId, deactivatedAt: null },
  })

  return NextResponse.json({ addons })
}

export async function POST(request: Request) {
  const denied = await requirePermission('workspace:billing')
  if (denied) return denied

  const context = await getWorkspaceContext()
  const { addOnId, quantity } = await request.json()

  const addon = AVAILABLE_ADDONS.find((a) => a.id === addOnId)
  if (!addon) {
    return NextResponse.json({ error: 'Ogiltigt tillagg' }, { status: 400 })
  }

  const workspace = await prisma.workspace.findUnique({
    where: { id: context.workspaceId },
    select: { stripeSubscriptionId: true },
  })

  if (!workspace?.stripeSubscriptionId) {
    return NextResponse.json({ error: 'Ingen aktiv prenumeration' }, { status: 400 })
  }

  const subscriptionItem = await stripe.subscriptionItems.create({
    subscription: workspace.stripeSubscriptionId,
    price: addon.stripePriceId,
    quantity,
    proration_behavior: 'always_invoice',
  })

  await prisma.workspaceAddOn.create({
    data: {
      workspaceId: context.workspaceId,
      addOnId,
      quantity,
      stripeItemId: subscriptionItem.id,
    },
  })

  return NextResponse.json({ success: true })
}
```

**Remove Add-On API:**

```typescript
// app/api/billing/addons/[addOnId]/route.ts
export async function DELETE(
  request: Request,
  { params }: { params: { addOnId: string } }
) {
  const denied = await requirePermission('workspace:billing')
  if (denied) return denied

  const context = await getWorkspaceContext()

  const addon = await prisma.workspaceAddOn.findFirst({
    where: {
      workspaceId: context.workspaceId,
      addOnId: params.addOnId,
      deactivatedAt: null,
    },
  })

  if (!addon) {
    return NextResponse.json({ error: 'Tillagg hittades inte' }, { status: 404 })
  }

  if (addon.stripeItemId) {
    await stripe.subscriptionItems.del(addon.stripeItemId, {
      proration_behavior: 'always_invoice',
    })
  }

  await prisma.workspaceAddOn.update({
    where: { id: addon.id },
    data: { deactivatedAt: new Date() },
  })

  return NextResponse.json({ success: true })
}
```

**Updated Usage Limits with Add-Ons:**

```typescript
// lib/usage/limits.ts (add this function)
export async function getEffectiveLimits(workspaceId: string): Promise<UsageLimits> {
  const workspace = await prisma.workspace.findUnique({
    where: { id: workspaceId },
    include: { addons: { where: { deactivatedAt: null } } },
  })

  if (!workspace) throw new Error('Workspace not found')

  const baseLimits = getLimits(workspace.subscription_tier)
  const effectiveLimits = { ...baseLimits }

  for (const addon of workspace.addons) {
    const addOnConfig = AVAILABLE_ADDONS.find((a) => a.id === addon.addOnId)
    if (!addOnConfig) continue

    const totalBenefit = addOnConfig.benefit.amount * addon.quantity

    if (addOnConfig.benefit.type === 'employees' && effectiveLimits.employees !== null) {
      effectiveLimits.employees += totalBenefit
    } else if (addOnConfig.benefit.type === 'storage' && effectiveLimits.storageGB !== null) {
      effectiveLimits.storageGB += totalBenefit
    }
  }

  return effectiveLimits
}
```

**Reference:** Story 5.4 (Stripe config), Story 5.5 (usage limits), `lib/auth/permissions.ts` (`workspace:billing`)

## Testing

**Unit Tests:**

- `getEffectiveLimits()` calculates correctly with add-ons
- Add-on benefits accumulate (2x employee add-ons = +20 employees)
- Storage add-ons convert correctly

**Integration Tests:**

- Purchase employee add-on, verify usage limit increases
- Remove add-on, verify limit decreases
- Proration charges correctly
- Webhook syncs add-on status

**Test File:** `tests/unit/billing/addons.test.ts`

## Change Log

| Date       | Version | Description                         | Author     |
| ---------- | ------- | ----------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation              | Sarah (PO) |
| 2026-02-19 | 2.0     | Updated auth patterns, Swedish text | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
