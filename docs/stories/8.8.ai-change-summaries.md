# Story 8.8: Implement AI Change Summaries

## Status

Draft

## Story

**As a** user,
**I want** to see plain-language summaries of law changes,
**so that** I understand the impact without reading legal jargon.

## Acceptance Criteria

1. **GPT-4 generates summary when change detected:**
   - Triggered automatically by change detection cron job
   - Prompt: "Summarize this law change in 1-2 sentences for a business owner. Focus on practical impact."
   - Output in Swedish

2. **Summary stored in `law_changes.ai_summary`**

3. **Generation completes within 5 minutes (NFR11)**

4. **Hallucination check:**
   - Verify claims in summary appear in diff
   - Regenerate if hallucination detected
   - Fallback: "Ändring upptäckt. Se detaljer för mer information."

5. **Summary displayed in:**
   - Changes tab (change cards)
   - Diff modal (at top)
   - Daily digest emails
   - Weekly digest emails
   - Reminder emails

6. **Business Impact Assessment:**
   - GPT-4 also generates `business_impact` field
   - Categories: "Action required by [date]", "FYI only - reference update", "Review for compliance", "High impact - legal advice recommended"

7. **Contextual Explanation (optional):**
   - If change affects specific section (e.g., "§ 26"), generate explanation of what that section handles
   - Stored in `law_changes.contextual_explanation`

8. **Retry logic:**
   - If OpenAI API fails, retry up to 3 times with exponential backoff
   - If all retries fail, use fallback text

9. **Cost control:**
   - Use GPT-4 for high/medium priority changes
   - Use GPT-3.5-Turbo for low-priority changes
   - Track token usage

## Tasks / Subtasks

- [ ] Create AI summary generation function
- [ ] Integrate with change detection cron job
- [ ] Implement hallucination check logic
- [ ] Generate business impact assessment
- [ ] Generate contextual explanation for sections
- [ ] Add retry logic with exponential backoff
- [ ] Implement cost control (model selection by priority)
- [ ] Store summaries in database
- [ ] Test with various change types
- [ ] Verify Swedish output quality
- [ ] Test hallucination detection
- [ ] Monitor token usage and costs

## Dev Notes

**AI Summary Generation Function:**

```typescript
// lib/law-changes/generate-ai-summary.ts
import OpenAI from 'openai'

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

interface AISummaryResult {
  aiSummary: string
  businessImpact: string
  contextualExplanation?: string
}

export async function generateAISummary(
  oldContent: string,
  newContent: string,
  lawTitle: string,
  lawSfsNummer: string,
  priority: 'high' | 'medium' | 'low',
  affectedSections?: string[]
): Promise<AISummaryResult> {
  // Select model based on priority (cost control)
  const model = priority === 'low' ? 'gpt-3.5-turbo' : 'gpt-4'

  try {
    const response = await openai.chat.completions.create({
      model,
      messages: [
        {
          role: 'system',
          content: `Du är en expert på svensk lagstiftning. Din uppgift är att sammanfatta lagändringar på ett sätt som företagare förstår. Använd enkelt språk och fokusera på praktisk påverkan.`,
        },
        {
          role: 'user',
          content: `Lag: ${lawTitle} (${lawSfsNummer})

Tidigare version:
${oldContent}

Ny version:
${newContent}

Sammanfatta ändringen i 1-2 meningar på svenska. Fokusera på vad som ändrades och hur det påverkar företag praktiskt.`,
        },
      ],
      temperature: 0.3,
      max_tokens: 150,
    })

    const aiSummary = response.choices[0].message.content?.trim() || ''

    // Hallucination check
    if (!verifyClaimsInDiff(aiSummary, oldContent, newContent)) {
      console.warn(
        `Hallucination detected in summary for ${lawSfsNummer}. Regenerating...`
      )
      // Retry with more explicit prompt
      return await regenerateSummaryWithStricterPrompt(
        oldContent,
        newContent,
        lawTitle,
        lawSfsNummer,
        model
      )
    }

    // Generate business impact
    const businessImpact = await generateBusinessImpact(
      aiSummary,
      lawTitle,
      priority,
      model
    )

    // Generate contextual explanation if specific sections affected
    let contextualExplanation: string | undefined
    if (affectedSections && affectedSections.length > 0) {
      contextualExplanation = await generateContextualExplanation(
        affectedSections[0],
        newContent.substring(0, 500),
        lawTitle,
        model
      )
    }

    return {
      aiSummary:
        aiSummary || 'Ändring upptäckt. Se detaljer för mer information.',
      businessImpact,
      contextualExplanation,
    }
  } catch (error) {
    console.error('Failed to generate AI summary:', error)
    return {
      aiSummary: 'Ändring upptäckt. Se detaljer för mer information.',
      businessImpact: 'Kräver granskning',
    }
  }
}

function verifyClaimsInDiff(
  summary: string,
  oldContent: string,
  newContent: string
): boolean {
  // Basic hallucination check: ensure key terms in summary appear in diff
  const summaryWords = summary
    .toLowerCase()
    .split(/\s+/)
    .filter((word) => word.length > 4) // Focus on meaningful words

  const diffContent = (oldContent + ' ' + newContent).toLowerCase()

  // At least 60% of key words should appear in diff
  const foundWords = summaryWords.filter((word) => diffContent.includes(word))
  const accuracy = foundWords.length / summaryWords.length

  return accuracy >= 0.6
}

async function regenerateSummaryWithStricterPrompt(
  oldContent: string,
  newContent: string,
  lawTitle: string,
  lawSfsNummer: string,
  model: string
): Promise<AISummaryResult> {
  try {
    const response = await openai.chat.completions.create({
      model,
      messages: [
        {
          role: 'system',
          content: `Du är en expert på svensk lagstiftning. Sammanfatta ENDAST vad som faktiskt ändrades mellan de två versionerna. Hitta inte på information som inte finns i texten.`,
        },
        {
          role: 'user',
          content: `Lag: ${lawTitle} (${lawSfsNummer})

Tidigare version:
${oldContent}

Ny version:
${newContent}

Beskriv exakt vad som ändrades, utan att spekulera eller lägga till extra information. 1-2 meningar på svenska.`,
        },
      ],
      temperature: 0.1, // Lower temperature for less creativity
      max_tokens: 100,
    })

    const aiSummary =
      response.choices[0].message.content?.trim() ||
      'Ändring upptäckt. Se detaljer för mer information.'
    const businessImpact = await generateBusinessImpact(
      aiSummary,
      lawTitle,
      'medium',
      model
    )

    return { aiSummary, businessImpact }
  } catch (error) {
    console.error('Failed to regenerate summary:', error)
    return {
      aiSummary: 'Ändring upptäckt. Se detaljer för mer information.',
      businessImpact: 'Kräver granskning',
    }
  }
}

async function generateBusinessImpact(
  aiSummary: string,
  lawTitle: string,
  priority: 'high' | 'medium' | 'low',
  model: string
): Promise<string> {
  try {
    const response = await openai.chat.completions.create({
      model,
      messages: [
        {
          role: 'system',
          content: `Du är en expert på svensk lagstiftning. Baserat på en lagändring, bedöm den praktiska påverkan för företag. Kategorisera som: "Åtgärd krävs senast [datum]", "FYI - endast referensändring", "Granska för efterlevnad", eller "Hög påverkan - överväg juridisk rådgivning".`,
        },
        {
          role: 'user',
          content: `Lag: ${lawTitle}
Sammanfattning av ändring: ${aiSummary}

Beskriv den praktiska påverkan för företag i en kort mening.`,
        },
      ],
      temperature: 0.3,
      max_tokens: 50,
    })

    return response.choices[0].message.content?.trim() || 'Kräver granskning'
  } catch (error) {
    console.error('Failed to generate business impact:', error)
    return 'Kräver granskning'
  }
}

async function generateContextualExplanation(
  sectionNumber: string,
  sectionContent: string,
  lawTitle: string,
  model: string
): Promise<string> {
  try {
    const response = await openai.chat.completions.create({
      model,
      messages: [
        {
          role: 'system',
          content: `Du är en expert på svensk lagstiftning. Förklara vad en specifik paragraf i en lag hanterar, på ett sätt som företagare förstår.`,
        },
        {
          role: 'user',
          content: `Lag: ${lawTitle}
Paragraf: ${sectionNumber}
Innehåll: ${sectionContent}

Beskriv i en mening vad denna paragraf hanterar.`,
        },
      ],
      temperature: 0.3,
      max_tokens: 80,
    })

    return (
      response.choices[0].message.content?.trim() || `${sectionNumber} ändrades`
    )
  } catch (error) {
    console.error('Failed to generate contextual explanation:', error)
    return `${sectionNumber} ändrades`
  }
}

// Retry wrapper with exponential backoff
export async function generateAISummaryWithRetry(
  oldContent: string,
  newContent: string,
  lawTitle: string,
  lawSfsNummer: string,
  priority: 'high' | 'medium' | 'low',
  affectedSections?: string[],
  maxRetries = 3
): Promise<AISummaryResult> {
  let lastError: Error | null = null

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await generateAISummary(
        oldContent,
        newContent,
        lawTitle,
        lawSfsNummer,
        priority,
        affectedSections
      )
    } catch (error) {
      lastError = error as Error
      console.error(`AI summary generation attempt ${attempt} failed:`, error)

      if (attempt < maxRetries) {
        // Exponential backoff: 2^attempt seconds
        const backoffMs = Math.pow(2, attempt) * 1000
        console.log(`Retrying in ${backoffMs}ms...`)
        await new Promise((resolve) => setTimeout(resolve, backoffMs))
      }
    }
  }

  console.error(
    `All ${maxRetries} attempts failed for ${lawSfsNummer}:`,
    lastError
  )

  // Return fallback
  return {
    aiSummary: 'Ändring upptäckt. Se detaljer för mer information.',
    businessImpact: 'Kräver granskning',
  }
}
```

**Integration with Change Detection Cron:**

```typescript
// app/api/cron/detect-law-changes/route.ts (excerpt)
import { generateAISummaryWithRetry } from '@/lib/law-changes/generate-ai-summary'

async function detectAndStoreChange(
  law: any,
  oldContent: string,
  newContent: string
) {
  // Determine priority (logic from Story 8.1)
  const priority = determinePriority(oldContent, newContent)

  // Extract affected sections
  const affectedSections = extractAffectedSections(oldContent, newContent)

  // Generate AI summary
  const { aiSummary, businessImpact, contextualExplanation } =
    await generateAISummaryWithRetry(
      oldContent,
      newContent,
      law.rubrik,
      law.sfsNummer,
      priority,
      affectedSections
    )

  // Store change
  await prisma.lawChange.create({
    data: {
      lawId: law.id,
      changeType: 'amendment',
      priority,
      detectedAt: new Date(),
      oldContent,
      newContent,
      diffContent: generateDiff(oldContent, newContent),
      aiSummary,
      businessImpact,
      contextualExplanation,
      affectedSections,
    },
  })

  console.log(`Change detected and summarized for ${law.sfsNummer}`)
}

function extractAffectedSections(
  oldContent: string,
  newContent: string
): string[] {
  // Extract section numbers mentioned in diff (e.g., "§ 26", "6 kap. 17 §")
  const sectionPattern = /§\s*\d+|(\d+\s*kap\.\s*\d+\s*§)/g
  const mentions = newContent.match(sectionPattern) || []
  return [...new Set(mentions)] // Unique sections
}
```

**Database Schema (already exists from Story 8.1):**

```prisma
model LawChange {
  id                    String   @id @default(uuid())
  lawId                 String
  changeType            String   // amendment, new_section, repeal, metadata
  priority              String   // high, medium, low
  detectedAt            DateTime
  acknowledgedAt        DateTime?
  acknowledgedBy        String?
  oldContent            String   @db.Text
  newContent            String   @db.Text
  diffContent           String   @db.Text
  aiSummary             String?  @db.Text
  businessImpact        String?
  contextualExplanation String?
  affectedSections      String[]
  officialSourceUrl     String?
  effectiveDate         DateTime?

  law Law @relation(fields: [lawId], references: [id])

  @@index([lawId, acknowledgedAt])
  @@index([detectedAt])
  @@map("law_changes")
}
```

**Cost Tracking:**

```typescript
// lib/analytics/track-openai-usage.ts
import { prisma } from '@/lib/prisma'

export async function trackOpenAIUsage(
  feature: string,
  model: string,
  promptTokens: number,
  completionTokens: number
) {
  const totalTokens = promptTokens + completionTokens

  // Estimate cost (GPT-4: $0.03/1K input, $0.06/1K output; GPT-3.5-Turbo: $0.0015/1K input, $0.002/1K output)
  const inputCost =
    model === 'gpt-4'
      ? (promptTokens / 1000) * 0.03
      : (promptTokens / 1000) * 0.0015

  const outputCost =
    model === 'gpt-4'
      ? (completionTokens / 1000) * 0.06
      : (completionTokens / 1000) * 0.002

  const totalCost = inputCost + outputCost

  await prisma.openAIUsageLog.create({
    data: {
      feature,
      model,
      promptTokens,
      completionTokens,
      totalTokens,
      estimatedCost: totalCost,
      timestamp: new Date(),
    },
  })
}
```

**Reference:** PRD Epic 8 Story 8.8, NFR11 (AI summary generation <5 minutes)

## Testing

**Unit Tests:**

- AI summary generated in Swedish
- Summary is 1-2 sentences
- Business impact assessment generated
- Contextual explanation generated for sections
- Hallucination check detects false claims
- Retry logic works with exponential backoff
- Fallback text used when all retries fail

**Integration Tests:**

- AI summary generated during change detection cron
- Summary stored in `law_changes.ai_summary`
- Business impact stored in `law_changes.business_impact`
- Contextual explanation stored in `law_changes.contextual_explanation`
- Summary displayed in Changes tab
- Summary displayed in diff modal
- Summary included in emails

**Manual Testing:**

- Trigger change detection for real law change
- Verify AI summary is accurate and in Swedish
- Verify business impact makes sense
- Verify contextual explanation clarifies section purpose
- Test with high-priority change (uses GPT-4)
- Test with low-priority change (uses GPT-3.5-Turbo)
- Manually inject hallucination, verify regeneration

**Quality Testing:**

- Read 20+ AI summaries, verify accuracy
- Check for hallucinations (claims not in diff)
- Verify Swedish grammar and spelling
- Ensure summaries are concise (not too long)
- Verify business impact categorization is appropriate

**Performance Testing:**

- AI summary generation completes <5 seconds per change
- Hallucination check completes <1 second
- Retry logic doesn't exceed 30 seconds total (3 retries)
- Cost per summary: GPT-4 ~$0.01, GPT-3.5-Turbo ~$0.001

**Cost Testing:**

- Track token usage for 100 summaries
- Verify high/medium priority uses GPT-4
- Verify low priority uses GPT-3.5-Turbo
- Estimate monthly cost for 1000 changes/month

**Edge Cases:**

- Very long diff (10,000+ characters) (truncate for prompt)
- Very short diff (1 word change) (summary: "Minor textual correction")
- Diff in English (translate or note language)
- OpenAI API down (retry, then fallback)
- Rate limit exceeded (retry with backoff)

**Test File:** `__tests__/features/law-changes/ai-summary.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Read AI summaries to understand changes quickly
- Verify AI summary by viewing full diff if unsure
- Report inaccurate summaries for improvement

**Developer Responsibility:**

- Generate accurate AI summaries in plain Swedish
- Focus summaries on practical business impact
- Implement hallucination checks to prevent false claims
- Provide fallback text if AI fails
- Optimize costs by using appropriate model for priority
- Generate summaries within 5 minutes (NFR11)
- Retry failed generations with exponential backoff
- Track token usage and costs for budgeting
- Store summaries in database for reuse
- Display summaries prominently in UI and emails
- Continuously improve prompts based on feedback
- Monitor summary quality through spot checks

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
