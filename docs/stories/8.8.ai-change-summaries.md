# Story 8.8: AI Content Enrichment for Amendments

## Status

Draft (v2 — radically restructured: replaces standalone OpenAI summary system with integration into Story 12.3 content generation pipeline)

## Story

**As a** system process running after amendment detection,
**I want** all parsed amendments to have AI-generated summering and kommentar on their LegalDocument records,
**so that** downstream consumers (Changes Tab, email notifications, diff views) have rich content to display without generating it on-the-fly.

## Context & Dependencies

**Supersedes:** The original Story 8.8 proposed a standalone OpenAI-based summary system (GPT-4 for high priority, GPT-3.5-Turbo for low). This is **entirely replaced** by the proven Story 12.3 summering/kommentar pipeline using Anthropic Claude.

**Builds on:**

- Story 12.3 content generation pipeline — `lib/ai/prompts/document-content.ts` with `buildSystemPrompt()` and `buildDocumentContext()`
- `sync-sfs-updates` cron — creates `AmendmentDocument` + `SectionChange` + `LegalDocument` (content_type=SFS_AMENDMENT)
- `AmendmentDocument.parse_status = COMPLETED` — indicates amendment is ready for enrichment
- `LegalDocument.summary` (summering) and `LegalDocument.kommentar` — target fields for AI content
- Hallucination checking — `lib/ai/prompts/document-content.ts` uses Haiku 4.5 for claim verification

**Relationship to Story 8.4:**

Story 8.4 (email notifications) performs inline content generation for amendments missing summering/kommentar at notification time. This story provides a **dedicated background enrichment process** that runs BEFORE the notification cron, ensuring content is pre-generated and ready.

**Key insight:** The "business impact" concept from the old Story 8.8 maps directly to the Kommentar voice ("Vi ska...", "Vi behover...") from the 12.3 pipeline. No separate "business impact" field is needed.

## Acceptance Criteria

### Background Enrichment Cron

1. New cron endpoint at `/api/cron/enrich-amendment-content` runs daily at 05:00 UTC (after sync-sfs-updates at 04:30, before notify-amendment-changes at 07:00)
2. `maxDuration = 300` with 30s timeout buffer
3. Finds `AmendmentDocument` records with `parse_status = COMPLETED` whose corresponding `LegalDocument` (content_type=SFS_AMENDMENT) has `summary IS NULL` or `kommentar IS NULL`

### Content Generation

4. Uses `buildSystemPrompt()` and `buildDocumentContext()` from `lib/ai/prompts/document-content.ts` — the same proven prompts as Story 12.3
5. Uses Anthropic Claude Sonnet for speed (must complete within cron timeout)
6. Generates both `summering` (neutral, 2-3 sentences) and `kommentar` ("Vi ska..." compliance voice, 2-3 sentences)
7. Stores results on the amendment's `LegalDocument.summary` and `LegalDocument.kommentar`

### ChangeEvent AI Summary

8. For each enriched amendment, also update the corresponding `ChangeEvent.ai_summary` with a condensed 1-sentence summary (derived from summering)
9. This enables the Changes Tab (Story 8.1) and Notification Bell (Story 8.5) to show quick summaries without loading the full LegalDocument

### Hallucination Check

10. Run hallucination check using existing Haiku 4.5 checker from the 12.3 pipeline
11. If unsupported claims detected, regenerate with stricter prompt
12. If second attempt also fails, store summering/kommentar as-is but flag the LegalDocument with a metadata note

### Fallback & Reliability

13. If LLM generation fails or times out for a specific amendment, skip it (will be retried next cron run or handled inline by Story 8.4)
14. Cron returns JSON stats: `{ enriched, skipped, failed, alreadyHadContent, duration }`
15. CronJobRun record created for monitoring
16. Admin notification email with stats (reuse `sendSfsSyncEmail` pattern)

## Tasks / Subtasks

- [ ] **Task 1: Create enrichment cron route** (AC: 1, 2)
  - [ ] Create `app/api/cron/enrich-amendment-content/route.ts`
  - [ ] Add to `vercel.json` crons: `"0 5 * * *"` (05:00 UTC daily)
  - [ ] Auth check + timeout protection with 30s buffer
- [ ] **Task 2: Find un-enriched amendments** (AC: 3)
  - [ ] Query AmendmentDocument where parse_status=COMPLETED
  - [ ] Join to LegalDocument where summary IS NULL or kommentar IS NULL
  - [ ] Order by created_at ASC (oldest first)
- [ ] **Task 3: Generate summering + kommentar** (AC: 4, 5, 6, 7)
  - [ ] For each un-enriched amendment, call Claude Sonnet with 12.3 prompts
  - [ ] Parse JSON response: `{ summering, kommentar }`
  - [ ] Store on LegalDocument.summary and LegalDocument.kommentar
- [ ] **Task 4: Update ChangeEvent.ai_summary** (AC: 8, 9)
  - [ ] Find ChangeEvent where amendment_sfs matches
  - [ ] Set ai_summary to condensed version of summering
- [ ] **Task 5: Hallucination check** (AC: 10, 11, 12)
  - [ ] Run Haiku 4.5 checker on generated content
  - [ ] Regenerate if claims flagged
  - [ ] Flag in metadata if second attempt also flagged
- [ ] **Task 6: Stats + monitoring** (AC: 13, 14, 15, 16)
  - [ ] Track enriched/skipped/failed counts
  - [ ] Create CronJobRun record
  - [ ] Send admin email with stats

## Dev Notes

### Source Tree (relevant files)

```
lib/ai/prompts/document-content.ts          — buildSystemPrompt(), buildDocumentContext() (THE source of truth)
app/api/cron/sync-sfs-updates/route.ts      — Creates AmendmentDocument + LegalDocument (upstream)
app/api/cron/notify-amendment-changes/       — Story 8.4 (downstream consumer, also does inline generation)
lib/sfs/amendment-to-legal-document.ts       — createLegalDocumentFromAmendment
prisma/schema.prisma                        — AmendmentDocument, LegalDocument, ChangeEvent, CronJobRun
```

### Key Data Models

```
AmendmentDocument
  ├─ sfs_number: "2026:145"
  ├─ parse_status: COMPLETED
  ├─ full_text, markdown_content
  └─ section_changes: SectionChange[]

LegalDocument (amendment, content_type=SFS_AMENDMENT)
  ├─ document_number: "SFS 2026:145"
  ├─ summary: null       ← TARGET: store summering here
  ├─ kommentar: null      ← TARGET: store kommentar here
  └─ html_content, markdown_content, full_text

ChangeEvent
  ├─ amendment_sfs: "SFS 2026:145"
  ├─ ai_summary: null     ← TARGET: store condensed summary here
  └─ diff_summary
```

### Content Generation Pattern

```typescript
import Anthropic from '@anthropic-ai/sdk'
import { buildSystemPrompt, buildDocumentContext } from '@/lib/ai/prompts/document-content'

const response = await client.messages.create({
  model: 'claude-sonnet-4-20250514',  // Sonnet for speed
  max_tokens: 2048,
  system: buildSystemPrompt(),
  messages: [{ role: 'user', content: buildDocumentContext(docContext) }],
})
// Parse JSON → { summering, kommentar }
```

### Cron Execution Order (daily)

```
04:30 UTC  sync-sfs-updates     → Detects amendments, creates AmendmentDocument + LegalDocument
05:00 UTC  enrich-amendment-content (THIS STORY) → Generates summering/kommentar on LegalDocuments
07:00 UTC  notify-amendment-changes (Story 8.4) → Sends emails (uses pre-generated content, or generates inline if missing)
```

### Timing Budget (5 min total)

- Query un-enriched amendments: <5s
- Content generation: ~10s per amendment (Sonnet) x max ~15 amendments = ~150s
- Hallucination checks: ~3s per amendment x ~15 = ~45s
- ChangeEvent updates: <5s
- Buffer: 30s
- Total: well within 300s

## Testing

**Test location:** `tests/unit/lib/cron/enrich-amendment-content.test.ts`

**Test framework:** Vitest with `vi.mock()` for Anthropic, Prisma

**Unit tests:**
- Finds AmendmentDocuments with COMPLETED status and missing summering/kommentar
- Calls buildSystemPrompt/buildDocumentContext with correct amendment context
- Stores summering on LegalDocument.summary
- Stores kommentar on LegalDocument.kommentar
- Updates ChangeEvent.ai_summary with condensed version
- Skips amendments that already have content
- Handles LLM failure gracefully (skips, logs, continues)
- CronJobRun record created with correct stats

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation (standalone OpenAI-based summaries)     | Sarah (PO) |
| 2026-02-09 | 2.0     | Radical restructure: replace OpenAI approach with Story 12.3 pipeline integration. Now a background enrichment cron. | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
