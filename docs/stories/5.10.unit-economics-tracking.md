# Story 5.10: Implement Unit Economics Tracking (NFR18 - CRITICAL)

## Status
Draft

## Story

**As a** product owner,
**I want** to track costs per workspace to validate business model,
**so that** I ensure gross margin >80%.

## Acceptance Criteria

1. `workspace_costs` table tracks: workspace_id, month, ai_api_cost, vector_query_cost, storage_cost, total_cost
2. AI API costs logged per query (OpenAI/Anthropic pricing)
3. Vector query costs calculated (Supabase pricing or estimated)
4. Storage costs calculated based on GB used
5. Monthly cron job aggregates costs per workspace
6. Analytics dashboard shows:
   - Revenue per workspace (subscription MRR)
   - Cost per workspace (AI + storage)
   - Gross margin % (target >80%)
   - Cohort analysis: Margin by tier (Solo vs Team vs Enterprise)
7. Email report sent to founder weekly
8. Alerting: If any workspace margin <60%, flag for review
9. Cost optimization recommendations: "Switch to cheaper embedding model for workspace X"

## Tasks / Subtasks

- [ ] Create workspace_costs table
- [ ] Log AI API costs per query
- [ ] Calculate vector query costs
- [ ] Calculate storage costs
- [ ] Create monthly cost aggregation cron job
- [ ] Build unit economics dashboard
- [ ] Implement weekly email report
- [ ] Add alerting for low-margin workspaces
- [ ] Generate cost optimization recommendations

## Dev Notes

**Database Schema:**
```prisma
model WorkspaceCost {
  id               String   @id @default(uuid())
  workspaceId      String
  month            DateTime // First day of month
  aiApiCost        Float    @default(0) // â‚¬
  vectorQueryCost  Float    @default(0) // â‚¬
  storageCost      Float    @default(0) // â‚¬
  totalCost        Float    @default(0) // â‚¬
  revenue          Float    @default(0) // â‚¬ (subscription MRR)
  grossMargin      Float?   // %
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, month])
  @@index([month])
  @@map("workspace_costs")
}

model ApiCostLog {
  id              String   @id @default(uuid())
  workspaceId     String
  endpoint        String   // /api/chat/query, /api/embeddings, etc.
  model           String   // gpt-4, text-embedding-3-small
  inputTokens     Int
  outputTokens    Int
  cost            Float    // â‚¬ calculated based on model pricing
  timestamp       DateTime @default(now())

  @@index([workspaceId, timestamp])
  @@map("api_cost_logs")
}
```

**Pricing Constants:**
```typescript
// lib/costs/pricing.ts

// OpenAI pricing (as of 2025)
export const OPENAI_PRICING = {
  'gpt-4': {
    input: 0.03 / 1000, // â‚¬0.03 per 1K tokens
    output: 0.06 / 1000 // â‚¬0.06 per 1K tokens
  },
  'gpt-4-turbo': {
    input: 0.01 / 1000,
    output: 0.03 / 1000
  },
  'text-embedding-3-small': {
    input: 0.00002 / 1000, // â‚¬0.00002 per 1K tokens
    output: 0
  }
}

// Supabase pricing (estimated)
export const VECTOR_QUERY_COST_PER_QUERY = 0.0001 // â‚¬0.0001 per query

// Storage pricing (estimated)
export const STORAGE_COST_PER_GB_MONTH = 0.02 // â‚¬0.02 per GB per month

export function calculateAICost(
  model: string,
  inputTokens: number,
  outputTokens: number
): number {
  const pricing = OPENAI_PRICING[model as keyof typeof OPENAI_PRICING]
  if (!pricing) return 0

  return (
    pricing.input * inputTokens +
    pricing.output * outputTokens
  )
}
```

**Log AI API Cost:**
```typescript
// lib/costs/log-api-cost.ts

export async function logAPIcost({
  workspaceId,
  endpoint,
  model,
  inputTokens,
  outputTokens
}: {
  workspaceId: string
  endpoint: string
  model: string
  inputTokens: number
  outputTokens: number
}) {
  const cost = calculateAICost(model, inputTokens, outputTokens)

  await prisma.apiCostLog.create({
    data: {
      workspaceId,
      endpoint,
      model,
      inputTokens,
      outputTokens,
      cost
    }
  })

  return cost
}
```

**Usage in AI Query:**
```typescript
// app/api/chat/query/route.ts (updated)
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId }) => {
    const { query } = await request.json()

    // ... existing RAG logic ...

    // Call OpenAI
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: query }
      ]
    })

    const answer = completion.choices[0].message.content

    // Log API cost
    await logAPIcost({
      workspaceId,
      endpoint: '/api/chat/query',
      model: 'gpt-4',
      inputTokens: completion.usage!.prompt_tokens,
      outputTokens: completion.usage!.completion_tokens
    })

    return NextResponse.json({ answer })
  })
}
```

**Monthly Cost Aggregation Cron:**
```typescript
// lib/cron/aggregate-costs.ts
import cron from 'node-cron'

export function scheduleMonthlyCostAggregation() {
  // Run on 1st of every month at 03:00 UTC
  cron.schedule('0 3 1 * *', async () => {
    console.log('Aggregating monthly costs...')

    const now = new Date()
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1)

    const workspaces = await prisma.workspace.findMany({
      where: { status: 'active' }
    })

    for (const workspace of workspaces) {
      // Aggregate AI API costs
      const aiCosts = await prisma.apiCostLog.aggregate({
        where: {
          workspaceId: workspace.id,
          timestamp: {
            gte: lastMonth,
            lt: new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 1)
          }
        },
        _sum: {
          cost: true
        }
      })

      // Calculate vector query costs (estimate based on usage)
      const usage = await prisma.workspaceUsage.findUnique({
        where: { workspaceId: workspace.id }
      })

      const vectorQueryCost = (usage?.aiQueriesThisMonth || 0) * VECTOR_QUERY_COST_PER_QUERY

      // Calculate storage costs
      const storageCost = ((usage?.storageUsedMb || 0) / 1024) * STORAGE_COST_PER_GB_MONTH

      // Calculate total cost
      const aiApiCost = aiCosts._sum.cost || 0
      const totalCost = aiApiCost + vectorQueryCost + storageCost

      // Get revenue (subscription MRR)
      const revenue = getTierMRR(workspace.subscriptionTier)

      // Calculate gross margin
      const grossMargin = revenue > 0 ? ((revenue - totalCost) / revenue) * 100 : 0

      // Store in database
      await prisma.workspaceCost.upsert({
        where: {
          workspaceId_month: {
            workspaceId: workspace.id,
            month: lastMonth
          }
        },
        update: {
          aiApiCost,
          vectorQueryCost,
          storageCost,
          totalCost,
          revenue,
          grossMargin
        },
        create: {
          workspaceId: workspace.id,
          month: lastMonth,
          aiApiCost,
          vectorQueryCost,
          storageCost,
          totalCost,
          revenue,
          grossMargin
        }
      })

      console.log(
        `Workspace ${workspace.id}: Revenue â‚¬${revenue.toFixed(2)}, Cost â‚¬${totalCost.toFixed(2)}, Margin ${grossMargin.toFixed(1)}%`
      )

      // Alert if margin < 60%
      if (grossMargin < 60) {
        await sendLowMarginAlert(workspace, grossMargin, totalCost, revenue)
      }
    }

    console.log('Monthly cost aggregation complete')
  })
}

function getTierMRR(tier: string): number {
  const mrr: Record<string, number> = {
    trial: 0,
    solo: 399,
    team: 899,
    enterprise: 2000 // Estimated
  }

  return mrr[tier] || 0
}
```

**Unit Economics Dashboard:**
```typescript
// components/admin/unit-economics-dashboard.tsx
'use client'

import { useEffect, useState } from 'react'

export function UnitEconomicsDashboard() {
  const [data, setData] = useState<any>(null)

  useEffect(() => {
    async function fetchData() {
      const response = await fetch('/api/admin/unit-economics')
      const data = await response.json()
      setData(data)
    }

    fetchData()
  }, [])

  if (!data) return <div>Loading...</div>

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">Unit Economics</h1>

      {/* Key Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <MetricCard
          title="Average Margin"
          value={`${data.averageMargin.toFixed(1)}%`}
          target=">80%"
          isGood={data.averageMargin > 80}
        />
        <MetricCard
          title="Total MRR"
          value={`â‚¬${data.totalMRR.toFixed(0)}`}
        />
        <MetricCard
          title="Total Costs"
          value={`â‚¬${data.totalCosts.toFixed(0)}`}
        />
        <MetricCard
          title="Low Margin Workspaces"
          value={data.lowMarginCount}
          isGood={data.lowMarginCount === 0}
        />
      </div>

      {/* Margin by Tier */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-lg font-semibold mb-4">Margin by Tier</h2>
        <div className="space-y-3">
          {data.marginByTier.map((tier: any) => (
            <div key={tier.tier}>
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm font-medium capitalize">{tier.tier}</span>
                <span className="text-sm text-gray-600">
                  {tier.margin.toFixed(1)}% â€¢ {tier.count} workspaces
                </span>
              </div>
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div
                  className={`h-full ${
                    tier.margin > 80
                      ? 'bg-green-500'
                      : tier.margin > 60
                      ? 'bg-yellow-500'
                      : 'bg-red-500'
                  }`}
                  style={{ width: `${tier.margin}%` }}
                />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Low Margin Workspaces */}
      {data.lowMarginWorkspaces.length > 0 && (
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4 text-red-600">
            Low Margin Workspaces (<60%)
          </h2>
          <div className="space-y-3">
            {data.lowMarginWorkspaces.map((workspace: any) => (
              <div
                key={workspace.id}
                className="p-4 border border-red-200 rounded-lg"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="font-medium">{workspace.name}</p>
                    <p className="text-sm text-gray-600 capitalize">
                      {workspace.tier} â€¢ {workspace.margin.toFixed(1)}% margin
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="text-sm font-medium">
                      â‚¬{workspace.revenue.toFixed(0)} MRR
                    </p>
                    <p className="text-sm text-red-600">
                      â‚¬{workspace.cost.toFixed(2)} cost
                    </p>
                  </div>
                </div>
                {workspace.recommendation && (
                  <p className="mt-2 text-xs text-gray-600">
                    ðŸ’¡ {workspace.recommendation}
                  </p>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

function MetricCard({
  title,
  value,
  target,
  isGood
}: {
  title: string
  value: string | number
  target?: string
  isGood?: boolean
}) {
  return (
    <div className="bg-white rounded-lg shadow p-6">
      <p className="text-sm text-gray-600 mb-1">{title}</p>
      <p className={`text-3xl font-bold ${isGood !== undefined ? (isGood ? 'text-green-600' : 'text-red-600') : ''}`}>
        {value}
      </p>
      {target && <p className="text-xs text-gray-500 mt-1">Target: {target}</p>}
    </div>
  )
}
```

**Weekly Email Report:**
```typescript
// lib/email/send-unit-economics-report.ts

export async function sendWeeklyUnitEconomicsReport() {
  const data = await getUnitEconomicsData()

  await sendEmail({
    to: process.env.FOUNDER_EMAIL!,
    subject: `Unit Economics Report - ${new Date().toLocaleDateString()}`,
    html: `
      <h1>Weekly Unit Economics Report</h1>

      <h2>Key Metrics</h2>
      <ul>
        <li>Average Margin: ${data.averageMargin.toFixed(1)}% (Target: >80%)</li>
        <li>Total MRR: â‚¬${data.totalMRR.toFixed(0)}</li>
        <li>Total Costs: â‚¬${data.totalCosts.toFixed(0)}</li>
        <li>Low Margin Workspaces: ${data.lowMarginCount}</li>
      </ul>

      <h2>Margin by Tier</h2>
      <ul>
        ${data.marginByTier.map((tier: any) => `
          <li>${tier.tier}: ${tier.margin.toFixed(1)}% (${tier.count} workspaces)</li>
        `).join('')}
      </ul>

      ${data.lowMarginWorkspaces.length > 0 ? `
        <h2>Low Margin Workspaces</h2>
        <ul>
          ${data.lowMarginWorkspaces.map((ws: any) => `
            <li>${ws.name}: ${ws.margin.toFixed(1)}% (â‚¬${ws.cost.toFixed(2)} cost / â‚¬${ws.revenue.toFixed(0)} revenue)</li>
          `).join('')}
        </ul>
      ` : ''}

      <p><a href="${process.env.NEXT_PUBLIC_APP_URL}/admin/unit-economics">View Full Report</a></p>
    `
  })
}

// Schedule weekly email
cron.schedule('0 9 * * 1', () => {
  // Every Monday at 9am
  sendWeeklyUnitEconomicsReport()
})
```

**Reference:** PRD Epic 5 Story 5.10 (NFR18), Architecture Section 18 (Cost Management)

## Testing

**Unit Tests:**
- `calculateAICost()` returns correct cost for each model
- Cost aggregation sums correctly
- Gross margin calculation is accurate

**Integration Tests:**
- Log AI query, verify cost logged
- Run monthly aggregation, verify costs calculated
- Low margin alert triggered when margin <60%

**Manual Testing:**
- Generate 100 AI queries, verify costs tracked
- Check unit economics dashboard shows accurate data
- Verify weekly email report sent
- Test cost optimization recommendations

**Performance Testing:**
- Cost logging doesn't slow down queries
- Monthly aggregation completes in <10 minutes

**Test File:** `__tests__/features/costs/unit-economics.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**
- (Founder only) Monitor unit economics dashboard
- Review low-margin workspaces
- Implement cost optimization recommendations

**Developer Responsibility:**
- Log all AI API costs accurately
- Calculate vector query and storage costs
- Aggregate costs monthly
- Alert on low margins
- Provide cost optimization recommendations
- Send weekly reports to founder

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
