# Story 11.4: User Management

## Status

Draft

## Story

**As an** admin,
**I want** to browse and search all users on the platform,
**so that** I can look up customer information and understand their workspace memberships.

## Acceptance Criteria

1. User list page at `/admin/users`
2. Searchable data table (TanStack Table) with columns: Name, Email, Last Login, Workspace Count, Created Date
3. Search by name or email (server-side filtering via query params)
4. Sortable by any column (server-side sorting)
5. Paginated (25 per page, server-side)
6. Click a user row to navigate to detail view at `/admin/users/[id]`
7. Detail view shows:
   - User info (name, email, avatar URL, created date, last login — formatted as relative time)
   - Workspace memberships table (workspace name, role, subscription tier, joined date)
   - "Logga in som användare" (Impersonate) button — placeholder only, implemented in Story 11.5
8. Read-only — no user editing from admin (users manage their own profile)

## Tasks / Subtasks

- [ ] **Task 1: Create user list query** (AC: 2, 3, 4, 5)
  - [ ] Add to `lib/admin/queries.ts`:
  - [ ] `getUserList(params)` — accepts `{ search?: string, sortBy?: string, sortDir?: 'asc' | 'desc', page?: number, pageSize?: number }`
  - [ ] Build dynamic Prisma `where` clause:
    - If `search`: match against `name` or `email` using `contains` (case-insensitive via `mode: 'insensitive'`)
  - [ ] Return `{ data: UserListItem[], total: number, page: number, pageSize: number }`
  - [ ] Use `select` to fetch: id, name, email, last_login_at, created_at, `_count: { select: { workspaces: true } }`
  - [ ] Default sort: `created_at` desc

- [ ] **Task 2: Create user detail query** (AC: 7)
  - [ ] Add to `lib/admin/queries.ts`:
  - [ ] `getUserDetail(id: string)` — returns user with:
    - User fields: id, name, email, avatar_url, created_at, last_login_at
    - Workspace memberships via `workspaces` relation:
      ```typescript
      workspaces: {
        select: {
          role: true,
          created_at: true,
          workspace: {
            select: { id: true, name: true, slug: true, subscription_tier: true, status: true }
          }
        }
      }
      ```

- [ ] **Task 3: Create user list page** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `app/admin/(dashboard)/users/page.tsx` — Server Component
  - [ ] Read search/sort/page from `searchParams`
  - [ ] Call `getUserList()` with parsed params
  - [ ] Render `UserTable` client component with data
  - [ ] Create `components/admin/user-table.tsx` — `'use client'` component:
    - TanStack Table following same pattern as `workspace-table.tsx` from Story 11.3
    - Search input at top (debounced, updates URL search params)
    - Column header sorting
    - Pagination controls
    - Row click navigates to `/admin/users/${row.id}`
    - Format `last_login_at` as relative time ("3 timmar sedan") or "Aldrig" if null

- [ ] **Task 4: Create user detail page** (AC: 6, 7, 8)
  - [ ] Create `app/admin/(dashboard)/users/[id]/page.tsx` — Server Component
  - [ ] Fetch user detail via `getUserDetail(id)`
  - [ ] Show 404 if user not found
  - [ ] Render user info section (Card with key-value pairs):
    - Name, Email, Avatar (image or placeholder), Created date, Last login (relative)
  - [ ] Render workspace memberships table (shadcn/ui Table):
    - Columns: Workspace Name (link to `/admin/workspaces/${id}`), Role (Swedish label), Tier (badge), Status (badge), Joined date
  - [ ] Render disabled "Logga in som användare" button with tooltip "Kommer i nästa story" — placeholder for Story 11.5
  - [ ] If user has no workspace memberships, show "Inga workspace-medlemskap" message

- [ ] **Task 5: Testing** (AC: all)
  - **Automated (Vitest)** — extend `tests/unit/lib/admin/queries.test.ts`:
  - [ ] Test: `getUserList()` with no filters returns paginated results
  - [ ] Test: `getUserList()` with search filters by name/email
  - [ ] Test: `getUserList()` pagination returns correct total and page
  - [ ] Test: `getUserDetail()` returns user with workspace memberships
  - [ ] Test: `getUserDetail()` returns null for non-existent user
  - **Manual:**
  - [ ] Test: search and paginate user list
  - [ ] Test: click user → detail view loads with memberships
  - [ ] Test: workspace links in detail view navigate correctly
  - [ ] Test: user with no workspaces shows empty state

## Dev Notes

### Dependencies

- **Blocked by:** Story 11.1 (Admin Auth & Shell Layout) — requires admin auth and layout shell
- **Independent of:** Stories 11.3, 11.6, 11.7
- **Blocks:** Story 11.5 (User Impersonation) — impersonate button placed on user detail page

### Architecture Context

This page follows the exact same pattern as Story 11.3 (Workspace Management) for the TanStack Table. Reuse the same URL search params pattern for server-side filtering and pagination.

### Relevant Source Tree

```
app/admin/(dashboard)/
  users/
    page.tsx                          # NEW: User list page
    [id]/
      page.tsx                        # NEW: User detail page

components/admin/
  user-table.tsx                      # NEW: 'use client' TanStack Table

lib/admin/
  queries.ts                          # EXTEND: Add getUserList(), getUserDetail()

# REFERENCE FILES:
prisma/schema.prisma
  - User model (line ~20): id, name, email, avatar_url, last_login_at, created_at
  - WorkspaceMember model (line ~103): user_id, workspace_id, role, created_at
  - Workspace model (line ~57): name, slug, subscription_tier, status
components/admin/workspace-table.tsx  # REFERENCE: TanStack Table pattern from Story 11.3
```

### Key Implementation Details

1. **TanStack Table reuse.** The table pattern from Story 11.3 should be followed exactly — same URL search param management, same debounced search, same pagination controls. Consider extracting shared table utilities (pagination, search input) into `components/admin/table-controls.tsx` if the duplication is significant.

2. **Role labels in Swedish** (reuse from Story 10.3):

   ```typescript
   const ROLE_LABELS: Record<WorkspaceRole, string> = {
     OWNER: 'Ägare',
     ADMIN: 'Administratör',
     HR_MANAGER: 'HR-ansvarig',
     MEMBER: 'Medlem',
     AUDITOR: 'Revisor',
   }
   ```

3. **Last login formatting:**

   ```typescript
   import { formatDistanceToNow } from 'date-fns'
   import { sv } from 'date-fns/locale'

   function formatLastLogin(date: Date | null): string {
     if (!date) return 'Aldrig'
     return formatDistanceToNow(date, { addSuffix: true, locale: sv })
   }
   ```

4. **Cross-linking.** Workspace names in the user detail view should link to `/admin/workspaces/${workspaceId}` so the admin can navigate between users and workspaces seamlessly.

5. **Impersonate button placeholder.** Add a disabled `Button` with `variant="outline"` and text "Logga in som användare". Story 11.5 will enable it and add the action.

### Coding Standards

- Server-side data fetching in Server Components [Source: architecture/17-coding-standards.md#17.3]
- TanStack Table for data tables (same pattern as 11.3) [Source: architecture/3-tech-stack.md]
- shadcn/ui components: Card, Table, Badge, Button [Source: architecture/17-coding-standards.md#17.3]
- Prisma `select` for selective field fetching [Source: architecture/17-coding-standards.md#17.7]
- Date formatting with `date-fns` + Swedish locale [Source: architecture/3-tech-stack.md — date-fns 3.3+]

### Testing

- **Test file location**: `tests/unit/lib/admin/queries.test.ts` (extend)
- **Testing framework**: Vitest [Source: architecture/17-coding-standards.md]
- **Mock strategy**: Mock `prisma` for query tests
- **Manual**: Full table interaction (search, sort, paginate), user detail view, cross-links to workspaces

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-02-02 | 1.0     | Initial story creation | Sarah (PO) |
