# Story 6.3: Implement Law Card Modal (Detailed View)

## Status
Draft

## Story

**As a** user,
**I want** to click a law card to see full details and add notes,
**so that** I can manage that law's compliance.

## Acceptance Criteria

1. Clicking law card opens modal
2. Modal displays:
   - Law title, SFS number
   - Category badge
   - AI summary (200 words)
   - Current status (column)
   - Priority dropdown (High/Medium/Low)
   - Assigned employees (multi-select dropdown)
   - Due date picker (optional)
   - Notes textarea (markdown supported)
   - Tags input (custom tags)
3. "View Full Law" link → Opens individual law page
4. "Ask AI About This" button → Opens chat with law pre-loaded in context
5. "Save" button persists changes
6. "Close" or ESC key closes modal
7. Modal mobile-responsive (full-screen on mobile)

## Tasks / Subtasks

- [ ] Create law card modal component
- [ ] Fetch law details with all metadata
- [ ] Implement priority dropdown with update logic
- [ ] Build employee multi-select dropdown
- [ ] Add due date picker component
- [ ] Implement notes textarea with markdown support
- [ ] Create tags input with autocomplete
- [ ] Add "View Full Law" link
- [ ] Implement "Ask AI About This" button
- [ ] Create save/update API endpoint
- [ ] Add ESC key handler to close modal
- [ ] Implement mobile full-screen layout
- [ ] Add loading and error states

## Dev Notes

**Law Card Modal Component:**
```typescript
// components/kanban/law-card-modal.tsx
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import ReactMarkdown from 'react-markdown'
import { DatePicker } from '@/components/ui/date-picker'
import { EmployeeSelect } from '@/components/ui/employee-select'
import { TagsInput } from '@/components/ui/tags-input'

interface LawCardModalProps {
  workspaceLawId: string
  onClose: () => void
}

export function LawCardModal({ workspaceLawId, onClose }: LawCardModalProps) {
  const router = useRouter()
  const [lawData, setLawData] = useState<any>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [isSaving, setIsSaving] = useState(false)

  // Form state
  const [status, setStatus] = useState('')
  const [priority, setPriority] = useState<'high' | 'medium' | 'low' | null>(null)
  const [assignedEmployees, setAssignedEmployees] = useState<string[]>([])
  const [dueDate, setDueDate] = useState<Date | null>(null)
  const [notes, setNotes] = useState('')
  const [tags, setTags] = useState<string[]>([])
  const [isNotesPreview, setIsNotesPreview] = useState(false)

  useEffect(() => {
    fetchLawData()

    // ESC key handler
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose()
    }
    window.addEventListener('keydown', handleEsc)
    return () => window.removeEventListener('keydown', handleEsc)
  }, [workspaceLawId])

  async function fetchLawData() {
    setIsLoading(true)
    try {
      const response = await fetch(`/api/workspace-laws/${workspaceLawId}`)
      const data = await response.json()

      setLawData(data)
      setStatus(data.status)
      setPriority(data.priority)
      setAssignedEmployees(data.assignedEmployees.map((e: any) => e.id))
      setDueDate(data.dueDate ? new Date(data.dueDate) : null)
      setNotes(data.notes || '')
      setTags(data.tags || [])
    } catch (error) {
      console.error('Failed to fetch law data:', error)
    } finally {
      setIsLoading(false)
    }
  }

  async function handleSave() {
    setIsSaving(true)
    try {
      const response = await fetch(`/api/workspace-laws/${workspaceLawId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          priority,
          assignedEmployees,
          dueDate,
          notes,
          tags
        })
      })

      if (response.ok) {
        onClose()
        // Refresh page to show updated data
        router.refresh()
      } else {
        alert('Failed to save changes')
      }
    } catch (error) {
      alert('Failed to save changes')
    } finally {
      setIsSaving(false)
    }
  }

  if (isLoading) {
    return <ModalSkeleton onClose={onClose} />
  }

  if (!lawData) {
    return null
  }

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 bg-black bg-opacity-50 z-40"
        onClick={onClose}
      />

      {/* Modal */}
      <div className="fixed inset-0 md:inset-auto md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-4xl md:max-h-[90vh] bg-white md:rounded-lg shadow-xl z-50 overflow-hidden flex flex-col">
        {/* Modal Header */}
        <div className="px-6 py-4 border-b border-gray-200 flex items-start justify-between">
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-2">
              {/* Category Badge */}
              <span className="px-2 py-1 text-xs font-medium rounded bg-blue-100 text-blue-700">
                {lawData.category}
              </span>
              {/* Status Badge */}
              <span className={`px-2 py-1 text-xs font-medium rounded ${getStatusColor(status)}`}>
                {status.replace(/_/g, ' ')}
              </span>
            </div>
            <h2 className="text-xl font-bold text-gray-900 mb-1">
              {lawData.lawTitle}
            </h2>
            <p className="text-sm text-gray-600">
              {lawData.lawSfsNumber}
            </p>
          </div>

          {/* Close Button */}
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 p-2"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Modal Body - Scrollable */}
        <div className="flex-1 overflow-y-auto px-6 py-6">
          <div className="space-y-6">
            {/* AI Summary */}
            <div>
              <h3 className="text-sm font-semibold text-gray-900 mb-2">Summary</h3>
              <div className="prose prose-sm max-w-none text-gray-700">
                {lawData.aiSummary || 'No summary available.'}
              </div>
            </div>

            {/* Status Dropdown */}
            <div>
              <label className="block text-sm font-semibold text-gray-900 mb-2">
                Status
              </label>
              <select
                value={status}
                onChange={(e) => setStatus(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="not_started">Not Started</option>
                <option value="in_progress">In Progress</option>
                <option value="blocked">Blocked</option>
                <option value="review">Review</option>
                <option value="compliant">Compliant</option>
              </select>
            </div>

            {/* Priority Dropdown */}
            <div>
              <label className="block text-sm font-semibold text-gray-900 mb-2">
                Priority
              </label>
              <select
                value={priority || ''}
                onChange={(e) => setPriority(e.target.value as 'high' | 'medium' | 'low' || null)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">No priority</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>

            {/* Assigned Employees */}
            <div>
              <label className="block text-sm font-semibold text-gray-900 mb-2">
                Assigned Employees
              </label>
              <EmployeeSelect
                value={assignedEmployees}
                onChange={setAssignedEmployees}
              />
            </div>

            {/* Due Date */}
            <div>
              <label className="block text-sm font-semibold text-gray-900 mb-2">
                Due Date
              </label>
              <DatePicker
                value={dueDate}
                onChange={setDueDate}
              />
            </div>

            {/* Tags */}
            <div>
              <label className="block text-sm font-semibold text-gray-900 mb-2">
                Tags
              </label>
              <TagsInput
                value={tags}
                onChange={setTags}
              />
            </div>

            {/* Notes (Markdown) */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <label className="block text-sm font-semibold text-gray-900">
                  Notes
                </label>
                <button
                  onClick={() => setIsNotesPreview(!isNotesPreview)}
                  className="text-xs text-blue-600 hover:underline"
                >
                  {isNotesPreview ? 'Edit' : 'Preview'}
                </button>
              </div>

              {isNotesPreview ? (
                <div className="border border-gray-300 rounded-lg p-4 min-h-[200px] prose prose-sm max-w-none">
                  <ReactMarkdown>{notes}</ReactMarkdown>
                </div>
              ) : (
                <textarea
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[200px] font-mono text-sm"
                  placeholder="Add notes (Markdown supported)..."
                />
              )}
              <p className="text-xs text-gray-500 mt-1">
                Supports Markdown formatting
              </p>
            </div>
          </div>
        </div>

        {/* Modal Footer */}
        <div className="px-6 py-4 border-t border-gray-200 flex items-center justify-between bg-gray-50">
          <div className="flex gap-3">
            {/* View Full Law */}
            <a
              href={`/laws/${lawData.lawId}`}
              target="_blank"
              rel="noopener noreferrer"
              className="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              View Full Law
            </a>

            {/* Ask AI */}
            <button
              onClick={() => {
                router.push(`/dashboard?open=chat&lawId=${lawData.lawId}`)
              }}
              className="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
              </svg>
              Ask AI About This
            </button>
          </div>

          <div className="flex gap-3">
            {/* Cancel */}
            <button
              onClick={onClose}
              disabled={isSaving}
              className="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50"
            >
              Cancel
            </button>

            {/* Save */}
            <button
              onClick={handleSave}
              disabled={isSaving}
              className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
            >
              {isSaving ? 'Saving...' : 'Save Changes'}
            </button>
          </div>
        </div>
      </div>
    </>
  )
}

function getStatusColor(status: string) {
  const colors: Record<string, string> = {
    not_started: 'bg-gray-100 text-gray-700',
    in_progress: 'bg-blue-100 text-blue-700',
    blocked: 'bg-red-100 text-red-700',
    review: 'bg-yellow-100 text-yellow-700',
    compliant: 'bg-green-100 text-green-700'
  }
  return colors[status] || colors.not_started
}
```

**Modal Skeleton:**
```typescript
// components/kanban/modal-skeleton.tsx
export function ModalSkeleton({ onClose }: { onClose: () => void }) {
  return (
    <>
      <div className="fixed inset-0 bg-black bg-opacity-50 z-40" onClick={onClose} />
      <div className="fixed inset-0 md:inset-auto md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-4xl md:max-h-[90vh] bg-white md:rounded-lg shadow-xl z-50 overflow-hidden flex flex-col animate-pulse">
        <div className="px-6 py-4 border-b border-gray-200">
          <div className="h-6 w-48 bg-gray-300 rounded mb-2"></div>
          <div className="h-4 w-32 bg-gray-300 rounded"></div>
        </div>
        <div className="flex-1 p-6 space-y-6">
          <div className="h-32 bg-gray-300 rounded"></div>
          <div className="h-10 bg-gray-300 rounded"></div>
          <div className="h-10 bg-gray-300 rounded"></div>
          <div className="h-40 bg-gray-300 rounded"></div>
        </div>
      </div>
    </>
  )
}
```

**Employee Select Component:**
```typescript
// components/ui/employee-select.tsx
'use client'

import { useState, useEffect } from 'react'

interface EmployeeSelectProps {
  value: string[] // Array of employee IDs
  onChange: (value: string[]) => void
}

export function EmployeeSelect({ value, onChange }: EmployeeSelectProps) {
  const [employees, setEmployees] = useState<any[]>([])
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    fetchEmployees()
  }, [])

  async function fetchEmployees() {
    setIsLoading(true)
    try {
      const response = await fetch('/api/employees')
      const data = await response.json()
      setEmployees(data.employees)
    } catch (error) {
      console.error('Failed to fetch employees:', error)
    } finally {
      setIsLoading(false)
    }
  }

  function toggleEmployee(employeeId: string) {
    if (value.includes(employeeId)) {
      onChange(value.filter((id) => id !== employeeId))
    } else {
      onChange([...value, employeeId])
    }
  }

  if (isLoading) {
    return <div className="animate-pulse h-10 bg-gray-200 rounded"></div>
  }

  return (
    <div className="space-y-2">
      {employees.length === 0 ? (
        <p className="text-sm text-gray-500">No employees available</p>
      ) : (
        employees.map((employee) => (
          <label
            key={employee.id}
            className="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
          >
            <input
              type="checkbox"
              checked={value.includes(employee.id)}
              onChange={() => toggleEmployee(employee.id)}
              className="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            />
            <div className="flex items-center gap-3 flex-1">
              <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <span className="text-blue-600 text-sm font-semibold">
                  {(employee.name || employee.email)[0].toUpperCase()}
                </span>
              </div>
              <div>
                <p className="text-sm font-medium text-gray-900">
                  {employee.name || employee.email}
                </p>
                {employee.role && (
                  <p className="text-xs text-gray-500">{employee.role}</p>
                )}
              </div>
            </div>
          </label>
        ))
      )}
    </div>
  )
}
```

**Tags Input Component:**
```typescript
// components/ui/tags-input.tsx
'use client'

import { useState, KeyboardEvent } from 'react'

interface TagsInputProps {
  value: string[]
  onChange: (value: string[]) => void
}

export function TagsInput({ value, onChange }: TagsInputProps) {
  const [input, setInput] = useState('')

  function handleKeyDown(e: KeyboardEvent<HTMLInputElement>) {
    if (e.key === 'Enter' && input.trim()) {
      e.preventDefault()
      if (!value.includes(input.trim())) {
        onChange([...value, input.trim()])
      }
      setInput('')
    } else if (e.key === 'Backspace' && !input && value.length > 0) {
      onChange(value.slice(0, -1))
    }
  }

  function removeTag(tag: string) {
    onChange(value.filter((t) => t !== tag))
  }

  return (
    <div className="border border-gray-300 rounded-lg p-2 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500">
      <div className="flex flex-wrap gap-2 mb-2">
        {value.map((tag) => (
          <span
            key={tag}
            className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-sm rounded"
          >
            {tag}
            <button
              onClick={() => removeTag(tag)}
              className="hover:text-blue-900"
            >
              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </span>
        ))}
      </div>
      <input
        type="text"
        value={input}
        onChange={(e) => setInput(e.target.value)}
        onKeyDown={handleKeyDown}
        className="w-full outline-none text-sm"
        placeholder={value.length === 0 ? 'Add tags (press Enter)...' : 'Add another tag...'}
      />
    </div>
  )
}
```

**Date Picker Component:**
```typescript
// components/ui/date-picker.tsx
'use client'

import { format } from 'date-fns'
import { sv } from 'date-fns/locale'

interface DatePickerProps {
  value: Date | null
  onChange: (date: Date | null) => void
}

export function DatePicker({ value, onChange }: DatePickerProps) {
  return (
    <div className="flex gap-2">
      <input
        type="date"
        value={value ? format(value, 'yyyy-MM-dd') : ''}
        onChange={(e) => onChange(e.target.value ? new Date(e.target.value) : null)}
        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      />
      {value && (
        <button
          onClick={() => onChange(null)}
          className="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          title="Clear date"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      )}
    </div>
  )
}
```

**Get Workspace Law API:**
```typescript
// app/api/workspace-laws/[id]/route.ts
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId }) => {
    const workspaceLaw = await prisma.workspaceLaw.findFirst({
      where: {
        id: params.id,
        workspaceId
      },
      include: {
        law: {
          include: {
            categories: {
              include: {
                category: true
              },
              take: 1
            }
          }
        },
        assignedEmployees: {
          include: {
            employee: {
              select: {
                id: true,
                name: true,
                email: true,
                role: true
              }
            }
          }
        }
      }
    })

    if (!workspaceLaw) {
      return NextResponse.json(
        { error: 'Law not found' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      id: workspaceLaw.id,
      lawId: workspaceLaw.lawId,
      lawTitle: workspaceLaw.law.title,
      lawSfsNumber: workspaceLaw.law.sfsNumber,
      category: workspaceLaw.law.categories[0]?.category.name || 'Övrigt',
      aiSummary: workspaceLaw.law.aiSummary,
      status: workspaceLaw.status,
      priority: workspaceLaw.priority,
      dueDate: workspaceLaw.dueDate,
      notes: workspaceLaw.notes,
      tags: workspaceLaw.tags,
      assignedEmployees: workspaceLaw.assignedEmployees.map((ae) => ({
        id: ae.employee.id,
        name: ae.employee.name,
        email: ae.employee.email,
        role: ae.employee.role
      }))
    })
  })
}
```

**Update Workspace Law API:**
```typescript
// app/api/workspace-laws/[id]/route.ts (PATCH)
export async function PATCH(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    // Check permission
    checkPermission(role as WorkspaceRole, Permission.MANAGE_LAWS)

    const data = await request.json()
    const { status, priority, assignedEmployees, dueDate, notes, tags } = data

    // Verify law belongs to workspace
    const existingLaw = await prisma.workspaceLaw.findFirst({
      where: {
        id: params.id,
        workspaceId
      }
    })

    if (!existingLaw) {
      return NextResponse.json(
        { error: 'Law not found' },
        { status: 404 }
      )
    }

    // Update workspace law
    const updated = await prisma.workspaceLaw.update({
      where: { id: params.id },
      data: {
        status,
        priority,
        dueDate: dueDate ? new Date(dueDate) : null,
        notes,
        tags,
        updatedAt: new Date()
      }
    })

    // Update assigned employees (replace all)
    // First, delete existing assignments
    await prisma.workspaceLawEmployee.deleteMany({
      where: { workspaceLawId: params.id }
    })

    // Then, create new assignments
    if (assignedEmployees && assignedEmployees.length > 0) {
      await prisma.workspaceLawEmployee.createMany({
        data: assignedEmployees.map((employeeId: string) => ({
          workspaceLawId: params.id,
          employeeId
        }))
      })
    }

    // Log activity
    await logActivity({
      workspaceId,
      userId,
      action: ActivityAction.LAW_STATUS_CHANGED,
      resourceType: 'law',
      resourceId: existingLaw.lawId,
      metadata: {
        lawTitle: existingLaw.law.title,
        oldStatus: existingLaw.status,
        newStatus: status
      }
    })

    return NextResponse.json({ success: true })
  })
}
```

**Updated Law Card to Open Modal:**
```typescript
// components/kanban/law-card.tsx (updated)
'use client'

import { useState } from 'react'
import { LawCardModal } from './law-card-modal'

export function LawCard({ law }: LawCardProps) {
  const [isModalOpen, setIsModalOpen] = useState(false)

  return (
    <>
      <div
        className="bg-white rounded-lg border-2 border-gray-200 p-4 cursor-pointer transition-all hover:shadow-md hover:border-blue-300"
        onClick={() => setIsModalOpen(true)}
      >
        {/* Law card content... */}
      </div>

      {/* Modal */}
      {isModalOpen && (
        <LawCardModal
          workspaceLawId={law.id}
          onClose={() => setIsModalOpen(false)}
        />
      )}
    </>
  )
}
```

**Reference:** PRD Epic 6 Story 6.3, Architecture Section 14 (Compliance Workspace)

## Testing

**Unit Tests:**
- Modal opens when law card clicked
- ESC key closes modal
- Backdrop click closes modal
- Form state initializes with law data
- Save button calls API with updated data
- Employee assignment toggles correctly
- Tags can be added and removed

**Integration Tests:**
- Open modal, update priority, save, verify updated in Kanban
- Assign employees, verify avatars appear on card
- Add notes with markdown, verify renders correctly
- Set due date, verify persists after refresh
- Click "View Full Law", verify opens in new tab
- Click "Ask AI", verify opens chat with law context

**Manual Testing:**
- Click law card from Kanban, verify modal opens
- Update all fields, click Save, verify persists
- Press ESC, verify modal closes
- Click backdrop, verify modal closes
- Test on mobile, verify full-screen layout
- Test markdown preview in notes
- Verify "View Full Law" link works
- Verify "Ask AI" button navigates correctly

**Accessibility Testing:**
- Modal traps focus (Tab cycles within modal)
- ESC key closes modal
- Screen reader announces modal open/close
- Form labels properly associated with inputs
- Color contrast meets WCAG AA standards

**Performance Testing:**
- Modal opens <200ms after click
- Large notes (1000+ lines) render without lag
- Employee list loads <500ms

**Test File:** `__tests__/features/kanban/law-card-modal.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Update law metadata (status, priority, employees, due date)
- Add detailed notes for compliance tracking
- Tag laws for organization
- View full law details when needed
- Ask AI questions about specific laws

**Developer Responsibility:**
- Fetch law data quickly (<500ms)
- Persist all changes accurately
- Prevent modal body scroll when open (trap scroll)
- Support markdown in notes
- Validate data before saving
- Handle errors gracefully (show error messages)
- Refresh Kanban board after save

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
