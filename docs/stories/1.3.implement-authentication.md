# Story 1.3: Implement Authentication (Supabase Auth + NextAuth.js)

## Status

Draft

## Story

**As a** user,
**I want** to sign up and log in using email/password, Google, or Microsoft,
**so that** I can access my personalized workspace.

## Acceptance Criteria

1. Supabase Auth configured with email/password provider
2. Google OAuth provider configured
3. Microsoft OAuth provider configured
4. NextAuth.js integrated for session management
5. Login page with email/password form and OAuth buttons
6. Sign-up page with password complexity validation
7. Email verification flow (6-digit code)
8. Password reset flow
9. Protected routes redirect to login if not authenticated
10. Session cookies set with 30-day expiration, HTTP-only
11. User profile accessible at `/api/auth/me`

## Tasks / Subtasks

- [ ] Configure Supabase Auth providers (AC: 1, 2, 3)
  - [ ] Enable email/password in Supabase Dashboard → Authentication → Providers
  - [ ] Create Google OAuth app in Google Cloud Console
  - [ ] Add Google client ID/secret to Supabase
  - [ ] Create Microsoft Azure AD app
  - [ ] Add Microsoft client ID/secret to Supabase
  - [ ] Configure redirect URLs for all providers

- [ ] Install and configure NextAuth.js (AC: 4)
  - [ ] Install: `npm install next-auth @supabase/auth-helpers-nextjs`
  - [ ] Create `app/api/auth/[...nextauth]/route.ts`
  - [ ] Configure NextAuth with Supabase adapter
  - [ ] Set NEXTAUTH_SECRET and NEXTAUTH_URL in `.env.local`

- [ ] Create login page (AC: 5)
  - [ ] Create `app/login/page.tsx`
  - [ ] Build email/password form with Zod validation
  - [ ] Add Google OAuth button
  - [ ] Add Microsoft OAuth button
  - [ ] Handle authentication errors with user-friendly messages
  - [ ] Redirect to dashboard after successful login

- [ ] Create sign-up page (AC: 6)
  - [ ] Create `app/signup/page.tsx`
  - [ ] Build sign-up form (email, password, confirm password, name)
  - [ ] Validate password: min 8 chars, uppercase, lowercase, number, special char
  - [ ] Show password strength indicator
  - [ ] Link to login page: "Already have an account?"

- [ ] Implement email verification (AC: 7)
  - [ ] Configure Supabase email templates
  - [ ] Send 6-digit verification code on signup
  - [ ] Create verification page: `app/verify-email/page.tsx`
  - [ ] Validate code and mark email as verified
  - [ ] Redirect to onboarding after verification

- [ ] Implement password reset (AC: 8)
  - [ ] Create forgot password page: `app/forgot-password/page.tsx`
  - [ ] Send reset link via Supabase Auth
  - [ ] Create reset password page: `app/reset-password/page.tsx`
  - [ ] Update password and redirect to login

- [ ] Protect routes with middleware (AC: 9)
  - [ ] Create `middleware.ts` in project root
  - [ ] Check session for protected routes (`/dashboard`, `/workspace`, `/admin`)
  - [ ] Redirect unauthenticated users to `/login?redirect=/original-path`
  - [ ] Allow public routes: `/`, `/login`, `/signup`, `/alla-lagar/*`

- [ ] Configure session cookies (AC: 10)
  - [ ] Set maxAge: 30 days (2592000 seconds)
  - [ ] Enable httpOnly: true
  - [ ] Enable secure: true (HTTPS only in production)
  - [ ] Set sameSite: 'lax' for CSRF protection

- [ ] Create user profile API (AC: 11)
  - [ ] Create `app/api/auth/me/route.ts`
  - [ ] Return: user ID, email, name, workspaceId
  - [ ] Require authentication (check session)
  - [ ] Return 401 if not authenticated

## Dev Notes

### Authentication Architecture

**Strategy:** Supabase Auth + NextAuth.js hybrid

- **Supabase Auth:** Handles OAuth providers and email/password
- **NextAuth.js:** Manages sessions and middleware
- **Why hybrid?** Best of both: Supabase's auth UI + Next.js session management

### Supabase Auth Configuration

**Email Settings (Supabase Dashboard):**

- **SMTP:** Use Supabase's default SMTP for MVP
- **Email Templates:** Customize confirmation and reset emails with brand colors
- **Magic Link:** Disabled for MVP (use password instead)

**OAuth Redirect URLs:**

```
Google: https://[project-ref].supabase.co/auth/v1/callback
Microsoft: https://[project-ref].supabase.co/auth/v1/callback
Development: http://localhost:54321/auth/v1/callback (if using Supabase CLI)
```

### NextAuth.js Configuration

**app/api/auth/[...nextauth]/route.ts:**

```typescript
import NextAuth from 'next-auth'
import GoogleProvider from 'next-auth/providers/google'
import MicrosoftProvider from 'next-auth/providers/microsoft'
import CredentialsProvider from 'next-auth/providers/credentials'
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

export const authOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    MicrosoftProvider({
      clientId: process.env.MICROSOFT_CLIENT_ID!,
      clientSecret: process.env.MICROSOFT_CLIENT_SECRET!,
    }),
    CredentialsProvider({
      name: 'Email',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: credentials!.email,
          password: credentials!.password,
        })

        if (error || !data.user) return null
        return { id: data.user.id, email: data.user.email }
      },
    }),
  ],
  session: {
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  cookies: {
    sessionToken: {
      name: 'laglig-session',
      options: {
        httpOnly: true,
        sameSite: 'lax',
        path: '/',
        secure: process.env.NODE_ENV === 'production',
      },
    },
  },
  pages: {
    signIn: '/login',
    signOut: '/logout',
    error: '/login',
  },
}

const handler = NextAuth(authOptions)
export { handler as GET, handler as POST }
```

### Middleware for Protected Routes

**middleware.ts:**

```typescript
import { withAuth } from 'next-auth/middleware'
import { NextResponse } from 'next/server'

export default withAuth(
  function middleware(req) {
    // Allow request to proceed if authenticated
    return NextResponse.next()
  },
  {
    callbacks: {
      authorized: ({ token }) => !!token,
    },
  }
)

export const config = {
  matcher: [
    '/dashboard/:path*',
    '/workspace/:path*',
    '/admin/:path*',
    '/api/protected/:path*',
  ],
}
```

### Password Validation Schema

**lib/validation/auth.ts:**

```typescript
import { z } from 'zod'

export const SignupSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z
    .string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Must contain uppercase letter')
    .regex(/[a-z]/, 'Must contain lowercase letter')
    .regex(/[0-9]/, 'Must contain number')
    .regex(/[^A-Za-z0-9]/, 'Must contain special character'),
  name: z.string().min(2, 'Name must be at least 2 characters'),
})

export const LoginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(1, 'Password required'),
})
```

### Environment Variables Required

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL="https://[project-ref].supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJ..."
SUPABASE_SERVICE_ROLE_KEY="eyJ..."

NEXTAUTH_SECRET="generate-with: openssl rand -base64 32"
NEXTAUTH_URL="http://localhost:3000"

GOOGLE_CLIENT_ID="..."
GOOGLE_CLIENT_SECRET="..."

MICROSOFT_CLIENT_ID="..."
MICROSOFT_CLIENT_SECRET="..."
```

### Important Architecture References

**From Section 15.1 (Security):**

- Session cookies must be HTTP-only to prevent XSS
- Use secure flag in production (HTTPS)
- CSRF protection via sameSite: 'lax'

**From Section 11.2 (Authentication):**

- Complete authentication flow diagrams
- Session management patterns
- Token refresh strategies

**From Section 18 (Error Handling):**

- User-friendly authentication error messages
- Don't expose whether email exists (security)
- Generic "Invalid credentials" for failed login

### Testing

**Test File:** `tests/integration/auth/authentication.test.ts`

```typescript
import { describe, it, expect } from 'vitest'
import { signIn, signOut } from 'next-auth/react'

describe('Authentication', () => {
  it('signs up new user with valid credentials', async () => {
    // Test signup flow
  })

  it('logs in existing user', async () => {
    // Test login flow
  })

  it('rejects weak passwords', () => {
    const result = SignupSchema.safeParse({
      email: 'test@example.com',
      password: 'weak',
      name: 'Test',
    })

    expect(result.success).toBe(false)
  })

  it('protects dashboard route', async () => {
    const response = await fetch('/dashboard')
    expect(response.status).toBe(401)
  })
})
```

**E2E Test:** `tests/e2e/auth/login.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test('complete login flow', async ({ page }) => {
  await page.goto('/login')

  await page.fill('[name=email]', 'test@example.com')
  await page.fill('[name=password]', 'ValidPass123!')
  await page.click('button[type=submit]')

  await expect(page).toHaveURL('/dashboard')
})
```

### User Responsibilities

- Create Google Cloud Console project for OAuth
- Create Microsoft Azure AD app for OAuth
- Provide OAuth client IDs and secrets
- Test authentication flows in staging

### Developer Responsibilities

- Configure all auth providers
- Implement secure session management
- Create user-friendly auth UI
- Write integration and E2E tests
- Document OAuth setup for future team members

## Change Log

| Date       | Version | Description                            | Author     |
| ---------- | ------- | -------------------------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
