# Story 4.13: Document Grouping with Accordion Sections

## Status

Approved

## Story

**As a** workspace user,
**I want** to organize my documents into collapsible groups within my law list,
**so that** I can reduce cognitive load, improve navigation, and maintain context when managing large document sets.

## Acceptance Criteria

1. Users can create named groups within a law list (e.g., "Arbetsmiljö", "GDPR", "Ekonomi")
2. Documents can be assigned to a group via dropdown selector in both card and table views
3. Grouped documents display in collapsible accordion sections with expand/collapse buttons
4. Each group header shows: Group name, document count, expand/collapse chevron
5. "Expand All" / "Collapse All" toggle button for bulk accordion control
6. Ungrouped documents appear in a default "Övrigt" (Other) section at the bottom
7. Groups can be renamed, reordered, and deleted (documents move to "Övrigt" on delete)
8. Documents can be dragged between groups via drag-and-drop (both views)
9. Group expansion state persists to localStorage per list
10. Groups work in both card view and table view (TanStack Table grouping)
11. Empty groups are hidden by default, with option to show empty groups
12. Group filter: Click group header to filter view to only that group's documents
13. Mobile-responsive: Groups collapse to simple headers on small screens
14. Performance: Accordion animations smooth for groups with 50+ documents

## Tasks / Subtasks

- [x] **Task 0: List URL Deep Linking (Prerequisite Fix)**
  - [x] Read `?list={listId}` query param on page load via `useSearchParams()`
  - [x] If param present and valid, set as `activeListId` in store (override localStorage)
  - [x] On list switch, update URL with `router.push('/laglistor?list={id}', { shallow: true })`
  - [x] Ensure URL updates don't cause full page reload (shallow routing)
  - [x] Add list links to sidebar "Mina laglistor" section using `?list={id}` format
  - [x] Test: Copy URL → paste in new tab → correct list loads

- [x] **Task 1: Database Schema Extension** (AC: 1, 6)
  - [x] Add `group_id String?` FK field to LawListItem model
  - [x] Create `LawListGroup` model: `id`, `law_list_id`, `name`, `position`, `created_at`
  - [x] Add relation: LawListItem → LawListGroup (nullable)
  - [x] Add unique constraint: `@@unique([law_list_id, name])` on LawListGroup
  - [x] Run `pnpm prisma db push` and regenerate client

- [ ] **Task 2: Server Actions for Group Management** (AC: 1, 7)
  - [ ] Add `createListGroup({ listId, name })` action with validation
  - [ ] Add `updateListGroup({ groupId, name?, position? })` action
  - [ ] Add `deleteListGroup({ groupId })` action (moves items to null group)
  - [ ] Add `getListGroups({ listId })` action returns groups with item counts
  - [ ] Add Zod schemas for all group inputs
  - [ ] Ensure workspace permission checks on all actions

- [ ] **Task 3: Extend Item Actions for Group Assignment** (AC: 2, 8)
  - [ ] Add `groupId` parameter to `updateListItem` action
  - [ ] Add `bulkMoveToGroup({ itemIds, groupId })` action for bulk assignment
  - [ ] Update `getDocumentListItems` to include group relation in response
  - [ ] Add sorting option: `sortBy: 'group'` for grouped view queries

- [ ] **Task 4: Create Group Management UI Components** (AC: 1, 7)
  - [ ] Create `components/features/document-list/group-manager.tsx`
  - [ ] Modal/dropdown for creating new groups (input + color picker optional)
  - [ ] Inline editing for group names (click to edit)
  - [ ] Drag handle for reordering groups
  - [ ] Delete button with confirmation (warns about ungrouping items)
  - [ ] Use shadcn/ui Dialog, Input, Button, DropdownMenu

- [ ] **Task 5: Create Group Selector Component** (AC: 2)
  - [ ] Create `components/features/document-list/group-selector.tsx`
  - [ ] Dropdown showing all groups + "Ingen grupp" (no group) option
  - [ ] Used in both card view (as badge/dropdown) and table view (inline editor)
  - [ ] Shows current group with color indicator (if colors implemented)
  - [ ] "Skapa ny grupp" option at bottom of dropdown

- [ ] **Task 6: Implement Accordion Container for Card View** (AC: 3, 4, 5, 11)
  - [ ] Create `components/features/document-list/grouped-document-grid.tsx`
  - [ ] Use shadcn/ui Accordion (Collapsible) for group sections
  - [ ] Group header: Name, item count badge, ChevronDown/ChevronRight icon
  - [ ] Expand/Collapse all button in toolbar
  - [ ] Smooth height transition animations (CSS `transition: height`)
  - [ ] "Övrigt" section for ungrouped items (always last)
  - [ ] Empty state: "Inga dokument i denna grupp" (hidden by default)
  - [ ] Add "Visa tomma grupper" toggle in toolbar (Switch component, persisted to store)

- [ ] **Task 7: Implement TanStack Table Grouping for Table View** (AC: 3, 4, 10)
  - [ ] Add `getGroupedRowModel()` to TanStack Table configuration
  - [ ] Define `grouping` column state pointing to `groupId`/`groupName`
  - [ ] Render group headers as collapsible rows with expand/collapse toggle
  - [ ] Group header row shows: Chevron, Group name, item count
  - [ ] Indentation for grouped rows (visual hierarchy)
  - [ ] Use `row.getIsGrouped()` to conditionally render group header cells

- [ ] **Task 8: Implement Cross-Group Drag and Drop** (AC: 8)
  - [ ] Extend @dnd-kit configuration for group-aware drops
  - [ ] Accept drops on group headers (moves item to that group)
  - [ ] Visual feedback: Group header highlights when dragging over
  - [ ] Update item's `groupId` on successful cross-group drop
  - [ ] Works in both card view (drag to accordion header) and table view

- [ ] **Task 9: Persist Group Expansion State** (AC: 9)
  - [ ] Add `expandedGroups: Record<string, boolean>` to Zustand store
  - [ ] Persist per-list expansion state to localStorage via Zustand persist middleware
  - [ ] Store key included in existing `document-list-storage` partition
  - [ ] Default: All groups expanded on first view (empty record = all expanded)
  - [ ] Collapse All sets all group IDs to `false`, persists state

- [ ] **Task 10: Update Zustand Store for Grouping** (AC: all)
  - [ ] Add `groups: LawListGroup[]` to store state
  - [ ] Add `showEmptyGroups: boolean` to store state (default: false)
  - [ ] Add `fetchGroups()` action
  - [ ] Add `createGroup()`, `updateGroup()`, `deleteGroup()` actions with optimistic updates
  - [ ] Add `moveItemToGroup(itemId, groupId)` action with optimistic update + rollback
  - [ ] Add `toggleGroupExpanded(groupId)` using `expandedGroups: Record<string, boolean>`
  - [ ] Add `expandAllGroups()` / `collapseAllGroups()` actions
  - [ ] Add `setShowEmptyGroups(show: boolean)` action

- [ ] **Task 11: Group Filter Mode** (AC: 12)
  - [ ] Clicking group header name (not chevron) filters to that group only
  - [ ] Filter chip appears: "Visar: [Group Name]" with X to clear
  - [ ] URL param: `?group={groupId}` for shareable filtered views
  - [ ] On page load, read `?group` param and apply filter (client-side via useSearchParams)
  - [ ] Update URL without page reload using `router.push` with shallow routing
  - [ ] Combine with content type filter (both applied simultaneously)

- [ ] **Task 12: Mobile Responsive Accordion** (AC: 13)
  - [ ] On screens <640px: Group headers simplified (name + count only)
  - [ ] Touch-friendly tap targets (44px minimum)
  - [ ] Swipe gestures for expand/collapse (optional enhancement)
  - [ ] Test on iOS Safari and Android Chrome

- [ ] **Task 13: Performance Optimization** (AC: 14)
  - [ ] Virtualize items within expanded groups (reuse @tanstack/react-virtual)
  - [ ] Lazy render collapsed group contents (don't mount until expanded)
  - [ ] Memoize group header components
  - [ ] Test with 10 groups × 50 items each = 500 items

- [ ] **Task 14: Unit Tests**
  - [ ] Test group CRUD operations in store
  - [ ] Test group selector dropdown interactions
  - [ ] Test accordion expand/collapse state
  - [ ] Test drag-and-drop between groups
  - [ ] Test TanStack Table grouping configuration

- [ ] **Task 15: E2E Tests**
  - [ ] Test create group → assign document → verify in group
  - [ ] Test expand/collapse accordion sections
  - [ ] Test drag document between groups
  - [ ] Test delete group → verify items ungrouped
  - [ ] Test group filter mode
  - [ ] Test persistence: Refresh page → groups still expanded/collapsed correctly

## Dev Notes

### Task 0: List URL Deep Linking Implementation

**Problem:** Currently `activeListId` is only stored in Zustand/localStorage. Users cannot:
- Share a direct link to a specific list with colleagues
- Bookmark a specific list
- Use browser back/forward between lists

**Solution:** Add `?list={listId}` query parameter support.

**Implementation in `document-list-page-content.tsx`:**

```typescript
'use client'

import { useSearchParams, useRouter } from 'next/navigation'
import { useEffect } from 'react'

export function DocumentListPageContent({ initialLists, defaultListId }) {
  const searchParams = useSearchParams()
  const router = useRouter()
  const { setActiveList, activeListId } = useDocumentListStore()

  // On mount: Read ?list= param and set active list
  useEffect(() => {
    const listIdFromUrl = searchParams.get('list')
    if (listIdFromUrl && initialLists.some(l => l.id === listIdFromUrl)) {
      setActiveList(listIdFromUrl)
    }
  }, []) // Only on mount

  // On list change: Update URL (shallow routing, no reload)
  const handleListChange = (listId: string) => {
    setActiveList(listId)
    router.push(`/laglistor?list=${listId}`, { scroll: false })
  }

  // Pass handleListChange to DocumentListSwitcher instead of setActiveList directly
}
```

**Sidebar "Mina laglistor" links:**

```typescript
// In workspace sidebar component
{lists.map(list => (
  <Link
    key={list.id}
    href={`/laglistor?list=${list.id}`}
    className={cn(activeListId === list.id && 'bg-accent')}
  >
    {list.name}
  </Link>
))}
```

### Previous Story Context (4.12)

Story 4.12 implemented the Jira-inspired table view with:
- TanStack Table integration for sorting, filtering, column visibility
- Inline cell editors for status, priority, due date, assignee
- Bulk selection and actions via floating action bar
- @dnd-kit row reordering
- Zustand store with localStorage persistence

Story 4.13 builds on this by adding grouping to both card and table views.

### Database Schema Addition

**New model and relations:**

```prisma
// NEW MODEL
model LawListGroup {
  id          String @id @default(uuid())
  law_list_id String
  name        String
  position    Float  @default(0) // For ordering groups

  created_at DateTime @default(now())

  law_list LawList       @relation(fields: [law_list_id], references: [id], onDelete: Cascade)
  items    LawListItem[]

  @@unique([law_list_id, name])
  @@index([law_list_id, position])
  @@map("law_list_groups")
}

// ADD TO EXISTING LawList model
model LawList {
  // ... existing fields ...

  // Story 4.13: Add groups relation
  groups LawListGroup[]
}

// ADD TO EXISTING LawListItem model
model LawListItem {
  // ... existing fields ...

  // Story 4.13: Grouping
  group_id String?
  group    LawListGroup? @relation(fields: [group_id], references: [id], onDelete: SetNull)

  @@index([group_id])
}
```

[Source: prisma/schema.prisma]

### TanStack Table Grouping Pattern

[Source: docs/architecture/3-tech-stack.md#tanstack-table]

TanStack Table provides built-in grouping via `getGroupedRowModel()`:

```typescript
import {
  useReactTable,
  getCoreRowModel,
  getGroupedRowModel,
  getExpandedRowModel,
  type GroupingState,
  type ExpandedState,
} from '@tanstack/react-table'

const [grouping, setGrouping] = useState<GroupingState>(['groupName'])
const [expanded, setExpanded] = useState<ExpandedState>({})

const table = useReactTable({
  data: items,
  columns,
  state: { grouping, expanded },
  onGroupingChange: setGrouping,
  onExpandedChange: setExpanded,
  getGroupedRowModel: getGroupedRowModel(),
  getExpandedRowModel: getExpandedRowModel(),
  getCoreRowModel: getCoreRowModel(),
})

// In render:
{table.getRowModel().rows.map((row) => (
  row.getIsGrouped() ? (
    <GroupHeaderRow
      key={row.id}
      row={row}
      isExpanded={row.getIsExpanded()}
      onToggle={() => row.toggleExpanded()}
    />
  ) : (
    <DocumentRow key={row.id} row={row} />
  )
))}
```

### shadcn/ui Accordion Pattern

[Source: docs/architecture/17-coding-standards.md#shadcn-ui]

For card view, use shadcn/ui Collapsible (not Accordion for multi-expand):

```typescript
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible'

<Collapsible open={isExpanded} onOpenChange={setIsExpanded}>
  <CollapsibleTrigger className="flex items-center justify-between w-full p-4">
    <span>{group.name}</span>
    <div className="flex items-center gap-2">
      <Badge variant="secondary">{group.itemCount}</Badge>
      <ChevronDown className={cn("h-4 w-4 transition-transform", isExpanded && "rotate-180")} />
    </div>
  </CollapsibleTrigger>
  <CollapsibleContent>
    <DocumentListGrid items={groupItems} />
  </CollapsibleContent>
</Collapsible>
```

### File Locations

[Source: docs/architecture/12-unified-project-structure.md]

```
components/features/document-list/
├── group-manager.tsx           # CRUD modal for groups
├── group-selector.tsx          # Dropdown to assign group
├── grouped-document-grid.tsx   # Card view with accordion
├── document-list-table.tsx     # Update for TanStack grouping
└── group-filter-chip.tsx       # Filter indicator

lib/stores/
└── document-list-store.ts      # Add groups state + actions

app/actions/
└── document-list.ts            # Add group server actions
```

### Zustand Store Extension

```typescript
// Add to DocumentListState interface
groups: LawListGroup[]
expandedGroups: Record<string, boolean>  // groupId -> isExpanded (empty = all expanded)
showEmptyGroups: boolean                  // Toggle for AC 11
activeGroupFilter: string | null          // For group filter mode (AC 12)
_rollbackGroups: LawListGroup[] | null    // For optimistic update rollback

// Actions
fetchGroups: () => Promise<void>
createGroup: (name: string) => Promise<string | null>
updateGroup: (groupId: string, updates: { name?: string; position?: number }) => Promise<boolean>
deleteGroup: (groupId: string) => Promise<boolean>
reorderGroups: (groups: Array<{ id: string; position: number }>) => Promise<boolean>
moveItemToGroup: (itemId: string, groupId: string | null) => Promise<boolean>
toggleGroupExpanded: (groupId: string) => void
expandAllGroups: () => void
collapseAllGroups: () => void
setShowEmptyGroups: (show: boolean) => void
setActiveGroupFilter: (groupId: string | null) => void
```

**Optimistic Update Pattern (follow existing store patterns):**

```typescript
createGroup: async (name: string) => {
  const { groups, activeListId } = get()
  if (!activeListId) return null

  // Optimistic: Add temp group immediately
  const tempId = `temp-${Date.now()}`
  const tempGroup = { id: tempId, name, position: groups.length, itemCount: 0 }
  set({ groups: [...groups, tempGroup], _rollbackGroups: groups })

  try {
    const result = await createListGroup({ listId: activeListId, name })
    if (result.success && result.data) {
      // Replace temp with real group
      set(state => ({
        groups: state.groups.map(g => g.id === tempId ? result.data : g),
        _rollbackGroups: null,
      }))
      return result.data.id
    } else {
      // Rollback on error
      set({ groups, error: result.error, _rollbackGroups: null })
      return null
    }
  } catch {
    set({ groups, error: 'Kunde inte skapa grupp', _rollbackGroups: null })
    return null
  }
}
```

### UX Reference: Notisum Law Lists

The grouping UX is inspired by Notisum's industry law lists which feature:
- 10-20 documents per group section
- Accordion-style expand/collapse for each group
- Clear visual hierarchy reducing cognitive load
- Groups named by topic/area (Arbetsmiljö, Ekonomi, etc.)

### Cross-Group Drag and Drop

Extend @dnd-kit configuration:

```typescript
// DragOverlay shows group header highlight
const handleDragOver = (event: DragOverEvent) => {
  const { over } = event
  if (over?.data.current?.type === 'group') {
    setActiveDropGroup(over.id)
  }
}

const handleDragEnd = async (event: DragEndEvent) => {
  const { active, over } = event
  if (over?.data.current?.type === 'group') {
    await moveItemToGroup(active.id, over.id)
  }
}
```

### Performance Considerations

- Lazy render collapsed groups (defer mounting until expanded)
- Virtualize long item lists within groups
- Memoize group headers and item cards
- Debounce expansion state persistence
- Target: <100ms interaction response for 500 items across 10 groups

### Error Handling Scenarios

| Operation | Error Scenario | User Feedback | Recovery |
|-----------|----------------|---------------|----------|
| Create group | Duplicate name | Toast: "En grupp med detta namn finns redan" | Keep modal open, highlight input |
| Create group | Server error | Toast: "Kunde inte skapa grupp" | Rollback optimistic add |
| Delete group | Server error | Toast: "Kunde inte ta bort grupp" | Rollback, keep group visible |
| Move item | Server error | Toast: "Kunde inte flytta dokument" | Rollback item to original group |
| Bulk move | Partial failure | Toast: "X av Y dokument flyttades" | Refresh items from server |
| Fetch groups | Network error | Inline error in group panel | Retry button, show cached if available |

**Error Toast Pattern:**
```typescript
// Use existing toast infrastructure from shadcn/ui
import { toast } from '@/components/ui/use-toast'

toast({
  title: 'Kunde inte skapa grupp',
  description: error.message,
  variant: 'destructive',
})
```

## Testing

### Test File Locations

```
tests/
├── unit/
│   └── components/features/document-list/
│       ├── group-manager.test.tsx
│       ├── group-selector.test.tsx
│       └── grouped-document-grid.test.tsx
│   └── lib/stores/
│       └── document-list-store.groups.test.ts
└── e2e/
    └── document-list.spec.ts     # Add Story 4.13 tests
```

### Testing Standards

[Source: docs/architecture/17-coding-standards.md]

- **Framework:** Vitest + React Testing Library
- **Coverage target:** 60-70%
- **E2E:** Playwright
- **Mocking:** MSW for server action calls

### Key Test Scenarios

1. Create group, assign item, verify group section appears
2. Expand/collapse group accordion, verify persistence after refresh
3. Drag item from one group to another, verify move
4. Delete group with items, verify items appear in "Övrigt"
5. Bulk select items, bulk move to group
6. Group filter: Click group header, verify filter applied
7. Table view: TanStack grouping rows render correctly
8. Empty group hidden by default, visible when "show empty" enabled

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2026-01-06 | 1.0     | Initial story creation | Bob (SM)     |
| 2026-01-06 | 1.1     | PO validation fixes: Added LawList.groups relation, fixed expansion state type consistency, added show empty groups toggle, error handling scenarios, optimistic update patterns, URL param SSR behavior, QA Results section | Sarah (PO) |
| 2026-01-06 | 1.2     | Added Task 0: List URL Deep Linking as prerequisite fix (enables shareable list URLs via ?list= param) | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent after implementation review_
