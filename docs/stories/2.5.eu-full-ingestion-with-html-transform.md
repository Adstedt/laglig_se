# Story 2.5: Complete EU Ingestion with HTML Transformation, Linkification, and NIM Data

## Status

Draft

## Story

**As a** developer,
**I want** to complete the full EU document ingestion with transformed HTML, cross-reference linkification, and Swedish NIM data,
**so that** all ~67,000 EU documents are browsable with proper TOC navigation, preamble accordions, clickable legal references, and bidirectional links to Swedish implementing laws.

## Acceptance Criteria

### Phase 1: Fix Ingestion + Apply HTML Transformer (AC: 1-8)

1. Update `ingest-eu-by-year.ts` (or create new unified script) to pipe CELLAR HTML through `transformEuHtml()` before storing in `html_content`
2. Plain text extracted from transformed HTML stored in `full_text`
3. Transform stats (structureType, chapterCount, articleCount, etc.) stored in `metadata` JSONB
4. All ~63,045 regulations ingested with transformed HTML
5. All ~4,752 directives ingested with transformed HTML
6. Script handles existing documents: re-transform HTML for docs already in DB (`--retransform` flag)
7. Checkpoint/resume system works for the full run (`--resume` flag)
8. Rate limiting respects CELLAR API (2 req/sec) with proper retry on 429s

### Phase 2: Linkification (AC: 9-14)

9. After HTML transformation, run `linkifyHtmlContent()` on each document's HTML
10. Build `SlugMap` once before processing (all documents in DB) and refresh periodically as new docs are added
11. Detected references to SFS laws, agency regulations, and court cases become clickable `<a class="legal-ref">` links
12. Linked references saved as `cross_references` with `reference_type = REFERENCES` via `saveCrossReferences()`
13. Self-references excluded (a document doesn't link to itself)
14. Linkification is idempotent -- existing `<a class="legal-ref">` links stripped before re-linkifying

### Phase 3: NIM Data Integration (AC: 15-19)

15. New SPARQL query fetches all Swedish NIM entries using correct CDM predicates
16. NIM data stored in `eu_documents.national_implementation_measures` JSONB field
17. SFS numbers from NIM data matched against existing `legal_documents` entries
18. `cross_references` created with `reference_type = IMPLEMENTS` linking SFS laws to EU directives
19. At least 2,000+ directives linked to Swedish implementing laws

### Phase 4: Verification (AC: 20-24)

20. All transformed HTML renders correctly in the document reader (spot check 10 documents across chaptered/flat/minimal types)
21. TOC/StickyDocNav works for chaptered EU documents (section.kapitel headings detected)
22. Preamble accordion collapses/expands correctly
23. Legal references in document text are clickable and navigate to correct target documents
24. Final DB counts match SPARQL API totals (within 5% tolerance for correction docs etc.)

## Tasks / Subtasks

### Task 1: Update Ingestion Pipeline with HTML Transformer (AC: 1-3, 6)

- [ ] Modify `processDocument()` in `scripts/ingest-eu-by-year.ts` to:
  1. Fetch raw HTML from CELLAR via `fetchDocumentContentViaCellar(celex)`
  2. Run through `transformEuHtml(rawHtml, { celex, documentNumber, shortTitle })` from `lib/eu/eu-html-transformer.ts`
  3. Store `result.html` in `html_content` (NOT raw CELLAR HTML)
  4. Extract plain text from transformed HTML via cheerio `$('body').text()` for `full_text`
  5. Store `result.structureType` and `result.stats` in `metadata` JSONB
- [ ] Add `--retransform` flag: load existing `html_content`, detect if raw (contains `eli-` classes), re-transform and update
- [ ] Fix connection pool: ensure sequential DB writes with `connection_limit=1` (no parallel workers)
  - [Source: Story 2.4 Dev Notes - connection pool exhaustion root cause]

### Task 2: Improve Rate Limiting and Error Handling (AC: 7-8)

- [ ] Add proper HTTP 429 detection with `Retry-After` header parsing in `fetchDocumentContentViaCellar()`
- [ ] Implement exponential backoff: 2s -> 4s -> 8s -> 16s (max 5 retries)
  - [Source: architecture/7-external-apis.md#583-rate-limiting-retry-strategy]
- [ ] Handle SPARQL response truncation: reduce batch size automatically on JSON parse error
- [ ] Add per-year progress summary with timing and ETA
- [ ] Verify checkpoint JSON saves after each completed year for resumability

### Task 3: Apply Linkification to Transformed HTML (AC: 9-14)

- [ ] Build `SlugMap` once at script start via `buildSlugMap()` from `lib/linkify/build-slug-map.ts`
- [ ] After `transformEuHtml()`, run `linkifyHtmlContent(transformedHtml, slugMap, celex)` from `lib/linkify/linkify-html.ts`
- [ ] Store the final linkified HTML (not just transformed) in `html_content`
- [ ] Call `saveCrossReferences(docId, linkedRefs, plainText)` from `lib/linkify/save-cross-references.ts` to populate `cross_references` with `reference_type = 'REFERENCES'`
- [ ] Refresh `SlugMap` periodically (e.g. every 1000 docs or per completed year) as new documents become linkable targets
- [ ] Log linkification stats per batch: total references detected, total linked, total unresolved

### Task 4: Run Full Ingestion (AC: 4-5, 7)

- [ ] Run regulations ingestion: all years 1950-2026 (newest first for faster value)
- [ ] Run directives ingestion: all years 1950-2026
- [ ] Verify checkpoint system allows resume on interruption (kill + `--resume`)
- [ ] Log final counts and compare to SPARQL API totals (~63,045 regulations, ~4,752 directives)

### Task 5: Add NIM SPARQL Query (AC: 15-16)

- [ ] Add `fetchSwedishNIM()` function to `lib/external/eurlex.ts` using verified SPARQL query:
  ```sparql
  PREFIX cdm: <http://publications.europa.eu/ontology/cdm#>
  SELECT ?dirCelex ?nimCelex ?ojNumber ?actType ?title WHERE {
    ?nim cdm:measure_national_implementing_implements_resource_legal ?dir .
    ?nim cdm:measure_national_implementing_implemented_by_country
      <http://publications.europa.eu/resource/authority/country/SWE> .
    ?dir cdm:resource_legal_id_celex ?dirCelex .
    ?nim cdm:resource_legal_id_celex ?nimCelex .
    OPTIONAL { ?nim cdm:measure_national_implementing_number_official_journal ?ojNumber }
    OPTIONAL { ?nim cdm:measure_national_implementing_type_act ?actType }
    OPTIONAL { ?nim cdm:work_title ?title }
  }
  ```
- [ ] Parse SFS numbers from `ojNumber` field using regex `/(?:SFS\s+)?(\d{4})[:/](\d+)/`
  - Handles formats: "SFS 2025:1440", "2024:1371", "1982/673"
- [ ] Store NIM data in `eu_documents.national_implementation_measures` JSONB:
  ```typescript
  { sweden: { measures: [{ sfs_number, title, act_type, nim_celex }], count: N } }
  ```

### Task 6: Build Cross-References from NIM Data (AC: 17-19)

- [ ] Match NIM SFS numbers against `legal_documents.document_number` (SFS format: "SFS YYYY:NNN")
- [ ] Create `cross_references` entries: SFS law (source) -> EU directive (target), `reference_type = 'IMPLEMENTS'`
  - [Source: architecture/4-data-models.md#48-crossreference]
- [ ] Handle SFS number format normalization: "1982/673" -> "SFS 1982:673"
- [ ] Log: "Matched X of Y NIM SFS numbers to existing laws (Z unmatched)"

### Task 7: Verification and Spot Checks (AC: 20-24)

- [ ] Spot check 10 documents in browser across all structure types:
  - 3 chaptered (e.g. GDPR 32016R0679, REACH 32006R1907, Taxonomy 32020R0852)
  - 3 flat (smaller regulations)
  - 2 minimal (delegated/implementing acts)
  - 2 directives (e.g. Whistleblower 32019L1937, Working Time 32003L0088)
- [ ] Verify TOC/StickyDocNav renders `section.kapitel > h2` headings for chaptered docs
- [ ] Verify `details.preamble-accordion` collapses/expands
- [ ] Verify `<a class="legal-ref">` links navigate to correct SFS law / agency regulation pages
- [ ] Verify cross-reference links appear on directive pages (both REFERENCES and IMPLEMENTS)
- [ ] Compare final DB counts to SPARQL API: regulations (~63,045), directives (~4,752), NIM links (~2,483 directives)

## Dev Notes

### Previous Story Insights (Story 2.4)

[Source: docs/stories/in-progress/2.4.ingest-eu-legislation-eur-lex.md - Dev Agent Record]

- **Connection pool exhaustion**: `connection_limit=1` in DATABASE_URL combined with 50 parallel workers caused failures. Solution: sequential processing only.
- **SPARQL truncation**: Responses > ~1MB get truncated causing JSON parse errors. Solution: smaller `LIMIT` (500 instead of 1000) or batch by year.
- **EUR-Lex WAF**: CloudFront WAF blocks direct EUR-Lex HTML fetching. CELLAR REST API (`publications.europa.eu/resource/celex/{CELEX}`) bypasses this.
- **Correction documents**: CELEX numbers ending in `R(01)`, `R(02)` return 404 from CELLAR (they reference corrections, not standalone docs). Skip these.
- **NIM via HTML was blocked**: The old `fetchNationalMeasures()` tried scraping `eur-lex.europa.eu/legal-content/EN/NIM/` which is WAF-blocked. **SPARQL NIM works** using `cdm:measure_national_implementing_*` predicates.

### Data Models

[Source: architecture/4-data-models.md#45-legaldocument, #47-eudocument, #48-crossreference]

**LegalDocument** (polymorphic, used for EU docs):
- `content_type`: `EU_REGULATION` | `EU_DIRECTIVE`
- `document_number`: CELEX number (e.g. "32016R0679")
- `html_content`: Transformed HTML (article.sfs schema)
- `full_text`: Plain text for RAG/search
- `metadata`: JSONB with celex, structureType, stats, method

**EuDocument** (one-to-one with LegalDocument):
- `celex_number`: Unique, indexed
- `national_implementation_measures`: JSONB for NIM data
- `eli_identifier`, `in_force`, `directory_codes`, `subject_matters`, `eurovoc_concepts`
- `authors`, `legal_basis_celex`, `cites_celex`, `amended_by_celex`, `corrected_by_celex`
- `eea_relevant`, `end_of_validity`, `signature_date`, `transposition_deadline`

**CrossReference**:
- `source_document_id` -> `target_document_id`
- `reference_type`: `'REFERENCES'` (linkification) or `'IMPLEMENTS'` (NIM)
- `context`: Snippet of text surrounding the reference

### API Specifications

[Source: architecture/7-external-apis.md#77-eur-lex-cellar-api-integration]

**SPARQL Endpoint**: `https://publications.europa.eu/webapi/rdf/sparql` (public, no auth)
**CELLAR REST API**: `https://publications.europa.eu/resource/celex/{CELEX}`
- Headers: `Accept: text/html`, `Accept-Language: sv`
- Handles HTTP 300 (Multiple Choices) for language selection
- Rate limit: 2 req/sec (conservative for government API)
- User-Agent: `Laglig.se/1.0 (https://laglig.se; contact@laglig.se)`

**NIM SPARQL** (newly discovered):
- Country filter: `<http://publications.europa.eu/resource/authority/country/SWE>`
- Returns 10,470 Swedish NIM entries across 2,483 directives
- `ojNumber` field contains SFS numbers in varying formats

### HTML Transformation Pipeline

[Source: lib/eu/eu-html-transformer.ts - committed, 30 tests in tests/unit/lib/eu/]

**Processing order**: Raw CELLAR HTML -> `transformEuHtml()` -> `linkifyHtmlContent()` -> store

**Structure detection** (three types, same ELI schema):
- **Chaptered**: 2+ `cpt_*`/`chp_*` divs -> `<section class="kapitel">` + `<h2>` + articles as `<h3>`
- **Flat**: 2+ `art_*` divs -> `<a class="paragraf">` anchors
- **Minimal**: No recognizable structure -> body content only

**Output HTML schema** (compatible with StickyDocNav, `.legal-document` CSS):
```html
<article class="sfs" id="eu-{celex}">
  <div class="lovhead"><h1>...</h1></div>
  <details class="preamble-accordion">
    <summary>Inledning och skäl</summary>
    <div class="preamble">...</div>
  </details>
  <div class="body">
    <section class="kapitel" id="chp-i">
      <h2>KAPITEL I -- Allmänna bestämmelser</h2>
      <h3 id="art-1">Artikel 1 -- <em>Syfte</em></h3>
      ...
    </section>
  </div>
</article>
```

### Linkification Pipeline

[Source: lib/linkify/ - committed, tests in tests/unit/lib/linkify/]

- `buildSlugMap()`: Single DB query loads all `{document_number -> slug, contentType, title, id}`
- `linkifyHtmlContent(html, slugMap, sourceDocNumber)`: Cheerio-based, walks text nodes, detects SFS/agency/court references, injects `<a class="legal-ref">`
- `saveCrossReferences(sourceId, linkedRefs, plainText)`: Deletes old REFERENCES for source, creates fresh ones in transaction
- **Idempotent**: Strips existing `<a class="legal-ref">` and `<a[href]>` (except `.paragraf`) before re-linkifying
- **SlugMap refresh**: Build once, refresh as new docs are inserted to catch EU-to-EU links

### File Locations

[Source: architecture/12-unified-project-structure.md]

```
lib/external/eurlex.ts          # SPARQL + CELLAR API client (add fetchSwedishNIM)
lib/eu/eu-html-transformer.ts   # HTML transformer (existing, 30 tests)
lib/linkify/                    # Linkification pipeline (existing, tested)
  ├── detect-references.ts
  ├── linkify-html.ts
  ├── build-slug-map.ts
  ├── save-cross-references.ts
  ├── rewrite-links.ts
  └── index.ts
scripts/ingest-eu-by-year.ts    # Main ingestion script (modify)
data/eu-ingestion-checkpoint.json  # Checkpoint file (auto-generated)
```

### Technical Constraints

- **Database**: Supabase PostgreSQL with `connection_limit=1` via pgbouncer. Sequential DB writes only.
- **Two-pass strategy**: Docs already in DB with raw CELLAR HTML can be re-transformed in-place (no API call). Only docs missing HTML need CELLAR fetch.
- **CELLAR HTML consistency**: All docs use same ELI schema regardless of age/type/complexity.
- **Estimated runtime**: ~30 min for in-place re-transform, ~9 hours for CELLAR fetch of ~62K missing docs, ~5 min for NIM query, ~10 min for cross-reference building.

### Testing

[Source: architecture/section-15-summary.md#162-unit-testing]

**Framework**: Vitest

**Existing tests** (no new tests needed for ingestion scripts, but verify existing pass):
- `tests/unit/lib/eu/eu-html-transformer.test.ts` (30 tests)
- `tests/unit/lib/linkify/detect-references.test.ts`
- `tests/unit/lib/linkify/linkify-html.test.ts`
- `tests/unit/lib/linkify/build-slug-map.test.ts`

**New test coverage needed**:
- Unit test for `fetchSwedishNIM()` SPARQL query builder (mock SPARQL response)
- Unit test for NIM SFS number parsing (format variations)
- Verify all existing tests pass after pipeline changes: `pnpm test`

**Test file location**: `tests/unit/lib/external/eurlex-nim.test.ts`

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2026-02-13 | 1.0 | Story created based on investigation of SPARQL NIM data, HTML transformer, and linkification pipeline | Bob (SM) |

## Dev Agent Record

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes

_To be filled during implementation_

### File List

_To be filled during implementation_

## QA Results

_To be filled after implementation_
