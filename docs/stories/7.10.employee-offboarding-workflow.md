# Story 7.10: Implement Employee Offboarding Workflow

## Status

Draft

## Story

**As an** HR manager,
**I want** to offboard employees when they leave,
**so that** I maintain accurate records and compliance.

## Acceptance Criteria

1. Employee Profile → "Mark as Inactive" button
2. Offboarding modal fields: Last working day, Offboarding reason (dropdown: Resignation, Termination, Retirement, End of contract)
3. Marking inactive sets `employees.status = 'inactive'` and `employees.end_date`
4. Inactive employees hidden from default Employee List view
5. "Show inactive employees" toggle
6. Inactive employees cannot be assigned to new tasks/laws
7. Data retained for 2 years (GDPR compliance), then hard deleted
8. Export employee data before offboarding (GDPR right to data portability)
9. Activity log records offboarding action

## Tasks / Subtasks

- [ ] Add "Mark as Inactive" button to Employee Profile
- [ ] Create offboarding modal with form fields
- [ ] Implement offboarding logic (set status, end_date)
- [ ] Update Employee List to hide inactive by default
- [ ] Add "Show inactive employees" toggle
- [ ] Prevent inactive employees from task/law assignment
- [ ] Implement GDPR data export functionality
- [ ] Create cron job for 2-year data deletion
- [ ] Log offboarding activity
- [ ] Test offboarding workflow
- [ ] Test data retention policy

## Dev Notes

**Mark as Inactive Button:**

```typescript
// components/hr/employee-profile-header.tsx (updated)
'use client'

import { useState } from 'react'
import { OffboardingModal } from './offboarding-modal'

export function EmployeeProfileHeader({ employee }: { employee: any }) {
  const [showOffboardingModal, setShowOffboardingModal] = useState(false)

  if (employee.status === 'inactive') {
    return (
      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <p className="text-sm text-yellow-800">
          This employee was offboarded on {new Date(employee.endDate!).toLocaleDateString('sv-SE')}.
        </p>
      </div>
    )
  }

  return (
    <div className="flex items-center justify-between mb-6">
      <div>
        <h1 className="text-2xl font-bold">{employee.name}</h1>
        <p className="text-gray-600">{employee.role} • {employee.department}</p>
      </div>

      <button
        onClick={() => setShowOffboardingModal(true)}
        className="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50"
      >
        Mark as Inactive
      </button>

      {showOffboardingModal && (
        <OffboardingModal
          employee={employee}
          isOpen={showOffboardingModal}
          onClose={() => setShowOffboardingModal(false)}
        />
      )}
    </div>
  )
}
```

**Offboarding Modal:**

```typescript
// components/hr/offboarding-modal.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface OffboardingModalProps {
  employee: any
  isOpen: boolean
  onClose: () => void
}

const OFFBOARDING_REASONS = [
  { value: 'resignation', label: 'Resignation' },
  { value: 'termination', label: 'Termination' },
  { value: 'retirement', label: 'Retirement' },
  { value: 'end_of_contract', label: 'End of Contract' }
]

export function OffboardingModal({ employee, isOpen, onClose }: OffboardingModalProps) {
  const router = useRouter()
  const [lastWorkingDay, setLastWorkingDay] = useState('')
  const [reason, setReason] = useState('resignation')
  const [notes, setNotes] = useState('')
  const [isProcessing, setIsProcessing] = useState(false)
  const [exportData, setExportData] = useState(false)

  async function handleOffboard() {
    if (!lastWorkingDay) {
      alert('Please specify the last working day')
      return
    }

    if (!confirm(`Are you sure you want to offboard ${employee.name}? This action cannot be undone easily.`)) {
      return
    }

    setIsProcessing(true)

    try {
      // Export data if requested (GDPR)
      if (exportData) {
        const exportResponse = await fetch(`/api/employees/${employee.id}/export`)
        const blob = await exportResponse.blob()
        const url = URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        link.download = `employee-data-${employee.name.replace(/\s/g, '-')}-${Date.now()}.json`
        link.click()
        URL.revokeObjectURL(url)
      }

      // Offboard employee
      const response = await fetch(`/api/employees/${employee.id}/offboard`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          lastWorkingDay,
          reason,
          notes
        })
      })

      if (response.ok) {
        onClose()
        router.push('/hr/employees')
        router.refresh()
      } else {
        alert('Failed to offboard employee')
      }
    } catch (error) {
      console.error('Offboarding error:', error)
      alert('Failed to offboard employee')
    } finally {
      setIsProcessing(false)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg w-full max-w-2xl p-6">
        <h2 className="text-xl font-bold mb-6">Offboard Employee</h2>

        <div className="space-y-4">
          {/* Warning */}
          <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-sm text-yellow-800">
              Offboarding {employee.name} will mark them as inactive. They will no longer appear in active employee lists
              and cannot be assigned to new tasks or laws.
            </p>
          </div>

          {/* Last Working Day */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Last Working Day *
            </label>
            <input
              type="date"
              value={lastWorkingDay}
              onChange={(e) => setLastWorkingDay(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
              max={new Date().toISOString().split('T')[0]}
            />
          </div>

          {/* Reason */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Offboarding Reason *
            </label>
            <select
              value={reason}
              onChange={(e) => setReason(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            >
              {OFFBOARDING_REASONS.map((r) => (
                <option key={r.value} value={r.value}>
                  {r.label}
                </option>
              ))}
            </select>
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Notes (Optional)
            </label>
            <textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
              placeholder="Additional information about the offboarding..."
            />
          </div>

          {/* Export Data (GDPR) */}
          <div className="flex items-start gap-2">
            <input
              type="checkbox"
              id="exportData"
              checked={exportData}
              onChange={(e) => setExportData(e.target.checked)}
              className="mt-1"
            />
            <label htmlFor="exportData" className="text-sm text-gray-700">
              Export employee data before offboarding (GDPR compliance - right to data portability)
            </label>
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-3 mt-6">
          <button
            onClick={onClose}
            disabled={isProcessing}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:bg-gray-100"
          >
            Cancel
          </button>
          <button
            onClick={handleOffboard}
            disabled={isProcessing}
            className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300"
          >
            {isProcessing ? 'Processing...' : 'Offboard Employee'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

**Offboard API:**

```typescript
// app/api/employees/[id]/offboard/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { checkPermission, Permission } from '@/lib/permissions/roles'
import { WorkspaceRole } from '@prisma/client'
import { prisma } from '@/lib/prisma'

export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_EMPLOYEES)

    const { lastWorkingDay, reason, notes } = await request.json()

    const employee = await prisma.employee.findFirst({
      where: { id: params.id, workspaceId },
    })

    if (!employee) {
      return NextResponse.json({ error: 'Employee not found' }, { status: 404 })
    }

    if (employee.status === 'inactive') {
      return NextResponse.json(
        { error: 'Employee already inactive' },
        { status: 400 }
      )
    }

    // Update employee status
    await prisma.employee.update({
      where: { id: params.id },
      data: {
        status: 'inactive',
        endDate: new Date(lastWorkingDay),
      },
    })

    // Log activity
    await prisma.employeeActivity.create({
      data: {
        employeeId: params.id,
        userId,
        action: 'status_changed',
        changes: {
          status: { old: 'active', new: 'inactive' },
          endDate: { old: null, new: lastWorkingDay },
          reason: { old: null, new: reason },
          notes: { old: null, new: notes },
        },
      },
    })

    return NextResponse.json({ success: true })
  })
}
```

**Export Employee Data API (GDPR):**

```typescript
// app/api/employees/[id]/export/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'
import { decrypt } from '@/lib/encryption'

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId }) => {
    const employee = await prisma.employee.findFirst({
      where: { id: params.id, workspaceId },
      include: {
        manager: true,
        subordinates: true,
        kollektivavtal: {
          include: {
            kollektivavtal: true,
          },
        },
        documents: true,
        activities: {
          include: {
            user: true,
          },
        },
        assignedLaws: {
          include: {
            law: true,
          },
        },
      },
    })

    if (!employee) {
      return NextResponse.json({ error: 'Employee not found' }, { status: 404 })
    }

    // Decrypt personnummer
    const decryptedPersonnummer = await decrypt(employee.personnummer)

    // Build export data
    const exportData = {
      personalInformation: {
        name: employee.name,
        personnummer: decryptedPersonnummer,
        email: employee.email,
        phone: employee.phone,
      },
      employment: {
        role: employee.role,
        department: employee.department,
        employmentDate: employee.employmentDate,
        endDate: employee.endDate,
        contractType: employee.contractType,
        status: employee.status,
        manager: employee.manager
          ? { name: employee.manager.name, email: employee.manager.email }
          : null,
      },
      compliance: {
        status: employee.complianceStatus,
        score: employee.complianceScore,
        reasons: employee.complianceReasons,
      },
      kollektivavtal: employee.kollektivavtal.map((k) => ({
        name: k.kollektivavtal.name,
        type: k.kollektivavtal.type,
        assignedAt: k.assignedAt,
      })),
      documents: employee.documents.map((d) => ({
        fileName: d.fileName,
        fileUrl: d.fileUrl,
        uploadedAt: d.createdAt,
      })),
      assignedLaws: employee.assignedLaws.map((al) => ({
        sfsNummer: al.law.sfsNummer,
        rubrik: al.law.rubrik,
        assignedAt: al.assignedAt,
      })),
      activities: employee.activities.map((a) => ({
        action: a.action,
        changes: a.changes,
        performedBy: a.user.name,
        timestamp: a.createdAt,
      })),
      exportMetadata: {
        exportedAt: new Date().toISOString(),
        exportedBy: 'Laglig.se',
        gdprCompliance: 'Right to data portability (GDPR Article 20)',
      },
    }

    return NextResponse.json(exportData, {
      headers: {
        'Content-Type': 'application/json',
        'Content-Disposition': `attachment; filename="employee-${employee.name.replace(/\s/g, '-')}-${Date.now()}.json"`,
      },
    })
  })
}
```

**Show Inactive Employees Toggle:**

```typescript
// app/hr/employees/page.tsx (updated)
export default function EmployeesPage({ searchParams }: { searchParams: { showInactive?: string } }) {
  const showInactive = searchParams.showInactive === 'true'

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Employees</h1>

        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            checked={showInactive}
            onChange={(e) => {
              const params = new URLSearchParams(searchParams)
              if (e.target.checked) {
                params.set('showInactive', 'true')
              } else {
                params.delete('showInactive')
              }
              router.push(`/hr/employees?${params.toString()}`)
            }}
            className="w-4 h-4"
          />
          <span className="text-sm text-gray-700">Show inactive employees</span>
        </label>
      </div>

      <Suspense fallback={<Skeleton />}>
        <EmployeeList showInactive={showInactive} />
      </Suspense>
    </div>
  )
}
```

**Data Retention Cron Job (2-year deletion):**

```typescript
// app/api/cron/employee-data-retention/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

export async function GET(request: Request) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    // Find employees inactive for >2 years
    const twoYearsAgo = new Date()
    twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2)

    const employeesToDelete = await prisma.employee.findMany({
      where: {
        status: 'inactive',
        endDate: {
          lt: twoYearsAgo,
        },
      },
      include: {
        documents: true,
      },
    })

    const deleted = []

    for (const employee of employeesToDelete) {
      // Delete documents from Supabase Storage
      for (const doc of employee.documents) {
        const filePath = doc.fileUrl.split('/employee-documents/')[1]
        if (filePath) {
          await supabase.storage.from('employee-documents').remove([filePath])
        }
      }

      // Delete employee photo
      if (employee.photoUrl) {
        const photoPath = employee.photoUrl.split('/employee-photos/')[1]
        if (photoPath) {
          await supabase.storage.from('employee-photos').remove([photoPath])
        }
      }

      // Hard delete employee (cascade deletes related records)
      await prisma.employee.delete({
        where: { id: employee.id },
      })

      deleted.push({
        id: employee.id,
        name: employee.name,
        endDate: employee.endDate,
      })
    }

    return NextResponse.json({
      success: true,
      deletedCount: deleted.length,
      deleted,
    })
  } catch (error: any) {
    console.error('Data retention cron error:', error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}
```

**Vercel Cron Configuration:**

```json
// vercel.json (updated)
{
  "crons": [
    {
      "path": "/api/cron/employee-compliance-reminders",
      "schedule": "0 9 * * *"
    },
    {
      "path": "/api/cron/employee-data-retention",
      "schedule": "0 2 1 * *"
    }
  ]
}
```

**Reference:** PRD Epic 7 Story 7.10, GDPR Article 20 (Right to data portability)

## Testing

**Unit Tests:**

- Offboarding sets status to "inactive" and end_date
- Export API returns complete employee data
- Show inactive toggle filters employees correctly
- Data retention cron deletes employees >2 years inactive

**Integration Tests:**

- Offboard employee, verify status changed to "inactive"
- Offboard with data export, verify JSON file downloaded
- Toggle "Show inactive", verify inactive employees appear in list
- Wait 2 years (mock date), run cron, verify employee deleted
- Try assigning inactive employee to task, verify blocked

**Manual Testing:**

- Click "Mark as Inactive", verify modal appears
- Fill in last working day and reason, click "Offboard", verify success
- Check "Export data", offboard, verify JSON file downloaded
- View Employee List, verify offboarded employee hidden
- Toggle "Show inactive", verify offboarded employee appears (grayed out)
- Try to edit inactive employee, verify some fields disabled
- View activity log, verify offboarding action recorded

**GDPR Compliance Testing:**

- Export employee data, verify contains all personal information
- Export employee data, verify includes documents, activities, assigned laws
- Verify exported data in machine-readable format (JSON)
- Verify 2-year retention policy enforced (cron job deletes old data)
- Verify hard deletion removes all traces (database + storage)

**Edge Cases:**

- Offboard employee with no end_date specified (should default to today)
- Offboard employee who is a manager (verify subordinates not affected)
- Export employee with 100+ documents (test performance)
- Run data retention cron with 1000+ inactive employees (test performance)

**Security Testing:**

- Non-authorized roles cannot offboard employees
- Cannot offboard employee from other workspace
- Encrypted personnummer properly decrypted in export
- Export API requires authentication

**Test File:** `__tests__/features/hr/employee-offboarding.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Offboard employees promptly when they leave
- Specify accurate last working day
- Select correct offboarding reason
- Export employee data if requested by employee (GDPR)
- Keep offboarding records for audit purposes

**Developer Responsibility:**

- Implement secure offboarding workflow (confirmation required)
- Export complete employee data (GDPR compliance)
- Hide inactive employees from default views (avoid clutter)
- Prevent inactive employees from task/law assignment
- Enforce 2-year data retention policy automatically
- Hard delete data after retention period (GDPR right to erasure)
- Log all offboarding actions for audit trail
- Optimize data retention cron for large datasets (batch processing)
- Handle edge cases (employee is manager, has pending tasks, etc.)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
