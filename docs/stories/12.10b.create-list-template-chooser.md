# Story 12.10b: Refactor Create List Modal into Template-Aware Chooser

## Status

Ready for Review (QA fixes applied — re-review requested)

## Story

**As a** workspace member,
**I want** the "Skapa ny lista" flow to surface available templates alongside the blank-list option,
**so that** I can discover and adopt expert-curated templates without leaving my workspace context.

## Background

The current "Skapa ny lista" flow (Story 4.11) opens a plain modal with name, description, and default-list toggle. Once templates exist, this is a missed opportunity — users in their workspace should be able to discover and adopt templates at the moment they're creating a new list, not only via the public catalog.

This story refactors the create-list modal into a two-path creation flow that is more engaging and surfaces templates as the recommended starting point.

## Acceptance Criteria

1. When user clicks "Skapa ny lista" (from the document list switcher dropdown), the modal opens with a **chooser view** instead of the current plain form:
   - Two prominent option cards: "Borja fran mall" and "Tom lista"
   - If published templates exist, show a "Populara mallar" section with template preview cards inline (max 3-4)
2. **"Borja fran mall" path**:
   - Selecting a template card shows a quick preview: template name, description, document count, section count, regulatory bodies
   - "Anvand denna mall" button triggers the adoption flow (Story 12.10 server action)
   - Name is pre-filled from template name (editable), description pre-filled from template description — **user-edited name is respected** (passed as `name` override to `adoptTemplate`)
   - Default-list toggle available
   - On success: list created with template items, same toast and redirect as 12.10
3. **"Tom lista" path**:
   - Shows the current create form (name, description, default toggle) — identical to today's behavior
   - No regression in the blank-list creation flow
4. **Template card in chooser**:
   - Shows: template name, domain badge, document count, brief description excerpt
   - Tjansteforetag variants shown as a subtle toggle or secondary option on the parent card
5. **Empty state**: If no published templates exist, skip the chooser and show the current plain form directly (no UX regression)
6. **Edit mode unchanged**: When `mode='edit'`, the modal behaves exactly as today — no chooser, just the edit form
7. Responsive: works on mobile (cards stack vertically)
8. **Keyboard accessible**: Option cards and template cards are keyboard-navigable (Enter/Space to select, focus ring visible)
9. **Step transitions are animated**: Switching between chooser, template preview, and blank form uses smooth crossfade/slide transitions for a premium feel
10. `adoptTemplate()` server action is extended to accept an optional `name` override — when provided, the list uses that name (still deduped via `generateUniqueName`) instead of the template's default name

## UX Wireframe

```
+------------------------------------------------------+
|  Skapa ny laglista                              [x]  |
|  Valj hur du vill borja.                             |
|                                                      |
|  +----------------------+  +----------------------+  |
|  |  Borja fran mall     |  |  Tom lista           |  |
|  |                      |  |                      |  |
|  |  Valj bland expert-  |  |  Skapa en helt egen  |  |
|  |  framtagna laglistor |  |  laglista fran       |  |
|  |  med fardiga lagar   |  |  grunden             |  |
|  |  och sammanfattningar|  |                      |  |
|  |         [Valj]       |  |        [Valj]        |  |
|  +----------------------+  +----------------------+  |
|                                                      |
|  -- Populara mallar -----------                      |
|  +----------+ +----------+ +----------+              |
|  |Arbetsmiljo| |Miljo     | |Arb.tj.   |            |
|  |112 lagar | |98 lagar  | |55 lagar  |             |
|  |Alla arb. | |Tillverk. | |Tjanstefr.|             |
|  +----------+ +----------+ +----------+              |
+------------------------------------------------------+

After selecting a template:
+------------------------------------------------------+
|  <- Tillbaka    Skapa fran mall                  [x] |
|                                                      |
|  Mall: Arbetsmiljo                                   |
|  112 lagar - Arbetsmiljoverket, Riksdagen, EU        |
|  "Komplett laglista for alla svenska arbetsgivare..." |
|                                                      |
|  -- Anpassa ---------------------------------------- |
|  Namn                                                |
|  [Arbetsmiljo                                    ]   |
|                                                      |
|  Beskrivning (valfritt)                              |
|  [Komplett laglista...                           ]   |
|                                                      |
|  Standardlista                              [  o  ]  |
|                                                      |
|               [Avbryt]  [Skapa fran mall]            |
+------------------------------------------------------+
```

## Tasks / Subtasks

- [x] **Task 0: Extend `adoptTemplate` to accept optional name override** (AC: 2, 10)
  - [x] Modify `app/actions/template-adoption.ts`:
    - Add `name: z.string().min(1).optional()` to `AdoptTemplateSchema`
    - Change `generateUniqueName` call (line 92-95): use `parsed.data.name ?? template.name` as the base name instead of always `template.name`
    - No other changes needed — the rest of the action (groups, items, revalidation) is unaffected
  - [x] Add unit test for the new parameter in `tests/unit/app/actions/template-adoption.test.ts` (existing test file from Story 12.10):
    - Test: when `name` is provided, list is created with that name (not template name)
    - Test: when `name` is omitted, list uses template name (existing behavior, no regression)
    - Test: when `name` collides with existing list, `generateUniqueName` appends suffix

- [x] **Task 1: Thread template data from server page to modal** (AC: 1, 5)
  - [x] Modify `app/(workspace)/laglistor/page.tsx` (Server Component):
    - Add `getPublishedTemplates()` import from `@/lib/db/queries/template-catalog`
    - Add to existing `Promise.all` fetch: `getPublishedTemplates()` — runs in parallel with `getDocumentLists()` and `getOrCreateDefaultList()`
    - Pass `publishedTemplates` as new prop to `<DocumentListPageContent />`
  - [x] Modify `components/features/document-list/document-list-page-content.tsx`:
    - Add `publishedTemplates: PublishedTemplate[]` to `DocumentListPageContentProps` interface
    - Thread `publishedTemplates` prop to `<ManageListModal templates={publishedTemplates} />`
  - [x] No client-side fetching — templates are fetched server-side and passed as props (matches existing pattern)

- [x] **Task 2: Refactor ManageListModal to support multi-step** (AC: 1, 3, 5, 6)
  - [x] Modify `components/features/document-list/manage-list-modal.tsx`:
    - Add `templates?: PublishedTemplate[] | undefined` to `ManageListModalProps`
    - Add internal state: `step: 'choose' | 'from-template' | 'blank'`
    - Add state: `selectedTemplate: PublishedTemplate | null`
    - When `mode='create'` and `templates.length > 0`: initial step = `'choose'`
    - When `mode='create'` and `templates.length === 0`: initial step = `'blank'` (current form, no regression)
    - When `mode='edit'`: render current edit form unchanged (no step state machine)
    - Reset step to initial state when modal opens (in existing `useEffect` on `open`)
    - Widen modal: `sm:max-w-lg` when step is `'choose'`, keep `sm:max-w-md` for `'blank'` and `'from-template'`
    - Render step-appropriate content:
      - `'choose'` → `<CreateListChooser>`
      - `'from-template'` → `<CreateListFromTemplate>`
      - `'blank'` → current form (existing JSX, extract to inline or keep as-is)
  - [x] **Animate step transitions** using `framer-motion` (already installed `^12.23.24`):
    - Wrap step content in `<AnimatePresence mode="wait">` with keyed `<motion.div>` per step
    - Enter: `initial={{ opacity: 0, x: 20 }}`, `animate={{ opacity: 1, x: 0 }}` — slide-in from right
    - Exit: `exit={{ opacity: 0, x: -20 }}` — slide-out to left
    - Back navigation reverses direction: enter from left, exit to right (track `direction` state: `1` for forward, `-1` for back)
    - Duration: `0.2s` with `ease: 'easeInOut'` — snappy, not sluggish
    - Import: `import { motion, AnimatePresence } from 'framer-motion'` (same pattern as `components/features/landing/features-section.tsx`)
  - [x] Update `DialogTitle` and `DialogDescription` per step:
    - `'choose'`: title "Skapa ny laglista", description "Valj hur du vill borja."
    - `'from-template'`: title "Skapa fran mall", no description
    - `'blank'`: current title/description (unchanged)

- [x] **Task 3: Create chooser step component** (AC: 1, 4)
  - [x] Create `components/features/document-list/create-list-chooser.tsx` (`'use client'`)
  - [x] Props: `templates: PublishedTemplate[]`, `onSelectTemplate: (template: PublishedTemplate) => void`, `onSelectBlank: () => void`
  - [x] Two prominent option cards side by side:
    - **"Borja fran mall"** card: `Library` icon (from lucide-react), Swedish copy: "Valj bland expertframtagna laglistor med fardiga lagar och sammanfattningar", Button "Valj" — clicking scrolls to / focuses the template cards section below. This card is the recommended path — use a subtle highlight (e.g., `ring-2 ring-primary/20` or `border-primary/30`)
    - **"Tom lista"** card: `Plus` icon, Swedish copy: "Skapa en helt egen laglista fran grunden", Button "Valj" → calls `onSelectBlank()`
    - Cards use `rounded-lg border bg-card p-5 hover:border-primary/50 transition-colors cursor-pointer` pattern — clickable entire card, not just the button
    - **Keyboard accessible**: `role="button" tabIndex={0}` on each card, `onKeyDown` handler fires on `Enter`/`Space` (call `e.preventDefault()` for Space to prevent scroll), visible `focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2` outline
    - Side-by-side on desktop (`grid grid-cols-2 gap-4`), stacked on mobile (`grid-cols-1`)
  - [x] **"Populara mallar"** section below the option cards:
    - Section heading: `<p className="text-sm font-medium text-muted-foreground">Populara mallar</p>` with a subtle `Separator` above
    - Renders `<TemplateOptionCard>` for each template (max 4, slice if more)
    - Horizontal layout: `flex gap-3 overflow-x-auto` on mobile, `grid grid-cols-3 gap-3` on desktop (or flex-wrap)
    - Clicking a template card directly calls `onSelectTemplate(template)` — shortcut that skips the generic "Borja fran mall" card

- [x] **Task 4: Create inline template option card** (AC: 4)
  - [x] Create `components/features/document-list/template-option-card.tsx` (`'use client'`)
  - [x] Props: `template: PublishedTemplate`, `onClick: () => void`
  - [x] Compact card design matching the design language from 12.8/12.9:
    - Domain badge using `DOMAIN_LABELS` and `DOMAIN_COLORS` from `@/lib/constants/template-domains` (with dark mode)
    - Template name (`font-medium text-sm`)
    - Document count with `FileText` icon (`text-xs text-muted-foreground`)
    - Description excerpt (truncated to ~60 chars, `text-xs text-muted-foreground line-clamp-2`)
    - Target audience as secondary text if present
  - [x] Hover state: `hover:border-primary/50 hover:shadow-sm transition-all`
  - [x] **Keyboard accessible**: `role="button" tabIndex={0}`, `onKeyDown` for `Enter`/`Space`, `focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2`
  - [x] Variant display: If `template.variants.length > 0`, show a small secondary text below: "Tjansteforetagsversion tillganglig" (italic, text-xs) — clicking the card always selects the parent. Variant selection is deferred to the template detail preview step or the full catalog.
  - [x] Reuse `Badge` from `@/components/ui/badge` for domain badge

- [x] **Task 5: Create template preview / adopt step** (AC: 2)
  - [x] Create `components/features/document-list/create-list-from-template.tsx` (`'use client'`)
  - [x] Props: `template: PublishedTemplate`, `onBack: () => void`, `onCreated: (listId: string) => void`
  - [x] Template summary display at top:
    - Template name as `<h3 className="font-semibold">`
    - Stats line: `{document_count} lagar` with `FileText` icon, `{section_count} kategorier` with `Layers` icon — same pattern as 12.9 stats bar (but compact, single line)
    - Regulatory bodies as small `<Badge variant="secondary">` badges
    - Description text (full, not truncated)
  - [x] "Tillbaka" button (top-left, `variant="ghost"`, `ArrowLeft` icon) → calls `onBack()`
  - [x] Editable form below the summary (matches existing create form pattern):
    - Separator with label "Anpassa"
    - Name `<Input>` pre-filled with `template.name` (editable, required)
    - Description `<Textarea>` pre-filled with `template.description ?? ''` (editable, optional)
    - Default-list `<Switch>` toggle (default off)
  - [x] Footer: "Avbryt" button + "Skapa fran mall" primary button with `Sparkles` icon
  - [x] On submit: call `adoptTemplate({ templateSlug: template.slug, name: name.trim() })` — passes user-edited name as override. **No workspaceId needed** — the server action resolves workspace from context via `withWorkspace()` when workspaceId is absent [Source: app/actions/template-adoption.ts:61-63]. If the user hasn't changed the name, it passes the original `template.name` which behaves identically to before.
  - [x] Use `useTransition()` for loading state (same pattern as `template-adopt-cta.tsx`)
  - [x] On success: `toast.success(...)` then call `onCreated(result.data.listId)` — the parent modal handles closing and any redirect
  - [x] On error: `toast.error(result.error ?? 'Ett ovantat fel uppstod')`

- [x] **Task 6: Responsive layout** (AC: 7)
  - [x] Chooser step: option cards `grid grid-cols-1 sm:grid-cols-2 gap-4`
  - [x] Template preview cards: `grid grid-cols-1 sm:grid-cols-3 gap-3` with `overflow-x-auto` fallback
  - [x] Preview/adopt step: single-column form layout (same as current modal — naturally responsive)
  - [x] Modal width transitions: `sm:max-w-lg` for chooser, `sm:max-w-md` for form steps — use a conditional className on `<DialogContent>`

- [x] **Task 7: Write tests** (AC: all)
  - [x] **ManageListModal tests** (`tests/unit/components/features/document-list/manage-list-modal.test.tsx`):
    - Chooser renders two option cards when templates are provided
    - Chooser skips to plain form when no templates provided (empty array)
    - Chooser skips to plain form when templates prop is undefined
    - Edit mode renders current form (no chooser, no regression)
    - "Tom lista" card click navigates to blank form step
    - Template card click navigates to template preview step
    - Back button from template preview returns to chooser
    - Back button from blank form returns to chooser (if templates exist)
    - Modal resets to initial step when re-opened
    - Modal title changes based on step
  - [x] **CreateListChooser tests** (`tests/unit/components/features/document-list/create-list-chooser.test.tsx`):
    - Renders "Borja fran mall" and "Tom lista" option cards
    - Renders template preview cards for each template (max 4)
    - Calls `onSelectTemplate` when template card is clicked
    - Calls `onSelectBlank` when "Tom lista" card is clicked
    - Domain badge renders with correct label from DOMAIN_LABELS
    - Option cards are keyboard accessible (Enter key triggers selection)
    - Option cards are keyboard accessible (Space key triggers selection)
    - Option cards have `role="button"` and `tabIndex={0}`
  - [x] **CreateListFromTemplate tests** (`tests/unit/components/features/document-list/create-list-from-template.test.tsx`):
    - Renders template name, document count, regulatory bodies
    - Pre-fills name input with template name
    - Pre-fills description textarea with template description
    - Name input is editable
    - Calls `adoptTemplate` with correct templateSlug and user-edited name on submit
    - Calls `adoptTemplate` with original template name when name is not edited
    - Shows success toast on successful adoption
    - Shows error toast on failed adoption
    - Back button calls `onBack`
    - Renders description text from template
  - [x] **TemplateOptionCard tests** (`tests/unit/components/features/document-list/template-option-card.test.tsx`):
    - Renders template name and document count
    - Renders domain badge with correct label
    - Shows variant availability text when variants exist
    - Does not show variant text when no variants
    - Calls onClick when clicked
    - Keyboard accessible: Enter key triggers onClick
    - Keyboard accessible: Space key triggers onClick
    - Has `role="button"` and `tabIndex={0}`

## Dev Notes

### Previous Story Insights (Story 12.10)

Story 12.10 is Done. Key learnings from Dev Agent Record: [Source: docs/stories/completed/12.10.adopt-template-workspace.md#Dev Agent Record]

- **108 unit test files pass (1474 tests)** — regression baseline to maintain.
- **`adoptTemplate()` server action** at `app/actions/template-adoption.ts` is fully functional. It currently accepts `{ templateSlug: string, workspaceId?: string }`. **This story extends it** to also accept `{ name?: string }` — an optional name override for the created list. When `workspaceId` is omitted, it resolves the current workspace via `withWorkspace()`. The modal does NOT need to pass a workspaceId.
- **`generateUniqueName`** extracted to `lib/utils/generate-unique-name.ts` — handles duplicate list names automatically (appends " (2)", " (3)", etc.).
- **`requireWorkspaceAccess` limitation**: Only validates against the user's *active* workspace context (from cookie). True cross-workspace adoption would need extension. Not relevant for this story (modal is always in current workspace context).
- **Toast library**: `sonner` — `import { toast } from 'sonner'`, use `toast.success()` / `toast.error()`. [Source: components/ui/sonner.tsx]
- **`exactOptionalPropertyTypes` active**: Optional props need explicit `| undefined` annotations (e.g., `templates?: PublishedTemplate[] | undefined`). [Source: docs/architecture/17-coding-standards.md#17.2]
- **No existing tests for `manage-list-modal.tsx`** — Story 4.11 did not include modal tests. This story creates the first test file for it.

### Data Flow Architecture (CRITICAL)

The `ManageListModal` is a client component rendered deep in the component tree. Template data must be fetched server-side and threaded as props:

```
Server Component                     Client Components
------------------                   ------------------
app/(workspace)/laglistor/page.tsx   DocumentListPageContent
  |                                    |
  | getPublishedTemplates()            | publishedTemplates prop
  | (parallel with existing fetches)   |
  v                                    v
  <DocumentListPageContent             <ManageListModal
    initialLists={lists}                 templates={publishedTemplates}
    defaultListId={defaultListId}        ...other existing props
    publishedTemplates={templates}     />
  />
```

[Source: app/(workspace)/laglistor/page.tsx — existing parallel fetch pattern with Promise.all]

**Key**: Do NOT fetch templates client-side. The page server component already uses `Promise.all` for parallel data loading. Adding `getPublishedTemplates()` there is a single-line addition:

```typescript
const [listsResult, defaultListResult, templates] = await Promise.all([
  getDocumentLists(),
  getOrCreateDefaultList(),
  getPublishedTemplates(),  // NEW — runs in parallel
])
```

### Current Modal Implementation (to refactor)

**Entry point chain:** [Source: components/features/document-list/]

1. `document-list-switcher.tsx:96-99` — "Skapa ny lista" dropdown item calls `onCreateList()`
2. `document-list-page-content.tsx:83` — `setManageModalMode('create')` + `setIsManageModalOpen(true)`
3. `manage-list-modal.tsx` — renders the Dialog with form

**Current `ManageListModalProps`:**
```typescript
interface ManageListModalProps {
  open: boolean
  onOpenChange: (_open: boolean) => void
  mode: 'create' | 'edit'
  list?: DocumentListSummary | undefined
  onCreated: (_listId: string) => void
  onUpdated: () => void
  onDeleted: () => void
}
```

Add: `templates?: PublishedTemplate[] | undefined`

**Current modal width:** `sm:max-w-md` on `<DialogContent>` (line 153). Widen to `sm:max-w-lg` for the chooser step.

**Current form** (lines 165-233): `<form>` with Input (name), Textarea (description), Switch (isDefault), error display, footer buttons. This form should remain as-is for the `'blank'` step and `mode='edit'`.

### Multi-step State Machine

```
mode='create':
  has published templates? --yes---> step='choose'
                           --no----> step='blank' (current form, zero regression)

step='choose':
  "Borja fran mall" clicked ---> step='from-template' (with selectedTemplate)
  "Tom lista" clicked ---------> step='blank'
  Template card clicked -------> step='from-template' (with selectedTemplate)

step='from-template':
  "Tillbaka" ---------> step='choose'
  "Skapa fran mall" --> adoptTemplate() -> onCreated()

step='blank':
  "Tillbaka" ---------> step='choose' (only if templates exist)
  "Skapa" ------------> createDocumentList() -> onCreated()

mode='edit':
  Always renders current edit form (no state machine, no regression)
```

### Adoption Integration

The `adoptTemplate()` server action [Source: app/actions/template-adoption.ts] accepts:

```typescript
// BEFORE (Story 12.10):
const AdoptTemplateSchema = z.object({
  templateSlug: z.string().min(1),
  workspaceId: z.string().uuid().optional(),
})

// AFTER (this story extends it):
const AdoptTemplateSchema = z.object({
  templateSlug: z.string().min(1),
  name: z.string().min(1).optional(),       // NEW — user-provided name override
  workspaceId: z.string().uuid().optional(),
})
```

The `name` override is used as the base for `generateUniqueName` instead of `template.name`:
```typescript
// Line 92-95 of template-adoption.ts — CHANGE:
const listName = generateUniqueName(
  parsed.data.name ?? template.name,  // was: template.name
  existingLists.map((l) => l.name)
)
```

**From the modal, call with slug + name:**
```typescript
const result = await adoptTemplate({ templateSlug: template.slug, name: name.trim() })
// workspaceId is intentionally omitted — server action resolves from cookie via withWorkspace()
```

**Return type:** `ActionResult<{ listId: string; listName: string; itemCount: number }>`

On success: `toast.success(\`Mallen '\${result.data.listName}' har lagts till med \${result.data.itemCount} lagar\`)` then `onCreated(result.data.listId)`.

The parent `DocumentListPageContent` handles the redirect/list switch in `handleListCreated` (existing callback).

### Template Query

Reuse `getPublishedTemplates()` from `lib/db/queries/template-catalog.ts` [Source: lib/db/queries/template-catalog.ts:36-72]. Returns `PublishedTemplate[]` — each with:
- `id`, `name`, `slug`, `description`, `domain`, `target_audience`
- `document_count`, `section_count`, `primary_regulatory_bodies`
- `is_variant`, `variants: PublishedTemplateVariant[]`

This is the same query powering the catalog page (12.8). It only returns published, non-variant templates — variants appear as `.variants` on the parent.

### Design Language — "Fun & Intuitive"

Align with the visual language established in Stories 12.8 and 12.9 to make the chooser feel like a natural extension of the template ecosystem:

- **Domain badges**: Reuse `DOMAIN_LABELS`, `DOMAIN_COLORS`, `DEFAULT_DOMAIN_COLOR` from `@/lib/constants/template-domains` — consistent colored badges with dark mode support [Source: lib/constants/template-domains.ts]
- **Icons**: `Library` for "Borja fran mall" card, `Plus` for "Tom lista" card, `FileText` for doc count, `Layers` for section count, `Sparkles` for the adopt button (same as 12.10 CTA), `ArrowLeft` for back navigation. All from `lucide-react`.
- **Card hover states**: `hover:border-primary/50 hover:shadow-sm transition-all` — subtle interactive feedback matching catalog cards
- **Recommended path highlight**: The "Borja fran mall" card should feel like the recommended option — subtle ring or primary border accent
- **Swedish micro-copy**: Keep it warm and inviting ("Valj bland expertframtagna laglistor", "Skapa en helt egen laglista fran grunden")
- **Dark mode**: All custom colors must include `dark:` variants (established pattern across 12.8, 12.9, 12.10)
- **Step transitions**: Use `framer-motion` `AnimatePresence` with `mode="wait"` for crossfade/slide between steps. Direction-aware: forward navigation slides right-to-left, back slides left-to-right. Duration `0.2s` keeps it snappy. [Source: `framer-motion ^12.23.24` already in package.json, used in `components/features/landing/features-section.tsx`]
- **Keyboard polish**: All interactive cards use `role="button" tabIndex={0}` with `onKeyDown` for `Enter`/`Space`. Focus ring: `focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2` (matches shadcn/ui button focus pattern). Premium feel = no mouse-only interactions.

### Existing UI Components to Reuse

- **Dialog**: `components/ui/dialog.tsx` — already used by `ManageListModal` [Source: manage-list-modal.tsx:12-16]
- **Input**: `components/ui/input.tsx` — form fields [Source: manage-list-modal.tsx:17]
- **Textarea**: `components/ui/textarea.tsx` — description field [Source: manage-list-modal.tsx:19]
- **Button**: `components/ui/button.tsx` — actions [Source: manage-list-modal.tsx:20]
- **Switch**: `components/ui/switch.tsx` — default toggle [Source: manage-list-modal.tsx:21]
- **Badge**: `components/ui/badge.tsx` — domain badges, regulatory body badges [Source: components/features/templates/template-card.tsx]
- **Separator**: `components/ui/separator.tsx` — visual dividers between sections
- **Label**: `components/ui/label.tsx` — form labels [Source: manage-list-modal.tsx:18]
- **Sonner toast**: `import { toast } from 'sonner'` [Source: components/ui/sonner.tsx]
- **Icons**: `Library`, `Plus`, `FileText`, `Layers`, `Sparkles`, `ArrowLeft`, `Loader2` from `lucide-react`

### Dependencies

- **Blocked by:** Story 12.10 (adoption server action must exist) -- DONE
- **Blocked by:** Story 12.8 (published template query must exist) -- DONE
- **Uses:** `getPublishedTemplates()` from `lib/db/queries/template-catalog.ts`
- **Uses + Modifies:** `adoptTemplate()` from `app/actions/template-adoption.ts` — adds optional `name` parameter to schema
- **Modifies:** `manage-list-modal.tsx` (Story 4.11), `document-list-page-content.tsx` (Story 4.11), `app/(workspace)/laglistor/page.tsx` (Story 4.11)

### Relevant Source Tree

```
# Modified files
app/actions/template-adoption.ts                                       # ADD optional `name` field to AdoptTemplateSchema, use as base for generateUniqueName
app/(workspace)/laglistor/page.tsx                                     # ADD getPublishedTemplates() to Promise.all, pass as prop
components/features/document-list/document-list-page-content.tsx       # ADD publishedTemplates prop, thread to ManageListModal
components/features/document-list/manage-list-modal.tsx                # ADD multi-step state machine, templates prop, conditional width, AnimatePresence transitions

# New files
components/features/document-list/create-list-chooser.tsx              # NEW — chooser step with option cards + template cards
components/features/document-list/create-list-from-template.tsx        # NEW — template preview + adopt form
components/features/document-list/template-option-card.tsx             # NEW — compact template card for chooser

# No changes
components/features/document-list/document-list-switcher.tsx           # Entry point unchanged (onCreateList callback)
lib/db/queries/template-catalog.ts                                     # REUSE — getPublishedTemplates() query
lib/constants/template-domains.ts                                      # REUSE — DOMAIN_LABELS, DOMAIN_COLORS for badges

# Test files
tests/unit/components/features/document-list/manage-list-modal.test.tsx             # NEW — modal multi-step tests
tests/unit/components/features/document-list/create-list-chooser.test.tsx           # NEW — chooser component tests
tests/unit/components/features/document-list/create-list-from-template.test.tsx     # NEW — template preview/adopt tests
tests/unit/components/features/document-list/template-option-card.test.tsx          # NEW — template card tests
```

### Technical Constraints

- **TypeScript:** 5.5+ strict mode, `exactOptionalPropertyTypes: true` — optional props need explicit `| undefined` [Source: docs/architecture/17-coding-standards.md#17.2]
- **UI Library:** shadcn/ui (Radix UI + Tailwind) — mandatory for all UI components [Source: docs/architecture/17-coding-standards.md#17.3]
- **Icons:** Lucide Icons — tree-shake, import specific icons only [Source: docs/architecture/3-tech-stack.md#3.1]
- **Package manager:** pnpm [Source: docs/architecture/3-tech-stack.md#3.1]
- **Next.js 16:** `params` are Promises that must be awaited (not relevant here — no route params) [Source: docs/architecture/12-unified-project-structure.md]
- **No `any` types**: Use explicit interfaces for all component props [Source: docs/architecture/17-coding-standards.md#17.2]
- **Toast library:** `sonner` — `import { toast } from 'sonner'` [Source: components/ui/sonner.tsx]
- **Server Actions pattern:** `adoptTemplate()` from `app/actions/template-adoption.ts` — extended with optional `name` field in this story (Task 0), no new server action files needed [Source: app/actions/template-adoption.ts]
- **Animation library:** `framer-motion ^12.23.24` (already installed) — use `motion`, `AnimatePresence` [Source: package.json:95]
- **Dark mode:** All custom badge colors MUST include `dark:` variants [Source: lib/constants/template-domains.ts]

### Testing

- **Test framework:** Vitest 1.4+ with React Testing Library 14.2+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Test config:** `vitest.config.mts` — environment: `happy-dom`, setup: `tests/setup.ts` [Source: docs/architecture/section-15-summary.md#16.7]
- **Test location:** `tests/unit/components/features/document-list/`
- **Mocking strategy:** Use `vi.fn()` and `vi.mock()`. Mock `adoptTemplate` server action for component tests. Mock templates data as props. Do NOT make real DB calls in unit tests. [Source: docs/architecture/section-15-summary.md#16.6]
- **Current baseline:** 108 unit test files, 1474 tests (from 12.10)
- **No existing modal tests:** `manage-list-modal.tsx` has no test file. This story creates the first.
- **Sample test fixture** (reuse from 12.8):
```typescript
import type { PublishedTemplate } from '@/lib/db/queries/template-catalog'

const mockTemplateWithVariants: PublishedTemplate = {
  id: 'uuid-1',
  name: 'Arbetsmiljo',
  slug: 'arbetsmiljo',
  description: 'Omfattande lagkrav for alla svenska arbetsgivare inom arbetsmiljoområdet.',
  domain: 'arbetsmiljo',
  target_audience: 'Alla svenska arbetsgivare oavsett bransch',
  document_count: 112,
  section_count: 9,
  primary_regulatory_bodies: ['Arbetsmiljoverket', 'Riksdagen'],
  is_variant: false,
  variants: [{
    id: 'uuid-2',
    name: 'Arbetsmiljo for tjansteforetag',
    slug: 'arbetsmiljo-tjansteforetag',
    document_count: 55,
    section_count: 7,
    target_audience: 'Tjansteforetag',
  }],
}

const mockTemplateNoVariants: PublishedTemplate = {
  id: 'uuid-3',
  name: 'Miljo',
  slug: 'miljo',
  description: 'Miljolagstiftning for verksamheter med miljopåverkan.',
  domain: 'miljo',
  target_audience: 'Verksamheter med miljopåverkan',
  document_count: 98,
  section_count: 9,
  primary_regulatory_bodies: ['Naturvårdsverket', 'Riksdagen'],
  is_variant: false,
  variants: [],
}
```

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-08 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-10 | 2.0     | SM enrichment: Full architecture context from codebase review — verified data flow chain from server page through DocumentListPageContent to ManageListModal (templates must be fetched server-side in page.tsx Promise.all and threaded as props, NOT client-side); Previous story insights from 12.10 (108 test files / 1474 tests baseline, adoptTemplate server action params, generateUniqueName utility, no existing modal tests); Corrected template query path from `lib/db/queries/template.ts` to `lib/db/queries/template-catalog.ts`; Confirmed adoptTemplate accepts `{ templateSlug, workspaceId? }` — modal needs only slug (workspace resolved from cookie); Detailed component architecture with exact prop interfaces, import paths, and source references; Task resequencing — Task 1 now threads data from server to client (critical prerequisite), Tasks 2-5 build the UI components, Task 6 handles responsiveness, Task 7 comprehensive tests with 4 new test files; Design language section documenting "fun & intuitive" visual direction with specific icon, badge, and hover state patterns from 12.8/12.9; Complete test plan with sample fixtures and mocking strategy; Added explicit source references for all technical details | Bob (SM) |
| 2026-02-10 | 2.1     | PO validation fixes: (1) Added Task 0 — extend `adoptTemplate()` server action to accept optional `name` override, so user-edited list name is respected (option B from validation report); (2) Added AC 8 — keyboard accessibility for all interactive cards (`role="button"`, `tabIndex`, Enter/Space handlers, `focus-visible` ring); (3) Added AC 9 — animated step transitions using `framer-motion` `AnimatePresence` with direction-aware slide/crossfade (0.2s, snappy); (4) Added AC 10 — `adoptTemplate` schema extension; (5) Updated Tasks 2-5 with keyboard and animation requirements inline; (6) Updated test plan (Task 7) with keyboard accessibility tests and animation presence tests; (7) Updated source tree — `template-adoption.ts` moved from REUSE to MODIFIED; (8) Updated Dev Notes: Adoption Integration section shows before/after schema, `generateUniqueName` change, modal call signature with name; Design Language section adds animation and keyboard polish guidance | Sarah (PO) |

## Dev Agent Record

**Agent Model Used:** Claude Opus 4.6
**Date Completed:** 2026-02-10

### Completion Notes

All 8 tasks (Task 0–7) implemented and validated. The multi-step modal state machine with framer-motion animations, template chooser, template preview/adopt form, and blank form steps all work as specified. Tests cover all acceptance criteria. TypeScript type check passes with zero errors. Full regression suite passes (112 unit test files, 1513 tests — baseline was 108 files, 1474 tests, net +4 files, +39 tests). 7 pre-existing integration test failures are unrelated to this story.

**QA Fixes (2026-02-10):** Applied 3 fixes from Quinn's review (gate CONCERNS → re-review requested):
- FORM-001: Extended `adoptTemplate()` to accept `description` and `isDefault` params. Client now sends both. +2 server action tests.
- CODE-001: Replaced inline SVG back arrow with `ArrowLeft` from lucide-react in `manage-list-modal.tsx`.
- CODE-002: Removed redundant JS `slice(0, 60)` truncation in `template-option-card.tsx`, relying on `line-clamp-2` CSS.

### Debug Log

- **Test fix 1:** `getByText('Arbetsmiljö')` found multiple elements because domain badge label and template name are identical. Fixed by using `getAllByText` with `toBeGreaterThanOrEqual(1)` assertions.
- **Test fix 2:** `getByText('Skapa från mall')` found multiple elements (dialog title + button text). Fixed with `getAllByText`.
- **Test fix 3:** Template description text appeared in both summary paragraph and pre-filled textarea. Fixed with `getAllByText`.
- **QA fix 1:** Updated `create-list-from-template.test.tsx` assertions to expect `description` and `isDefault` in `adoptTemplate()` call args.

### File List

**Modified files:**
- `app/actions/template-adoption.ts` — Extended `AdoptTemplateSchema` with optional `name`, `description`, `isDefault` fields; passes description/is_default to LawList.create
- `app/(workspace)/laglistor/page.tsx` — Added `getPublishedTemplates()` to `Promise.all`, passed as prop
- `components/features/document-list/document-list-page-content.tsx` — Added `publishedTemplates` prop, threaded to ManageListModal
- `components/features/document-list/manage-list-modal.tsx` — Rewritten: multi-step state machine, framer-motion transitions, conditional width/title

**New files:**
- `components/features/document-list/create-list-chooser.tsx` — Chooser step with option cards + template cards
- `components/features/document-list/create-list-from-template.tsx` — Template preview + adopt form
- `components/features/document-list/template-option-card.tsx` — Compact template card for chooser

**Test files (all new):**
- `tests/unit/components/features/document-list/manage-list-modal.test.tsx` — 10 tests
- `tests/unit/components/features/document-list/create-list-chooser.test.tsx` — 8 tests
- `tests/unit/components/features/document-list/create-list-from-template.test.tsx` — 10 tests
- `tests/unit/components/features/document-list/template-option-card.test.tsx` — 8 tests
- `tests/unit/app/actions/template-adoption.test.ts` — 5 new tests added (17 total)

### Change Log

| Date       | Change | Files |
|------------|--------|-------|
| 2026-02-10 | Task 0: Extended adoptTemplate with optional name override | `app/actions/template-adoption.ts`, `tests/unit/app/actions/template-adoption.test.ts` |
| 2026-02-10 | Task 1: Threaded template data from server page to modal | `app/(workspace)/laglistor/page.tsx`, `components/features/document-list/document-list-page-content.tsx` |
| 2026-02-10 | Task 2: Refactored ManageListModal to multi-step with animations | `components/features/document-list/manage-list-modal.tsx` |
| 2026-02-10 | Task 3: Created CreateListChooser component | `components/features/document-list/create-list-chooser.tsx` |
| 2026-02-10 | Task 4: Created TemplateOptionCard component | `components/features/document-list/template-option-card.tsx` |
| 2026-02-10 | Task 5: Created CreateListFromTemplate component | `components/features/document-list/create-list-from-template.tsx` |
| 2026-02-10 | Task 6: Responsive layout built into all components | All new component files |
| 2026-02-10 | Task 7: 39 new tests across 4 new test files + 3 added to existing | All test files listed above |
| 2026-02-10 | QA fixes: FORM-001 (description/isDefault propagation), CODE-001 (ArrowLeft icon), CODE-002 (remove JS truncation) | `app/actions/template-adoption.ts`, `components/features/document-list/create-list-from-template.tsx`, `components/features/document-list/manage-list-modal.tsx`, `components/features/document-list/template-option-card.tsx`, `tests/unit/actions/template-adoption.test.ts`, `tests/unit/components/features/document-list/create-list-from-template.test.tsx` |

## QA Results

### Review Date: 2026-02-10

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Good implementation overall. The multi-step state machine in `manage-list-modal.tsx` is clean and well-structured. Component decomposition into 4 focused client components (`ManageListModal`, `CreateListChooser`, `CreateListFromTemplate`, `TemplateOptionCard`) follows the existing pattern. Server-side data threading from `page.tsx → DocumentListPageContent → ManageListModal` is correct. TypeScript compiles with zero errors. All 51 tests pass (15 server action + 36 component tests).

One medium-severity concern: the template adoption form collects `description` and `isDefault` input from the user but silently discards both — the `adoptTemplate()` server action only accepts `{ templateSlug, name, workspaceId }`. This creates a data-loss UX gap where user edits have no effect.

### Refactoring Performed

None — no refactoring performed during this review.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, explicit interfaces, shadcn/ui components, lucide-react icons
- Project Structure: ✓ Components in `components/features/document-list/`, tests in `tests/unit/components/features/document-list/`
- Testing Strategy: ✓ Unit tests with RTL + vitest, mocked server actions, keyboard accessibility assertions
- All ACs Met: ✗ AC 2 partially — `description` and `isDefault` fields render but their values are not sent to the server

### Improvements Checklist

- [ ] **FORM-001 (Medium)**: Either extend `adoptTemplate()` to accept `description` and `isDefault` parameters and propagate them to `LawList.create()`, OR remove the description textarea and default-list toggle from the template adoption form to avoid user confusion. Recommended: extend the server action — the fields are already in the UI and match user expectations.
- [ ] **CODE-001 (Low)**: Replace inline SVG back arrow in `manage-list-modal.tsx:239-250` with `ArrowLeft` from lucide-react (already used in `create-list-from-template.tsx:8`). Keeps icon sourcing consistent.
- [ ] **CODE-002 (Low)**: In `template-option-card.tsx:56-59`, remove the JS `slice(0, 60)` truncation and rely solely on `line-clamp-2` CSS. The JS truncation can cut mid-word and produces a double truncation effect.

### Security Review

No security concerns. Server action is auth-gated via `withWorkspace()` / `requireWorkspaceAccess()`. Zod schema validates all input. No raw error message leakage — Swedish user-facing messages used throughout.

### Performance Considerations

No performance concerns. Templates are fetched server-side in `Promise.all` (parallel with existing data fetches), not client-side. The chooser renders max 4 template cards. framer-motion animations use lightweight crossfade (0.2s duration).

### Files Modified During Review

None — this is an advisory review with no code changes.

### Gate Status

Gate: CONCERNS → docs/qa/gates/12.10b-create-list-template-chooser.yml

### Recommended Status

✗ Changes Required — See unchecked items above (FORM-001 is the priority item)
(Story owner decides final status)

---

### Re-Review Date: 2026-02-10

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

All 3 previous issues resolved. Implementation quality is now excellent. The `adoptTemplate()` server action properly accepts and propagates `description` and `isDefault` to `LawList.create()` (lines 106-107). ArrowLeft icon from lucide-react is used consistently. Description truncation uses CSS-only `line-clamp-2`. TypeScript compiles with zero errors. All 53 tests pass (17 server action + 36 component).

### Refactoring Performed

None — all fixes were applied by dev prior to re-review.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, explicit interfaces, shadcn/ui components, lucide-react icons
- Project Structure: ✓ Components in `components/features/document-list/`, tests in `tests/unit/components/features/document-list/`
- Testing Strategy: ✓ Unit tests with RTL + vitest, mocked server actions, keyboard accessibility assertions
- All ACs Met: ✓ All 10 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] **FORM-001 (Medium)**: `adoptTemplate()` extended with `description` and `isDefault` params — both propagated to `LawList.create()`. Client sends both. +2 server action tests verify.
- [x] **CODE-001 (Low)**: Inline SVG replaced with `ArrowLeft` from lucide-react in `manage-list-modal.tsx`.
- [x] **CODE-002 (Low)**: JS `slice(0, 60)` removed from `template-option-card.tsx`, CSS `line-clamp-2` used alone.

### Security Review

No security concerns. Auth gated via `withWorkspace()` / `requireWorkspaceAccess()`. Zod schema validates all input including new `description` (max 500 chars) and `isDefault` (boolean) fields. No raw error leakage.

### Performance Considerations

No performance concerns. Server-side parallel fetch via `Promise.all`. Max 4 template cards rendered. Lightweight framer-motion animations (0.2s).

### Files Modified During Review

None — advisory re-review with no code changes.

### Gate Status

Gate: PASS → docs/qa/gates/12.10b-create-list-template-chooser.yml

### Recommended Status

✓ Ready for Done
(Story owner decides final status)
