# Story 2.1: Design Multi-Content-Type Data Model

## Status

Draft

## Story

**As a** developer,
**I want** to create a flexible database schema supporting multiple legal document types,
**so that** we can store SFS laws, court cases, and EU legislation with type-specific metadata.

## Acceptance Criteria

1. `ContentType` enum created with values: SFS_LAW, HD_SUPREME_COURT, HOVR_COURT_APPEAL, HFD_ADMIN_SUPREME, MOD_ENVIRONMENT_COURT, MIG_MIGRATION_COURT, EU_REGULATION, EU_DIRECTIVE
2. `legal_documents` table created with polymorphic schema (id, content_type, document_number, title, summary, full_text, effective_date, publication_date, status, source_url, metadata, search_vector, embedding)
3. Type-specific tables: `court_cases` and `eu_documents`
4. `cross_references` table created
5. `amendments` table with 7 enhanced fields (competitive feature)
6. `document_subjects` table for categorization
7. Prisma schema updated with all models and relations
8. Migration generated and applied successfully
9. TypeScript types generated for all models
10. Test data inserted for each content type validates schema

## Tasks / Subtasks

- [ ] Create Prisma schema enums (AC: 1)
  - [ ] ContentType enum
  - [ ] DocumentStatus enum
  - [ ] Add to schema.prisma

- [ ] Design `legal_documents` polymorphic table (AC: 2)
  - [ ] Core fields common to all document types
  - [ ] search_vector (tsvector) for full-text search
  - [ ] embedding (vector(1536)) for semantic search
  - [ ] Indexes on document_number, content_type

- [ ] Create type-specific tables (AC: 3)
  - [ ] `court_cases` table with foreign key to legal_documents
  - [ ] `eu_documents` table with CELEX, NIM fields
  - [ ] One-to-one relationships

- [ ] Design `cross_references` table (AC: 4)
  - [ ] source_document_id, target_document_id
  - [ ] reference_type, context fields
  - [ ] Bidirectional navigation support

- [ ] Create `amendments` table with enhanced metadata (AC: 5)
  - [ ] 7 fields per competitive analysis
  - [ ] base_document_id, amending_document_id
  - [ ] affected_sections (JSON), summary (GPT-4), effective_date
  - [ ] See docs/notisum-amendment-competitive-analysis.md

- [ ] Create `document_subjects` table (AC: 6)
  - [ ] document_id, subject_code, subject_name
  - [ ] Many-to-many relationship

- [ ] Generate and apply migration (AC: 7, 8)
  - [ ] Run: npx prisma migrate dev --name multi-content-type
  - [ ] Verify all tables created in Supabase

- [ ] Generate TypeScript types (AC: 9)
  - [ ] Run: npx prisma generate
  - [ ] Verify types available in code

- [ ] Insert test data (AC: 10)
  - [ ] Sample SFS law
  - [ ] Sample court case
  - [ ] Sample EU regulation
  - [ ] Sample amendment with all 7 fields
  - [ ] Verify queries work

## Dev Notes

### Complete Schema Reference

See Architecture Section 9 (Database Schema) for full 29-entity schema. This story implements core legal content entities.

### Amendment Table Design (Competitive Feature)

**7 Fields per Notisum competitive analysis:**

```prisma
model Amendment {
  id                    String   @id @default(uuid())
  baseDocumentId        String
  amendingDocumentId    String
  amendingLawTitle      String   // "Lag (2025:732) om ändring i..."
  publicationDate       DateTime
  effectiveDate         DateTime?
  affectedSectionsRaw   String?  // "ändr. 6 kap. 17 §; upph. 8 kap. 4 §"
  affectedSections      Json?    // {amended: ["6:17"], repealed: ["8:4"]}
  summary               String?  // GPT-4 generated, 2-3 sentences
  summaryGeneratedBy    String?  // GPT_4, HUMAN, SFSR, RIKSDAGEN
  detectedMethod        String?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  baseDocument     LegalDocument @relation("BaseDocument", fields: [baseDocumentId], references: [id])
  amendingDocument LegalDocument @relation("AmendingDocument", fields: [amendingDocumentId], references: [id])

  @@map("amendments")
}
```

**Reference:** docs/notisum-amendment-competitive-analysis.md, docs/historical-amendment-tracking-strategy.md

### Testing

**Test File:** `tests/integration/database/schema.test.ts`

Verify all tables created, relationships work, test data inserts successfully.

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
