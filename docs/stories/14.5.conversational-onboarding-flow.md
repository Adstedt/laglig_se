# Story 14.5: Conversational Onboarding Flow

## Status

Draft

## Story

**As a** new workspace admin,
**I want** the compliance partner to interview me about my company through natural conversation,
**so that** my profile is populated without filling out forms.

## Context & Dependencies

Instead of a form, the agent conducts a natural Swedish conversation with 5-7 adaptive questions. The conversation is stored as a WorkspaceConversation, and structured fields are extracted and saved to WorkspaceProfile. This is the "lowest friction" approach to company profiling.

- **Builds on:** Existing chat UI patterns from Story 3.3 (`app/(workspace)/chat/`), Vercel AI SDK 5.0+ streaming architecture
- **Depends on:** 14.4 (WorkspaceProfile model must exist)
- **Depended on by:** 14.9 (system prompt references onboarding data), 14.10 (assessment flow uses company context)

## Acceptance Criteria

### Schema

1. Prisma model `WorkspaceConversation` with relation to Workspace
2. Fields: id (cuid), workspaceId, type (enum), transcript (Json), extractedInsights (Json), conductedAt (DateTime), createdAt, updatedAt
3. ConversationType enum: ONBOARDING, CHECK_IN, AD_HOC
4. Database migration runs cleanly

### Onboarding Agent

5. Onboarding prompt instructs the agent to ask 5-7 adaptive questions in Swedish about the company
6. Questions adapt based on previous answers (e.g., construction -> ask about heights and chemicals)
7. Agent extracts structured WorkspaceProfile fields from the conversation
8. After conversation completes, extracted fields are saved to WorkspaceProfile via server action
9. Both raw transcript and extracted insights stored in WorkspaceConversation

### UI

10. Onboarding accessible from: (a) first visit to compliance partner page, (b) settings page "Kor onboarding igen" button
11. Chat-style UI using existing Vercel AI SDK patterns (`useChat` hook)
12. Completion indicator: when the agent has enough info, it summarizes what it learned and confirms with the user
13. "Hoppa over" (skip) option — user can skip onboarding and fill profile manually

### Periodic Check-in

14. Agent can initiate check-in conversation: "Har nagot andrats i er verksamhet?" (triggered from settings or after N months)
15. Check-in updates existing WorkspaceProfile fields, preserving what hasn't changed

### Testing

16. At least 8 unit tests covering conversation storage, field extraction, profile update

## Tasks / Subtasks

- [ ] **Task 1: Prisma schema** (AC: 1-4)
  - [ ] Add `WorkspaceConversation` model to `prisma/schema.prisma`
  - [ ] Add `ConversationType` enum with ONBOARDING, CHECK_IN, AD_HOC
  - [ ] Add relation to Workspace (many conversations per workspace)
  - [ ] Generate and run migration

- [ ] **Task 2: Onboarding prompt** (AC: 5-7)
  - [ ] Create `lib/agent/onboarding-prompt.ts`
  - [ ] System prompt: conduct a 5-7 question interview in Swedish
  - [ ] Adaptive question logic: branch based on industry/activity answers
  - [ ] Field extraction instructions: output structured JSON at conversation end
  - [ ] Example opening: "Hej! Jag ar er compliance-partner. Beratta lite om ert foretag sa att jag kan ge er relevanta rad."

- [ ] **Task 3: Field extraction** (AC: 8-9)
  - [ ] Create `lib/agent/extract-profile-fields.ts`
  - [ ] Parse agent's final structured JSON output
  - [ ] Map extracted fields to WorkspaceProfile schema
  - [ ] Handle partial extraction (not all fields may be captured)
  - [ ] Validate extracted values against enums

- [ ] **Task 4: Server actions** (AC: 8-9)
  - [ ] Create `app/actions/workspace-conversation.ts`
  - [ ] `saveOnboardingConversation(transcript, extractedInsights)` — stores conversation record
  - [ ] Trigger field extraction and profile update after save
  - [ ] Update `WorkspaceProfile.lastOnboardingAt` timestamp
  - [ ] Use `withWorkspace(callback, 'write')` for mutations

- [ ] **Task 5: Onboarding UI** (AC: 10-13)
  - [ ] Create onboarding chat component using `useChat()` hook from `@ai-sdk/react`
  - [ ] API route: `app/api/agent/onboarding/route.ts` with `streamText()`
  - [ ] First-visit detection: check if WorkspaceProfile has been onboarded
  - [ ] Show onboarding prompt on first compliance partner visit
  - [ ] Add "Kor onboarding igen" button to settings page
  - [ ] Completion detection: agent signals conversation complete
  - [ ] Summary confirmation: agent recaps extracted info, user confirms
  - [ ] "Hoppa over" skip button

- [ ] **Task 6: Check-in capability** (AC: 14-15)
  - [ ] Reuse onboarding flow with `CHECK_IN` conversation type
  - [ ] Check-in prompt: "Har nagot andrats i er verksamhet sedan [lastOnboardingAt]?"
  - [ ] Merge logic: only update fields that changed, preserve existing values
  - [ ] Add "Kor uppfoljning" button to settings page

- [ ] **Task 7: Tests** (AC: 16)
  - [ ] Write unit tests for field extraction from sample agent outputs
  - [ ] Write unit tests for conversation storage
  - [ ] Write unit tests for profile update merging (check-in preserves existing)
  - [ ] Minimum 8 tests total

## Dev Notes

- Vercel AI SDK 5.0: `useChat()` hook in `@ai-sdk/react` with transport-based architecture
- Existing chat UI pattern: `app/(workspace)/chat/page.tsx` — reference for streaming chat implementation
- Agent prompt should output structured JSON at the end of conversation with extracted fields mapping to WorkspaceProfile
- Use `streamText()` from `ai` package for the API route
- API route: `app/api/agent/onboarding/route.ts`
- The agent should feel like a helpful colleague, not a form. Example opening:
  > "Hej! Jag ar er compliance-partner. Beratta lite om ert foretag sa att jag kan ge er relevanta rad. Vilken typ av verksamhet driver ni?"
- Transcript JSON format: `[{ role: 'user' | 'assistant', content: string, timestamp: string }]`
- ExtractedInsights JSON: `{ companyName, organizationType, industryLabel, employeeCountRange, activityFlags, certifications, ... }` — mirrors WorkspaceProfile fields
- Completion signal: the agent includes a special marker (e.g., `[ONBOARDING_COMPLETE]`) in its final message, followed by a JSON block with extracted fields. The UI strips the marker and triggers save.
- Check-in merge strategy: for each field in extractedInsights, only overwrite if the new value is non-null. Use `Object.entries(insights).filter(([_, v]) => v != null)` to build the update payload.
- Source tree:
  - `prisma/schema.prisma` — add WorkspaceConversation model
  - `lib/agent/onboarding-prompt.ts` (new) — system prompt
  - `lib/agent/extract-profile-fields.ts` (new) — extraction logic
  - `app/actions/workspace-conversation.ts` (new) — server actions
  - `app/api/agent/onboarding/route.ts` (new) — streaming API route
  - `app/(workspace)/chat/` — existing chat UI for reference

## Testing

- **Test files:**
  - `tests/unit/agent/extract-profile-fields.test.ts`
  - `tests/unit/actions/workspace-conversation.test.ts`
- **What to test:**
  - Field extraction from a complete agent output with all fields present
  - Field extraction from partial agent output (missing fields)
  - Field extraction with invalid enum values (should skip or map to closest)
  - Conversation storage with correct type and transcript format
  - Profile update from onboarding (fresh profile)
  - Profile update from check-in (merge with existing profile, preserve unchanged fields)
  - Check-in doesn't clear fields that weren't mentioned
  - lastOnboardingAt is updated after save
- **Patterns to follow:** Mock AI SDK for conversation tests. Mock Prisma client for storage tests. Use `vi.mock` for dependencies. Follow existing test patterns in `tests/unit/actions/`.

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2026-02-18 | 0.1     | Initial draft                  | Claude |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
