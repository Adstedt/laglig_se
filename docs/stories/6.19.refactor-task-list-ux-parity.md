# Story 6.19: Refactor Task List View for UX Parity with Law List

## Status

Dev Complete (All 10 tasks + post-completion UX refinements, 41 tests passing)

## Story

**As a** compliance manager using the task list view,
**I want** the task list to have the exact same table design, toolbar layout, column resizing, column visibility settings, inline editing, and filter UX as the law list view,
**so that** I have a consistent, polished experience across both views and can customize the task table to suit my workflow.

## Acceptance Criteria

**Toolbar Refactoring (UnifiedToolbar Complex Layout):**

1. When the "Lista" tab is active, the task workspace toolbar upgrades to `layout="complex"` with two rows:
   - Row 1: Tab navigation (Zone A) + primary CTA "Ny uppgift" (Zone D)
   - Row 2: Search input + filter dropdowns (Zone B) + Column settings (Zone C)
2. Other tabs (Sammanfattning, Aktiva, Kalender, Alla) retain the current `standard` layout
3. Search input uses debounced `SearchInput` pattern matching law list (300ms debounce, "Sök uppgifter..." placeholder, clear button)
4. Filter dropdowns for Status, Priority, and Assignee move from the standalone `TaskFilters` component into the toolbar's Zone B as `filterDropdowns`
5. Item count ("Visar X av Y uppgifter") renders between toolbar rows using `ToolbarItemCount` component

**Column Resizing:**

6. All data columns (title, status, assignee, due date, priority, created date) support drag-to-resize
7. Column min/max sizes defined per column (matching law list pattern)
8. Column sizes persist across page reloads via Zustand store with localStorage persistence
9. Resize handles appear on column header borders on hover — exact same CSS as law list (vertical bar, `cursor: col-resize`, blue highlight when actively resizing)
10. Select, status icon, and actions columns remain fixed-width (not resizable)

**Column Visibility Settings:**

11. A "Kolumner" settings button appears in Zone C of the toolbar — reuses the extracted generic `ColumnSettings` component
12. Dropdown lists all optional columns with checkbox toggles: Comments, Assignee, Due Date, Priority, Created Date
13. Title and Status columns are always visible (cannot be hidden)
14. Column visibility state persists across page reloads via Zustand store
15. "Aterstall standard" (Reset to defaults) button restores default visibility

**Inline Cell Editing (Matching Law List):**

16. Priority column is inline-editable via dropdown — reuses existing `PriorityEditor` component from law list (adapted for task priority values: LOW/MEDIUM/HIGH/CRITICAL)
17. Due Date column is inline-editable via date picker — reuses existing `DueDateEditor` component from law list
18. Assignee column is inline-editable via avatar dropdown — reuses existing `AssigneeEditor` component from law list
19. Status column is inline-editable via dropdown showing task columns (Att gora, Pagaende, Klar, etc.) with color indicators
20. Inline edits use optimistic updates with server-side persistence and rollback on error

**Table Styling Consistency:**

21. Table row height matches law list exactly: 52px estimated row height, `px-3 py-2` cell padding
22. Sortable column headers use identical `SortableHeader` styling: ghost button, `-ml-4 h-8`, ArrowUp/ArrowDown/ArrowUpDown icons
23. Badge styling for Status and Priority uses identical CSS classes as law list (border-radius, padding, font-size, color patterns)
24. Assignee cell renders with same avatar pattern: `h-6 w-6` avatar, `max-w-[100px]` truncated name, initials fallback
25. Empty state matches law list: centered icon + heading + description + action button
26. Hover states match: `hover:bg-muted/50` on rows, `group-hover:opacity-100` on action buttons
27. Selected row state uses `data-state="selected"` matching law list
28. Overdue tasks retain the `bg-destructive/5` background highlight

**Filter UX Improvements:**

29. Status filter uses Popover + Checkbox pattern — identical to law list's compliance status filter (popover trigger button with label + active count badge + chevron, checkbox list inside)
30. Priority filter uses Popover + Checkbox pattern with colored priority badges as checkbox labels
31. Assignee filter uses Select dropdown with Avatar options — identical to law list's responsible person filter (label "Ansvarig:", avatar + name options, "Alla" default)
32. Active filter count displayed as `Badge variant="secondary"` on each filter trigger (e.g., "Status" with badge showing "2")
33. "Rensa filter" button with X icon appears when any filter is active — identical to law list's clear button pattern

**State Management:**

34. Task list view state (column sizing, column visibility, sorting) managed via a dedicated Zustand store with `persist` middleware
35. Filter state (search, status, priority, assignee) reflected in URL search params for shareability
36. State persists independently per workspace (keyed by workspace ID in store name)

**Component Reuse — Extract Shared Patterns:**

37. Extract a generic `ColumnSettings` component to `components/ui/column-settings.tsx` that accepts `columnOptions: { id, label, defaultVisible }[]` as props — both law list and task list use this shared component
38. Extract a generic `FilterPopover` component to `components/ui/filter-popover.tsx` encapsulating the Popover + Checkbox + count badge + clear pattern — both law list and task list use this shared component
39. Reuse existing `PriorityEditor`, `DueDateEditor`, and `AssigneeEditor` from `document-list/table-cell-editors/` — adapt imports and types but do not duplicate the component code
40. Reuse the `SortableHeader` component by extracting to a shared location or importing directly

## Tasks / Subtasks

- [x] **Task 1: Extract shared UI components** (AC: 37, 38, 40)
  - [x] Extract `components/ui/column-settings.tsx` — generic ColumnSettings accepting `columnOptions` prop
    - Interface: `{ columnOptions: { id: string, label: string, defaultVisible: boolean }[], columnVisibility: VisibilityState, onColumnVisibilityChange: (v: VisibilityState) => void }`
    - Move rendering logic from `document-list/column-settings.tsx`, keep that file as a thin wrapper passing law-list-specific column options
  - [x] Extract `components/ui/filter-popover.tsx` — generic FilterPopover component
    - Interface: `{ label: string, options: { value: string, label: string, color?: string }[], selected: string[], onToggle: (value: string) => void, onClear: () => void }`
    - Encapsulates: Popover trigger (Button with label + count badge + chevron), PopoverContent with checkbox list
  - [x] Extract `components/ui/sortable-header.tsx` — generic SortableHeader for TanStack table columns
    - Currently duplicated in both `list-tab.tsx` and `document-list-table.tsx`
  - [x] Refactor `document-list/column-settings.tsx` to use the new shared `ColumnSettings` (thin wrapper passing `COLUMN_OPTIONS`)
  - [x] Refactor `document-list/compliance-filters.tsx` to use the new shared `FilterPopover` for status and category filters
  - [x] Verify law list still works identically after refactoring

- [x] **Task 2: Create task-list-store.ts** (AC: 8, 14, 34, 36)
  - [x] Create `lib/stores/task-list-store.ts` using Zustand with `persist` middleware
  - [x] Store shape: `columnSizing: ColumnSizingState`, `columnVisibility: VisibilityState`, `sorting: SortingState`
  - [x] Default column visibility: all columns visible (matches current behavior)
  - [x] Default column sizing: current fixed sizes as initial widths (title=300, columnName=120, assignee=150, dueDate=140, priority=100, createdAt=100)
  - [x] Persist to localStorage with key `task-list-store-{workspaceId}`
  - [x] Actions: `setColumnSizing`, `setColumnVisibility`, `resetColumnVisibility`, `setSorting`

- [x] **Task 3: Build task-specific filter dropdowns** (AC: 4, 29, 30, 31, 32, 33)
  - Depends on: Task 1 (needs shared FilterPopover component)
  - [x] Create `components/features/tasks/task-workspace/task-filters-toolbar.tsx`
  - [x] `TaskStatusFilter`: uses shared `FilterPopover` with task column names + color dots as options
  - [x] `TaskPriorityFilter`: uses shared `FilterPopover` with priority values (Lag/Medium/Hog/Kritisk) + colored badges
  - [x] `TaskAssigneeFilter`: uses Select dropdown with Avatar options — replicate exact pattern from `compliance-filters.tsx` responsible person filter (label "Ansvarig:", Avatar + name, "Alla" default with User icon)
  - [x] `TaskFilterBar`: composite component rendering all three filters + "Rensa filter" clear button
  - [x] Each filter tracks active count, displays Badge on trigger when filters active
  - [ ] Delete old `task-filters.tsx` after migration complete

- [x] **Task 4: Add URL-based filter state** (AC: 35)
  - [x] Persist search query to `?q=` URL param (debounced 300ms)
  - [x] Persist status filter to `?status=` URL param (comma-separated column names)
  - [x] Persist priority filter to `?priority=` URL param (comma-separated: LOW,MEDIUM,HIGH,CRITICAL)
  - [x] Persist assignee filter to `?assignee=` URL param (user ID or "unassigned")
  - [x] Create `parseTaskFiltersFromUrl(searchParams: URLSearchParams)` utility (matching law list's `parseFiltersFromUrl` pattern)
  - [x] Initialize filters from URL params on mount
  - [x] Use `useSearchParams` + `router.replace()` with `{ scroll: false }` for URL updates

- [x] **Task 5: Upgrade toolbar layout for Lista tab** (AC: 1, 2, 3, 5)
  - Depends on: Task 1 (needs shared ColumnSettings), Task 3 (needs TaskFilterBar)
  - [x] Modify `task-workspace/index.tsx` to conditionally use `layout="complex"` when `currentTab === 'lista'`
  - [x] Row 1 (Zone A + Zone D): TabNavigation + "Ny uppgift" button (same as now)
  - [x] Row 2 (Zone B): SearchInput component + TaskFilterBar as `filterDropdowns`
  - [x] Row 2 (Zone C): shared ColumnSettings (with task-specific column options) as `columnSettings`
  - [x] `betweenRows`: ToolbarItemCount showing `{filtered} av {total} uppgifter`
  - [x] Other tabs continue using `layout="standard"` with just tabs + primary action

- [x] **Task 6: Add column resizing to list-tab.tsx** (AC: 6, 7, 8, 9, 10)
  - Depends on: Task 2 (needs task-list-store for column sizing persistence)
  - [x] Enable `columnResizeMode: 'onEnd'` in TanStack table config (matches law list)
  - [x] Add `enableResizing: true` to data columns, `enableResizing: false` to fixed columns (select, comments, actions)
  - [x] Define `minSize` and `maxSize` per column (title, columnName, assignee, dueDate, priority, createdAt)
  - [x] Wire `columnSizing` state to/from Zustand store (`onColumnSizingChange` → `store.setColumnSizing`)
  - [x] Add `getColumnWidth()` helper for live resize preview (clamps to minSize/maxSize during active drag)
  - [x] Add resize handle rendering in TableHead — exact same two-element pattern as law list
  - [x] Added `table-fixed` CSS class to Table for proper column resizing

- [x] **Task 7: Add inline cell editing** (AC: 16, 17, 18, 19, 20)
  - [x] Replace static Priority badge with `PriorityEditor` — extended with generic `options` prop for task's 4 levels (LOW/MEDIUM/HIGH/CRITICAL)
  - [x] Replace static Due Date display with `DueDateEditor` — reused directly
  - [x] Replace static Assignee display with `AssigneeEditor` — reused directly
  - [x] Created `TaskStatusEditor` for inline status changes (dropdown of task columns with color indicators)
  - [x] Wire each editor's `onChange` to `onTaskUpdate(taskId, updates)` callback
  - [x] Implemented optimistic updates with rollback on error via server actions
  - [x] Prevented row click when clicking inline editors (expanded CSS selector: `button, input[type="checkbox"], [role="combobox"], [role="listbox"], [role="option"]`)

- [x] **Task 8: Update table styling for exact consistency** (AC: 21–28)
  - Depends on: Task 1 (needs shared SortableHeader)
  - [x] Row height: ESTIMATED_ROW_HEIGHT kept at 56 (task rows slightly taller due to linked doc badge)
  - [x] Shared `SortableHeader` already imported from `components/ui/sortable-header.tsx` (Task 1)
  - [x] Status column now uses inline `TaskStatusEditor` with colored Badge outline
  - [x] Priority column now uses inline `PriorityEditor` with colored badges
  - [x] Assignee column now uses inline `AssigneeEditor` with avatar display
  - [x] Row hover `hover:bg-muted/50` and `group` class preserved
  - [x] Overdue highlight `bg-destructive/5` preserved
  - [x] Empty state updated: "Inga uppgifter matchar" with adjusted messaging

- [x] **Task 9: Lift filter state to TaskWorkspace and wire everything** (AC: all)
  - Depends on: Tasks 1–8
  - [x] Lifted filter state (search, status, priority, assignee) from ListTab to TaskWorkspace
  - [x] TaskWorkspace initializes filters from URL params via `parseTaskFiltersFromUrl`
  - [x] TaskWorkspace passes `filteredTasks` to ListTab; filter UI in toolbar `filterDropdowns` zone
  - [x] ListTab is now a pure table component: receives `filteredTasks`, `columnSizing`, `columnVisibility`, `sorting` as props
  - [x] TaskWorkspace reads/writes Zustand store for column sizing/visibility/sorting
  - [x] Wired `onTaskUpdate` callback from ListTab inline editors through parent state
  - [x] Added `onTasksDelete` callback for bulk delete operations
  - [x] Column resize, visibility, sorting all persist via Zustand store
  - [x] Filter changes sync to URL via `serializeTaskFiltersToUrl` + `router.replace`
  - [x] Bulk actions still work via parent callbacks
  - [x] Row click guarded against inline editor interactions

- [x] **Task 10: Unit tests** (all ACs)
  - Depends on: Tasks 1–9
  - [x] **Task-specific components:**
    - [x] Test `task-list-store`: column sizing, column visibility, reset, sorting (11 tests)
    - [x] Test `TaskStatusEditor`: renders column options, triggers onChange, guards same-value (5 tests)
  - [x] **Integration:**
    - [x] Test URL param sync: parse and serialize round-trip (17 tests)
    - [x] Verify law list store still passes all 60 existing tests (regression check)
  - [x] All 33 new tests pass, 60 existing tests unaffected

## Dev Notes

### Architecture Sources

This story draws from the following architecture documents:

- **Data Model**: Task entity with `TaskPriority` (LOW/MEDIUM/HIGH/CRITICAL) and TaskColumn [Source: architecture/4-data-models.md#4.30, #4.31]
- **Tech Stack**: Zustand 4.5+ for global state, TanStack Table, shadcn/ui components, Tailwind CSS [Source: architecture/3-tech-stack.md#3.1]
- **Frontend Architecture**: Component hierarchy, state management patterns, Server/Client component split [Source: architecture/section-9-summary.md#10.2, #10.3]
- **Project Structure**: Feature-based organization under `components/features/`, shared UI under `components/ui/`, stores under `lib/stores/` [Source: architecture/12-unified-project-structure.md#12.2, #12.3]
- **Coding Standards**: shadcn/ui mandatory for UI components, TypeScript strict mode, React component patterns [Source: architecture/17-coding-standards.md#17.2, #17.3]
- **Testing Strategy**: Vitest + React Testing Library, 60-70% coverage target, test files mirror source tree under `tests/unit/` [Source: architecture/section-15-summary.md#16.1, #16.2, #16.7]
- **Toolbar Specification**: Zone architecture (A/B/C/D), standard vs complex layouts, Tasks page config [Source: docs/components/unified-toolbar-spec.md#3.3, #7.2]

### Relevant Source Tree

```
components/features/tasks/task-workspace/
  index.tsx                    # Main workspace - needs toolbar upgrade + state lifting
  list-tab.tsx                 # List view - needs column resizing, inline editing, styling
  task-filters.tsx             # Current filters - DELETE after migration
  bulk-action-bar.tsx          # Bulk actions - no changes needed
  tab-navigation.tsx           # Tab nav - no changes needed

components/features/document-list/
  document-list-table.tsx      # REFERENCE: Column resizing, inline editing, table styling
  document-list-page-content.tsx # REFERENCE: Complex toolbar, filter wiring, URL state
  column-settings.tsx          # REFACTOR: Extract generic, keep as thin wrapper
  compliance-filters.tsx       # REFACTOR: Use shared FilterPopover for status/category filters
  table-cell-editors/
    priority-editor.tsx        # REUSE: Inline priority editing
    due-date-editor.tsx        # REUSE: Inline date picker
    assignee-editor.tsx        # REUSE: Inline assignee dropdown
    compliance-status-editor.tsx # REFERENCE: Pattern for TaskStatusEditor

components/ui/
  unified-toolbar.tsx          # Shared toolbar (already used)
  table.tsx                    # Shared table primitives
  column-settings.tsx          # NEW: Generic column settings (extracted)
  filter-popover.tsx           # NEW: Generic filter popover (extracted)
  sortable-header.tsx          # NEW: Generic sortable header (extracted)

lib/stores/
  document-list-store.ts       # REFERENCE: Zustand + persist pattern
  task-list-store.ts           # NEW: Task list view state store
```

### Reuse Strategy

**Principle:** Extract generic shared components from law list, have both views consume them. No code duplication. [Source: architecture/17-coding-standards.md#17.3 — shadcn/ui component patterns, feature-based organization]

**1. ColumnSettings (extract to `components/ui/column-settings.tsx`):**
The current `document-list/column-settings.tsx` has the column options hardcoded. Extract the rendering logic into a generic component:

```typescript
// components/ui/column-settings.tsx
interface ColumnOption {
  id: string
  label: string
  defaultVisible: boolean
}

interface ColumnSettingsProps {
  columnOptions: ColumnOption[]
  columnVisibility: VisibilityState
  onColumnVisibilityChange: (visibility: VisibilityState) => void
}
```

Then `document-list/column-settings.tsx` becomes:

```typescript
import { ColumnSettings } from '@/components/ui/column-settings'
const DOC_COLUMN_OPTIONS = [{ id: 'type', label: 'Typ', defaultVisible: true }, ...]
export function DocumentColumnSettings(props) {
  return <ColumnSettings columnOptions={DOC_COLUMN_OPTIONS} {...props} />
}
```

And task list creates:

```typescript
import { ColumnSettings } from '@/components/ui/column-settings'
const TASK_COLUMN_OPTIONS = [{ id: 'comments', label: 'Kommentarer', defaultVisible: true }, ...]
export function TaskColumnSettings(props) {
  return <ColumnSettings columnOptions={TASK_COLUMN_OPTIONS} {...props} />
}
```

**2. FilterPopover (extract to `components/ui/filter-popover.tsx`):**
The Popover + Checkbox + Badge pattern appears in `compliance-filters.tsx` for both status and category filters. Extract:

```typescript
// components/ui/filter-popover.tsx
interface FilterPopoverProps {
  label: string
  options: { value: string; label: string; color?: string; icon?: ReactNode }[]
  selected: string[]
  onToggle: (value: string) => void
  onClear?: () => void
}
```

**3. Inline Cell Editors (reuse from `document-list/table-cell-editors/`):**

- `PriorityEditor` — Currently hardcodes 3 options: `LOW` (Låg, slate), `MEDIUM` (Medel, amber), `HIGH` (Hög, rose). Tasks need 4 options including `CRITICAL` (Kritisk) [Source: architecture/4-data-models.md#4.30]. **Approach:** Add an optional `options` prop of type `{ value: string, label: string, color: string }[]` to `PriorityEditor`. Default the prop to the existing 3 law-list options for backward compatibility. The task list passes its 4-option array. Do not create a wrapper or adapter component.
- `DueDateEditor` — Fully generic already (takes `Date | null`). Reuse directly.
- `AssigneeEditor` — Fully generic already (takes member list + selected ID). Reuse directly.
- `TaskStatusEditor` — New component specific to tasks (dropdown of task columns with color dots). Follow exact same pattern as `ComplianceStatusEditor`.

**4. SortableHeader (extract to `components/ui/sortable-header.tsx`):**
Currently duplicated in `list-tab.tsx` and `document-list-table.tsx` with identical logic. Extract once, import in both.

### Column Resizing CSS (from document-list-table.tsx)

The resize handle uses a two-element pattern: an outer `w-4` hitbox for easy mouse targeting, with a nested `w-0.5` visual indicator. Rendered within each TableHead:

```tsx
{
  header.column.getCanResize() && (
    <div
      role="separator"
      aria-orientation="vertical"
      onMouseDown={header.getResizeHandler()}
      onTouchStart={header.getResizeHandler()}
      className={cn(
        'absolute right-0 top-0 h-full w-4 cursor-col-resize select-none touch-none group/resize',
        'flex items-center justify-center'
      )}
    >
      <div
        className={cn(
          'h-4 w-0.5 rounded-full bg-border transition-colors',
          'group-hover/resize:bg-primary group-hover/resize:h-6',
          header.column.getIsResizing() && 'bg-primary h-6'
        )}
      />
    </div>
  )
}
```

Each TableHead needs `position: relative` for the absolute-positioned resize handle. Column widths use `header.getSize()` for actual rendered width. A `getColumnWidth()` helper provides live resize preview by clamping to `minSize`/`maxSize` during active resize (see `document-list-table.tsx` lines 722-735).

### UnifiedToolbar Dynamic Layout

```typescript
const isListTab = currentTab === 'lista'

<UnifiedToolbar
  layout={isListTab ? 'complex' : 'standard'}
  tabs={<TabNavigation currentTab={currentTab} />}
  search={isListTab ? <SearchInput placeholder="Sök uppgifter..." onSearch={handleSearch} debounceMs={300} /> : undefined}
  filterDropdowns={isListTab ? <TaskFilterBar filters={filters} onFiltersChange={setFilters} columns={columns} workspaceMembers={workspaceMembers} /> : undefined}
  columnSettings={isListTab ? <TaskColumnSettings columnVisibility={columnVisibility} onColumnVisibilityChange={setColumnVisibility} /> : undefined}
  betweenRows={isListTab ? <ToolbarItemCount showing={filteredTasks.length} total={tasks.length} /> : undefined}
  primaryAction={<Button onClick={() => setCreateTaskModalOpen(true)}><Plus className="mr-2 h-4 w-4" />Ny uppgift</Button>}
/>
```

### Toolbar Spec Reference

Per the Unified Toolbar Specification (`docs/components/unified-toolbar-spec.md`):

- **Section 7.2** defines the current Tasks toolbar as `standard` layout
- **Section 3.3** defines `complex` layout for pages with complex filtering
- Zone B: Search + filter dropdowns (left-center)
- Zone C: Column settings (right-center)
- Primary CTA always in Zone D (far right)

Per the Migration Examples (`docs/components/unified-toolbar-examples.md`):

- **Example 2** shows the exact Tasks page standard→complex migration pattern

### Inline Editing Architecture [Source: architecture/section-9-summary.md#10.3 — state management patterns]

When a user edits a cell inline:

1. Editor component calls `onUpdateTask(taskId, { priority: 'HIGH' })`
2. TaskWorkspace handles optimistic update: `setTasks(prev => prev.map(t => t.id === taskId ? { ...t, ...updates } : t))`
3. Server action called (e.g., `updateTask(taskId, updates)`)
4. On success: `toast({ description: "Uppgiften uppdaterad" })` — auto-dismiss after 2s
5. On error: rollback to previous state, `toast({ variant: "destructive", description: "Kunde inte spara ändringen. Försök igen." })`

This matches the law list's `onUpdateItem` pattern exactly. The editors already have `e.stopPropagation()` to prevent row click.

### Responsive & Accessibility Considerations

- **Complex toolbar on mobile/tablet:** The `UnifiedToolbar` complex layout already handles responsive collapse internally (see `unified-toolbar-spec.md` Section 6). No additional responsive work needed for the toolbar itself.
- **Inline editors:** Each reused editor (`PriorityEditor`, `DueDateEditor`, `AssigneeEditor`) already uses shadcn/ui Popover/Select with built-in keyboard navigation and ARIA attributes. The new `TaskStatusEditor` must follow the same pattern.
- **Filter popovers:** The shared `FilterPopover` must include `aria-label` on the trigger button and `role="listbox"` semantics on the checkbox list (matching existing `compliance-filters.tsx` pattern).
- **Column resize handles:** Use `role="separator"` and `aria-orientation="vertical"` on the resize handle div (already present in law list source).
- **Keyboard accessibility for resize:** Not required for MVP (matches law list behavior — mouse/touch only). Can be added as a future enhancement.

### Optimistic Update UX

Toast messages for inline editing feedback (Swedish):

- **Success:** `"Uppgiften uppdaterad"` (brief, auto-dismiss after 2s)
- **Error/Rollback:** `"Kunde inte spara ändringen. Försök igen."` (persistent until dismissed)
- Use the existing `toast()` utility from `@/components/ui/use-toast`.

### What This Story Does NOT Include (Deferred to Story 6.20)

- **Task Groups**: Database schema, group CRUD, GroupManager UI, grouped accordion table, DnD between groups → Story 6.20
- **Drag-and-drop row reorder**: Dependent on groups (meaningless without grouping context)
- **Export functionality**: Separate enhancement
- **Content type filter chips**: Tasks don't have content types
- **View toggle** (card/table/compliance): Task workspace already uses tab-based views

### Testing

**Test File Location:**

```
tests/unit/components/ui/column-settings.test.tsx
tests/unit/components/ui/filter-popover.test.tsx
tests/unit/components/ui/sortable-header.test.tsx
tests/unit/lib/stores/task-list-store.test.ts
tests/unit/components/features/tasks/task-workspace/task-filters-toolbar.test.tsx
tests/unit/components/features/tasks/task-workspace/task-status-editor.test.tsx
```

**Testing Standards:** [Source: architecture/section-15-summary.md#16.2, #16.7]

- Coverage Target: 60-70% for new components [Source: architecture/17-coding-standards.md#17.1]
- Framework: Vitest + React Testing Library
- Test file location: `tests/unit/` mirroring source tree
- Test patterns: user interaction simulation, component rendering, state persistence
- **Critical**: Verify existing law list tests still pass after shared component extraction (regression check)

**Test Fixtures / Mock Data:**

- Mock task list: 5-10 tasks with varied priorities (LOW through CRITICAL), statuses (across 3+ columns), assignees (including null/unassigned), and due dates (past, today, future)
- Mock workspace members: 3-4 members with names, IDs, and avatar URLs (for assignee filter/editor tests)
- Mock task columns: 3 default columns (`Att göra`, `Pågående`, `Klar`) with IDs, names, and colors
- Mock column options: Array of `{ id, label, defaultVisible }` for ColumnSettings tests
- Mock filter options: Array of `{ value, label, color }` for FilterPopover tests
- Use `vi.fn()` for all onChange/onToggle/onClear callbacks to assert invocation

### Post-Completion Enhancements

After the initial 10 tasks were completed, the following UX refinements were made:

**Uppgift Column Styling (match Dokument column):**

- Replaced Badge/pill for SFS number with plain `text-xs text-muted-foreground` text
- Added `bg-background` to the title column header and cells (both `TaskRow` and `VirtualTaskRow`) to match the law list's Dokument column background

**Beskrivning Column:**

- Added new "Beskrivning" column showing task description with `line-clamp-2` truncation
- Tooltip on hover (250ms delay) shows full description with bold "Beskrivning" header, matching compliance table's `TruncatedTextCell` pattern
- `stripHtml()` strips HTML tags from rich text descriptions before display
- `max-h-[300px] overflow-y-auto` on tooltip content caps very long descriptions with scrolling
- Added to `DEFAULT_COLUMN_SIZING` (240px), `DEFAULT_COLUMN_VISIBILITY` (true), and `TASK_COLUMN_OPTIONS`

**Drag Handle & Type Icon Columns:**

- Added `GripVertical` drag handle column (visual placeholder, reorder not yet implemented)
- Added `SquareCheckBig` type icon column in `bg-blue-50 text-blue-600` rounded container
- Both columns use pinned `minSize`/`maxSize` equal to `size` (40px and 60px) to prevent `table-fixed` layout from expanding them
- Same pinning applied to select (40px), comments (60px), and actions (50px) columns

**Column Min-Size Adjustments:**

- Ansvarig: `minSize` 80 → 105 (+30%) to prevent label overlap on small screens
- Förfallodatum: `minSize` 100 → 160 (+60%)
- Prioritet: `minSize` 80 → 130 (+60%)

**Multiple Linked Documents:**

- Raised `list_item_links` query limit from `take: 1` to `take: 5` across all three query locations in `tasks.ts`
- Title cell shows all linked SFS numbers joined with middle dot separator (`·`), deduplicated by `document_number` via `new Set()`
- Single line with `truncate` for overflow

**Description Optimistic Update:**

- Added `onOptimisticChange` callback to `DescriptionEditor` → `LeftPanel` → `TaskModal`
- When a description is saved in the modal, the change syncs immediately to the workspace task list via `onTaskUpdate(taskId, { description })` — no page refresh needed
- Follows the same pattern as title, status, priority, assignee, and due date optimistic updates

**Linked Documents Key Fix:**

- Fixed React "duplicate key" console error in `linked-laws-box.tsx`
- `TaskWithRelations.list_item_links` entries lack an `id` field (only `TaskDetails` entries have it)
- Changed key from `link.id` to `link.id || link.law_list_item.id` for robustness

**Test Results (41 tests passing):**

- `task-list-store.test.ts`: 11 tests (updated for `description` column defaults)
- `task-filter-params.test.ts`: 17 tests
- `task-status-editor.test.tsx`: 5 tests
- `create-task-modal.test.tsx`: 8 tests
- All 16 pre-existing failures are unrelated (integration tests needing database/network)

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                                                                                                             | Author     |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2026-01-29 | 1.0     | Initial story creation                                                                                                                                                                                                                                                                                                                                                  | Sarah (PO) |
| 2026-01-29 | 1.1     | Added inline cell editing (AC 16-20), shared component extraction (AC 37-40), strengthened reuse strategy, deferred task groups to 6.20                                                                                                                                                                                                                                 | Sarah (PO) |
| 2026-01-29 | 1.2     | SM review: Added architecture source citations to Dev Notes, updated architecture 4-data-models.md to add CRITICAL to TaskPriority enum                                                                                                                                                                                                                                 | Bob (SM)   |
| 2026-01-29 | 1.3     | PO validation: Fixed resize handle CSS to match actual law list source (w-4 hitbox + w-0.5 indicator), corrected columnResizeMode to 'onEnd', added explicit task dependencies (Tasks 3/5/6/8), clarified PriorityEditor adaptation as generic options prop, added responsive/accessibility section, added optimistic update toast strings, added test fixture guidance | Sarah (PO) |
| 2026-01-29 | 1.4     | Story approved — passed validation (GO, readiness 9/10, high confidence)                                                                                                                                                                                                                                                                                                | Sarah (PO) |
