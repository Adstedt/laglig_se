# Story 7.1: Build Employee List View (CRUD)

## Status
Draft

## Story

**As an** HR manager,
**I want** to manage employees in a centralized list,
**so that** I track who works for my company.

## Acceptance Criteria

1. HR Module page created at `/hr/employees`
2. Table view shows all employees with columns: Name, Role, Employment Date, Contract Type, Status
3. "Add Employee" button opens modal
4. **Add Employee Modal fields:**
   - Name (required)
   - Personnummer (Swedish SSN, encrypted at rest, required)
   - Email (optional)
   - Phone (optional)
   - Employment date (date picker, required)
   - Contract type (dropdown: Permanent, Fixed-term, Consultant)
   - Role (dropdown: Manager, Employee, Intern, etc.)
   - Department (text input)
   - Manager (dropdown of existing employees)
5. "Save" creates employee record
6. Edit button (inline edit or modal)
7. Delete button (confirmation modal)
8. Search bar filters by name
9. Role-based access: Only HR Manager, Admin, Owner can access

## Tasks / Subtasks

- [ ] Create HR Module page at `/hr/employees`
- [ ] Build employee table with all required columns
- [ ] Implement "Add Employee" modal with form validation
- [ ] Add personnummer encryption (at rest)
- [ ] Implement edit employee functionality
- [ ] Add delete employee with confirmation
- [ ] Create search bar for filtering by name
- [ ] Restrict access to HR Manager/Admin/Owner roles
- [ ] Test CRUD operations

## Dev Notes

**Database Schema:**
```prisma
model Employee {
  id                String   @id @default(uuid())
  workspaceId       String
  name              String
  personnummer      String   // Encrypted at rest
  email             String?
  phone             String?
  employmentDate    DateTime
  contractType      String   // permanent, fixed_term, consultant
  role              String
  department        String?
  managerId         String?  // Self-referential
  status            String   @default("active") // active, inactive
  endDate           DateTime?
  photoUrl          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  manager       Employee?      @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates  Employee[]     @relation("ManagerSubordinates")
  kollektivavtal EmployeeKollektivavtal[]
  documents     EmployeeDocument[]

  @@index([workspaceId])
  @@index([managerId])
  @@map("employees")
}
```

**HR Employees Page:**
```typescript
// app/hr/employees/page.tsx
import { Suspense } from 'react'
import { EmployeeList } from '@/components/hr/employee-list'
import { AddEmployeeButton } from '@/components/hr/add-employee-button'
import { Can } from '@/components/permissions/can'
import { Permission } from '@/lib/permissions/roles'

export default function EmployeesPage() {
  return (
    <Can
      permission={Permission.VIEW_EMPLOYEES}
      fallback={<div className="p-6 text-center">You don't have access to this page.</div>}
    >
      <div className="max-w-7xl mx-auto p-6">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-2xl font-bold">Employees</h1>
            <p className="text-sm text-gray-600 mt-1">Manage your workforce</p>
          </div>
          <Can permission={Permission.MANAGE_EMPLOYEES}>
            <AddEmployeeButton />
          </Can>
        </div>

        <Suspense fallback={<TableSkeleton />}>
          <EmployeeList />
        </Suspense>
      </div>
    </Can>
  )
}
```

**Employee List Component:**
```typescript
// components/hr/employee-list.tsx
import { getEmployees } from '@/lib/hr/get-employees'
import { EmployeeRow } from './employee-row'

export async function EmployeeList() {
  const employees = await getEmployees()

  return (
    <div className="bg-white rounded-lg shadow overflow-hidden">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Department</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employment Date</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contract Type</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {employees.map((employee) => (
            <EmployeeRow key={employee.id} employee={employee} />
          ))}
        </tbody>
      </table>

      {employees.length === 0 && (
        <div className="text-center py-12">
          <p className="text-gray-500">No employees yet. Add your first employee to get started.</p>
        </div>
      )}
    </div>
  )
}
```

**Add Employee Modal:**
```typescript
// components/hr/add-employee-modal.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'

export function AddEmployeeModal({ isOpen, onClose }: Props) {
  const router = useRouter()
  const [isSubmitting, setIsSubmitting] = useState(false)
  const { register, handleSubmit, formState: { errors } } = useForm()

  async function onSubmit(data: any) {
    setIsSubmitting(true)
    try {
      const response = await fetch('/api/employees', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })

      if (response.ok) {
        onClose()
        router.refresh()
      } else {
        alert('Failed to add employee')
      }
    } catch (error) {
      alert('Failed to add employee')
    } finally {
      setIsSubmitting(false)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div className="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
        <h2 className="text-xl font-bold mb-6">Add Employee</h2>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* Name */}
          <div>
            <label className="block text-sm font-medium mb-1">Name *</label>
            <input
              {...register('name', { required: 'Name is required' })}
              className="w-full px-3 py-2 border rounded-lg"
            />
            {errors.name && <p className="text-sm text-red-600 mt-1">{errors.name.message}</p>}
          </div>

          {/* Personnummer */}
          <div>
            <label className="block text-sm font-medium mb-1">Personnummer *</label>
            <input
              {...register('personnummer', {
                required: 'Personnummer is required',
                pattern: {
                  value: /^\d{12}$/,
                  message: 'Invalid personnummer format (12 digits)'
                }
              })}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder="YYYYMMDDXXXX"
            />
            {errors.personnummer && <p className="text-sm text-red-600 mt-1">{errors.personnummer.message}</p>}
          </div>

          {/* Email & Phone */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Email</label>
              <input
                {...register('email', {
                  pattern: {
                    value: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                    message: 'Invalid email'
                  }
                })}
                type="email"
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Phone</label>
              <input
                {...register('phone')}
                type="tel"
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          </div>

          {/* Employment Date */}
          <div>
            <label className="block text-sm font-medium mb-1">Employment Date *</label>
            <input
              {...register('employmentDate', { required: 'Employment date is required' })}
              type="date"
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>

          {/* Contract Type & Role */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Contract Type *</label>
              <select
                {...register('contractType', { required: 'Contract type is required' })}
                className="w-full px-3 py-2 border rounded-lg"
              >
                <option value="">Select...</option>
                <option value="permanent">Permanent</option>
                <option value="fixed_term">Fixed-term</option>
                <option value="consultant">Consultant</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Role *</label>
              <select
                {...register('role', { required: 'Role is required' })}
                className="w-full px-3 py-2 border rounded-lg"
              >
                <option value="">Select...</option>
                <option value="manager">Manager</option>
                <option value="employee">Employee</option>
                <option value="intern">Intern</option>
                <option value="consultant">Consultant</option>
              </select>
            </div>
          </div>

          {/* Department */}
          <div>
            <label className="block text-sm font-medium mb-1">Department</label>
            <input
              {...register('department')}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>

          {/* Actions */}
          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
            >
              {isSubmitting ? 'Adding...' : 'Add Employee'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

**Create Employee API:**
```typescript
// app/api/employees/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_EMPLOYEES)

    const data = await request.json()

    // Encrypt personnummer before storing
    const encryptedPersonnummer = await encrypt(data.personnummer)

    const employee = await prisma.employee.create({
      data: {
        workspaceId,
        name: data.name,
        personnummer: encryptedPersonnummer,
        email: data.email,
        phone: data.phone,
        employmentDate: new Date(data.employmentDate),
        contractType: data.contractType,
        role: data.role,
        department: data.department
      }
    })

    return NextResponse.json({ employee })
  })
}
```

**Encryption Utility:**
```typescript
// lib/encryption.ts
import crypto from 'crypto'

const ALGORITHM = 'aes-256-gcm'
const KEY = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex') // 32 bytes

export async function encrypt(text: string): Promise<string> {
  const iv = crypto.randomBytes(16)
  const cipher = crypto.createCipheriv(ALGORITHM, KEY, iv)

  let encrypted = cipher.update(text, 'utf8', 'hex')
  encrypted += cipher.final('hex')

  const authTag = cipher.getAuthTag()

  return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`
}

export async function decrypt(encryptedText: string): Promise<string> {
  const [ivHex, authTagHex, encrypted] = encryptedText.split(':')

  const iv = Buffer.from(ivHex, 'hex')
  const authTag = Buffer.from(authTagHex, 'hex')
  const decipher = crypto.createDecipheriv(ALGORITHM, KEY, iv)

  decipher.setAuthTag(authTag)

  let decrypted = decipher.update(encrypted, 'hex', 'utf8')
  decrypted += decipher.final('utf8')

  return decrypted
}
```

**Reference:** PRD Epic 7 Story 7.1, GDPR encryption requirements

## Testing

**Unit Tests:**
- Employee creation validates required fields
- Personnummer encrypted before storing
- Role permission checks enforced

**Integration Tests:**
- Create employee, verify stored in database
- Edit employee, verify updates persisted
- Delete employee, verify removed from database
- Search by name, verify filtering works

**Manual Testing:**
- Add employee with all fields, verify success
- Add employee missing required field, verify validation error
- Edit employee, verify changes saved
- Delete employee, verify confirmation modal appears
- Search for employee by name, verify filters list
- Test as non-HR Manager role, verify access blocked

**Security Testing:**
- Personnummer encrypted in database (not plain text)
- Non-authorized roles cannot access `/hr/employees`
- Cannot access other workspace's employees

**Test File:** `__tests__/features/hr/employee-list.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Enter accurate employee data
- Keep employee list up-to-date
- Respect privacy of employee personal information

**Developer Responsibility:**
- Encrypt personnummer at rest (GDPR compliance)
- Restrict access to authorized roles only
- Validate all input data
- Provide clear error messages

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
