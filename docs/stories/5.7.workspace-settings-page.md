# Story 5.7: Implement Workspace Settings Page

## Status

Draft

## Story

**As a** workspace owner/admin,
**I want** to configure workspace settings,
**so that** I can customize branding and notifications.

## Acceptance Criteria

1. Workspace Settings page with tabs: General, Team, Billing, Notifications, Integrations
2. **General tab:**
   - Workspace name (editable)
   - Company logo upload (max 2MB, PNG/JPG)
   - Industry (SNI code, readonly - set during onboarding)
3. **Team tab:**
   - Current members list (name, role, joined date)
   - Invite member button
   - Change role dropdown (Owner/Admin only)
   - Remove member button (confirmation modal)
4. **Billing tab:**
   - Current plan, next billing date
   - Payment method, update card button
   - Invoice history (downloadable PDFs)
   - Upgrade/downgrade buttons
5. **Notifications tab:**
   - Email preferences: Daily digest, weekly digest, instant change alerts
   - In-app notification preferences
6. **Integrations tab:**
   - Placeholder: "Fortnox integration coming soon"
7. Save button persists changes
8. Owner-only actions disabled for non-owners

## Tasks / Subtasks

- [ ] Create settings page with tab navigation
- [ ] Build General tab with workspace name and logo
- [ ] Implement Team tab (reuse from Story 5.3)
- [ ] Add Billing tab (redirect to billing page)
- [ ] Create Notifications tab with preferences
- [ ] Add Integrations tab placeholder
- [ ] Implement file upload for logo
- [ ] Add permission checks for each action
- [ ] Test all settings persist correctly

## Dev Notes

**Settings Page with Tabs:**

```typescript
// app/settings/page.tsx
'use client'

import { useState } from 'react'
import { GeneralTab } from '@/components/settings/general-tab'
import { TeamTab } from '@/components/settings/team-tab'
import { BillingTab } from '@/components/settings/billing-tab'
import { NotificationsTab } from '@/components/settings/notifications-tab'
import { IntegrationsTab } from '@/components/settings/integrations-tab'

export default function SettingsPage() {
  const [activeTab, setActiveTab] = useState<string>('general')

  const tabs = [
    { id: 'general', label: 'General', icon: '‚öôÔ∏è' },
    { id: 'team', label: 'Team', icon: 'üë•' },
    { id: 'billing', label: 'Billing', icon: 'üí≥' },
    { id: 'notifications', label: 'Notifications', icon: 'üîî' },
    { id: 'integrations', label: 'Integrations', icon: 'üîå' }
  ]

  return (
    <div className="max-w-6xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">Workspace Settings</h1>

      {/* Tab Navigation */}
      <div className="bg-white rounded-lg shadow mb-6">
        <div className="border-b">
          <div className="flex">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`px-6 py-3 font-medium border-b-2 transition-colors ${
                  activeTab === tab.id
                    ? 'border-blue-600 text-blue-600'
                    : 'border-transparent text-gray-600 hover:text-gray-900'
                }`}
              >
                <span className="mr-2">{tab.icon}</span>
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* Tab Content */}
        <div className="p-6">
          {activeTab === 'general' && <GeneralTab />}
          {activeTab === 'team' && <TeamTab />}
          {activeTab === 'billing' && <BillingTab />}
          {activeTab === 'notifications' && <NotificationsTab />}
          {activeTab === 'integrations' && <IntegrationsTab />}
        </div>
      </div>
    </div>
  )
}
```

**General Tab:**

```typescript
// components/settings/general-tab.tsx
'use client'

import { useState, useEffect } from 'react'
import { useForm } from 'react-hook-form'

export function GeneralTab() {
  const [workspace, setWorkspace] = useState<any>(null)
  const [logoPreview, setLogoPreview] = useState<string | null>(null)
  const [isUploading, setIsUploading] = useState(false)

  const { register, handleSubmit, formState: { errors } } = useForm()

  useEffect(() => {
    async function fetchWorkspace() {
      const response = await fetch('/api/workspace/current')
      const data = await response.json()
      setWorkspace(data)
      setLogoPreview(data.companyLogo)
    }

    fetchWorkspace()
  }, [])

  async function onSubmit(data: { name: string }) {
    try {
      const response = await fetch('/api/workspace/settings', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: data.name })
      })

      if (response.ok) {
        alert('Settings saved successfully')
      }
    } catch (error) {
      alert('Failed to save settings')
    }
  }

  async function handleLogoUpload(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0]
    if (!file) return

    // Validate file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      alert('File size must be less than 2MB')
      return
    }

    // Validate file type
    if (!['image/png', 'image/jpeg'].includes(file.type)) {
      alert('Only PNG and JPG files are allowed')
      return
    }

    setIsUploading(true)

    try {
      const formData = new FormData()
      formData.append('logo', file)

      const response = await fetch('/api/workspace/logo', {
        method: 'POST',
        body: formData
      })

      if (response.ok) {
        const data = await response.json()
        setLogoPreview(data.logoUrl)
        alert('Logo uploaded successfully')
      }
    } catch (error) {
      alert('Failed to upload logo')
    } finally {
      setIsUploading(false)
    }
  }

  if (!workspace) return <div>Loading...</div>

  return (
    <div className="space-y-6">
      <form onSubmit={handleSubmit(onSubmit)}>
        {/* Workspace Name */}
        <div>
          <label className="block text-sm font-medium mb-2">
            Workspace Name
          </label>
          <input
            type="text"
            {...register('name', { required: 'Name is required' })}
            defaultValue={workspace.name}
            className="w-full max-w-md px-3 py-2 border border-gray-300 rounded-lg"
          />
          {errors.name && (
            <p className="mt-1 text-sm text-red-600">{errors.name.message}</p>
          )}
        </div>

        {/* Company Logo */}
        <div>
          <label className="block text-sm font-medium mb-2">Company Logo</label>
          <div className="flex items-center gap-4">
            {logoPreview && (
              <img
                src={logoPreview}
                alt="Company logo"
                className="w-16 h-16 rounded-lg object-cover border"
              />
            )}
            <div>
              <input
                type="file"
                accept="image/png,image/jpeg"
                onChange={handleLogoUpload}
                className="hidden"
                id="logo-upload"
                disabled={isUploading}
              />
              <label
                htmlFor="logo-upload"
                className="px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 inline-block"
              >
                {isUploading ? 'Uploading...' : 'Upload Logo'}
              </label>
              <p className="text-xs text-gray-500 mt-2">
                PNG or JPG, max 2MB
              </p>
            </div>
          </div>
        </div>

        {/* Industry (readonly) */}
        <div>
          <label className="block text-sm font-medium mb-2">Industry</label>
          <div className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg max-w-md text-gray-700">
            {workspace.companyProfile?.sniCode} - {workspace.companyProfile?.industry}
          </div>
          <p className="text-xs text-gray-500 mt-1">
            Set during onboarding. Contact support to change.
          </p>
        </div>

        <button
          type="submit"
          className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          Save Changes
        </button>
      </form>
    </div>
  )
}
```

**Notifications Tab:**

```typescript
// components/settings/notifications-tab.tsx
'use client'

import { useState, useEffect } from 'react'

export function NotificationsTab() {
  const [preferences, setPreferences] = useState<any>(null)

  useEffect(() => {
    async function fetchPreferences() {
      const response = await fetch('/api/notifications/preferences')
      const data = await response.json()
      setPreferences(data)
    }

    fetchPreferences()
  }, [])

  async function updatePreference(key: string, value: boolean) {
    setPreferences({ ...preferences, [key]: value })

    await fetch('/api/notifications/preferences', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ [key]: value })
    })
  }

  if (!preferences) return <div>Loading...</div>

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-4">Email Notifications</h3>

        <div className="space-y-4">
          <NotificationToggle
            label="Daily Digest"
            description="Receive a daily summary of law changes and updates"
            enabled={preferences.dailyDigest}
            onChange={(enabled) => updatePreference('dailyDigest', enabled)}
          />

          <NotificationToggle
            label="Weekly Digest"
            description="Receive a weekly summary every Monday morning"
            enabled={preferences.weeklyDigest}
            onChange={(enabled) => updatePreference('weeklyDigest', enabled)}
          />

          <NotificationToggle
            label="Instant Change Alerts"
            description="Get notified immediately when a law in your list changes"
            enabled={preferences.instantAlerts}
            onChange={(enabled) => updatePreference('instantAlerts', enabled)}
          />

          <NotificationToggle
            label="Team Activity"
            description="Notifications about team member actions"
            enabled={preferences.teamActivity}
            onChange={(enabled) => updatePreference('teamActivity', enabled)}
          />
        </div>
      </div>

      <div className="pt-6 border-t">
        <h3 className="text-lg font-semibold mb-4">In-App Notifications</h3>

        <div className="space-y-4">
          <NotificationToggle
            label="Browser Notifications"
            description="Show desktop notifications when app is open"
            enabled={preferences.browserNotifications}
            onChange={(enabled) => updatePreference('browserNotifications', enabled)}
          />

          <NotificationToggle
            label="Sound Alerts"
            description="Play sound for important notifications"
            enabled={preferences.soundAlerts}
            onChange={(enabled) => updatePreference('soundAlerts', enabled)}
          />
        </div>
      </div>
    </div>
  )
}

function NotificationToggle({
  label,
  description,
  enabled,
  onChange
}: {
  label: string
  description: string
  enabled: boolean
  onChange: (enabled: boolean) => void
}) {
  return (
    <div className="flex items-center justify-between py-3">
      <div>
        <p className="font-medium">{label}</p>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
      <button
        onClick={() => onChange(!enabled)}
        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
          enabled ? 'bg-blue-600' : 'bg-gray-300'
        }`}
      >
        <span
          className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
            enabled ? 'translate-x-6' : 'translate-x-1'
          }`}
        />
      </button>
    </div>
  )
}
```

**Integrations Tab:**

```typescript
// components/settings/integrations-tab.tsx
export function IntegrationsTab() {
  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-4">Available Integrations</h3>
        <p className="text-gray-600 mb-6">
          Connect Laglig.se with your existing tools and workflows.
        </p>

        <div className="space-y-4">
          {/* Fortnox */}
          <div className="flex items-center justify-between p-4 border rounded-lg">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                <span className="text-2xl">üìä</span>
              </div>
              <div>
                <h4 className="font-semibold">Fortnox</h4>
                <p className="text-sm text-gray-600">
                  Sync employees and company data automatically
                </p>
              </div>
            </div>
            <span className="px-3 py-1 text-sm bg-yellow-100 text-yellow-700 rounded">
              Coming Soon
            </span>
          </div>

          {/* Slack */}
          <div className="flex items-center justify-between p-4 border rounded-lg">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                <span className="text-2xl">üí¨</span>
              </div>
              <div>
                <h4 className="font-semibold">Slack</h4>
                <p className="text-sm text-gray-600">
                  Get law change notifications in Slack
                </p>
              </div>
            </div>
            <span className="px-3 py-1 text-sm bg-yellow-100 text-yellow-700 rounded">
              Coming Soon
            </span>
          </div>

          {/* Microsoft Teams */}
          <div className="flex items-center justify-between p-4 border rounded-lg">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                <span className="text-2xl">üëî</span>
              </div>
              <div>
                <h4 className="font-semibold">Microsoft Teams</h4>
                <p className="text-sm text-gray-600">
                  Compliance updates in Teams channels
                </p>
              </div>
            </div>
            <span className="px-3 py-1 text-sm bg-yellow-100 text-yellow-700 rounded">
              Coming Soon
            </span>
          </div>
        </div>
      </div>

      <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p className="text-sm text-blue-900">
          üí° Want to see a specific integration? Email us at integrations@laglig.se
        </p>
      </div>
    </div>
  )
}
```

**Settings API Endpoints:**

```typescript
// app/api/workspace/settings/route.ts
export async function PATCH(request: Request) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_WORKSPACE_SETTINGS)

    const { name } = await request.json()

    await prisma.workspace.update({
      where: { id: workspaceId },
      data: { name },
    })

    return NextResponse.json({ success: true })
  })
}

// app/api/workspace/logo/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_WORKSPACE_SETTINGS)

    const formData = await request.formData()
    const file = formData.get('logo') as File

    // Upload to storage (Vercel Blob, S3, etc.)
    const logoUrl = await uploadLogo(file, workspaceId)

    await prisma.workspace.update({
      where: { id: workspaceId },
      data: { companyLogo: logoUrl },
    })

    return NextResponse.json({ logoUrl })
  })
}

// app/api/notifications/preferences/route.ts
export async function GET(request: Request) {
  return withWorkspace(async ({ userId }) => {
    const preferences = await prisma.notificationPreferences.findUnique({
      where: { userId },
    })

    return NextResponse.json(
      preferences || {
        dailyDigest: false,
        weeklyDigest: true,
        instantAlerts: true,
        teamActivity: true,
        browserNotifications: false,
        soundAlerts: false,
      }
    )
  })
}

export async function PATCH(request: Request) {
  return withWorkspace(async ({ userId }) => {
    const data = await request.json()

    await prisma.notificationPreferences.upsert({
      where: { userId },
      update: data,
      create: {
        userId,
        ...data,
      },
    })

    return NextResponse.json({ success: true })
  })
}
```

**Reference:** PRD Epic 5 Story 5.7, Architecture Section 12 (Multi-Tenancy)

## Testing

**Unit Tests:**

- Settings form validation works correctly
- File upload validates size and type
- Permission checks block unauthorized users

**Integration Tests:**

- Update workspace name, verify persisted
- Upload logo, verify stored correctly
- Update notification preferences, verify saved
- Non-owner cannot access settings (should block)

**Manual Testing:**

- Navigate through all tabs
- Update workspace name and save
- Upload company logo (test 2MB+ file rejection)
- Toggle notification preferences
- Verify integrations tab shows "Coming Soon"
- Test as different roles (Owner, Admin, Member)

**Test File:** `__tests__/features/settings/workspace-settings.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**

- Configure workspace name and logo
- Set notification preferences
- Manage team members via settings

**Developer Responsibility:**

- Build tabbed settings interface
- Implement file upload for logo
- Store settings securely
- Enforce permission checks on all actions
- Validate file uploads (size, type)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
