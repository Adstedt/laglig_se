# Story 8.3: Implement "Mark as Reviewed" Workflow

## Status

Draft (v2 — rewritten to align with actual data model and amendment pipeline)

## Story

**As a** workspace member who has reviewed a law change,
**I want** to mark it as reviewed so it disappears from my Changes tab,
**so that** I can track which amendments I've acknowledged and focus on unreviewed changes.

## Context & Dependencies

**Builds on:**

- Story 8.1 (Changes Tab) — renders "Mark as Reviewed" buttons on change cards
- Story 8.2 (Diff View) — renders "Mark as Reviewed" button on diff page
- `LawListItem.last_change_acknowledged_at` / `last_change_acknowledged_by` — existing schema fields for per-item acknowledgment
- `ActivityLog` model — existing audit trail for workspace actions

**Design decision: Acknowledgment granularity**

The existing `LawListItem.last_change_acknowledged_at` field acknowledges ALL changes to a specific law up to that timestamp. This is sufficient for MVP:
- When a user marks a change as reviewed, update `LawListItem.last_change_acknowledged_at = NOW()` and `last_change_acknowledged_by = user.id`
- This acknowledges ALL ChangeEvents for that law detected before now
- Story 8.1's unacknowledged query: `ChangeEvent.detected_at > LawListItem.last_change_acknowledged_at`

For bulk "Mark All as Reviewed", update all affected LawListItems at once.

## Acceptance Criteria

1. "Mark as Reviewed" button on change card (Story 8.1) and diff page (Story 8.2)
2. Clicking the button:
   - Updates `LawListItem.last_change_acknowledged_at = NOW()`
   - Updates `LawListItem.last_change_acknowledged_by = current user ID`
   - Change disappears from Changes tab (no longer matches unacknowledged query)
   - Unacknowledged count badge decrements
3. Confirmation toast: "Ändring markerad som granskad"
4. Bulk "Mark All as Reviewed" button on Changes tab with confirmation dialog
5. All acknowledge actions logged to `ActivityLog`:
   - `entity_type: 'law_list_item'`, `entity_id: lawListItem.id`, `action: 'change_acknowledged'`
   - Metadata includes: amendment_sfs, base law document_number

## Tasks / Subtasks

- [ ] **Task 1: Create server action for single acknowledge** (AC: 1, 2, 5)
  - [ ] Server action in `app/actions/change-acknowledgment.ts`
  - [ ] Find `LawListItem` for the base law's `LegalDocument` in current workspace
  - [ ] Update `last_change_acknowledged_at` and `last_change_acknowledged_by`
  - [ ] Create `ActivityLog` entry
  - [ ] Revalidate Changes tab path
- [ ] **Task 2: Create server action for bulk acknowledge** (AC: 4, 5)
  - [ ] Accept array of LawListItem IDs
  - [ ] Update all items in a transaction
  - [ ] Create bulk `ActivityLog` entry
- [ ] **Task 3: Wire buttons in ChangeCard and DiffPage** (AC: 1, 3)
  - [ ] Add `useTransition` for pending state
  - [ ] Show confirmation toast (shadcn/ui Sonner)
- [ ] **Task 4: Bulk acknowledge UI** (AC: 4)
  - [ ] "Mark All as Reviewed" button on Changes tab
  - [ ] Confirmation dialog (shadcn/ui AlertDialog)

## Dev Notes

### Source Tree (relevant files)

```
prisma/schema.prisma                     — LawListItem.last_change_acknowledged_at/by
app/actions/                             — Existing server actions pattern
components/ui/                           — shadcn/ui toast (Sonner) already configured
```

### Key Data Models

```
LawListItem
  ├─ document_id → LegalDocument (base law)
  ├─ last_change_acknowledged_at: DateTime?
  ├─ last_change_acknowledged_by: String?    (user ID)
  └─ law_list → LawList (workspace_id)

ActivityLog
  ├─ workspace_id, user_id
  ├─ entity_type: String
  ├─ entity_id: String
  ├─ action: String
  └─ old_value, new_value: Json?
```

### Server Action Pattern

```typescript
// app/actions/change-acknowledgment.ts
'use server'

export async function acknowledgeChange(lawListItemId: string) {
  // 1. Verify user has access to workspace
  // 2. Update LawListItem.last_change_acknowledged_at = new Date()
  // 3. Create ActivityLog entry
  // 4. revalidatePath for changes tab
}

export async function acknowledgeAllChanges(lawListItemIds: string[]) {
  // Same but in a prisma.$transaction for all items
}
```

### UI Standards

- Use shadcn/ui `AlertDialog` for bulk confirmation
- Use shadcn/ui Sonner toast for success feedback
- Use `useTransition` for optimistic UI updates
- Server actions (not API routes) for mutations

## Testing

**Test location:** `tests/unit/components/laws/acknowledge.test.ts`

**Test framework:** Vitest

**Unit tests:**
- Single acknowledge updates LawListItem timestamps correctly
- Bulk acknowledge updates all items in transaction
- ActivityLog entry created with correct metadata
- Changes tab query excludes acknowledged changes

**Integration tests:**
- Mark single change → disappears from Changes tab
- Mark all changes → all disappear, count badge shows 0
- Toast displays after successful acknowledge

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: use LawListItem.last_change_acknowledged_at, ActivityLog, server actions | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
