# Story 8.3: Implement "Mark as Reviewed" Workflow

## Status
Draft

## Story

**As a** user,
**I want** to mark changes as reviewed,
**so that** they disappear from my Changes tab after I've acknowledged them.

## Acceptance Criteria

1. "Mark as Reviewed" button on change card and diff modal
2. Clicking button:
   - Updates `law_changes.acknowledged_at` timestamp
   - Updates `law_changes.acknowledged_by` to current user
   - Removes change from Changes tab
   - Decreases unacknowledged count badge
3. Confirmation toast: "Change marked as reviewed ✓"
4. Bulk "Mark All as Reviewed" button (confirmation modal)
5. Activity logged: "Anna reviewed change to Arbetsmiljölagen on 2025-01-15"
6. Enterprise tier: Activity appears in Workspace Activity Log

## Tasks / Subtasks

- [ ] Implement acknowledge API endpoint
- [ ] Add confirmation toast notification
- [ ] Create bulk acknowledge modal
- [ ] Log activity for each acknowledge action
- [ ] Update unacknowledged count badge
- [ ] Test single and bulk acknowledge
- [ ] Verify Enterprise activity log integration

## Dev Notes

**Acknowledge API (already created in 8.1):**
```typescript
// app/api/law-changes/[id]/acknowledge/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'

export async function POST(request: Request, { params }: { params: { id: string } }) {
  return withWorkspace(async ({ workspaceId, userId }) => {
    const lawChange = await prisma.lawChange.findUnique({
      where: { id: params.id },
      include: {
        law: {
          include: {
            workspaceLaws: {
              where: { workspaceId },
              select: { workspaceId: true }
            }
          }
        }
      }
    })

    if (!lawChange || lawChange.law.workspaceLaws.length === 0) {
      return NextResponse.json({ error: 'Change not found' }, { status: 404 })
    }

    // Update acknowledgment
    await prisma.lawChange.update({
      where: { id: params.id },
      data: {
        acknowledgedAt: new Date(),
        acknowledgedBy: userId
      }
    })

    // Log activity
    await prisma.workspaceActivity.create({
      data: {
        workspaceId,
        userId,
        action: 'law_change_reviewed',
        resourceType: 'law_change',
        resourceId: lawChange.id,
        metadata: {
          lawTitle: lawChange.law.rubrik,
          lawSfsNummer: lawChange.law.sfsNummer
        }
      }
    })

    return NextResponse.json({ success: true })
  })
}
```

**Bulk Acknowledge API:**
```typescript
// app/api/law-changes/bulk-acknowledge/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'

export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, userId }) => {
    const { changeIds } = await request.json()

    if (!changeIds || !Array.isArray(changeIds)) {
      return NextResponse.json({ error: 'Invalid changeIds' }, { status: 400 })
    }

    // Update all changes
    await prisma.lawChange.updateMany({
      where: {
        id: { in: changeIds },
        law: {
          workspaceLaws: {
            some: { workspaceId }
          }
        },
        acknowledgedAt: null
      },
      data: {
        acknowledgedAt: new Date(),
        acknowledgedBy: userId
      }
    })

    // Log bulk activity
    await prisma.workspaceActivity.create({
      data: {
        workspaceId,
        userId,
        action: 'law_changes_bulk_reviewed',
        resourceType: 'law_change',
        resourceId: null,
        metadata: {
          count: changeIds.length
        }
      }
    })

    return NextResponse.json({ success: true, acknowledgedCount: changeIds.length })
  })
}
```

**Toast Notification Component:**
```typescript
// components/ui/toast.tsx
'use client'

import { createContext, useContext, useState, useCallback } from 'react'

interface Toast {
  id: string
  message: string
  type: 'success' | 'error' | 'info'
}

const ToastContext = createContext<{
  addToast: (message: string, type: Toast['type']) => void
}>({
  addToast: () => {}
})

export function ToastProvider({ children }: { children: React.ReactNode }) {
  const [toasts, setToasts] = useState<Toast[]>([])

  const addToast = useCallback((message: string, type: Toast['type']) => {
    const id = Math.random().toString(36).substr(2, 9)
    setToasts((prev) => [...prev, { id, message, type }])

    setTimeout(() => {
      setToasts((prev) => prev.filter((toast) => toast.id !== id))
    }, 3000)
  }, [])

  return (
    <ToastContext.Provider value={{ addToast }}>
      {children}
      <div className="fixed bottom-4 right-4 z-50 space-y-2">
        {toasts.map((toast) => (
          <div
            key={toast.id}
            className={`px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in ${
              toast.type === 'success'
                ? 'bg-green-600 text-white'
                : toast.type === 'error'
                ? 'bg-red-600 text-white'
                : 'bg-blue-600 text-white'
            }`}
          >
            {toast.type === 'success' && (
              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fillRule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clipRule="evenodd"
                />
              </svg>
            )}
            <span className="text-sm font-medium">{toast.message}</span>
          </div>
        ))}
      </div>
    </ToastContext.Provider>
  )
}

export function useToast() {
  return useContext(ToastContext)
}
```

**Updated Change Card with Toast:**
```typescript
// components/laws/change-card.tsx (updated)
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useToast } from '@/components/ui/toast'

export function ChangeCard({ change }: ChangeCardProps) {
  const router = useRouter()
  const { addToast } = useToast()
  const [isMarking, setIsMarking] = useState(false)

  async function handleMarkAsReviewed() {
    setIsMarking(true)
    try {
      const response = await fetch(`/api/law-changes/${change.id}/acknowledge`, {
        method: 'POST'
      })

      if (response.ok) {
        addToast('Change marked as reviewed ✓', 'success')
        router.refresh()
      } else {
        addToast('Failed to mark as reviewed', 'error')
      }
    } catch (error) {
      addToast('Failed to mark as reviewed', 'error')
    } finally {
      setIsMarking(false)
    }
  }

  // ... rest of component
}
```

**Bulk Acknowledge Modal:**
```typescript
// components/laws/bulk-acknowledge-modal.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useToast } from '@/components/ui/toast'

interface BulkAcknowledgeModalProps {
  changeIds: string[]
  isOpen: boolean
  onClose: () => void
}

export function BulkAcknowledgeModal({ changeIds, isOpen, onClose }: BulkAcknowledgeModalProps) {
  const router = useRouter()
  const { addToast } = useToast()
  const [isProcessing, setIsProcessing] = useState(false)

  async function handleBulkAcknowledge() {
    setIsProcessing(true)
    try {
      const response = await fetch('/api/law-changes/bulk-acknowledge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ changeIds })
      })

      if (response.ok) {
        const { acknowledgedCount } = await response.json()
        addToast(`${acknowledgedCount} changes marked as reviewed ✓`, 'success')
        onClose()
        router.refresh()
      } else {
        addToast('Failed to mark changes as reviewed', 'error')
      }
    } catch (error) {
      addToast('Failed to mark changes as reviewed', 'error')
    } finally {
      setIsProcessing(false)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg w-full max-w-md p-6">
        <h2 className="text-xl font-bold mb-4">Mark All as Reviewed?</h2>
        <p className="text-sm text-gray-600 mb-6">
          Are you sure you want to mark all {changeIds.length} changes as reviewed? This action cannot be undone.
        </p>
        <div className="flex gap-3">
          <button
            onClick={onClose}
            disabled={isProcessing}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:bg-gray-100"
          >
            Cancel
          </button>
          <button
            onClick={handleBulkAcknowledge}
            disabled={isProcessing}
            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
          >
            {isProcessing ? 'Processing...' : 'Mark All as Reviewed'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

**Add Bulk Button to Changes Tab:**
```typescript
// components/laws/changes-tab.tsx (updated)
'use client'

import { useState } from 'react'
import { BulkAcknowledgeModal } from './bulk-acknowledge-modal'

export function ChangesTab({ changes }: { changes: any[] }) {
  const [showBulkModal, setShowBulkModal] = useState(false)

  if (changes.length === 0) {
    return <EmptyState />
  }

  const changeIds = changes.map((c) => c.id)

  return (
    <div>
      {/* Header with Bulk Action */}
      <div className="flex items-center justify-between mb-6">
        <PriorityFilter />
        <button
          onClick={() => setShowBulkModal(true)}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
        >
          Mark All as Reviewed ({changes.length})
        </button>
      </div>

      {/* Changes List */}
      <div className="space-y-4">
        {changes.map((change) => (
          <ChangeCard key={change.id} change={change} />
        ))}
      </div>

      {/* Bulk Modal */}
      <BulkAcknowledgeModal
        changeIds={changeIds}
        isOpen={showBulkModal}
        onClose={() => setShowBulkModal(false)}
      />
    </div>
  )
}
```

**Reference:** PRD Epic 8 Story 8.3

## Testing

**Unit Tests:**
- Acknowledge API updates timestamps correctly
- Bulk acknowledge API processes all change IDs
- Toast notification displays for 3 seconds
- Activity log created for each acknowledge

**Integration Tests:**
- Mark single change as reviewed, verify removed from Changes tab
- Mark single change, verify unacknowledged count badge decrements
- Click bulk acknowledge, verify confirmation modal appears
- Confirm bulk acknowledge, verify all changes removed
- Verify activity log entry created with correct metadata

**Manual Testing:**
- Click "Mark as Reviewed" on change card, verify toast appears
- Verify change disappears from Changes tab after marking
- Click "Mark All as Reviewed", verify confirmation modal
- Confirm bulk action, verify toast shows count (e.g., "15 changes marked as reviewed ✓")
- View Workspace Activity Log (Enterprise), verify review actions logged
- Test with no changes, verify bulk button hidden
- Test on mobile, verify toast doesn't overlap content

**Edge Cases:**
- Mark already acknowledged change (should return error)
- Bulk acknowledge with empty array (should validate)
- Bulk acknowledge with mix of valid/invalid IDs (handle gracefully)
- Network error during acknowledge (show error toast)

**Performance Testing:**
- Single acknowledge completes <300ms
- Bulk acknowledge 50 changes completes <2 seconds
- Toast animation smooth (60fps)

**Test File:** `__tests__/features/law-changes/acknowledge.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Mark changes as reviewed only after understanding impact
- Use bulk acknowledge carefully (review all changes first)
- Don't mark high-priority changes as reviewed without action plan

**Developer Responsibility:**
- Update acknowledgment timestamps atomically
- Show clear confirmation for bulk actions
- Provide toast feedback for all actions (success/error)
- Log all acknowledge actions for audit trail
- Optimize bulk acknowledge for large volumes (batch processing)
- Prevent double-acknowledgment (idempotency)
- Make toast notifications accessible (ARIA announcements)
- Handle errors gracefully (network failures, invalid IDs)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
