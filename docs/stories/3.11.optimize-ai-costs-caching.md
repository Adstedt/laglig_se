# Story 3.11: Optimize AI API Costs with Caching

## Status
Draft

## Story

**As a** product owner,
**I want** to cache AI responses for common queries,
**so that** we reduce OpenAI API costs.

## Acceptance Criteria

1. Response caching implemented using Redis or Vercel KV
2. Cache key: hash of query + context (law_ids)
3. Cache hit → Return cached response (skip LLM call)
4. Cache miss → Call LLM, store response in cache
5. Cache TTL: 7 days
6. Cache invalidation: When law content changes
7. Analytics tracking: Cache hit rate target >50%
8. Cost tracking: AI API costs per query logged
9. Dashboard shows: Daily API costs, cache hit rate, queries per tier
10. Optimization: Cheaper embedding model if cost/query >€0.10

## Tasks / Subtasks

- [ ] Set up Vercel KV or Redis
- [ ] Implement cache layer
- [ ] Create cache key hashing
- [ ] Add cache invalidation logic
- [ ] Track cache hit rate
- [ ] Build cost analytics dashboard

## Dev Notes

**Caching with Vercel KV:**
```typescript
import { kv } from '@vercel/kv'

async function getCachedResponse(query: string, contextIds: string[]) {
  const cacheKey = generateCacheKey(query, contextIds)
  const cached = await kv.get(cacheKey)

  if (cached) {
    trackCacheHit()
    return cached
  }

  // Cache miss - call LLM
  const response = await callRAGPipeline(query, contextIds)

  // Store in cache (7 day TTL)
  await kv.set(cacheKey, response, { ex: 7 * 24 * 60 * 60 })

  trackCacheMiss()
  return response
}

function generateCacheKey(query: string, contextIds: string[]): string {
  const normalized = query.toLowerCase().trim()
  const context = contextIds.sort().join(',')
  return `chat:${hash(normalized + context)}`
}
```

**Cost Tracking:**
```typescript
await prisma.aiCostLog.create({
  data: {
    endpoint: '/api/chat/query',
    model: 'gpt-4',
    inputTokens: 1500,
    outputTokens: 300,
    cost: calculateCost('gpt-4', 1500, 300),
    cacheHit: false,
    timestamp: new Date()
  }
})
```

**Reference:** Architecture Section 19 (Monitoring), Cost optimization strategies

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-11 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
