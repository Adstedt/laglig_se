# Story 8.10: Implement Effective Date Tracking and Display

## Status

Draft (v2 — rewritten to leverage existing effective_date fields from amendment pipeline)

## Story

**As a** workspace member reviewing law changes,
**I want** to see when each amendment takes effect with clear visual indicators,
**so that** I can plan compliance timelines and prioritize urgent changes.

## Context & Dependencies

**Builds on:**

- `AmendmentDocument.effective_date` — already parsed from amendment PDFs by `sync-sfs-updates` cron
- `Amendment.effective_date` — stored when amendment record is created
- `LegalDocument.effective_date` — available on amendment LegalDocuments
- Story 8.1 (Changes Tab) — displays change cards where effective date badges will appear
- Story 8.2 (Diff View) — displays full effective date section
- Story 8.9 (Timeline) — shows effective date per amendment with future indicator

**Key insight:** Unlike the original Story 8.10 which proposed building separate date extraction logic (regex + OpenAI), the actual pipeline already parses effective dates during amendment PDF processing in `sync-sfs-updates`. This story focuses on **displaying** effective dates, not extracting them.

**What's already available:**
- `AmendmentDocument.effective_date` — set during PDF parsing
- `Amendment.effective_date` — set during amendment creation
- Riksdagen API provides `ikraftträdandedatum` for many laws

**What may be missing:**
- Some older amendments may lack effective dates (fallback handling needed)
- `ChangeEvent` may not have a direct effective_date field — needs to resolve through amendment chain

## Acceptance Criteria

### Effective Date Display

1. **Changes Tab cards** (Story 8.1) show effective date badge:
   - "Traeder i kraft om 30 dagar" (amber) — future
   - "Traeder i kraft idag" (red) — today
   - "Traedde i kraft foer 10 dagar sedan" (green) — recent past
   - "Ikrafttraedande okaent" (gray) — no date available
2. **Diff view** (Story 8.2) shows effective date section:
   - Detected date: "Aendringen upptaeckt {date}"
   - Effective date: "Traeder i kraft {date}"
   - Time until effective: calculated relative display
   - Source link: link to Riksdagen page for the amendment
3. **Amendment timeline** (Story 8.9) shows effective date per amendment card with future indicator badge

### Effective Date Resolution

4. Resolve effective date from chain: `ChangeEvent.amendment_sfs` → `AmendmentDocument.effective_date` or `Amendment.effective_date` or `LegalDocument.effective_date`
5. Use first non-null value from the chain
6. If all null: display "Ikrafttraedandedatum okaent" badge

### Sort Enhancement

7. Changes Tab supports sorting by effective date (upcoming first) as secondary sort option
8. Priority remains primary sort, effective date as optional secondary

### Email Integration

9. Story 8.4 daily digest emails include effective date for each amendment: "Ikrafttraedande: {date}"
10. Story 8.6 reminder emails highlight amendments with upcoming effective dates (within 30 days)

## Tasks / Subtasks

- [ ] **Task 1: Create effectiveDateBadge utility** (AC: 1, 6)
  - [ ] Shared utility function: given a date (or null), return { text, color, variant }
  - [ ] Handle future, today, recent past, far past, unknown cases
  - [ ] Swedish-language labels
- [ ] **Task 2: Create effectiveDate resolution helper** (AC: 4, 5)
  - [ ] Given a ChangeEvent, resolve effective date through amendment chain
  - [ ] Fallback: try AmendmentDocument → Amendment → LegalDocument → null
- [ ] **Task 3: Add badge to ChangeCard** (AC: 1)
  - [ ] Import and render effectiveDateBadge in Story 8.1's ChangeCard
- [ ] **Task 4: Add effective date section to diff page** (AC: 2)
  - [ ] Add section below summering/kommentar in Story 8.2's diff page
  - [ ] Show detected date, effective date, time-until-effective, source link
- [ ] **Task 5: Sort by effective date option** (AC: 7, 8)
  - [ ] Add sort toggle to Changes Tab: "Sort by: Priority | Effective Date"
  - [ ] Secondary sort within priority groups
- [ ] **Task 6: Email integration** (AC: 9, 10)
  - [ ] Update Story 8.4 email template to include effective date line
  - [ ] Update Story 8.6 reminder emails to highlight upcoming effective dates

## Dev Notes

### Source Tree (relevant files)

```
app/api/cron/sync-sfs-updates/route.ts       — Parses effective_date from amendments
lib/sfs/amendment-llm-prompt.ts              — LLM prompt extracts effective date from PDF
prisma/schema.prisma                         — AmendmentDocument.effective_date, Amendment.effective_date
```

### Key Data Models

```
Effective date resolution chain:
  ChangeEvent.amendment_sfs
    → AmendmentDocument.effective_date     (parsed from PDF)
    → Amendment.effective_date             (set during creation)
    → LegalDocument.effective_date         (on amendment legal doc)
    → null (display "okänt")

Badge logic:
  date > today + 30 days     → blue "Träder i kraft {date}"
  date > today + 7 days      → amber "Träder i kraft om {N} dagar"
  date > today               → red "Träder i kraft om {N} dagar"
  date == today               → red "Träder i kraft idag"
  date < today && < 30 days   → green "Trädde i kraft för {N} dagar sedan"
  date < today && > 30 days   → (no badge, already established)
  null                        → gray "Ikraftträdandedatum okänt"
```

### Shared Utility

```typescript
// lib/utils/effective-date-badge.ts
export function getEffectiveDateBadge(date: Date | null): {
  text: string
  variant: 'default' | 'destructive' | 'secondary' | 'outline'
  className: string
} | null
```

### UI Standards

- shadcn/ui Badge for date indicators
- Shared utility used by ChangeCard (8.1), DiffPage (8.2), AmendmentCard (8.9)

## Testing

**Test location:** `tests/unit/lib/utils/effective-date-badge.test.ts`

**Test framework:** Vitest

**Unit tests:**
- Badge returns correct text and color for: 60 days future, 7 days future, today, 10 days ago, 60 days ago, null
- Resolution helper finds effective date from AmendmentDocument
- Resolution helper falls back through chain correctly
- Null handling produces "unknown" badge

**Integration tests:**
- ChangeCard displays correct effective date badge
- Diff page shows full effective date section
- Sort by effective date orders upcoming first

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation (with separate date extraction logic)   | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: leverage existing effective_date from amendment pipeline, focus on display not extraction | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
