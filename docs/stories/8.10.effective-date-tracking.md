# Story 8.10: Implement Effective Date Tracking

## Status

Draft

## Story

**As a** user,
**I want** to see when a law change takes effect,
**so that** I can plan compliance timelines.

## Acceptance Criteria

1. **`law_changes` table stores:**
   - `effectiveDate` (when change becomes active)
   - `sourceUrl` (link to Riksdagen proposition/document)

2. **Diff view modal displays:**
   - Detected date (when we found the change)
   - Effective date (when change takes effect)
   - Time until effective (e.g., "60 days from now", "Effective today", "Effective 10 days ago")
   - Source link (Riksdagen proposition or official document)

3. **Changes tab badges:**
   - **"Effective in 30 days"** (amber) - Future effective date
   - **"Effective today"** (red) - Takes effect today
   - **"Effective 10 days ago"** (green) - Already in effect

4. **Sort changes by effective date:**
   - Prioritize upcoming effective dates (soonest first)
   - Then by detection date

5. **Calendar view (optional enhancement):**
   - Display upcoming effective dates on calendar
   - Click date → Shows all changes effective that day

6. **Notifications mention effective date:**
   - Daily digest: "Changes effective this week: 3"
   - Weekly digest: "Upcoming effective dates"

7. **Extract effective date from change content:**
   - Parse Swedish date phrases: "träder i kraft den 1 januari 2025"
   - Fallback: Manual input or AI extraction

8. **Empty state for unknown effective date:**
   - Badge: "Effective date unknown"
   - Prompt user to add manually

## Tasks / Subtasks

- [ ] Add effectiveDate and sourceUrl to law_changes schema
- [ ] Create function to extract effective date from text
- [ ] Add AI extraction as fallback
- [ ] Display effective date in diff modal
- [ ] Add effective date badges to change cards
- [ ] Implement "time until effective" calculation
- [ ] Sort changes by effective date
- [ ] Add effective date to email notifications
- [ ] Allow manual input of effective date
- [ ] Test with various date formats
- [ ] Test badge colors and logic
- [ ] Test sorting by effective date

## Dev Notes

**Database Schema (already exists, add fields):**

```prisma
model LawChange {
  id                    String   @id @default(uuid())
  lawId                 String
  changeType            String
  priority              String
  detectedAt            DateTime
  acknowledgedAt        DateTime?
  acknowledgedBy        String?
  oldContent            String   @db.Text
  newContent            String   @db.Text
  diffContent           String   @db.Text
  aiSummary             String?  @db.Text
  businessImpact        String?
  contextualExplanation String?
  affectedSections      String[]

  // New fields for Story 8.10
  effectiveDate         DateTime?
  sourceUrl             String?

  law Law @relation(fields: [lawId], references: [id])

  @@index([lawId, acknowledgedAt])
  @@index([detectedAt])
  @@index([effectiveDate])
  @@map("law_changes")
}
```

**Extract Effective Date from Text:**

```typescript
// lib/law-changes/extract-effective-date.ts

interface EffectiveDateResult {
  effectiveDate: Date | null
  confidence: 'high' | 'medium' | 'low'
  sourcePhrase?: string
}

export function extractEffectiveDate(text: string): EffectiveDateResult {
  // Common Swedish date phrases
  const patterns = [
    // "träder i kraft den 1 januari 2025"
    /träder i kraft den (\d{1,2}) (januari|februari|mars|april|maj|juni|juli|augusti|september|oktober|november|december) (\d{4})/i,

    // "ikraftträdande: 2025-01-01"
    /ikraftträdande[:\s]+(\d{4})-(\d{2})-(\d{2})/i,

    // "denna lag träder i kraft den 1 juli 2024"
    /denna lag träder i kraft den (\d{1,2}) (januari|februari|mars|april|maj|juni|juli|augusti|september|oktober|november|december) (\d{4})/i,

    // "gäller från och med den 1 januari 2025"
    /gäller från och med den (\d{1,2}) (januari|februari|mars|april|maj|juni|juli|augusti|september|oktober|november|december) (\d{4})/i,
  ]

  const monthMap: { [key: string]: number } = {
    januari: 0,
    februari: 1,
    mars: 2,
    april: 3,
    maj: 4,
    juni: 5,
    juli: 6,
    augusti: 7,
    september: 8,
    oktober: 9,
    november: 10,
    december: 11,
  }

  for (const pattern of patterns) {
    const match = text.match(pattern)
    if (match) {
      try {
        let date: Date

        if (pattern.toString().includes('(\d{4})-(\d{2})-(\d{2})')) {
          // ISO format: 2025-01-01
          date = new Date(match[1], parseInt(match[2]) - 1, parseInt(match[3]))
        } else {
          // Swedish format: 1 januari 2025
          const day = parseInt(match[1])
          const month = monthMap[match[2].toLowerCase()]
          const year = parseInt(match[3])
          date = new Date(year, month, day)
        }

        return {
          effectiveDate: date,
          confidence: 'high',
          sourcePhrase: match[0],
        }
      } catch (error) {
        console.error('Failed to parse date from match:', match, error)
      }
    }
  }

  return { effectiveDate: null, confidence: 'low' }
}
```

**AI Effective Date Extraction:**

```typescript
// lib/law-changes/extract-effective-date-ai.ts
import OpenAI from 'openai'

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

export async function extractEffectiveDateAI(
  newContent: string,
  lawTitle: string
): Promise<{
  effectiveDate: Date | null
  confidence: 'high' | 'medium' | 'low'
}> {
  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: `Du är en expert på svensk lagstiftning. Din uppgift är att hitta ikraftträdandedatum i lagtext. Svara med ENDAST datumet i formatet YYYY-MM-DD, eller "UNKNOWN" om inget datum hittas.`,
        },
        {
          role: 'user',
          content: `Lag: ${lawTitle}

Text:
${newContent.substring(0, 2000)}

Hitta ikraftträdandedatumet. Svara med YYYY-MM-DD eller "UNKNOWN".`,
        },
      ],
      temperature: 0.1,
      max_tokens: 20,
    })

    const result = response.choices[0].message.content?.trim()

    if (result && result !== 'UNKNOWN') {
      // Parse YYYY-MM-DD
      const dateMatch = result.match(/(\d{4})-(\d{2})-(\d{2})/)
      if (dateMatch) {
        const date = new Date(
          dateMatch[1],
          parseInt(dateMatch[2]) - 1,
          parseInt(dateMatch[3])
        )
        return { effectiveDate: date, confidence: 'medium' }
      }
    }

    return { effectiveDate: null, confidence: 'low' }
  } catch (error) {
    console.error('Failed to extract effective date with AI:', error)
    return { effectiveDate: null, confidence: 'low' }
  }
}
```

**Combined Extraction Logic:**

```typescript
// lib/law-changes/detect-effective-date.ts
import { extractEffectiveDate } from './extract-effective-date'
import { extractEffectiveDateAI } from './extract-effective-date-ai'

export async function detectEffectiveDate(
  newContent: string,
  lawTitle: string
): Promise<Date | null> {
  // First try regex extraction
  const regexResult = extractEffectiveDate(newContent)
  if (regexResult.effectiveDate && regexResult.confidence === 'high') {
    console.log(`Effective date found via regex: ${regexResult.effectiveDate}`)
    return regexResult.effectiveDate
  }

  // Fallback to AI extraction
  const aiResult = await extractEffectiveDateAI(newContent, lawTitle)
  if (aiResult.effectiveDate && aiResult.confidence !== 'low') {
    console.log(`Effective date found via AI: ${aiResult.effectiveDate}`)
    return aiResult.effectiveDate
  }

  console.log('Effective date not found')
  return null
}
```

**Integration with Change Detection:**

```typescript
// app/api/cron/detect-law-changes/route.ts (excerpt)
import { detectEffectiveDate } from '@/lib/law-changes/detect-effective-date'

async function detectAndStoreChange(
  law: any,
  oldContent: string,
  newContent: string
) {
  // ... existing logic (priority, AI summary, etc.)

  // Detect effective date
  const effectiveDate = await detectEffectiveDate(newContent, law.rubrik)

  // Generate source URL (Riksdagen proposition)
  const sourceUrl = `https://www.riksdagen.se/sv/dokument-och-lagar/dokument/svensk-forfattningssamling/${law.sfsNummer}`

  // Store change
  await prisma.lawChange.create({
    data: {
      lawId: law.id,
      changeType: 'amendment',
      priority,
      detectedAt: new Date(),
      oldContent,
      newContent,
      diffContent: generateDiff(oldContent, newContent),
      aiSummary,
      businessImpact,
      contextualExplanation,
      affectedSections,
      effectiveDate,
      sourceUrl,
    },
  })

  console.log(
    `Change detected for ${law.sfsNummer}, effective: ${effectiveDate || 'unknown'}`
  )
}
```

**Display Effective Date in Diff Modal:**

```typescript
// components/laws/diff-modal.tsx (excerpt, add to existing component)

function formatTimeUntilEffective(effectiveDate: Date): { text: string; color: string } {
  const now = new Date()
  const diffMs = effectiveDate.getTime() - now.getTime()
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

  if (diffDays > 0) {
    // Future
    if (diffDays === 0) {
      return { text: 'Träder i kraft idag', color: 'bg-red-100 text-red-800' }
    } else if (diffDays <= 7) {
      return { text: `Träder i kraft om ${diffDays} dagar`, color: 'bg-red-100 text-red-800' }
    } else if (diffDays <= 30) {
      return { text: `Träder i kraft om ${diffDays} dagar`, color: 'bg-amber-100 text-amber-800' }
    } else {
      return { text: `Träder i kraft om ${Math.floor(diffDays / 30)} månader`, color: 'bg-blue-100 text-blue-800' }
    }
  } else {
    // Past
    const daysSince = Math.abs(diffDays)
    if (daysSince === 0) {
      return { text: 'Träder i kraft idag', color: 'bg-red-100 text-red-800' }
    } else if (daysSince <= 30) {
      return { text: `Trädde i kraft för ${daysSince} dagar sedan`, color: 'bg-green-100 text-green-800' }
    } else {
      return { text: `Trädde i kraft för ${Math.floor(daysSince / 30)} månader sedan`, color: 'bg-green-100 text-green-800' }
    }
  }
}

// In diff modal component:
{change.effectiveDate && (
  <div className="p-4 bg-gray-50 border-b border-gray-200">
    <h3 className="text-sm font-semibold text-gray-900 mb-2">Ikraftträdande</h3>
    <div className="flex flex-wrap gap-3">
      <div>
        <p className="text-xs text-gray-600">Upptäckt</p>
        <p className="text-sm font-medium">{new Date(change.detectedAt).toLocaleDateString('sv-SE')}</p>
      </div>
      <div>
        <p className="text-xs text-gray-600">Träder i kraft</p>
        <p className="text-sm font-medium">{new Date(change.effectiveDate).toLocaleDateString('sv-SE')}</p>
      </div>
      <div className="flex items-center">
        <span
          className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
            formatTimeUntilEffective(new Date(change.effectiveDate)).color
          }`}
        >
          {formatTimeUntilEffective(new Date(change.effectiveDate)).text}
        </span>
      </div>
    </div>
    {change.sourceUrl && (
      <a
        href={change.sourceUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="text-sm text-blue-600 hover:underline mt-2 inline-block"
      >
        Källa: Riksdagen ↗
      </a>
    )}
  </div>
)}
```

**Add Badge to Change Card:**

```typescript
// components/laws/change-card.tsx (excerpt)

function getEffectiveDateBadge(effectiveDate: Date | null): { text: string; color: string } | null {
  if (!effectiveDate) {
    return { text: 'Ikraftträdandedatum okänt', color: 'bg-gray-100 text-gray-600' }
  }

  const now = new Date()
  const diffMs = effectiveDate.getTime() - now.getTime()
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

  if (diffDays > 0) {
    // Future
    if (diffDays <= 7) {
      return { text: `Träder i kraft om ${diffDays} dagar`, color: 'bg-red-100 text-red-800' }
    } else if (diffDays <= 30) {
      return { text: `Träder i kraft om ${diffDays} dagar`, color: 'bg-amber-100 text-amber-800' }
    } else {
      return { text: `Träder i kraft ${effectiveDate.toLocaleDateString('sv-SE')}`, color: 'bg-blue-100 text-blue-800' }
    }
  } else {
    // Past
    const daysSince = Math.abs(diffDays)
    if (daysSince <= 30) {
      return { text: `Trädde i kraft för ${daysSince} dagar sedan`, color: 'bg-green-100 text-green-800' }
    } else {
      return null // Don't show badge for old changes
    }
  }
}

// In change card component:
{(() => {
  const badge = getEffectiveDateBadge(change.effectiveDate)
  return badge ? (
    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badge.color}`}>
      {badge.text}
    </span>
  ) : null
})()}
```

**Sort Changes by Effective Date:**

```typescript
// app/laws/changes/page.tsx (update query)
const changes = await prisma.lawChange.findMany({
  where: {
    law: {
      workspaceLaws: {
        some: { workspaceId },
      },
    },
    acknowledgedAt: null,
  },
  include: {
    law: {
      select: {
        id: true,
        sfsNummer: true,
        rubrik: true,
      },
    },
  },
  orderBy: [
    { priority: 'desc' }, // High priority first
    { effectiveDate: 'asc' }, // Soonest effective date first (null goes last)
    { detectedAt: 'desc' }, // Then by detection date
  ],
})
```

**Manual Input Form:**

```typescript
// components/laws/edit-effective-date-modal.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface EditEffectiveDateModalProps {
  change: any
  isOpen: boolean
  onClose: () => void
}

export function EditEffectiveDateModal({ change, isOpen, onClose }: EditEffectiveDateModalProps) {
  const [effectiveDate, setEffectiveDate] = useState(
    change.effectiveDate ? new Date(change.effectiveDate).toISOString().split('T')[0] : ''
  )
  const [sourceUrl, setSourceUrl] = useState(change.sourceUrl || '')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const router = useRouter()

  async function handleSubmit() {
    setIsSubmitting(true)
    try {
      const response = await fetch(`/api/law-changes/${change.id}/effective-date`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          effectiveDate: effectiveDate ? new Date(effectiveDate) : null,
          sourceUrl
        })
      })

      if (response.ok) {
        onClose()
        router.refresh()
      }
    } catch (error) {
      console.error('Failed to update effective date:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg w-full max-w-md p-6">
        <h2 className="text-xl font-bold mb-4">Redigera ikraftträdandedatum</h2>

        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Ikraftträdandedatum
          </label>
          <input
            type="date"
            value={effectiveDate}
            onChange={(e) => setEffectiveDate(e.target.value)}
            className="w-full border border-gray-300 rounded-lg px-3 py-2"
          />
        </div>

        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Källa (URL)
          </label>
          <input
            type="url"
            value={sourceUrl}
            onChange={(e) => setSourceUrl(e.target.value)}
            placeholder="https://www.riksdagen.se/..."
            className="w-full border border-gray-300 rounded-lg px-3 py-2"
          />
        </div>

        <div className="flex gap-3">
          <button
            onClick={onClose}
            disabled={isSubmitting}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Avbryt
          </button>
          <button
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            {isSubmitting ? 'Sparar...' : 'Spara'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

**API Endpoint for Updating Effective Date:**

```typescript
// app/api/law-changes/[id]/effective-date/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'

export async function PATCH(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ userId }) => {
    const { effectiveDate, sourceUrl } = await request.json()

    const lawChange = await prisma.lawChange.update({
      where: { id: params.id },
      data: {
        effectiveDate: effectiveDate ? new Date(effectiveDate) : null,
        sourceUrl: sourceUrl || null,
      },
    })

    return NextResponse.json(lawChange)
  })
}
```

**Reference:** PRD Epic 8 Story 8.10

## Testing

**Unit Tests:**

- Regex extraction detects various Swedish date formats
- AI extraction returns date in YYYY-MM-DD format
- Time until effective calculates correctly (future/past)
- Badge color logic works for different time windows
- Manual input form validates date format

**Integration Tests:**

- Change detection extracts effective date
- Effective date stored in database
- Diff modal displays effective date section
- Change card displays effective date badge
- Changes sorted by effective date (soonest first)
- Manual update API works correctly

**Manual Testing:**

- Create change with "träder i kraft den 1 januari 2025" in text
- Verify effective date extracted as 2025-01-01
- Verify badge shows "Träder i kraft om X dagar"
- Wait until effective date passes, verify badge changes to "Trädde i kraft för X dagar sedan"
- Manually edit effective date, verify saved and displayed
- Test with change with no effective date, verify "okänt" badge

**Extraction Testing:**

- Test with 20+ different Swedish date phrasings
- Test AI extraction when regex fails
- Verify confidence scores (high/medium/low)
- Test with English text (should return null)

**Performance Testing:**

- Regex extraction completes <1ms
- AI extraction completes <2 seconds
- Badge calculation instant (<1ms)

**Edge Cases:**

- Change with no effective date (show "okänt" badge)
- Effective date in past (show "Trädde i kraft X dagar sedan")
- Effective date today (show "Träder i kraft idag" in red)
- Very far future date (2030+) (show full date)
- Invalid date format in manual input (validation error)

**Test File:** `__tests__/features/law-changes/effective-date.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Review effective dates to plan compliance timelines
- Manually add effective date if unknown
- Prioritize changes with upcoming effective dates

**Developer Responsibility:**

- Extract effective date from change content (regex + AI)
- Display effective date in diff modal and change cards
- Show time until effective with appropriate badge color
- Sort changes by effective date (upcoming first)
- Provide manual input form for missing dates
- Link to official source documents (Riksdagen)
- Include effective date in email notifications
- Optimize extraction performance (<5 seconds total)
- Handle missing effective dates gracefully
- Test with various Swedish date formats
- Store effective date in database for sorting/filtering

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
