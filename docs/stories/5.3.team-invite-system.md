# Story 5.3: Build Team Invite System

## Status

Draft

## Story

**As a** workspace owner/admin,
**I want** to invite team members via email,
**so that** they can join my workspace.

## Acceptance Criteria

1. Team settings page shows current members list
2. "Invite Member" button opens modal
3. Modal fields: Email, Role (dropdown)
4. Clicking "Send Invite" creates pending invitation
5. Invitation email sent to recipient with: workspace name, inviter name, "Join Workspace" CTA link
6. Invite link format: `/invite/[token]`
7. Recipient clicks link → Redirected to signup (if new user) or direct join (if existing user)
8. After joining, invitation status updated to "accepted"
9. Owner/Admin can re-send invites or revoke pending invites
10. Invite expiry: 7 days, auto-delete expired invites

## Tasks / Subtasks

- [ ] Create team settings page with members list
- [ ] Build invite member modal component
- [ ] Create invitation API endpoint
- [ ] Implement invite token generation
- [ ] Send invitation email
- [ ] Create invite acceptance page
- [ ] Handle new vs existing user flows
- [ ] Implement re-send and revoke functionality
- [ ] Add 7-day expiry with cron job
- [ ] Test complete invite flow

## Dev Notes

**Database Schema:**

```prisma
model WorkspaceInvitation {
  id          String   @id @default(uuid())
  workspaceId String
  email       String
  role        String   // admin, hr_manager, member
  token       String   @unique
  invitedBy   String   // User ID of inviter
  status      String   @default("pending") // pending, accepted, revoked
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  acceptedAt  DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter   User      @relation(fields: [invitedBy], references: [id])

  @@index([token])
  @@index([workspaceId, status])
  @@map("workspace_invitations")
}
```

**Team Settings Page:**

```typescript
// app/settings/team/page.tsx
'use client'

import { useState } from 'react'
import { Can } from '@/components/permissions/can'
import { Permission } from '@/lib/permissions/roles'

export default function TeamSettingsPage() {
  const [members, setMembers] = useState<Member[]>([])
  const [invitations, setInvitations] = useState<Invitation[]>([])
  const [isInviteModalOpen, setIsInviteModalOpen] = useState(false)

  return (
    <div className="max-w-4xl mx-auto p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Team Members</h1>

        <Can permission={Permission.INVITE_MEMBERS}>
          <button
            onClick={() => setIsInviteModalOpen(true)}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Invite Member
          </button>
        </Can>
      </div>

      {/* Current Members */}
      <div className="bg-white rounded-lg shadow mb-8">
        <div className="p-4 border-b">
          <h2 className="font-semibold">Current Members ({members.length})</h2>
        </div>
        <div className="divide-y">
          {members.map((member) => (
            <MemberRow key={member.id} member={member} />
          ))}
        </div>
      </div>

      {/* Pending Invitations */}
      {invitations.length > 0 && (
        <div className="bg-white rounded-lg shadow">
          <div className="p-4 border-b">
            <h2 className="font-semibold">
              Pending Invitations ({invitations.length})
            </h2>
          </div>
          <div className="divide-y">
            {invitations.map((invitation) => (
              <InvitationRow key={invitation.id} invitation={invitation} />
            ))}
          </div>
        </div>
      )}

      {/* Invite Modal */}
      {isInviteModalOpen && (
        <InviteMemberModal
          onClose={() => setIsInviteModalOpen(false)}
          onInviteSent={() => {
            setIsInviteModalOpen(false)
            // Refresh invitations list
          }}
        />
      )}
    </div>
  )
}

function MemberRow({ member }: { member: Member }) {
  return (
    <div className="p-4 flex items-center justify-between">
      <div className="flex items-center">
        <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
          <span className="text-blue-600 font-semibold">
            {member.user.email[0].toUpperCase()}
          </span>
        </div>
        <div>
          <p className="font-medium">{member.user.email}</p>
          <p className="text-sm text-gray-500">
            Joined {new Date(member.joinedAt).toLocaleDateString()}
          </p>
        </div>
      </div>

      <div className="flex items-center gap-3">
        <Can permission={Permission.MANAGE_MEMBERS}>
          <select
            value={member.role}
            onChange={(e) => updateMemberRole(member.id, e.target.value)}
            className="px-3 py-1 border border-gray-300 rounded"
          >
            <option value="member">Member</option>
            <option value="hr_manager">HR Manager</option>
            <option value="admin">Admin</option>
          </select>
        </Can>

        <RoleBadge role={member.role} />

        <Can permission={Permission.REMOVE_MEMBERS}>
          {member.role !== 'owner' && (
            <button
              onClick={() => removeMember(member.id)}
              className="text-red-600 hover:text-red-700 text-sm"
            >
              Remove
            </button>
          )}
        </Can>
      </div>
    </div>
  )
}

function InvitationRow({ invitation }: { invitation: Invitation }) {
  const daysUntilExpiry = Math.ceil(
    (new Date(invitation.expiresAt).getTime() - Date.now()) / (1000 * 60 * 60 * 24)
  )

  return (
    <div className="p-4 flex items-center justify-between">
      <div>
        <p className="font-medium">{invitation.email}</p>
        <p className="text-sm text-gray-500">
          Invited {new Date(invitation.createdAt).toLocaleDateString()} •
          Expires in {daysUntilExpiry} days
        </p>
      </div>

      <div className="flex items-center gap-3">
        <RoleBadge role={invitation.role} />

        <Can permission={Permission.INVITE_MEMBERS}>
          <button
            onClick={() => resendInvitation(invitation.id)}
            className="text-blue-600 hover:text-blue-700 text-sm"
          >
            Resend
          </button>
          <button
            onClick={() => revokeInvitation(invitation.id)}
            className="text-red-600 hover:text-red-700 text-sm"
          >
            Revoke
          </button>
        </Can>
      </div>
    </div>
  )
}

function RoleBadge({ role }: { role: string }) {
  const colors: Record<string, string> = {
    owner: 'bg-purple-100 text-purple-700',
    admin: 'bg-blue-100 text-blue-700',
    hr_manager: 'bg-green-100 text-green-700',
    member: 'bg-gray-100 text-gray-700'
  }

  const labels: Record<string, string> = {
    owner: 'Owner',
    admin: 'Admin',
    hr_manager: 'HR Manager',
    member: 'Member'
  }

  return (
    <span className={`px-2 py-1 text-xs rounded ${colors[role] || colors.member}`}>
      {labels[role] || role}
    </span>
  )
}
```

**Invite Member Modal:**

```typescript
// components/team/invite-member-modal.tsx
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'

export function InviteMemberModal({ onClose, onInviteSent }: Props) {
  const [isLoading, setIsLoading] = useState(false)
  const { register, handleSubmit, formState: { errors } } = useForm()

  async function onSubmit(data: { email: string; role: string }) {
    setIsLoading(true)

    try {
      const response = await fetch('/api/workspace/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })

      if (!response.ok) {
        throw new Error('Failed to send invitation')
      }

      alert('Invitation sent successfully!')
      onInviteSent()
    } catch (error) {
      alert('Failed to send invitation')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-bold">Invite Team Member</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
            ✕
          </button>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Email Address</label>
            <input
              type="email"
              {...register('email', { required: 'Email is required' })}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder="colleague@example.com"
            />
            {errors.email && (
              <p className="mt-1 text-sm text-red-600">{errors.email.message}</p>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Role</label>
            <select
              {...register('role', { required: 'Role is required' })}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="member">Member (Read-only)</option>
              <option value="hr_manager">HR Manager (Manage employees)</option>
              <option value="admin">Admin (Full access except billing)</option>
            </select>
            {errors.role && (
              <p className="mt-1 text-sm text-red-600">{errors.role.message}</p>
            )}
          </div>

          <div className="flex gap-3">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={isLoading}
              className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
            >
              {isLoading ? 'Sending...' : 'Send Invitation'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

**Invitation API Endpoint:**

```typescript
// app/api/workspace/invite/route.ts
import crypto from 'crypto'

export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    // Check permission
    checkPermission(role as WorkspaceRole, Permission.INVITE_MEMBERS)

    const { email, role: inviteeRole } = await request.json()

    // Validate email
    if (!email || !isValidEmail(email)) {
      return NextResponse.json({ error: 'Invalid email' }, { status: 400 })
    }

    // Check if user already in workspace
    const existingMember = await prisma.workspaceMember.findFirst({
      where: {
        workspaceId,
        user: { email },
      },
    })

    if (existingMember) {
      return NextResponse.json(
        { error: 'User already in workspace' },
        { status: 400 }
      )
    }

    // Check if invitation already exists
    const existingInvitation = await prisma.workspaceInvitation.findFirst({
      where: {
        workspaceId,
        email,
        status: 'pending',
      },
    })

    if (existingInvitation) {
      return NextResponse.json(
        { error: 'Invitation already sent' },
        { status: 400 }
      )
    }

    // Generate unique token
    const token = crypto.randomBytes(32).toString('hex')

    // Create invitation
    const invitation = await prisma.workspaceInvitation.create({
      data: {
        workspaceId,
        email,
        role: inviteeRole,
        token,
        invitedBy: userId,
        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days
      },
    })

    // Get workspace and inviter info
    const workspace = await prisma.workspace.findUnique({
      where: { id: workspaceId },
      include: { owner: true },
    })

    const inviter = await prisma.user.findUnique({
      where: { id: userId },
    })

    // Send invitation email
    await sendInvitationEmail({
      to: email,
      workspaceName: workspace.name,
      inviterEmail: inviter.email,
      role: inviteeRole,
      inviteUrl: `${process.env.NEXT_PUBLIC_APP_URL}/invite/${token}`,
    })

    return NextResponse.json({ success: true })
  })
}
```

**Invitation Acceptance Page:**

```typescript
// app/invite/[token]/page.tsx
export default async function InviteAcceptPage({
  params
}: {
  params: { token: string }
}) {
  const invitation = await prisma.workspaceInvitation.findUnique({
    where: { token: params.token },
    include: {
      workspace: true,
      inviter: true
    }
  })

  if (!invitation || invitation.status !== 'pending') {
    return <InvalidInvitePage />
  }

  if (new Date() > invitation.expiresAt) {
    return <ExpiredInvitePage />
  }

  // Check if user is logged in
  const session = await getServerSession(authOptions)

  if (!session) {
    // Redirect to signup with invite token
    return redirect(`/signup?invite=${params.token}`)
  }

  // User is logged in - accept invitation directly
  return <AcceptInviteForm invitation={invitation} />
}

function AcceptInviteForm({ invitation }: { invitation: Invitation }) {
  async function acceptInvite() {
    const response = await fetch(`/api/invite/${invitation.token}/accept`, {
      method: 'POST'
    })

    if (response.ok) {
      window.location.href = '/dashboard'
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
        <h1 className="text-2xl font-bold mb-4">Join Workspace</h1>
        <p className="text-gray-600 mb-2">
          You've been invited to join <strong>{invitation.workspace.name}</strong>
        </p>
        <p className="text-sm text-gray-500 mb-6">
          Invited by {invitation.inviter.email}
        </p>

        <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-6">
          <p className="text-sm text-blue-900">
            You'll join as <strong>{invitation.role}</strong>
          </p>
        </div>

        <button
          onClick={acceptInvite}
          className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          Accept Invitation
        </button>
      </div>
    </div>
  )
}
```

**Accept Invitation API:**

```typescript
// app/api/invite/[token]/accept/route.ts
export async function POST(
  request: Request,
  { params }: { params: { token: string } }
) {
  const session = await getServerSession(authOptions)

  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const invitation = await prisma.workspaceInvitation.findUnique({
    where: { token: params.token },
  })

  if (!invitation || invitation.status !== 'pending') {
    return NextResponse.json({ error: 'Invalid invitation' }, { status: 400 })
  }

  if (new Date() > invitation.expiresAt) {
    return NextResponse.json({ error: 'Invitation expired' }, { status: 400 })
  }

  // Add user to workspace
  await prisma.workspaceMember.create({
    data: {
      workspaceId: invitation.workspaceId,
      userId: session.user.id,
      role: invitation.role,
      joinedAt: new Date(),
    },
  })

  // Mark invitation as accepted
  await prisma.workspaceInvitation.update({
    where: { id: invitation.id },
    data: {
      status: 'accepted',
      acceptedAt: new Date(),
    },
  })

  return NextResponse.json({ success: true })
}
```

**Invitation Email Template:**

```typescript
// components/emails/workspace-invitation.tsx
export function WorkspaceInvitationEmail({
  workspaceName,
  inviterEmail,
  role,
  inviteUrl
}: Props) {
  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>
            You've been invited to join {workspaceName}
          </Heading>

          <Text style={styles.text}>
            {inviterEmail} has invited you to collaborate on {workspaceName} at
            Laglig.se.
          </Text>

          <Text style={styles.text}>
            You'll join as <strong>{role}</strong>.
          </Text>

          <Section style={styles.buttonSection}>
            <Button href={inviteUrl} style={styles.button}>
              Accept Invitation
            </Button>
          </Section>

          <Text style={styles.smallText}>
            This invitation expires in 7 days.
          </Text>

          <Hr style={styles.hr} />

          <Text style={styles.smallText}>
            If you didn't expect this invitation, you can safely ignore this email.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}
```

**Cron Job for Expired Invitations:**

```typescript
// lib/cron/delete-expired-invitations.ts
export function scheduleExpiredInvitationCleanup() {
  cron.schedule('0 0 * * *', async () => {
    const now = new Date()

    await prisma.workspaceInvitation.deleteMany({
      where: {
        expiresAt: {
          lt: now,
        },
        status: 'pending',
      },
    })

    console.log('Deleted expired invitations')
  })
}
```

**Reference:** PRD Epic 5 Story 5.3, Architecture Section 12 (Multi-Tenancy)

## Testing

**Unit Tests:**

- Token generation creates unique tokens
- Invitation expiry calculated correctly (7 days)
- Email validation rejects invalid emails

**Integration Tests:**

- Complete invite flow: send → accept → join workspace
- New user signup with invite token
- Existing user accepts invitation
- Expired invitation rejected
- Revoked invitation rejected
- Re-send invitation updates expiry

**Manual Testing:**

- Send invitation, verify email received
- Accept invitation as new user (signup flow)
- Accept invitation as existing user (direct join)
- Test expired invitation (shows error)
- Test revoked invitation (shows error)
- Verify member appears in workspace

**Test File:** `__tests__/features/workspace/invitations.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**

- Invite team members with appropriate roles
- Re-send invitations if needed
- Revoke invitations if mistakenly sent

**Developer Responsibility:**

- Generate secure invitation tokens
- Send invitation emails
- Handle new vs existing user flows
- Enforce 7-day expiry
- Clean up expired invitations
- Prevent duplicate invitations

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
