# Story 12.2: Design Template Data Model

## Status

Ready for Review

## Story

**As a** developer,
**I want** to create the database schema for law list templates, sections, and items,
**so that** we have a system-level template catalog independent of workspaces.

## Acceptance Criteria

1. `LawListTemplate` model created with fields: `id` (UUID), `name`, `slug` (unique), `description`, `domain`, `target_audience`, `status` (enum: DRAFT, IN_REVIEW, PUBLISHED, ARCHIVED), `version` (integer), `document_count`, `section_count`, `primary_regulatory_bodies` (string[]), `parent_template_id` (nullable UUID), `is_variant` (boolean), `variant_filter_field` (nullable string), `metadata` (JSONB), `created_by` (FK to User), `published_at`, timestamps
2. `TemplateSection` model created with fields: `id` (UUID), `template_id` (FK), `section_number` (string "01"-"09"), `name`, `description`, `position` (float), `item_count` (integer), timestamps. Unique constraint on `(template_id, section_number)`
3. `TemplateItem` model created with fields: `id` (UUID), `template_id` (FK), `section_id` (FK), `document_id` (FK to LegalDocument), `index` (SSDD string), `position` (float), `compliance_summary` (text), `expert_commentary` (text), `source_type`, `regulatory_body`, `last_amendment` (nullable), `replaces_old_reference` (nullable), `is_service_company_relevant` (boolean), `variant_section_override` (nullable), `cross_list_references` (string[]), `content_status` (enum: STUB, AI_GENERATED, HUMAN_REVIEWED, APPROVED), `generated_by` (nullable), `reviewed_by` (nullable FK), `reviewed_at` (nullable), timestamps. Unique constraint on `(template_id, document_id)`
4. Prisma migration generated and applied
5. TypeScript types generated for all models
6. Database indexes created for: `LawListTemplate`: `slug`, `status`, `domain`; `TemplateSection`: `(template_id, position)`; `TemplateItem`: `(template_id, section_id, position)`, `document_id`, `content_status`

## Tasks / Subtasks

- [x] **Task 1: Define enums** (AC: 1, 3)
  - [x] Add `TemplateStatus` enum after existing enums (~line 498): `DRAFT`, `IN_REVIEW`, `PUBLISHED`, `ARCHIVED`
  - [x] Add `TemplateItemContentStatus` enum: `STUB`, `AI_GENERATED`, `HUMAN_REVIEWED`, `APPROVED`
  - [x] Use `@@map` if needed for table name consistency (enums don't need `@@map`)
- [x] **Task 2: Create LawListTemplate model** (AC: 1)
  - [x] Define all fields per AC 1 — see Dev Notes for exact field definitions
  - [x] Add self-referential `parent_template_id` relation for variant support (nullable FK to self)
  - [x] Add `created_by` FK to User model
  - [x] Add `children` reverse relation (`LawListTemplate[]`) for parent → variants query
  - [x] Add `sections` reverse relation (`TemplateSection[]`)
  - [x] Add `items` reverse relation (`TemplateItem[]`)
  - [x] Add `@@map("law_list_templates")`
- [x] **Task 3: Create TemplateSection model** (AC: 2)
  - [x] Define all fields per AC 2 — see Dev Notes
  - [x] Add `@@unique([template_id, section_number])`
  - [x] Add FK relation to `LawListTemplate` with `onDelete: Cascade`
  - [x] Add `items` reverse relation (`TemplateItem[]`)
  - [x] Add `@@map("template_sections")`
- [x] **Task 4: Create TemplateItem model** (AC: 3)
  - [x] Define all fields per AC 3 — see Dev Notes for exact field definitions
  - [x] Add `@@unique([template_id, document_id])`
  - [x] Add FK relations: template (`onDelete: Cascade`), section (`onDelete: Cascade`), document, reviewer (User)
  - [x] Add `@@map("template_items")`
- [x] **Task 5: Update existing models with reverse relations** (AC: 1, 3)
  - [x] Add `created_templates LawListTemplate[] @relation("TemplateCreator")` to User model (~line 20)
  - [x] Add `reviewed_items TemplateItem[] @relation("TemplateItemReviewer")` to User model
  - [x] Add `template_items TemplateItem[]` to LegalDocument model (~line 276)
- [x] **Task 6: Add indexes** (AC: 6)
  - [x] `LawListTemplate`: `@@index([slug])`, `@@index([status])`, `@@index([domain])`
  - [x] `TemplateSection`: `@@index([template_id, position])`
  - [x] `TemplateItem`: `@@index([template_id, section_id, position])`, `@@index([document_id])`, `@@index([content_status])`
- [x] **Task 7: Generate and apply migration** (AC: 4, 5)
  - [x] Run `pnpm prisma db push` (see Dev Notes — shadow DB issue prevents `migrate dev`)
  - [x] Run `pnpm prisma generate` to regenerate TypeScript types
  - [x] Verify TypeScript types include `LawListTemplate`, `TemplateSection`, `TemplateItem`, `TemplateStatus`, `TemplateItemContentStatus`
  - [x] Verify `tsc --noEmit` passes cleanly
- [x] **Task 8: Write tests** (AC: all)
  - [x] Unit test: Verify model types are generated and accessible from `@prisma/client`
  - [x] Unit test: Verify enum values for `TemplateStatus` and `TemplateItemContentStatus`
  - [x] Unit test: Verify index definitions (if using Prisma introspection helpers)
  - [x] Note: Full CRUD/constraint integration tests deferred to stories 12.4+ which seed actual data

## Dev Notes

### Previous Story Context (Story 12.1)

Story 12.1 is complete (commit `b8210d1`). Key learnings relevant to 12.2:

- **Migration approach**: Used `pnpm prisma db push` instead of `prisma migrate dev` because the shadow database cannot replay historical migrations referencing a dropped `_LawInWorkspaceTags` table. **Use `db push` for 12.2 as well.**
- **Enum additions**: When adding Prisma enums, any code using exhaustive `Record<EnumType, ...>` maps will fail to compile. This story only adds `TemplateStatus` and `TemplateItemContentStatus` enums — these are new types not yet used in any existing Records, so no existing code needs updating.
- **Relations on User model**: User model (~line 20) already has many relations. New relations must use named `@relation()` to avoid ambiguity (e.g., `@relation("TemplateCreator")`, `@relation("TemplateItemReviewer")`).

### Architecture Decision: System-Level, Not Workspace-Scoped

Templates live outside the workspace multi-tenancy model (see Epic 12 Decision 1). They are created by admins, published globally, and "adopted" by workspaces. This is fundamentally different from `LawList` which is workspace-scoped. [Source: docs/epics/epic-12-law-list-templates.md#Decision 1]

### Variant Architecture (Decision 2)

The `is_variant` + `parent_template_id` + `variant_filter_field` fields enable the Arbetsmiljö för Tjänsteföretag pattern: [Source: docs/epics/epic-12-law-list-templates.md#Decision 2]
- A variant template has `is_variant = true` and `parent_template_id` set
- It contains **no TemplateItem records** — items are queried from the parent at runtime
- It has its own `TemplateSection` records defining the re-numbered section structure
- `variant_filter_field` = `"is_service_company_relevant"` tells the query which boolean to filter on

### Prisma Schema — Exact Location and Conventions

**File:** `prisma/schema.prisma` [Source: prisma/schema.prisma]

**Where to add new models:** After the existing `ActivityLog` model (last model ends around line 1120). Add enums in the enums section (~line 498, after `NotificationType`).

**Naming conventions to follow** (match existing patterns in the schema):
- Field names: `snake_case` (e.g., `parent_template_id`, `section_number`, `content_status`)
- IDs: `String @id @default(uuid())`
- Timestamps: `created_at DateTime @default(now())`, `updated_at DateTime @updatedAt`
- Table mapping: `@@map("snake_case_plural")` (e.g., `@@map("law_list_templates")`)
- Text fields: `@db.Text` for long text (compliance_summary, expert_commentary, description, target_audience)
- JSON fields: `Json?` for metadata
- String arrays: `String[]` for primary_regulatory_bodies, cross_list_references
- Float for position: `Float` (used in LawListItem for position)
- Nullable FKs: `String?` for optional relations

### LawListTemplate Model — Field Definitions

```prisma
model LawListTemplate {
  id                       String         @id @default(uuid())
  name                     String
  slug                     String         @unique
  description              String?        @db.Text
  domain                   String         // "arbetsmiljo", "miljo", etc.
  target_audience          String?        @db.Text
  status                   TemplateStatus @default(DRAFT)
  version                  Int            @default(1)
  document_count           Int            @default(0)
  section_count            Int            @default(0)
  primary_regulatory_bodies String[]
  parent_template_id       String?
  is_variant               Boolean        @default(false)
  variant_filter_field     String?
  metadata                 Json?
  created_by               String
  published_at             DateTime?
  created_at               DateTime       @default(now())
  updated_at               DateTime       @updatedAt

  // Relations
  creator     User               @relation("TemplateCreator", fields: [created_by], references: [id])
  parent      LawListTemplate?   @relation("TemplateVariant", fields: [parent_template_id], references: [id])
  children    LawListTemplate[]  @relation("TemplateVariant")
  sections    TemplateSection[]
  items       TemplateItem[]

  @@index([slug])
  @@index([status])
  @@index([domain])
  @@map("law_list_templates")
}
```

### TemplateSection Model — Field Definitions

```prisma
model TemplateSection {
  id              String          @id @default(uuid())
  template_id     String
  section_number  String          // "01", "02", ..., "09"
  name            String
  description     String?         @db.Text
  position        Float           @default(0)
  item_count      Int             @default(0)
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt

  // Relations
  template  LawListTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)
  items     TemplateItem[]

  @@unique([template_id, section_number])
  @@index([template_id, position])
  @@map("template_sections")
}
```

### TemplateItem Model — Field Definitions

```prisma
model TemplateItem {
  id                          String                    @id @default(uuid())
  template_id                 String
  section_id                  String
  document_id                 String
  index                       String                    // SSDD format: "0100", "0210"
  position                    Float                     @default(0)
  compliance_summary          String?                   @db.Text
  expert_commentary           String?                   @db.Text
  source_type                 String?                   // "lag", "forordning", "foreskrift", etc.
  regulatory_body             String?                   // "Arbetsmiljöverket", "Boverket", etc.
  last_amendment              String?                   // "SFS 2025:732"
  replaces_old_reference      String?                   // "ersätter AFS 2001:1"
  is_service_company_relevant Boolean                   @default(true)
  variant_section_override    String?                   // Alternative section for variant views
  cross_list_references       String[]                  // Template slugs where this doc also appears
  content_status              TemplateItemContentStatus @default(STUB)
  generated_by                String?                   // "gpt-4o", "human", etc.
  reviewed_by                 String?
  reviewed_at                 DateTime?
  created_at                  DateTime                  @default(now())
  updated_at                  DateTime                  @updatedAt

  // Relations
  template  LawListTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)
  section   TemplateSection @relation(fields: [section_id], references: [id], onDelete: Cascade)
  document  LegalDocument   @relation(fields: [document_id], references: [id])
  reviewer  User?           @relation("TemplateItemReviewer", fields: [reviewed_by], references: [id])

  @@unique([template_id, document_id])
  @@index([template_id, section_id, position])
  @@index([document_id])
  @@index([content_status])
  @@map("template_items")
}
```

### Relations to Update on Existing Models

**User model** (line 20) — add these two relations anywhere in the relations block:
```prisma
created_templates    LawListTemplate[] @relation("TemplateCreator")
reviewed_items       TemplateItem[]    @relation("TemplateItemReviewer")
```

**LegalDocument model** (line 276) — add this relation:
```prisma
template_items       TemplateItem[]
```

### Denormalized Counts

`document_count` and `section_count` on `LawListTemplate`, and `item_count` on `TemplateSection` are denormalized for catalog display performance. They should be updated when items/sections are added or removed (via application logic in Stories 12.4-12.6, not DB triggers). [Source: docs/epics/epic-12-law-list-templates.md#Story 12.2]

### Relevant Source Tree

```
prisma/schema.prisma              # Add models here (~line 1120+), enums (~line 498+)
prisma/migrations/                # Not used — using db push (see Previous Story Context)
lib/db/queries/                   # Future query helpers (Stories 12.4+)
tests/unit/prisma/                # Test location for schema tests
```

### Technical Constraints

- **TypeScript:** 5.5+ strict mode [Source: docs/architecture/17-coding-standards.md#17.2]
- **ORM:** Prisma 5.x with type-safe queries [Source: docs/architecture/3-tech-stack.md]
- **Database:** PostgreSQL 15+ via Supabase [Source: docs/architecture/9-database-schema.md#9.1]
- **Package manager:** pnpm [Source: docs/architecture/3-tech-stack.md]
- **Migration:** Use `pnpm prisma db push` (NOT `prisma migrate dev`) — shadow DB issue documented in Story 12.1

### Testing

- **Test framework:** Vitest 1.4+ [Source: docs/architecture/3-tech-stack.md]
- **Test location:** `tests/unit/prisma/` for schema-level tests
- **Test standards from architecture:** [Source: docs/architecture/17-coding-standards.md#17.4]
  - TypeScript strict mode in tests
  - Co-locate test helpers with test files
- **Specific tests needed:**
  - Verify Prisma client exports the new model types (`LawListTemplate`, `TemplateSection`, `TemplateItem`)
  - Verify `TemplateStatus` enum has correct values (`DRAFT`, `IN_REVIEW`, `PUBLISHED`, `ARCHIVED`)
  - Verify `TemplateItemContentStatus` enum has correct values (`STUB`, `AI_GENERATED`, `HUMAN_REVIEWED`, `APPROVED`)
  - Integration tests for CRUD, unique constraints, and cascade deletes are deferred to Stories 12.4-12.6 which will seed actual template data
- **Note:** This is a pure data model story. The bulk of testing happens when the models are actually used to seed data (Story 12.4+). Schema-level unit tests confirm type generation succeeded.

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-06 | 2.0     | SM enrichment: full field definitions from architecture, db push guidance, relations map, variant architecture notes | Bob (SM) |
| 2026-02-06 | 2.1     | PO validation: GO — readiness 9/10, high confidence, 0 blocking issues. Story approved for implementation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `prisma/schema.prisma` | Modified | Added TemplateStatus + TemplateItemContentStatus enums, LawListTemplate, TemplateSection, TemplateItem models with all relations/indexes, updated User and LegalDocument with reverse relations |
| `tests/unit/prisma/template-models.test.ts` | Created | 10 unit tests verifying enum values, model type exports, and scalar field enums for all 3 new models |

### Debug Log References
No issues encountered.

### Completion Notes
- All 8 tasks completed successfully
- `pnpm prisma db push` applied schema to Supabase PostgreSQL (no migration files — shadow DB limitation documented in Story 12.1)
- `pnpm prisma generate` regenerated TypeScript client with all new types
- `tsc --noEmit` passes with zero errors
- 10/10 new unit tests pass
- 85 unit test files (1205 tests) pass — zero regressions
- 0 lint errors (23 pre-existing warnings)
- 14 pre-existing integration test failures (FK constraint issues on live DB) — unrelated to this story

### Change Log
| Date | Change | Author |
|------|--------|--------|
| 2026-02-06 | Implemented all 8 tasks: enums, 3 models, reverse relations, indexes, db push, tests | James (Dev) |

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. Schema matches the story spec field-for-field with zero deviations. All naming conventions (snake_case fields, `@@map`, UUID IDs, `@db.Text` for long text, `Float` for position, named `@relation()` for ambiguous FKs) follow existing patterns in the schema perfectly. Enum placement, model placement, and section headers are clean and consistent. Self-referential variant relation and cascade deletes are correctly configured.

### Refactoring Performed

None required. Implementation is clean.

### Compliance Check

- Coding Standards: ✓ — snake_case fields, strict TypeScript, proper Prisma conventions
- Project Structure: ✓ — Models in `prisma/schema.prisma`, tests in `tests/unit/prisma/`
- Testing Strategy: ✓ — Unit tests verify type generation; CRUD/integration deferred to 12.4+ per spec
- All ACs Met: ✓ — All 6 acceptance criteria verified field-by-field (see traceability below)

### Requirements Traceability

| AC | Requirement | Status | Verification |
|----|-------------|--------|--------------|
| 1 | LawListTemplate — 19 fields, self-ref FK, User FK, reverse relations, @@map | ✓ | All 19 scalar fields verified via ScalarFieldEnum test; relations confirmed in schema read |
| 2 | TemplateSection — 9 fields, unique constraint, cascade FK, @@map | ✓ | All 9 fields verified; `@@unique([template_id, section_number])` present; `onDelete: Cascade` confirmed |
| 3 | TemplateItem — 21 fields, unique constraint, 4 FK relations, @@map | ✓ | All 21 fields verified; `@@unique([template_id, document_id])` present; all 4 relations with correct cascade/no-cascade |
| 4 | Prisma migration generated and applied | ✓ | `db push` succeeded against Supabase; no migration files (documented shadow DB limitation) |
| 5 | TypeScript types generated | ✓ | `prisma generate` succeeded; `tsc --noEmit` passes; tests import types from `@prisma/client` |
| 6 | Database indexes | ✓ | 3 on LawListTemplate, 1 on TemplateSection, 3 on TemplateItem — all match spec exactly |

### Improvements Checklist

- [x] All fields match AC spec exactly (verified field-by-field)
- [x] All indexes match AC6 spec exactly
- [x] Named relations avoid Prisma ambiguity errors
- [x] Cascade deletes on template children (sections, items) — correct
- [x] No cascade on LegalDocument FK — correct (prevents accidental data loss)
- [x] Reverse relations added to User and LegalDocument
- [x] Tests verify enum counts (guards against silent additions/removals)
- [x] Tests verify all scalar fields via ScalarFieldEnum

### Security Review

No security concerns. This is a pure data model story with no runtime code, no API endpoints, no auth changes, and no user input handling.

### Performance Considerations

No concerns. All indexes specified in AC6 are present. One minor observation: `@@index([slug])` on LawListTemplate is technically redundant since `@unique` already creates an index — but this is harmless, matches the story spec explicitly, and follows the project's existing pattern of explicit indexes.

### Files Modified During Review

None — no refactoring needed.

### Gate Status

Gate: **PASS** → `docs/qa/gates/12.2-template-data-model.yml`

### Recommended Status

✓ Ready for Done
