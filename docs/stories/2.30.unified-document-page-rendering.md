# Story 2.30: Unified Document Page Rendering

## Status

Draft

## Story

**As a** user browsing any legal document (law, amendment, regulation, EU directive, or court case),
**I want** all document pages to render with the same visual structure, styling, and navigation,
**so that** I get a consistent, high-quality reading experience regardless of document type — and the team can ingest new content types by simply providing well-structured HTML.

## Acceptance Criteria

1. A shared `<DocumentContent>` component exists that accepts `htmlContent` (+ optional `fallbackText`) and renders it inside `<article className="legal-document">` with automatic table wrapping, link rewriting (via `isWorkspace` prop), and `StickyDocNav` — replacing `LegalDocumentCard`, `LawSectionWithBanner`, `HtmlContentRenderer`, and `ContentWithStyledHeadings`
2. A shared `<DocumentPageLayout>` component wraps all document pages with consistent `has-hero-header`, `max-w-4xl`, spacing, and footer — accepting `isWorkspace` to toggle breadcrumbs/container style
3. A shared `<DocumentHero>` component renders the themed header card (icon, title, badges, quick info bar) driven by `contentType`, replacing the 5 duplicated hero implementations
4. All 10 page files (5 types × public/workspace) use the shared components, eliminating layout duplication
5. `StickyDocNav` (TOC sidebar with search and scrollspy) works on **all** 5 document types, including court cases which currently lack it
6. The modal rendering path (`LagtextSection` in document list) is **not affected** — it continues using its own lightweight `legal-document-modal` wrapper
7. Visual output on the three gold-standard pages matches current rendering exactly: SFS 1977:1160 (public), AFS 2023:13 kap. 4 (workspace), GDPR 32016R0679 (workspace)
8. All existing tests pass, `npx tsc --noEmit` clean

## Tasks / Subtasks

- [ ] Task 1: Extract `<DocumentContent>` component (AC: 1, 5, 6)
  - [ ] Create `components/features/document-content.tsx` as client component
  - [ ] Accept props: `htmlContent`, `fallbackText`, `isWorkspace`, `className`
  - [ ] Render `<article className="legal-document" ref={articleRef}>` with `dangerouslySetInnerHTML`
  - [ ] Port table-wrapping `useEffect` from `LegalDocumentCard`
  - [ ] Port link rewriting: apply `rewriteLinksForWorkspace()` internally when `isWorkspace=true`
  - [ ] Render `<StickyDocNav containerRef={articleRef} />` after the article
  - [ ] Fallback: render `<pre className="whitespace-pre-wrap ...">` when no `htmlContent`
- [ ] Task 2: Extract `<DocumentHero>` component (AC: 3)
  - [ ] Create `components/features/document-hero.tsx`
  - [ ] Accept props: `title`, `documentNumber`, `contentType`, `effectiveDate`, `publicationDate`, `sourceUrl`, `extraBadges`, `quickInfoItems`, `actionLinks`
  - [ ] Derive theme icon/colors via existing `getDocumentTheme(contentType)`
  - [ ] Render: rounded card, icon, title, badge row, separator, quick info bar — matching the gold-standard layout
- [ ] Task 3: Extract `<DocumentPageLayout>` wrapper (AC: 2, 4)
  - [ ] Create `components/features/document-page-layout.tsx`
  - [ ] Accept props: `isWorkspace`, `children`, `breadcrumbs` (optional ReactNode), `footer` (optional ReactNode)
  - [ ] Render `has-hero-header mx-auto max-w-4xl` wrapper with correct spacing
  - [ ] Public: `<main>` with gradient background, breadcrumbs slot before children
  - [ ] Workspace: `<div>` without breadcrumbs, no gradient
- [ ] Task 4: Migrate SFS Law pages (AC: 4, 7)
  - [ ] Refactor `app/(public)/lagar/[id]/page.tsx` to use `DocumentPageLayout` + `DocumentHero` + `DocumentContent`
  - [ ] Refactor `app/(workspace)/browse/lagar/[id]/page.tsx` to use same components
  - [ ] Move `LawContentWrapper` to shared location (`components/features/`) since modal depends on it
  - [ ] Verify SFS 1977:1160 renders identically
- [ ] Task 5: Migrate Foreskrifter pages (AC: 4, 7)
  - [ ] Refactor public and workspace foreskrifter pages
  - [ ] Remove `LegalDocumentCard` usage (replaced by `DocumentContent`)
  - [ ] Verify AFS 2023:13 kap. 4 renders identically
- [ ] Task 6: Migrate EU document pages (AC: 4, 7)
  - [ ] Refactor public and workspace EU pages
  - [ ] Verify GDPR 32016R0679 renders identically
- [ ] Task 7: Migrate Court case pages (AC: 4, 5)
  - [ ] Refactor public and workspace rattsfall pages
  - [ ] Replace `ContentWithStyledHeadings` with `DocumentContent`
  - [ ] Verify StickyDocNav activates (headings may need `id`/`name` attributes — investigate)
- [ ] Task 8: Migrate Amendment pages (AC: 4)
  - [ ] Refactor `AmendmentPageContent` to use `DocumentPageLayout` + `DocumentHero` + `DocumentContent`
  - [ ] Keep fallback rendering path for amendments without `html_content`
- [ ] Task 9: Cleanup and validation (AC: 6, 8)
  - [ ] Delete `LegalDocumentCard` if no longer referenced (modal uses its own path)
  - [ ] Delete `ContentWithStyledHeadings` if fully replaced
  - [ ] Run `npx tsc --noEmit` — clean
  - [ ] Run full test suite — all pass
  - [ ] Verify modal rendering in document list is unaffected

## Dev Notes

### Existing System Integration

**Source Tree — Key Files:**

| Current File | Role | Fate |
|---|---|---|
| `components/features/legal-document-card.tsx` | Renders foreskrifter/EU content + StickyDocNav | **Replaced** by `DocumentContent` |
| `components/features/paragraf-toc.tsx` | StickyDocNav with 4 detection strategies | **Unchanged** — consumed by `DocumentContent` |
| `components/features/amendment/amendment-page-content.tsx` | Amendment rendering (hero + content) | **Refactored** to use shared components |
| `app/(public)/lagar/[id]/law-section-with-banner.tsx` | Law content + future amendments banner | **Refactored** — banner logic preserved, content via `DocumentContent` |
| `app/(public)/lagar/[id]/law-content-wrapper.tsx` | Renders law HTML with highlights | **Moved** to `components/features/` (modal depends on it) |
| `lib/sfs/clean-law-html.ts` | Sanitizes Riksdagen HTML | **Unchanged** — called before passing to `DocumentContent` |
| `lib/document-themes.ts` | `getDocumentTheme()` returns icon/colors per content_type | **Unchanged** — consumed by `DocumentHero` |
| `lib/workspace/rewrite-links.ts` | `rewriteLinksForWorkspace()` rewrites hrefs for `/browse/` | **Unchanged** — called inside `DocumentContent` |

**Gold-Standard Reference Pages (visual acceptance benchmark):**

- SFS 1977:1160 — `/lagar/sfs-1977-1160` (public)
- AFS 2023:13 kap. 4 — `/browse/foreskrifter/afs-2023-13-kap-4-berg-och-gruvarbete` (workspace)
- GDPR 32016R0679 — `/browse/eu/forordning/32016R0679` (workspace)

**StickyDocNav 4 Detection Strategies (do not modify):**

- Strategy 0: `section.kapitel` + nested `h3[id]` (AFS chapter-based)
- Strategy 1: `h3[id/name]` + `h4[id/name]` hierarchy (SFS laws, amendments)
- Strategy 2: Flat `h4[id/name]` only (small documents)
- Strategy 3: `a.paragraf` anchors (SFS laws without chapter structure)

**Critical: Modal isolation.** `LagtextSection` (`components/features/document-list/legal-document-modal/lagtext-section.tsx`) renders content inside `<article className="legal-document-modal"><div className="legal-document">` with `LawContentWrapper`. This path must NOT be changed — it uses compact CSS overrides (`.legal-document-modal .legal-document`) and has no StickyDocNav. It imports `LawContentWrapper` from `app/(public)/lagar/[id]/law-content-wrapper.tsx` — when that file moves to `components/features/`, update this import.

**Court case TOC gap.** Court cases currently use `ContentWithStyledHeadings` which applies inline styles to headings. The HTML likely has `<h2>` and `<h3>` but without `id`/`name` attributes. Investigate whether court case HTML has anchors — if not, StickyDocNav won't activate (which is acceptable for now; adding IDs to court case HTML is a separate ingestion concern).

**CSS is already unified.** All document types now use `.legal-document` class in `globals.css`. Amendment-specific rules (section.ann, h3.paragraph, footnotes, in-force provisions) were consolidated into the `.legal-document` block earlier in this session. No CSS changes needed.

**Link rewriting pattern.** Currently each workspace page calls `rewriteLinksForWorkspace(htmlContent)` before passing to the renderer. `DocumentContent` should internalize this: accept `isWorkspace` prop and apply rewriting in a `useMemo` before rendering.

### Testing

**Test file locations:**

- `tests/unit/components/features/paragraf-toc.test.tsx` — StickyDocNav tests (must pass unchanged)
- `tests/unit/lib/sfs/` — HTML cleaning, amendment parsing tests
- `tests/unit/lib/transforms/` — HTML transform tests

**Testing standards:**

- Framework: Vitest + React Testing Library
- Run: `npx vitest run` for full suite, `npx vitest run tests/unit/components/` for component tests
- Type check: `npx tsc --noEmit`
- No new test files required for this story (it's a refactoring — existing tests validate behavior is preserved)
- If any component props change in a way that breaks existing tests, update those tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-13 | 1.0 | Initial draft — created from architectural analysis session | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

_To be filled during implementation_

## QA Results

_To be filled after implementation review_
