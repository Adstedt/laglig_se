# Story 2.2a: Backfill HTML Content for SFS Laws

## Status

Draft

## Story

**As a** frontend developer,
**I want** HTML versions of SFS laws stored alongside plain text,
**so that** I can render properly formatted legal documents with preserved structure and styling.

## Background

Story 2.2 ingests SFS laws as plain text (converted from HTML). While plain text is perfect for RAG, search, and embeddings, rendering law detail pages requires the original HTML formatting to preserve:

- Chapter and section structure
- Bold/italic legal emphasis
- Tables and lists
- Original Riksdagen formatting

## Acceptance Criteria

1. Database schema updated with nullable `html_content` field
2. Migration runs successfully without data loss
3. Backfill script created: `scripts/backfill-html-content.ts`
4. Script fetches HTML for all 11,365 SFS laws from Riksdagen API
5. HTML stored in `html_content` field (unsanitized - sanitize on render)
6. Rate limiting: 5 requests/second (same as Story 2.2)
7. Script completes in ~2 hours
8. Error handling: Retry 3x, log failures, continue processing
9. Progress logging: "Processed 5,000/11,365 laws (44%)"
10. Verification: Database contains HTML for >99% of laws
11. HTML content validates (contains expected structure)
12. Tests verify HTML sanitization on frontend render

## Tasks / Subtasks

- [ ] **Task 1: Update Database Schema**
  - [ ] Add `html_content` field to `LegalDocument` model (nullable, @db.Text)
  - [ ] Create migration: `prisma migrate dev --name add-html-content`
  - [ ] Run migration against dev database
  - [ ] Verify schema change: `pnpm prisma studio`

- [ ] **Task 2: Create Backfill Script**
  - [ ] Create `scripts/backfill-html-content.ts`
  - [ ] Import Riksdagen API client (`fetchLawFullText`)
  - [ ] Query all laws: `SELECT id, metadata->>'dokId' FROM legal_documents WHERE content_type = 'SFS_LAW'`
  - [ ] Fetch HTML for each law (with rate limiting)
  - [ ] Store **original HTML** (before `extractLawContent` cleanup)
  - [ ] Add progress logging every 100 laws
  - [ ] Add error handling with retry logic
  - [ ] Add final summary statistics

- [ ] **Task 3: Modify Riksdagen Client**
  - [ ] Update `lib/external/riksdagen.ts`
  - [ ] Create new function: `fetchLawFullTextAsHTML(dokId: string): Promise<string | null>`
  - [ ] Returns raw HTML (before cleanup)
  - [ ] Keep existing `fetchLawFullText` for plain text (backward compatible)

- [ ] **Task 4: Add Frontend Sanitization**
  - [ ] Install DOMPurify: `pnpm add dompurify isomorphic-dompurify`
  - [ ] Install types: `pnpm add -D @types/dompurify`
  - [ ] Create utility: `lib/utils/sanitize-html.ts`
  - [ ] Export `sanitizeHTML(html: string): string` function
  - [ ] Configure DOMPurify for legal content (allow `<b>`, `<i>`, `<h1-6>`, etc.)
  - [ ] Test with sample SFS HTML

- [ ] **Task 5: Run Backfill Script**
  - [ ] Execute: `pnpm tsx scripts/backfill-html-content.ts`
  - [ ] Monitor progress (expected: ~2 hours)
  - [ ] Verify completion: Check logs for errors
  - [ ] Spot check 10 random laws in Prisma Studio

- [ ] **Task 6: Create Tests**
  - [ ] Test file: `tests/integration/ingestion/html-backfill.test.ts`
  - [ ] Test: Verify HTML sanitization removes dangerous tags
  - [ ] Test: Verify HTML preserves legal formatting tags
  - [ ] Test: Query law with HTML content
  - [ ] Test: Render sanitized HTML (snapshot test)

- [ ] **Task 7: Update Documentation**
  - [ ] Update `docs/database-setup.md` with new field
  - [ ] Document HTML vs plain text usage patterns
  - [ ] Add example: "When to use html_content vs full_text"

## Dev Notes

### Rationale for Storing Both Formats

**Plain Text (`full_text`):**

- RAG/embedding generation
- Full-text search
- Amendment parsing
- GPT-4 processing

**HTML (`html_content`):**

- Law detail page rendering
- Preserves legal document structure
- Better user experience
- Competitive parity with Notisum/Lagen.nu

### Storage Impact

- Plain text: ~113MB (11,351 laws)
- HTML: ~200-300MB additional
- Total: ~400MB (well within Supabase 500MB free tier)

### Implementation Strategy

**Fetch Original HTML (Not Cleaned Text):**

```typescript
// lib/external/riksdagen.ts

// NEW: Fetch raw HTML
export async function fetchLawFullTextAsHTML(
  dokId: string
): Promise<string | null> {
  const url = `${RIKSDAGEN_BASE_URL}/dokument/${dokId}.html`

  try {
    const response = await fetchWithRetry(url, {
      headers: { Accept: 'text/html' },
    })

    const html = await response.text()

    // Extract body content but DON'T strip HTML tags
    const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i)
    return bodyMatch?.[1] || html
  } catch (error) {
    console.error(`Failed to fetch HTML for ${dokId}:`, error)
    return null
  }
}

// EXISTING: Keep for plain text
export async function fetchLawFullText(dokId: string): Promise<string | null> {
  // ... existing implementation ...
}
```

**Backfill Script Pattern:**

```typescript
// scripts/backfill-html-content.ts

import { prisma } from '../lib/prisma'
import { fetchLawFullTextAsHTML } from '../lib/external/riksdagen'

async function backfillHTMLContent() {
  console.log('Starting HTML content backfill...')

  const laws = await prisma.legalDocument.findMany({
    where: {
      content_type: 'SFS_LAW',
      html_content: null, // Only backfill missing HTML
    },
    select: {
      id: true,
      document_number: true,
      metadata: true,
    },
  })

  console.log(`Found ${laws.length} laws without HTML content`)

  let processed = 0
  let succeeded = 0
  let failed = 0

  for (const law of laws) {
    try {
      const dokId = (law.metadata as any)?.dokId
      if (!dokId) {
        console.warn(`âš ï¸  No dokId for ${law.document_number}`)
        failed++
        continue
      }

      const html = await fetchLawFullTextAsHTML(dokId)

      if (html) {
        await prisma.legalDocument.update({
          where: { id: law.id },
          data: { html_content: html },
        })
        succeeded++
      } else {
        failed++
      }

      processed++

      if (processed % 100 === 0) {
        const percent = Math.round((processed / laws.length) * 100)
        console.log(
          `ðŸ“ˆ Progress: ${processed}/${laws.length} (${percent}%) | Success: ${succeeded} | Failed: ${failed}`
        )
      }

      // Rate limiting: 200ms between requests (5 req/sec)
      await new Promise((resolve) => setTimeout(resolve, 200))
    } catch (error) {
      failed++
      console.error(`âŒ Error processing ${law.document_number}:`, error)
    }
  }

  console.log(`\nâœ… Backfill complete!`)
  console.log(`   Processed: ${processed}`)
  console.log(`   Succeeded: ${succeeded}`)
  console.log(`   Failed: ${failed}`)
}

backfillHTMLContent()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
```

**Frontend Sanitization:**

```typescript
// lib/utils/sanitize-html.ts

import DOMPurify from 'isomorphic-dompurify'

export function sanitizeHTML(html: string): string {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: [
      'h1',
      'h2',
      'h3',
      'h4',
      'h5',
      'h6',
      'p',
      'div',
      'span',
      'br',
      'b',
      'strong',
      'i',
      'em',
      'u',
      'ul',
      'ol',
      'li',
      'table',
      'thead',
      'tbody',
      'tr',
      'th',
      'td',
      'a',
    ],
    ALLOWED_ATTR: ['href', 'class', 'id'],
    ALLOW_DATA_ATTR: false,
  })
}
```

**Usage in Components:**

```tsx
// app/laws/[slug]/page.tsx

import { sanitizeHTML } from '@/lib/utils/sanitize-html'

export default function LawDetailPage({ law }: { law: LegalDocument }) {
  return (
    <article>
      <h1>{law.title}</h1>

      {law.html_content ? (
        <div
          className="law-content"
          dangerouslySetInnerHTML={{
            __html: sanitizeHTML(law.html_content),
          }}
        />
      ) : (
        <pre className="law-content-plain">{law.full_text}</pre>
      )}
    </article>
  )
}
```

### Database Migration

```prisma
// prisma/schema.prisma

model LegalDocument {
  id                String           @id @default(cuid())
  content_type      ContentType
  document_number   String           @unique
  title             String
  slug              String           @unique
  summary           String?          @db.Text
  full_text         String           @db.Text      // Plain text (for RAG, search)
  html_content      String?          @db.Text      // NEW: HTML (for rendering)
  effective_date    DateTime?
  publication_date  DateTime?
  status            DocumentStatus   @default(ACTIVE)
  source_url        String?
  metadata          Json?
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt

  @@index([content_type])
  @@index([status])
  @@map("legal_documents")
}
```

### Testing Strategy

```typescript
// tests/integration/ingestion/html-backfill.test.ts

import { describe, it, expect } from 'vitest'
import { sanitizeHTML } from '@/lib/utils/sanitize-html'

describe('HTML Content', () => {
  it('sanitizes dangerous tags', () => {
    const dangerous = '<script>alert("xss")</script><p>Safe content</p>'
    const sanitized = sanitizeHTML(dangerous)

    expect(sanitized).not.toContain('<script>')
    expect(sanitized).toContain('<p>Safe content</p>')
  })

  it('preserves legal formatting tags', () => {
    const legal = '<h2>1 kap.</h2><p><b>1 Â§</b> Text here.</p>'
    const sanitized = sanitizeHTML(legal)

    expect(sanitized).toContain('<h2>')
    expect(sanitized).toContain('<b>')
    expect(sanitized).toContain('<p>')
  })

  it('queries law with HTML content', async () => {
    const law = await prisma.legalDocument.findFirst({
      where: {
        content_type: 'SFS_LAW',
        html_content: { not: null },
      },
    })

    expect(law).toBeDefined()
    expect(law?.html_content).toBeTruthy()
    expect(law?.html_content).toContain('<')
  })
})
```

## Dependencies

- **Blocks:** Story 2.8 (Cross-Document Navigation) - Needs HTML for better rendering
- **Blocked by:** Story 2.2 (Ingest SFS Laws) - Must complete first

## Estimated Effort

- **Development:** 2-3 hours
- **Script execution:** 2 hours
- **Testing:** 1 hour
- **Total:** 5-6 hours

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-11-27 | 1.0     | Initial story creation | James (Dev) |
