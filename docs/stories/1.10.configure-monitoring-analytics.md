# Story 1.10: Configure Monitoring and Analytics (Vercel Analytics)

## Status

Ready for Review

## Story

**As a** product owner,
**I want** to track page views and Core Web Vitals,
**so that** I can measure SEO performance and engagement.

## Acceptance Criteria

1. Vercel Analytics enabled
2. Analytics tracking code added to app/layout.tsx
3. Dashboard shows: page views, unique visitors, top pages
4. Core Web Vitals tracked: LCP, FID, CLS, TTFB
5. Analytics data accessible in Vercel dashboard
6. No GDPR issues (Vercel Analytics is cookieless)

## Tasks / Subtasks

- [x] **Task 1: Enable Vercel Analytics in Dashboard** (AC: 1)
  - [x] Log into Vercel dashboard (https://vercel.com)
  - [x] Navigate to laglig_se project
  - [x] Click "Analytics" tab in sidebar
  - [x] Enable Analytics if not already enabled
  - [x] Note: Free tier = 25K events/month

- [x] **Task 2: Install Analytics Packages** (AC: 2)
  - [x] Run: `pnpm add @vercel/analytics` (CRITICAL: Use pnpm, NOT npm)
  - [x] Run: `pnpm add @vercel/speed-insights`
  - [x] Verify both packages added to package.json

- [x] **Task 3: Add Components to Root Layout** (AC: 2)
  - [x] Open `app/layout.tsx`
  - [x] Import `Analytics` from `@vercel/analytics/react`
  - [x] Import `SpeedInsights` from `@vercel/speed-insights/next`
  - [x] Add `<Analytics />` at end of `<body>` (after `{children}`)
  - [x] Add `<SpeedInsights />` after `<Analytics />`
  - [x] Add comments: GDPR compliance + Core Web Vitals tracking

- [x] **Task 4: Test Locally** (AC: 2)
  - [x] Run `pnpm dev`, navigate to http://localhost:3000
  - [x] Note: Beacons NOT sent in dev (only preview/production)
  - [x] Verify no console errors
  - [x] Run `pnpm build` to verify build succeeds

- [x] **Task 5: Deploy and Verify in Dashboard** (AC: 3, 4, 5)
  - [x] Push to GitHub (triggers Vercel deployment)
  - [x] Visit deployed URL, navigate between pages (/, /#features, /#pricing)
  - [x] Wait 5-10 minutes for data
  - [x] Check Vercel Analytics tab: page views, visitors, top pages
  - [x] Check Speed Insights tab: LCP, FID, CLS, TTFB scores

- [x] **Task 6: Add E2E Tests** (AC: 2)
  - [x] Create `tests/e2e/analytics.spec.ts`
  - [x] Test: Analytics script injected
  - [x] Test: SpeedInsights script injected
  - [x] Test: No console errors
  - [x] Run: `pnpm test:e2e` to verify tests pass

- [x] **Task 7: Document Configuration** (AC: 6)
  - [x] Inline comments in layout.tsx explain GDPR compliance
  - [x] Update Dev Agent Record in this story with completion notes

## Dev Notes

### Previous Story Insights (Story 1.9)

[Source: docs/stories/1.9.create-landing-page-hero.md - Dev Agent Record]

**Key Learnings:**

- Production URL: `https://laglig-8m5u5x0wu-adstedts-projects.vercel.app`
- **Package Manager:** `pnpm` (NOT npm) - all package commands must use pnpm
- Next.js 16.0.4 with App Router (Turbopack enabled)
- Landing page fully implemented with Hero, Features, Risk, Pricing, FAQ, Testimonials
- Recent changes (outside Story 1.9):
  - Hero eyebrow: "För företag som tar compliance på allvar"
  - Enhanced features section
  - New RiskSection with mesh gradients
  - ESLint accessibility fixes

### Vercel Analytics Overview

[Source: docs/architecture/3-tech-stack.md - Row 36, 54]

**Technology:** Vercel Analytics (Built-in)

**Why Vercel Analytics:**

- Zero config (just add component)
- Privacy-friendly (cookieless, GDPR-compliant)
- Core Web Vitals tracking (SEO critical)
- Free tier: 25K events/month
- vs. Google Analytics: No consent banner needed
- vs. Plausible: $9/mo, separate service
- vs. Mixpanel: Overkill, expensive

### Core Web Vitals Thresholds

[Source: docs/architecture/3-tech-stack.md]

| Metric   | Threshold | Importance            |
| -------- | --------- | --------------------- |
| **LCP**  | < 2.5s    | Google ranking factor |
| **FID**  | < 100ms   | Interactivity         |
| **CLS**  | < 0.1     | Visual stability      |
| **TTFB** | < 600ms   | Server response       |

**Why Critical:** Google uses these for SEO ranking (affects 170K+ law pages)

### File Locations

[Source: docs/architecture/12-unified-project-structure.md]

```
laglig_se/
├── app/
│   └── layout.tsx          # UPDATE - Add Analytics here
├── package.json            # ADD dependencies
└── tests/
    └── e2e/
        └── analytics.spec.ts  # NEW
```

### Implementation Code

**Current app/layout.tsx structure:**

- Metadata export with title/description
- Inter font with `swap` display
- HTML with `lang="sv"`
- Body with `{children}` only
- **No analytics yet** ← this story adds them

**Updated app/layout.tsx:**

```typescript
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'
import { Analytics } from '@vercel/analytics/react'
import { SpeedInsights } from '@vercel/speed-insights/next'

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-inter',
})

export const metadata: Metadata = {
  title: {
    default: 'Laglig.se - Svenska lagar och juridisk efterlevnad',
    template: '%s | Laglig.se',
  },
  description: 'Laglig.se hjälper företag att förstå och följa svenska lagar.',
  metadataBase: new URL(process.env.NEXT_PUBLIC_BASE_URL || 'https://laglig.se'),
}

export default function RootLayout({
  children,
}: Readonly<{ children: React.ReactNode }>) {
  return (
    <html lang="sv" className={inter.variable}>
      <body className="min-h-screen bg-white font-sans text-gray-900 antialiased">
        {children}
        {/* Vercel Analytics - Cookieless, GDPR-compliant */}
        <Analytics />
        {/* Speed Insights - Tracks LCP, FID, CLS, TTFB */}
        <SpeedInsights />
      </body>
    </html>
  )
}
```

**How It Works:**

1. `<Analytics />` tracks page views via Beacon API
2. `<SpeedInsights />` tracks Core Web Vitals
3. Scripts only load in production/preview (disabled in dev)
4. Data appears in Vercel dashboard in 5-10 min

### GDPR Compliance

**Why No Issues (AC: 6):**

- Cookieless (Beacon API, no cookies)
- No PII (no IPs, user agents)
- No cross-site tracking
- EU data residency (GDPR Article 44)
- Swedish IMY guidance: Cookieless analytics = legitimate interest, no consent needed

**Legal Basis:** GDPR Article 6.1.f (Legitimate Interest)

### Testing Strategy

**E2E Test (tests/e2e/analytics.spec.ts):**

```typescript
import { test, expect } from '@playwright/test'

test.describe('Analytics', () => {
  test('Analytics script loads', async ({ page }) => {
    await page.goto('/')
    const script = page.locator('script[src*="vercel-analytics"]')
    await expect(script).toBeAttached({ timeout: 5000 })
  })

  test('SpeedInsights script loads', async ({ page }) => {
    await page.goto('/')
    const script = page.locator('script[src*="speed-insights"]')
    await expect(script).toBeAttached({ timeout: 5000 })
  })

  test('No console errors', async ({ page }) => {
    const errors: string[] = []
    page.on('console', (msg) => {
      if (msg.type() === 'error') errors.push(msg.text())
    })
    await page.goto('/')
    await page.click('text=Funktioner')
    const analyticsErrors = errors.filter(
      (e) => e.includes('analytics') || e.includes('vitals')
    )
    expect(analyticsErrors).toHaveLength(0)
  })
})
```

**Manual Testing:**

1. Deploy to Vercel
2. Visit URL, navigate pages
3. Check DevTools → Network for `vitals.vercel-analytics.com`
4. Wait 5-10 min
5. Check Vercel dashboard → Analytics tab
6. Check Speed Insights tab for Core Web Vitals

### Dashboard Access

1. Login: https://vercel.com/
2. Select `laglig_se` project
3. **Analytics tab:** Page views, visitors, top pages, referrers
4. **Speed Insights tab:** LCP/FID/CLS/TTFB scores, trends

## Change Log

| Date       | Version | Description                                                                                                     | Author     |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation                                                                                          | Sarah (PO) |
| 2025-11-27 | 2.0     | Enriched with architecture context, Story 1.9 insights, testing specs, GDPR details, Core Web Vitals thresholds | Bob (SM)   |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Summary

Successfully implemented Vercel Analytics and Speed Insights integration for GDPR-compliant tracking of page views and Core Web Vitals.

### Completion Notes

1. **Analytics Dashboard Enabled**: User enabled Vercel Analytics in dashboard (Free tier: 25K events/month)

2. **Packages Installed**:
   - @vercel/analytics ^1.5.0
   - @vercel/speed-insights ^1.2.0
   - Both added to package.json via `pnpm add`

3. **Root Layout Updated** (app/layout.tsx:4-5, 35-38):
   - Imported Analytics and SpeedInsights components
   - Added components at end of <body> with GDPR and Core Web Vitals comments
   - Cookieless, privacy-friendly tracking (no consent banner needed)

4. **Build Verification**: `pnpm build` completed successfully with no errors

5. **Production Deployment**:
   - Merged feature/landing-page-redesign → main
   - Pushed to GitHub (commit: 9162263)
   - Vercel auto-deployed to production
   - Analytics data confirmed visible in Vercel dashboard

6. **E2E Tests Created** (tests/e2e/analytics.spec.ts):
   - Test: Analytics script loads
   - Test: SpeedInsights script loads
   - Test: No console errors related to analytics

### File List

**Modified:**

- app/layout.tsx
- package.json
- pnpm-lock.yaml
- docs/stories/1.10.configure-monitoring-analytics.md

**Created:**

- tests/e2e/analytics.spec.ts

### Debug Log References

None - implementation completed without issues.

### Blockers/Issues

None

## QA Results

_To be populated by QA agent_
