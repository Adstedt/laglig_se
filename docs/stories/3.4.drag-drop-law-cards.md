# Story 3.4: Implement Drag-and-Drop for Law Cards into Chat

## Status

Draft

## Story

**As a** user,
**I want** to drag law cards from my law list into the chat,
**so that** the AI can answer questions specifically about those laws.

## Acceptance Criteria

1. Law cards made draggable using `@dnd-kit/core`
2. Chat input area is a drop zone
3. Dragging law card into chat creates "context pill" above input
4. Context pill displays: law title, "X" button to remove
5. Backend includes law_id in context for scoped retrieval
6. RAG retrieves chunks ONLY from specified laws
7. Visual feedback: Drop zone highlights on hover, smooth animations
8. Max 10 context items to prevent overload
9. Context persists across chat messages until manually removed
10. Mobile: Tap law card → "Add to chat context" button → pill appears

## Tasks / Subtasks

- [ ] Install drag-and-drop library (AC: 1)
  - [ ] Install: `npm install @dnd-kit/core`
  - [ ] Configure DndContext in layout

- [ ] Make law cards draggable (AC: 1)
  - [ ] Wrap law cards with useDraggable hook
  - [ ] Add drag handle indicator
  - [ ] Pass law data with drag event

- [ ] Create chat drop zone (AC: 2, 7)
  - [ ] Use useDroppable hook on chat input area
  - [ ] Add visual highlight on drag-over
  - [ ] Handle drop event

- [ ] Implement context pills (AC: 3, 4, 8, 9)
  - [ ] Create ContextPill component
  - [ ] Display law title, remove button
  - [ ] Store context in React state
  - [ ] Limit to 10 items max
  - [ ] Persist across messages

- [ ] Update RAG pipeline for scoped search (AC: 5, 6)
  - [ ] Modify API to accept context law_ids
  - [ ] Filter vector search to specific documents
  - [ ] Return only chunks from context laws

- [ ] Add animations (AC: 7)
  - [ ] Drag preview overlay
  - [ ] Drop zone highlight
  - [ ] Pill add/remove animations

- [ ] Implement mobile alternative (AC: 10)
  - [ ] Add "Add to context" button on law cards (mobile only)
  - [ ] Show modal with context pills
  - [ ] Manage context from modal

## Dev Notes

### Drag-and-Drop Implementation

**Why @dnd-kit:** Modern, performant, better TypeScript support than react-beautiful-dnd

**Layout Setup:**

```typescript
// app/workspace/layout.tsx
import { DndContext } from '@dnd-kit/core'

export default function WorkspaceLayout({ children }) {
  function handleDragEnd(event) {
    const { active, over } = event

    if (over?.id === 'chat-drop-zone') {
      const lawData = active.data.current.law
      addToContext(lawData)
    }
  }

  return (
    <DndContext onDragEnd={handleDragEnd}>
      {children}
    </DndContext>
  )
}
```

**Draggable Law Card:**

```typescript
import { useDraggable } from '@dnd-kit/core'

function LawCard({ law }) {
  const { attributes, listeners, setNodeRef, isDragging } = useDraggable({
    id: law.id,
    data: { type: 'law', law },
  })

  return (
    <div
      ref={setNodeRef}
      {...listeners}
      {...attributes}
      className={`p-4 border rounded-lg cursor-grab ${isDragging ? 'opacity-50' : ''}`}
    >
      <h3>{law.title}</h3>
      <p className="text-sm text-gray-600">{law.documentNumber}</p>
    </div>
  )
}
```

**Chat Drop Zone:**

```typescript
import { useDroppable } from '@dnd-kit/core'

function ChatInputArea() {
  const { setNodeRef, isOver } = useDroppable({
    id: 'chat-drop-zone',
  })

  return (
    <div
      ref={setNodeRef}
      className={`border-2 border-dashed p-4 rounded-lg transition-colors ${
        isOver ? 'border-primary bg-blue-50' : 'border-gray-300'
      }`}
    >
      {isOver && <p className="text-sm text-primary">Drop law here to add context</p>}
      <input type="text" placeholder="Ask a question..." />
    </div>
  )
}
```

**Context State Management:**

```typescript
// Store context in React state or Zustand
const [chatContext, setChatContext] = useState<Law[]>([])

function addToContext(law: Law) {
  if (chatContext.length >= 10) {
    toast.error('Maximum 10 laws in context')
    return
  }

  if (chatContext.find((l) => l.id === law.id)) {
    toast.info('Law already in context')
    return
  }

  setChatContext([...chatContext, law])
}

function removeFromContext(lawId: string) {
  setChatContext(chatContext.filter((l) => l.id !== lawId))
}
```

**Context Pills UI:**

```typescript
function ContextPills({ context, onRemove }) {
  if (context.length === 0) return null

  return (
    <div className="flex flex-wrap gap-2 mb-2">
      {context.map(law => (
        <div key={law.id} className="flex items-center gap-2 bg-blue-100 px-3 py-1 rounded-full">
          <span className="text-sm">{law.title}</span>
          <button
            onClick={() => onRemove(law.id)}
            className="text-gray-600 hover:text-gray-900"
          >
            ✕
          </button>
        </div>
      ))}
      {context.length >= 10 && (
        <span className="text-xs text-gray-500">Max reached</span>
      )}
    </div>
  )
}
```

### Scoped RAG Search

**Modified API endpoint:**

```typescript
// app/api/chat/query/route.ts
export async function POST(request: Request) {
  const { query, contextLawIds } = await request.json()

  // If context provided, only search those laws
  const chunks = contextLawIds?.length
    ? await retrieveRelevantChunksScoped(query, contextLawIds, 10)
    : await retrieveRelevantChunks(query, 10)

  // ... rest of RAG pipeline
}
```

**Scoped retrieval function:**

```typescript
export async function retrieveRelevantChunksScoped(
  query: string,
  lawIds: string[],
  k: number
): Promise<RetrievalResult[]> {
  const queryEmbedding = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: query,
  })

  const embedding = queryEmbedding.data[0].embedding

  // Add WHERE clause to filter by document_id
  const results = await prisma.$queryRaw<RetrievalResult[]>`
    SELECT
      le.chunk_text AS "chunkText",
      le.document_id AS "documentId",
      ld.title AS "documentTitle",
      ld.document_number AS "documentNumber",
      1 - (le.embedding <=> ${embedding}::vector) AS similarity
    FROM law_embeddings le
    JOIN legal_documents ld ON le.document_id = ld.id
    WHERE le.document_id = ANY(${lawIds}::uuid[])
    ORDER BY le.embedding <=> ${embedding}::vector
    LIMIT ${k}
  `

  return results
}
```

### Mobile Implementation

**Responsive context management:**

```typescript
function LawCardMobile({ law }) {
  const [showContextMenu, setShowContextMenu] = useState(false)

  return (
    <>
      <div className="p-4 border rounded-lg">
        <h3>{law.title}</h3>
        <button
          onClick={() => setShowContextMenu(true)}
          className="mt-2 text-sm text-primary"
        >
          Add to chat context
        </button>
      </div>

      {showContextMenu && (
        <ContextMenuModal
          law={law}
          onAdd={() => {
            addToContext(law)
            setShowContextMenu(false)
          }}
          onClose={() => setShowContextMenu(false)}
        />
      )}
    </>
  )
}
```

### Important Architecture References

**From Feature Spec 03 (AI Chat Interface):**

- Drag-and-drop interaction design
- Context pill UI specifications
- Mobile alternative patterns

**From Architecture Section 6 (Components):**

- Component interaction patterns
- State management approach

**From Front-End Spec:**

- Drag-and-drop visual feedback
- Animation specifications

### Testing

**Test File:** `tests/e2e/chat/drag-drop.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('Law Card Drag and Drop', () => {
  test('drag law card into chat adds context', async ({ page }) => {
    await page.goto('/workspace')

    // Drag law card
    const lawCard = page.locator('[data-testid="law-card-1"]')
    const chatZone = page.locator('[data-testid="chat-drop-zone"]')

    await lawCard.dragTo(chatZone)

    // Verify context pill appears
    await expect(page.locator('[data-testid="context-pill"]')).toBeVisible()
    await expect(page.locator('[data-testid="context-pill"]')).toContainText(
      'Arbetsmiljölagen'
    )
  })

  test('removes context pill on X click', async ({ page }) => {
    await page.goto('/workspace')

    // Add context
    await addContextPill(page, 'law-1')

    // Remove
    await page.locator('[data-testid="context-pill"] button').click()

    await expect(page.locator('[data-testid="context-pill"]')).not.toBeVisible()
  })

  test('limits to 10 context items', async ({ page }) => {
    await page.goto('/workspace')

    // Add 10 laws
    for (let i = 1; i <= 10; i++) {
      await addContextPill(page, `law-${i}`)
    }

    // Try to add 11th
    await addContextPill(page, 'law-11')

    // Verify toast message
    await expect(page.locator('[data-toast]')).toContainText('Maximum 10')

    // Verify only 10 pills
    const pills = await page.locator('[data-testid="context-pill"]').count()
    expect(pills).toBe(10)
  })

  test('mobile: tap to add context', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 })
    await page.goto('/workspace')

    await page
      .locator('[data-testid="law-card-1"] button:has-text("Add to context")')
      .click()

    await expect(page.locator('[data-testid="context-pill"]')).toBeVisible()
  })
})
```

**Integration Test:**

```typescript
describe('Scoped RAG Search', () => {
  it('returns chunks only from context laws', async () => {
    const contextLawIds = ['law-1-id', 'law-2-id']

    const response = await fetch('/api/chat/query', {
      method: 'POST',
      body: JSON.stringify({
        query: 'What are the requirements?',
        contextLawIds,
      }),
    })

    const { answer, citations } = await response.json()

    // Verify all citations are from context laws
    expect(citations.every((c) => contextLawIds.includes(c.law_id))).toBe(true)
  })
})
```

### User Responsibilities

- None for this story

### Developer Responsibilities

- Implement drag-and-drop with proper visual feedback
- Create scoped RAG search functionality
- Build context management UI
- Test across desktop and mobile
- Ensure smooth animations and UX

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
