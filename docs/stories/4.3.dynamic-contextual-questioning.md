# Story 4.3: Implement Dynamic Contextual Questioning Flow

## Status
Draft

## Story

**As a** visitor,
**I want** to answer 3-5 contextual questions about my business during onboarding,
**so that** the AI can generate a highly accurate and comprehensive law list.

## Acceptance Criteria

1. After Bolagsverket data fetch, AI determines first question based on SNI code and employee count
2. Question selection logic implemented with rule-based decision tree (GPT-4 enhancement optional):
   - **Always ask:** "Hur m√•nga anst√§llda har ni?" (if not in Bolagsverket data)
   - **Industry-triggered questions:** Based on SNI code
     - Restaurang (SNI 56.x): "Serverar ni alkohol?", "Har ni uteservering?", "Anst√§ller ni personer under 18 √•r?"
     - Bygg (SNI 41-43): "Arbetar ni med farliga √§mnen?", "Har ni underentrepren√∂rer?", "Arbetar ni p√• h√∂jd?"
     - E-handel (SNI 47.91): "S√§ljer ni till privatpersoner eller f√∂retag?", "S√§ljer ni till andra EU-l√§nder?"
     - V√•rdgivare (SNI 86-88): "Privat eller kommunal v√•rdgivare?", "Hanterar ni patientjournaler?"
   - **Employee-count-triggered questions:**
     - 1-9 employees: "Har ni kollektivavtal?"
     - 10-24 employees: "Har ni skyddsombud?" (required by law)
     - 25+ employees: "Har ni skyddskommitt√©?" (required by law)
   - **Follow-up questions:** Based on previous answers
     - If "Ja" to alcohol: "Vilken typ av serveringstillst√•nd?"
     - If "Ja" to subcontractors: "Kontrollerar ni deras F-skatt?"
3. Question UI displays:
   - Progress indicator: "Fr√•ga 2 av ~4"
   - Contextual intro: "Eftersom ni har 12 anst√§llda:"
   - Question text (large, clear Swedish)
   - Answer options (radio buttons or large buttons)
   - Educational tooltip: "üí° Med 10+ anst√§llda kr√§vs skyddsombud enligt Arbetsmilj√∂lagen"
4. Laws stream into list as questions are answered (progressive value demonstration)
5. Each answer adds 3-8 new laws to streaming list with reason tags: "G√§ller eftersom ni serverar alkohol"
6. Hard limit: Maximum 5 questions, then force to Phase 1 completion
7. User can go back to previous question, answers preserved, law list regenerates
8. "Hoppa √∂ver" option available with warning: "Vi kanske missar relevanta lagar"
9. "Vet inte" answer option includes law with "‚ö†Ô∏è Kan g√§lla dig - kontrollera" tag
10. Answers stored in `CompanyContext` object for downstream use (AI chat, notifications, analytics)
11. Session storage preserves partial progress (24-hour expiry) if user closes browser
12. Mobile-responsive question UI (large touch targets)
13. Question-answer flow completes in <2 minutes (target: avg 3-4 questions √ó 30 seconds each)
14. Test with 10 different industries: Verify questions are relevant and law lists accurate

## Tasks / Subtasks

- [ ] Create question selection decision tree logic
- [ ] Build question UI component with progress tracking
- [ ] Implement answer handling and context accumulation
- [ ] Add educational tooltips for each question
- [ ] Wire up streaming law generation per answer
- [ ] Implement "go back" functionality with state preservation
- [ ] Add session storage for partial progress
- [ ] Create mobile-responsive question interface
- [ ] Test with 10 different industry scenarios

## Dev Notes

**Component:** `components/features/onboarding/contextual-questions.tsx`

**Question Decision Tree:**
```typescript
interface CompanyContext {
  sniCode: string
  employeeCount: number
  legalForm: string
  answers: Record<string, string>
}

interface Question {
  id: string
  text: string
  intro?: string
  tooltip?: string
  options: Array<{ value: string; label: string }>
  followUp?: (answer: string) => Question | null
}

function selectNextQuestion(context: CompanyContext): Question | null {
  const { sniCode, employeeCount, answers } = context

  // Always ask employee count if not available
  if (!employeeCount) {
    return {
      id: 'employee_count',
      text: 'Hur m√•nga anst√§llda har ni?',
      options: [
        { value: '0', label: '0 (bara jag)' },
        { value: '1-9', label: '1-9 anst√§llda' },
        { value: '10-24', label: '10-24 anst√§llda' },
        { value: '25-49', label: '25-49 anst√§llda' },
        { value: '50+', label: '50+ anst√§llda' }
      ]
    }
  }

  // Industry-specific questions
  if (sniCode.startsWith('56')) {
    // Restaurant industry
    if (!answers.serves_alcohol) {
      return {
        id: 'serves_alcohol',
        text: 'Serverar ni alkohol?',
        intro: 'Eftersom ni driver restaurangverksamhet:',
        tooltip: 'üí° Alkoholservering kr√§ver tillst√•nd och medf√∂r specifika lagar',
        options: [
          { value: 'yes', label: 'Ja, vi har serveringstillst√•nd' },
          { value: 'no', label: 'Nej, alkoholfritt' },
          { value: 'unsure', label: 'Vet inte' }
        ],
        followUp: (answer) => {
          if (answer === 'yes') {
            return {
              id: 'serving_permit_type',
              text: 'Vilken typ av serveringstillst√•nd har ni?',
              options: [
                { value: 'full', label: 'Fullst√§ndigt serveringstillst√•nd' },
                { value: 'beer_wine', label: 'Endast √∂l och vin' },
                { value: 'unsure', label: 'Vet inte' }
              ]
            }
          }
          return null
        }
      }
    }
  }

  if (sniCode.startsWith('41') || sniCode.startsWith('42') || sniCode.startsWith('43')) {
    // Construction industry
    if (!answers.hazardous_materials) {
      return {
        id: 'hazardous_materials',
        text: 'Arbetar ni med farliga √§mnen?',
        intro: 'Eftersom ni driver byggverksamhet:',
        tooltip: 'üí° Arbete med farliga √§mnen kr√§ver s√§rskilda s√§kerhets√•tg√§rder och utbildning',
        options: [
          { value: 'yes', label: 'Ja' },
          { value: 'no', label: 'Nej' },
          { value: 'unsure', label: 'Vet inte' }
        ]
      }
    }

    if (!answers.subcontractors) {
      return {
        id: 'subcontractors',
        text: 'Har ni underentrepren√∂rer?',
        tooltip: 'üí° Som huvudentrepren√∂r har ni ansvar f√∂r underentrepren√∂rers arbetsmilj√∂',
        options: [
          { value: 'yes', label: 'Ja, regelbundet' },
          { value: 'sometimes', label: 'Ibland' },
          { value: 'no', label: 'Nej' }
        ],
        followUp: (answer) => {
          if (answer === 'yes' || answer === 'sometimes') {
            return {
              id: 'f_tax_verification',
              text: 'Kontrollerar ni underentrepren√∂rers F-skatt?',
              tooltip: 'üí° Du √§r skyldig att kontrollera F-skattsedel f√∂r att undvika skatteansvarslagen',
              options: [
                { value: 'yes', label: 'Ja, alltid' },
                { value: 'no', label: 'Nej' },
                { value: 'unsure', label: 'Vet inte' }
              ]
            }
          }
          return null
        }
      }
    }
  }

  if (sniCode.startsWith('47.91')) {
    // E-commerce
    if (!answers.customer_type) {
      return {
        id: 'customer_type',
        text: 'S√§ljer ni till privatpersoner eller f√∂retag?',
        intro: 'Eftersom ni driver e-handel:',
        tooltip: 'üí° B2C-f√∂rs√§ljning har str√§ngare konsumentskyddsregler √§n B2B',
        options: [
          { value: 'b2c', label: 'Huvudsakligen privatpersoner (B2C)' },
          { value: 'b2b', label: 'Huvudsakligen f√∂retag (B2B)' },
          { value: 'both', label: 'B√•de och' }
        ]
      }
    }
  }

  if (sniCode.startsWith('86') || sniCode.startsWith('87') || sniCode.startsWith('88')) {
    // Healthcare
    if (!answers.healthcare_type) {
      return {
        id: 'healthcare_type',
        text: 'Privat eller kommunal v√•rdgivare?',
        intro: 'Eftersom ni driver v√•rdverksamhet:',
        tooltip: 'üí° Privata v√•rdgivare har ytterligare tillst√•ndskrav',
        options: [
          { value: 'private', label: 'Privat v√•rdgivare' },
          { value: 'public', label: 'Kommunal/offentlig' },
          { value: 'unsure', label: 'Vet inte' }
        ]
      }
    }
  }

  // Employee-count triggered questions
  if (employeeCount >= 10 && employeeCount < 25 && !answers.safety_representative) {
    return {
      id: 'safety_representative',
      text: 'Har ni skyddsombud?',
      intro: 'Eftersom ni har 10+ anst√§llda:',
      tooltip: 'üí° Skyddsombud √§r obligatoriskt enligt Arbetsmilj√∂lagen f√∂r f√∂retag med 10+ anst√§llda',
      options: [
        { value: 'yes', label: 'Ja, vi har skyddsombud' },
        { value: 'no', label: 'Nej, inte √§n' },
        { value: 'unsure', label: 'Vet inte' }
      ]
    }
  }

  if (employeeCount >= 25 && !answers.safety_committee) {
    return {
      id: 'safety_committee',
      text: 'Har ni skyddskommitt√©?',
      intro: 'Eftersom ni har 25+ anst√§llda:',
      tooltip: 'üí° Skyddskommitt√© √§r obligatoriskt enligt Arbetsmilj√∂lagen f√∂r f√∂retag med 25+ anst√§llda',
      options: [
        { value: 'yes', label: 'Ja, vi har skyddskommitt√©' },
        { value: 'no', label: 'Nej, inte √§n' },
        { value: 'unsure', label: 'Vet inte' }
      ]
    }
  }

  if (employeeCount >= 1 && employeeCount < 10 && !answers.collective_agreement) {
    return {
      id: 'collective_agreement',
      text: 'Har ni kollektivavtal?',
      tooltip: 'üí° Kollektivavtal p√•verkar vilka arbetsr√§ttsliga lagar som g√§ller',
      options: [
        { value: 'yes', label: 'Ja' },
        { value: 'no', label: 'Nej' },
        { value: 'unsure', label: 'Vet inte' }
      ]
    }
  }

  // No more questions
  return null
}
```

**Progressive Law Streaming:**
```typescript
async function handleAnswer(questionId: string, answer: string, context: CompanyContext) {
  // Store answer in context
  context.answers[questionId] = answer

  // Fetch relevant laws based on this specific answer
  const newLaws = await fetchLawsForAnswer(questionId, answer, context)

  // Stream laws to UI with reason tags
  for (const law of newLaws) {
    const reasonTag = generateReasonTag(questionId, answer)
    streamLawCard({
      ...law,
      reasonTag // e.g., "G√§ller eftersom ni serverar alkohol"
    })
  }

  // Check if we should ask follow-up
  const currentQuestion = getQuestionById(questionId)
  if (currentQuestion.followUp) {
    const followUp = currentQuestion.followUp(answer)
    if (followUp) {
      return followUp
    }
  }

  // Select next question
  return selectNextQuestion(context)
}
```

**Session Storage:**
```typescript
// Save progress to session storage
function saveProgress(context: CompanyContext) {
  sessionStorage.setItem('onboarding_context', JSON.stringify({
    ...context,
    timestamp: Date.now(),
    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
  }))
}

// Restore progress from session storage
function restoreProgress(): CompanyContext | null {
  const stored = sessionStorage.getItem('onboarding_context')
  if (!stored) return null

  const data = JSON.parse(stored)
  if (Date.now() > data.expiresAt) {
    sessionStorage.removeItem('onboarding_context')
    return null
  }

  return data
}
```

**Question UI Component:**
```typescript
export function ContextualQuestion({
  question,
  currentIndex,
  totalQuestions,
  onAnswer,
  onSkip,
  onBack,
  canGoBack
}: ContextualQuestionProps) {
  const [selectedAnswer, setSelectedAnswer] = useState<string | null>(null)

  return (
    <div className="max-w-2xl mx-auto p-6">
      {/* Progress indicator */}
      <div className="mb-8">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm text-gray-600">
            Fr√•ga {currentIndex} av ~{totalQuestions}
          </span>
          {canGoBack && (
            <button onClick={onBack} className="text-sm text-blue-600 hover:underline">
              ‚Üê Tillbaka
            </button>
          )}
        </div>
        <div className="h-2 bg-gray-200 rounded-full">
          <div
            className="h-full bg-blue-600 rounded-full transition-all"
            style={{ width: `${(currentIndex / totalQuestions) * 100}%` }}
          />
        </div>
      </div>

      {/* Contextual intro */}
      {question.intro && (
        <p className="text-gray-600 mb-2">{question.intro}</p>
      )}

      {/* Question text */}
      <h2 className="text-3xl font-bold mb-6">{question.text}</h2>

      {/* Tooltip */}
      {question.tooltip && (
        <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <p className="text-sm text-blue-800">{question.tooltip}</p>
        </div>
      )}

      {/* Answer options */}
      <div className="space-y-3 mb-8">
        {question.options.map((option) => (
          <button
            key={option.value}
            onClick={() => setSelectedAnswer(option.value)}
            className={`w-full p-4 text-left border-2 rounded-lg transition-all ${
              selectedAnswer === option.value
                ? 'border-blue-600 bg-blue-50'
                : 'border-gray-200 hover:border-gray-300'
            }`}
          >
            <div className="flex items-center">
              <div
                className={`w-5 h-5 rounded-full border-2 mr-3 ${
                  selectedAnswer === option.value
                    ? 'border-blue-600 bg-blue-600'
                    : 'border-gray-300'
                }`}
              >
                {selectedAnswer === option.value && (
                  <svg className="w-full h-full text-white" fill="currentColor" viewBox="0 0 12 12">
                    <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" strokeWidth="2" fill="none" />
                  </svg>
                )}
              </div>
              <span className="text-lg">{option.label}</span>
            </div>
          </button>
        ))}
      </div>

      {/* Actions */}
      <div className="flex gap-4">
        <button
          onClick={() => selectedAnswer && onAnswer(selectedAnswer)}
          disabled={!selectedAnswer}
          className="flex-1 py-3 px-6 bg-blue-600 text-white rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-blue-700"
        >
          N√§sta
        </button>
        <button
          onClick={onSkip}
          className="py-3 px-6 border border-gray-300 rounded-lg hover:bg-gray-50"
        >
          Hoppa √∂ver
        </button>
      </div>

      {/* Skip warning (when hovering skip button) */}
      <p className="text-xs text-gray-500 mt-4 text-center">
        Hoppar du √∂ver fr√•gor kanske vi missar relevanta lagar f√∂r din verksamhet
      </p>
    </div>
  )
}
```

**Reference:** PRD Epic 4 Story 4.2b, Architecture Section 8 (Onboarding), Feature Spec 01 (Homepage & Onboarding)

## Testing

**Unit Tests:**
- `selectNextQuestion()` returns correct question based on SNI code
- `selectNextQuestion()` returns correct question based on employee count
- Follow-up questions trigger correctly based on answers
- Session storage saves and restores context correctly
- Question limit enforced (max 5 questions)

**Integration Tests:**
- Complete question flow for restaurant industry (SNI 56.x)
- Complete question flow for construction industry (SNI 41-43)
- Complete question flow for e-commerce (SNI 47.91)
- Complete question flow for healthcare (SNI 86-88)
- Laws stream correctly as questions answered
- "Go back" functionality regenerates law list correctly
- Session storage persists across page refreshes

**Manual Testing:**
- Test with 10 different real company org-numbers
- Verify questions are relevant to each industry
- Verify law lists are accurate based on answers
- Test mobile responsiveness (large touch targets)
- Test skip functionality with warning
- Test "Vet inte" option includes laws with warning tags
- Verify educational tooltips display correctly

**Test File:** `__tests__/features/onboarding/contextual-questions.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Answer contextual questions honestly about their business
- Use educational tooltips to understand why questions are asked
- Decide whether to skip questions or answer "Vet inte"

**Developer Responsibility:**
- Implement rule-based decision tree for question selection
- Ensure questions are industry-relevant based on SNI codes
- Stream laws progressively as questions are answered
- Preserve session state across browser closures (24-hour expiry)
- Generate appropriate reason tags for each law
- Handle edge cases (unknown SNI codes, missing employee count)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
