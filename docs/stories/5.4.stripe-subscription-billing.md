# Story 5.4: Integrate Stripe for Subscription Billing

## Status

Draft

## Story

**As a** product owner,
**I want** to collect payments via Stripe,
**so that** users can subscribe to paid tiers.

## Acceptance Criteria

1. Stripe account created, publishable and secret keys configured
2. Stripe Customer created for each workspace
3. Three Stripe Products created: Solo (â‚¬399/mo), Team (â‚¬899/mo), Enterprise (â‚¬2,000+/mo custom)
4. Stripe Checkout integration for trial â†’ paid conversion
5. Billing page shows: Current plan, next billing date, payment method, invoice history
6. "Upgrade Plan" flow: Select tier â†’ Stripe Checkout â†’ Subscription created
7. Webhook endpoint `/api/webhooks/stripe` handles: `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.payment_failed`
8. Subscription status synced to `workspaces.subscription_tier` and `workspaces.subscription_status`
9. Failed payments â†’ Email notification + 3-day grace period before access blocked
10. Test subscription lifecycle: Trial â†’ Paid â†’ Upgrade â†’ Downgrade â†’ Cancel

## Tasks / Subtasks

- [ ] Set up Stripe account and get API keys
- [ ] Create Stripe Products for Solo, Team, Enterprise
- [ ] Implement Stripe Customer creation on workspace signup
- [ ] Build billing page UI
- [ ] Implement Stripe Checkout integration
- [ ] Create webhook endpoint for Stripe events
- [ ] Sync subscription status to database
- [ ] Handle payment failures with grace period
- [ ] Test complete subscription lifecycle
- [ ] Set up Stripe webhook in production

## Dev Notes

**Stripe Configuration:**

```typescript
// lib/stripe/config.ts
import Stripe from 'stripe'

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16',
})

export const STRIPE_PRICE_IDS = {
  solo: process.env.STRIPE_SOLO_PRICE_ID!,
  team: process.env.STRIPE_TEAM_PRICE_ID!,
  enterprise: process.env.STRIPE_ENTERPRISE_PRICE_ID!,
}

// Create products and prices in Stripe dashboard or via API:
// Solo: â‚¬399/month
// Team: â‚¬899/month
// Enterprise: â‚¬2,000/month (custom pricing)
```

**Create Stripe Customer on Signup:**

```typescript
// lib/stripe/create-customer.ts
export async function createStripeCustomer(
  workspaceId: string,
  email: string,
  companyName: string
) {
  const customer = await stripe.customers.create({
    email,
    name: companyName,
    metadata: {
      workspaceId,
    },
  })

  // Store Stripe customer ID in workspace
  await prisma.workspace.update({
    where: { id: workspaceId },
    data: { stripeCustomerId: customer.id },
  })

  return customer
}
```

**Billing Page:**

```typescript
// app/billing/page.tsx
'use client'

import { useEffect, useState } from 'react'
import { Can } from '@/components/permissions/can'
import { Permission } from '@/lib/permissions/roles'

export default function BillingPage() {
  const [subscription, setSubscription] = useState<any>(null)
  const [invoices, setInvoices] = useState<any[]>([])

  useEffect(() => {
    async function fetchBilling() {
      const response = await fetch('/api/billing')
      const data = await response.json()
      setSubscription(data.subscription)
      setInvoices(data.invoices)
    }

    fetchBilling()
  }, [])

  return (
    <Can
      permission={Permission.VIEW_BILLING}
      fallback={
        <div className="p-8 text-center">
          <h1 className="text-2xl font-bold mb-2">Access Denied</h1>
          <p className="text-gray-600">
            Only workspace owners can view billing information.
          </p>
        </div>
      }
    >
      <div className="max-w-4xl mx-auto p-6">
        <h1 className="text-2xl font-bold mb-6">Billing & Subscription</h1>

        {/* Current Plan */}
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <h2 className="text-lg font-semibold mb-4">Current Plan</h2>

          <div className="flex items-center justify-between mb-4">
            <div>
              <p className="text-2xl font-bold">
                {subscription?.tier === 'solo' && 'Solo'}
                {subscription?.tier === 'team' && 'Team'}
                {subscription?.tier === 'enterprise' && 'Enterprise'}
                {subscription?.tier === 'trial' && 'Free Trial'}
              </p>
              <p className="text-gray-600">
                {subscription?.tier === 'trial' ? (
                  <>Trial ends {new Date(subscription.trialEndsAt).toLocaleDateString()}</>
                ) : (
                  <>Next billing: {new Date(subscription.currentPeriodEnd).toLocaleDateString()}</>
                )}
              </p>
            </div>

            <Can permission={Permission.MANAGE_BILLING}>
              {subscription?.tier === 'trial' ? (
                <button
                  onClick={() => (window.location.href = '/billing/upgrade')}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  Upgrade Now
                </button>
              ) : (
                <button
                  onClick={() => (window.location.href = '/billing/change-plan')}
                  className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                  Change Plan
                </button>
              )}
            </Can>
          </div>

          {subscription?.tier !== 'trial' && (
            <div className="pt-4 border-t">
              <h3 className="font-semibold mb-2">Payment Method</h3>
              <div className="flex items-center justify-between">
                <div className="flex items-center">
                  <div className="w-12 h-8 bg-gray-200 rounded mr-3 flex items-center justify-center">
                    ðŸ’³
                  </div>
                  <div>
                    <p className="font-medium">
                      â€¢â€¢â€¢â€¢ {subscription?.paymentMethod?.last4}
                    </p>
                    <p className="text-sm text-gray-600">
                      Expires {subscription?.paymentMethod?.expMonth}/
                      {subscription?.paymentMethod?.expYear}
                    </p>
                  </div>
                </div>
                <Can permission={Permission.MANAGE_BILLING}>
                  <button
                    onClick={() => updatePaymentMethod()}
                    className="text-blue-600 hover:underline text-sm"
                  >
                    Update
                  </button>
                </Can>
              </div>
            </div>
          )}
        </div>

        {/* Invoice History */}
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4">Invoice History</h2>

          {invoices.length === 0 ? (
            <p className="text-gray-600">No invoices yet</p>
          ) : (
            <div className="space-y-3">
              {invoices.map((invoice) => (
                <div
                  key={invoice.id}
                  className="flex items-center justify-between p-3 border rounded-lg"
                >
                  <div>
                    <p className="font-medium">
                      â‚¬{(invoice.amount / 100).toFixed(2)}
                    </p>
                    <p className="text-sm text-gray-600">
                      {new Date(invoice.created * 1000).toLocaleDateString()}
                    </p>
                  </div>
                  <div className="flex items-center gap-3">
                    <span
                      className={`px-2 py-1 text-xs rounded ${
                        invoice.status === 'paid'
                          ? 'bg-green-100 text-green-700'
                          : 'bg-red-100 text-red-700'
                      }`}
                    >
                      {invoice.status}
                    </span>
                    <a
                      href={invoice.invoicePdf}
                      target="_blank"
                      className="text-blue-600 hover:underline text-sm"
                    >
                      Download
                    </a>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </Can>
  )
}
```

**Upgrade Flow (Stripe Checkout):**

```typescript
// app/api/billing/checkout/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, workspace, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_BILLING)

    const { tier } = await request.json()

    // Get or create Stripe customer
    let stripeCustomerId = workspace.stripeCustomerId

    if (!stripeCustomerId) {
      const customer = await createStripeCustomer(
        workspaceId,
        workspace.owner.email,
        workspace.name
      )
      stripeCustomerId = customer.id
    }

    // Create Stripe Checkout session
    const session = await stripe.checkout.sessions.create({
      customer: stripeCustomerId,
      mode: 'subscription',
      payment_method_types: ['card'],
      line_items: [
        {
          price: STRIPE_PRICE_IDS[tier as keyof typeof STRIPE_PRICE_IDS],
          quantity: 1,
        },
      ],
      success_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing`,
      metadata: {
        workspaceId,
        tier,
      },
    })

    return NextResponse.json({ url: session.url })
  })
}
```

**Stripe Webhook Handler:**

```typescript
// app/api/webhooks/stripe/route.ts
import { headers } from 'next/headers'
import Stripe from 'stripe'

export async function POST(request: Request) {
  const body = await request.text()
  const signature = headers().get('stripe-signature')!

  let event: Stripe.Event

  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    )
  } catch (err: any) {
    console.error('Webhook signature verification failed:', err.message)
    return NextResponse.json({ error: err.message }, { status: 400 })
  }

  try {
    switch (event.type) {
      case 'checkout.session.completed':
        await handleCheckoutCompleted(
          event.data.object as Stripe.Checkout.Session
        )
        break

      case 'customer.subscription.updated':
        await handleSubscriptionUpdated(
          event.data.object as Stripe.Subscription
        )
        break

      case 'customer.subscription.deleted':
        await handleSubscriptionDeleted(
          event.data.object as Stripe.Subscription
        )
        break

      case 'invoice.payment_failed':
        await handlePaymentFailed(event.data.object as Stripe.Invoice)
        break

      case 'invoice.payment_succeeded':
        await handlePaymentSucceeded(event.data.object as Stripe.Invoice)
        break

      default:
        console.log(`Unhandled event type: ${event.type}`)
    }

    return NextResponse.json({ received: true })
  } catch (error) {
    console.error('Webhook handler error:', error)
    return NextResponse.json(
      { error: 'Webhook handler failed' },
      { status: 500 }
    )
  }
}

async function handleCheckoutCompleted(session: Stripe.Checkout.Session) {
  const workspaceId = session.metadata?.workspaceId
  const tier = session.metadata?.tier

  if (!workspaceId || !tier) return

  // Get subscription ID
  const subscriptionId = session.subscription as string

  // Update workspace
  await prisma.workspace.update({
    where: { id: workspaceId },
    data: {
      subscriptionTier: tier,
      subscriptionStatus: 'active',
      stripeSubscriptionId: subscriptionId,
      trialEndsAt: null, // Clear trial end date
    },
  })

  // Track conversion analytics
  await trackEvent('trial_converted', {
    workspaceId,
    tier,
  })

  console.log(`Workspace ${workspaceId} upgraded to ${tier}`)
}

async function handleSubscriptionUpdated(subscription: Stripe.Subscription) {
  const workspaceId = subscription.metadata?.workspaceId

  if (!workspaceId) return

  // Determine tier from price ID
  const priceId = subscription.items.data[0].price.id
  const tier = Object.entries(STRIPE_PRICE_IDS).find(
    ([_, id]) => id === priceId
  )?.[0]

  await prisma.workspace.update({
    where: { id: workspaceId },
    data: {
      subscriptionTier: tier || 'solo',
      subscriptionStatus: subscription.status,
      currentPeriodEnd: new Date(subscription.current_period_end * 1000),
    },
  })

  console.log(`Workspace ${workspaceId} subscription updated`)
}

async function handleSubscriptionDeleted(subscription: Stripe.Subscription) {
  const workspaceId = subscription.metadata?.workspaceId

  if (!workspaceId) return

  // Pause workspace
  await prisma.workspace.update({
    where: { id: workspaceId },
    data: {
      status: 'paused',
      pausedAt: new Date(),
      subscriptionStatus: 'canceled',
    },
  })

  console.log(`Workspace ${workspaceId} subscription canceled`)
}

async function handlePaymentFailed(invoice: Stripe.Invoice) {
  const customerId = invoice.customer as string

  // Find workspace
  const workspace = await prisma.workspace.findFirst({
    where: { stripeCustomerId: customerId },
    include: { owner: true },
  })

  if (!workspace) return

  // Send payment failed email
  await sendPaymentFailedEmail(
    workspace.owner.email,
    workspace.name,
    invoice.amount_due / 100
  )

  // Set grace period (3 days)
  await prisma.workspace.update({
    where: { id: workspace.id },
    data: {
      paymentGracePeriodEndsAt: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
    },
  })

  console.log(
    `Payment failed for workspace ${workspace.id}, 3-day grace period`
  )
}

async function handlePaymentSucceeded(invoice: Stripe.Invoice) {
  const customerId = invoice.customer as string

  // Find workspace
  const workspace = await prisma.workspace.findFirst({
    where: { stripeCustomerId: customerId },
  })

  if (!workspace) return

  // Clear grace period if any
  await prisma.workspace.update({
    where: { id: workspace.id },
    data: {
      paymentGracePeriodEndsAt: null,
      subscriptionStatus: 'active',
    },
  })

  console.log(`Payment succeeded for workspace ${workspace.id}`)
}
```

**Database Schema Updates:**

```prisma
model Workspace {
  // ... existing fields
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  subscriptionStatus     String?   // active, past_due, canceled, etc.
  currentPeriodEnd       DateTime?
  paymentGracePeriodEndsAt DateTime?
}
```

**Payment Failed Email:**

```typescript
// components/emails/payment-failed.tsx
export function PaymentFailedEmail({
  companyName,
  amount
}: {
  companyName: string
  amount: number
}) {
  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>Payment Failed</Heading>

          <Text style={styles.text}>Hej {companyName},</Text>

          <Text style={styles.text}>
            Your payment of â‚¬{amount.toFixed(2)} for Laglig.se failed to process.
          </Text>

          <Text style={styles.text}>
            Please update your payment method within 3 days to avoid service
            interruption.
          </Text>

          <Section style={styles.buttonSection}>
            <Button
              href={`${process.env.NEXT_PUBLIC_APP_URL}/billing`}
              style={styles.button}
            >
              Update Payment Method
            </Button>
          </Section>

          <Text style={styles.text}>
            If you have questions, reply to this email and we'll help.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}
```

**Reference:** PRD Epic 5 Story 5.4, Stripe documentation, Architecture Section 14 (Subscription Management)

## Testing

**Unit Tests:**

- Stripe customer creation works correctly
- Checkout session created with correct parameters
- Webhook signature verification works

**Integration Tests:**

- Complete upgrade flow: Trial â†’ Stripe Checkout â†’ Paid
- Webhook handles checkout.session.completed
- Webhook handles subscription.updated
- Webhook handles subscription.deleted
- Webhook handles invoice.payment_failed
- Payment failure triggers grace period
- Grace period expires â†’ workspace paused

**Manual Testing:**

- Upgrade from trial to Solo plan
- Upgrade from Solo to Team plan
- Downgrade from Team to Solo plan
- Cancel subscription (pauses workspace)
- Test payment failure (use Stripe test card 4000 0000 0000 0341)
- Verify invoices downloadable
- Update payment method

**Stripe Testing:**

- Use Stripe test mode for development
- Test cards: 4242 4242 4242 4242 (success), 4000 0000 0000 0341 (decline)
- Verify webhook events in Stripe dashboard

**Test File:** `__tests__/features/billing/stripe-integration.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**

- Choose appropriate subscription tier
- Provide valid payment method
- Update payment method if it fails
- Monitor billing emails

**Developer Responsibility:**

- Securely store Stripe API keys
- Create Stripe customers for workspaces
- Handle all Stripe webhook events
- Sync subscription status to database
- Implement 3-day grace period for failed payments
- Send payment failure notifications
- Test subscription lifecycle thoroughly

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
