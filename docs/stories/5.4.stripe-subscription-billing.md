# Story 5.4: Integrate Stripe for Subscription Billing

## Status

Draft

## Story

**As a** product owner,
**I want** to collect payments via Stripe,
**so that** users can subscribe to paid tiers.

## Context & Dependencies

- **Builds on:** Story 5.1 (completed) — `SubscriptionTier` enum (TRIAL, SOLO, TEAM, ENTERPRISE) and `subscription_tier` field on Workspace model
- **Builds on:** Story 5.7 (completed) — workspace settings page (billing tab will live here)
- **Depended on by:** Stories 5.5 (usage limits), 5.6 (add-ons), 5.8 (pause/delete), 5.10 (unit economics)
- **Note:** Pricing tiers are subject to validation — EUR 399/899/2000 are initial estimates. Update Stripe Price IDs once confirmed.

## Acceptance Criteria

1. Stripe account created, publishable and secret keys configured in env vars
2. Stripe Customer created for each workspace on first billing interaction
3. Three Stripe Products created: Solo (EUR 399/mo), Team (EUR 899/mo), Enterprise (EUR 2,000+/mo custom)
4. Stripe Checkout integration for trial-to-paid conversion
5. Billing page shows: Current plan, next billing date, payment method, invoice history
6. "Upgrade Plan" flow: Select tier -> Stripe Checkout -> Subscription created
7. Webhook endpoint `/api/webhooks/stripe` handles: `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.payment_failed`
8. Subscription status synced to `workspaces.subscription_tier` and workspace status
9. Failed payments -> Email notification via Resend + 3-day grace period before access blocked
10. Test subscription lifecycle: Trial -> Paid -> Upgrade -> Downgrade -> Cancel

## Tasks / Subtasks

- [ ] Set up Stripe account and configure API keys in env
- [ ] Create Stripe Products/Prices for Solo, Team, Enterprise
- [ ] Implement Stripe Customer creation on first billing interaction
- [ ] Build billing page UI (settings tab)
- [ ] Implement Stripe Checkout integration
- [ ] Create webhook endpoint for Stripe events
- [ ] Sync subscription status to database
- [ ] Handle payment failures with grace period
- [ ] Create payment failure notification email (React Email + Resend)
- [ ] Test complete subscription lifecycle
- [ ] Set up Stripe webhook URL in production

## Dev Notes

**Stripe Configuration:**

```typescript
// lib/stripe/config.ts
import Stripe from 'stripe'

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-12-18.acacia',
})

export const STRIPE_PRICE_IDS = {
  SOLO: process.env.STRIPE_SOLO_PRICE_ID!,
  TEAM: process.env.STRIPE_TEAM_PRICE_ID!,
  ENTERPRISE: process.env.STRIPE_ENTERPRISE_PRICE_ID!,
}
```

**Database Schema Updates:**

```prisma
// Add to Workspace model:
  stripeCustomerId         String?
  stripeSubscriptionId     String?
  subscriptionStatus       String?   // active, past_due, canceled
  currentPeriodEnd         DateTime?
  paymentGracePeriodEndsAt DateTime?
```

**Create Stripe Customer:**

```typescript
// lib/stripe/create-customer.ts
import { stripe } from './config'
import { prisma } from '@/lib/prisma'

export async function getOrCreateStripeCustomer(
  workspaceId: string,
  email: string,
  companyName: string
) {
  const workspace = await prisma.workspace.findUnique({
    where: { id: workspaceId },
    select: { stripeCustomerId: true },
  })

  if (workspace?.stripeCustomerId) {
    return workspace.stripeCustomerId
  }

  const customer = await stripe.customers.create({
    email,
    name: companyName,
    metadata: { workspaceId },
  })

  await prisma.workspace.update({
    where: { id: workspaceId },
    data: { stripeCustomerId: customer.id },
  })

  return customer.id
}
```

**Checkout API Endpoint:**

```typescript
// app/api/billing/checkout/route.ts
import { NextResponse } from 'next/server'
import { getWorkspaceContext } from '@/lib/auth/workspace-context'
import { requirePermission } from '@/lib/api/require-permission'
import { stripe, STRIPE_PRICE_IDS } from '@/lib/stripe/config'
import { getOrCreateStripeCustomer } from '@/lib/stripe/create-customer'

export async function POST(request: Request) {
  const denied = await requirePermission('workspace:billing')
  if (denied) return denied

  const context = await getWorkspaceContext()
  const { tier } = await request.json()

  const workspace = await prisma.workspace.findUnique({
    where: { id: context.workspaceId },
    include: { owner: { select: { email: true } } },
  })

  const stripeCustomerId = await getOrCreateStripeCustomer(
    context.workspaceId,
    workspace!.owner.email,
    workspace!.name
  )

  const session = await stripe.checkout.sessions.create({
    customer: stripeCustomerId,
    mode: 'subscription',
    payment_method_types: ['card'],
    line_items: [
      {
        price: STRIPE_PRICE_IDS[tier as keyof typeof STRIPE_PRICE_IDS],
        quantity: 1,
      },
    ],
    success_url: `${process.env.NEXT_PUBLIC_APP_URL}/settings/billing?success=true&session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/settings/billing`,
    metadata: { workspaceId: context.workspaceId, tier },
  })

  return NextResponse.json({ url: session.url })
}
```

**Stripe Webhook Handler:**

```typescript
// app/api/webhooks/stripe/route.ts
import { headers } from 'next/headers'
import Stripe from 'stripe'
import { stripe, STRIPE_PRICE_IDS } from '@/lib/stripe/config'
import { prisma } from '@/lib/prisma'
import { sendEmail } from '@/lib/email/email-service'
import { PaymentFailedEmail } from '@/components/emails/payment-failed'

export async function POST(request: Request) {
  const body = await request.text()
  const headersList = await headers()
  const signature = headersList.get('stripe-signature')!

  let event: Stripe.Event
  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    )
  } catch (err: any) {
    console.error('[STRIPE-WEBHOOK] Signature verification failed:', err.message)
    return NextResponse.json({ error: err.message }, { status: 400 })
  }

  try {
    switch (event.type) {
      case 'checkout.session.completed': {
        const session = event.data.object as Stripe.Checkout.Session
        const workspaceId = session.metadata?.workspaceId
        const tier = session.metadata?.tier
        if (!workspaceId || !tier) break

        await prisma.workspace.update({
          where: { id: workspaceId },
          data: {
            subscription_tier: tier as any,
            stripeSubscriptionId: session.subscription as string,
            subscriptionStatus: 'active',
            trial_ends_at: null,
          },
        })
        break
      }

      case 'customer.subscription.updated': {
        const subscription = event.data.object as Stripe.Subscription
        const workspaceId = subscription.metadata?.workspaceId
        if (!workspaceId) break

        const priceId = subscription.items.data[0].price.id
        const tier = Object.entries(STRIPE_PRICE_IDS).find(
          ([_, id]) => id === priceId
        )?.[0]

        await prisma.workspace.update({
          where: { id: workspaceId },
          data: {
            subscription_tier: (tier as any) || 'SOLO',
            subscriptionStatus: subscription.status,
            currentPeriodEnd: new Date(subscription.current_period_end * 1000),
          },
        })
        break
      }

      case 'customer.subscription.deleted': {
        const subscription = event.data.object as Stripe.Subscription
        const workspaceId = subscription.metadata?.workspaceId
        if (!workspaceId) break

        await prisma.workspace.update({
          where: { id: workspaceId },
          data: {
            status: 'PAUSED',
            paused_at: new Date(),
            subscriptionStatus: 'canceled',
          },
        })
        break
      }

      case 'invoice.payment_failed': {
        const invoice = event.data.object as Stripe.Invoice
        const customerId = invoice.customer as string

        const workspace = await prisma.workspace.findFirst({
          where: { stripeCustomerId: customerId },
          include: { owner: { select: { email: true } } },
        })
        if (!workspace) break

        await sendEmail({
          to: workspace.owner.email,
          subject: 'Betalning misslyckades - Laglig.se',
          react: PaymentFailedEmail({
            companyName: workspace.name,
            amount: (invoice.amount_due || 0) / 100,
          }),
          from: 'notifications',
        })

        await prisma.workspace.update({
          where: { id: workspace.id },
          data: {
            paymentGracePeriodEndsAt: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
          },
        })
        break
      }

      case 'invoice.payment_succeeded': {
        const invoice = event.data.object as Stripe.Invoice
        const customerId = invoice.customer as string
        const workspace = await prisma.workspace.findFirst({
          where: { stripeCustomerId: customerId },
        })
        if (!workspace) break

        await prisma.workspace.update({
          where: { id: workspace.id },
          data: {
            paymentGracePeriodEndsAt: null,
            subscriptionStatus: 'active',
          },
        })
        break
      }
    }

    return NextResponse.json({ received: true })
  } catch (error) {
    console.error('[STRIPE-WEBHOOK] Handler error:', error)
    return NextResponse.json({ error: 'Webhook handler failed' }, { status: 500 })
  }
}
```

**Reference:** Stripe documentation, `lib/auth/workspace-context.ts`, `lib/auth/permissions.ts` (`workspace:billing`), `lib/email/email-service.ts`

## Testing

**Unit Tests:**

- Stripe customer creation returns customer ID
- Checkout session created with correct parameters
- Webhook signature verification works

**Integration Tests:**

- Complete upgrade flow: Trial -> Stripe Checkout -> Paid
- Webhook handles checkout.session.completed
- Webhook handles subscription.updated
- Webhook handles subscription.deleted
- Webhook handles invoice.payment_failed
- Payment failure triggers grace period and email
- Grace period clearance on payment success

**Stripe Testing:**

- Use Stripe test mode for development
- Test cards: 4242 4242 4242 4242 (success), 4000 0000 0000 0341 (decline)
- Verify webhook events in Stripe dashboard

**Test File:** `tests/unit/billing/stripe-integration.test.ts`

## Change Log

| Date       | Version | Description                                           | Author     |
| ---------- | ------- | ----------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                | Sarah (PO) |
| 2026-02-19 | 2.0     | Updated auth patterns, email via Resend, added context | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
