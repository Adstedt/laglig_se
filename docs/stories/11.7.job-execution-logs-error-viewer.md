# Story 11.7: Job Execution Logs & Error Viewer

## Status

Draft

## Story

**As an** admin,
**I want** to inspect detailed execution logs and errors for cron jobs,
**so that** I can diagnose failures in legal document ingestion and other automated processes.

## Acceptance Criteria

1. Click a job on the cron dashboard to navigate to `/admin/cron-jobs/[jobName]`
2. Job detail page shows run history: table of recent runs (last 50) with timestamp, duration, status, items processed, items failed
3. Click a specific run to navigate to `/admin/cron-jobs/[jobName]/[runId]`
4. Run detail shows:
   - Full log output (scrollable, monospace font, line-by-line rendering)
   - Error message and stack trace (if failed) — highlighted in red
   - Metadata (job-specific details rendered as JSON)
   - Items processed vs failed breakdown
   - Duration and timestamps (started, completed)
5. Error aggregation view at `/admin/cron-jobs/errors`:
   - List of all failed runs across all jobs, most recent first
   - Filterable by job name (dropdown) and date range
   - Shows: job name, timestamp, error message (truncated to 100 chars), items failed
6. Log output supports structured display: each log line shows timestamp and message
7. Pagination on run history (25 per page)
8. Auto-refresh toggle on job detail page (poll every 10s when enabled) for monitoring running jobs

## Tasks / Subtasks

- [ ] **Task 1: Create job run queries** (AC: 2, 3, 5, 7)
  - [ ] Add to `lib/admin/queries.ts`:
  - [ ] `getJobRunHistory(jobName: string, params: { page?: number, pageSize?: number })` — returns paginated `CronJobRun` records for a specific job, ordered by `started_at` desc
  - [ ] `getJobRunDetail(runId: string)` — returns single `CronJobRun` with all fields
  - [ ] `getFailedRuns(params: { jobName?: string, fromDate?: Date, toDate?: Date, page?: number, pageSize?: number })` — returns paginated failed runs across all jobs, filterable by job name and date range

- [ ] **Task 2: Create job run history page** (AC: 1, 2, 7, 8)
  - [ ] Create `app/admin/(dashboard)/cron-jobs/[jobName]/page.tsx` — Server Component
  - [ ] Look up job definition from `JOB_REGISTRY` by `jobName` param — show 404 if not found
  - [ ] Fetch run history via `getJobRunHistory()` with pagination from search params
  - [ ] Display job metadata header: name, description, schedule
  - [ ] Display run history as a shadcn/ui Table:
    - Columns: Status (colored badge), Started At (formatted), Duration (e.g. "12.3s"), Items Processed, Items Failed, Triggered By
    - Click row → navigate to `/admin/cron-jobs/[jobName]/[runId]`
  - [ ] Pagination controls at bottom
  - [ ] Create `'use client'` component for auto-refresh toggle:
    - `components/admin/auto-refresh-toggle.tsx`
    - Toggle switch/checkbox: "Autoförnya" (Auto-refresh)
    - When enabled: `router.refresh()` every 10 seconds
    - When disabled: clear interval

- [ ] **Task 3: Create run detail page** (AC: 3, 4, 6)
  - [ ] Create `app/admin/(dashboard)/cron-jobs/[jobName]/[runId]/page.tsx` — Server Component
  - [ ] Fetch run detail via `getJobRunDetail(runId)` — show 404 if not found
  - [ ] Display run summary section (Card):
    - Status badge (colored)
    - Started at, Completed at (formatted with date-fns, Swedish locale)
    - Duration (human-readable: "12.3 sekunder" or "2 minuter 34 sekunder")
    - Items processed / Items failed
    - Triggered by (cron or admin email)
  - [ ] Display log output section:
    - `components/admin/log-viewer.tsx` component
    - Monospace font, dark background (`bg-gray-900 text-gray-100`)
    - Each line rendered separately for readability
    - Auto-scroll to bottom option
    - Copy-to-clipboard button
  - [ ] Display error section (only if `status === 'FAILED'`):
    - Error message in red text
    - Stack trace in monospace, collapsible (expanded by default)
  - [ ] Display metadata section (only if metadata is present):
    - Render as formatted JSON in a code block

- [ ] **Task 4: Create log viewer component** (AC: 4, 6)
  - [ ] Create `components/admin/log-viewer.tsx` — `'use client'` component
  - [ ] Props: `content: string | null`
  - [ ] Split content by newline, render each line in a `<div>`:
    - Parse timestamp prefix `[2026-02-02T10:30:00.000Z]` and render it in a muted color
    - Render rest of line in white
    - Lines containing "error" or "fail" (case-insensitive) highlighted with red text
  - [ ] Empty state: "Ingen loggdata" if content is null/empty
  - [ ] Max height with overflow-y scroll
  - [ ] "Kopiera" (Copy) button at top-right that copies raw log text to clipboard

- [ ] **Task 5: Create error aggregation page** (AC: 5)
  - [ ] Create `app/admin/(dashboard)/cron-jobs/errors/page.tsx` — Server Component
  - [ ] Read filters from search params: `jobName`, `from`, `to`
  - [ ] Fetch failed runs via `getFailedRuns()` with filters
  - [ ] Create filter bar (`'use client'` component):
    - Job name dropdown (populated from `JOB_REGISTRY`)
    - Date range: "Från" and "Till" date inputs
    - Filters update URL search params
  - [ ] Display results as a shadcn/ui Table:
    - Columns: Job Name, Started At, Duration, Error Message (truncated), Items Failed
    - Click row → navigate to `/admin/cron-jobs/[jobName]/[runId]`
  - [ ] Add sidebar navigation link: "Errors" sub-item under "Cron Jobs" (or a tab on the cron jobs page)
  - [ ] Pagination (25 per page)

- [ ] **Task 6: Update cron job dashboard links** (AC: 1)
  - [ ] Modify `components/admin/cron-job-card.tsx` (from Story 11.6):
    - Job name/title is now a link to `/admin/cron-jobs/[jobName]`
    - Add "Visa historik" (View history) text link below the job card content

- [ ] **Task 7: Testing** (AC: all)
  - **Automated (Vitest)** — extend `tests/unit/lib/admin/queries.test.ts`:
  - [ ] Test: `getJobRunHistory()` returns paginated runs for specific job
  - [ ] Test: `getJobRunHistory()` orders by started_at desc
  - [ ] Test: `getJobRunDetail()` returns full run details
  - [ ] Test: `getJobRunDetail()` returns null for non-existent ID
  - [ ] Test: `getFailedRuns()` returns only FAILED runs
  - [ ] Test: `getFailedRuns()` filters by job name
  - [ ] Test: `getFailedRuns()` filters by date range
  - **Manual:**
  - [ ] Test: navigate from cron dashboard → job run history → run detail
  - [ ] Test: log viewer renders log lines with timestamps
  - [ ] Test: error detail shows message + stack trace for failed runs
  - [ ] Test: error aggregation page filters correctly
  - [ ] Test: auto-refresh toggle works (page updates when jobs complete)
  - [ ] Test: copy log output to clipboard

## Dev Notes

### Dependencies

- **Blocked by:** Story 11.6 (Cron Job Dashboard) — requires `CronJobRun` model, job registry, and populated data
- **Blocked by:** Story 11.1 (Admin Auth & Shell Layout) — requires admin auth

### Architecture Context

This story is primarily read-only views on top of the `CronJobRun` data created by Story 11.6. The most complex component is the log viewer, which needs to handle potentially large log outputs (thousands of lines) without performance issues.

### Relevant Source Tree

```
app/admin/(dashboard)/
  cron-jobs/
    [jobName]/
      page.tsx                        # NEW: Job run history
      [runId]/
        page.tsx                      # NEW: Individual run detail
    errors/
      page.tsx                        # NEW: Cross-job error aggregation

components/admin/
  log-viewer.tsx                      # NEW: Monospace log display
  auto-refresh-toggle.tsx             # NEW: Toggle for auto-refresh polling
  run-history-table.tsx               # NEW: Run history data table (optional — or inline)
  cron-job-card.tsx                   # MODIFY: Add link to job history (from Story 11.6)

lib/admin/
  queries.ts                          # EXTEND: Add getJobRunHistory(), getJobRunDetail(), getFailedRuns()
  job-registry.ts                     # READ: JOB_REGISTRY for job name validation and dropdown

# REFERENCE FILES:
prisma/schema.prisma                  # CronJobRun model (added in Story 11.6)
```

### Key Implementation Details

1. **Log viewer performance.** For large log outputs, consider virtualization:
   - If log output is <1000 lines: render all lines directly in a scrollable div
   - If log output is >1000 lines: use `@tanstack/react-virtual` (already in project) for virtualized scrolling
   - Start with the simple approach; optimize only if needed

2. **Log line parsing:**

   ```typescript
   function parseLogLine(line: string): {
     timestamp: string | null
     message: string
   } {
     const match = line.match(/^\[(\d{4}-\d{2}-\d{2}T[\d:.]+Z?)\]\s*(.*)$/)
     if (match?.[1] && match?.[2] !== undefined) {
       return { timestamp: match[1], message: match[2] }
     }
     return { timestamp: null, message: line }
   }
   ```

3. **Duration formatting:**

   ```typescript
   function formatDuration(ms: number): string {
     if (ms < 1000) return `${ms}ms`
     if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`
     const minutes = Math.floor(ms / 60000)
     const seconds = Math.round((ms % 60000) / 1000)
     return `${minutes}m ${seconds}s`
   }
   ```

4. **Error message truncation for table view:**

   ```typescript
   function truncate(str: string | null, maxLen: number): string {
     if (!str) return '—'
     if (str.length <= maxLen) return str
     return str.slice(0, maxLen) + '...'
   }
   ```

5. **Date range filtering.** Use HTML `<input type="date">` for the date range filter. Parse the date strings to `Date` objects for the Prisma query:

   ```typescript
   where: {
     status: 'FAILED',
     ...(jobName && { job_name: jobName }),
     ...(fromDate && { started_at: { gte: new Date(fromDate) } }),
     ...(toDate && { started_at: { lte: new Date(toDate + 'T23:59:59.999Z') } }),
   }
   ```

6. **Sidebar sub-navigation.** Add "Felloggar" (Error logs) as a secondary link under "Cron Jobs" in the admin sidebar, or render it as a tab on the cron jobs page. Simplest approach: add it as an icon-link in the sidebar component from Story 11.1.

7. **Copy to clipboard:**

   ```typescript
   async function copyToClipboard(text: string) {
     await navigator.clipboard.writeText(text)
     toast.success('Kopierat till urklipp')
   }
   ```

### Coding Standards

- Server-side data fetching in Server Components [Source: architecture/17-coding-standards.md#17.3]
- shadcn/ui components: Table, Card, Badge, Button, Switch [Source: architecture/17-coding-standards.md#17.3]
- Date formatting with `date-fns` + Swedish locale [Source: architecture/3-tech-stack.md]
- URL search params for server-side filtering/pagination
- `@tanstack/react-virtual` available for virtualized scrolling if needed [Source: architecture/3-tech-stack.md — @tanstack/react-virtual 3.13.17]

### Testing

- **Test file location**: `tests/unit/lib/admin/queries.test.ts` (extend)
- **Testing framework**: Vitest [Source: architecture/17-coding-standards.md]
- **Mock strategy**: Mock `prisma` for query tests
- **Manual**: Full navigation flow (dashboard → history → detail), log viewer rendering, error aggregation filtering, auto-refresh toggle

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-02-02 | 1.0     | Initial story creation | Sarah (PO) |
