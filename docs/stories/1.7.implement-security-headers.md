# Story 1.7: Implement Security Headers (CSP, X-Frame-Options)

## Status
Draft

## Story

**As a** security-conscious product owner,
**I want** to protect users from XSS and clickjacking,
**so that** the application meets security best practices.

## Acceptance Criteria

1. CSP header configured in Next.js middleware
2. CSP allows: self, Vercel, Supabase, OpenAI
3. CSP blocks: inline scripts (except nonce), eval(), data: URIs
4. X-Frame-Options: DENY header set
5. X-Content-Type-Options: nosniff header set
6. Referrer-Policy: strict-origin-when-cross-origin set
7. Security headers tested with securityheaders.com (score A/A+)
8. No CSP violations in browser console

## Tasks / Subtasks

- [ ] Configure CSP in middleware
  - [ ] Create or update `middleware.ts`
  - [ ] Add CSP header with nonce support
  - [ ] Allow required domains

- [ ] Add security headers
  - [ ] X-Frame-Options: DENY
  - [ ] X-Content-Type-Options: nosniff
  - [ ] Referrer-Policy: strict-origin-when-cross-origin
  - [ ] Permissions-Policy (optional)

- [ ] Test security headers
  - [ ] Visit securityheaders.com
  - [ ] Scan production URL
  - [ ] Fix any warnings
  - [ ] Achieve A/A+ score

## Dev Notes

### Security Headers Configuration

**middleware.ts:**
```typescript
import { NextResponse } from 'next/server'

export function middleware(request: Request) {
  const nonce = Buffer.from(crypto.randomUUID()).toString('base64')
  const cspHeader = `
    default-src 'self';
    script-src 'self' 'nonce-${nonce}' 'strict-dynamic';
    style-src 'self' 'unsafe-inline';
    img-src 'self' blob: data:;
    font-src 'self';
    connect-src 'self' *.supabase.co *.openai.com;
    frame-ancestors 'none';
  `

  const response = NextResponse.next()
  response.headers.set('Content-Security-Policy', cspHeader)
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')

  return response
}
```

**Reference:** Architecture Section 15 (Security and Performance)

### Testing
Test at https://securityheaders.com with production URL

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-11 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
