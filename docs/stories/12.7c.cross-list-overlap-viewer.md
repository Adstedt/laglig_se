# Story 12.7c: Cross-List Overlap Viewer

## Status

Ready for Review

## Story

**As an** admin,
**I want** to see which documents appear across multiple templates and identify inconsistencies,
**so that** I can maintain consistency in compliance summaries across the catalog.

## Acceptance Criteria

1. Admin route: `/admin/templates/overlap`
2. Table showing all documents that appear in 2+ templates
3. For each shared document: list of templates it belongs to, compliance summary preview per template
4. Highlight inconsistencies: flag documents where compliance summaries differ significantly across templates
5. "Sync summaries" action: copy compliance summary from one template to another for shared documents

## Tasks / Subtasks

- [x] **Task 1: Build overlap query** (AC: 2, 3)
  - [x] Add `getTemplateOverlap()` to `lib/admin/template-queries.ts`
  - [x] Define `TemplateOverlapItem` interface:
    - `documentId: string`, `documentTitle: string`, `documentNumber: string | null`
    - `templateCount: number`
    - `entries: { templateId: string; templateName: string; templateSlug: string; itemId: string; compliance_summary: string | null; expert_commentary: string | null; content_status: TemplateItemContentStatus }[]`
    - `isInconsistent: boolean`
  - [x] Two-step query approach (Prisma `groupBy` with `having`):
    1. `groupBy` on `document_id` with `_count` of distinct `template_id`, filter `_count >= 2`
    2. For those document_ids, fetch all `TemplateItem` records with template and document relations
  - [x] Compute `isInconsistent` per overlap group: compare `compliance_summary` strings across entries — if any differ, mark `true`
  - [x] Return array of `TemplateOverlapItem` sorted by `templateCount` desc, then `documentTitle` asc

- [x] **Task 2: Create overlap page** (AC: 1)
  - [x] Create `app/admin/(dashboard)/templates/overlap/page.tsx` (server component)
  - [x] Follow existing detail page pattern: `export const dynamic = 'force-dynamic'`, call `getTemplateOverlap()`, pass data to client component
  - [x] Page header: "Dokumentöverlapp" with back link to `/admin/templates` using `<ArrowLeft />` icon
  - [x] Display summary stats: total overlapping documents, total inconsistencies count
  - [x] Empty state: if no overlapping documents exist, show a centered message: "Inga dokument finns i fler än en mall" with a link back to templates list. Do not render the table component in this case.
  - [x] Add "Överlapp" link on the templates list page (`app/admin/(dashboard)/templates/page.tsx`) — a `<Link>` to `/admin/templates/overlap` rendered above or below the template table header, e.g., "Visa dokumentöverlapp →". Do NOT modify the admin sidebar — adding nested nav would require refactoring the sidebar component.

- [x] **Task 3: Build overlap table component** (AC: 2, 3)
  - [x] Create `components/admin/template-overlap-table.tsx` (client component, `'use client'`)
  - [x] Props: `data: TemplateOverlapItem[]` (serialized from server — dates as strings if any)
  - [x] Table columns:
    - **Dokument**: document title (text)
    - **SFS/AFS**: `documentNumber` (text)
    - **Mallar**: template names as `<Badge>` components (one per template)
    - **Antal mallar**: `templateCount` (number)
    - **Status**: inconsistency indicator — `<AlertTriangle />` icon (from lucide-react) with "Inkonsekvent" text if `isInconsistent`, otherwise `<CheckCircle2 />` with "Konsekvent"
  - [x] Expandable rows: clicking a row toggles an expansion panel showing side-by-side compliance summaries from each template
    - Use a `useState<Set<string>>` for `expandedDocIds`
    - Expansion panel: grid layout (1 column per template) with template name header + compliance summary text + expert commentary text (collapsed/expandable, secondary to summary) + `ContentStatusBadge` (reuse from `components/admin/content-status-badge.tsx`). Show both fields since the sync action (Task 4) copies both — the admin needs to compare both before deciding to sync.
  - [x] Filter toggle: "Visa bara inkonsekvenser" checkbox — filter `data` to only `isInconsistent === true` items
  - [x] Use shadcn/ui `<Table>`, `<Badge>`, `<Checkbox>` components

- [x] **Task 4: Implement sync summaries server action** (AC: 5)
  - [x] Add `syncTemplateSummaries(documentId, sourceTemplateId, targetTemplateIds)` to `app/actions/admin-templates.ts`
  - [x] Follow existing server action pattern exactly:
    1. `getAdminSession()` — return error if null
    2. Validate inputs with Zod: `documentId: z.string().uuid()`, `sourceTemplateId: z.string().uuid()`, `targetTemplateIds: z.array(z.string().uuid()).min(1)`
    3. Find source `TemplateItem` by `(document_id, template_id)` — return error if not found
    4. Find target `TemplateItem` records by `(document_id, template_id IN targetTemplateIds)` — return error if any not found
    5. `prisma.$transaction`: update each target item with source's `compliance_summary`, `expert_commentary`, and `content_status`
    6. `revalidatePath('/admin/templates/overlap')` + `revalidatePath` for each affected template detail page
  - [x] Return type: `Promise<{ success: boolean; error?: string; updatedCount?: number }>`
  - [x] Zod schema: `syncSummariesSchema`

- [x] **Task 5: Build sync dialog component** (AC: 5)
  - [x] Add sync UI to `template-overlap-table.tsx` or create `components/admin/sync-summaries-dialog.tsx`
  - [x] "Synka" button on each expanded overlap row (one per document)
  - [x] Dialog (shadcn/ui `<Dialog>` with `<DialogDescription>` for WCAG compliance):
    - Show document title
    - Source template selector: `<Select>` dropdown listing templates this document appears in, with compliance summary preview of the selected source
    - Target templates: `<Checkbox>` list of the other templates (pre-checked)
    - "Synka sammanfattningar" confirm button
  - [x] Use `useTransition` for non-blocking server action call
  - [x] Toast notification on success: `toast.success("Sammanfattningar synkade för X mallar")` via `sonner`
  - [x] On success, refresh data (either `router.refresh()` or re-fetch)

- [x] **Task 6: Write tests** (AC: all)
  - [x] **Overlap query tests** (`tests/unit/lib/admin/template-overlap-queries.test.ts`):
    - Documents in 2+ templates are returned
    - Documents in only 1 template are excluded
    - `isInconsistent` is `true` when summaries differ across templates
    - `isInconsistent` is `false` when summaries are identical
    - Empty result when no overlapping documents exist
  - [x] **Sync action tests** (extend `tests/unit/components/admin/admin-template-actions.test.ts`):
    - Sync copies `compliance_summary` and `expert_commentary` from source to target
    - Sync updates `content_status` on target items
    - Sync fails if source item not found
    - Sync fails if target items don't exist
    - Auth check: returns error when not authenticated
  - [x] **Component test** (`tests/unit/components/admin/template-overlap-table.test.tsx`):
    - Renders correct number of rows for overlapping documents
    - Shows inconsistency indicator on inconsistent rows
    - Filter toggle hides consistent rows
    - Expanding a row shows per-template summaries

## Dev Notes

### Previous Story Insights (Story 12.7b)

Story 12.7b is complete (Done). Key learnings from Dev Agent Record: [Source: docs/stories/completed/12.7b.template-content-editor-review.md#Dev Agent Record]

- **ContentStatusBadge extracted**: Shared component at `components/admin/content-status-badge.tsx` — reuse it for the overlap table's expansion panel.
- **Server action pattern firmly established**: All 8 actions in `app/actions/admin-templates.ts` follow the same pattern: `getAdminSession()` → `findFirst` for admin user → Zod validation → entity check → Prisma operation → `revalidatePath()` → try/catch. Follow this exactly.
- **`$transaction` for multi-row updates**: When updating multiple rows with the same values, `updateMany` is fine. When updating multiple rows with potentially different per-row values, use `$transaction` with individual updates.
- **`exactOptionalPropertyTypes` active**: Optional props need explicit `| undefined` annotations when passed from parent components (e.g., `selectedItemIds?: Set<string> | undefined`).
- **No ActivityLog**: Templates are admin-level entities without workspace context — use plain Prisma operations. [Source: Story 12.7a Dev Agent Record]
- **77 unit tests pass** across 6 test files in the template area.

### Implementation Context (Decision B — FE First with Mock Data)

This story is built **before** templates are seeded. Use mock/stub template data during development and testing. The overlap viewer requires at least 2 templates with shared documents to be meaningful — create test fixtures accordingly. Real overlap data will appear once seeding stories are completed after ingestion is fixed. [Source: docs/epics/epic-12-law-list-templates.md#Decision B]

### Data Models

[Source: prisma/schema.prisma — also documented in docs/stories/completed/12.7b.template-content-editor-review.md#Dev Notes]

**TemplateItem (primary model for overlap queries):**
```prisma
model TemplateItem {
  id                          String                    @id @default(uuid())
  template_id                 String
  section_id                  String
  document_id                 String
  index                       String
  position                    Float                     @default(0)
  compliance_summary          String?                   @db.Text
  expert_commentary           String?                   @db.Text
  source_type                 String?
  regulatory_body             String?
  last_amendment              String?
  replaces_old_reference      String?
  is_service_company_relevant Boolean                   @default(true)
  variant_section_override    String?
  cross_list_references       String[]
  content_status              TemplateItemContentStatus @default(STUB)
  generated_by                String?
  reviewed_by                 String?
  reviewed_at                 DateTime?
  created_at                  DateTime                  @default(now())
  updated_at                  DateTime                  @updatedAt

  template LawListTemplate @relation(...)
  section  TemplateSection @relation(...)
  document LegalDocument   @relation(...)
}
```

**Key constraint:** `@@unique([template_id, document_id])` — each document can only appear once per template. This means the overlap query is: find `document_id` values that appear across **different** `template_id` values.

**LawListTemplate:**
```prisma
model LawListTemplate {
  id        String         @id @default(uuid())
  name      String
  slug      String         @unique
  status    TemplateStatus @default(DRAFT)
  // ... other fields
}
```

**Enums:**
```prisma
enum TemplateItemContentStatus { STUB, AI_GENERATED, HUMAN_REVIEWED, APPROVED }
```

### Overlap Query Strategy

The `cross_list_references` field on TemplateItem stores which template slugs a document also appears in, but the **overlap query should use the database directly** for accuracy (cross_list_references may be stale). [Source: docs/epics/epic-12-law-list-templates.md#Story 12.7c]

**SQL approach:**
```sql
SELECT document_id, COUNT(DISTINCT template_id) as template_count
FROM template_items
GROUP BY document_id
HAVING COUNT(DISTINCT template_id) >= 2
```

**Prisma approach** (two steps):
1. `prisma.templateItem.groupBy({ by: ['document_id'], _count: { template_id: true }, having: { template_id: { _count: { gte: 2 } } } })` — Prisma supports `having` in `groupBy` since v4.8 (project uses v6.19)
2. Then fetch full item details for the overlapping `document_id` values

**Defensive fallback** (if `having` causes unexpected issues at runtime):
1. `groupBy` all document_ids with `_count: true`
2. Filter in JS: `result.filter(r => r._count >= 2)`
3. Fetch full items for those document_ids

### Inconsistency Detection

For MVP, simple string comparison is sufficient. If `compliance_summary` values are identical across all templates for a document, it's consistent. If any differ, flag as inconsistent. [Source: docs/epics/epic-12-law-list-templates.md#Story 12.7c]

Implementation: compare all `compliance_summary` strings in each group. If `new Set(summaries).size > 1`, it's inconsistent. Handle `null` summaries: two `null` values are "consistent" (both empty), but `null` vs a non-null string is "inconsistent".

### Overlap Data (Expected)

From the cross-list analysis: [Source: data/notisum-amnesfokus/analysis/10-cross-list-analysis.md]
- 22 documents shared between Arbetsmiljö and Miljö
- Additional overlaps with future templates (Fastighet-Bygg, etc.)

### Existing Admin Patterns — Exact Codebase References

**Server action pattern:** [Source: app/actions/admin-templates.ts]
- `'use server'` directive
- Return type: `Promise<{ success: boolean; error?: string }>`
- Step 1: `getAdminSession()` — return error if null
- Step 2: Validate input with Zod `safeParse()`
- Step 3: Check entity exists
- Step 4: Prisma operation (use `$transaction` for multi-table updates)
- Step 5: `revalidatePath()` for affected pages
- Wrap in try/catch, return generic error message

**Detail page (server component) pattern:** [Source: app/admin/(dashboard)/templates/[id]/page.tsx]
- `export const dynamic = 'force-dynamic'`
- Call query function, pass data to client component
- Back link with `<ArrowLeft />` icon from lucide-react

**Client component pattern:** [Source: components/admin/template-detail-client.tsx]
- `'use client'` directive
- `useTransition` for non-blocking server action calls
- Toast notifications via `sonner` (`toast.success()`, `toast.error()`)

**Query pattern:** [Source: lib/admin/template-queries.ts]
- Defined interfaces for return types
- Selective field fetching with `select`
- Include relations as needed
- All queries exported from `lib/admin/template-queries.ts`

**Constants pattern:** [Source: lib/admin/constants.ts]
- `CONTENT_STATUS_LABELS: Record<TemplateItemContentStatus, string>` — STUB → "Stub", AI_GENERATED → "AI-genererad", HUMAN_REVIEWED → "Granskad", APPROVED → "Godkänd"
- `CONTENT_STATUS_VARIANT: Record<TemplateItemContentStatus, BadgeVariant>` — STUB → "secondary", AI_GENERATED → "default", HUMAN_REVIEWED → "outline", APPROVED → "default" (with `className="bg-green-100 text-green-800"` override for green)

**Admin sidebar:** [Source: components/admin/admin-sidebar.tsx]
- Navigation items array with `{ href, label, icon }` objects
- Current Templates link: `{ href: '/admin/templates', label: 'Templates', icon: FileText }`
- Uses `usePathname()` for active state
- Adding "Overlap" as a sidebar sub-item would require refactoring to support nested nav — **prefer adding a link on the templates list page instead** (simpler, no sidebar changes)

**WCAG compliance:** All Radix UI dialogs must include `<DialogDescription>`. [Source: Story 12.7a QA]

### Relevant Source Tree

```
# New files
app/admin/(dashboard)/templates/overlap/page.tsx  # Overlap page (server component)
components/admin/template-overlap-table.tsx        # Overlap table (client component)
components/admin/sync-summaries-dialog.tsx         # Sync dialog (client component, optional — can inline)

# Modified files
app/actions/admin-templates.ts                     # Add syncTemplateSummaries action
lib/admin/template-queries.ts                      # Add getTemplateOverlap() query + TemplateOverlapItem interface
app/admin/(dashboard)/templates/page.tsx            # Add "Överlapp" link

# Test files
tests/unit/lib/admin/template-overlap-queries.test.ts  # Overlap query tests
tests/unit/components/admin/template-overlap-table.test.tsx  # Component tests
tests/unit/components/admin/admin-template-actions.test.ts   # Extend with sync action tests
```

### Technical Constraints

- **TypeScript:** 5.5+ strict mode, `exactOptionalPropertyTypes: true` [Source: docs/architecture/17-coding-standards.md#17.2]
- **UI Library:** shadcn/ui (Radix UI + Tailwind) — mandatory for all UI components [Source: docs/architecture/17-coding-standards.md#17.3]
- **ORM:** Prisma 6.x with type-safe queries (project uses `^6.19.0`; architecture doc says "5.12+" but is outdated) [Source: package.json, docs/architecture/3-tech-stack.md#3.1]
- **Validation:** Zod 3.22+ for all server action inputs [Source: docs/architecture/3-tech-stack.md#3.1]
- **Icons:** Lucide Icons 0.365+ — use `AlertTriangle`, `CheckCircle2`, `ArrowLeft` [Source: docs/architecture/3-tech-stack.md#3.1]
- **Date formatting:** date-fns 3.3+ with `sv` locale [Source: docs/architecture/3-tech-stack.md#3.1]
- **Package manager:** pnpm [Source: docs/architecture/3-tech-stack.md#3.1]
- **Next.js 16:** `searchParams` and `params` are Promises that must be awaited [Source: docs/architecture/12-nextjs-16-migration-notes.md]
- **No ActivityLog:** Templates are admin-level entities without workspace context [Source: Story 12.7a Dev Agent Record]

### Testing

- **Test framework:** Vitest 1.4+ with React Testing Library 14.2+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Test config:** `vitest.config.mts` — environment: `happy-dom`, setup: `tests/setup.ts` [Source: docs/architecture/section-15-summary.md#16.7]
- **Test location:** `tests/unit/lib/admin/`, `tests/unit/components/admin/`
- **Mocking strategy:** Use `vi.fn()` and `vi.mock()`. Do NOT make real DB calls in unit tests. [Source: docs/architecture/section-15-summary.md#16.6]
- **Tests needed:**
  - Overlap query: documents in 2+ templates returned, 1-template docs excluded, inconsistency detection correct
  - Sync action: copies both fields, updates content_status, auth check, entity validation
  - Component: renders rows, inconsistency icons, filter toggle, expandable summaries

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Added mock data context per Decision B (FE first, seeding deferred) | Sarah (PO) |
| 2026-02-09 | 2.0     | SM enrichment: full architecture context with source references, previous story insights from 12.7b, exact admin codebase patterns (server actions, queries, page structure, constants, sidebar navigation), Prisma model definitions, overlap query strategy (Prisma groupBy + having), inconsistency detection algorithm, sync action specification, expanded tasks with specific implementation details and file locations, testing strategy with test cases | Bob (SM) |
| 2026-02-09 | 2.1     | PO validation fixes: (S-1) corrected Prisma version from 5.x to 6.x per package.json; (S-2) made Task 2 navigation definitive — link on templates list page only, no sidebar modification; (S-3) removed contradictory "Prisma doesn't support HAVING" claim, clarified having is supported since v4.8; (N-1) added empty state UI guidance for zero overlapping documents; (N-2) added expert_commentary to expandable comparison panel alongside compliance_summary | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No issues encountered during implementation.

### Completion Notes
- All 6 tasks implemented and verified
- `npx tsc --noEmit` passes with zero type errors
- 97 unit test files pass (1378 tests) — full regression clean
- 7 pre-existing integration test failures (DB FK constraints, unrelated to this story)
- `TemplateOverlapEntry` interface extracted separately for reuse by the sync dialog
- Prisma `groupBy` with `having` works as expected (v6.19)
- Inconsistency detection uses `Set` size comparison on `compliance_summary` values — `null` vs string is treated as inconsistent
- Sync dialog pre-selects first template as source and all others as targets for quick workflow

### File List

**New files:**
- `app/admin/(dashboard)/templates/overlap/page.tsx` — Overlap page (server component)
- `components/admin/template-overlap-table.tsx` — Overlap table (client component)
- `components/admin/sync-summaries-dialog.tsx` — Sync dialog (client component)
- `tests/unit/lib/admin/template-overlap-queries.test.ts` — Overlap query tests (7 tests)
- `tests/unit/components/admin/template-overlap-table.test.tsx` — Component tests (7 tests)

**Modified files:**
- `lib/admin/template-queries.ts` — Added `TemplateOverlapItem`, `TemplateOverlapEntry` interfaces and `getTemplateOverlap()` query
- `app/actions/admin-templates.ts` — Added `syncSummariesSchema` and `syncTemplateSummaries()` server action
- `app/admin/(dashboard)/templates/page.tsx` — Added "Visa dokumentöverlapp" link
- `tests/unit/components/admin/admin-template-actions.test.ts` — Added 6 sync action tests, `findFirst` mock

### Change Log

| Date | Change | Details |
|------|--------|---------|
| 2026-02-09 | Implementation complete | All 6 tasks implemented, 20 new tests added, full regression passes |

## QA Results

_To be populated by QA agent_
