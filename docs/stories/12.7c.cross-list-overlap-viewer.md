# Story 12.7c: Cross-List Overlap Viewer

## Status

Draft

## Story

**As an** admin,
**I want** to see which documents appear across multiple templates and identify inconsistencies,
**so that** I can maintain consistency in compliance summaries across the catalog.

## Acceptance Criteria

1. Admin route: `/admin/templates/overlap`
2. Table showing all documents that appear in 2+ templates
3. For each shared document: list of templates it belongs to, compliance summary preview per template
4. Highlight inconsistencies: flag documents where compliance summaries differ significantly across templates
5. "Sync summaries" action: copy compliance summary from one template to another for shared documents

## Tasks / Subtasks

- [ ] **Task 1: Create overlap page** (AC: 1)
  - [ ] Create `app/admin/(dashboard)/templates/overlap/page.tsx`
  - [ ] Add "Overlap" link in templates section (sub-navigation or sidebar sub-item)
- [ ] **Task 2: Build overlap query** (AC: 2, 3)
  - [ ] Query: find all `document_id` values that appear in 2+ TemplateItem records across different templates
  - [ ] For each shared document: join with LegalDocument for title/number, and TemplateItem for per-template compliance summary
  - [ ] Add to `lib/admin/template-queries.ts`: `getTemplateOverlap()`
- [ ] **Task 3: Build overlap table** (AC: 2, 3)
  - [ ] Create `components/admin/template-overlap-table.tsx`
  - [ ] Columns: document title, SFS/AFS number, templates (badges), summary previews
  - [ ] Expandable rows: show full compliance summary from each template side-by-side
- [ ] **Task 4: Implement inconsistency detection** (AC: 4)
  - [ ] Compare compliance summaries across templates for each shared document
  - [ ] Flag as "inconsistent" if summaries differ (basic string comparison, or more sophisticated diff)
  - [ ] Visual indicator: warning icon on inconsistent rows
  - [ ] Filter: "Show only inconsistencies"
- [ ] **Task 5: Implement sync action** (AC: 5)
  - [ ] "Sync summaries" button on each shared document row
  - [ ] Dialog: select source template → target template(s)
  - [ ] Server action: `syncTemplateSummaries(documentId, sourceTemplateId, targetTemplateIds)`
  - [ ] Copies both `compliance_summary` and `expert_commentary`
  - [ ] Updates `content_status` on target to match source
- [ ] **Task 6: Write tests** (AC: all)
  - [ ] Unit test: overlap query finds documents in 2+ templates
  - [ ] Unit test: inconsistency detection flags different summaries
  - [ ] Integration test: sync action copies summaries correctly

## Dev Notes

### Implementation Context (Decision B — FE First with Mock Data)

This story is built **before** templates are seeded. Use mock/stub template data during development and testing. The overlap viewer requires at least 2 templates with shared documents to be meaningful — create test fixtures accordingly. Real overlap data will appear once seeding stories are completed after ingestion is fixed.

### Overlap Data

From the cross-list analysis (`data/notisum-amnesfokus/analysis/10-cross-list-analysis.md`):
- 22 documents shared between Arbetsmiljö and Miljö
- Additional overlaps with future templates (Fastighet-Bygg, etc.)

The `cross_list_references` field on TemplateItem stores which template slugs a document also appears in, but the overlap query should use the database directly for accuracy.

### SQL Approach for Overlap

```sql
SELECT document_id, COUNT(DISTINCT template_id) as template_count
FROM template_items
GROUP BY document_id
HAVING COUNT(DISTINCT template_id) >= 2
```

### Inconsistency Detection

For MVP, simple string comparison is sufficient. If summaries are identical, they're consistent. If different, flag for review. Future enhancement: use LLM to assess semantic similarity.

### Admin Navigation

Add "Overlap" as a sub-link under Templates in the admin sidebar, or as a tab on the templates list page.

### Relevant Source Tree

```
app/admin/(dashboard)/templates/overlap/page.tsx  # New page
components/admin/template-overlap-table.tsx        # New component
lib/admin/template-queries.ts                      # Add overlap query
app/actions/admin-templates.ts                     # Add sync action
```

### Testing

- **Test framework:** Vitest 1.4+
- **Test location:** `tests/unit/lib/admin/`, `tests/unit/components/admin/`
- **Tests needed:**
  - Overlap query returns correct documents (those in 2+ templates)
  - Inconsistency flag set when summaries differ
  - Sync action copies summary from source to target correctly
  - Sync action updates content_status on target

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Added mock data context per Decision B (FE first, seeding deferred) | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
