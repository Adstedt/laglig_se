# Story 3.10: Implement Chat History and Session Management

## Status

Draft

## Story

**As a** user,
**I want** my chat history saved,
**so that** I can reference previous conversations.

## Acceptance Criteria

1. Chat messages stored in `chat_messages` table: id, workspace_id, user_id, role (user/assistant), content, created_at
2. Chat sidebar loads last 20 messages on open
3. Infinite scroll to load older messages
4. Messages grouped by date ("Today", "Yesterday", "Last week")
5. User can delete individual messages or clear entire history
6. Chat history scoped to workspace (multi-tenancy in Epic 5)
7. Search within chat history (keyword search)
8. Export chat history as PDF or text file
9. Privacy: Chat history deleted if workspace deleted (Epic 5 soft-delete cascade)

## Tasks / Subtasks

- [ ] Create chat_messages table schema
- [ ] Implement message persistence
- [ ] Add infinite scroll for history
- [ ] Group messages by date
- [ ] Add delete functionality
- [ ] Implement chat search
- [ ] Add export feature

## Dev Notes

**Schema:**

```prisma
model ChatMessage {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  role        String   // "user" or "assistant"
  content     String   @db.Text
  metadata    Json?    // citations, context, etc.
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId, createdAt])
  @@map("chat_messages")
}
```

**Load Messages:**

```typescript
async function loadChatHistory(workspaceId: string, limit = 20, offset = 0) {
  return await prisma.chatMessage.findMany({
    where: { workspaceId },
    orderBy: { createdAt: 'desc' },
    take: limit,
    skip: offset,
  })
}
```

**Reference:** Epic 5 (multi-tenancy), Architecture Section 9 (DB schema)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
