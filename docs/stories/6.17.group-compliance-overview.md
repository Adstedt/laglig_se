# Story 6.17: Group Compliance Overview Indicators

## Status

Ready for Review

## Story

**As a** compliance user viewing grouped law lists,
**I want** to see aggregated compliance status and priority risk indicators in each group header,
**so that** I can quickly assess overall compliance health and risk level per group without expanding individual sections.

## Background / Problem

Currently, the grouped accordion view (Story 6.14) shows only the document count per group (e.g., "4 dokument"). Users must expand each group and scan individual rows to understand:

- How well the group is performing compliance-wise
- Which groups have high-priority unresolved items

By adding visual indicators to the group header, users can:

- Instantly identify groups needing attention
- Prioritize their compliance review efforts
- Get a "dashboard-like" overview at the list level

## Acceptance Criteria

### 1. Compliance Progress Indicator

1. Display a compliance progress indicator in the group header, positioned to the left of the document count badge
2. Calculation excludes `EJ_TILLAMPLIG` (not applicable) items from both numerator and denominator
3. Show: `{compliant_count}/{applicable_count}` format (e.g., "2/3")
4. Include a small progress bar (inline, `w-12 h-1`) matching the TasksAccordion pattern
5. Progress bar color coding:
   - 100% compliant (all `UPPFYLLD`): Green (`bg-green-500`)
   - 50-99%: Blue (`bg-blue-500`)
   - 1-49%: Amber (`bg-amber-500`)
   - 0%: Red (`bg-red-500`)
6. If all items are `EJ_TILLAMPLIG`, show "—" with muted styling (no applicable items to track)

**Design Reference:** Reuse the exact progress bar pattern from `TasksAccordion` (lines 331-344):

```tsx
<div className="flex items-center gap-2">
  <span className="text-xs text-muted-foreground tabular-nums">2/3</span>
  <div className="w-12 h-1 bg-muted rounded-full overflow-hidden">
    <div
      className="h-full bg-green-500 rounded-full transition-all duration-300"
      style={{ width: `${percentage}%` }}
    />
  </div>
</div>
```

### 2. Priority Risk Indicator

7. Display a priority risk indicator after the compliance progress, before the document count
8. Show priority distribution as compact badges: count per level with color coding
9. Badge format: `{count} Hög` (rose), `{count} Medel` (amber), `{count} Låg` (slate)
10. Only show badges for non-zero counts (e.g., if no HIGH priority items, don't show "0 Hög")
11. Exclude `EJ_TILLAMPLIG` items from priority counts (they don't contribute to risk)
12. If all items are `EJ_TILLAMPLIG`, show "—" for priority (no applicable items)

### 3. Visual Layout

13. New indicators positioned between group name and document count badge
14. Layout order (left to right): `[Chevron] [Folder] [Name] [Compliance Progress] [Priority Badges] [Document Count]`
15. Responsive: On mobile (< sm), hide priority badges and show only compliance fraction (no progress bar)
16. Indicators use consistent spacing (`gap-2` or `gap-3`) with existing header elements
17. Progress bar has subtle rounded corners (`rounded-full`) matching existing badge styles

### 4. Tooltip Information

18. Compliance progress has tooltip showing breakdown:
    ```
    Efterlevnadsstatus
    • Uppfylld: 2
    • Delvis uppfylld: 1
    • Ej uppfylld: 0
    • Ej påbörjad: 0
    • Ej tillämplig: 2 (exkluderade)
    ```
19. Priority section has tooltip showing full breakdown:
    ```
    Prioritetsnivåer (tillämpliga dokument)
    • Hög: 1
    • Medel: 2
    • Låg: 0
    ```

### 5. Performance

20. Calculations done client-side from items already loaded in memory (no additional API calls)
21. Use `useMemo` to prevent recalculation on every render
22. Indicators update instantly when item compliance/priority changes (optimistic UI)

## Tasks / Subtasks

- [x] **Task 1: Create GroupComplianceIndicator component** (AC: 1-6, 18)
  - [x] Create `components/features/document-list/group-compliance-indicator.tsx`
  - [x] Accept `items: DocumentListItem[]` prop
  - [x] Calculate applicable items (exclude `EJ_TILLAMPLIG`)
  - [x] Calculate compliant count (`UPPFYLLD`)
  - [x] **IMPORTANT:** Reuse exact progress bar pattern from `tasks-accordion.tsx:331-344`
  - [x] Render fraction: `text-xs text-muted-foreground tabular-nums`
  - [x] Render progress bar: `w-12 h-1 bg-muted rounded-full overflow-hidden`
  - [x] Color code progress bar based on percentage (green/blue/amber/red)
  - [x] Handle edge case: all items `EJ_TILLAMPLIG` (show "—")
  - [x] Add tooltip with full status breakdown using shadcn Tooltip

- [x] **Task 2: Create GroupPriorityIndicator component** (AC: 7-12, 19)
  - [x] Create `components/features/document-list/group-priority-indicator.tsx`
  - [x] Accept `items: DocumentListItem[]` prop
  - [x] Calculate priority distribution (excluding `EJ_TILLAMPLIG`)
  - [x] Render compact badges for non-zero counts
  - [x] Use existing priority color scheme (rose for HIGH, amber for MEDIUM, slate for LOW)
  - [x] Handle edge case: all items `EJ_TILLAMPLIG` (show "—")
  - [x] Add tooltip with full priority breakdown

- [x] **Task 3: Integrate indicators into GroupTableSection** (AC: 13-17)
  - [x] Modify `components/features/document-list/group-table-section.tsx`
  - [x] Import new indicator components
  - [x] Position indicators between name and document count badge
  - [x] Ensure responsive behavior (hide priority badges on mobile)
  - [x] Verify spacing matches existing header design

- [x] **Task 4: Update GroupedDocumentList (card view) for consistency** (AC: 13-17)
  - [x] Modify `components/features/document-list/grouped-document-list.tsx`
  - [x] Add same indicators to card view accordion headers
  - [x] Ensure visual consistency between table and card views

- [x] **Task 5: Unit tests** (AC: 1-12, 20-22)
  - [x] Create `tests/unit/components/features/document-list/group-compliance-indicator.test.tsx`
  - [x] Create `tests/unit/components/features/document-list/group-priority-indicator.test.tsx`
  - [x] Test calculation logic with various item distributions
  - [x] Test edge cases: empty group, all EJ_TILLAMPLIG, single item
  - [x] Test color coding thresholds
  - [x] Test responsive rendering (mobile vs desktop)
  - [x] Target: 60-70% coverage for new components

- [ ] **Task 6: Manual testing and polish**
  - [ ] Verify indicators appear correctly in grouped table view
  - [ ] Verify indicators appear correctly in grouped card view
  - [ ] Test on mobile viewport (indicators hide appropriately)
  - [ ] Verify tooltips display correct information
  - [ ] Verify instant updates when changing item status/priority

## Dev Notes

### Previous Story Insights (Stories 6.14 & 6.16)

From the completed Story 6.16 (Law List UX Tooltips):

- Tooltip patterns established using shadcn Tooltip with TooltipProvider wrapper
- **Rich tooltip content supported:** shadcn's `TooltipContent` accepts any JSX children, enabling multi-line tooltips with titles and bullet lists (see implementation pattern below)
- Color coding for status/priority already defined in `COMPLIANCE_STATUS_OPTIONS` and `PRIORITY_OPTIONS`
- Swedish localization patterns for UI labels

From Story 6.14 (Grouped Accordion Table View):

- `GroupTableSection` component handles each collapsible group
- Items array already available in props (`items: DocumentListItem[]`)
- Header layout uses flexbox with `gap-2 sm:gap-3` spacing
- Mobile responsiveness uses `sm:` breakpoint for visibility toggles

### Architecture References

**UI Standards:** [Source: docs/architecture/17-coding-standards.md#17.3]

- Use shadcn/ui components: Tooltip, Progress from `@/components/ui/`
- Client Components with `"use client"` directive for interactive elements
- Lucide icons for consistent iconography

**Tech Stack:** [Source: docs/architecture/3-tech-stack.md#3.1]

- React 19 with Next.js 16 App Router
- shadcn/ui (Radix UI + Tailwind) for accessible UI primitives
- Vitest 1.4+ with React Testing Library 14.2+ for testing

**Component Organization:** [Source: docs/architecture/12-unified-project-structure.md#12.2]

- Feature components in `components/features/{feature-name}/`
- UI primitives in `components/ui/`
- Tests mirror source structure in `tests/unit/components/`

### File Locations [Source: docs/architecture/12-unified-project-structure.md]

**Files to Create:**

```
components/features/document-list/
├── group-compliance-indicator.tsx    # AC 1-6, 18
└── group-priority-indicator.tsx      # AC 7-12, 19

tests/unit/components/features/document-list/
├── group-compliance-indicator.test.tsx
└── group-priority-indicator.test.tsx
```

**Files to Modify:**

```
components/features/document-list/
├── group-table-section.tsx           # AC 13-17 - Add indicators to header
└── grouped-document-list.tsx         # AC 13-17 - Add indicators to card view
```

### Data Model Reference

[Source: prisma/schema.prisma]

**ComplianceStatus enum:**

```prisma
enum ComplianceStatus {
  EJ_PABORJAD    // "Ej påbörjad" - Not started
  PAGAENDE       // "Delvis uppfylld" - Partially compliant (UI label updated in 6.16)
  UPPFYLLD       // "Uppfylld" - Compliant
  EJ_UPPFYLLD    // "Ej uppfylld" - Non-compliant
  EJ_TILLAMPLIG  // "Ej tillämplig" - Not applicable (excluded from calculations)
}
```

**LawListItemPriority enum:**

```prisma
enum LawListItemPriority {
  LOW     // "Låg"
  MEDIUM  // "Medel"
  HIGH    // "Hög"
}
```

### Required Imports (Reuse Existing Constants)

Import existing constants to ensure consistency with established patterns:

```typescript
// For status labels, colors, and tooltips
import { COMPLIANCE_STATUS_OPTIONS } from '@/components/features/document-list/table-cell-editors/compliance-status-editor'

// For priority labels, colors, and tooltips
import { PRIORITY_OPTIONS } from '@/components/features/document-list/table-cell-editors/priority-editor'

// For DocumentListItem type
import type { DocumentListItem } from '@/app/actions/document-list'
```

### Calculation Logic

**Compliance Progress:**

```typescript
const applicableItems = items.filter(
  (i) => i.complianceStatus !== 'EJ_TILLAMPLIG'
)
const compliantItems = applicableItems.filter(
  (i) => i.complianceStatus === 'UPPFYLLD'
)
const percentage =
  applicableItems.length > 0
    ? (compliantItems.length / applicableItems.length) * 100
    : null // null = no applicable items
```

**Priority Distribution:**

```typescript
const applicableItems = items.filter(
  (i) => i.complianceStatus !== 'EJ_TILLAMPLIG'
)
const priorityCounts = {
  HIGH: applicableItems.filter((i) => i.priority === 'HIGH').length,
  MEDIUM: applicableItems.filter((i) => i.priority === 'MEDIUM').length,
  LOW: applicableItems.filter((i) => i.priority === 'LOW').length,
}
```

### Existing Progress Bar Pattern (REUSE STRUCTURE, EXTEND COLORS)

[Source: components/features/document-list/legal-document-modal/tasks-accordion.tsx:331-344]

The TasksAccordion component has the progress indicator **structure and sizing** to reuse. The color coding is **extended** for this story to reflect compliance percentage thresholds (the original only uses `bg-green-500`):

```tsx
{
  /* Progress indicator */
}
{
  totalCount > 0 && (
    <div className="flex items-center gap-2 ml-auto mr-2 font-normal">
      <span className="text-xs text-muted-foreground tabular-nums">
        {totalCount - activeCount}/{totalCount}
      </span>
      <div className="w-12 h-1 bg-muted rounded-full overflow-hidden">
        <div
          className="h-full bg-green-500 rounded-full transition-all duration-300"
          style={{ width: `${progressPercent}%` }}
        />
      </div>
    </div>
  )
}
```

**Key design elements:**

- Fraction: `text-xs text-muted-foreground tabular-nums` (tabular-nums ensures consistent width)
- Progress container: `w-12 h-1 bg-muted rounded-full overflow-hidden`
- Progress fill: `h-full rounded-full transition-all duration-300`
- Gap: `gap-2` between fraction and bar

### Existing Color Patterns

[Source: components/features/document-list/table-cell-editors/priority-editor.tsx]

```typescript
const PRIORITY_COLORS = {
  HIGH: 'bg-rose-100 text-rose-700 border-rose-200', // Hög
  MEDIUM: 'bg-amber-100 text-amber-700 border-amber-200', // Medel
  LOW: 'bg-slate-100 text-slate-600 border-slate-200', // Låg
}
```

### Implementation Patterns

**Memoized calculation:**

```typescript
const { compliantCount, applicableCount, percentage } = useMemo(() => {
  const applicable = items.filter((i) => i.complianceStatus !== 'EJ_TILLAMPLIG')
  const compliant = applicable.filter((i) => i.complianceStatus === 'UPPFYLLD')
  return {
    compliantCount: compliant.length,
    applicableCount: applicable.length,
    percentage:
      applicable.length > 0
        ? (compliant.length / applicable.length) * 100
        : null,
  }
}, [items])
```

**Compliance Progress Component (adapted from TasksAccordion pattern):**

```tsx
// Based on tasks-accordion.tsx:331-344 pattern
const { compliantCount, applicableCount, percentage } = useMemo(() => {
  const applicable = items.filter((i) => i.complianceStatus !== 'EJ_TILLAMPLIG')
  const compliant = applicable.filter((i) => i.complianceStatus === 'UPPFYLLD')
  return {
    compliantCount: compliant.length,
    applicableCount: applicable.length,
    percentage:
      applicable.length > 0
        ? (compliant.length / applicable.length) * 100
        : null,
  }
}, [items])

const getProgressColor = (pct: number | null) => {
  if (pct === null) return 'bg-muted'
  if (pct === 100) return 'bg-green-500'
  if (pct >= 50) return 'bg-blue-500'
  if (pct > 0) return 'bg-amber-500'
  return 'bg-red-500'
}

// Render (matching TasksAccordion exactly):
{
  applicableCount > 0 ? (
    <div className="flex items-center gap-2">
      <span className="text-xs text-muted-foreground tabular-nums">
        {compliantCount}/{applicableCount}
      </span>
      <div className="w-12 h-1 bg-muted rounded-full overflow-hidden">
        <div
          className={cn(
            'h-full rounded-full transition-all duration-300',
            getProgressColor(percentage)
          )}
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  ) : (
    <span className="text-xs text-muted-foreground">—</span>
  )
}
```

**Tooltip structure (matching 6.16 pattern):**

```tsx
<Tooltip>
  <TooltipTrigger asChild>
    <div className="...">...</div>
  </TooltipTrigger>
  <TooltipContent side="bottom" className="space-y-2">
    <p className="font-medium text-foreground">Efterlevnadsstatus</p>
    <ul className="text-sm text-muted-foreground space-y-1">
      <li>• Uppfylld: {counts.UPPFYLLD}</li>
      <li>• Delvis uppfylld: {counts.PAGAENDE}</li>
      ...
    </ul>
  </TooltipContent>
</Tooltip>
```

### Optional: Shared Calculation Utility

If calculation logic is needed elsewhere in the future, consider extracting to a shared utility:

```typescript
// lib/utils/compliance-calculations.ts (optional, create only if needed elsewhere)
export function calculateGroupCompliance(items: DocumentListItem[]) {
  const applicable = items.filter((i) => i.complianceStatus !== 'EJ_TILLAMPLIG')
  const compliant = applicable.filter((i) => i.complianceStatus === 'UPPFYLLD')
  return {
    compliantCount: compliant.length,
    applicableCount: applicable.length,
    percentage:
      applicable.length > 0
        ? (compliant.length / applicable.length) * 100
        : null,
  }
}

export function calculateGroupPriority(items: DocumentListItem[]) {
  const applicable = items.filter((i) => i.complianceStatus !== 'EJ_TILLAMPLIG')
  return {
    HIGH: applicable.filter((i) => i.priority === 'HIGH').length,
    MEDIUM: applicable.filter((i) => i.priority === 'MEDIUM').length,
    LOW: applicable.filter((i) => i.priority === 'LOW').length,
  }
}
```

**Note:** For this story, inline the calculations with `useMemo` in each component. Only extract to shared utility if reuse becomes necessary.

## Testing

### Test File Locations [Source: docs/architecture/12-unified-project-structure.md#12.2]

```
tests/unit/components/features/document-list/
├── group-compliance-indicator.test.tsx
└── group-priority-indicator.test.tsx
```

### Testing Standards [Source: docs/architecture/3-tech-stack.md#3.1]

- **Framework:** Vitest 1.4+ with React Testing Library 14.2+
- **Coverage Target:** 60-70% for components
- **Pattern:** Test user behavior, not implementation details

### Unit Tests (Required)

```typescript
describe('GroupComplianceIndicator', () => {
  it('shows correct fraction when some items are compliant', () => {
    // 3 items: 1 UPPFYLLD, 1 PAGAENDE, 1 EJ_PABORJAD -> "1/3"
  })

  it('excludes EJ_TILLAMPLIG items from calculation', () => {
    // 4 items: 1 UPPFYLLD, 1 PAGAENDE, 2 EJ_TILLAMPLIG -> "1/2"
  })

  it('shows "—" when all items are EJ_TILLAMPLIG', () => {
    // 3 items: all EJ_TILLAMPLIG -> "—"
  })

  it('shows green progress bar at 100%', () => {
    // All applicable items are UPPFYLLD
  })

  it('shows blue progress bar at 50-99%', () => {
    // 2 of 3 applicable items are UPPFYLLD (67%)
  })

  it('shows amber progress bar at 1-49%', () => {
    // 1 of 3 applicable items is UPPFYLLD (33%)
  })

  it('shows red progress bar at 0%', () => {
    // 0 of 3 applicable items are UPPFYLLD
  })

  it('displays tooltip with full breakdown on hover')
})

describe('GroupPriorityIndicator', () => {
  it('shows badges for non-zero priority counts', () => {
    // 2 HIGH, 1 MEDIUM, 0 LOW -> shows "2 Hög", "1 Medel", no LOW badge
  })

  it('excludes EJ_TILLAMPLIG items from priority counts')

  it('shows "—" when all items are EJ_TILLAMPLIG')

  it('uses correct color coding for each priority level')

  it('displays tooltip with full breakdown on hover')

  it('hides on mobile viewport')
})
```

### Manual Testing Checklist

1. Create a law list with groups containing mixed compliance statuses
2. Verify compliance progress shows correct fraction and progress bar color
3. Verify priority badges appear with correct counts and colors
4. Change an item from `Ej tillämplig` → `Ej påbörjad` → verify indicators update
5. Change an item's priority → verify priority badges update
6. Test on mobile viewport → verify priority badges hide, compliance fraction shows
7. Hover over compliance indicator → verify tooltip shows full breakdown
8. Hover over priority badges → verify tooltip shows full breakdown
9. Test with empty group → verify graceful handling
10. Test with all `Ej tillämplig` items → verify "—" displays for both indicators

## Change Log

| Date       | Version | Description         | Author   |
| ---------- | ------- | ------------------- | -------- |
| 2026-01-28 | 0.1     | Initial story draft | Bob (SM) |

---

## Definition of Done

- [ ] All acceptance criteria met and verified
- [ ] Compliance progress indicator displays correctly in grouped table view
- [ ] Compliance progress indicator displays correctly in grouped card view
- [ ] Priority risk badges display correctly with proper color coding
- [ ] Calculations exclude `EJ_TILLAMPLIG` items correctly
- [ ] Tooltips show full breakdown information
- [ ] Responsive behavior works (priority badges hide on mobile)
- [ ] Unit tests added and passing (60-70% coverage)
- [ ] No visual regressions in existing group header layout
- [ ] Code follows existing patterns and standards
