# Story 7.4: Implement Employee Compliance Status Calculation

## Status
Draft

## Story

**As an** HR manager,
**I want** to see which employees are compliant,
**so that** I prioritize HR tasks.

## Acceptance Criteria

1. Compliance status calculated per employee:
   - **Compliant:** All required fields filled, kollektivavtal assigned, no missing documents
   - **Needs Attention:** Some missing data (e.g., no kollektivavtal, missing contract document)
   - **Non-Compliant:** Critical missing data (e.g., no employment date, invalid personnummer)
2. Status badge shown in Employee List and Profile
3. Compliance reasons listed: "Missing kollektivavtal assignment", "No contract document uploaded"
4. Dashboard shows compliance summary: "40/50 employees compliant"
5. Filter employees by status
6. Automated reminders to HR Manager when employee status is "Needs Attention" for >7 days
7. Recalculate status whenever employee data changes
8. Performance: Status calculation cached, recomputed only on data change

## Tasks / Subtasks

- [ ] Define compliance rules and status logic
- [ ] Implement compliance calculation function
- [ ] Add status badge to Employee List
- [ ] Add status display to Employee Profile
- [ ] Add compliance reasons to Profile
- [ ] Create dashboard compliance summary widget
- [ ] Implement filter by compliance status
- [ ] Create automated reminder system (cron job)
- [ ] Add status recalculation triggers
- [ ] Optimize performance with caching
- [ ] Test all compliance scenarios
- [ ] Test automated reminders

## Dev Notes

**Compliance Rules:**
```typescript
// lib/hr/compliance-rules.ts
export interface ComplianceCheck {
  field: string
  required: boolean
  validator?: (value: any, employee: any) => boolean
  errorMessage: string
  severity: 'critical' | 'warning'
}

export const COMPLIANCE_RULES: ComplianceCheck[] = [
  // Critical fields (must have for "Compliant" status)
  {
    field: 'name',
    required: true,
    validator: (value) => !!value && value.trim().length > 0,
    errorMessage: 'Name is required',
    severity: 'critical'
  },
  {
    field: 'personnummer',
    required: true,
    validator: (value) => !!value && /^\d{12}$/.test(value.replace(/\D/g, '')),
    errorMessage: 'Valid personnummer is required',
    severity: 'critical'
  },
  {
    field: 'employmentDate',
    required: true,
    validator: (value) => !!value && !isNaN(new Date(value).getTime()),
    errorMessage: 'Employment date is required',
    severity: 'critical'
  },
  {
    field: 'contractType',
    required: true,
    validator: (value) => !!value && ['permanent', 'fixed_term', 'consultant'].includes(value),
    errorMessage: 'Contract type is required',
    severity: 'critical'
  },
  {
    field: 'role',
    required: true,
    validator: (value) => !!value && value.trim().length > 0,
    errorMessage: 'Role is required',
    severity: 'critical'
  },

  // Warning fields (should have for full compliance)
  {
    field: 'kollektivavtal',
    required: false,
    validator: (value, employee) => employee.kollektivavtal && employee.kollektivavtal.length > 0,
    errorMessage: 'No kollektivavtal assigned',
    severity: 'warning'
  },
  {
    field: 'contractDocument',
    required: false,
    validator: (value, employee) => {
      return employee.documents?.some((doc: any) =>
        doc.fileName.toLowerCase().includes('contract') ||
        doc.fileName.toLowerCase().includes('avtal') ||
        doc.fileName.toLowerCase().includes('anställningsavtal')
      )
    },
    errorMessage: 'No contract document uploaded',
    severity: 'warning'
  },
  {
    field: 'email',
    required: false,
    validator: (value) => {
      if (!value) return true // Optional, so null is ok
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)
    },
    errorMessage: 'Invalid email format',
    severity: 'warning'
  },
  {
    field: 'department',
    required: false,
    validator: (value) => !!value && value.trim().length > 0,
    errorMessage: 'Department not specified',
    severity: 'warning'
  }
]

export type ComplianceStatus = 'compliant' | 'needs_attention' | 'non_compliant'

export interface ComplianceResult {
  status: ComplianceStatus
  reasons: string[]
  criticalIssues: number
  warnings: number
  score: number // 0-100
}

export function calculateEmployeeCompliance(employee: any): ComplianceResult {
  const reasons: string[] = []
  let criticalIssues = 0
  let warnings = 0

  for (const rule of COMPLIANCE_RULES) {
    const value = employee[rule.field]
    const isValid = rule.validator ? rule.validator(value, employee) : !!value

    if (!isValid) {
      reasons.push(rule.errorMessage)
      if (rule.severity === 'critical') {
        criticalIssues++
      } else {
        warnings++
      }
    }
  }

  // Calculate score (100 = perfect, 0 = all issues)
  const totalRules = COMPLIANCE_RULES.length
  const passedRules = totalRules - (criticalIssues + warnings)
  const score = Math.round((passedRules / totalRules) * 100)

  // Determine status
  let status: ComplianceStatus
  if (criticalIssues > 0) {
    status = 'non_compliant'
  } else if (warnings > 0) {
    status = 'needs_attention'
  } else {
    status = 'compliant'
  }

  return {
    status,
    reasons,
    criticalIssues,
    warnings,
    score
  }
}
```

**Update Employee Schema:**
```prisma
model Employee {
  // ... existing fields ...

  complianceStatus       String   @default("non_compliant") // compliant, needs_attention, non_compliant
  complianceScore        Int      @default(0) // 0-100
  complianceReasons      Json?    // Array of reason strings
  complianceLastChecked  DateTime @default(now())

  // ... relations ...
}
```

**Update Employee List with Status Badge:**
```typescript
// components/hr/employee-row.tsx (updated)
'use client'

import { ComplianceStatus } from '@/lib/hr/compliance-rules'

interface EmployeeRowProps {
  employee: any
}

export function EmployeeRow({ employee }: EmployeeRowProps) {
  return (
    <tr className="hover:bg-gray-50">
      <td className="px-6 py-4 whitespace-nowrap">
        <div className="flex items-center">
          <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-sm font-bold text-gray-600">
            {employee.photoUrl ? (
              <img
                src={employee.photoUrl}
                alt={employee.name}
                className="w-10 h-10 rounded-full object-cover"
              />
            ) : (
              employee.name
                .split(' ')
                .map((n: string) => n[0])
                .join('')
                .toUpperCase()
            )}
          </div>
          <div className="ml-4">
            <a
              href={`/hr/employees/${employee.id}`}
              className="text-sm font-medium text-gray-900 hover:text-blue-600"
            >
              {employee.name}
            </a>
          </div>
        </div>
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{employee.role}</td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{employee.department || '—'}</td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        {new Date(employee.employmentDate).toLocaleDateString('sv-SE')}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        {employee.contractType === 'permanent'
          ? 'Permanent'
          : employee.contractType === 'fixed_term'
          ? 'Fixed-term'
          : 'Consultant'}
      </td>

      {/* Compliance Status Badge */}
      <td className="px-6 py-4 whitespace-nowrap">
        <ComplianceStatusBadge
          status={employee.complianceStatus}
          score={employee.complianceScore}
        />
      </td>

      <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
        <a
          href={`/hr/employees/${employee.id}`}
          className="text-blue-600 hover:text-blue-900 mr-4"
        >
          View
        </a>
      </td>
    </tr>
  )
}

function ComplianceStatusBadge({ status, score }: { status: ComplianceStatus; score: number }) {
  const config = {
    compliant: {
      bg: 'bg-green-100',
      text: 'text-green-800',
      icon: '✓',
      label: 'Compliant'
    },
    needs_attention: {
      bg: 'bg-yellow-100',
      text: 'text-yellow-800',
      icon: '!',
      label: 'Needs Attention'
    },
    non_compliant: {
      bg: 'bg-red-100',
      text: 'text-red-800',
      icon: '✗',
      label: 'Non-Compliant'
    }
  }

  const { bg, text, icon, label } = config[status]

  return (
    <div className="flex flex-col gap-1">
      <span
        className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${bg} ${text}`}
      >
        <span className="mr-1">{icon}</span>
        {label}
      </span>
      <span className="text-xs text-gray-500">{score}%</span>
    </div>
  )
}
```

**Dashboard Compliance Summary Widget:**
```typescript
// components/dashboard/compliance-summary.tsx
import { prisma } from '@/lib/prisma'
import { withWorkspace } from '@/lib/auth/with-workspace'

export async function ComplianceSummary() {
  const stats = await withWorkspace(async ({ workspaceId }) => {
    const employees = await prisma.employee.findMany({
      where: { workspaceId, status: 'active' },
      select: {
        complianceStatus: true,
        complianceScore: true
      }
    })

    const total = employees.length
    const compliant = employees.filter((e) => e.complianceStatus === 'compliant').length
    const needsAttention = employees.filter((e) => e.complianceStatus === 'needs_attention').length
    const nonCompliant = employees.filter((e) => e.complianceStatus === 'non_compliant').length

    const avgScore =
      total > 0 ? Math.round(employees.reduce((sum, e) => sum + e.complianceScore, 0) / total) : 0

    return { total, compliant, needsAttention, nonCompliant, avgScore }
  })

  return (
    <div className="bg-white rounded-lg shadow p-6">
      <h2 className="text-lg font-semibold mb-4">Employee Compliance</h2>

      {/* Progress Ring */}
      <div className="flex items-center justify-center mb-6">
        <div className="relative">
          <svg className="w-32 h-32 transform -rotate-90">
            <circle
              cx="64"
              cy="64"
              r="56"
              stroke="#E5E7EB"
              strokeWidth="12"
              fill="none"
            />
            <circle
              cx="64"
              cy="64"
              r="56"
              stroke="#10B981"
              strokeWidth="12"
              fill="none"
              strokeDasharray={`${(stats.compliant / stats.total) * 351.68} 351.68`}
              strokeLinecap="round"
            />
          </svg>
          <div className="absolute inset-0 flex flex-col items-center justify-center">
            <p className="text-3xl font-bold text-gray-900">{stats.compliant}</p>
            <p className="text-sm text-gray-500">of {stats.total}</p>
          </div>
        </div>
      </div>

      {/* Stats Breakdown */}
      <div className="space-y-3">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-green-500"></div>
            <span className="text-sm text-gray-700">Compliant</span>
          </div>
          <span className="text-sm font-medium text-gray-900">{stats.compliant}</span>
        </div>

        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
            <span className="text-sm text-gray-700">Needs Attention</span>
          </div>
          <span className="text-sm font-medium text-gray-900">{stats.needsAttention}</span>
        </div>

        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-red-500"></div>
            <span className="text-sm text-gray-700">Non-Compliant</span>
          </div>
          <span className="text-sm font-medium text-gray-900">{stats.nonCompliant}</span>
        </div>
      </div>

      {/* Average Score */}
      <div className="mt-6 pt-6 border-t border-gray-200">
        <div className="flex items-center justify-between">
          <span className="text-sm text-gray-700">Average Compliance Score</span>
          <span className="text-lg font-bold text-gray-900">{stats.avgScore}%</span>
        </div>
      </div>

      {/* Action Link */}
      {stats.needsAttention + stats.nonCompliant > 0 && (
        <a
          href="/hr/employees?filter=non_compliant,needs_attention"
          className="mt-4 block text-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
        >
          View {stats.needsAttention + stats.nonCompliant} Employees Needing Attention
        </a>
      )}
    </div>
  )
}
```

**Recalculate Compliance on Data Change:**
```typescript
// lib/hr/recalculate-compliance.ts
import { prisma } from '@/lib/prisma'
import { calculateEmployeeCompliance } from './compliance-rules'

export async function recalculateEmployeeCompliance(employeeId: string) {
  // Fetch employee with all related data
  const employee = await prisma.employee.findUnique({
    where: { id: employeeId },
    include: {
      kollektivavtal: {
        include: {
          kollektivavtal: true
        }
      },
      documents: true
    }
  })

  if (!employee) {
    throw new Error('Employee not found')
  }

  // Calculate compliance
  const compliance = calculateEmployeeCompliance(employee)

  // Update employee record
  await prisma.employee.update({
    where: { id: employeeId },
    data: {
      complianceStatus: compliance.status,
      complianceScore: compliance.score,
      complianceReasons: compliance.reasons,
      complianceLastChecked: new Date()
    }
  })

  return compliance
}

// Trigger recalculation after employee updates
export async function afterEmployeeUpdate(employeeId: string) {
  await recalculateEmployeeCompliance(employeeId)
}

// Bulk recalculation (for cron jobs)
export async function recalculateAllEmployees(workspaceId: string) {
  const employees = await prisma.employee.findMany({
    where: { workspaceId, status: 'active' },
    include: {
      kollektivavtal: {
        include: {
          kollektivavtal: true
        }
      },
      documents: true
    }
  })

  for (const employee of employees) {
    const compliance = calculateEmployeeCompliance(employee)

    await prisma.employee.update({
      where: { id: employee.id },
      data: {
        complianceStatus: compliance.status,
        complianceScore: compliance.score,
        complianceReasons: compliance.reasons,
        complianceLastChecked: new Date()
      }
    })
  }
}
```

**Update Employee APIs to Trigger Recalculation:**
```typescript
// app/api/employees/[id]/route.ts (updated)
export async function PATCH(request: Request, { params }: { params: { id: string } }) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_EMPLOYEES)

    const data = await request.json()

    // Update employee
    const employee = await prisma.employee.update({
      where: {
        id: params.id,
        workspaceId
      },
      data: {
        // ... update fields
      }
    })

    // Recalculate compliance
    await afterEmployeeUpdate(employee.id)

    return NextResponse.json({ employee })
  })
}
```

**Automated Reminder System (Cron Job):**
```typescript
// app/api/cron/employee-compliance-reminders/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { sendEmail } from '@/lib/email/send-email'

export async function GET(request: Request) {
  // Verify cron secret (security)
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    // Find employees "Needs Attention" for >7 days
    const sevenDaysAgo = new Date()
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)

    const employees = await prisma.employee.findMany({
      where: {
        status: 'active',
        complianceStatus: 'needs_attention',
        complianceLastChecked: {
          lt: sevenDaysAgo
        }
      },
      include: {
        workspace: {
          include: {
            members: {
              where: {
                role: {
                  in: ['owner', 'admin', 'hr_manager']
                }
              },
              include: {
                user: true
              }
            }
          }
        }
      }
    })

    const reminders = []

    for (const employee of employees) {
      const hrManagers = employee.workspace.members

      for (const member of hrManagers) {
        // Send email reminder
        await sendEmail({
          to: member.user.email,
          subject: `Employee Compliance Reminder: ${employee.name}`,
          html: `
            <h2>Employee Needs Attention</h2>
            <p>Employee <strong>${employee.name}</strong> has been in "Needs Attention" status for more than 7 days.</p>
            <h3>Compliance Issues:</h3>
            <ul>
              ${(employee.complianceReasons as string[]).map((reason) => `<li>${reason}</li>`).join('')}
            </ul>
            <p><a href="${process.env.NEXT_PUBLIC_APP_URL}/hr/employees/${employee.id}">View Employee Profile</a></p>
          `
        })

        reminders.push({
          employeeId: employee.id,
          sentTo: member.user.email
        })
      }
    }

    return NextResponse.json({
      success: true,
      remindersSent: reminders.length,
      reminders
    })
  } catch (error: any) {
    console.error('Cron job error:', error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}
```

**Vercel Cron Configuration:**
```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/employee-compliance-reminders",
      "schedule": "0 9 * * *"
    }
  ]
}
```

**Filter Employees by Compliance Status:**
```typescript
// app/hr/employees/page.tsx (updated)
export default function EmployeesPage({
  searchParams
}: {
  searchParams: { filter?: string }
}) {
  return (
    <Can permission={Permission.VIEW_EMPLOYEES}>
      <div className="max-w-7xl mx-auto p-6">
        {/* Filter Bar */}
        <div className="mb-6 flex items-center gap-4">
          <ComplianceFilter currentFilter={searchParams.filter} />
        </div>

        <Suspense fallback={<TableSkeleton />}>
          <EmployeeList filter={searchParams.filter} />
        </Suspense>
      </div>
    </Can>
  )
}

// components/hr/compliance-filter.tsx
'use client'

export function ComplianceFilter({ currentFilter }: { currentFilter?: string }) {
  const filters = [
    { value: 'all', label: 'All Employees' },
    { value: 'compliant', label: 'Compliant' },
    { value: 'needs_attention', label: 'Needs Attention' },
    { value: 'non_compliant', label: 'Non-Compliant' }
  ]

  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-gray-600">Filter:</span>
      {filters.map((filter) => (
        <a
          key={filter.value}
          href={`/hr/employees${filter.value !== 'all' ? `?filter=${filter.value}` : ''}`}
          className={`px-3 py-1.5 rounded-lg text-sm ${
            (currentFilter === filter.value || (!currentFilter && filter.value === 'all'))
              ? 'bg-blue-600 text-white'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
        >
          {filter.label}
        </a>
      ))}
    </div>
  )
}

// lib/hr/get-employees.ts (updated)
export async function getEmployees(filter?: string) {
  return withWorkspace(async ({ workspaceId }) => {
    const where: any = { workspaceId, status: 'active' }

    if (filter && filter !== 'all') {
      where.complianceStatus = filter
    }

    const employees = await prisma.employee.findMany({
      where,
      orderBy: [
        { complianceStatus: 'asc' }, // Non-compliant first
        { name: 'asc' }
      ]
    })

    return employees
  })
}
```

**Reference:** PRD Epic 7 Story 7.4, Vercel Cron Jobs documentation

## Testing

**Unit Tests:**
- Compliance calculation returns "compliant" for fully filled employee
- Compliance calculation returns "needs_attention" for missing kollektivavtal
- Compliance calculation returns "non_compliant" for missing personnummer
- Score calculated correctly (100% for perfect, 0% for all missing)

**Integration Tests:**
- Create employee without kollektivavtal, verify status "needs_attention"
- Upload contract document, verify status recalculated to "compliant"
- Update employee to remove required field, verify status changes to "non_compliant"
- Filter by compliance status, verify only matching employees displayed
- Cron job sends reminders, verify emails sent to HR managers

**Manual Testing:**
- View Employee List, verify compliance badges displayed
- Click filter buttons, verify employees filtered correctly
- View Employee Profile, verify compliance reasons listed
- Update employee data, verify compliance status updates automatically
- View Dashboard, verify compliance summary widget accurate
- Wait 7 days with "Needs Attention" employee, verify reminder email received

**Performance Testing:**
- Recalculate compliance for 1000 employees completes <5 minutes
- Dashboard compliance summary loads <2 seconds
- Filtering by compliance status instant (no lag)

**Automated Reminders Testing:**
- Create employee with missing data 8 days ago, verify reminder sent
- Create employee with missing data 6 days ago, verify no reminder sent
- Verify reminder sent to all HR managers in workspace
- Verify reminder email includes all compliance reasons and link to profile

**Test File:** `__tests__/features/hr/employee-compliance.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Review compliance status regularly
- Address compliance issues promptly when notified
- Keep employee data complete and up-to-date
- Respond to automated reminders within reasonable timeframe

**Developer Responsibility:**
- Define clear compliance rules and validation logic
- Calculate compliance status accurately and consistently
- Recalculate status automatically when data changes
- Cache compliance status for performance (avoid recalculating on every page load)
- Send automated reminders reliably via cron job
- Display compliance status clearly in UI with badges and colors
- Provide actionable error messages (specific reasons, not vague)
- Optimize bulk recalculation for large employee datasets

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
