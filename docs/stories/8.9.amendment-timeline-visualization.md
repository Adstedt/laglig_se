# Story 8.9: Add Amendment Timeline Visualization

## Status

Draft (v2 — rewritten to align with actual Amendment + AmendmentDocument models and SectionChange data)

## Story

**As a** workspace member viewing a law's detail page,
**I want** to see a complete amendment history timeline with rich metadata and team comments,
**so that** I understand how the law has evolved over time and can track regulatory changes.

## Context & Dependencies

**Builds on:**

- `Amendment` model — links base_document_id to amending_document_id, stores affected_sections, summary, effective_date
- `AmendmentDocument` model — stores parsed amendment PDFs with full_text, markdown_content, section_changes
- `SectionChange` model — per-section diffs (chapter, section, change_type, old_text, new_text)
- `LegalDocument` (amendment, content_type=SFS_AMENDMENT) — stores summering + kommentar
- `sync-sfs-updates` cron — detects and parses amendments automatically

**Does not exist yet (needs new model):**

- `AmendmentComment` — workspace-specific comments on amendments (competitive differentiator vs Notisum)

**Competitive context:** Notisum provides amendment timelines with 7 data points per amendment. This story implements feature parity + automation advantages (AI summaries, workspace comments, auto-detection).

## Acceptance Criteria

### Timeline Component

1. Individual Law Page → "Aendringshistorik" tab (next to existing tabs)
2. Amendment Timeline displays all `Amendment` records for the base law, ordered by `publication_date` DESC (newest first)
3. Each amendment card shows:
   - **SFS Number** (clickable → links to amendment's LegalDocument page): e.g., "SFS 2025:732"
   - **Publication Date**: from `Amendment.publication_date`
   - **Full Title**: from `Amendment.amending_law_title` or amending LegalDocument.title
   - **Affected Sections**: from `Amendment.affected_sections` (Notisum format: "aendr. 6 kap. 17 §; upph. 8 kap. 4 §")
   - **AI Summary**: from amending LegalDocument.summary (2-3 sentences, generated by Story 8.8)
   - **Effective Date**: from `Amendment.effective_date` with future indicator badge ("Framtida") if not yet in effect
   - **Workspace Comments**: expandable area showing comments from current workspace members

### Contextual Help

4. Tooltips on Swedish legal notation:
   - "aendr." → "Aendrad bestaemmelse (amended)"
   - "upph." → "Upphaevd bestaemmelse (repealed)"
   - "nya" → "Ny bestaemmelse (new provision)"
   - "betecknas" → "Ombenamnd (renumbered)"

### Data & Links

5. Link to amending law's page: click SFS number → `/lagar/{amendment-slug}`
6. Link to Riksdagen PDF: from `AmendmentDocument.original_url`
7. Data source badge: "Riksdagen" (auto-parsed) vs "Manuell" (if manually added)

### Workspace Comments

8. New `AmendmentComment` model: amendment_id, workspace_id, user_id, content, created_at
9. Users can add comments per amendment (visible only to workspace members)
10. Comments display under each amendment card with author name and date

### Performance & UX

11. Timeline loads <500ms for laws with <50 amendments
12. Empty state: "Inga registrerade aendringar aen"
13. Filter by year or search by affected section
14. Collapsible cards (click to expand full details, collapsed by default shows SFS number + title + date)

## Tasks / Subtasks

- [ ] **Task 1: Create AmendmentComment model** (AC: 8)
  - [ ] Prisma schema: amendment_id, workspace_id, user_id, content, created_at
  - [ ] Migration
- [ ] **Task 2: Create "Aendringshistorik" tab** (AC: 1)
  - [ ] Add tab to individual law page navigation
  - [ ] Route: within existing law detail page layout
- [ ] **Task 3: Build AmendmentTimeline component** (AC: 2, 14)
  - [ ] Query `Amendment` records where base_document_id matches current law
  - [ ] Include amending LegalDocument (for summary/kommentar)
  - [ ] Include AmendmentDocument (for original_url)
  - [ ] Include AmendmentComments for current workspace
  - [ ] Year filter and section search
  - [ ] Collapsible cards
- [ ] **Task 4: Build AmendmentCard component** (AC: 3, 4, 5, 6, 7)
  - [ ] 7-field display with all required data
  - [ ] Legal notation tooltips (shadcn/ui Tooltip)
  - [ ] SFS number link, PDF link, data source badge
  - [ ] Future effective date badge
- [ ] **Task 5: Workspace comment functionality** (AC: 9, 10)
  - [ ] Server action to create AmendmentComment
  - [ ] Display comments under each card
  - [ ] Comment form (expandable textarea)
- [ ] **Task 6: Empty state and performance** (AC: 11, 12)

## Dev Notes

### Source Tree (relevant files)

```
prisma/schema.prisma                         — Amendment, AmendmentDocument, LegalDocument, SectionChange
app/api/cron/sync-sfs-updates/route.ts       — Creates Amendment + AmendmentDocument records
lib/sfs/amendment-to-legal-document.ts        — createLegalDocumentFromAmendment
```

### Key Data Models

```
Amendment (existing)
  ├─ base_document_id → LegalDocument (the base law being amended)
  ├─ amending_document_id → LegalDocument (the amendment itself, content_type=SFS_AMENDMENT)
  ├─ amending_law_title: String
  ├─ publication_date, effective_date
  ├─ affected_sections_raw: String ("aendr. 6 kap. 17 §; upph. 8 kap. 4 §")
  ├─ affected_sections: Json (structured array)
  ├─ summary: String?
  └─ detected_method: String

AmendmentDocument (existing)
  ├─ sfs_number, base_law_sfs
  ├─ original_url: String (Riksdagen PDF link)
  ├─ section_changes: SectionChange[]
  └─ parse_status: COMPLETED

LegalDocument (amendment, content_type=SFS_AMENDMENT)
  ├─ summary (summering) ← from Story 8.8 enrichment
  ├─ kommentar ← from Story 8.8 enrichment
  └─ effective_date

AmendmentComment (NEW — this story creates it)
  ├─ amendment_id → Amendment
  ├─ workspace_id → Workspace
  ├─ user_id → User
  ├─ content: String
  └─ created_at
```

### Query Pattern

```typescript
const amendments = await prisma.amendment.findMany({
  where: { base_document_id: lawId },
  include: {
    amending_document: {
      select: { id: true, title: true, summary: true, slug: true, effective_date: true }
    },
    // AmendmentComments for current workspace (need relation setup)
  },
  orderBy: { publication_date: 'desc' }
})
```

### UI Standards

- shadcn/ui Card, Badge, Tooltip, Collapsible
- Server component for data fetching
- Client component for collapsible cards, comment form, filters

## Testing

**Test location:** `tests/unit/components/laws/amendment-timeline.test.tsx`

**Test framework:** Vitest with React Testing Library

**Unit tests:**
- AmendmentCard renders all 7 fields
- Legal notation tooltips appear on hover
- Future effective date shows "Framtida" badge
- Collapsible cards expand/collapse on click
- Comment form submits and displays new comment
- Empty state renders when no amendments

**Integration tests:**
- Timeline loads Amendment records for correct base law
- Year filter works
- Section search filters correctly
- SFS number link navigates to amendment page
- PDF link opens external URL

**Performance tests:**
- Timeline loads <500ms for law with 50 amendments

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with Amendment + AmendmentDocument models, new AmendmentComment model | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
