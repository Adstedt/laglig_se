# Story 8.9: Add Amendment Timeline Visualization

## Status
Draft

## Story

**As a** user,
**I want** to see a complete amendment history timeline for each law,
**so that** I understand how the law has evolved over time.

## Acceptance Criteria

1. **Individual Law Page → "Change History" tab** (next to Overview, Chat, etc.)

2. **Amendment Timeline displays all historical amendments** (newest first)

3. **Each amendment card shows 7 fields:**
   - **SFS Number** (clickable link to amending law, e.g., "SFS 2024:567")
   - **Publication Date** (when amendment was published)
   - **Full Title** of amending law
   - **Affected Sections** (e.g., "ändr. 6 kap. 17 §; upph. 8 kap. 4 §")
   - **AI Summary** (2-3 sentences explaining what changed)
   - **Effective Date** (with future indicator badge if not yet in effect)
   - **User Comments** (workspace-specific notes on this amendment)

4. **Contextual help tooltips** for legal notation:
   - "ändr." → "ändring" (amendment)
   - "upph." → "upphävd" (repealed)
   - "nya" → "nya bestämmelser" (new provisions)
   - "betecknas" → "ombenämnd" (renamed)

5. **Data source indicator badge:**
   - "Verified" (from official Riksdagen data)
   - "Scraped" (from web scraping)
   - "User-added" (manually added by user)

6. **Link to official PDF** for each amendment

7. **Timeline loads <500ms** for laws with <50 amendments (NFR10)

8. **Empty state:** "Inga registrerade ändringar än" (if no amendments found)

9. **Future amendments highlighted** with badge "Träder i kraft [date]"

10. **Search/filter amendments** by year or affected section

## Tasks / Subtasks

- [ ] Create "Change History" tab in Individual Law Page
- [ ] Build AmendmentTimeline component
- [ ] Create AmendmentCard component with 7 fields
- [ ] Add contextual help tooltips for legal notation
- [ ] Implement data source indicator badges
- [ ] Add links to official PDFs
- [ ] Generate AI summaries for historical amendments
- [ ] Add user comment functionality per amendment
- [ ] Implement search/filter by year or section
- [ ] Add empty state component
- [ ] Test with laws with many amendments (100+)
- [ ] Optimize query performance (<500ms)
- [ ] Test on mobile (vertical cards)

## Dev Notes

**Database Schema:**
```prisma
model LawAmendment {
  id                    String   @id @default(uuid())
  lawId                 String
  amendingSfsNummer     String   // SFS number of the amending law
  amendingLawTitle      String
  publicationDate       DateTime
  effectiveDate         DateTime?
  affectedSections      String[] // e.g., ["ändr. 6 kap. 17 §", "upph. 8 kap. 4 §"]
  aiSummary             String?  @db.Text
  dataSource            String   // verified, scraped, user_added
  officialPdfUrl        String?

  law Law @relation(fields: [lawId], references: [id])

  comments LawAmendmentComment[]

  @@index([lawId, publicationDate])
  @@map("law_amendments")
}

model LawAmendmentComment {
  id                String   @id @default(uuid())
  lawAmendmentId    String
  workspaceId       String
  userId            String
  content           String   @db.Text
  createdAt         DateTime @default(now())

  lawAmendment LawAmendment @relation(fields: [lawAmendmentId], references: [id])
  workspace    Workspace    @relation(fields: [workspaceId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([lawAmendmentId, workspaceId])
  @@map("law_amendment_comments")
}
```

**Change History Tab:**
```typescript
// app/laws/[lawId]/change-history/page.tsx
import { notFound } from 'next/navigation'
import { prisma } from '@/lib/prisma'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { AmendmentTimeline } from '@/components/laws/amendment-timeline'

interface PageProps {
  params: { lawId: string }
  searchParams: { year?: string; section?: string }
}

export default async function ChangeHistoryPage({ params, searchParams }: PageProps) {
  return withWorkspace(async ({ workspaceId }) => {
    const law = await prisma.law.findUnique({
      where: { id: params.lawId },
      select: {
        id: true,
        sfsNummer: true,
        rubrik: true
      }
    })

    if (!law) {
      notFound()
    }

    // Build filter
    const filter: any = { lawId: params.lawId }

    if (searchParams.year) {
      const year = parseInt(searchParams.year)
      filter.publicationDate = {
        gte: new Date(`${year}-01-01`),
        lt: new Date(`${year + 1}-01-01`)
      }
    }

    if (searchParams.section) {
      filter.affectedSections = {
        hasSome: [searchParams.section]
      }
    }

    // Fetch amendments
    const amendments = await prisma.lawAmendment.findMany({
      where: filter,
      include: {
        comments: {
          where: { workspaceId },
          include: {
            user: {
              select: { name: true }
            }
          },
          orderBy: { createdAt: 'desc' }
        }
      },
      orderBy: { publicationDate: 'desc' }
    })

    return (
      <div className="max-w-4xl mx-auto p-6">
        {/* Header */}
        <div className="mb-6">
          <h1 className="text-2xl font-bold">{law.rubrik}</h1>
          <p className="text-sm text-gray-600 mt-1">{law.sfsNummer}</p>
        </div>

        {/* Timeline */}
        <AmendmentTimeline
          amendments={amendments}
          workspaceId={workspaceId}
          searchParams={searchParams}
        />
      </div>
    )
  })
}
```

**Amendment Timeline Component:**
```typescript
// components/laws/amendment-timeline.tsx
'use client'

import { useState } from 'react'
import { AmendmentCard } from './amendment-card'

interface AmendmentTimelineProps {
  amendments: any[]
  workspaceId: string
  searchParams: { year?: string; section?: string }
}

export function AmendmentTimeline({ amendments, workspaceId, searchParams }: AmendmentTimelineProps) {
  const [filterYear, setFilterYear] = useState(searchParams.year || '')
  const [filterSection, setFilterSection] = useState(searchParams.section || '')

  // Extract unique years and sections for filters
  const years = [...new Set(amendments.map((a) => new Date(a.publicationDate).getFullYear()))]
  const sections = [...new Set(amendments.flatMap((a) => a.affectedSections))]

  function handleFilterChange() {
    const params = new URLSearchParams()
    if (filterYear) params.set('year', filterYear)
    if (filterSection) params.set('section', filterSection)
    window.location.search = params.toString()
  }

  if (amendments.length === 0) {
    return (
      <div className="text-center py-12 bg-white rounded-lg shadow">
        <svg
          className="mx-auto h-16 w-16 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <p className="mt-4 text-lg font-medium text-gray-900">Inga registrerade ändringar än</p>
        <p className="text-sm text-gray-600 mt-1">
          Historiska ändringar kommer att visas här när de blir tillgängliga.
        </p>
      </div>
    )
  }

  return (
    <div>
      {/* Filters */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div className="flex flex-wrap gap-4">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Year</label>
            <select
              value={filterYear}
              onChange={(e) => setFilterYear(e.target.value)}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
            >
              <option value="">All Years</option>
              {years.map((year) => (
                <option key={year} value={year}>
                  {year}
                </option>
              ))}
            </select>
          </div>
          <div className="flex-1 min-w-[200px]">
            <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Section</label>
            <select
              value={filterSection}
              onChange={(e) => setFilterSection(e.target.value)}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
            >
              <option value="">All Sections</option>
              {sections.slice(0, 20).map((section) => (
                <option key={section} value={section}>
                  {section}
                </option>
              ))}
            </select>
          </div>
          <div className="flex items-end">
            <button
              onClick={handleFilterChange}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
            >
              Apply Filters
            </button>
          </div>
        </div>
      </div>

      {/* Timeline */}
      <div className="space-y-4">
        {amendments.map((amendment) => (
          <AmendmentCard key={amendment.id} amendment={amendment} workspaceId={workspaceId} />
        ))}
      </div>
    </div>
  )
}
```

**Amendment Card Component:**
```typescript
// components/laws/amendment-card.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface AmendmentCardProps {
  amendment: any
  workspaceId: string
}

const LEGAL_NOTATION_TOOLTIPS = {
  'ändr.': 'Ändring - bestämmelsen har ändrats',
  'upph.': 'Upphävd - bestämmelsen har tagits bort',
  'nya': 'Nya bestämmelser - nya regler har lagts till',
  'betecknas': 'Ombenämnd - paragrafnumret har ändrats'
}

const DATA_SOURCE_BADGES = {
  verified: { label: 'Verified', color: 'bg-green-100 text-green-800' },
  scraped: { label: 'Scraped', color: 'bg-yellow-100 text-yellow-800' },
  user_added: { label: 'User-added', color: 'bg-blue-100 text-blue-800' }
}

export function AmendmentCard({ amendment, workspaceId }: AmendmentCardProps) {
  const [showCommentForm, setShowCommentForm] = useState(false)
  const [commentText, setCommentText] = useState('')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const router = useRouter()

  const publicationDate = new Date(amendment.publicationDate)
  const effectiveDate = amendment.effectiveDate ? new Date(amendment.effectiveDate) : null
  const isFuture = effectiveDate && effectiveDate > new Date()

  const dataSourceBadge = DATA_SOURCE_BADGES[amendment.dataSource as keyof typeof DATA_SOURCE_BADGES] || DATA_SOURCE_BADGES.scraped

  async function handleAddComment() {
    if (!commentText.trim()) return

    setIsSubmitting(true)
    try {
      const response = await fetch('/api/law-amendments/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          lawAmendmentId: amendment.id,
          workspaceId,
          content: commentText
        })
      })

      if (response.ok) {
        setCommentText('')
        setShowCommentForm(false)
        router.refresh()
      }
    } catch (error) {
      console.error('Failed to add comment:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  function renderAffectedSections(sections: string[]) {
    return sections.map((section, index) => {
      // Extract notation (ändr., upph., etc.)
      const notationMatch = section.match(/^(ändr\.|upph\.|nya|betecknas)/)
      const notation = notationMatch ? notationMatch[1] : null
      const tooltip = notation ? LEGAL_NOTATION_TOOLTIPS[notation as keyof typeof LEGAL_NOTATION_TOOLTIPS] : null

      return (
        <span key={index} className="inline-block mr-2 mb-1">
          {notation && tooltip ? (
            <span
              className="inline-flex items-center text-sm text-gray-700"
              title={tooltip}
            >
              <span className="underline decoration-dotted cursor-help">{notation}</span>
              <span className="ml-1">{section.replace(notation, '').trim()}</span>
            </span>
          ) : (
            <span className="text-sm text-gray-700">{section}</span>
          )}
          {index < sections.length - 1 && <span className="text-gray-400">;</span>}
        </span>
      )
    })
  }

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      {/* Header */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            {/* SFS Number Link */}
            <a
              href={`/laws?search=${amendment.amendingSfsNummer}`}
              className="text-lg font-bold text-blue-600 hover:underline"
            >
              {amendment.amendingSfsNummer}
            </a>

            {/* Data Source Badge */}
            <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${dataSourceBadge.color}`}>
              {dataSourceBadge.label}
            </span>

            {/* Future Amendment Badge */}
            {isFuture && effectiveDate && (
              <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                Träder i kraft {effectiveDate.toLocaleDateString('sv-SE')}
              </span>
            )}
          </div>

          {/* Full Title */}
          <h3 className="text-base font-semibold text-gray-900">{amendment.amendingLawTitle}</h3>

          {/* Publication Date */}
          <p className="text-sm text-gray-600 mt-1">
            Publicerad {publicationDate.toLocaleDateString('sv-SE', { year: 'numeric', month: 'long', day: 'numeric' })}
          </p>
        </div>

        {/* Official PDF Link */}
        {amendment.officialPdfUrl && (
          <a
            href={amendment.officialPdfUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1"
          >
            PDF ↗
          </a>
        )}
      </div>

      {/* Affected Sections */}
      {amendment.affectedSections.length > 0 && (
        <div className="mb-4">
          <h4 className="text-sm font-medium text-gray-700 mb-1">Berörda paragrafer:</h4>
          <div className="flex flex-wrap">
            {renderAffectedSections(amendment.affectedSections)}
          </div>
        </div>
      )}

      {/* AI Summary */}
      {amendment.aiSummary && (
        <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <p className="text-sm text-blue-900">{amendment.aiSummary}</p>
        </div>
      )}

      {/* Effective Date (if past) */}
      {effectiveDate && !isFuture && (
        <p className="text-sm text-gray-600 mb-4">
          Trädde i kraft: {effectiveDate.toLocaleDateString('sv-SE')}
        </p>
      )}

      {/* User Comments */}
      {amendment.comments.length > 0 && (
        <div className="mb-4 border-t border-gray-200 pt-4">
          <h4 className="text-sm font-medium text-gray-700 mb-2">Arbetsytans kommentarer:</h4>
          <div className="space-y-2">
            {amendment.comments.map((comment: any) => (
              <div key={comment.id} className="bg-gray-50 p-3 rounded-lg">
                <p className="text-sm text-gray-900">{comment.content}</p>
                <p className="text-xs text-gray-500 mt-1">
                  {comment.user.name} • {new Date(comment.createdAt).toLocaleDateString('sv-SE')}
                </p>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Add Comment Button */}
      {!showCommentForm ? (
        <button
          onClick={() => setShowCommentForm(true)}
          className="text-sm text-blue-600 hover:text-blue-700 font-medium"
        >
          + Lägg till kommentar
        </button>
      ) : (
        <div className="border-t border-gray-200 pt-4">
          <textarea
            value={commentText}
            onChange={(e) => setCommentText(e.target.value)}
            placeholder="Lägg till en kommentar om denna ändring..."
            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm resize-none"
            rows={3}
          />
          <div className="flex gap-2 mt-2">
            <button
              onClick={handleAddComment}
              disabled={isSubmitting || !commentText.trim()}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm disabled:bg-gray-300"
            >
              {isSubmitting ? 'Sparar...' : 'Spara'}
            </button>
            <button
              onClick={() => {
                setShowCommentForm(false)
                setCommentText('')
              }}
              className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm"
            >
              Avbryt
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
```

**API Endpoint for Adding Comments:**
```typescript
// app/api/law-amendments/comments/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'

export async function POST(request: Request) {
  return withWorkspace(async ({ userId }) => {
    const { lawAmendmentId, workspaceId, content } = await request.json()

    if (!content || !content.trim()) {
      return NextResponse.json({ error: 'Content required' }, { status: 400 })
    }

    const comment = await prisma.lawAmendmentComment.create({
      data: {
        lawAmendmentId,
        workspaceId,
        userId,
        content: content.trim()
      }
    })

    return NextResponse.json(comment)
  })
}
```

**Reference:** PRD Epic 8 Story 8.9, NFR10 (timeline loads <500ms)

## Testing

**Unit Tests:**
- Amendment card displays all 7 fields
- Legal notation tooltips appear on hover
- Data source badge displays correct color
- Future amendment badge displays correctly
- Affected sections render with tooltips
- Comment form submits successfully

**Integration Tests:**
- Change History tab queries amendments correctly
- Filter by year works
- Filter by section works
- Click on SFS number searches for amending law
- Add comment API creates comment
- Comments display under amendment

**Manual Testing:**
- View law with 10+ amendments, verify timeline displays
- Hover on "ändr." notation, verify tooltip appears
- Filter by year 2023, verify only 2023 amendments shown
- Add comment to amendment, verify saved and displayed
- Click SFS number link, verify navigates to amending law
- Click official PDF link, verify opens Riksdagen PDF
- Test with law with 100+ amendments (pagination needed?)

**Performance Testing:**
- Timeline loads <500ms for 50 amendments
- Timeline loads <2 seconds for 200 amendments
- Filter application instant (<100ms)
- Comment submission <300ms

**Edge Cases:**
- Law with no amendments (empty state)
- Amendment with no affected sections (hide section)
- Amendment with no AI summary (hide summary)
- Amendment with no official PDF (hide link)
- Very long affected sections list (truncate or scroll)
- Future amendment (badge displays correctly)

**Accessibility Testing:**
- Tooltips keyboard-accessible (focus + hover)
- Screen reader announces amendment details
- Comment form keyboard-navigable

**Test File:** `__tests__/features/law-amendments/timeline.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Review amendment timeline to understand law evolution
- Add workspace comments to track internal notes
- Use filters to find specific amendments by year or section

**Developer Responsibility:**
- Display complete amendment history in chronological order
- Provide all 7 fields for each amendment
- Generate AI summaries for historical amendments
- Add contextual help tooltips for legal notation
- Link to official PDFs for transparency
- Optimize query performance (<500ms for 50 amendments)
- Support workspace-specific comments on amendments
- Implement filters for year and section
- Handle empty state when no amendments exist
- Highlight future amendments with badge
- Make timeline mobile-responsive (vertical cards)
- Fetch amendment data from Riksdagen API or scraping
- Store amendment data in database for fast retrieval

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
