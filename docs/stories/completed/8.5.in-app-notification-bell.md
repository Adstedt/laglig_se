# Story 8.5: Implement In-App Notification Bell

## Status

Done

## Story

**As a** workspace member,
**I want** to see a notification bell with a count of unacknowledged law changes,
**so that** I know at a glance if there are amendment updates requiring my review.

## Context & Dependencies

**Builds on:**

- `Notification` model — existing in-app notification system with `type`, `entity_type`, `entity_id`, `read_at` [Source: prisma/schema.prisma:1042]
- `NotificationType` enum — includes `AMENDMENT_DETECTED`, `LAW_REPEALED`, `RULING_CITED`, `AMENDMENT_REMINDER` [Source: prisma/schema.prisma:514]
- `ChangeEvent` model — amendment changes detected by `sync-sfs-updates` [Source: prisma/schema.prisma:806]
- `NotificationPreference` model — per-workspace notification settings with `email_enabled`, per-type toggles [Source: prisma/schema.prisma:1071]
- Story 8.15 (Notification Service) — `createChangeNotifications()` creates `Notification` records per affected user [Source: lib/notifications/amendment-notifications.ts:75]
- Story 8.4 (Daily Email Digest) — `notify-amendment-changes` cron calls `processChangeEventNotifications()` which populates `Notification` records [Source: app/api/cron/notify-amendment-changes/route.ts:328]
- `components/layout/header.tsx` — existing authenticated app header with a **disabled placeholder** bell button at line 86-95 [Source: components/layout/header.tsx]

**Depends on:**

- Story 8.15 (Done) — must have `Notification` records to display
- Story 8.4 (Done) — the cron that creates `Notification` records alongside emails

**Depended on by:**

- Story 8.11 (Notification Preferences UI) — depends on 8.15 + 8.5 (notification types must exist to configure)

## Acceptance Criteria

### Notification Bell Component

1. Bell icon replaces the disabled placeholder in the app header (`components/layout/header.tsx`), right side next to the "+ Skapa" button
2. Red badge showing unread notification count (from `Notification` where `read_at IS NULL` for the current user in the active workspace)
3. Badge disappears when count = 0
4. Clicking bell opens a Popover dropdown showing last 5 unread notifications
5. Each notification in the dropdown shows:
   - Change type icon (amendment, repeal, ruling — map from `NotificationType`)
   - Title (base law title, truncated to 50 chars, full title on hover)
   - Body snippet (from `Notification.body`, truncated)
   - Relative time: "2 timmar sedan" (using `date-fns` `formatDistanceToNow` with `sv` locale)
6. Click on notification → marks notification as read (`read_at = NOW()`) and navigates to the related entity (for `entity_type: 'change_event'`, navigate to the base law document page `/dokument/{slug}`)
7. "Visa alla" link at bottom → navigates to a future notifications page (for now, can be a no-op or navigate to workspace root)
8. Dropdown closes when clicking outside (Popover built-in behavior)
9. Empty state: "Inga nya notifieringar" with muted text
10. "Markera alla som lästa" button in dropdown header → marks all unread notifications as read

### API Routes

11. `GET /api/notifications/unread-count` — returns `{ count: number }` for the current user in the active workspace
12. `GET /api/notifications` — returns last N (default 5) unread notifications for the current user, ordered by `created_at DESC`
13. `PATCH /api/notifications/[id]/read` — marks a single notification as read (`read_at = NOW()`)
14. `PATCH /api/notifications/mark-all-read` — marks all unread notifications as read for the current user in the active workspace
15. All API routes require authentication (use `getServerSession()` or `auth()` from NextAuth)

### Real-Time Updates

16. Poll for new notification count every 5 minutes (simple `setInterval` + `fetch`)
17. Update badge count without full page reload
18. Re-fetch notification list when bell is opened (not stale data)

## Tasks / Subtasks

- [x] **Task 1: Create unread-count API route** (AC: 11, 15)
  - [x] Create `app/api/notifications/unread-count/route.ts`
  - [x] Implement `GET` handler: authenticate user, query `prisma.notification.count({ where: { user_id, workspace_id, read_at: null } })`
  - [x] Determine workspace from session (active workspace in session or query param)
  - [x] Return `{ count: number }`

- [x] **Task 2: Create notifications list API route** (AC: 12, 15)
  - [x] Create `app/api/notifications/route.ts`
  - [x] Implement `GET` handler: authenticate user, read optional `?limit=N` query param (default 5, max 20, validate with `Math.min(Math.max(1, Number(limit)), 20)`)
  - [x] Query `prisma.notification.findMany({ where: { user_id, workspace_id, read_at: null }, orderBy: { created_at: 'desc' }, take: limit, select: { id, type, title, body, entity_type, entity_id, created_at } })`
  - [x] Return JSON array of notifications

- [x] **Task 3: Create mark-as-read API route** (AC: 13, 15)
  - [x] Create `app/api/notifications/[id]/read/route.ts`
  - [x] Implement `PATCH` handler: authenticate user, verify notification belongs to user, update `read_at = new Date()`
  - [x] Return `{ success: true }`

- [x] **Task 4: Create mark-all-read API route** (AC: 14, 15)
  - [x] Create `app/api/notifications/mark-all-read/route.ts`
  - [x] Implement `PATCH` handler: authenticate user, `prisma.notification.updateMany({ where: { user_id, workspace_id, read_at: null }, data: { read_at: new Date() } })`
  - [x] Return `{ success: true, updated: number }`

- [x] **Task 5: Build NotificationBell component** (AC: 1, 2, 3, 8, 9, 10, 16, 17, 18)
  - [x] Create `components/features/notifications/notification-bell.tsx` as a `"use client"` component
  - [x] Use `useWorkspace()` hook to get `workspaceId`; accept `userId` as prop
  - [x] Use shadcn/ui `Popover` for the dropdown (handles click-outside automatically)
  - [x] Use shadcn/ui `Badge` for the unread count
  - [x] Add dynamic `aria-label` on bell button: `aria-label={count > 0 ? \`${count} olästa notifieringar\` : 'Notifieringar'}` (WCAG 2.1 AA)
  - [x] Fetch unread count on mount and on 5-minute interval (`setInterval`); skip polling if `userId` or `workspaceId` not yet available
  - [x] Fetch notification list when Popover opens (`onOpenChange`)
  - [x] Show loading skeleton (`shadcn/ui Skeleton`) in dropdown while notification list is being fetched
  - [x] Render notification items with icon, title, body snippet, relative time
  - [x] Render empty state: "Inga nya notifieringar"
  - [x] Add "Markera alla som lästa" button in header calling mark-all-read API
  - [x] Add "Visa alla" link in footer

- [x] **Task 6: Build notification item sub-component** (AC: 4, 5, 6)
  - [x] Create `components/features/notifications/notification-item.tsx`
  - [x] Map `NotificationType` → icon (use Lucide icons: `FileEdit` for AMENDMENT_DETECTED, `XCircle` for LAW_REPEALED, `Gavel` for RULING_CITED, `Clock` for AMENDMENT_REMINDER, `Bell` as fallback)
  - [x] Truncate title to 50 chars with `title` attribute for full text on hover
  - [x] Format relative time using `date-fns` `formatDistanceToNow` with `{ locale: sv, addSuffix: true }`
  - [x] Click handler: call mark-as-read API → navigate to `/dokument/{slug}` (requires resolving `entity_id` → `ChangeEvent.document_id` → `LegalDocument.slug`)

- [x] **Task 7: Integrate NotificationBell into app header** (AC: 1)
  - [x] Replace the disabled placeholder bell in `components/layout/header.tsx` with `<NotificationBell userId={user.id} />`
  - [x] `NotificationBell` receives `userId` as prop from Header's `user.id` (typed `id?: string` — guard for undefined)
  - [x] `NotificationBell` gets `workspaceId` internally via `useWorkspace()` hook (already in context tree via `WorkspaceProvider` in `workspace-shell.tsx:66`) — do NOT pass as prop
  - [x] Ensure the bell appears in the correct position (after search, before profile)

- [x] **Task 8: Handle navigation from notification click** (AC: 6)
  - [x] For `entity_type: 'change_event'`: resolve the ChangeEvent → its `document_id` → LegalDocument.slug → navigate to `/dokument/{slug}`
  - [x] Option A: Include slug/URL in the notification list API response (join through ChangeEvent → LegalDocument)
  - [x] Option B: Store a `link_url` when creating notifications (would require Story 8.15 changes — avoid if possible)
  - [x] Prefer Option A — enrich the GET /api/notifications response with a `link_url` derived from the entity

- [x] **Task 9: Write tests** (see Testing section)
  - [x] Unit tests for NotificationBell component
  - [x] Unit tests for notification-item component
  - [x] Unit tests for all 4 API routes
  - [x] Verify `npx tsc --noEmit` passes
  - [x] Verify all existing tests still pass (`pnpm vitest run`)

## Dev Notes

### Previous Story Insights

**From Story 8.4 (Daily Email Digest):**
- Story 8.4 calls `processChangeEventNotifications(changeEventIds)` from `lib/notifications/amendment-notifications.ts` which creates `Notification` records with `entity_type: 'change_event'` and `entity_id: changeEvent.id`. This story (8.5) reads those records. [Source: app/api/cron/notify-amendment-changes/route.ts:328]
- Anthropic SDK mock pattern: use class syntax `class MockAnthropic { messages = {...} }`, NOT `mockImplementation`. [Source: Story 8.4 Debug Log]
- Pre-existing type error: `laglig-email-layout.tsx:106` unused `headerText` variable (TS6133) — not introduced by this story.

**From Story 8.15 (Notification Service):**
- `createChangeNotifications()` creates `Notification` records with: `type` (AMENDMENT_DETECTED/LAW_REPEALED/RULING_CITED), `title` (base law title), `body` (formatted change description), `entity_type: 'change_event'`, `entity_id: changeEventId`. [Source: lib/notifications/amendment-notifications.ts:157-167]
- Notifications have `read_at: null` when created (unread). This story marks them read on user click.
- Migration approach: Used `prisma db push` instead of `prisma migrate dev` due to Supabase shadow database limitation (P3006 error). [Source: Story 8.15 Debug Log]
- Prisma generate gotcha on Windows: may fail with EPERM on DLL rename — kill running node processes first. [Source: Story 8.15 Debug Log]

**From Story 8.16 (Change Tracking):**
- `changeTypeToNotificationType()` maps `ChangeType` → `NotificationType | null`. Returns null for `NEW_LAW` and `METADATA_UPDATE`. [Source: lib/notifications/amendment-notifications.ts:17-31]
- Enum usage: Always use Prisma-generated enum values, never string literals. [Source: Story 8.15 Dev Notes]

### Data Models (verified against prisma/schema.prisma)

**`Notification`** (prisma/schema.prisma:1042) [Source: prisma/schema.prisma]
```prisma
model Notification {
  id           String           @id @default(uuid())
  workspace_id String
  user_id      String // Recipient
  type         NotificationType

  // Content
  title String
  body  String? @db.Text

  // Link to related entity
  entity_type String? // 'change_event', 'task', 'comment', etc.
  entity_id   String?

  // Status
  read_at    DateTime?
  created_at DateTime  @default(now())

  // Relations
  workspace Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [user_id], references: [id])

  @@index([user_id, read_at])
  @@index([workspace_id])
  @@index([created_at])
  @@map("notifications")
}
```

**`NotificationType` enum** (prisma/schema.prisma:514) [Source: prisma/schema.prisma]
```prisma
enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE_SOON
  TASK_OVERDUE
  COMMENT_ADDED
  MENTION
  STATUS_CHANGED
  WEEKLY_DIGEST
  AMENDMENT_DETECTED
  LAW_REPEALED
  RULING_CITED
  AMENDMENT_REMINDER
}
```

**`ChangeEvent`** (prisma/schema.prisma:806) [Source: prisma/schema.prisma]
```prisma
model ChangeEvent {
  id                String      @id @default(cuid())
  document_id       String      // FK -> LegalDocument (the BASE LAW)
  content_type      ContentType
  change_type       ChangeType
  amendment_sfs     String?     // "SFS 2025:732"
  diff_summary      String?     @db.Text
  ai_summary        String?     @db.Text
  detected_at       DateTime    @default(now())
  notification_sent Boolean     @default(false)
  document          LegalDocument @relation(...)
  @@map("change_events")
}
```

### Notification → Navigation Resolution

Notifications have `entity_type: 'change_event'` and `entity_id` pointing to a `ChangeEvent.id`. To navigate the user to the relevant law page, the API must resolve:

```
Notification.entity_id → ChangeEvent.id → ChangeEvent.document_id → LegalDocument.slug
→ navigate to /dokument/{slug}
```

Enriched query for the notifications list API:

```typescript
// In GET /api/notifications - enrich with navigation URL
const notifications = await prisma.notification.findMany({
  where: { user_id: userId, workspace_id: workspaceId, read_at: null },
  orderBy: { created_at: 'desc' },
  take: 5,
  select: {
    id: true,
    type: true,
    title: true,
    body: true,
    entity_type: true,
    entity_id: true,
    created_at: true,
  },
})

// For change_event notifications, resolve slug
for (const n of notifications) {
  if (n.entity_type === 'change_event' && n.entity_id) {
    const changeEvent = await prisma.changeEvent.findUnique({
      where: { id: n.entity_id },
      select: { document: { select: { slug: true } } },
    })
    // Attach link_url to response
    n.link_url = changeEvent?.document?.slug
      ? `/dokument/${changeEvent.document.slug}`
      : null
  }
}
```

[Source: prisma/schema.prisma — ChangeEvent.document_id → LegalDocument.slug]

### Existing App Header

`components/layout/header.tsx` is a `"use client"` component with a disabled bell placeholder: [Source: components/layout/header.tsx:86-95]

```tsx
{/* Notification Bell Placeholder */}
<Button
  variant="ghost"
  size="icon"
  className="relative h-9 w-9 ml-2"
  disabled
  title="Notifieringar kommer snart"
>
  <Bell className="h-5 w-5 text-muted-foreground" />
  <span className="sr-only">Notifieringar</span>
</Button>
```

**Replace** this entire block with `<NotificationBell userId={user.id} />`. The `Header` component receives `user` prop with `user.id` (typed `id?: string`). The workspace ID is available inside the component via `useWorkspace()` hook — see "Workspace ID Resolution" section below.

The header component's interface: [Source: components/layout/header.tsx:15-23]
```typescript
interface HeaderProps {
  user: {
    id?: string
    name?: string | null
    email?: string | null
    image?: string | null
  }
  onMenuToggle?: () => void
}
```

### UI Component Library

All needed shadcn/ui components already exist: [Source: components/ui/]
- `popover.tsx` — for the bell dropdown (Radix Popover with click-outside dismiss)
- `badge.tsx` — for the unread count badge
- `skeleton.tsx` — for loading states
- `button.tsx` — for the bell trigger

### Date Formatting

Use `date-fns` (already in project dependencies, v3.3+): [Source: architecture/3-tech-stack.md]
```typescript
import { formatDistanceToNow } from 'date-fns'
import { sv } from 'date-fns/locale'

formatDistanceToNow(new Date(notification.created_at), {
  locale: sv,
  addSuffix: true,
})
// → "2 timmar sedan", "igår"
```

### Icons Mapping

Use Lucide Icons (already in project): [Source: architecture/3-tech-stack.md]
```typescript
import { FileEdit, XCircle, Gavel, Clock, Bell } from 'lucide-react'

const NOTIFICATION_ICON_MAP: Record<string, React.ComponentType> = {
  AMENDMENT_DETECTED: FileEdit,
  LAW_REPEALED: XCircle,
  RULING_CITED: Gavel,
  AMENDMENT_REMINDER: Clock,
  // Fallback for collaboration types (future):
  TASK_ASSIGNED: Bell,
  // ... etc
}
```

### Authentication Pattern for API Routes

Follow the established pattern from other API routes: [Source: architecture/11-backend-architecture.md, architecture/17-coding-standards.md]
```typescript
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth/auth-options'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const session = await getServerSession(authOptions)
  if (!session?.user?.id) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  // ... use session.user.id and workspace from query/session
}
```

### Workspace ID Resolution

The `NotificationBell` component lives inside the `WorkspaceProvider` context tree (see `components/layout/workspace-shell.tsx:66`). Use the `useWorkspace()` hook to get the active workspace ID: [Source: lib/hooks/use-workspace.tsx:136-142]

```typescript
import { useWorkspace } from '@/lib/hooks/use-workspace'

// Inside NotificationBell component:
const { workspaceId, isLoading: workspaceLoading } = useWorkspace()
```

The hook returns:
```typescript
interface WorkspaceContextValue {
  workspaceId: string
  workspaceName: string
  workspaceSlug: string
  workspaceStatus: WorkspaceStatus | null
  role: WorkspaceRole
  isLoading: boolean
  error: string | null
  refresh: () => Promise<void>
}
```

**Do NOT pass `workspaceId` as a prop** from Header — it is not in the Header's props. Use `useWorkspace()` directly inside `NotificationBell`.

For `userId`: the Header receives `user.id` via props (typed as `id?: string`). Pass it to `NotificationBell` as a prop, or have `NotificationBell` accept it. Guard for `undefined` (show bell without badge while loading).

### File Locations

Per project structure [Source: architecture/12-unified-project-structure.md]:

```
app/api/notifications/
  unread-count/route.ts                    -- NEW: unread count endpoint
  route.ts                                 -- NEW: list notifications endpoint
  [id]/read/route.ts                       -- NEW: mark single as read
  mark-all-read/route.ts                   -- NEW: mark all as read

components/features/notifications/
  notification-bell.tsx                    -- NEW: bell + popover component
  notification-item.tsx                    -- NEW: individual notification row

components/layout/
  header.tsx                               -- MODIFY: replace placeholder with NotificationBell
```

Import aliases: use `@/lib/...`, `@/components/...`, `@prisma/client` [Source: architecture/12-unified-project-structure.md#12.5]

### Error Handling

- API routes: return proper HTTP status codes (401 for unauthenticated, 404 for not found, 500 for server error) [Source: architecture/18-error-handling-strategy.md]
- Client component: handle fetch errors gracefully — show bell without badge if count fetch fails, show error state in dropdown if list fetch fails [Source: architecture/18-error-handling-strategy.md#18.7]

### Performance Considerations

- Unread count query uses the existing `@@index([user_id, read_at])` index on `Notification` — should be fast [Source: prisma/schema.prisma:1064]
- Polling interval: 5 minutes is low-overhead (12 requests/hour per user)
- Notification list query: only 5 results, using index — negligible

## Testing

**Test location:** `tests/unit/components/features/notifications/notification-bell.test.tsx` (component) + `tests/unit/app/api/notifications/` (API routes) [Source: architecture/12-unified-project-structure.md — tests mirror source structure]

**Test framework:** Vitest 1.4+ with React Testing Library for component tests, `vi.mock()` for Prisma [Source: architecture/3-tech-stack.md#Frontend Testing, #Backend Testing]

**Mocking strategy:**
- Mock `@/lib/prisma` using `vi.mock()` — never hit real database [Source: Story 8.4/8.15 established pattern]
- Mock `next-auth` / `getServerSession` for API route tests
- Mock `fetch` for component tests (polling behavior)
- Mock `next/navigation` (`useRouter`) for navigation on click

**Unit tests — NotificationBell component:**
- Renders bell icon
- Shows badge with unread count when count > 0
- Hides badge when count = 0
- Opens popover on click showing notifications
- Shows empty state "Inga nya notifieringar" when no notifications
- Clicking notification calls mark-as-read and navigates
- "Markera alla som lästa" button calls mark-all-read API and clears badge
- Polls for count updates (mock `setInterval`)

**Unit tests — notification-item component:**
- Renders correct icon for each `NotificationType`
- Truncates title to 50 chars
- Shows relative time in Swedish
- Full title on hover (title attribute)

**Unit tests — API routes:**
- `GET /api/notifications/unread-count`: returns 401 without session, returns correct count with session
- `GET /api/notifications`: returns 401 without session, returns array of notifications ordered by created_at desc, enriches with link_url
- `PATCH /api/notifications/[id]/read`: returns 401 without session, returns 404 for non-existent notification, marks as read
- `PATCH /api/notifications/mark-all-read`: returns 401 without session, updates all unread for user+workspace

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with existing Notification model, ChangeEvent, NotificationPreference | Sarah (PO) |
| 2026-02-17 | 3.0     | SM enrichment: Full architecture context from Stories 8.4/8.15/8.16 dev records. Added source references to all models and files. Corrected file locations per project structure. Added API routes (4 endpoints), notification→navigation resolution pattern, header.tsx placeholder identification, shadcn/ui component inventory, date-fns locale pattern, icon mapping, auth pattern for API routes, workspace ID resolution note. Expanded tasks from 6 to 9 with detailed subtasks. Added comprehensive testing section with established mock patterns. | Bob (SM) |
| 2026-02-17 | 3.1     | PO validation fixes: (S1) Replaced vague workspace ID resolution with concrete `useWorkspace()` hook from `lib/hooks/use-workspace.tsx` — full interface documented, explicit "do NOT pass as prop" guidance. (S2) Corrected Task 7: `NotificationBell` receives `userId` as prop, gets `workspaceId` via `useWorkspace()` internally, not passed from Header. Updated "Existing App Header" section to match. (N1) Added `aria-label` accessibility guidance and loading skeleton subtask to Task 5. (N2) Added loading `Skeleton` in dropdown while fetching. (N3) Made notification list `take` param configurable via `?limit=N` query param in Task 2. Status → Approved. | Sarah (PO) |
| 2026-02-17 | 4.0     | Implementation complete: 4 API routes, 2 client components, header integration, 34 unit tests (6 files), all passing. tsc clean. Status → Ready for Review. | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List

**New files:**
- `app/api/notifications/unread-count/route.ts` — GET endpoint returning `{ count }` of unread notifications
- `app/api/notifications/route.ts` — GET endpoint returning last N unread notifications with `link_url` enrichment
- `app/api/notifications/[id]/read/route.ts` — PATCH endpoint to mark single notification as read
- `app/api/notifications/mark-all-read/route.ts` — PATCH endpoint to mark all unread as read
- `components/features/notifications/notification-bell.tsx` — Bell icon with Popover dropdown, polling, badge
- `components/features/notifications/notification-item.tsx` — Individual notification row with icon, truncation, relative time
- `tests/unit/app/api/notifications/unread-count.test.ts` — 3 tests for unread-count endpoint
- `tests/unit/app/api/notifications/notifications-list.test.ts` — 6 tests for notifications list endpoint
- `tests/unit/app/api/notifications/mark-read.test.ts` — 4 tests for mark-as-read endpoint
- `tests/unit/app/api/notifications/mark-all-read.test.ts` — 3 tests for mark-all-read endpoint
- `tests/unit/components/features/notifications/notification-bell.test.tsx` — 11 tests for NotificationBell component
- `tests/unit/components/features/notifications/notification-item.test.tsx` — 7 tests for NotificationItem component

**Modified files:**
- `components/layout/header.tsx` — Replaced disabled bell placeholder with `<NotificationBell userId={user.id} />`

### Debug Log References

No blocking issues encountered.

- Type fix: `exactOptionalPropertyTypes` required `userId?: string | undefined` (not just `userId?: string`) for the NotificationBellProps interface when receiving `user.id` which is `string | undefined`.
- Pre-existing type error: `laglig-email-layout.tsx:106` unused `headerText` variable (TS6133) — confirmed not introduced by this story.
- Used `getWorkspaceContext()` from `@/lib/auth/workspace-context` instead of raw `getServerSession()` for API routes — provides both `userId` and `workspaceId` in one call with proper auth/workspace validation.
- Used `BadgeVariants` was not needed — implemented badge as a styled `<span>` for the count indicator (more flexible positioning than shadcn Badge component).

### Completion Notes

- All 9 tasks completed with all subtasks checked
- 34 tests across 6 test files, all passing
- `npx tsc --noEmit` passes (only pre-existing `headerText` TS6133 error in `laglig-email-layout.tsx`)
- Full regression: 10 pre-existing failures in unrelated areas (performance-audit, integration tests, agency-pdf-registry), 0 new failures introduced
- Navigation enrichment implemented via Option A (enrich GET /api/notifications response with `link_url`)
- "Visa alla" button rendered as disabled (story AC says "can be a no-op" for now)

## QA Results

### Review Date: 2026-02-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. Clean, consistent code following established project patterns. All 4 API routes use the `getWorkspaceContext()` abstraction for auth+workspace resolution — this is the correct pattern per the codebase and provides proper multi-tenant isolation. Component architecture is well-structured with clear separation between the bell container and item sub-component. Tests are comprehensive with 34 passing across 6 files.

### Refactoring Performed

None. Code quality does not warrant refactoring.

### Requirements Traceability

| AC | Description | Implementation | Test Coverage |
|----|-------------|----------------|---------------|
| 1 | Bell replaces placeholder in header | `header.tsx:87` — `<NotificationBell userId={user.id} />` | bell.test: renders bell icon |
| 2 | Red badge with unread count | `notification-bell.tsx:120-124` — destructive bg span | bell.test: shows badge with count > 0 |
| 3 | Badge disappears when count=0 | `notification-bell.tsx:120` — `{unreadCount > 0 && ...}` | bell.test: hides badge when count=0 |
| 4 | Popover shows last 5 notifications | `notification-bell.tsx:107` — Popover + fetch on open | bell.test: opens popover and shows notifications |
| 5 | Icon, title (50ch), body, relative time | `notification-item.tsx:46-84` — full rendering | item.test: 4 tests covering each sub-element |
| 6 | Click marks read + navigates | `notification-item.tsx:58-63` — handleClick | item.test: calls onMarkRead and navigates |
| 7 | "Visa alla" link | `notification-bell.tsx:179-186` — disabled button (no-op per AC) | N/A (disabled placeholder) |
| 8 | Click outside closes dropdown | Radix Popover built-in behavior | N/A (framework behavior) |
| 9 | Empty state "Inga nya notifieringar" | `notification-bell.tsx:160-162` | bell.test: shows empty state |
| 10 | "Markera alla som lästa" button | `notification-bell.tsx:132-141` | bell.test: calls mark-all-read API |
| 11 | GET /api/notifications/unread-count | `unread-count/route.ts` — full implementation | 3 tests: auth, count, zero |
| 12 | GET /api/notifications | `route.ts` — with limit param + enrichment | 6 tests: auth, list, enrichment, limit handling |
| 13 | PATCH /api/notifications/[id]/read | `[id]/read/route.ts` — ownership check + update | 4 tests: auth, 404, read, ownership |
| 14 | PATCH /api/notifications/mark-all-read | `mark-all-read/route.ts` — updateMany | 3 tests: auth, update, zero case |
| 15 | All routes require auth | All use `getWorkspaceContext()` which throws on no session | Every route test includes 401 case |
| 16 | Poll every 5 minutes | `notification-bell.tsx:18,70` — `setInterval(fetchUnreadCount, POLL_INTERVAL_MS)` | bell.test: polls for updates on interval |
| 17 | Update badge without reload | `notification-bell.tsx:41` — `setUnreadCount(data.count)` | bell.test: shows badge update |
| 18 | Re-fetch on bell open | `notification-bell.tsx:81` — `if (open) { fetchNotifications() }` | bell.test: opens popover and shows notifications |

**All 18 ACs covered.** No gaps.

### Compliance Check

- Coding Standards: ✓ Strict TypeScript, no `any`, proper error handling, consistent patterns
- Project Structure: ✓ Files in correct directories per architecture/12-unified-project-structure.md
- Testing Strategy: ✓ Vitest + RTL for components, vi.mock for Prisma/auth, 34 tests all passing
- All ACs Met: ✓ 18/18 acceptance criteria traced to implementation and tests

### Improvements Checklist

- [x] All API routes use proper auth via `getWorkspaceContext()` (better than raw `getServerSession`)
- [x] Ownership check on mark-as-read prevents cross-user access
- [x] Accessible: dynamic aria-label on bell button (WCAG 2.1 AA)
- [x] Loading skeletons in dropdown while fetching
- [x] 99+ cap on badge display
- [ ] **Advisory**: `Number(limitParam)` in GET /api/notifications can produce NaN for non-numeric strings (e.g., `?limit=abc`). `Math.min(Math.max(1, NaN), 20)` = NaN, which would cause Prisma to throw (caught by generic 500). Consider defaulting on `isNaN()` check. Low priority — results in a 500 that's properly handled.
- [ ] **Advisory**: Client-side `handleMarkRead` and `handleMarkAllRead` don't check `res.ok` before optimistic UI update. If server returns HTTP error (non-network), the notification disappears from the list but isn't actually marked read. It self-corrects on next popover open. Low impact for a notification feature.

### Security Review

**PASS.** No concerns.

- All 4 API routes authenticate via `getWorkspaceContext()` which validates session + workspace membership
- Mark-as-read route verifies notification ownership (user_id + workspace_id match) before allowing update
- No raw user input in SQL — all through Prisma parameterized queries
- No XSS risk — React handles output escaping
- No secrets exposed in client-side code

### Performance Considerations

**PASS.** No concerns.

- Polling at 5-minute interval = 12 requests/hour/user — negligible server load
- Unread count query hits `@@index([user_id, read_at])` — fast index scan
- Notification list limited to 5 results by default (max 20) — negligible
- N+1 enrichment queries for `link_url` (max 5 individual `changeEvent.findUnique` calls) — acceptable at this scale. If limit increases significantly in the future, consider batching.

### Files Modified During Review

None. No refactoring performed.

### Gate Status

Gate: **PASS** → docs/qa/gates/8.5-in-app-notification-bell.yml

### Recommended Status

✓ Ready for Done

Two advisory items noted (NaN limit, optimistic update without res.ok check) — both low priority and self-correcting. Neither warrants blocking. Excellent implementation overall.
