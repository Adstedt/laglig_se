# Story 2.28: Unified SFS PDF Sync & Document Classification

## Status

Done

## Story

**As a** system maintainer,
**I want** a unified sync system that fetches PDFs for all SFS documents (lagar, förordningar, amendments) from svenskforfattningssamling.se when detected via Riksdagen API,
**so that** we have a complete PDF archive for front-end use and can classify documents by type (lag vs förordning) while parsing only amendments for section-level changes.

## Background

### Current State

The system has two separate, disconnected processes:

1. **Riksdagen API sync** (`sync-sfs`, `sync-sfs-updates`) - Detects new/changed laws, stores consolidated text
2. **svenskforfattningssamling.se ingestion** (`ingest-amendments.ts`) - Manual batch job that crawls index pages to find amendment PDFs

### Problems with Current Approach

- **No ongoing sync** for new amendment PDFs - requires manual batch runs
- **Two independent processes** can drift out of sync
- **Crawling is wasteful** - fetches entire index pages when we already know what changed
- **No classification** - all SFS documents stored as `SFS_LAW` regardless of type (lag vs förordning)
- **PDFs only for amendments** - no PDF archive for new laws or förordningar

### Proposed Solution: Riksdagen-Driven Unified Sync

Use Riksdagen API as the **single source of truth** for what's new/changed, then:

1. Construct direct URLs to svenskforfattningssamling.se (no crawling)
2. Fetch PDFs for ALL document types
3. Classify documents (lag vs förordning vs amendment)
4. Parse with LLM only for amendments (section-level changes)
5. Store all PDFs in Supabase Storage for future front-end use

## Dependencies

- **Story 2.13** (Amendment Documents & Historical Versions) - Phase 2 complete
  - PDF parsing infrastructure (`lib/external/pdf-parser.ts`)
  - LLM parsing (`lib/external/llm-amendment-parser.ts`)
  - Supabase Storage setup (`lib/supabase/storage.ts`)
  - `AmendmentDocument` and `SectionChange` tables

## Supersedes

This story consolidates and replaces:

- **Story 2.18** - Amendment PDF Integration for Change Monitoring
- **Story 2.25** - Amendment Sync Automation

## Acceptance Criteria

### PDF Fetching (All Document Types)

1. **AC1:** When `sync-sfs` inserts a NEW SFS document, fetch its PDF from svenskforfattningssamling.se
2. **AC2:** When `sync-sfs-updates` detects an amendment (undertitel changed), fetch the amendment PDF
3. **AC3:** Construct PDF URLs directly from SFS number + publication date (no crawling):
   - HTML: `https://svenskforfattningssamling.se/doc/{YYYYNNNN}.html`
   - PDF: `https://svenskforfattningssamling.se/sites/default/files/sfs/{YYYY-MM}/SFS{YYYY}-{NNNN}.pdf`
4. **AC4:** Store all PDFs in Supabase Storage bucket `sfs-pdfs` with path `{YYYY}/SFS{YYYY}-{NNNN}.pdf`
5. **AC5:** Store PDF metadata in `LegalDocument.metadata.pdf`: `{ storagePath, storageBucket, originalUrl, fileSize, fetchedAt }`

### Document Classification

6. **AC6:** Classify all SFS documents by parsing title using `classifyLawType()`:
   - `type`: `'lag'` | `'förordning'` | `'kungörelse'` | `'other'`
   - `category`: `'new'` | `'amendment'` | `'repeal'`
   - `targetType`: For amendments - type of document being modified
   - `targetSfs`: For amendments - SFS number of target document
7. **AC7:** Store classification in `LegalDocument.metadata`: `{ lawType, documentCategory, baseLawSfs, baseLawType, classificationConfidence }`

### Amendment Parsing (Only Amendments)

8. **AC8:** For documents classified as `category: 'amendment'`:
   - Extract text from PDF using `unpdf`
   - Parse with LLM to extract section changes
   - Create `AmendmentDocument` and `SectionChange` records
   - Link to base law via `base_law_sfs`
9. **AC9:** For documents classified as `category: 'new'` or `'repeal'`: Store PDF only, no LLM parsing

### Error Handling & Reliability

10. **AC10:** PDF fetch failures are logged but don't block the sync job
11. **AC11:** Failed PDFs are marked for retry (store failure in metadata)
12. **AC12:** Weekly retry cron for failed PDF fetches
13. **AC13:** Rate limit PDF fetches: 1 request/second to svenskforfattningssamling.se

### Observability

14. **AC14:** Sync summary includes PDF stats: `{ pdfsFetched, pdfsStored, pdfsFailed, amendmentsParsed }`
15. **AC15:** Email notification includes PDF/amendment stats

## Tasks / Subtasks

- [x] **Task 1: Create `classifyLawType()` utility** (AC: 6, 7)
  - [x] Create `lib/sfs/classify.ts` with classification logic
  - [x] Handle patterns: `"Lag (...)"`, `"Förordning (...)"`, `"om ändring i"`, `"om upphävande av"`
  - [x] Extract target SFS number for amendments/repeals
  - [x] Return confidence score based on pattern match strength
  - [x] Unit tests for all classification patterns

- [x] **Task 2: Create PDF URL construction utility** (AC: 3)
  - [x] Create `lib/sfs/pdf-urls.ts` with `constructPdfUrls(sfsNumber, publicationDate)`
  - [x] Handle SFS number padding (e.g., "2025:123" → "20250123")
  - [x] Handle year-month extraction from publication date
  - [x] Unit tests for URL construction

- [x] **Task 3: Create PDF fetch and storage utility** (AC: 4, 5, 10, 13)
  - [x] Create `lib/sfs/pdf-fetcher.ts` with `fetchAndStorePdf(sfsNumber, publicationDate)`
  - [x] Download PDF from svenskforfattningssamling.se
  - [x] Upload to Supabase Storage bucket `sfs-pdfs`
  - [x] Return metadata object for storage in LegalDocument
  - [x] Implement rate limiting (1 req/sec)
  - [x] Handle failures gracefully (log, return null)

- [x] **Task 4: Enhance `sync-sfs` for new documents** (AC: 1, 6, 7, 9)
  - [x] Classify document using `classifyLawType()` before insert
  - [x] Fetch PDF using `fetchAndStorePdf()`
  - [x] Store classification and PDF metadata in LegalDocument.metadata
  - [x] Update stats to include PDF counts

- [x] **Task 5: Enhance `sync-sfs-updates` for amendments** (AC: 2, 6, 7, 8)
  - [x] When `undertitel` changes, extract amendment SFS number
  - [x] Classify the amendment document
  - [x] Fetch amendment PDF using `fetchAndStorePdf()`
  - [x] Create `AmendmentDocument` record with PDF storage path
  - [x] Link to base law
  - [x] Update stats to include PDF/amendment counts

- [x] **Task 6: Create retry mechanism for failed PDFs** (AC: 11, 12)
  - [x] Store failure info in `LegalDocument.metadata.pdf.error`
  - [x] Create cron job `/api/cron/retry-failed-pdfs` (weekly)
  - [x] Query documents with `metadata.pdf.error IS NOT NULL`
  - [x] Retry fetch for failed PDFs
  - [x] Add cron entry to `vercel.json`: `{ "path": "/api/cron/retry-failed-pdfs", "schedule": "0 6 * * 0" }` (Sundays 6 AM)

- [x] **Task 7: Update email notifications** (AC: 14, 15)
  - [x] Extend `sendSfsSyncEmail()` to include PDF stats
  - [x] Add amendment parsing stats

- [x] **Task 8: Integration tests**
  - [x] Test end-to-end flow with mock PDF
  - [x] Test classification for different document types
  - [x] Test PDF storage and metadata

## Dev Notes

### Source Tree

```
lib/
├── sfs/                              # NEW - SFS-specific utilities
│   ├── classify.ts                   # Document classification
│   ├── pdf-urls.ts                   # URL construction
│   └── pdf-fetcher.ts                # PDF fetch + storage
├── external/
│   ├── pdf-parser.ts                 # FROM 2.13 - PDF text extraction
│   └── llm-amendment-parser.ts       # FROM 2.13 - Amendment parsing
├── supabase/
│   └── storage.ts                    # Existing - PDF upload utilities

app/api/cron/
├── sync-sfs/route.ts                 # MODIFY - Add PDF fetch + classification
├── sync-sfs-updates/route.ts         # MODIFY - Add amendment PDF fetch + parsing
└── retry-failed-pdfs/route.ts        # NEW - Weekly retry for failed PDFs

tests/
├── unit/lib/sfs/
│   ├── classify.test.ts              # Classification tests
│   └── pdf-urls.test.ts              # URL construction tests
└── integration/sfs/
    └── pdf-sync.test.ts              # End-to-end PDF sync tests
```

### URL Construction Logic

```typescript
function constructPdfUrls(sfsNumber: string, publicationDate: string) {
  // sfsNumber: "2025:1581"
  // publicationDate: "2025-12-23"

  const [year, number] = sfsNumber.split(':')
  const paddedNumber = number.padStart(4, '0')
  const yearMonth = publicationDate.substring(0, 7) // "2025-12"

  return {
    html: `https://svenskforfattningssamling.se/doc/${year}${paddedNumber}.html`,
    pdf: `https://svenskforfattningssamling.se/sites/default/files/sfs/${yearMonth}/SFS${year}-${number}.pdf`,
  }
}
```

### Classification Logic Overview

```typescript
function classifyLawType(title: string): SfsClassification {
  // Detect category first
  const isAmendment = title.includes('om ändring i')
  const isRepeal = title.includes('om upphävande av')
  const category = isAmendment ? 'amendment' : isRepeal ? 'repeal' : 'new'

  // Detect document type
  const type = title.includes('förordning')
    ? 'förordning'
    : title.includes('lag') || title.includes('balk')
      ? 'lag'
      : title.includes('kungörelse')
        ? 'kungörelse'
        : 'other'

  // For amendments, extract target info
  const targetSfs = extractTargetSfs(title) // e.g., "1977:1160"
  const targetType = extractTargetType(title) // e.g., "lag"

  return { type, category, targetType, targetSfs, confidence }
}
```

### Enhanced Sync Flow

```
Riksdagen API detects new/changed SFS
        │
        ▼
┌───────────────────────────────────────┐
│ 1. Classify document (classifyLawType) │
│    → type: lag/förordning              │
│    → category: new/amendment/repeal    │
└───────────────────┬───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐
│ 2. Construct PDF URL (no crawling!)   │
│    → svenskforfattningssamling.se     │
└───────────────────┬───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐
│ 3. Fetch PDF → Supabase Storage       │
│    → All types: store for front-end   │
└───────────────────┬───────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
   category=new          category=amendment
        │                       │
        ▼                       ▼
┌───────────────┐     ┌─────────────────────┐
│ Store PDF     │     │ Store PDF           │
│ metadata only │     │ + LLM Parse         │
│               │     │ + AmendmentDocument │
│               │     │ + SectionChange     │
└───────────────┘     └─────────────────────┘
```

### Supabase Storage Structure

**Note:** The `sfs-pdfs` bucket already exists from Story 2.13 implementation. No bucket creation needed.

```
sfs-pdfs/                           # Bucket (already exists)
├── 2018/
│   ├── SFS2018-0001.pdf
│   └── ...
├── 2019/
│   └── ...
├── ...
└── 2025/
    ├── SFS2025-0001.pdf           # New law
    ├── SFS2025-0123.pdf           # Förordning
    └── SFS2025-1581.pdf           # Amendment (also parsed)
```

### LegalDocument.metadata Structure

```typescript
interface LegalDocumentMetadata {
  // Existing fields
  dokId: string
  systemdatum: string
  latestAmendment: string | null

  // NEW: Classification
  lawType: 'lag' | 'förordning' | 'kungörelse' | 'other'
  documentCategory: 'new' | 'amendment' | 'repeal'
  baseLawSfs: string | null // For amendments: "1977:1160"
  baseLawType: string | null // For amendments: "lag"
  classificationConfidence: number // 0.0 - 1.0

  // NEW: PDF storage
  pdf: {
    storagePath: string // "2025/SFS2025-1581.pdf"
    storageBucket: string // "sfs-pdfs"
    originalUrl: string // Full URL to source
    fileSize: number // Bytes
    fetchedAt: string // ISO timestamp
    error?: string // If fetch failed
  } | null
}
```

### Rate Limiting

```typescript
const PDF_FETCH_DELAY_MS = 1000 // 1 second between requests

// In sync loop
for (const doc of documents) {
  await processDocument(doc)
  await delay(PDF_FETCH_DELAY_MS)
}
```

### Daily Volume Expectations

- New SFS documents per day: ~5-15
- Amendments per day: ~1-5
- Total PDF fetches per day: ~10-20
- LLM parses per day: ~1-5 (only amendments)

This volume is easily handled within cron timeout limits (5 minutes).

## Testing

### Test File Locations

- Unit tests: `tests/unit/lib/sfs/*.test.ts`
- Integration tests: `tests/integration/sfs/*.test.ts`

### Test Standards

- Use Vitest as test runner
- Mock external services (svenskforfattningssamling.se, Supabase Storage, LLM)
- Test classification for all document type patterns
- Test URL construction edge cases (padding, special characters)
- Test error handling (PDF fetch failure, LLM timeout)

### Key Test Cases

```typescript
// Classification tests
describe('classifyLawType', () => {
  it('classifies "Arbetsmiljölag (1977:1160)" as lag/new')
  it('classifies "Förordning (2024:456) om..." as förordning/new')
  it('classifies "Lag (2025:1581) om ändring i..." as lag/amendment')
  it('extracts targetSfs for amendments')
  it('handles edge cases (kungörelse, unusual formats)')
})

// URL construction tests
describe('constructPdfUrls', () => {
  it('constructs correct URLs for standard SFS numbers')
  it('pads SFS numbers correctly (123 → 0123)')
  it('extracts year-month from publication date')
})

// PDF fetch tests
describe('fetchAndStorePdf', () => {
  it('downloads and uploads PDF successfully')
  it('handles 404 errors gracefully')
  it('respects rate limiting')
  it('returns correct metadata structure')
})
```

## Scope Notes

- **In Scope:**
  - PDF fetching for all SFS documents (2018+)
  - Document classification (lag vs förordning)
  - Amendment parsing with LLM
  - Supabase Storage for PDF archive
  - Weekly retry for failed PDFs

- **Out of Scope:**
  - Historical backfill of PDFs for pre-existing documents (separate story)
  - UI for filtering by law type (separate story)
  - PDF viewer in front-end (separate story)
  - Pre-2018 PDFs from rkrattsdb.gov.se (covered by existing batch jobs)

## Change Log

| Date       | Version | Description                                                                  | Author     |
| ---------- | ------- | ---------------------------------------------------------------------------- | ---------- |
| 2025-12-26 | 0.1     | Initial draft - consolidates 2.18 + 2.25 with new scope                      | Bob (SM)   |
| 2025-12-26 | 0.2     | PO validation passed, added vercel.json note, bucket clarification, approved | Sarah (PO) |

## Dev Agent Record

### Files Created

| File                                      | Purpose                                                        |
| ----------------------------------------- | -------------------------------------------------------------- |
| `lib/sfs/classify.ts`                     | Document classification (lag/förordning, new/amendment/repeal) |
| `lib/sfs/pdf-urls.ts`                     | URL construction for svenskforfattningssamling.se              |
| `lib/sfs/pdf-fetcher.ts`                  | PDF download with rate limiting + Supabase upload              |
| `lib/sfs/index.ts`                        | Barrel export for all SFS utilities                            |
| `app/api/cron/retry-failed-pdfs/route.ts` | Weekly retry cron for failed PDF fetches                       |
| `tests/unit/lib/sfs/classify.test.ts`     | Classification unit tests (29 tests)                           |
| `tests/unit/lib/sfs/pdf-urls.test.ts`     | URL construction unit tests (31 tests)                         |
| `tests/unit/lib/sfs/integration.test.ts`  | Integration tests (25 tests)                                   |

### Files Modified

| File                                     | Changes                                                  |
| ---------------------------------------- | -------------------------------------------------------- |
| `app/api/cron/sync-sfs/route.ts`         | Added classification + PDF fetch before insert           |
| `app/api/cron/sync-sfs-updates/route.ts` | Added amendment PDF fetch + AmendmentDocument creation   |
| `lib/email/cron-notifications.ts`        | Extended SfsSyncStats with PDF stats, updated email HTML |
| `vercel.json`                            | Added retry-failed-pdfs cron (Sundays 6 AM UTC)          |

### Implementation Notes

- All 85 SFS-related tests passing
- Rate limiting: 1 request/second to svenskforfattningssamling.se
- PDF storage path: `{year}/SFS{year}-{number}.pdf` in `sfs-pdfs` bucket
- Classification handles "balk" laws (Brottsbalk, Miljöbalk) as type "lag"
- Target SFS extraction uses matchAll() to get second SFS number in amendments
- **AC8 LLM Parsing**: Amendments are parsed with Claude after PDF storage:
  - PDF downloaded from Supabase Storage
  - Text extracted using `unpdf`
  - Parsed with `parseAmendmentWithLLM()` from Story 2.13
  - `SectionChange` records created for each affected section
  - `AmendmentDocument.parse_status` updated to COMPLETED/FAILED
- LLM parsing happens after main transaction for timeout safety (1-5 amendments/day)

## Story Wrap-Up

### Summary of Changes

This story consolidated Stories 2.18 and 2.25 into a unified SFS sync system that:

1. **Detects ALL amendments via full text extraction** - not just the latest from `undertitel`
2. **Fetches PDFs for all document types** from svenskforfattningssamling.se
3. **Classifies documents** as lag/förordning, new/amendment/repeal
4. **Parses amendments with LLM** to extract section-level changes
5. **Stores PDFs in Supabase Storage** for future front-end use

### Key Technical Decisions

- **Full text extraction** catches 100% of amendments vs 75% with undertitel-only (validated on Dec 17/23 data)
- **`systemdatum`** used for PDF URL construction (amendment publication date proxy)
- **Rate limiting** at 1 req/sec to svenskforfattningssamling.se
- **`sok=` API parameter** used instead of `beteckning=` for reliable base law lookup

### Validation Results

| Detection Method     | Coverage         |
| -------------------- | ---------------- |
| Undertitel only      | 75% (15/20)      |
| Full text extraction | **100%** (20/20) |

5 extra amendments caught only by full text (same-day multiple amendments to base laws).

### Agent Model

Claude Opus 4.5

### Changelog

| Date       | Change                                                   |
| ---------- | -------------------------------------------------------- |
| 2025-12-26 | Initial implementation of all 8 tasks                    |
| 2025-12-26 | Added full text extraction for multi-amendment detection |
| 2025-12-26 | Fixed API query to use `sok=` parameter                  |
| 2025-12-26 | Validated 100% detection rate on Dec 17/23 test data     |

## QA Results

### Review Date: 2025-12-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent**

The implementation demonstrates high code quality with:

- **Clean architecture** - Well-separated utility modules in `lib/sfs/` with single responsibilities
- **Comprehensive typing** - Strong TypeScript interfaces for all data structures
- **Good documentation** - JSDoc comments on all public functions with examples
- **Consistent patterns** - Follows established project conventions for cron jobs and error handling

Notable implementation strengths:

1. **Full text extraction** achieves 100% amendment detection vs 75% with undertitel-only approach
2. Rate limiting prevents overloading svenskforfattningssamling.se
3. LLM parsing moved outside transaction for timeout safety
4. Weekly retry mechanism for failed PDFs

### Refactoring Performed

No refactoring performed - code quality meets standards.

### Compliance Check

- Coding Standards: ✓ Follows project coding standards
- Project Structure: ✓ Files in correct locations (`lib/sfs/`, `app/api/cron/`)
- Testing Strategy: ✓ 85 unit tests covering classification, URL construction, and integration
- All ACs Met: ✓ All 15 acceptance criteria validated

### Improvements Checklist

All items pass review:

- [x] Classification logic handles all document types (lag, förordning, kungörelse, balk)
- [x] URL construction correctly pads SFS numbers for HTML, uses original for PDF
- [x] Rate limiting implemented at 1 req/sec
- [x] Error metadata stored for retry mechanism
- [x] Email notifications include PDF/amendment stats
- [x] vercel.json has retry-failed-pdfs cron entry
- [x] Full text extraction catches multiple amendments per day

Future improvements (optional, not blocking):

- [ ] Consider extracting amendment processing loop to separate utility for better testability
- [ ] Consider converting rate limiter to instance-based for cleaner serverless behavior

### Security Review

**Status: PASS**

- CRON_SECRET authorization properly verified on all cron endpoints
- No hardcoded secrets or credentials
- Input validation on SFS number parsing
- User-Agent header identifies requests appropriately

### Performance Considerations

**Status: PASS**

- Rate limiting prevents external service overload
- LLM parsing executed after main database transaction (timeout safety)
- Daily volume (10-20 PDFs) well within 5-minute cron timeout
- Parallel fetching of HTML and full text where possible

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.28-unified-sfs-pdf-sync-document-classification.yml

| NFR Area        | Status |
| --------------- | ------ |
| Security        | PASS   |
| Performance     | PASS   |
| Reliability     | PASS   |
| Maintainability | PASS   |

Quality Score: **95/100**

### Recommended Status

✓ **Ready for Done**

All acceptance criteria met, comprehensive test coverage, clean implementation with proper error handling and observability.
