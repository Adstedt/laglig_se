# Story 11.2: Customer Overview Dashboard

## Status

Done

## Story

**As an** admin,
**I want** to see a high-level overview of the platform's customers,
**so that** I can quickly understand platform health and growth.

## Acceptance Criteria

1. Dashboard page at `/admin/dashboard`
2. Metric cards displayed:
   - Total workspaces (with breakdown: Active, Paused, Deleted)
   - Total users
   - Subscription tier distribution (Trial, Solo, Team, Enterprise) as count per tier
   - New signups in the last 7 and 30 days (users created in those periods)
3. Recent workspaces table: last 10 created workspaces showing name, owner email, tier, status, created date
4. Recent users table: last 10 registered users showing name, email, last login, workspace count
5. Data fetched server-side via Prisma aggregate queries (no client-side fetching)
6. Page refreshes data on each visit (no caching — use `export const dynamic = 'force-dynamic'`)

## Tasks / Subtasks

- [x] **Task 1: Create admin query utilities** (AC: 2, 3, 4, 5)
  - [x] Create `lib/admin/queries.ts` with the following functions:
  - [x] `getWorkspaceMetrics()` — returns `{ total, active, paused, deleted, byTier: Record<SubscriptionTier, number> }` using `prisma.workspace.groupBy()` and `prisma.workspace.count()`
  - [x] `getUserMetrics()` — returns `{ total, newLast7Days, newLast30Days }` using `prisma.user.count()` with date filters
  - [x] `getRecentWorkspaces(limit: number)` — returns last N workspaces with owner info:
    ```typescript
    prisma.workspace.findMany({
      take: limit,
      orderBy: { created_at: 'desc' },
      select: {
        id: true,
        name: true,
        slug: true,
        subscription_tier: true,
        status: true,
        created_at: true,
        owner: { select: { email: true, name: true } },
        _count: { select: { members: true } },
      },
    })
    ```
  - [x] `getRecentUsers(limit: number)` — returns last N users with workspace count:
    ```typescript
    prisma.user.findMany({
      take: limit,
      orderBy: { created_at: 'desc' },
      select: {
        id: true,
        name: true,
        email: true,
        last_login_at: true,
        created_at: true,
        _count: { select: { workspace_members: true } },
      },
    })
    ```
    Note: The User model relation is `workspace_members WorkspaceMember[]` (not `workspaces`) [Source: prisma/schema.prisma:31]

- [x] **Task 2: Create metric card component** (AC: 2)
  - [x] Create `components/admin/metric-card.tsx` — Server Component
  - [x] Props: `title: string`, `value: number | string`, `description?: string | undefined`, `children?: React.ReactNode | undefined` (for sub-metrics). Note: `exactOptionalPropertyTypes: true` requires the `| undefined` on optional props [Source: tsconfig.json:16]
  - [x] Use shadcn/ui `Card`, `CardHeader`, `CardTitle`, `CardContent`
  - [x] Support sub-items display (e.g. breakdown by status or tier) rendered as a small list inside the card

- [x] **Task 3: Create dashboard page** (AC: 1, 2, 3, 4, 6)
  - [x] Replace `app/admin/(dashboard)/dashboard/page.tsx` — Server Component (replace placeholder from 11.1)
  - [x] Set `export const dynamic = 'force-dynamic'`
  - [x] Fetch all metrics in parallel using `Promise.all()`:
    ```typescript
    const [workspaceMetrics, userMetrics, recentWorkspaces, recentUsers] =
      await Promise.all([
        getWorkspaceMetrics(),
        getUserMetrics(),
        getRecentWorkspaces(10),
        getRecentUsers(10),
      ])
    ```
  - [x] Render metric cards in a responsive grid (2 cols on desktop, 1 on mobile)
  - [x] Render recent workspaces using shadcn/ui `Table` component (no TanStack Table needed for 10 rows)
  - [x] Render recent users using shadcn/ui `Table` component
  - [x] Format dates using `date-fns` with Swedish locale (`sv`)
  - [x] Format "last login" as relative time ("3 timmar sedan", "igår") using `formatDistanceToNow`. Display `null` values as "—" (em dash) since `last_login_at` is nullable

- [x] **Task 4: Testing** (AC: all)
  - **Automated (Vitest)** — write in `tests/unit/lib/admin/queries.test.ts`:
  - [x] Test: `getWorkspaceMetrics()` returns correct shape with groupBy counts
  - [x] Test: `getUserMetrics()` returns correct date-filtered counts
  - [x] Test: `getRecentWorkspaces()` returns workspaces ordered by created_at desc with owner info
  - [x] Test: `getRecentUsers()` returns users ordered by created_at desc with workspace count
  - **Manual:**
  - [ ] Test: dashboard page loads with real data
  - [ ] Test: metrics are accurate against database
  - [ ] Test: page is responsive (mobile/desktop)

## Dev Notes

### Dependencies

- **Blocked by:** Story 11.1 (Admin Auth & Shell Layout) — requires admin auth and layout shell

### Previous Story Insights

**From Story 11.1 (Admin Authentication & Shell Layout) — Done:**

- `cookies()` from `next/headers` must be awaited in Next.js 16: `const cookieStore = await cookies()` [Source: app/(workspace)/layout.tsx:52]
- `exactOptionalPropertyTypes: true` in tsconfig.json requires `| undefined` on optional interface props — e.g. `error?: string | undefined` not just `error?: string` [Source: tsconfig.json:16]
- `noUncheckedIndexedAccess: true` requires optional chaining on array index access (e.g., `arr[0]?.value`) [Source: tsconfig.json:15]
- `noUnusedLocals: true` and `noUnusedParameters: true` are enforced — any unused imports or variables will cause type errors [Source: tsconfig.json:11-12]
- Admin dashboard placeholder at `app/admin/(dashboard)/dashboard/page.tsx` exists and should be **replaced** (not created new) [Source: 11.1 Task 6]
- Admin shell layout with auth guard at `app/admin/(dashboard)/layout.tsx` already sets `export const dynamic = 'force-dynamic'` [Source: app/admin/(dashboard)/layout.tsx]
- 20 pre-existing failing tests (redis, caching, auth signup) exist in the test suite — zero new failures expected [Source: 11.1 Completion Notes]
- `redirect()` must be called outside try/catch to avoid catching Next.js redirect as error [Source: 11.1 Completion Notes]

### Architecture Context

This is a read-only dashboard page. All data is fetched server-side in a Server Component — no client-side state management needed. The admin query functions in `lib/admin/queries.ts` will be extended by Stories 11.3, 11.4, 11.6, and 11.7. [Source: docs/epics/epic-11-admin-backoffice.md#Story Sequencing]

### Relevant Source Tree

```
app/admin/(dashboard)/
  dashboard/
    page.tsx                          # REPLACE: Dashboard page (replace placeholder from 11.1)

lib/admin/
  queries.ts                          # NEW: Admin Prisma query functions

components/admin/
  metric-card.tsx                     # NEW: Reusable metric display card

# REFERENCE FILES:
prisma/schema.prisma                  # Workspace model (line ~58): status, subscription_tier, owner relation
                                      # User model (line ~20): created_at, last_login_at
                                      # WorkspaceMember model (line ~105): user_id, workspace_id
                                      # enum WorkspaceStatus: ACTIVE, PAUSED, DELETED (line ~435)
                                      # enum SubscriptionTier: TRIAL, SOLO, TEAM, ENTERPRISE (line ~441)
lib/prisma.ts                         # Prisma client singleton — import { prisma } from '@/lib/prisma'
app/admin/(dashboard)/layout.tsx      # Existing admin layout with auth guard (from 11.1)
components/admin/admin-sidebar.tsx    # Existing sidebar with Dashboard link (from 11.1)
```

[Source: architecture/12-unified-project-structure.md#12.2, prisma/schema.prisma]

### Key Implementation Details

1. **Workspace metrics query.** Use two queries — `groupBy` for status breakdown and tier breakdown. The `status` enum has values `ACTIVE`, `PAUSED`, `DELETED` and `subscription_tier` has values `TRIAL`, `SOLO`, `TEAM`, `ENTERPRISE` [Source: prisma/schema.prisma:435-446]:

   ```typescript
   const [statusCounts, tierCounts, total] = await Promise.all([
     prisma.workspace.groupBy({ by: ['status'], _count: true }),
     prisma.workspace.groupBy({ by: ['subscription_tier'], _count: true }),
     prisma.workspace.count(),
   ])
   ```

   [Source: architecture/17-coding-standards.md#17.7 — parallel data fetching with Promise.all()]

2. **User date filtering.** Calculate dates server-side. The `User` model has `created_at` (DateTime, non-null) and `last_login_at` (DateTime, nullable) [Source: prisma/schema.prisma:20-28]:

   ```typescript
   const now = new Date()
   const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
   const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)
   ```

3. **Date formatting.** Use `date-fns` v4.1.0 (installed) with Swedish locale [Source: architecture/3-tech-stack.md — date-fns 3.3+]:

   ```typescript
   import { formatDistanceToNow, format } from 'date-fns'
   import { sv } from 'date-fns/locale'

   formatDistanceToNow(date, { addSuffix: true, locale: sv }) // "3 timmar sedan"
   format(date, 'yyyy-MM-dd', { locale: sv }) // "2026-01-31"
   ```

4. **Responsive grid.** Use Tailwind grid [Source: architecture/3-tech-stack.md — Tailwind CSS 3.4+]:

   ```tsx
   <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4">
     {/* metric cards */}
   </div>
   ```

5. **Simple tables.** For 10-row tables, use shadcn/ui `Table` component directly — no need for TanStack Table (that comes in 11.3/11.4) [Source: architecture/17-coding-standards.md#17.3 — MANDATORY shadcn/ui for all UI components].

6. **Workspace `owner` relation.** The Workspace model has `owner User @relation("WorkspaceOwner")` via `owner_id`, so `owner: { select: { email: true, name: true } }` works in Prisma queries [Source: prisma/schema.prisma:62-63].

7. **Workspace `members` relation.** The Workspace model has `members WorkspaceMember[]`, so `_count: { select: { members: true } }` works for member count [Source: prisma/schema.prisma:82].

8. **User `workspaces` relation.** The User model has `workspace_members WorkspaceMember[]`, so for counting user workspaces use `_count: { select: { workspace_members: true } }` (not `workspaces`) [Source: prisma/schema.prisma:31].

### Coding Standards

- Server Components by default — no `'use client'` needed for this page [Source: architecture/17-coding-standards.md#17.3]
- Parallel data fetching with `Promise.all()` [Source: architecture/17-coding-standards.md#17.7]
- Selective field fetching with `select` (not `include` with all fields) [Source: architecture/17-coding-standards.md#17.7]
- shadcn/ui components for cards and tables [Source: architecture/17-coding-standards.md#17.3]
- Import path aliases: `@/lib/admin/queries`, `@/components/admin/metric-card` [Source: architecture/12-unified-project-structure.md#12.5]

### Testing

- **Test file location**: `tests/unit/lib/admin/queries.test.ts` [Source: architecture/12-unified-project-structure.md#12.2 — tests/ directory]
- **Testing framework**: Vitest [Source: architecture/3-tech-stack.md — Vitest 1.4+]
- **Note**: `tests/` directory is excluded from tsconfig `include` — Vitest has its own config [Source: tsconfig.json:49]
- **Mock strategy**: Mock `prisma` using Vitest mocks (`vi.mock('@/lib/prisma')`) — mock the Prisma client singleton, then set up mock return values per test for `groupBy`, `count`, `findMany`
- **Pre-existing test failures**: 20 known failing tests (redis, caching, auth signup) — zero new failures expected from this story [Source: 11.1 Completion Notes]
- **Manual**: Verify dashboard renders with real data, metrics are accurate, page is responsive

## File List

| File                                       | Action   | Description                                                                                             |
| ------------------------------------------ | -------- | ------------------------------------------------------------------------------------------------------- |
| `lib/admin/queries.ts`                     | NEW      | Admin Prisma query functions (getWorkspaceMetrics, getUserMetrics, getRecentWorkspaces, getRecentUsers) |
| `components/admin/metric-card.tsx`         | NEW      | Reusable metric display card component                                                                  |
| `app/admin/(dashboard)/dashboard/page.tsx` | MODIFIED | Replaced placeholder with full dashboard page                                                           |
| `tests/unit/lib/admin/queries.test.ts`     | NEW      | Unit tests for all admin query functions (5 tests)                                                      |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes

- All 4 tasks implemented and verified
- TypeScript type check passes with zero errors
- 5 new unit tests all pass
- Full regression: 20 pre-existing failures (unchanged from 11.1 baseline), 92 test files pass, zero new failures
- All query functions use parallel `Promise.all()` per coding standards
- Server Component throughout — no `'use client'` directives
- `export const dynamic = 'force-dynamic'` set on page
- Swedish locale used for all date formatting
- `last_login_at` null values displayed as em dash ("—")
- Optional props use `| undefined` for `exactOptionalPropertyTypes` compliance
- Array index access uses optional chaining for `noUncheckedIndexedAccess` compliance
- Manual testing items remain for reviewer: page load with real data, metric accuracy, responsiveness

## Change Log

| Date       | Version | Description                                                                                                                                                                                             | Author      |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2026-02-02 | 1.0     | Initial story creation                                                                                                                                                                                  | Sarah (PO)  |
| 2026-02-02 | 1.1     | SM review: Added Previous Story Insights from 11.1, added source references throughout, fixed User relation name (workspace_members not workspaces), added Prisma enum values, enriched testing section | Bob (SM)    |
| 2026-02-02 | 1.2     | PO validation: Fixed Task 3 "Create" → "Replace", "HTML table" → "shadcn/ui Table", added `\| undefined` to optional props, added null handling for last_login_at display                               | Sarah (PO)  |
| 2026-02-02 | 1.3     | Implementation: All tasks complete, 5 unit tests passing, zero regressions, type check clean                                                                                                            | James (Dev) |
| 2026-02-02 | 1.4     | QA Review: PASS — clean implementation, all ACs covered, no issues found                                                                                                                                | Quinn (QA)  |

## QA Results

### Review Date: 2026-02-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The code is clean, well-structured, and follows all project coding standards precisely. Key strengths:

- **Query layer** (`lib/admin/queries.ts`): Clean separation of concerns. Explicit return type interfaces. Parallel fetching with `Promise.all()`. Enum-initialized default maps handle missing `groupBy` rows gracefully (zero-default pattern). Selective field fetching with `select` throughout.
- **Component** (`components/admin/metric-card.tsx`): Focused, reusable. Correct `| undefined` on optional props for `exactOptionalPropertyTypes`. Good composition via `children` slot.
- **Page** (`app/admin/(dashboard)/dashboard/page.tsx`): Server Component throughout (no unnecessary `'use client'`). Parallel data fetching. Swedish locale dates. Null handling for `last_login_at` and `name`. Record-based label maps avoid switch statements. Empty state handling for both tables.
- **Tests** (`tests/unit/lib/admin/queries.test.ts`): All 4 query functions tested. Edge case for missing enum values covered. Date filter presence verified without brittle time assertions. Optional chaining on array access for `noUncheckedIndexedAccess`.

### Refactoring Performed

None required. Implementation is clean as-is.

### Compliance Check

- Coding Standards: ✓ Server Components default, `Promise.all()` parallel fetching, selective `select` queries, shadcn/ui components, `@/` path aliases
- Project Structure: ✓ Files in correct locations (`lib/admin/`, `components/admin/`, `app/admin/(dashboard)/dashboard/`)
- Testing Strategy: ✓ Unit tests for all query functions with Prisma mocks, 5/5 passing
- All ACs Met: ✓ All 6 acceptance criteria fully satisfied (see traceability below)

### Requirements Traceability

| AC  | Requirement                                                    | Implementation                                       | Tests                                                      |
| --- | -------------------------------------------------------------- | ---------------------------------------------------- | ---------------------------------------------------------- |
| 1   | Dashboard at `/admin/dashboard`                                | `app/admin/(dashboard)/dashboard/page.tsx`           | Manual                                                     |
| 2   | Metric cards (workspace breakdown, users, tiers, signups)      | 4 MetricCard instances with sub-item breakdowns      | `getWorkspaceMetrics` (2 tests), `getUserMetrics` (1 test) |
| 3   | Recent workspaces table (10 rows, name/owner/tier/status/date) | shadcn/ui Table with 6 columns + empty state         | `getRecentWorkspaces` (1 test)                             |
| 4   | Recent users table (10 rows, name/email/login/workspaces)      | shadcn/ui Table with 5 columns + empty state         | `getRecentUsers` (1 test)                                  |
| 5   | Server-side Prisma queries (no client fetch)                   | All in `lib/admin/queries.ts`, Server Component page | All 5 tests verify Prisma call args                        |
| 6   | `force-dynamic`                                                | `export const dynamic = 'force-dynamic'` on page     | N/A (config)                                               |

### Improvements Checklist

No issues found. No refactoring needed.

- [x] All query functions tested with correct mock strategy
- [x] Edge case: missing enum values default to zero
- [x] Null handling for optional fields (name, last_login_at)
- [x] Empty table state when no data
- [x] Parallel data fetching in both queries and page

### Security Review

No security concerns. This is a read-only dashboard protected by the admin auth guard in `app/admin/(dashboard)/layout.tsx` (from Story 11.1). No user input processing. No mutations. Query functions use Prisma's parameterized queries (no injection risk). Admin email/session data displayed is within admin context.

### Performance Considerations

No performance concerns. All data fetches use `Promise.all()` for parallelism. Queries use selective `select` fields (no `include` with all relations). `getWorkspaceMetrics` runs 3 parallel queries (2 `groupBy` + 1 `count`). `getUserMetrics` runs 3 parallel `count` queries. Page-level `Promise.all` parallelizes all 4 query functions. For the expected data volumes on an admin dashboard, this will be fast.

### Files Modified During Review

No files modified.

### Gate Status

Gate: **PASS** → docs/qa/gates/11.2-customer-overview-dashboard.yml

### Recommended Status

✓ Ready for Done
