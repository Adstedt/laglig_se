# Story 12.8: Template Catalog Browse Page

## Status

Done

## Story

**As a** logged-in workspace member,
**I want** to browse available law list templates by domain,
**so that** I can find a relevant starting point for my compliance work.

## Acceptance Criteria

1. Authenticated route: `/laglistor/mallar` (within workspace layout, behind auth)
2. Catalog page displays all PUBLISHED templates as cards: template name, domain badge, description excerpt, key stats (document count, section count), target audience tag, primary regulatory body icons/badges
3. Filter by domain (target audience filter deferred to Phase 2 when catalog exceeds 3 templates)
4. Tjänsteföretag variants shown as toggle on parent template card ("Visa tjänsteföretagsversion")
5. Each card links to template detail/preview page (`/laglistor/mallar/{slug}`)
6. Mobile-responsive card grid (1 col mobile, 2-3 col desktop)
7. Empty state for domains with no published templates ("Kommer snart")

## Tasks / Subtasks

- [x] **Task 1: Create catalog route and page** (AC: 1)
  - [x] Create `app/(workspace)/laglistor/mallar/page.tsx` (Server Component, auth-gated via workspace layout)
  - [x] Create `app/(workspace)/laglistor/mallar/loading.tsx` — skeleton: page header placeholder (`h-8 w-48` + `h-5 w-96` with `bg-muted animate-pulse rounded`) followed by 3 card skeletons in responsive grid (`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6`), each card skeleton using `rounded-lg border bg-card p-6 space-y-4` with `bg-muted animate-pulse rounded` blocks for title, badge, description, and stats row
  - [x] Add Next.js metadata export (title: "Mallbibliotek | Laglig", description)
  - [x] Use `export const dynamic = 'force-dynamic'` (matches existing workspace page pattern)
  - [x] Call `getPublishedTemplates()` query, pass results to client component `<TemplateCatalogClient />`
  - [x] If query returns empty array, render full-page empty state (AC: 7)
- [x] **Task 2: Build published templates query** (AC: 2)
  - [x] Create `lib/db/queries/template-catalog.ts` (user-facing queries, separate from admin queries)
  - [x] Define `PublishedTemplate` interface:
    - `id: string`, `name: string`, `slug: string`, `description: string | null`
    - `domain: string`, `target_audience: string | null`
    - `document_count: number`, `section_count: number`
    - `primary_regulatory_bodies: string[]`
    - `is_variant: boolean`
    - `variants: { id: string; name: string; slug: string; document_count: number; section_count: number; target_audience: string | null }[]`
  - [x] `getPublishedTemplates()`: Query `LawListTemplate WHERE status = 'PUBLISHED' AND is_variant = false`, include child variants (also PUBLISHED), select only needed fields
  - [x] Sort: by `domain` asc, then `name` asc (group templates by domain naturally)
  - [x] `getUniqueDomains()`: Extract distinct domains from published templates for filter component
- [x] **Task 3: Build template card component** (AC: 2, 5)
  - [x] Create `components/features/templates/template-card.tsx` (client component, `'use client'`)
  - [x] Props: `template: PublishedTemplate` (serialized from server)
  - [x] Display:
    - Template name as `<CardTitle>`
    - Domain as `<Badge>` (e.g., "Arbetsmiljö", "Miljö")
    - Description excerpt (truncated to ~120 chars with "...")
    - Stats row: document count icon + number, section count icon + number (use `FileText` and `Layers` from lucide-react)
    - Target audience as secondary `<Badge variant="outline">`
    - Primary regulatory body badges (small, muted)
  - [x] Entire card is a `<Link>` to `/laglistor/mallar/{slug}` (detail/preview page — Story 12.9)
  - [x] Use shadcn/ui `<Card>`, `<CardHeader>`, `<CardContent>`, `<CardFooter>`, `<Badge>`
- [x] **Task 4: Implement variant toggle** (AC: 4)
  - [x] On parent template cards that have `variants.length > 0`: render toggle in `<CardFooter>`
  - [x] Toggle label: "Visa tjänsteföretagsversion" (use shadcn/ui `<Switch>` component — verify `components/ui/switch.tsx` exists, if not run `pnpm dlx shadcn@latest add switch`)
  - [x] When toggled ON: update card stats to show variant's `document_count` and `section_count`, update card link to variant's slug (`/laglistor/mallar/{variant-slug}`)
  - [x] Use `useState<boolean>` for toggle state per card
  - [x] When toggled OFF: revert to parent stats and link
  - [x] For Phase 1: only Arbetsmiljö has a variant (Tjänsteföretag, 55 docs / 7 sections)
- [x] **Task 5: Build catalog client component with domain filter** (AC: 3)
  - [x] Create `components/features/templates/template-catalog-client.tsx` (client component, `'use client'`)
  - [x] Props: `templates: PublishedTemplate[]`, `domains: string[]`
  - [x] Domain filter: row of clickable `<Badge>` buttons (one per unique domain + "Alla" default), client-side filtering. Phase 1 = domain filter only; target audience filter deferred to Phase 2.
  - [x] Use `useState<string | null>` for `activeDomain` (null = show all)
  - [x] Filter `templates` array by `activeDomain` — if null, show all; else filter by `domain === activeDomain`
  - [x] Render filtered templates as responsive card grid
  - [x] Per-domain empty state: if filter is active and no templates match, show "Kommer snart" message
- [x] **Task 6: Responsive layout** (AC: 6)
  - [x] Card grid: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6`
  - [x] Cards use equal height within grid rows (flexbox or `min-h` on card)
  - [x] Page header with "Mallbibliotek" title + subtitle, consistent with existing workspace page headers (see `app/(workspace)/laglistor/page.tsx` pattern)
  - [x] Add navigation link to this page from the existing laglistor page — a `<Link>` to `/laglistor/mallar` rendered below the page header, e.g., "Utforska mallar →"
  - [x] Add "Mallbibliotek" as a sub-item in the left sidebar navigation under the "Laglistor" accordion (`components/layout/left-sidebar.tsx`). Place it after the existing "Mina laglistor" link. Use `Library` icon from lucide-react. Follow the existing nav item pattern: `flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors` with active state via `usePathname()` matching `/laglistor/mallar`
  - [x] Add breadcrumb to the catalog page: `Laglistor > Mallbibliotek` — follow existing workspace sub-page breadcrumb pattern for consistent navigation UX
- [x] **Task 7: Empty state** (AC: 7)
  - [x] If catalog is completely empty (no published templates at all): centered message with icon, "Mallbiblioteket är tomt just nu" + "Mallar publiceras inom kort — kom tillbaka snart!" + link back to `/laglistor`
  - [x] If domain filter is active but no templates in that domain: inline message "Inga mallar för detta område ännu — kommer snart"
  - [x] Use a simple centered layout with muted text and `Library` icon from lucide-react (verified to exist — do NOT use `BookTemplate` which may not exist in the installed version)
- [x] **Task 8: Write tests** (AC: all)
  - [x] **Query tests** (`tests/unit/lib/db/queries/template-catalog.test.ts`):
    - Returns only PUBLISHED, non-variant templates
    - Includes variant children on parent templates
    - Returns empty array when no published templates exist
    - Filters out DRAFT/ARCHIVED templates
  - [x] **Card component tests** (`tests/unit/components/features/templates/template-card.test.tsx`):
    - Card renders template name, domain badge, stats
    - Card links to correct detail page URL
    - Variant toggle appears only on cards with variants
    - Variant toggle updates displayed stats
    - Card without variants has no toggle
  - [x] **Catalog client component tests** (`tests/unit/components/features/templates/template-catalog-client.test.tsx`):
    - Renders correct number of template cards
    - Domain filter hides/shows correct cards
    - "Alla" filter shows all templates
    - Empty state renders when no templates match filter
    - Full empty state renders when templates array is empty

## Dev Notes

### Previous Story Insights (Story 12.7c)

Story 12.7c is complete (Ready for Review). Key learnings from Dev Agent Record: [Source: docs/stories/12.7c.cross-list-overlap-viewer.md#Dev Agent Record]

- **Prisma `groupBy` with `having` works correctly** in Prisma v6.19 — `having` has been supported since v4.8. No defensive fallbacks needed.
- **`TemplateOverlapEntry` interface extracted separately** for reuse by the sync dialog — pattern of splitting public/shared interfaces from component-internal types is established.
- **97 unit test files pass (1378 tests)** — full regression baseline to maintain.
- **7 pre-existing integration test failures** (DB FK constraints, unrelated to template stories) — ignore these during development.
- **Server action pattern firmly established**: `getAdminSession()` → Zod validation → entity check → Prisma operation → `revalidatePath()` → try/catch. However, this story is user-facing (not admin), so authentication uses `getWorkspaceContext()` instead.
- **`exactOptionalPropertyTypes` active**: Optional props need explicit `| undefined` annotations when passed from parent components.

### Implementation Context (Decision B — FE First with Mock Data)

This story is built **before** templates are seeded. Use mock/stub template data during development and testing. The catalog page should handle empty states gracefully ("Kommer snart"). The blocking dependency on 12.4/12.5 is removed — build the page now with mock data, real published templates appear later. [Source: docs/epics/epic-12-law-list-templates.md#Decision B]

**Revised dependency**: No longer blocked by 12.4/12.5. Blocked only by 12.2 (schema must exist).

### Route Conflict Resolution (CRITICAL)

[Source: codebase exploration — `app/(workspace)/laglistor/page.tsx`]

**Problem**: The original story specified `/laglistor` as the catalog route, but `app/(workspace)/laglistor/page.tsx` already exists — it's the personal law lists page from Story 4.11 ("Mina laglistor"). There is no `(authenticated)` route group in this codebase; all authenticated routes live under `app/(workspace)/`.

**Resolution**: Template catalog uses the sub-route `/laglistor/mallar` within the existing workspace layout:
- `/laglistor` → Personal law lists (Story 4.11, existing) — "Mina laglistor"
- `/laglistor/mallar` → Template catalog (this story) — "Mallbibliotek"
- `/laglistor/mallar/{slug}` → Template detail/preview (Story 12.9, future)

This is a natural hierarchy: law lists are the parent concept, and templates ("mallar") are a sub-feature that helps users create new law lists from curated starting points.

### Route Structure

Authenticated route under `app/(workspace)/laglistor/mallar/` — automatically auth-gated by the workspace layout (`app/(workspace)/layout.tsx`), which:
1. Calls `getCurrentUser()` — redirects to `/login` if null
2. Resolves workspace context via `getWorkspaceContext()` — redirects to `/onboarding` if no workspace
3. Renders `<WorkspaceShell>` with sidebar navigation

No additional auth checks needed in the page itself — the layout handles it. [Source: `app/(workspace)/layout.tsx`]

### Server Component Pattern

This page should be a Server Component for data fetching. Use `Suspense` + `loading.tsx` for loading states. No SEO/structured data needed since the page is behind auth. [Source: docs/architecture/section-9-summary.md#10.2 — Server-First Rendering]

Follow the existing workspace page pattern from `app/(workspace)/laglistor/page.tsx`:
```typescript
export const dynamic = 'force-dynamic'

export const metadata: Metadata = {
  title: 'Mallbibliotek | Laglig',
  description: 'Utforska färdiga laglistor...',
}

export default async function TemplateCatalogPage() {
  // Server-side data fetch
  const templates = await getPublishedTemplates()
  const domains = [...new Set(templates.map(t => t.domain))]
  return <TemplateCatalogClient templates={templates} domains={domains} />
}
```

### Data Models

[Source: prisma/schema.prisma]

**LawListTemplate (query target):**
```prisma
model LawListTemplate {
  id                        String         @id @default(uuid())
  name                      String
  slug                      String         @unique
  description               String?        @db.Text
  domain                    String
  target_audience           String?
  status                    TemplateStatus @default(DRAFT)
  version                   Int            @default(1)
  document_count            Int            @default(0)
  section_count             Int            @default(0)
  primary_regulatory_bodies String[]
  parent_template_id        String?
  is_variant                Boolean        @default(false)
  variant_filter_field      String?
  metadata                  Json?
  created_by                String
  published_at              DateTime?
  created_at                DateTime       @default(now())
  updated_at                DateTime       @updatedAt

  parent   LawListTemplate?  @relation("TemplateVariant", fields: [parent_template_id], references: [id])
  children LawListTemplate[] @relation("TemplateVariant")
  sections TemplateSection[]
  items    TemplateItem[]
}
```

**Enums:**
```prisma
enum TemplateStatus { DRAFT, IN_REVIEW, PUBLISHED, ARCHIVED }
```

**Key fields for catalog query:**
- `status = PUBLISHED` — only show published templates
- `is_variant = false` — only show parent templates (variants appear as toggles on parent cards)
- `children` relation — to include variant data on parent cards
- `domain` — for filter functionality
- `target_audience` — for secondary filter/display

### Query Strategy

[Source: lib/admin/template-queries.ts — existing admin query patterns]

Create a **separate** query file `lib/db/queries/template-catalog.ts` for user-facing queries. Admin queries live in `lib/admin/template-queries.ts` and should NOT be reused here because:
1. Admin queries include DRAFT/ARCHIVED templates; catalog only shows PUBLISHED
2. Admin queries include pagination/sorting complexity not needed for the catalog
3. Separation of concerns: admin vs. user-facing data access

**Catalog query approach:**
```typescript
export async function getPublishedTemplates(): Promise<PublishedTemplate[]> {
  const templates = await prisma.lawListTemplate.findMany({
    where: {
      status: 'PUBLISHED',
      is_variant: false,
    },
    select: {
      id: true,
      name: true,
      slug: true,
      description: true,
      domain: true,
      target_audience: true,
      document_count: true,
      section_count: true,
      primary_regulatory_bodies: true,
      is_variant: true,
      children: {
        where: { status: 'PUBLISHED' },
        select: {
          id: true,
          name: true,
          slug: true,
          document_count: true,
          section_count: true,
          target_audience: true,
        },
      },
    },
    orderBy: [{ domain: 'asc' }, { name: 'asc' }],
  })
  return templates
}
```

### Existing Component Patterns

[Source: docs/architecture/17-coding-standards.md#17.3]

- **Card component:** `components/ui/card.tsx` (shadcn/ui) — `Card`, `CardHeader`, `CardTitle`, `CardDescription`, `CardContent`, `CardFooter`
- **Badge component:** `components/ui/badge.tsx` (shadcn/ui) — for domain, target audience
- **Switch component:** `components/ui/switch.tsx` (shadcn/ui) — for variant toggle. If missing, install: `pnpm dlx shadcn@latest add switch`
- **Responsive grid:** Tailwind grid classes (`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6`)
- **Icons:** Lucide Icons — `FileText`, `Layers`, `Library`, `ArrowRight` [Source: docs/architecture/3-tech-stack.md#3.1]

### Dark Mode Badge Colors (CRITICAL)

[Source: codebase — `components/features/document-list/document-list-card.tsx`]

All badge color customizations in the workspace MUST include dark mode variants. Existing pattern:
```tsx
// Example from existing document list cards:
<Badge variant="outline" className="bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-950 dark:text-blue-300 dark:border-blue-800">

// Recommended domain badge colors:
// Arbetsmiljö: bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-950 dark:text-amber-300 dark:border-amber-800
// Miljö: bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-950 dark:text-emerald-300 dark:border-emerald-800
```

Badge sizing for compact inline use: `text-xs py-0 px-1.5` (matches existing workspace badge patterns). The `<Badge variant="outline">` base is the recommended starting point for domain and target audience badges.

### Existing Workspace Page Header Pattern

[Source: `app/(workspace)/laglistor/page.tsx`]

```tsx
<div className="space-y-6">
  <div>
    <h1 className="text-2xl font-semibold">Mallbibliotek</h1>
    <p className="mt-1 text-sm text-muted-foreground">
      Utforska färdiga laglistor och hitta en relevant utgångspunkt...
    </p>
  </div>
  {/* Content */}
</div>
```

### Variant Display Logic

[Source: docs/epics/epic-12-law-list-templates.md#Decision 2]

For Phase 1 (3 templates), only Arbetsmiljö has a variant (Tjänsteföretag). The variant toggle appears on the parent card. When toggled, the card stats update to reflect the variant (55 docs, 7 sections instead of 112 docs, 9 sections), and the card link changes to the variant's detail page.

Variants are `LawListTemplate` records with `is_variant = true` and `parent_template_id` set. They contain no `TemplateItem` records of their own — items live on the parent.

### Dependencies

- **Blocked by:** Story 12.2 (schema must exist) ✅ Done
- **Not blocked by:** 12.4/12.5 (seeding) — per Decision B, build with mock/empty data
- **Blocks:** Story 12.10b (reuses published template query from this story)

### Relevant Source Tree

```
# New files
app/(workspace)/laglistor/mallar/page.tsx              # Catalog page (server component)
app/(workspace)/laglistor/mallar/loading.tsx            # Loading skeleton
lib/db/queries/template-catalog.ts                      # User-facing published template query
components/features/templates/template-card.tsx          # Template card (client component)
components/features/templates/template-catalog-client.tsx # Catalog client with filter (client component)

# Modified files
app/(workspace)/laglistor/page.tsx                      # Add "Utforska mallar →" link
components/layout/left-sidebar.tsx                      # Add "Mallbibliotek" nav item under Laglistor accordion

# Test files
tests/unit/lib/db/queries/template-catalog.test.ts      # Query tests
tests/unit/components/features/templates/template-card.test.tsx     # Card component tests
tests/unit/components/features/templates/template-catalog-client.test.tsx  # Catalog client tests
```

### Technical Constraints

- **TypeScript:** 5.5+ strict mode, `exactOptionalPropertyTypes: true` — optional props need explicit `| undefined` [Source: docs/architecture/17-coding-standards.md#17.2]
- **UI Library:** shadcn/ui (Radix UI + Tailwind) — mandatory for all UI components [Source: docs/architecture/17-coding-standards.md#17.3]
- **ORM:** Prisma 6.x with type-safe queries (project uses `^6.19.0`) [Source: package.json]
- **Icons:** Lucide Icons 0.365+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Package manager:** pnpm [Source: docs/architecture/3-tech-stack.md#3.1]
- **Next.js 16:** `searchParams` and `params` are Promises that must be awaited [Source: docs/architecture/12-nextjs-16-migration-notes.md]
- **No ActivityLog:** Templates are system-level entities without workspace context — use plain Prisma operations [Source: Story 12.7a Dev Agent Record]
- **No SEO/structured data:** Page is behind auth, not publicly accessible [Source: Story 12.8 AC, Change Log v1.2]

### Testing

- **Test framework:** Vitest 1.4+ with React Testing Library 14.2+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Test config:** `vitest.config.mts` — environment: `happy-dom`, setup: `tests/setup.ts` [Source: docs/architecture/section-15-summary.md#16.7]
- **Test location:** `tests/unit/lib/db/queries/`, `tests/unit/components/features/templates/`
- **Mocking strategy:** Use `vi.fn()` and `vi.mock()`. Do NOT make real DB calls in unit tests. Mock `prisma.lawListTemplate.findMany` for query tests. [Source: docs/architecture/section-15-summary.md#16.6]
- **Tests needed:**
  - Query: returns only PUBLISHED non-variant templates, includes variant children, handles empty DB
  - Card: renders all fields, links to correct URL, variant toggle behavior, no toggle when no variants
  - Catalog client: renders grid, domain filter works, empty states for filtered and unfiltered views
- **Sample test fixture** (use across all test files):
```typescript
const mockTemplate: PublishedTemplate = {
  id: 'uuid-1',
  name: 'Arbetsmiljö',
  slug: 'arbetsmiljo',
  description: 'Omfattande lagkrav för alla svenska arbetsgivare inom arbetsmiljöområdet.',
  domain: 'arbetsmiljo',
  target_audience: 'Alla svenska arbetsgivare oavsett bransch',
  document_count: 112,
  section_count: 9,
  primary_regulatory_bodies: ['Arbetsmiljöverket', 'Riksdagen'],
  is_variant: false,
  variants: [{
    id: 'uuid-2',
    name: 'Arbetsmiljö för tjänsteföretag',
    slug: 'arbetsmiljo-tjansteforetag',
    document_count: 55,
    section_count: 7,
    target_audience: 'Tjänsteföretag',
  }],
}

const mockTemplateNoVariants: PublishedTemplate = {
  id: 'uuid-3',
  name: 'Miljö',
  slug: 'miljo',
  description: 'Miljölagstiftning för verksamheter med miljöpåverkan.',
  domain: 'miljo',
  target_audience: 'Verksamheter med miljöpåverkan',
  document_count: 98,
  section_count: 9,
  primary_regulatory_bodies: ['Naturvårdsverket', 'Riksdagen'],
  is_variant: false,
  variants: [],
}
```

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Added mock data context, removed seeding dependency per Decision B | Sarah (PO) |
| 2026-02-09 | 1.2     | Moved from public to authenticated route — template catalog is logged-in only, removed SEO/structured data requirements | Sarah (PO) |
| 2026-02-09 | 2.0     | SM enrichment: corrected route from `/laglistor` to `/laglistor/mallar` (conflict with existing Story 4.11 page), corrected route group from `(authenticated)` to `(workspace)` (actual codebase pattern), full architecture context with source references, previous story insights from 12.7c, data model definitions from Prisma schema, query strategy with code example, exact workspace layout auth pattern, existing component patterns with imports, expanded tasks with specific file paths and implementation details, testing strategy with test file locations and mock patterns, variant display logic from epic Decision 2 | Bob (SM) |
| 2026-02-09 | 2.1     | PO validation fixes: (S-1) AC 3 narrowed to domain filter only — target audience filter deferred to Phase 2; (S-2) loading skeleton visual spec added to Task 1 with `bg-muted animate-pulse rounded` pattern matching existing `laglistor/loading.tsx`; (S-3) sidebar nav item "Mallbibliotek" added under Laglistor accordion in Task 6, plus breadcrumb guidance; (S-4) dark mode badge colors section added with recommended domain color palette and `dark:` variant requirements; (N-1) replaced unverified `BookTemplate` icon with `Library`; (N-2) specified `<Switch>` with installation verification step; (N-3) sample `PublishedTemplate` test fixtures added to Testing section; (N-4) breadcrumb `Laglistor > Mallbibliotek` added to Task 6 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No blocking issues encountered.

### Completion Notes
- All 8 tasks implemented and verified
- TypeScript strict mode passes (`npx tsc --noEmit` — zero errors)
- 100 unit test files pass (1398 tests) — up from 97/1378 baseline (+3 files, +20 tests)
- 7 pre-existing integration test failures remain (DB FK constraints, unrelated)
- `switch.tsx` component already existed — no installation needed
- Sidebar "Mallbibliotek" added as static sub-item under Laglistor accordion, preserved in dynamic list builder so it's not overwritten when individual lists load
- Added `isStaticSubPage` active state detection to sidebar for `/laglistor/mallar` path highlighting (existing dynamic list logic only handles `?list=` param links)
- Domain badge colors include dark mode variants per story spec (amber for arbetsmiljo, emerald for miljo, blue for gdpr, red for brandskydd, purple for livsmedel)
- `children` Prisma relation mapped to `variants` in query return type for cleaner API

### File List

**New files:**
- `app/(workspace)/laglistor/mallar/page.tsx` — Catalog page (server component)
- `app/(workspace)/laglistor/mallar/loading.tsx` — Loading skeleton
- `lib/db/queries/template-catalog.ts` — Published template queries + interfaces
- `components/features/templates/template-card.tsx` — Template card with variant toggle
- `components/features/templates/template-catalog-client.tsx` — Catalog client with domain filter + empty states
- `tests/unit/lib/db/queries/template-catalog.test.ts` — Query tests (6 tests)
- `tests/unit/components/features/templates/template-card.test.tsx` — Card component tests (8 tests)
- `tests/unit/components/features/templates/template-catalog-client.test.tsx` — Catalog client tests (6 tests)

**Modified files:**
- `app/(workspace)/laglistor/page.tsx` — Reverted to original (link moved to toolbar)
- `components/layout/left-sidebar.tsx` — Added "Mallbibliotek" nav item under Laglistor accordion + `isStaticSubPage` active state logic
- `components/features/document-list/document-list-page-content.tsx` — Added "Utforska mallar" outline button in toolbar `secondaryActions`
- `components/layout/breadcrumbs.tsx` — Added `mallar: 'Mallbibliotek'` to `routeLabels` map

### Change Log

| Date | Change | Reason |
|------|--------|--------|
| 2026-02-09 | Implemented all 8 tasks | Story 12.8 development |
| 2026-02-09 | Added `isStaticSubPage` active state to sidebar | Existing dynamic list logic only handles `?list=` links, not static sub-pages like `/laglistor/mallar` |
| 2026-02-09 | QA review applied — no code changes needed | Gate PASS, zero immediate issues, status set to Ready for Done |
| 2026-02-09 | Post-QA UX fixes: moved "Utforska mallar" from page header text link to toolbar outline button in `secondaryActions` (next to "+ Lägg till dokument"); removed custom breadcrumb from mallar page (workspace shell already provides one, double breadcrumb was inconsistent with other pages); added `mallar: 'Mallbibliotek'` to workspace shell breadcrumb `routeLabels` | User feedback after visual testing |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent.** Clean, well-structured implementation following established project patterns. Server Component fetches data via `Promise.all`, passes to Client Component for interactivity. Query layer is properly separated from admin queries with targeted `select` fields. All 7 ACs fully implemented. 20 tests across 3 files provide strong coverage.

**Highlights:**
- Prisma query uses `select` for targeted field fetching and `distinct` for efficient domain extraction
- `children` → `variants` mapping in query layer provides a clean public API
- Card component correctly places `<Switch>` outside the `<Link>` wrapper to prevent accidental navigation on toggle click
- Sidebar integration preserves existing dynamic list behavior while adding static sub-page active state detection (`isStaticSubPage`)
- Loading skeleton matches the visual spec with `bg-muted animate-pulse rounded` pattern
- Dark mode badge colors include all required `dark:` variants

### Refactoring Performed

No refactoring performed — code quality is high as-is.

### Compliance Check

- Coding Standards: ✓ — shadcn/ui components used throughout, TypeScript strict mode passes, selective field fetching, `Promise.all` for parallel queries
- Project Structure: ✓ — Files in correct locations (`components/features/templates/`, `lib/db/queries/`, `app/(workspace)/laglistor/mallar/`), test files mirror source structure, `@/` import aliases used
- Testing Strategy: ✓ — Vitest + React Testing Library, Prisma mocked at module level, `userEvent` for interactions, no real DB calls
- All ACs Met: ✓ — See traceability below

### Requirements Traceability

| AC | Description | Validating Tests | Status |
|----|-------------|-----------------|--------|
| 1 | Authenticated route `/laglistor/mallar` | Route exists at correct path; auth handled by workspace layout (convention-based) | ✓ |
| 2 | Card displays name, domain badge, description, stats, audience, regulatory bodies | `template-card.test.tsx`: renders name/badge/stats, renders truncated description, renders audience badge, renders regulatory bodies | ✓ |
| 3 | Filter by domain | `template-catalog-client.test.tsx`: filters by domain click, "Alla" shows all, renders filter badges | ✓ |
| 4 | Variant toggle on parent cards | `template-card.test.tsx`: toggle appears only with variants, toggle updates stats and link, no toggle without variants | ✓ |
| 5 | Card links to `/laglistor/mallar/{slug}` | `template-card.test.tsx`: links to correct detail page URL, link updates on variant toggle | ✓ |
| 6 | Mobile-responsive grid | Implementation uses `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6` (CSS-level, not unit-testable) | ✓ |
| 7 | Empty states | `template-catalog-client.test.tsx`: full empty state with link back, per-domain empty state with "kommer snart" message | ✓ |

### Improvements Checklist

- [x] All 8 tasks fully implemented
- [x] TypeScript strict mode passes (zero errors)
- [x] 20 unit tests pass across 3 files
- [x] Dark mode badge colors included
- [x] Breadcrumb navigation added
- [x] Sidebar nav item with active state detection
- [ ] **Future:** Extract `DOMAIN_LABELS` to shared constant — currently duplicated in `template-card.tsx:19-25` and `template-catalog-client.tsx:11-17`. Low priority (2 files only), recommend addressing when a third consumer appears
- [ ] **Future:** Variant toggle label "Visa tjänsteföretagsversion" is hardcoded — if Phase 2 introduces templates with differently-named variants, consider making this dynamic from variant data

### Security Review

No security concerns. Page is read-only and behind workspace authentication (layout-level `getCurrentUser()` check). Query accepts no user input — fetches all published templates unconditionally. No injection vectors.

### Performance Considerations

No performance concerns. Query uses `select` for targeted fields (no over-fetching). `Promise.all` runs `getPublishedTemplates()` and `getUniqueDomains()` concurrently. `force-dynamic` ensures fresh data on each request. Template catalog is expected to remain small (< 20 templates) so no pagination needed.

### Files Modified During Review

None — no refactoring performed.

### Gate Status

Gate: PASS → docs/qa/gates/12.8-template-catalog-browse.yml
Quality score: 90

### Recommended Status

✓ Ready for Done — All acceptance criteria met, tests pass, no blocking issues.
