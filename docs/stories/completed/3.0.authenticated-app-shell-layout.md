# Story 3.0: Authenticated App Shell Layout

## Status

Completed

## Story

**As a** logged-in user,
**I want** a consistent application layout with header, navigation sidebar, main content area, and AI chat sidebar,
**so that** I can navigate the application efficiently and access AI assistance from any page.

## Context

This story establishes the foundational Four-Panel Layout for all authenticated pages. It is a **prerequisite for Epic 3** (AI Chat Interface) and **Epic 6** (Compliance Workspace). Without this shell, stories like 3.3 (Chat UI) and 6.1 (Dashboard) cannot be properly implemented.

**Reference Documentation:**

- `docs/feature-specifications/02-dashboard-and-workspace.md` - Complete layout specification
- `docs/front-end-spec.md` - Navigation structure and dimensions

## Acceptance Criteria

### Layout Structure

1. Four-panel layout implemented with correct dimensions:
   - Header: 60px height, full width
   - Left Sidebar: 240px fixed width, collapsible on mobile
   - Main Content: Fluid (remaining space)
   - Right Sidebar (AI Chat container): 400px fixed width, foldable

2. Layout renders correctly on desktop (1920√ó1080), tablet (1024√ó768), and mobile (375√ó667)

3. Authenticated layout wrapper (`app/(workspace)/layout.tsx`) protects all child routes

### Header Component

4. Header contains:
   - Laglig.se logo (links to dashboard)
   - Breadcrumb navigation (dynamic based on current route)
   - Global search placeholder (styled input, non-functional - Epic 6)
   - Notification bell placeholder (icon with badge slot, non-functional - Epic 8)
   - User avatar dropdown with: Account settings link, Logout action

5. Header is sticky/fixed at top during scroll

### Left Sidebar (Navigation)

6. Left sidebar contains navigation menu with:
   - Dashboard link (üìã)
   - AI Chat toggle (üí¨) - toggles right sidebar visibility
   - Laglistor accordion placeholder (‚öñÔ∏è) - static for now
   - Alla Lagar link (üìö) - links to existing `/rattskallor` or `/alla-lagar`
   - Uppgifter placeholder (‚úÖ) - non-functional
   - HR accordion placeholder (üë•) - non-functional
   - √Ñndringsbevakning placeholder (üîî) - non-functional
   - Inst√§llningar link (‚öôÔ∏è) - links to settings placeholder page

7. Active navigation item is visually highlighted

8. Accordion items expand/collapse and persist state (localStorage)

9. Trial status widget placeholder at bottom of sidebar (shows "Trial: X days left" mock)

10. Mobile: Sidebar collapses to hamburger menu, slides in as overlay

### Right Sidebar (AI Chat Container)

11. Right sidebar container with fold/unfold mechanism:
    - Toggle button visible when folded (‚ö° or üí¨ icon on right edge)
    - Smooth animation on fold/unfold (200-300ms)
    - Remembers fold state in localStorage

12. When expanded, shows placeholder content: "AI Chat kommer snart" with icon

13. Drop zone visual indicator (dashed border area) for future drag-and-drop

14. Keyboard shortcut: `Cmd/Ctrl + K` or `/` toggles right sidebar

### Main Content Area

15. Main content area is a flex container that:
    - Fills remaining horizontal space
    - Has appropriate padding (24px recommended)
    - Scrolls independently from sidebars
    - Renders child route content via `{children}`

16. Breadcrumb updates dynamically based on route hierarchy

### State Management

17. Sidebar states (collapsed, accordion open/closed) persist across sessions via localStorage

18. Layout state managed via React Context or Zustand store for cross-component access

### Integration

19. Existing public pages (`/lagar`, `/rattskallor`, etc.) remain unaffected (use separate `(public)` layout)

20. Authentication check redirects unauthenticated users to `/login`

21. All new authenticated routes under `(workspace)` route group use this layout

## Tasks / Subtasks

- [x] **Task 1: Install dependencies and create state management** (AC: 17, 18)
  - [x] Install Zustand: `pnpm add zustand`
  - [x] Install shadcn/ui sidebar: `pnpm dlx shadcn@latest add sidebar`
  - [x] Install additional shadcn/ui components:
    - `pnpm dlx shadcn@latest add dropdown-menu`
    - `pnpm dlx shadcn@latest add avatar`
    - `pnpm dlx shadcn@latest add tooltip`
  - [x] Create `lib/stores/layout-store.ts` using Zustand with persist middleware
  - [x] Define state: leftSidebarCollapsed, rightSidebarFolded, accordionStates
  - [x] Note: shadcn/ui sidebar provides SidebarProvider - evaluate if Zustand still needed for right sidebar

- [x] **Task 2: Create workspace route group and layout** (AC: 1, 3, 15)
  - [x] Create `app/(workspace)/layout.tsx` as authenticated layout wrapper
  - [x] Implement authentication check (redirect to /login if not authenticated)
  - [x] Set up CSS Grid or Flexbox for four-panel structure
  - [x] Create `app/(workspace)/page.tsx` that redirects to dashboard

- [x] **Task 3: Build Header component** (AC: 4, 5)
  - [x] Create `components/layout/header.tsx`
  - [x] Implement logo with link to dashboard
  - [x] Create `components/layout/breadcrumbs.tsx` with dynamic route-based breadcrumbs
  - [x] Add global search input placeholder (styled, disabled)
  - [x] Add notification bell icon placeholder with badge slot
  - [x] Create `components/layout/user-menu.tsx` dropdown with avatar, settings link, logout

- [x] **Task 4: Build Left Sidebar component using shadcn/ui** (AC: 6, 7, 8, 9, 10)
  - [x] Create `components/layout/left-sidebar.tsx` using shadcn/ui Sidebar primitives
  - [x] Use `SidebarMenu`, `SidebarMenuItem`, `SidebarMenuButton` for nav items
  - [x] Use `SidebarGroup` with `Collapsible` for accordion sections (Laglistor, HR)
  - [x] Implement active state detection using `isActive` prop based on current route
  - [x] Use `SidebarProvider` state or connect to Zustand for accordion persistence
  - [x] Create `components/layout/trial-status-widget.tsx` in `SidebarFooter`
  - [x] Mobile: shadcn/ui Sidebar has built-in Sheet behavior for mobile overlay

- [x] **Task 5: Build Right Sidebar (AI Chat container)** (AC: 11, 12, 13, 14)
  - [x] Create `components/layout/right-sidebar.tsx`
  - [x] Implement fold/unfold toggle button connected to layout store
  - [x] Add smooth CSS transition for fold animation (200-300ms)
  - [x] Create placeholder content for chat area
  - [x] Add drop zone visual indicator (dashed border)
  - [x] Implement keyboard shortcut listener (Cmd+K, /)

- [x] **Task 6: Implement responsive behavior** (AC: 2, 10)
  - [x] Add Tailwind breakpoint classes for responsive layout
  - [x] Implement mobile sidebar overlay with backdrop
  - [x] Test on desktop, tablet, and mobile viewports
  - [x] Ensure touch-friendly tap targets on mobile (min 44px)

- [x] **Task 7: Create placeholder pages** (AC: 19, 20, 21)
  - [x] Move/update `app/dashboard/page.tsx` to `app/(workspace)/dashboard/page.tsx`
  - [x] Create `app/(workspace)/settings/page.tsx` placeholder
  - [x] Verify public routes still work without authenticated layout

- [x] **Task 8: Testing and polish**
  - [x] Test authentication redirect flow
  - [x] Test keyboard navigation (Tab through elements)
  - [x] Test keyboard shortcuts (Cmd+K toggle)
  - [x] Verify localStorage persistence works correctly
  - [x] Cross-browser test (Chrome, Firefox, Safari)

## Dev Notes

### Technology Stack (from architecture docs)

- **Framework:** Next.js 16 with App Router
- **UI Library:** shadcn/ui + Tailwind CSS + Radix UI primitives
- **State Management:** Zustand for layout state (must be installed - see Task 1)
- **Icons:** Lucide React (already in project)
- **Animations:** CSS transitions preferred; Framer Motion available if needed

### Required Dependencies to Install

```bash
# Zustand for state management (NOT currently in package.json)
pnpm add zustand

# shadcn/ui sidebar component (RECOMMENDED - provides complete sidebar primitives)
# See: https://ui.shadcn.com/docs/components/sidebar
pnpm dlx shadcn@latest add sidebar

# Additional shadcn/ui components (run if not already installed)
pnpm dlx shadcn@latest add dropdown-menu
pnpm dlx shadcn@latest add avatar
pnpm dlx shadcn@latest add tooltip
```

### Using shadcn/ui Sidebar Component

The shadcn/ui `sidebar` component provides:

- `SidebarProvider` - Context for sidebar state
- `Sidebar` - Main sidebar container
- `SidebarHeader`, `SidebarContent`, `SidebarFooter` - Layout sections
- `SidebarMenu`, `SidebarMenuItem`, `SidebarMenuButton` - Navigation items
- `SidebarGroup`, `SidebarGroupLabel` - Grouping/accordion patterns
- `SidebarTrigger` - Toggle button
- Built-in mobile sheet behavior
- Keyboard navigation and accessibility
- localStorage persistence via `defaultOpen` prop

**Reference:** https://ui.shadcn.com/docs/components/sidebar

### Layout Dimensions (from 02-dashboard-and-workspace.md)

```
Header: 60px height (h-[60px])
Left Sidebar: 240px fixed width (w-[240px]), collapsible on mobile
Main Content: Fluid (flex-1)
Right Sidebar: 400px fixed width (w-[400px]), foldable
```

### Responsive Breakpoints (Tailwind)

```
Mobile: default (<640px) - sidebars hidden/overlay
Tablet: md (768px) - left sidebar visible, right sidebar foldable
Desktop: lg (1024px) - full layout visible
Large: xl (1280px), 2xl (1536px) - same as desktop
```

### Design System Patterns (from existing codebase)

Follow these established patterns for visual consistency:

```tsx
// Headings - use Safiro font
<h1 style={{ fontFamily: "'Safiro', system-ui, sans-serif" }}>

// Container pattern
<div className="container mx-auto px-4">

// Sticky header pattern (see navbar.tsx)
<header className="sticky top-0 z-50 transition-all duration-300">

// Muted text for descriptions
<p className="text-muted-foreground">

// Card styling
<div className="rounded-xl border bg-card p-5">

// Button styling (rounded-full for nav)
<Button className="h-9 rounded-full px-4">
```

### File Structure to Create

```
app/
  (workspace)/
    layout.tsx           # Authenticated layout wrapper with SidebarProvider
    page.tsx             # Redirects to /dashboard
    dashboard/
      page.tsx           # Dashboard content (move from app/dashboard)
    settings/
      page.tsx           # Settings placeholder

components/
  layout/
    header.tsx           # Workspace header (different from public navbar)
    breadcrumbs.tsx      # Dynamic breadcrumb navigation
    user-menu.tsx        # Avatar dropdown menu
    left-sidebar.tsx     # Uses shadcn/ui Sidebar primitives
    trial-status-widget.tsx  # Footer widget in sidebar
    right-sidebar.tsx    # AI Chat container (custom, not using shadcn sidebar)

  ui/
    sidebar.tsx          # Auto-generated by shadcn/ui add sidebar

lib/
  stores/
    layout-store.ts      # Zustand store for right sidebar + any additional state
```

**Note:** shadcn/ui sidebar installation will auto-create `components/ui/sidebar.tsx` with all primitives.

### Key Patterns to Follow

- Use `"use client"` only where needed (interactive components)
- Follow existing component patterns in `components/ui/`
- Use Tailwind for all styling (no inline styles)
- Use `cn()` utility for conditional classes (from `lib/utils`)

### Authentication Integration

- **Import from:** `lib/auth/session.ts` (NOT lib/auth.ts)
- Available functions:
  - `getServerSession()` - get full session object
  - `getCurrentUser()` - get user or null
- Check session in layout, redirect to `/login` if null

```tsx
// Example usage in layout.tsx
import { getCurrentUser } from '@/lib/auth/session'
import { redirect } from 'next/navigation'

export default async function WorkspaceLayout({ children }) {
  const user = await getCurrentUser()
  if (!user) {
    redirect('/login')
  }
  return (
    // ... layout JSX
  )
}
```

### Zustand Store Pattern with Persistence

```tsx
// lib/stores/layout-store.ts
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface LayoutState {
  leftSidebarCollapsed: boolean
  rightSidebarFolded: boolean
  accordionStates: Record<string, boolean>
  toggleLeftSidebar: () => void
  toggleRightSidebar: () => void
  setAccordionState: (id: string, isOpen: boolean) => void
}

export const useLayoutStore = create<LayoutState>()(
  persist(
    (set) => ({
      leftSidebarCollapsed: false,
      rightSidebarFolded: false,
      accordionStates: {},
      toggleLeftSidebar: () =>
        set((state) => ({ leftSidebarCollapsed: !state.leftSidebarCollapsed })),
      toggleRightSidebar: () =>
        set((state) => ({ rightSidebarFolded: !state.rightSidebarFolded })),
      setAccordionState: (id, isOpen) =>
        set((state) => ({
          accordionStates: { ...state.accordionStates, [id]: isOpen },
        })),
    }),
    { name: 'layout-storage' }
  )
)
```

### CSS Layout Approach (with shadcn/ui Sidebar)

```tsx
// layout.tsx - Using shadcn/ui SidebarProvider
import { SidebarProvider, SidebarInset } from '@/components/ui/sidebar'
import { LeftSidebar } from '@/components/layout/left-sidebar'
import { Header } from '@/components/layout/header'
import { RightSidebar } from '@/components/layout/right-sidebar'

export default async function WorkspaceLayout({ children }) {
  const user = await getCurrentUser()
  if (!user) redirect('/login')

  return (
    <SidebarProvider defaultOpen>
      <LeftSidebar />
      <SidebarInset>
        <Header className="h-[60px] shrink-0 sticky top-0 z-50" />
        <div className="flex flex-1 overflow-hidden">
          <main className="flex-1 overflow-auto p-6">{children}</main>
          <RightSidebar />
        </div>
      </SidebarInset>
    </SidebarProvider>
  )
}
```

```tsx
// left-sidebar.tsx - Using shadcn/ui Sidebar primitives
import {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarHeader,
  SidebarMenu,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarGroup,
  SidebarGroupLabel,
} from '@/components/ui/sidebar'

export function LeftSidebar() {
  return (
    <Sidebar className="w-[240px]">
      <SidebarHeader>{/* Logo */}</SidebarHeader>
      <SidebarContent>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton asChild isActive={/* check route */}>
              <Link href="/dashboard">Dashboard</Link>
            </SidebarMenuButton>
          </SidebarMenuItem>
          {/* More menu items... */}
        </SidebarMenu>
      </SidebarContent>
      <SidebarFooter>
        <TrialStatusWidget />
      </SidebarFooter>
    </Sidebar>
  )
}
```

### Testing

**Test file location:** `__tests__/components/layout/` or colocated as `*.test.tsx`

**Testing frameworks:**

- Vitest for unit tests
- React Testing Library for component tests
- Playwright for E2E (already configured)

**Key test scenarios:**

1. Layout renders all four panels
2. Authentication redirect works for unauthenticated users
3. Sidebar toggle persists state to localStorage
4. Keyboard shortcuts trigger correct actions
5. Mobile responsive behavior works correctly
6. Breadcrumbs update on route change

## Dependencies

### Blocks

- Story 3.3 (AI Chat UI) - needs right sidebar container
- Story 6.1 (Dashboard Summary View) - needs layout shell
- Story 6.2 (Kanban Compliance Workspace) - needs layout shell

### Depends On

- Story 1.3 (Authentication) - ‚úÖ Completed

## Risk Assessment

| Risk                          | Impact | Mitigation                                             |
| ----------------------------- | ------ | ------------------------------------------------------ |
| Layout affects existing pages | High   | Use route groups to isolate authenticated layout       |
| Mobile UX issues              | Medium | Test early on real devices, prioritize desktop for MVP |
| State sync issues             | Low    | Use proven Zustand patterns with localStorage          |

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                        | Author      |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2024-12-19 | 0.1     | Initial draft                                                                                                                                                                                                                                      | Sarah (PO)  |
| 2025-12-19 | 0.2     | PO Validation fixes: Added Zustand install step, corrected auth path to lib/auth/session.ts, added shadcn/ui sidebar component, added design system patterns, reordered tasks, added responsive breakpoints, added Zustand persist pattern example | Sarah (PO)  |
| 2025-12-19 | 0.3     | Status changed to Approved after validation pass                                                                                                                                                                                                   | Sarah (PO)  |
| 2025-12-19 | 1.0     | Implementation completed, all tasks done, story file retroactively updated                                                                                                                                                                         | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (implementation done without dev agent tracking)

### Debug Log References

N/A - Implementation completed without formal debug logging

### Completion Notes List

- Four-panel authenticated layout implemented with shadcn/ui Sidebar primitives
- Zustand store created for right sidebar state persistence
- All navigation items, accordions, and responsive behavior working
- Keyboard shortcuts (Cmd+K) implemented for AI chat toggle
- Mobile sidebar uses Sheet overlay pattern
- Authentication redirect integrated via middleware

### File List

**New Files Created:**

- `app/(workspace)/layout.tsx` - Authenticated layout wrapper with SidebarProvider
- `app/(workspace)/page.tsx` - Redirect to dashboard
- `app/(workspace)/dashboard/page.tsx` - Dashboard page
- `app/(workspace)/settings/page.tsx` - Settings placeholder
- `components/layout/header.tsx` - Workspace header
- `components/layout/breadcrumbs.tsx` - Dynamic breadcrumb navigation
- `components/layout/left-sidebar.tsx` - Navigation sidebar
- `components/layout/right-sidebar.tsx` - AI Chat container
- `components/layout/user-menu.tsx` - Avatar dropdown menu
- `components/layout/trial-status-widget.tsx` - Trial status in sidebar footer
- `components/layout/mobile-sidebar.tsx` - Mobile overlay sidebar
- `components/layout/workspace-shell.tsx` - Shell wrapper component
- `components/ui/sidebar.tsx` - shadcn/ui sidebar primitives
- `components/ui/dropdown-menu.tsx` - shadcn/ui dropdown
- `components/ui/avatar.tsx` - shadcn/ui avatar
- `components/ui/tooltip.tsx` - shadcn/ui tooltip
- `components/ui/collapsible.tsx` - shadcn/ui collapsible
- `lib/stores/layout-store.ts` - Zustand store with persist middleware
- `lib/hooks/use-mobile.tsx` - Mobile detection hook

**Modified Files:**

- `package.json` - Added zustand dependency
- `pnpm-lock.yaml` - Updated lockfile

---

## QA Results

_To be filled after QA review_
