# Story 12.5: Seed Miljö Template

## Status

Done

## Story

**As a** product owner,
**I want** the Miljö law list template fully populated with 98 documents in a single flat section,
**so that** we have a second domain template demonstrating cross-domain patterns and the reference implementation for a non-AFS-heavy regulatory domain.

## Acceptance Criteria

1. `LawListTemplate` record created: name "Miljö", slug "miljo", domain "miljo", target_audience "Organisationer med miljöpåverkan — tillverkningsindustri, bygg, avfall, energi, fastighet och kemikaliehantering", primary_regulatory_bodies ["Naturvårdsverket", "MSB", "Kemikalieinspektionen", "Riksdagen", "EU"]
2. 1 `TemplateSection` placeholder record created: section_number "01", name "Alla bestämmelser", item_count 98
3. 98 `TemplateItem` records created with sequential index numbers ("001"-"098"), document_id references, source_type classification, regulatory_body, `is_service_company_relevant` flags (30 of 98 = true, based on file 04 overlap), and `replaces_old_reference` where applicable
4. AI content verification: all 98 referenced LegalDocuments have non-null `summary` and `kommentar` (populated by Story 12.3 pipeline). `TemplateItem.content_status` updated to `AI_GENERATED` for items with content.
5. Template `document_count` = 98, `section_count` = 1
6. All cross-list references populated (22 shared with Arbetsmiljö, 14 shared with Fastighet-Bygg, etc.)
7. Quality checklist passes: every document has valid reference number, no index duplicates, all summaries present

## Tasks / Subtasks

- [x] **Task 1: Create seed script skeleton** (AC: 1, 2, 3)
  - [x] Create `scripts/seed-miljo-template.ts` following the 12.4 seed script pattern [Source: scripts/seed-arbetsmiljo-template.ts]
  - [x] Shebang: `#!/usr/bin/env npx tsx`, import `PrismaClient` from `@prisma/client`
  - [x] Implement `parseArgs()` function for CLI flags: `--force` (re-seed even if template exists), `--dry-run` (log what would be created)
  - [x] Use `fileURLToPath(import.meta.url)` with `resolve(process.argv[1])` for robust direct-execution detection [Source: Story 12.4 script pattern]
  - [x] Read and parse `data/notisum-amnesfokus/analysis/03-miljo.md` for the full document list (all 98 documents across all 9 analysis sections — ignore section assignments, extract only document references and titles)
  - [x] Read and parse `data/notisum-amnesfokus/laglistor-all-combined.csv` for the `Amendment SFS` column (useful for `replaces_old_reference` parsing on SFS entries). **WARNING**: Do NOT import the CSV's `Summary` or `Compliance` columns — those contain Notisum-sourced content.
  - [x] Read and parse `data/notisum-amnesfokus/analysis/04-miljo-tjansteforetag.md` for `is_service_company_relevant` mapping (30 of 32 documents in that file appear in the parent Miljö list)
- [x] **Task 2: Create LawListTemplate record** (AC: 1, 5)
  - [x] Upsert template on `slug = "miljo"` for idempotency [Source: prisma/schema.prisma — LawListTemplate.slug is @unique]
  - [x] Set fields: `name = "Miljö"`, `domain = "miljo"`, `target_audience = "Organisationer med miljöpåverkan — tillverkningsindustri, bygg, avfall, energi, fastighet och kemikaliehantering"`, `primary_regulatory_bodies = ["Naturvårdsverket", "MSB", "Kemikalieinspektionen", "Riksdagen", "EU"]`
  - [x] Set `status = DRAFT`, `version = 1`
  - [x] Set denormalized counts: `document_count = 98`, `section_count = 1`
  - [x] Set `is_variant = false`, `parent_template_id = null`
  - [x] Set `created_by` to system user ID — reuse `findOrCreateSystemUser()` pattern from 12.4
- [x] **Task 3: Create placeholder TemplateSection** (AC: 2)
  - [x] Upsert a single section on `(template_id, section_number)` unique constraint
  - [x] Set `section_number = "01"`, `name = "Alla bestämmelser"`, `description = "Flat list of all documents. Section groupings will be added in a future story."`
  - [x] Set `position = 1.0`, `item_count = 98`
- [x] **Task 4: Create 98 TemplateItem records** (AC: 3, 4)
  - [x] For each document in the analysis file, resolve the DB `document_number` and look up `LegalDocument`
  - [x] **EU documents**: Use CELEX number conversion with fallback chain (CELEX lookup → direct match → fuzzy ILIKE) — reuse `csvEuToCelex()` and `lookupDocument()` patterns from 12.4 [Source: scripts/seed-arbetsmiljo-template.ts lines 624-735]
  - [x] **BFS OVK normalization**: "BFS 2011:16 - OVK 1" → strip " - OVK 1" suffix for DB lookup — reuse `normalizeDocumentNumber()` [Source: scripts/seed-arbetsmiljo-template.ts line 199-204]
  - [x] **NOTE**: Unlike 12.4, Miljö has NO AFS 2023 consolidated provisions. No `OLD_AFS_TO_CHAPTER` mapping or `SPLIT_AFS` resolution is needed. All document_number lookups are direct.
  - [x] Upsert items on `(template_id, document_id)` unique constraint
  - [x] Set `index` as sequential 3-digit strings: "001", "002", ..., "098" — ordered by appearance in the analysis file (Section 01 docs first, then Section 02, etc.). Parse the actual count from the YAML frontmatter `document_count` field rather than hardcoding 98.
  - [x] Set `position` from index (parse as integer for ordering)
  - [x] All items assigned to the single placeholder section
  - [x] Classify `source_type` per item based on document_number prefix:
    - `SFS` with "lag" in title → `"lag"`
    - `SFS` with "förordning" in title → `"forordning"`
    - `NFS` → `"foreskrift"` (Naturvårdsverket)
    - `MSBFS` → `"foreskrift"` (MSB)
    - `KIFS` → `"foreskrift"` (Kemikalieinspektionen)
    - `BFS` → `"foreskrift"` (Boverket)
    - `SRVFS` → `"allmanna-rad"` (Räddningsverket)
    - `SCB-FS` → `"foreskrift"` (SCB)
    - `SSMFS` → `"foreskrift"` (Strålsäkerhetsmyndigheten)
    - `STAFS` → `"foreskrift"` (Swedac)
    - `(EU)` or `(EG)` → `"eu-forordning"`
  - [x] Set `regulatory_body` per item based on document_number prefix (see Regulatory Body Mapping below)
  - [x] Set `is_service_company_relevant` = true for the 30 documents that also appear in `04-miljo-tjansteforetag.md`, false for the remaining 68
  - [x] Set `replaces_old_reference` where applicable — parse from the analysis file if any "(ersätter ...)" notation exists, and from the CSV `Amendment SFS` column for SFS entries
  - [x] Set `content_status` = `AI_GENERATED` if LegalDocument has non-null `summary`, else `STUB`
- [x] **Task 5: Populate cross-list references** (AC: 6)
  - [x] Hardcode cross-list overlap sets derived from the overlap matrix and CSV cross-referencing [Source: data/notisum-amnesfokus/analysis/10-cross-list-analysis.md Section 2]
  - [x] For documents shared with other lists, set `cross_list_references` string array with template slugs:
    - 22 shared with Arbetsmiljö → items get `"arbetsmiljo"` in array
    - 9 shared with Arbetsmiljö tjänsteföretag → items get `"arbetsmiljo-tjansteforetag"` in array
    - 14 shared with Fastighet-Bygg → items get `"fastighet-bygg"` in array
    - 1 shared with Hälsa → items get `"halsa"` in array
    - 1 shared with Livsmedel → items get `"livsmedel"` in array
    - 1 shared with Miljö Sverige → items get `"miljo-sverige"` in array
  - [x] Documents appearing in multiple other lists get all relevant slugs combined
  - [x] **Note**: The 30-doc overlap with Miljo tjänsteföretag is handled via `is_service_company_relevant` flag (Task 4), not via cross_list_references
- [x] **Task 6: Verify content status** (AC: 4)
  - [x] Content generation (Story 12.3 pipeline) has already been run — `LegalDocument.summary` and `LegalDocument.kommentar` should be populated for all 98 documents. No generation step needed.
  - [x] After seeding (Tasks 1-5), verify all 98 referenced LegalDocuments have non-null `summary` and `kommentar` fields
  - [x] `TemplateItem.content_status` is already set to `AI_GENERATED` or `STUB` during Task 4. Log any items with `STUB` status for investigation.
  - [x] **Display fallback**: `templateItem.compliance_summary ?? document.summary` — no TemplateItem-level content overrides needed [Source: Story 12.3 AC #12]
- [x] **Task 7: Run quality validation** (AC: 7)
  - [x] Verify every item has a valid `document_id` reference (FK resolves to LegalDocument)
  - [x] Verify no index duplicates within the template
  - [x] Verify all LegalDocuments have non-null `summary` (Summering)
  - [x] Verify `is_service_company_relevant` count = 30
  - [x] Output validation report to stdout with pass/fail per check
- [x] **Task 8: Write tests** (AC: all)
  - [x] Create `tests/unit/scripts/seed-miljo-template.test.ts`
  - [x] Test: seed script creates correct record counts (1 template, 1 section, 98 items)
  - [x] Test: index uniqueness within template — no duplicate `index` values
  - [x] Test: `is_service_company_relevant` flags — exactly 30 items = true, 68 = false
  - [x] Test: all `document_id` references resolve to valid LegalDocument records (mock Prisma with `vi.fn()`)
  - [x] Test: `source_type` classification correct per prefix (SFS→lag/förordning, NFS/MSBFS/KIFS→föreskrift, EU→eu-förordning)
  - [x] Test: `regulatory_body` set correctly per prefix (10 distinct authorities)
  - [x] Test: cross_list_references populated correctly (22 items have "arbetsmiljo" in array, etc.)
  - [x] Test: EU document CELEX conversion and lookup fallback
  - [x] Test: idempotent — running seed twice doesn't create duplicates (upsert behavior)
  - [x] Test: `--dry-run` flag logs actions without database writes
  - [x] Test: missing LegalDocument reference logs error and continues (doesn't crash)

## Dev Notes

### Flattened Approach — No Section Groupings (Decision A)

**Decision**: This story seeds all 98 documents into a single placeholder section ("Alla bestämmelser") instead of the multi-section structure. Section groupings will be designed and applied in a future story. This is the same approach used in Story 12.4. [Source: Epic 12 Decision A, Story 12.4 v3.0]

**Rationale**:
- Section names and groupings from the analysis file are derived from Notisum's data. Until we design our own original groupings, seeding without sections avoids potential IP concerns.
- The 98 documents themselves are public Swedish law — no copyright concern.
- All per-item metadata (source_type, regulatory_body, is_service_company_relevant, cross_list_references) is fully populated regardless of section structure.

**Impact on original AC #2 (section restructuring)**: The Section 08 merge and Section 09 split design work described in the original story is **deferred**. Section groupings can be added later as a pure data operation — no schema changes needed. The analysis file `03-miljo.md` preserves the full section breakdown as reference material.

### Previous Story Insights (Story 12.4)

Story 12.4 is complete (status: Done, commit `bee90eb`, QA gate: PASS, 56 tests passing). Key learnings for 12.5: [Source: docs/stories/completed/12.4.seed-arbetsmiljo-template.md — Dev Agent Record]

- **Script structure**: Follow `scripts/seed-arbetsmiljo-template.ts` exactly — shebang, PrismaClient, `parseArgs()`, `fileURLToPath` direct-execution guard, pure functions exported for testability, sequential Prisma upserts
- **Migration**: Use `pnpm prisma db push` (NOT `prisma migrate dev`) if schema changes needed. No schema changes expected for 12.5.
- **Content on LegalDocument, not TemplateItem**: `LegalDocument.summary` and `LegalDocument.kommentar` are populated by Story 12.3. `TemplateItem.compliance_summary` and `expert_commentary` remain null. Display falls back: `templateItem.compliance_summary ?? document.summary`
- **Idempotency**: Use Prisma `upsert` keyed on unique constraints for all records
- **Pure functions for testability**: Export all parsing/classification/matching functions
- **AFS consolidation was 12.4's biggest complexity**: The `OLD_AFS_TO_CHAPTER` mapping and chapter resolution is NOT needed for 12.5. Miljö has no AFS documents — its agency regulations (NFS, MSBFS, KIFS, etc.) are all direct lookups.
- **Duplicate detection**: Some entries in the analysis file may map to the same LegalDocument (e.g., Miljöbalk appears in 04-miljo-tjansteforetag.md as separate chapter references like "Kap 2", "Kap 14", "Kap 15" — but in the parent list it's just "SFS 1998:808"). Detect and skip duplicates.
- **Content status**: Set to `AI_GENERATED` if LegalDocument has non-null `summary`, else `STUB`

### Key Differences from 12.4 (Arbetsmiljö)

| Aspect | 12.4 (Arbetsmiljö) | 12.5 (Miljö) |
|--------|-------------------|--------------|
| **Documents** | 112 | 98 |
| **Sections** | 1 placeholder | 1 placeholder (same) |
| **Service company overlap** | 55 of 112 from file 02 | 30 of 98 from file 04 |
| **AFS chapter resolution** | YES — complex OLD_AFS_TO_CHAPTER mapping | NO — no AFS documents |
| **Agency regulation types** | AFS-heavy (41 AFS) | Diverse: NFS (13), MSBFS (12), KIFS (2), SRVFS (2), SCB-FS (1), BFS (1), SSMFS (1), STAFS (1) |
| **EU documents** | 8 | 14 (more CELEX lookups) |
| **Regulatory authorities** | ~5 distinct | **10 distinct** (broadest in any list) |
| **Complexity** | Higher (AFS consolidation) | Lower (direct lookups) |

### Data Models

#### LawListTemplate [Source: prisma/schema.prisma lines 1201-1233]

```prisma
model LawListTemplate {
  id                        String         @id @default(uuid())
  name                      String
  slug                      String         @unique
  description               String?        @db.Text
  domain                    String         // "miljo"
  target_audience           String?        @db.Text
  status                    TemplateStatus @default(DRAFT)
  version                   Int            @default(1)
  document_count            Int            @default(0)   // 98
  section_count             Int            @default(0)   // 1
  primary_regulatory_bodies String[]
  parent_template_id        String?
  is_variant                Boolean        @default(false)
  created_by                String         // FK to User
  // ... relations
  @@unique([slug])
}
```

#### TemplateSection [Source: prisma/schema.prisma lines 1235-1253]

```prisma
model TemplateSection {
  id             String   @id @default(uuid())
  template_id    String
  section_number String   // "01"
  name           String   // "Alla bestämmelser"
  description    String?  @db.Text
  position       Float    @default(0)
  item_count     Int      @default(0)   // 98
  // ...
  @@unique([template_id, section_number])
}
```

#### TemplateItem [Source: prisma/schema.prisma lines 1255-1289]

```prisma
model TemplateItem {
  id                          String                    @id @default(uuid())
  template_id                 String
  section_id                  String
  document_id                 String
  index                       String                    // "001"-"098"
  position                    Float
  source_type                 String?
  regulatory_body             String?
  replaces_old_reference      String?
  is_service_company_relevant Boolean                   @default(true)
  cross_list_references       String[]
  content_status              TemplateItemContentStatus @default(STUB)
  // ...
  @@unique([template_id, document_id])
}
```

### Regulatory Body Mapping

10 distinct regulatory authorities — the broadest of any template: [Source: data/notisum-amnesfokus/analysis/03-miljo.md Section 3]

```typescript
const REGULATORY_BODY_MAP: Record<string, string> = {
  SFS: 'Riksdagen',
  NFS: 'Naturvårdsverket',
  MSBFS: 'MSB',
  KIFS: 'Kemikalieinspektionen',
  BFS: 'Boverket',
  SRVFS: 'Räddningsverket',
  'SCB-FS': 'SCB',
  SSMFS: 'Strålsäkerhetsmyndigheten',
  STAFS: 'Swedac',
  '(EU)': 'EU',
  '(EG)': 'EU',
}
```

**Distribution** (from analysis file Section 3):

| Source Type | Count | Regulatory Body |
|---|---|---|
| SFS | 51 (52%) | Riksdagen |
| EU | 14 (14.3%) | EU |
| NFS | 13 (13.3%) | Naturvårdsverket |
| MSBFS | 12 (12.2%) | MSB |
| KIFS | 2 (2%) | Kemikalieinspektionen |
| SRVFS | 2 (2%) | Räddningsverket |
| SCB-FS | 1 (1%) | SCB |
| BFS | 1 (1%) | Boverket |
| SSMFS | 1 (1%) | Strålsäkerhetsmyndigheten |
| STAFS | 1 (1%) | Swedac |

### Data Source Files

**Primary source:** `data/notisum-amnesfokus/analysis/03-miljo.md` [Source: data/notisum-amnesfokus/analysis/03-miljo.md]
- YAML frontmatter: `document_count: 98`, `section_count: 9`
- 9 sections with markdown tables: `| # | SFS/AFS Number | Official Statute Title | Last Amendment |`
- Ignore section assignments — flatten into single section, extract only document references
- **EU document format**: References like `(EU) nr 573/2024`, `(EG) nr 1907/2006`, `(EU) 40/2025` — need CELEX conversion for DB lookup

**Service company flags:** `data/notisum-amnesfokus/analysis/04-miljo-tjansteforetag.md` [Source: data/notisum-amnesfokus/analysis/04-miljo-tjansteforetag.md]
- 32 total documents, 30 of which appear in the parent Miljö list
- 2 unique additions ((EU) nr 852/2020, SFS 1995:1554) that are "promoted" in the tjansteforetag variant — these DO also appear in the parent Miljö list (Section 09 and Section 01 respectively), so they still get `is_service_company_relevant = true`
- **NOTE**: The tjansteforetag file references Miljöbalk by chapter (Kap 2, Kap 14, Kap 15) but the parent Miljö list uses "SFS 1998:808" — need to handle matching. The document `SFS 1998:808` appears ONCE in the Miljö list and should get `is_service_company_relevant = true` if any Miljöbalk chapter reference appears in file 04.

**Cross-list overlap:** `data/notisum-amnesfokus/analysis/10-cross-list-analysis.md` [Source: data/notisum-amnesfokus/analysis/10-cross-list-analysis.md Section 2]
- Miljö row in overlap matrix: Arb.(22), Arb.tj.(9), Fast-Bygg(14), Hälsa(1), Livsm.(1), Miljo.SE(1), Miljo.tj.(30)

**Structured CSV:** `data/notisum-amnesfokus/laglistor-all-combined.csv`
- Filter: rows where `Laglista = "Miljö"`
- Useful: `SFS Number` (maps to document_number), `Amendment SFS` (for replaces_old_reference)
- **WARNING**: Do NOT import `Summary` or `Compliance` columns (Notisum-sourced content)

### Cross-List Reference Data

Hardcoded overlap sets, keyed by template slug. Each set contains document references (from the Miljö analysis file) that also appear in the named list. The dev agent must derive these from the CSV cross-referencing and overlap matrix.

From the overlap matrix (Miljö perspective):

| Other Template | Shared Docs | Primary Overlap Area |
|---|---|---|
| arbetsmiljo | 22 | Chemical safety, fire/explosion, dangerous-goods transport, radiation |
| arbetsmiljo-tjansteforetag | 9 | Subset of above relevant to service companies |
| fastighet-bygg | 14 | Building regulations, waste, energy, ventilation, fire safety |
| halsa | 1 | Radiation protection |
| livsmedel | 1 | SKVFS statistics? |
| miljo-sverige | 1 | Minimal overlap |

**Note**: The 12.4 seed script already contains `CROSS_LIST_OVERLAPS.miljo` with 22 Arbetsmiljö references — those same 22 documents should get `"arbetsmiljo"` in their `cross_list_references` array from the Miljö side.

### EU Document Resolution

14 EU instruments in the Miljö list require CELEX-based lookup. Use the same `csvEuToCelex()` and `lookupDocument()` pattern from 12.4. [Source: scripts/seed-arbetsmiljo-template.ts lines 624-735]

Key EU documents and expected CELEX numbers:

| Analysis Reference | Expected CELEX |
|---|---|
| (EG) nr 1907/2006 | 32006R1907 |
| (EG) nr 1272/2008 | 32008R1272 |
| (EU) nr 1021/2019 | 32019R1021 |
| (EU) nr 573/2024 | 32024R0573 |
| (EU) nr 590/2024 | 32024R0590 |
| (EU) 40/2025 | 32025R0040 |
| (EG) nr 166/2006 | 32006R0166 |
| (EG) nr 440/2008 | 32008R0440 |
| (EU) nr 649/2012 | 32012R0649 |
| (EU) nr 852/2020 | 32020R0852 |
| (EU) nr 956/2023 | 32023R0956 |
| (EU) nr 1115/2023 | 32023R1115 |
| (EU) nr 1542/2023 | 32023R1542 |
| (EU) nr 2772/2023 | 32023R2772 |

### Code Reuse from 12.4

Many pure functions from `scripts/seed-arbetsmiljo-template.ts` can be reused or imported directly. Consider either:
- **Option A**: Copy and adapt (simpler, self-contained script)
- **Option B**: Extract shared utilities into `lib/seed-helpers.ts` and import from both scripts

Recommend **Option A** (copy and adapt) to keep the script self-contained, matching the 12.4 pattern. Functions to copy:
- `parseArgs()`, `SeedConfig` interface
- `extractBaseDocumentNumber()`, `extractReplacesReference()`
- `normalizeForMatching()`, `normalizeDocumentNumber()`
- `classifySourceType()` — extend with NFS, SCB-FS, SSMFS, STAFS prefixes
- `getRegulatoryBody()` — extend with all 10 Miljö authorities
- `REGULATORY_BODY_MAP` — extend
- `parseAnalysisFile()` — may need minor adjustment for table format differences
- `csvEuToCelex()`, `lookupDocument()`
- `findOrCreateSystemUser()`
- `SeedResult` interface, `seed()` function structure

Functions NOT needed:
- `OLD_AFS_TO_CHAPTER`, `SPLIT_AFS`, `resolveDocumentNumber()` (no AFS in Miljö)
- `parseTjansteforetagFile()` — adapt for file 04's different table format

### File Locations

[Source: docs/architecture/12-unified-project-structure.md]

```
scripts/seed-miljo-template.ts                       # NEW — seed script
tests/unit/scripts/seed-miljo-template.test.ts       # NEW — tests

data/notisum-amnesfokus/analysis/03-miljo.md                     # Input — document list (98)
data/notisum-amnesfokus/analysis/04-miljo-tjansteforetag.md      # Input — service company flags (30)
data/notisum-amnesfokus/analysis/10-cross-list-analysis.md       # Input — overlap matrix
data/notisum-amnesfokus/laglistor-all-combined.csv               # Input — structured data

scripts/seed-arbetsmiljo-template.ts                 # Reference — 12.4 implementation to follow
prisma/schema.prisma                                 # Reference — template models (DO NOT modify)
```

### Dependencies

- **Blocked by:** Story 12.1 (agency regulation stubs — Done), Story 12.2 (template schema — Done), Story 12.3 (content pipeline — Done), Story 12.4 (reference implementation — Done)
- **Blocks:** Story 12.6 (Tjänsteföretag variant — may derive from both Arbetsmiljö and Miljö parent templates)

### Technical Constraints

- **TypeScript:** 5.5+ strict mode, no `any`, explicit types [Source: docs/architecture/17-coding-standards.md#17.2]
- **ORM:** Prisma 5.x with type-safe queries, `@prisma/client` imports [Source: docs/architecture/3-tech-stack.md#3.1]
- **Database:** PostgreSQL 15+ via Supabase [Source: docs/architecture/3-tech-stack.md]
- **Package manager:** pnpm [Source: docs/architecture/3-tech-stack.md#3.1]
- **No schema changes expected** — this story creates data, not schema. All models from Story 12.2 are ready.
- **Commit format:** `feat(epic-12): <subject>` [Source: docs/architecture/17-coding-standards.md#17.8]

### Testing

- **Test framework:** Vitest 1.4+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Test config:** `vitest.config.mts` — environment: `happy-dom`, setup: `tests/setup.ts`
- **Test location:** `tests/unit/scripts/seed-miljo-template.test.ts` [Source: docs/architecture/12-unified-project-structure.md]
- **Mocking strategy:** Use `vi.fn()` and `vi.mock()` to mock Prisma calls. Do NOT run against a real database in unit tests. Follow the mock pattern from `tests/unit/scripts/seed-arbetsmiljo-template.test.ts` (56 tests). [Source: tests/unit/scripts/seed-arbetsmiljo-template.test.ts]

**Tests needed (11 tests minimum):**
1. Correct record counts (1 template, 1 section, 98 items)
2. Index uniqueness within template — no duplicate `index` values
3. `is_service_company_relevant` count = 30 true, 68 false
4. All `document_id` references resolve to valid LegalDocument records
5. `source_type` classification correct per document_number prefix (10 types)
6. `regulatory_body` set correctly per prefix (10 authorities)
7. `cross_list_references` populated correctly (22 items have "arbetsmiljo" in array, etc.)
8. EU document CELEX conversion and lookup fallback chain
9. Idempotent: running seed twice doesn't create duplicates
10. `--dry-run` flag logs actions without database writes
11. Missing LegalDocument reference logs error and continues

Plus additional pure function unit tests (parsing, classification, normalization) — target ~50+ tests following 12.4's pattern.

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Status changed to Deferred per Decision B — FE first with mock data, seeding after ingestion fix. Single-section approach per Decision A | Sarah (PO) |
| 2026-02-16 | 2.0     | SM enrichment: Complete rewrite to align with Decision A (single-section flat seeding). Removed multi-section restructuring (Section 08 merge, Section 09 split) — deferred to future story. Full architecture context with source references, 12.4 reference implementation insights, data model definitions, regulatory body mapping, EU CELEX resolution notes, cross-list reference data, testing section with 11+ test requirements. Based on 12.4 (Done, 56 tests, QA PASS) as the proven pattern. | Bob (SM) |
| 2026-02-16 | 2.1     | PO validation: GO (readiness 9/10, high confidence). Two minor corrections applied — Section 01/09 reference for SFS 1995:1554, Prisma line numbers. Status → Approved. | Sarah (PO) |
| 2026-02-16 | 2.2     | Implementation complete: seed script + 88 tests. All tasks done, all validations pass. Status → Ready for Review. | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### File List

| File | Action | Description |
|------|--------|-------------|
| `scripts/seed-miljo-template.ts` | CREATED | Seed script for Miljö template — 98 documents, 10 regulatory bodies, cross-list refs, service company flags |
| `tests/unit/scripts/seed-miljo-template.test.ts` | CREATED | 88 unit tests covering all pure functions, parsing, integration, and edge cases |
| `docs/stories/12.5.seed-miljo-template.md` | MODIFIED | Task checkboxes marked, Dev Agent Record populated |

### Debug Log References

- Cross-list overlap data derived from CSV via Python script (not hardcoded from overlap matrix document). Verified exact overlap counts: arbetsmiljo(22), arbetsmiljo-tjansteforetag(9), fastighet-bygg(14), halsa(1), livsmedel(1), miljo-sverige(1)
- Initial cross-list guesses were incorrect for fastighet-bygg (14 not initial estimate), halsa (SSMFS 2018:2 not SFS 2018:396), livsmedel ((EU) 40/2025 not SFS 2014:425), miljo-sverige (SFS 1995:1554 not SFS 1998:808). Corrected from CSV cross-referencing.
- arbetsmiljo-tjansteforetag: Removed incorrect BFS 2011:16, added SRVFS 2004:3 (9 total, verified)
- No type check errors in project `npx tsc --noEmit` for the seed script

### Completion Notes

- 88 tests passing (exceeds 50+ target), 0 failures, 93ms runtime
- Full regression: 2666 passed, 17 failed (all pre-existing — integration/DB tests, performance-audit specs, UI template chooser tests on feature branch — none in new files)
- Script follows 12.4 pattern exactly: Option A (copy and adapt), self-contained
- Extended `REGULATORY_BODY_MAP` with NFS, SCB-FS, SSMFS, STAFS (10 authorities total)
- Extended `classifySourceType` for all 10 agency prefixes
- No AFS chapter resolution needed (key simplification vs 12.4)
- `parseTjansteforetagFile` handles Miljöbalk chapter deduplication (Kap 2, 14, 15 → SFS 1998:808)
- `document_count` frontmatter field used (not `total_documents` like 12.4)
- 14 EU CELEX conversions implemented and tested

## QA Results

### Review Date: 2026-02-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation.** The seed script faithfully follows the 12.4 reference pattern while making appropriate domain-specific adaptations. Key strengths:

- **Clean pattern adherence**: Structure, function signatures, naming conventions, and flow mirror `seed-arbetsmiljo-template.ts` exactly — making the codebase consistent across seed scripts.
- **Appropriate simplification**: AFS chapter resolution complexity (OLD_AFS_TO_CHAPTER, SPLIT_AFS, resolveDocumentNumber) correctly omitted since Miljö has no AFS documents. This reduces ~60 lines of unnecessary complexity.
- **Pure function exports for testability**: All parsing, classification, and normalization functions are exported and independently testable.
- **Robust data enrichment**: `replaces_old_reference` uses CSV `amendmentSfs` as fallback when no `(ersätter ...)` notation exists in the analysis file — an improvement over hardcoding.
- **Correct frontmatter field**: Uses `document_count` (not `total_documents` as in 12.4), matching the actual `03-miljo.md` YAML frontmatter.
- **Cross-list data derived from CSV**: Debug log confirms overlap sets were cross-referenced against the CSV, not guessed from the overlap matrix. Corrections were made iteratively (fastighet-bygg count, halsa document, livsmedel document, miljo-sverige document, arbetsmiljo-tjansteforetag membership).

No `any` types, no security concerns, no unused code. TypeScript strict mode passes cleanly.

### Refactoring Performed

None required. The implementation is clean, well-structured, and follows established patterns.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, no `any`, explicit types, proper null handling
- Project Structure: ✓ Script in `scripts/`, tests in `tests/unit/scripts/`, correct naming conventions
- Testing Strategy: ✓ Vitest with mocked Prisma, pure function unit tests + integration tests, 88 tests (exceeds 50+ target)
- All ACs Met: ✓ See traceability matrix below

### Requirements Traceability

| AC | Requirement | Validating Tests | Status |
|----|-------------|-----------------|--------|
| AC1 | LawListTemplate record (slug "miljo", correct fields) | `seed() correct record counts (Test 1)` — verifies upsert called once | ✓ Covered |
| AC2 | 1 TemplateSection placeholder (section_number "01") | `seed() correct record counts (Test 1)` — verifies section upsert once | ✓ Covered |
| AC3 | 98 TemplateItems with correct metadata | Tests 1-8: record counts, index uniqueness, service company flags, document resolution, source_type, regulatory_body, cross_list_refs, CELEX conversion | ✓ Covered |
| AC4 | AI content verification (content_status) | `content_status set correctly` — AI_GENERATED vs STUB based on summary | ✓ Covered |
| AC5 | Template counts (document_count=98, section_count=1) | `seed() correct record counts (Test 1)` + denormalized count update logic | ✓ Covered |
| AC6 | Cross-list references populated | `cross_list_references (Test 7)` — 10 subtests covering all 6 overlap slugs | ✓ Covered |
| AC7 | Quality checklist passes | `index uniqueness (Test 2)`, `document_id references (Test 4)`, built-in Step 5 validation | ✓ Covered |

### Improvements Checklist

No improvements required. All items are addressed:

- [x] Script structure follows 12.4 pattern (Option A: self-contained)
- [x] All 10 regulatory body mappings implemented and tested
- [x] All 10 source_type classifications implemented and tested
- [x] 14 EU CELEX conversions implemented and tested
- [x] Miljöbalk chapter deduplication handled in parseTjansteforetagFile
- [x] Cross-list overlap data verified via CSV cross-referencing
- [x] Idempotency via Prisma upsert on unique constraints
- [x] Dry-run mode prevents database writes
- [x] Missing document handling (graceful skip with logging)
- [x] Denormalized count auto-correction when actual differs from expected

### Security Review

No security concerns. This is a data-seeding script that reads local files and writes to the database via Prisma's parameterized queries. No user input, no external API calls, no authentication surfaces.

### Performance Considerations

No performance concerns. The script processes 98 items sequentially with individual Prisma upserts — appropriate for a one-time seed operation. Test suite runs in 110ms (88 tests).

### Files Modified During Review

None. No refactoring was needed.

### Gate Status

Gate: PASS -> docs/qa/gates/12.5-seed-miljo-template.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, 88 tests passing, type-safe, pattern-consistent implementation. Story owner decides final status.
