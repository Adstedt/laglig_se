# Story 12.9: Template Detail & Preview Page

## Status

Done

## Story

**As a** logged-in workspace member,
**I want** to preview a template's full structure — sections, laws, compliance summaries — before adopting it,
**so that** I can evaluate whether it covers my compliance needs and feel confident adopting it.

## Acceptance Criteria

1. Authenticated route: `/laglistor/mallar/{slug}` (e.g., `/laglistor/mallar/arbetsmiljo`) — within workspace layout, behind auth
2. Template header: name, description, target audience badge, regulatory body badges, and a visually distinct stats bar showing document count, section count, and last updated date — with icons
3. Section accordion view: each section shows section number badge (colored), name, description, document count; expand to see list of laws (title, SFS number, source type badge with icon); first 3 compliance summaries shown as inline preview (rest behind "Visa alla {n} sammanfattningar")
4. CTA: "Använd denna mall" (Adopt this template) — prominent button, links to adoption flow (Story 12.10). User is always authenticated on this page.
5. Tjänsteföretag toggle (if viewing a parent template with variants): "Visa version för tjänsteföretag" — navigates to variant slug URL (`/laglistor/mallar/{variant-slug}`) for clean URL separation. Variant detail pages show a "Visa fullständig version" link back to the parent.
6. Stats bar: "112 lagar | 9 kategorier | Senast uppdaterad: 10 feb 2026" — rendered as a horizontal strip with `FileText`, `Layers`, and `Calendar` icons
7. Not-found handling: if slug doesn't match any PUBLISHED template (or PUBLISHED variant), show custom 404
8. Empty section handling: if a template has only a single section (per Decision A — single-section flat seeding), display it as an open list without accordion chrome, with a friendly "Sektionsindelning kommer snart" note
9. Mobile-responsive layout: single column on mobile, content area + sticky sidebar CTA on desktop

## Tasks / Subtasks

- [x] **Task 1: Build published template detail query** (AC: 1, 2, 3, 6)
  - [x] Add `getPublishedTemplateBySlug(slug: string)` to `lib/db/queries/template-catalog.ts`
  - [x] Define `TemplateDetailSection` interface:
    - `id: string`, `section_number: string`, `name: string`, `description: string | null`, `item_count: number`, `position: number`
    - `items: TemplateDetailItem[]`
  - [x] Define `TemplateDetailItem` interface:
    - `id: string`, `index: string`, `position: number`
    - `compliance_summary: string | null`, `expert_commentary: string | null`
    - `source_type: string | null`, `regulatory_body: string | null`
    - `document: { id: string; document_number: string; title: string; slug: string }`
  - [x] Define `TemplateDetail` interface:
    - All fields from `PublishedTemplate` (id, name, slug, description, domain, target_audience, document_count, section_count, primary_regulatory_bodies, is_variant)
    - Plus: `updated_at: string` (ISO date for stats bar), `parent_slug: string | null` (for variant → parent link)
    - `variants: PublishedTemplateVariant[]` (reuse existing type)
    - `sections: TemplateDetailSection[]`
  - [x] Query: `prisma.lawListTemplate.findFirst({ where: { slug, status: 'PUBLISHED' } })` with nested `sections` (ordered by `position` asc) and `items` (ordered by `position` asc) including `document` relation (select: `id, document_number, title, slug`)
  - [x] For variant templates (`is_variant = true`): fetch the variant's own `TemplateSection` records, but fetch items from the **parent** template filtered by `is_service_company_relevant = true`, respecting `variant_section_override` for section mapping. Include parent slug via `parent.slug` relation.
  - [x] For non-variant templates: fetch sections and items directly. Include `children` (published variants) for the variant toggle.
  - [x] Return `null` if no matching published template found
- [x] **Task 2: Create detail route and page** (AC: 1, 9)
  - [x] Create `app/(workspace)/laglistor/mallar/[slug]/page.tsx` (Server Component, auth-gated via workspace layout)
  - [x] Create `app/(workspace)/laglistor/mallar/[slug]/loading.tsx` — skeleton: header area placeholder (title + description + badges + stats bar) followed by 3 accordion section skeletons. Use `bg-muted animate-pulse rounded` pattern matching 12.8's loading.tsx.
  - [x] Create `app/(workspace)/laglistor/mallar/[slug]/not-found.tsx` — friendly 404 with `SearchX` icon (if available in project's lucide-react version; fallback to `Search` or `FileQuestion` if `SearchX` is not exported), message "Mallen kunde inte hittas", description "Den mall du söker finns inte eller har inte publicerats ännu.", link back to `/laglistor/mallar` ("Tillbaka till mallbiblioteket") (AC: 7)
  - [x] Add Next.js metadata export: `title: '{template.name} | Laglig'`, description from template description
  - [x] Use `export const dynamic = 'force-dynamic'`
  - [x] Await `params` per Next.js 16 pattern: `const { slug } = await params`
  - [x] Call `getPublishedTemplateBySlug(slug)`, if null call `notFound()`
  - [x] Pass template data to `<TemplateDetailClient />` client component
- [x] **Task 3: Build template detail header** (AC: 2, 6)
  - [x] Create `components/features/templates/template-detail-header.tsx` (client component, `'use client'`)
  - [x] Props: `template: TemplateDetail`
  - [x] Display in a visually engaging layout:
    - Template name as `<h1>` (text-2xl font-semibold)
    - Description paragraph (text-muted-foreground)
    - Badge row: domain badge (colored, reuse `DOMAIN_COLORS` from template-card.tsx — extract to shared constant `lib/constants/template-domains.ts`), target audience badge (outline), regulatory body badges (secondary, small)
    - **Stats bar**: horizontal strip with rounded-lg background (`bg-muted/50`), three stat items separated visually:
      - `FileText` icon + `{document_count} lagar`
      - `Layers` icon + `{section_count} kategorier`
      - `Calendar` icon + `Uppdaterad {formatted_date}` (use `date-fns` `format(date, 'd MMM yyyy', { locale: sv })`)
    - Each stat item uses `flex items-center gap-1.5 text-sm text-muted-foreground`
  - [x] Use `date-fns/locale/sv` for Swedish date formatting: `import { sv } from 'date-fns/locale/sv'` [Source: docs/architecture/3-tech-stack.md#3.1 — date-fns 4.1+]
- [x] **Task 4: Build sections accordion** (AC: 3, 8)
  - [x] Create `components/features/templates/template-sections-accordion.tsx` (client component, `'use client'`)
  - [x] Props: `sections: TemplateDetailSection[]`
  - [x] **Multi-section case** (sections.length > 1): use shadcn/ui `<Accordion type="multiple">` with `<AccordionItem>`, `<AccordionTrigger>`, `<AccordionContent>` [Source: components/ui/accordion.tsx — already installed]
  - [x] Each accordion trigger displays:
    - **Section number badge**: small rounded circle/pill with the section number (e.g., "01") in a muted color. Use alternating subtle colors or a single accent to add visual rhythm.
    - **Section name** (font-medium)
    - **Document count badge**: `<Badge variant="secondary" className="text-xs">{item_count} lagar</Badge>`
    - Section description as `text-sm text-muted-foreground` below the trigger title
  - [x] Each accordion content displays:
    - List of laws as rows: each row shows:
      - **Source type icon**: small icon from lucide-react mapped to source type (`Scale` for lag, `ScrollText` for förordning, `FileCheck` for föreskrift, `Globe` for eu-forordning, `BookOpen` for allmanna-rad). Provide a `SOURCE_TYPE_ICONS` mapping.
      - **Source type badge**: colored `<Badge variant="outline" className="text-xs">` with type label (capitalize Swedish: "Lag", "Förordning", "Föreskrift", "EU-förordning", "Allmänna råd")
      - **Document title** (font-medium, text-sm) — linked to future law page (`/lagar/{document.slug}`) if desired, or plain text for now
      - **SFS/AFS number** (text-xs text-muted-foreground)
    - **Compliance summary preview**: show first 3 items' compliance summaries (if non-null) as quoted text blocks with a subtle left border (`border-l-2 border-muted pl-3 text-sm text-muted-foreground italic`). If more than 3 items have summaries, show a "Visa alla {remaining} sammanfattningar" button that expands the rest.
  - [x] **Single-section case** (sections.length === 1): skip accordion wrapper. Render the single section's items directly as an open list. Add a subtle note: `<p className="text-xs text-muted-foreground italic">Sektionsindelning kommer snart</p>` (AC: 8)
  - [x] **Empty items case**: if a section has 0 items, show `text-sm text-muted-foreground italic` "Inga dokument i denna sektion ännu"
- [x] **Task 5: Build adopt CTA** (AC: 4)
  - [x] Create `components/features/templates/template-adopt-cta.tsx` (client component, `'use client'`)
  - [x] Props: `templateSlug: string`, `templateName: string`
  - [x] Renders a prominent CTA section:
    - On desktop: sticky sidebar card (`sticky top-20`) with: `Sparkles` icon, template name, "Börja din efterlevnadsresa" tagline, `<Button size="lg" className="w-full">Använd denna mall</Button>`
    - On mobile: fixed bottom bar or inline CTA at top of page content
  - [x] Button links to the adoption flow (Story 12.10) — for now, use `href="/laglistor/mallar/{slug}/adopt"` as a placeholder route. The actual adoption flow will be implemented in Story 12.10; for this story, the button should be a visible, styled link that doesn't navigate to an error page. Use a `<Button asChild>` wrapping a `<Link>` if the route exists, or a disabled button with tooltip "Kommer snart — adoption under utveckling" if we want to be safe.
  - [x] **Decision**: Since Story 12.10 is not yet implemented, render the button as a visually complete but temporarily non-functional element: `<Button size="lg" className="w-full gap-2" disabled><Sparkles className="h-4 w-4" /> Använd denna mall</Button>` with a `<p className="text-xs text-muted-foreground mt-2">Malladoption lanseras snart</p>` note below. When 12.10 is implemented, the `disabled` prop and note are removed and the button links to the adoption flow.
- [x] **Task 6: Build detail client wrapper with variant toggle** (AC: 5, 9)
  - [x] Create `components/features/templates/template-detail-client.tsx` (client component, `'use client'`)
  - [x] Props: `template: TemplateDetail`
  - [x] Layout: On desktop, a two-column layout — main content area (header + accordion, `col-span-8` or flex-grow) and sidebar (CTA, `col-span-4` or w-80). On mobile, single column with CTA above sections.
  - [x] **Variant toggle display** (if `template.is_variant === false && template.variants.length > 0`):
    - Show a `<Switch>` toggle with label "Visa version för tjänsteföretag" — when toggled, navigate to `/laglistor/mallar/{variant.slug}` using `router.push()` (Next.js `useRouter`)
  - [x] **Parent link** (if `template.is_variant === true && template.parent_slug`):
    - Show a `<Link>` to `/laglistor/mallar/{parent_slug}` with text "← Visa fullständig version"
  - [x] Compose: `<TemplateDetailHeader>`, variant toggle/parent link, `<TemplateSectionsAccordion>`, `<TemplateAdoptCta>` in the appropriate layout
- [x] **Task 7: Extract shared domain constants** (AC: 2, 3)
  - [x] Create `lib/constants/template-domains.ts`
  - [x] Move `DOMAIN_LABELS`, `DOMAIN_COLORS`, and `DEFAULT_DOMAIN_COLOR` from `template-card.tsx` into this shared file
  - [x] Export `SOURCE_TYPE_LABELS` mapping: `{ lag: 'Lag', forordning: 'Förordning', foreskrift: 'Föreskrift', 'eu-forordning': 'EU-förordning', 'allmanna-rad': 'Allmänna råd' }`
  - [x] Export `SOURCE_TYPE_ICONS` mapping (icon component references or icon name strings)
  - [x] Update `template-card.tsx` and `template-catalog-client.tsx` imports to use shared constants
- [x] **Task 8: Add breadcrumb support** (AC: 1)
  - [x] The breadcrumb should display: `Laglistor > Mallbibliotek > {template.name}`
  - [x] **Required changes to `components/layout/breadcrumbs.tsx`**:
    - Add `'laglistor'` to the `showAsLink` set (currently missing — intermediate segment is skipped without it)
    - Add `'mallar'` to the `showAsLink` set (currently missing — "Mallbibliotek" breadcrumb is skipped without it)
    - Both entries are already in `routeLabels` (`laglistor: 'Laglistor'`, `mallar: 'Mallbibliotek'`) from Story 12.8, but they must also be in `showAsLink` to appear as clickable breadcrumb segments
  - [x] For the dynamic `[slug]` segment: the breadcrumb system will display the raw slug string (e.g., "arbetsmiljo") as the final breadcrumb. This is acceptable for now — if dynamic template name resolution is desired, a breadcrumb override pattern can be added later. The slug is human-readable by design.
- [x] **Task 9: Write tests** (AC: all)
  - [x] **Query tests** (`tests/unit/lib/db/queries/template-catalog-detail.test.ts`):
    - Returns full template with sections and items for valid published slug
    - Returns null for non-existent slug
    - Returns null for DRAFT/ARCHIVED template slug
    - Variant query includes parent items filtered by `is_service_company_relevant`
    - Sections ordered by position, items ordered by position within sections
    - Document relation included with document_number, title, slug
  - [x] **Header component tests** (`tests/unit/components/features/templates/template-detail-header.test.tsx`):
    - Renders template name, description, stats bar
    - Shows domain badge with correct color
    - Shows target audience badge when present
    - Shows regulatory body badges
    - Stats bar shows document count, section count, formatted date
  - [x] **Accordion component tests** (`tests/unit/components/features/templates/template-sections-accordion.test.tsx`):
    - Renders correct number of accordion items for multi-section template
    - Each section shows name, section number, document count
    - Expanding a section shows law list with titles and SFS numbers
    - Source type badges rendered for each item
    - Compliance summary preview shows first 3 summaries
    - "Visa alla" button appears when more than 3 summaries exist
    - Single-section template renders without accordion chrome
    - Empty section shows placeholder message
  - [x] **CTA component tests** (`tests/unit/components/features/templates/template-adopt-cta.test.tsx`):
    - Renders "Använd denna mall" button
    - Button is currently disabled (pre-12.10)
    - Shows "Malladoption lanseras snart" note
  - [x] **Client wrapper tests** (`tests/unit/components/features/templates/template-detail-client.test.tsx`):
    - Renders header, accordion, and CTA components
    - Shows variant toggle for parent templates with variants
    - Shows parent link for variant templates
    - Hides variant toggle for templates without variants

## Dev Notes

### Previous Story Insights (Story 12.8)

Story 12.8 is Done. Key learnings from Dev Agent Record: [Source: docs/stories/completed/12.8.template-catalog-browse.md#Dev Agent Record]

- **100 unit test files pass (1398 tests)** — regression baseline to maintain.
- **7 pre-existing integration test failures** (DB FK constraints, unrelated to template stories) — ignore these during development.
- **`DOMAIN_LABELS` and `DOMAIN_COLORS` are duplicated** in `template-card.tsx` and `template-catalog-client.tsx` — this story extracts them to a shared constants file (Task 7). QA flagged this as a "Future" improvement; this story addresses it.
- **`isStaticSubPage` active state detection** added to sidebar for `/laglistor/mallar` — the `[slug]` child route will automatically match via the existing `pathname.startsWith('/laglistor/mallar')` check.
- **Breadcrumb system** uses `routeLabels` map in `components/layout/breadcrumbs.tsx` — `mallar: 'Mallbibliotek'` already added. The `[slug]` segment will need dynamic label handling (template name).
- **Switch component exists** (`components/ui/switch.tsx`) — no installation needed for variant toggle.
- **`exactOptionalPropertyTypes` active**: Optional props need explicit `| undefined` annotations.
- **Server Component pattern**: `export const dynamic = 'force-dynamic'` + `Promise.all` for parallel fetches. Auth handled by workspace layout — no auth checks in the page itself.

### User Design Intent — "Fun & Uplifting"

The user specifically requested this page be **intuitive and fun**, with **icons and visual elements** that make the experience more engaging than the neutral design system suggests. While staying aligned with shadcn/ui and the existing workspace aesthetic:

- **Lucide icons throughout**: Section number badges, source type icons, stats bar icons, CTA sparkle icon
- **Colored section number pills**: Small circular badges with numbers (01, 02...) in subtle accent colors for visual rhythm
- **Source type icons**: Each law gets a small contextual icon (Scale for lag, ScrollText for förordning, etc.)
- **Stats bar**: Visually distinct horizontal strip with icons — not just plain text
- **Compliance summary previews**: Styled as subtle quote blocks with a left border accent
- **CTA with personality**: Sparkle icon, encouraging micro-copy ("Börja din efterlevnadsresa")
- **Empty states with warm language**: "Sektionsindelning kommer snart" instead of dry error messages

All visual enhancements use existing Tailwind classes and lucide-react icons — no new dependencies.

### Route Structure

[Source: docs/stories/completed/12.8.template-catalog-browse.md#Route Conflict Resolution]

Authenticated route under `app/(workspace)/laglistor/mallar/[slug]/` — automatically auth-gated by the workspace layout (`app/(workspace)/layout.tsx`):
1. `getCurrentUser()` → redirects to `/login` if null
2. `getWorkspaceContext()` → redirects to `/onboarding` if no workspace
3. Renders `<WorkspaceShell>` with sidebar navigation

Route hierarchy established in 12.8:
- `/laglistor` → Personal law lists (Story 4.11)
- `/laglistor/mallar` → Template catalog (Story 12.8) — "Mallbibliotek"
- `/laglistor/mallar/{slug}` → **Template detail/preview (this story)**

No additional auth checks needed in the page — layout handles it. [Source: app/(workspace)/layout.tsx]

### Data Models

[Source: prisma/schema.prisma]

**LawListTemplate** (template-level data — reuse from 12.8):
```prisma
model LawListTemplate {
  id                        String         @id @default(uuid())
  name                      String
  slug                      String         @unique
  description               String?        @db.Text
  domain                    String
  target_audience           String?
  status                    TemplateStatus @default(DRAFT)
  version                   Int            @default(1)
  document_count            Int            @default(0)
  section_count             Int            @default(0)
  primary_regulatory_bodies String[]
  parent_template_id        String?
  is_variant                Boolean        @default(false)
  variant_filter_field      String?
  metadata                  Json?
  created_by                String
  published_at              DateTime?
  created_at                DateTime       @default(now())
  updated_at                DateTime       @updatedAt
  parent   LawListTemplate?  @relation("TemplateVariant", fields: [parent_template_id], references: [id])
  children LawListTemplate[] @relation("TemplateVariant")
  sections TemplateSection[]
  items    TemplateItem[]
}
```

**TemplateSection** (section structure):
```prisma
model TemplateSection {
  id             String   @id @default(uuid())
  template_id    String
  section_number String   // "01", "02", ..., "09"
  name           String
  description    String?  @db.Text
  position       Float    @default(0)
  item_count     Int      @default(0)
  template LawListTemplate @relation(...)
  items    TemplateItem[]
  @@unique([template_id, section_number])
  @@index([template_id, position])
}
```

**TemplateItem** (law items with content):
```prisma
model TemplateItem {
  id                          String  @id @default(uuid())
  template_id                 String
  section_id                  String
  document_id                 String
  index                       String  // SSDD format: "0100", "0210"
  position                    Float   @default(0)
  compliance_summary          String? @db.Text
  expert_commentary           String? @db.Text
  source_type                 String? // "lag", "forordning", "foreskrift", etc.
  regulatory_body             String?
  is_service_company_relevant Boolean @default(true)
  variant_section_override    String? // Alt section for variant views
  content_status              TemplateItemContentStatus @default(STUB)
  template LawListTemplate @relation(...)
  section  TemplateSection @relation(...)
  document LegalDocument   @relation(...)
  @@unique([template_id, document_id])
  @@index([template_id, section_id, position])
}
```

**LegalDocument** (key fields for display):
- `document_number`: "SFS 1977:1160", "AFS 2023:1"
- `title`: Official statute title
- `slug`: For linking to law detail page

### Variant Query Strategy

[Source: docs/epics/epic-12-law-list-templates.md#Decision 2]

Variant templates (`is_variant = true`) have their **own** `TemplateSection` records (re-numbered, e.g., 7 sections for Arb.tj.) but **no TemplateItem records**. Items live on the parent template.

**Variant detail query approach**:
1. Fetch variant template by slug (to get its sections and metadata)
2. Fetch parent template's items where `is_service_company_relevant = true`
3. Map items to variant sections using the algorithm below
4. Include `parent.slug` for the "back to full version" link

**Section mapping algorithm** (pseudocode):
```
parentSections = parent.sections (indexed by section_number → section_id)
variantSections = variant.sections (indexed by section_number → section_id)
parentItems = parent.items WHERE is_service_company_relevant = true

FOR each item in parentItems:
  IF item.variant_section_override IS NOT NULL:
    // ~2 items have explicit override — use variant section with matching section_number
    targetSection = variantSections[item.variant_section_override]
  ELSE:
    // Default: map by matching section_number between parent and variant
    parentSection = parentSections WHERE id = item.section_id
    targetSection = variantSections[parentSection.section_number]
  END IF

  IF targetSection EXISTS:
    assign item to targetSection
  ELSE:
    // Section doesn't exist on variant — item is excluded from variant view
    skip item
  END IF
END FOR
```

**Simplified Phase C approach** (FE first, no seeded data): The variant query can be simpler initially — if no items exist, the page gracefully shows empty sections. The full variant resolution logic can be refined when real data is seeded (Phase E). The algorithm above is the target implementation but can be built incrementally.

### Decision A Awareness

[Source: docs/epics/epic-12-law-list-templates.md#Decision A]

Templates will initially be seeded with a **single placeholder section** ("Alla bestämmelser"). The accordion view should degrade gracefully: when there is only 1 section, render it as a flat list without accordion expand/collapse chrome, and add a note about upcoming section structure.

### Server Component Pattern

[Source: docs/architecture/section-9-summary.md#10.2 — Server-First Rendering]

Follow the existing workspace page pattern from `app/(workspace)/laglistor/mallar/page.tsx`. Since the title depends on the slug (dynamic), use `generateMetadata()` instead of a static `metadata` export:
```typescript
import { Metadata } from 'next'
import { notFound } from 'next/navigation'
import { getPublishedTemplateBySlug } from '@/lib/db/queries/template-catalog'
import { TemplateDetailClient } from '@/components/features/templates/template-detail-client'

export const dynamic = 'force-dynamic'

export async function generateMetadata({
  params,
}: {
  params: Promise<{ slug: string }>
}): Promise<Metadata> {
  const { slug } = await params
  const template = await getPublishedTemplateBySlug(slug)
  if (!template) return { title: 'Mall ej hittad | Laglig' }
  return {
    title: `${template.name} | Laglig`,
    description: template.description ?? undefined,
  }
}

export default async function TemplateDetailPage({
  params,
}: {
  params: Promise<{ slug: string }>
}) {
  const { slug } = await params  // Next.js 16 pattern
  const template = await getPublishedTemplateBySlug(slug)
  if (!template) notFound()
  return <TemplateDetailClient template={template} />
}
```

Note: `generateMetadata()` is required here because the page title depends on the resolved slug — a static `export const metadata` cannot access route params.

### Existing Component Patterns

[Source: docs/architecture/17-coding-standards.md#17.3]

- **Accordion**: `components/ui/accordion.tsx` (shadcn/ui, Radix UI) — installed, ready to use
- **Card**: `components/ui/card.tsx` — for CTA sidebar card
- **Badge**: `components/ui/badge.tsx` — for domain, source type, section count badges
- **Switch**: `components/ui/switch.tsx` — for variant toggle
- **Separator**: `components/ui/separator.tsx` — for visual dividers
- **Tooltip**: `components/ui/tooltip.tsx` — for disabled CTA tooltip
- **Button**: `components/ui/button.tsx` — for CTA and "Visa alla" actions
- **Icons**: Lucide Icons — `FileText`, `Layers`, `Calendar`, `Scale`, `ScrollText`, `FileCheck`, `Globe`, `BookOpen`, `Sparkles`, `ArrowLeft`, `SearchX`, `ChevronRight` [Source: docs/architecture/3-tech-stack.md#3.1]

### Dark Mode Badge Colors

[Source: docs/stories/completed/12.8.template-catalog-browse.md#Dark Mode Badge Colors]

All badge color customizations MUST include dark mode variants. Reuse colors from 12.8:
```tsx
// Arbetsmiljö: bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-950 dark:text-amber-300 dark:border-amber-800
// Miljö: bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-950 dark:text-emerald-300 dark:border-emerald-800
```

Source type badge colors (new, consistent with domain badge pattern):
```tsx
// lag: bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-950 dark:text-blue-300 dark:border-blue-800
// forordning: bg-slate-50 text-slate-700 border-slate-200 dark:bg-slate-950 dark:text-slate-300 dark:border-slate-800
// foreskrift: bg-orange-50 text-orange-700 border-orange-200 dark:bg-orange-950 dark:text-orange-300 dark:border-orange-800
// eu-forordning: bg-indigo-50 text-indigo-700 border-indigo-200 dark:bg-indigo-950 dark:text-indigo-300 dark:border-indigo-800
// allmanna-rad: bg-teal-50 text-teal-700 border-teal-200 dark:bg-teal-950 dark:text-teal-300 dark:border-teal-800
```

### Dependencies

- **Blocked by:** Story 12.2 (schema must exist) ✅ Done
- **Not blocked by:** 12.4/12.5/12.6 (seeding) — per Decision B, build with mock/empty data
- **Builds on:** Story 12.8 (catalog page, published template queries, template-card patterns)
- **Blocks:** Story 12.10 (adoption flow uses the detail page CTA as entry point)

### Relevant Source Tree

```
# New files
app/(workspace)/laglistor/mallar/[slug]/page.tsx              # Detail page (server component)
app/(workspace)/laglistor/mallar/[slug]/loading.tsx            # Loading skeleton
app/(workspace)/laglistor/mallar/[slug]/not-found.tsx          # Custom 404
components/features/templates/template-detail-client.tsx        # Client wrapper (layout + variant toggle)
components/features/templates/template-detail-header.tsx        # Header with stats bar
components/features/templates/template-sections-accordion.tsx   # Sections accordion with law list
components/features/templates/template-adopt-cta.tsx            # Adoption CTA sidebar/mobile
lib/constants/template-domains.ts                               # Shared domain labels, colors, source type mappings

# Modified files
lib/db/queries/template-catalog.ts                              # Add getPublishedTemplateBySlug query + types
components/features/templates/template-card.tsx                 # Import DOMAIN_LABELS/COLORS from shared constants
components/features/templates/template-catalog-client.tsx       # Import DOMAIN_LABELS from shared constants

# Test files
tests/unit/lib/db/queries/template-catalog-detail.test.ts
tests/unit/components/features/templates/template-detail-header.test.tsx
tests/unit/components/features/templates/template-sections-accordion.test.tsx
tests/unit/components/features/templates/template-adopt-cta.test.tsx
tests/unit/components/features/templates/template-detail-client.test.tsx
```

### Technical Constraints

- **TypeScript:** 5.5+ strict mode, `exactOptionalPropertyTypes: true` — optional props need explicit `| undefined` [Source: docs/architecture/17-coding-standards.md#17.2]
- **UI Library:** shadcn/ui (Radix UI + Tailwind) — mandatory for all UI components [Source: docs/architecture/17-coding-standards.md#17.3]
- **ORM:** Prisma 6.x with type-safe queries (project uses `^6.19.0`) [Source: package.json]
- **Icons:** Lucide Icons 0.365+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Date formatting:** date-fns 4.1+ with `sv` locale — `import { sv } from 'date-fns/locale/sv'` [Source: docs/architecture/3-tech-stack.md#3.1, package.json: `"date-fns": "^4.1.0"`]
- **Package manager:** pnpm [Source: docs/architecture/3-tech-stack.md#3.1]
- **Next.js 16:** `params` are Promises that must be awaited [Source: docs/architecture/12-nextjs-16-migration-notes.md]
- **No ActivityLog:** Templates are system-level entities — use plain Prisma operations [Source: Story 12.7a Dev Agent Record]
- **No SEO/structured data:** Page is behind auth, not publicly accessible [Source: Story 12.8 Change Log v1.2]

### Testing

- **Test framework:** Vitest 1.4+ with React Testing Library 14.2+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Test config:** `vitest.config.mts` — environment: `happy-dom`, setup: `tests/setup.ts` [Source: docs/architecture/section-15-summary.md#16.7]
- **Test location:** `tests/unit/lib/db/queries/`, `tests/unit/components/features/templates/`
- **Mocking strategy:** Use `vi.fn()` and `vi.mock()`. Do NOT make real DB calls in unit tests. Mock `prisma.lawListTemplate.findFirst` for detail query tests. [Source: docs/architecture/section-15-summary.md#16.6]
- **Current baseline:** 100 unit test files, 1398 tests (from 12.8)
- **Sample test fixture** (extend from 12.8 fixtures):
```typescript
const mockTemplateDetail: TemplateDetail = {
  id: 'uuid-1',
  name: 'Arbetsmiljö',
  slug: 'arbetsmiljo',
  description: 'Omfattande lagkrav för alla svenska arbetsgivare inom arbetsmiljöområdet.',
  domain: 'arbetsmiljo',
  target_audience: 'Alla svenska arbetsgivare oavsett bransch',
  document_count: 112,
  section_count: 9,
  primary_regulatory_bodies: ['Arbetsmiljöverket', 'Riksdagen'],
  is_variant: false,
  updated_at: '2026-02-10T00:00:00.000Z',
  parent_slug: null,
  variants: [{
    id: 'uuid-2',
    name: 'Arbetsmiljö för tjänsteföretag',
    slug: 'arbetsmiljo-tjansteforetag',
    document_count: 55,
    section_count: 7,
    target_audience: 'Tjänsteföretag',
  }],
  sections: [
    {
      id: 'section-uuid-1',
      section_number: '01',
      name: 'Grundläggande regelverk',
      description: 'Övergripande lagar och regler som styr arbetsmiljöarbetet.',
      item_count: 7,
      position: 1,
      items: [
        {
          id: 'item-uuid-1',
          index: '0100',
          position: 1,
          compliance_summary: 'Vi ska bedriva ett systematiskt arbetsmiljöarbete enligt arbetsmiljölagen.',
          expert_commentary: 'Arbetsmiljölagen är grundstenen i svenskt arbetsmiljöarbete...',
          source_type: 'lag',
          regulatory_body: 'Riksdagen',
          document: {
            id: 'doc-uuid-1',
            document_number: 'SFS 1977:1160',
            title: 'Arbetsmiljölag',
            slug: 'sfs-1977-1160',
          },
        },
        {
          id: 'item-uuid-2',
          index: '0101',
          position: 2,
          compliance_summary: 'Vi ska följa Arbetsmiljöverkets föreskrifter om systematiskt arbetsmiljöarbete.',
          expert_commentary: null,
          source_type: 'foreskrift',
          regulatory_body: 'Arbetsmiljöverket',
          document: {
            id: 'doc-uuid-2',
            document_number: 'AFS 2023:1',
            title: 'Systematiskt arbetsmiljöarbete',
            slug: 'afs-2023-1',
          },
        },
      ],
    },
    {
      id: 'section-uuid-2',
      section_number: '02',
      name: 'Fysisk arbetsmiljö',
      description: 'Krav på den fysiska arbetsmiljön inklusive arbetsplatsens utformning.',
      item_count: 3,
      position: 2,
      items: [
        {
          id: 'item-uuid-3',
          index: '0200',
          position: 1,
          compliance_summary: 'Vi ska säkerställa att arbetsplatsen utformas enligt gällande föreskrifter.',
          expert_commentary: 'Arbetsplatsens utformning är central för att förebygga olyckor...',
          source_type: 'foreskrift',
          regulatory_body: 'Arbetsmiljöverket',
          document: {
            id: 'doc-uuid-3',
            document_number: 'AFS 2020:1',
            title: 'Arbetsplatsens utformning',
            slug: 'afs-2020-1',
          },
        },
        {
          id: 'item-uuid-4',
          index: '0201',
          position: 2,
          compliance_summary: null,
          expert_commentary: null,
          source_type: 'eu-forordning',
          regulatory_body: 'EU',
          document: {
            id: 'doc-uuid-4',
            document_number: 'EU 2016/425',
            title: 'Personlig skyddsutrustning',
            slug: 'eu-2016-425',
          },
        },
      ],
    },
  ],
}
```

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Added mock data context per Decision B, single-section note per Decision A | Sarah (PO) |
| 2026-02-09 | 1.2     | Moved from public to authenticated route — template detail is logged-in only, removed SEO/structured data, simplified CTA (no unauthenticated path) | Sarah (PO) |
| 2026-02-09 | 2.0     | SM enrichment: corrected route from `(authenticated)` to `(workspace)` and from `/laglistor/{slug}` to `/laglistor/mallar/{slug}` (matching 12.8 card link targets); full architecture context with Prisma schema definitions, variant query strategy from Epic Decision 2, query implementation approach with interfaces; previous story insights from 12.8 Dev Agent Record; new shared constants task (extracting duplicated DOMAIN_LABELS/COLORS from 12.8 QA finding); source type icon/badge mappings with dark mode colors; detailed component breakdown (header, accordion, CTA, client wrapper) with specific Tailwind patterns; Decision A single-section graceful degradation; breadcrumb handling for dynamic slug; disabled CTA approach pre-12.10; generateMetadata for dynamic page titles; comprehensive test plan with fixtures extending 12.8 baseline; user design intent section capturing "fun & uplifting" visual direction with specific icon and layout suggestions | Bob (SM) |
| 2026-02-09 | 2.1     | PO validation fixes: **S-1** date-fns version corrected from 3.3+ to 4.1+ with correct v4 import path `date-fns/locale/sv`; **S-2** replaced static `metadata` code example with full `generateMetadata()` async pattern; **S-3** expanded Task 8 breadcrumb guidance — concrete instructions to add 'laglistor' and 'mallar' to `showAsLink` set; **S-4** added `DEFAULT_DOMAIN_COLOR` extraction to Task 7; **S-5** added explicit variant section mapping pseudocode algorithm; **N-1** expanded test fixture with second section (Fysisk arbetsmiljö, 2 items incl. EU regulation) for multi-section test coverage; **N-2** added `SearchX` icon fallback note (→ `Search` or `FileQuestion`) | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes
- All 9 tasks completed successfully with zero blockers
- **105 unit test files pass (1443 tests)** — up from 100 files / 1398 tests (baseline from 12.8)
- **45 new tests** across 5 new test files, all passing
- **TypeScript strict mode**: clean `tsc --noEmit` — zero errors
- No new dependencies added — all icons, components, and date-fns already in project
- `SearchX` icon confirmed available in installed lucide-react
- Variant section mapping algorithm fully implemented with `variant_section_override` support
- CTA button rendered as disabled with "Malladoption lanseras snart" note per story decision (pre-12.10)
- Mobile CTA rendered as inline card below content; desktop CTA as sticky sidebar
- Domain constants extracted to shared file; template-card.tsx and template-catalog-client.tsx updated — zero regression in existing 12.8 tests
- `SOURCE_TYPE_COLORS` added alongside `SOURCE_TYPE_LABELS` and `SOURCE_TYPE_ICONS` for colored source type badges with dark mode support

### File List

**New files:**
- `app/(workspace)/laglistor/mallar/[slug]/page.tsx` — Detail page (server component, generateMetadata)
- `app/(workspace)/laglistor/mallar/[slug]/loading.tsx` — Loading skeleton
- `app/(workspace)/laglistor/mallar/[slug]/not-found.tsx` — Custom 404 with SearchX icon
- `components/features/templates/template-detail-client.tsx` — Client wrapper (layout + variant toggle)
- `components/features/templates/template-detail-header.tsx` — Header with stats bar
- `components/features/templates/template-sections-accordion.tsx` — Sections accordion with law list
- `components/features/templates/template-adopt-cta.tsx` — Adoption CTA sidebar/mobile
- `lib/constants/template-domains.ts` — Shared domain labels, colors, source type mappings
- `tests/unit/lib/db/queries/template-catalog-detail.test.ts` — 11 query tests
- `tests/unit/components/features/templates/template-detail-header.test.tsx` — 10 header tests
- `tests/unit/components/features/templates/template-sections-accordion.test.tsx` — 12 accordion tests
- `tests/unit/components/features/templates/template-adopt-cta.test.tsx` — 5 CTA tests
- `tests/unit/components/features/templates/template-detail-client.test.tsx` — 7 client wrapper tests

**Modified files:**
- `lib/db/queries/template-catalog.ts` — Added TemplateDetail/Section/Item interfaces + getPublishedTemplateBySlug query
- `components/features/templates/template-card.tsx` — Import DOMAIN_LABELS/COLORS/DEFAULT from shared constants
- `components/features/templates/template-catalog-client.tsx` — Import DOMAIN_LABELS from shared constants
- `components/layout/breadcrumbs.tsx` — Added 'laglistor' and 'mallar' to showAsLink set

### Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-09 | dev-1.0 | Implementation complete — all 9 tasks done, 45 new tests passing, zero regressions | James (Dev) |
| 2026-02-09 | dev-1.1 | QA review-qa: Gate PASS (92/100), zero top_issues, zero ac_gaps, all NFRs PASS. No code changes needed. Status → Ready for Done | James (Dev) |
| 2026-02-09 | dev-1.2 | Applied QA future recommendations: (1) Removed unused `templateSlug` prop from TemplateAdoptCta + callers + tests; (2) Wrapped `getPublishedTemplateBySlug` with React `cache()` for request-level dedup between generateMetadata and page render | James (Dev) |
| 2026-02-09 | dev-1.3 | UX iteration: (1) Reworked accordion to 2-column table (Typ + Dokument) with tabbed expand content ("Krav" / "Om lagen"); (2) CTA converted from sidebar card to compact inline toolbar; (3) Full-width layout (removed two-column sidebar); (4) FormattedText component for bullet lists + sentence splitting; (5) Updated seed with full AI-generated content for Arbetsmiljölag; (6) Added source toggle ("Laglig standardmallar" / "Community") to catalog browse page for future community templates; (7) Captured content inheritance design note in Story 12.10 | James (Dev) |

## QA Results

### Gate Decision: PASS

**Quality Score: 92/100**
**Reviewer:** Quinn (Test Architect)
**Date:** 2026-02-09

### Requirements Traceability

| AC | Status | Evidence |
|----|--------|----------|
| 1. Authenticated route `/laglistor/mallar/{slug}` | PASS | `app/(workspace)/laglistor/mallar/[slug]/page.tsx` — workspace layout auth-gated, `force-dynamic`, Next.js 16 `await params` pattern, `generateMetadata()` |
| 2. Template header | PASS | `template-detail-header.tsx` — h1 name, description, domain badge (colored + dark mode), target audience badge, regulatory body badges, stats bar with icons. 10 tests. |
| 3. Section accordion view | PASS | `template-sections-accordion.tsx` — multi-section accordion with colored number badges, source type icons/badges, compliance summary preview with "Visa alla" expansion. 12 tests. |
| 4. CTA | PASS | `template-adopt-cta.tsx` — disabled "Använd denna mall" button, "Malladoption lanseras snart" note per pre-12.10 decision. 5 tests. |
| 5. Variant toggle + parent link | PASS | `template-detail-client.tsx` — Switch toggle navigates via `router.push()` to variant slug; variant pages show "Visa fullständig version" link to parent. 4 tests. |
| 6. Stats bar | PASS | Header stats bar: FileText + document count, Layers + section count, Calendar + date-fns `sv` locale formatted date. 3 tests. |
| 7. Not-found handling | PASS | `not-found.tsx` — custom 404 with SearchX icon, Swedish text, link to catalog. Query returns `null` for non-PUBLISHED slugs. 2 query tests. |
| 8. Empty/single section handling | PASS | Single section: flat list without accordion chrome + "Sektionsindelning kommer snart" note. Empty items: "Inga dokument i denna sektion ännu". 3 tests. |
| 9. Mobile-responsive layout | PASS | `flex-col lg:flex-row` two-column layout; desktop sticky sidebar CTA (`hidden lg:block w-80`); mobile CTA at bottom (`lg:hidden`). Verified via rendering tests. |

### Test Architecture

- **45 new tests** across 5 files — all passing
- **11 query tests**: core paths, variant section mapping, `variant_section_override`, null handling, PUBLISHED status filter, ISO date conversion
- **10 header tests**: name, description (present/null), domain badge, target audience (present/null), regulatory bodies, stats bar (doc count, section count, date)
- **12 accordion tests**: multi-section rendering, badges, expand/collapse, source types, compliance summaries, "Visa alla" expand, single-section flat, empty section
- **5 CTA tests**: button text, disabled state, note, template name, tagline
- **7 client wrapper tests**: composition (header, accordion, CTA), variant toggle show/hide, parent link show/hide
- **Zero regressions**: 12.8 tests (14) still pass; full suite 59/59 in template test directory

### Code Quality Highlights

- **Shared constants extraction** (`lib/constants/template-domains.ts`): Addresses 12.8 QA finding — DOMAIN_LABELS/COLORS no longer duplicated
- **Variant mapping algorithm**: Correctly implements story pseudocode including `variant_section_override` support
- **`mapItem()` helper**: Strips internal Prisma fields (`section_id`, `is_service_company_relevant`, `variant_section_override`) from public interface
- **Dark mode**: All badge colors (domain, source type, section numbers) include dark mode variants
- **Heading hierarchy**: h1 (header name), h2 (single-section name), h3 (CTA template name) — accessible
- **Swedish localization**: All UI text in Swedish, date-fns `sv` locale

### Observations (Non-blocking)

1. **`templateSlug` prop accepted but unused** in `template-adopt-cta.tsx:8` — intentionally reserved for Story 12.10 adoption flow. TypeScript doesn't flag it because it's in the interface. Acceptable.
2. **Double `getPublishedTemplateBySlug` call** in `generateMetadata` + page function — standard Next.js pattern per story spec. Prisma doesn't auto-deduplicate, but acceptable for low-traffic auth page.

### NFR Validation

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | Read-only queries behind workspace auth. Slug as Prisma parameter — no injection risk. No user-controlled inputs. |
| Performance | PASS | Selective `select` fields, position-indexed ordering, single DB round-trip per page load. |
| Reliability | PASS | Null → `notFound()`, empty states handled, variant mapping skips unmapped items gracefully. |
| Maintainability | PASS | Clean component separation, shared constants, typed interfaces, comprehensive tests. |
