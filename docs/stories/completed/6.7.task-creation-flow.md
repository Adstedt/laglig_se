# Story 6.7: Implement Task Creation Flow

## Status

Ready for Review

## Story

**As a** user,
**I want** to create tasks from multiple entry points,
**so that** I can capture compliance work when I identify it.

## Acceptance Criteria

**From Legal Document Modal:**

1. "Skapa uppgift" button in Tasks tab (Uppgifter Summary Box)
2. Task automatically linked to current list item
3. Quick form: title, description (optional), assignee, due date
4. "Skapa" saves and shows task in list
5. "Skapa och öppna" saves and opens Task Modal

**From Task Workspace:**

6. "Ny uppgift" button in toolbar (next to search/filters)
7. Full form with all fields including linked laws selector
8. Task appears in "Att göra" column (first default column)

**From Global Header:**

9. "+ Skapa" button in header (next to search bar, always visible)
10. Opens create task modal (Jira-style slide-in panel)
11. Full form: title\*, priority, status, assignee, due date, linked laws
12. "Tilldela mig" quick action for assignee
13. "Skapa en till" checkbox to create multiple tasks in sequence
14. Task created in selected status column (default: "Att göra")

**From Keyboard Shortcut:**

15. Ctrl+Shift+T (Windows) / Cmd+Shift+T (Mac) opens same modal as header button

**Validation:**

16. Title required (min 3 characters)
17. Due date optional but recommended (show warning if empty)

## Tasks / Subtasks

### Prerequisites

- [x] **Task 0: Existing createTask action** (Already done in Story 6.6)
  - `app/actions/tasks.ts` already has `createTask` action that works
  - Kanban `+` button uses this for inline creation

### New Implementation

- [x] **Task 1: Extend createTask server action** (AC: 2, 8, 14)
  - [x] Modify `app/actions/tasks.ts`
  - [x] Make `columnId` optional - if not provided, find default column
  - [x] Add `linkedListItemIds?: string[]` parameter
  - [x] Create `TaskListItemLink` records when provided
  - [x] Add activity log entry for task creation
  - [x] Return full task with relations for immediate display
  - [x] Added `searchLawListItemsForLinking` action for law selector

- [x] **Task 2: Create searchable law selector component** (AC: 7, 11)
  - [x] Create `components/features/tasks/law-link-selector.tsx`
  - [x] Combobox with search (title, document number)
  - [x] Shows law title + SFS number + list name
  - [x] Multi-select support
  - [x] Query workspace law list items via server action
  - [x] Added Command component (cmdk) for combobox UI

- [x] **Task 3: Create Task Creation Form Component** (AC: 3, 7, 12, 13)
  - [x] Create `components/features/tasks/task-creation-form.tsx`
  - [x] Props: `mode: 'quick' | 'full'`, `linkedListItemId?: string`, `onSuccess`, `onCancel`
  - [x] Quick mode: title, description (optional), assignee, due date
  - [x] Full mode: All fields + linked laws multi-selector
  - [x] Use React Hook Form + Zod for validation
  - [x] Title validation: min 3 characters, max 200
  - [x] Due date warning: Show amber indicator if empty
  - [x] Assignee selector: Dropdown of workspace members
  - [x] Priority selector: LOW/MEDIUM/HIGH/CRITICAL (default MEDIUM)

- [x] **Task 4: Create Global Task Creation Modal** (AC: 9, 10, 11, 12, 13, 14, 15)
  - [x] Create `components/features/tasks/create-task-modal.tsx`
  - [x] Jira-style centered modal
  - [x] Full form fields:
    - Title\* (required, min 3 chars)
    - Priority selector (LOW/MEDIUM/HIGH/CRITICAL, default MEDIUM)
    - Status/Column selector (default: first column "Att göra")
    - Assignee dropdown with "Tilldela mig" quick action
    - Due date picker (optional, show warning if empty)
    - Linked laws multi-selector
  - [x] Footer: "Skapa en till" checkbox, Cancel, Create buttons
  - [x] On create with "Skapa en till": clear form, keep modal open, show toast
  - [x] On create without: close modal, show toast
  - [x] ESC closes, Ctrl+Enter submits

- [x] **Task 5: Add "+ Skapa" Button to Global Header** (AC: 9)
  - [x] Modify `components/layout/header.tsx` (authenticated workspace header)
  - [x] Add "+ Skapa" button (primary style, prominent placement near search)
  - [x] Button opens CreateTaskModal
  - [x] Visible on all authenticated workspace pages

- [x] **Task 6: Implement Global Keyboard Shortcut** (AC: 15)
  - [x] Create `lib/hooks/use-global-keyboard-shortcuts.ts`
  - [x] Listen for Ctrl+Shift+T (Windows) / Cmd+Shift+T (Mac)
  - [x] Prevent default browser behavior (re-open tab)
  - [x] Open CreateTaskModal
  - [x] Hook registered in Header component

- [x] **Task 7: Add "Ny uppgift" button to Task Workspace** (AC: 6, 7, 8)
  - [x] Modify `components/features/tasks/task-workspace/index.tsx`
  - [x] Add "Ny uppgift" button in header (next to tab navigation)
  - [x] Button opens CreateTaskModal (reuse same modal as header)
  - [x] On success: Task appears in selected column, show toast

- [x] **Task 8: Add "Skapa uppgift" to Legal Document Modal** (AC: 1, 2, 3, 4, 5)
  - [x] Modify `components/features/document-list/legal-document-modal/tasks-summary-box.tsx`
  - [x] Add "+ Skapa uppgift" button below task list
  - [x] Opens inline expandable form (quick mode)
  - [x] Pre-populate `linkedListItemId` with current list item
  - [x] "Skapa" creates and collapses form
  - [x] "Skapa och öppna" creates and triggers `onOpenTask(taskId)`

- [x] **Task 9: Unit tests** (All ACs)
  - [x] Test CreateTaskModal validation (title min 3 chars)
  - [x] Test "Skapa en till" checkbox behavior
  - [x] Test task creation success/failure

- [ ] **Task 10: E2E tests** (Deferred to QA phase)
  - [ ] E2E: Create task from header "+ Skapa" button
  - [ ] E2E: Create task from Legal Document Modal
  - [ ] E2E: Create task from Task Workspace toolbar
  - [ ] E2E: Create task via Ctrl+Shift+T
  - [ ] E2E: "Skapa en till" creates multiple tasks
  - [ ] E2E: Task appears in correct column

## Dev Notes

### Previous Story Context (6.6)

Story 6.6 implemented the Task Modal and basic inline task creation on the Kanban board. Key learnings:

- **Inline creation pattern:** The Kanban column `+` button opens an input field inline, submits via `createTask` action
- **createTask action exists:** Located in `app/actions/tasks.ts`, accepts `{ title, columnId, description?, ... }`
- **Task model:** Uses `Task` with `TaskColumn` for status, `TaskListItemLink` for law connections
- **Workspace context:** All actions use `withWorkspace()` for authorization

[Source: Story 6.6 Dev Agent Record - Completion Notes]

### Data Model Reference

**Task (from 4.30):**

```typescript
interface Task {
  id: string
  workspace_id: string
  title: string
  description: string | null
  status_column_id: string // FK to TaskColumn
  position: number
  assignee_id: string | null
  due_date: Date | null
  priority: 'LOW' | 'MEDIUM' | 'HIGH'
  labels: string[]
  created_by_id: string
  created_at: Date
  updated_at: Date
}
```

**TaskListItemLink (from 4.32):**

```typescript
interface TaskListItemLink {
  id: string
  task_id: string
  list_item_id: string // FK to LawListItem
}
```

[Source: architecture/4-data-models.md#4.30, #4.32]

### File Locations

**New Files:**

```
components/features/tasks/
  create-task-modal.tsx        # Jira-style global creation modal
  task-creation-form.tsx       # Reusable form (quick/full modes)
  law-link-selector.tsx        # Searchable law selector

lib/hooks/
  use-global-keyboard-shortcuts.ts  # Ctrl+Shift+T handler
```

**Files to Modify:**

```
components/layout/header.tsx
  - Authenticated workspace header (not public pages)
  - Add "+ Skapa" button that opens CreateTaskModal

components/features/tasks/task-workspace/index.tsx
  - Add "Ny uppgift" button to header

components/features/document-list/legal-document-modal/tasks-summary-box.tsx
  - Add "+ Skapa uppgift" button and inline form

app/actions/tasks.ts
  - Extend createTask with linkedListItemIds
  - Make columnId optional with default column fallback

app/layout.tsx OR components/providers/
  - Register global keyboard shortcuts hook
  - Mount CreateTaskModal at root level
```

[Source: architecture/12-unified-project-structure.md#12.2]

### UI Component Standards

**Use shadcn/ui components:**

```typescript
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Button } from '@/components/ui/button'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { Calendar } from '@/components/ui/calendar'
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
} from '@/components/ui/command'
```

**Form Validation (React Hook Form + Zod):**

```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'

const CreateTaskSchema = z.object({
  title: z.string().min(3, 'Titeln måste vara minst 3 tecken').max(200),
  description: z.string().max(10000).optional(),
  assignee_id: z.string().uuid().nullable().optional(),
  due_date: z.date().nullable().optional(),
  priority: z.enum(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']).default('MEDIUM'),
  column_id: z.string().uuid().optional(), // Optional - uses default column if not provided
  linked_list_item_ids: z.array(z.string().uuid()).optional(),
})
```

[Source: architecture/17-coding-standards.md#17.3, architecture/3-tech-stack.md#3.1]

### Jira-Style Create Modal Pattern

The global create modal follows Jira's UX pattern:

```typescript
// components/features/tasks/create-task-modal.tsx
'use client'

interface CreateTaskModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  defaultLinkedLawId?: string  // Pre-populate when opened from law context
}

export function CreateTaskModal({ open, onOpenChange, defaultLinkedLawId }: CreateTaskModalProps) {
  const [createAnother, setCreateAnother] = useState(false)
  const { data: session } = useSession()

  const form = useForm<CreateTaskInput>({
    resolver: zodResolver(CreateTaskSchema),
    defaultValues: {
      title: '',
      priority: 'MEDIUM',
      columnId: undefined,  // Will use default column
      assigneeId: null,
      dueDate: null,
      linkedListItemIds: defaultLinkedLawId ? [defaultLinkedLawId] : [],
    },
  })

  const onSubmit = async (data: CreateTaskInput) => {
    const result = await createTask(data)

    if (result.success) {
      toast.success('Uppgift skapad')

      if (createAnother) {
        form.reset({ ...form.getValues(), title: '' })  // Keep selections, clear title
      } else {
        onOpenChange(false)
      }
    } else {
      toast.error(result.error)
    }
  }

  const handleAssignToMe = () => {
    if (session?.user?.id) {
      form.setValue('assigneeId', session.user.id)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Skapa uppgift</DialogTitle>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            {/* Title - Required */}
            <FormField name="title" ... />

            {/* Priority */}
            <FormField name="priority" ... />

            {/* Status/Column */}
            <FormField name="columnId" ... />

            {/* Assignee with "Tilldela mig" */}
            <div className="flex items-end gap-2">
              <FormField name="assigneeId" className="flex-1" ... />
              <Button type="button" variant="link" onClick={handleAssignToMe}>
                Tilldela mig
              </Button>
            </div>

            {/* Due Date */}
            <FormField name="dueDate" ... />

            {/* Linked Laws */}
            <FormField name="linkedListItemIds" ... />

            {/* Footer */}
            <DialogFooter className="flex items-center justify-between">
              <label className="flex items-center gap-2 text-sm">
                <Checkbox
                  checked={createAnother}
                  onCheckedChange={setCreateAnother}
                />
                Skapa en till
              </label>
              <div className="flex gap-2">
                <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                  Avbryt
                </Button>
                <Button type="submit">Skapa</Button>
              </div>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  )
}
```

**Global Modal State Management:**

Use Zustand or React Context to manage modal state globally:

```typescript
// lib/stores/ui-store.ts
interface UIState {
  createTaskModalOpen: boolean
  createTaskModalProps: { defaultLinkedLawId?: string }
  openCreateTaskModal: (props?: { defaultLinkedLawId?: string }) => void
  closeCreateTaskModal: () => void
}

export const useUIStore = create<UIState>((set) => ({
  createTaskModalOpen: false,
  createTaskModalProps: {},
  openCreateTaskModal: (props = {}) =>
    set({
      createTaskModalOpen: true,
      createTaskModalProps: props,
    }),
  closeCreateTaskModal: () =>
    set({
      createTaskModalOpen: false,
      createTaskModalProps: {},
    }),
}))
```

Then in the header:

```typescript
// In navbar
const { openCreateTaskModal } = useUIStore()

<Button onClick={() => openCreateTaskModal()}>
  <Plus className="h-4 w-4 mr-1" />
  Skapa
</Button>
```

### Keyboard Shortcut Implementation

```typescript
// lib/hooks/use-global-keyboard-shortcuts.ts
'use client'

import { useEffect } from 'react'

export function useGlobalKeyboardShortcuts(handlers: {
  onQuickTaskCreate?: () => void
}) {
  useEffect(() => {
    function handleKeyDown(e: KeyboardEvent) {
      // Ctrl+Shift+T (Windows) or Cmd+Shift+T (Mac)
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
        e.preventDefault() // Prevent browser re-open tab
        handlers.onQuickTaskCreate?.()
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [handlers])
}
```

[Source: PRD Epic 6 Story 6.7 AC#9]

### Existing createTask Pattern

The existing `createTask` action in `app/actions/tasks.ts` (line ~43) accepts:

```typescript
interface CreateTaskInput {
  title: string
  columnId: string
  description?: string
  assigneeId?: string
  dueDate?: Date
  priority?: 'LOW' | 'MEDIUM' | 'HIGH'
}
```

Extend to add:

```typescript
interface CreateTaskInput {
  // ... existing fields
  linkedListItemIds?: string[] // NEW: Law links
}
```

After creating task, create links:

```typescript
if (linkedListItemIds?.length) {
  await prisma.taskListItemLink.createMany({
    data: linkedListItemIds.map((listItemId) => ({
      task_id: task.id,
      law_list_item_id: listItemId,
    })),
  })
}
```

### Swedish Text Translations

| English                             | Swedish                          |
| ----------------------------------- | -------------------------------- |
| Create                              | Skapa                            |
| Create task                         | Skapa uppgift                    |
| New task                            | Ny uppgift                       |
| Title                               | Titel                            |
| Summary                             | Sammanfattning                   |
| Description                         | Beskrivning                      |
| Status                              | Status                           |
| Assignee                            | Ansvarig                         |
| Assign to me                        | Tilldela mig                     |
| Due date                            | Förfallodatum                    |
| Priority                            | Prioritet                        |
| Link laws                           | Länka lagar                      |
| Search laws...                      | Sök lagar...                     |
| Create                              | Skapa                            |
| Create another                      | Skapa en till                    |
| Create and open                     | Skapa och öppna                  |
| Cancel                              | Avbryt                           |
| Title must be at least 3 characters | Titeln måste vara minst 3 tecken |
| Summary is required                 | Titel krävs                      |
| No due date set                     | Inget förfallodatum satt         |
| Task created                        | Uppgift skapad                   |
| Task created successfully           | Uppgiften har skapats            |

### Error Handling Pattern

```typescript
// Server action pattern
export async function createTask(
  input: CreateTaskInput
): Promise<ActionResult<Task>> {
  try {
    const validated = CreateTaskSchema.parse(input)

    return await withWorkspace(async ({ workspaceId, userId }) => {
      // Get default column if not specified
      const column = await prisma.taskColumn.findFirst({
        where: { workspace_id: workspaceId, is_default: true },
        orderBy: { position: 'asc' },
      })

      if (!column) {
        return { success: false, error: 'Ingen standardkolumn hittades' }
      }

      const task = await prisma.task.create({
        data: {
          workspace_id: workspaceId,
          title: validated.title,
          // ... other fields
          column_id: validated.columnId ?? column.id,
          created_by: userId,
        },
        include: {
          /* relations for return */
        },
      })

      // Create links
      if (validated.linkedListItemIds?.length) {
        await prisma.taskListItemLink.createMany({
          data: validated.linkedListItemIds.map((id) => ({
            task_id: task.id,
            law_list_item_id: id,
          })),
        })
      }

      // Log activity
      await logActivity(workspaceId, userId, 'task', task.id, 'created')

      revalidatePath('/tasks')
      return { success: true, data: task }
    })
  } catch (error) {
    if (error instanceof z.ZodError) {
      return {
        success: false,
        error: error.issues[0]?.message ?? 'Ogiltiga data',
      }
    }
    console.error('createTask error:', error)
    return { success: false, error: 'Kunde inte skapa uppgift' }
  }
}
```

[Source: architecture/17-coding-standards.md#17.5]

### Accessibility Requirements

- Dialog uses Radix Dialog (focus trap, ESC to close)
- Form fields have proper labels and aria attributes
- Keyboard navigation between form fields
- Error messages announced to screen readers
- Touch targets minimum 44x44px on mobile

[Source: architecture/17-coding-standards.md]

### Security Considerations

- **Workspace Authorization:** All server actions use `withWorkspace()` which validates user membership and extracts `workspaceId` from session
- **RLS Policies:** Prisma queries are scoped to workspace; Supabase RLS provides additional database-level protection
- **Assignee Validation:** Only workspace members can be assigned to tasks - verify membership before assignment
- **Input Validation:** All inputs validated via Zod schemas on server side (never trust client)
- **No Direct IDs in URLs:** Task creation modal uses controlled state, not URL parameters that could be manipulated

## Testing

### Test File Locations

```
tests/unit/components/features/tasks/
  task-creation-form.test.tsx
  create-task-modal.test.tsx
  law-link-selector.test.tsx

tests/unit/lib/hooks/
  use-global-keyboard-shortcuts.test.ts

tests/e2e/
  task-creation.spec.ts
```

### Testing Standards

**Unit Tests (Vitest + React Testing Library):**

```typescript
// task-creation-form.test.tsx
describe('TaskCreationForm', () => {
  it('validates title minimum length', async () => {
    render(<TaskCreationForm mode="quick" onSuccess={vi.fn()} onCancel={vi.fn()} />)

    await userEvent.type(screen.getByLabelText(/titel/i), 'ab')
    await userEvent.click(screen.getByRole('button', { name: /skapa/i }))

    expect(screen.getByText(/minst 3 tecken/i)).toBeInTheDocument()
  })

  it('shows due date warning when empty', async () => {
    render(<TaskCreationForm mode="full" onSuccess={vi.fn()} onCancel={vi.fn()} />)

    await userEvent.type(screen.getByLabelText(/titel/i), 'Test task')

    expect(screen.getByText(/inget förfallodatum/i)).toBeInTheDocument()
  })

  it('pre-populates linked law in quick mode', async () => {
    render(
      <TaskCreationForm
        mode="quick"
        linkedListItemId="list-item-123"
        onSuccess={vi.fn()}
        onCancel={vi.fn()}
      />
    )

    // Verify linked law badge is shown
    expect(screen.getByTestId('linked-law-badge')).toBeInTheDocument()
  })
})
```

**E2E Tests (Playwright):**

```typescript
// task-creation.spec.ts
test.describe('Task Creation Flow', () => {
  test('creates task from Legal Document Modal', async ({ page }) => {
    await page.goto('/workspace/laws')
    await page.click('[data-testid="law-list-item-1"]')

    await expect(page.locator('[role="dialog"]')).toBeVisible()
    await page.click('text=Skapa uppgift')

    await page.fill('[name="title"]', 'New compliance task')
    await page.click('button:has-text("Skapa")')

    await expect(page.locator('text=Uppgift skapad')).toBeVisible()
  })

  test('opens create task modal with Ctrl+Shift+T', async ({ page }) => {
    await page.goto('/workspace/tasks')
    await page.keyboard.press('Control+Shift+T')

    await expect(
      page.locator('[data-testid="create-task-modal"]')
    ).toBeVisible()
  })
})
```

[Source: architecture/3-tech-stack.md#3.1 - Vitest 1.4+, React Testing Library 14.2+, Playwright 1.42+]

### Test Coverage Target

60-70% coverage for new components

## Change Log

| Date       | Version | Description                                                                          | Author      |
| ---------- | ------- | ------------------------------------------------------------------------------------ | ----------- |
| 2026-01-08 | 1.0     | Initial story creation                                                               | Sarah (PO)  |
| 2026-01-26 | 2.0     | Enhanced with full technical context                                                 | Bob (SM)    |
| 2026-01-26 | 2.1     | Validation fixes: task reorder, header.tsx path, CRITICAL priority, security section | Sarah (PO)  |
| 2026-01-26 | 2.2     | Dev fixes: document truncation, optimistic UI, SWR caching, delete button removal    | James (Dev) |

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101 (Opus 4.5)

### Debug Log References

No debug sessions required - standard implementation.

### Completion Notes List

1. **createTask action extended** - Made columnId optional with default column fallback, added linkedListItemIds parameter for law linking, uses Prisma transaction for atomicity
2. **searchLawListItemsForLinking action created** - New action for searching workspace law list items by title/document number
3. **Command component (cmdk) added** - shadcn/ui Command component for combobox functionality in law selector
4. **Law link selector implemented** - Multi-select combobox with debounced search, displays law title + SFS number + list name
5. **TaskCreationForm implemented** - Reusable form with quick/full modes, React Hook Form + Zod validation, due date warning
6. **CreateTaskModal implemented** - Jira-style centered modal with "Skapa en till" functionality, Ctrl+Enter to submit
7. **Global keyboard shortcuts hook created** - Handles Ctrl+Shift+T / Cmd+Shift+T, ignores input/textarea focus
8. **Header "+ Skapa" button added** - Primary button in workspace header, opens CreateTaskModal
9. **Task workspace "Ny uppgift" button added** - Button next to tab navigation, opens same modal
10. **Legal Document Modal inline form added** - Expandable form in tasks-summary-box, pre-links current law item
11. **exactOptionalPropertyTypes compatibility** - Used conditional object building and explicit undefined types in interfaces
12. **All unit tests pass (8/8)** - CreateTaskModal tests cover validation, creation, "Skapa en till", cancel, error handling
13. **E2E tests deferred to QA phase** - Per story Task 10 specification
14. **Document title truncation fix** - Used `w-0 flex-1` CSS pattern in linked-laws-box.tsx to properly truncate long titles without pushing icons off-screen
15. **Optimistic UI for document linking** - Added immediate UI feedback for link/unlink operations in LinkedLawsBox with revert-on-error handling
16. **SWR caching for law lists** - Created use-law-lists.ts hook with SWR caching; revalidateOnMount ensures fresh counts when dialog opens
17. **Debounce hook created** - Created use-debounce.ts for 300ms search input debouncing
18. **Delete button removed** - Removed "Radera uppgift" button from modal-footer.tsx per UX decision
19. **TypeScript/ESLint fixes** - Fixed exactOptionalPropertyTypes with explicit `| undefined`, renamed unused params to `_links`

### File List

**New Files:**

- `components/ui/command.tsx` - shadcn/ui Command component (cmdk)
- `components/features/tasks/law-link-selector.tsx` - Searchable multi-select law combobox
- `components/features/tasks/task-creation-form.tsx` - Reusable form with quick/full modes
- `components/features/tasks/create-task-modal.tsx` - Global Jira-style creation modal
- `lib/hooks/use-global-keyboard-shortcuts.ts` - Ctrl+Shift+T handler
- `lib/hooks/use-law-lists.ts` - SWR hooks for caching law lists and items
- `lib/hooks/use-debounce.ts` - Debounce hook for search input
- `tests/unit/components/features/tasks/create-task-modal.test.tsx` - Unit tests (8 tests)

**Modified Files:**

- `app/actions/tasks.ts` - Extended createTask, added searchLawListItemsForLinking, getLawListItemsForLinking, LawListItemForLinking type with documentId
- `components/layout/header.tsx` - Added "+ Skapa" button, keyboard shortcuts, CreateTaskModal
- `components/features/tasks/task-workspace/index.tsx` - Added "Ny uppgift" button, CreateTaskModal
- `components/features/document-list/legal-document-modal/tasks-summary-box.tsx` - Added inline expandable form
- `components/features/tasks/task-modal/linked-laws-box.tsx` - Optimistic UI, SWR caching, truncation fix
- `components/features/tasks/task-modal/modal-footer.tsx` - Removed delete button, simplified to timestamps only
- `components/features/tasks/task-modal/right-panel.tsx` - Removed onClose prop (no longer needed)
- `components/features/tasks/task-modal/index.tsx` - Updated RightPanel props
- `lib/hooks/use-task-details.ts` - Added optimisticUpdateLinks function

## QA Results

### Review Date: 2026-01-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Strong implementation with clean, well-organized code following established patterns. The code demonstrates:

- Consistent use of shadcn/ui components (Dialog, Form, Select, Popover, Command)
- Proper TypeScript types with discriminated unions for action results
- React Hook Form + Zod validation for form handling
- Appropriate separation of concerns (modal, form, selector as separate components)
- Transaction-based database operations for atomicity
- Proper workspace authorization via `withWorkspace()` wrapper

### Refactoring Performed

None required - implementation quality is production-ready.

### Compliance Check

- Coding Standards: ✓ Uses shadcn/ui, proper TypeScript, Zod validation
- Project Structure: ✓ Files in correct locations per architecture docs
- Testing Strategy: ✓ Unit tests present (8/8 passing), E2E deferred per story design
- All ACs Met: ✓ All 17 acceptance criteria implemented

### Improvements Checklist

- [x] All unit tests passing (8/8)
- [x] TypeScript type checking passes with no errors
- [x] Server-side validation via Zod schemas
- [x] Workspace authorization on all server actions
- [x] Optimistic UI patterns with error revert
- [x] Swedish localization throughout
- [ ] Consider extracting shared CreateTaskSchema to shared location (minor duplication in modal and form)
- [ ] Add DialogDescription for improved accessibility (currently shows warnings in tests)
- [ ] E2E tests to be implemented in QA phase per story Task 10

### Security Review

**Status: PASS**

- All server actions use `withWorkspace()` for authorization
- Zod schemas validate all inputs server-side
- Assignee selection validates workspace membership
- LinkedListItemIds validated against workspace ownership before linking
- No direct URL parameter manipulation possible (controlled modal state)

### Performance Considerations

**Status: PASS**

- Uses SWR caching for law lists (use-law-lists.ts hook)
- Debounced search input (300ms via use-debounce.ts)
- Lazy loading of workspace members when form expands
- Optimistic UI updates for responsive feel

### Files Modified During Review

None - no refactoring was performed.

### Gate Status

Gate: PASS → docs/qa/gates/6.7-task-creation-flow.yml
Risk profile: Low risk - standard CRUD operation with proper authorization
NFR assessment: All NFRs validated inline

### Recommended Status

✓ Ready for Done

All acceptance criteria implemented, unit tests passing, TypeScript clean, security controls in place. E2E tests deferred to QA phase per story specification.
