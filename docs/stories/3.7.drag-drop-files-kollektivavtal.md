# Story 3.7: Implement Drag-and-Drop for Files into Chat (Kollektivavtal PDFs)

## Status

Draft

## Story

**As a** user,
**I want** to drag uploaded kollektivavtal PDFs into chat,
**so that** the AI can answer questions from that specific agreement.

## Acceptance Criteria

1. File upload feature (from HR Module Epic 7) allows PDF uploads
2. Uploaded PDFs chunked and embedded into vector database (separate from laws)
3. File cards made draggable
4. Dragging file adds context pill: filename, "X" to remove
5. RAG pipeline searches both law embeddings AND file embeddings
6. Citations distinguish between laws and uploaded files
7. Example: "What does our kollektivavtal say about overtime?" → AI searches uploaded PDF
8. File embeddings tagged with workspace_id for multi-tenancy
9. Mobile: Tap file → "Add to chat context"

## Tasks / Subtasks

- [ ] Implement PDF upload and parsing
- [ ] Chunk and embed PDF content
- [ ] Store file embeddings separately
- [ ] Make file cards draggable
- [ ] Update RAG to search multiple embedding sources
- [ ] Add citation source distinction

## Dev Notes

**PDF Processing:**

```typescript
import { PDFLoader } from 'langchain/document_loaders/fs/pdf'

async function processPDF(file: File, workspaceId: string) {
  const loader = new PDFLoader(file)
  const docs = await loader.load()

  // Chunk PDF content
  const chunks = chunkPDFContent(docs)

  // Generate embeddings
  const embeddings = await generateEmbeddings(chunks)

  // Store with workspace_id tag
  await prisma.fileEmbedding.createMany({
    data: embeddings.map((e) => ({
      workspaceId,
      filename: file.name,
      chunkText: e.text,
      embedding: e.vector,
    })),
  })
}
```

**Multi-Source RAG:**

```typescript
async function retrieveFromMultipleSources(query, contextFiles) {
  const lawChunks = await retrieveRelevantChunks(query, 5)
  const fileChunks = contextFiles?.length
    ? await retrieveFileChunks(query, contextFiles, 5)
    : []

  return [...lawChunks, ...fileChunks]
}
```

**Reference:** Feature Spec 05 (HR Module - File uploads)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
