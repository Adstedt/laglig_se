# Story 12.7b: Template Item Content Editor & Review Workflow

## Status

Draft

## Story

**As an** admin,
**I want** to review and edit AI-generated compliance summaries and expert commentary per template item,
**so that** I can ensure content quality before publishing a template.

## Acceptance Criteria

1. Template item editor page (accessible from section drill-down in 12.7a): view/edit compliance summary and expert commentary (markdown editor), view content_status badge (STUB → AI_GENERATED → HUMAN_REVIEWED → APPROVED), "Mark as reviewed" action (sets content_status = HUMAN_REVIEWED, reviewed_by, reviewed_at), "Approve" action (sets content_status = APPROVED), bulk actions: "Mark all AI_GENERATED as HUMAN_REVIEWED", "Regenerate selected"
2. Template publish workflow with explicit state machine rules:
   - DRAFT → IN_REVIEW: Requires all items at minimum AI_GENERATED (no STUB items remaining)
   - IN_REVIEW → PUBLISHED: Requires admin approval click. All items at minimum AI_GENERATED. Increments version, sets published_at.
   - PUBLISHED → ARCHIVED: Admin action, soft removal from catalog
   - Item content_status does NOT block publishing — AI_GENERATED is the minimum bar
   - If an item is regenerated after template is PUBLISHED, its content_status resets to AI_GENERATED and a warning badge shows ("1 item re-generated since last publish")
3. Content status dashboard on template detail: progress bar showing STUB / AI_GENERATED / HUMAN_REVIEWED / APPROVED counts

## Tasks / Subtasks

- [ ] **Task 1: Create template item editor page** (AC: 1)
  - [ ] Create `app/admin/(dashboard)/templates/[id]/items/[itemId]/page.tsx`
  - [ ] Display: document title, SFS/AFS number, section assignment, source type
  - [ ] Editable fields: compliance_summary (textarea/markdown), expert_commentary (textarea/markdown)
  - [ ] content_status badge with color coding
  - [ ] Navigation: prev/next item within section
- [ ] **Task 2: Implement review actions** (AC: 1)
  - [ ] "Mark as Reviewed" button → sets `content_status = HUMAN_REVIEWED`, `reviewed_by = admin user ID`, `reviewed_at = now()`
  - [ ] "Approve" button → sets `content_status = APPROVED`
  - [ ] Server actions in `app/actions/admin-templates.ts`:
    - `reviewTemplateItem(itemId)` — mark as reviewed
    - `approveTemplateItem(itemId)` — approve
    - `updateTemplateItemContent(itemId, { compliance_summary, expert_commentary })` — save edits
- [ ] **Task 3: Implement bulk actions** (AC: 1)
  - [ ] "Mark all AI_GENERATED as HUMAN_REVIEWED" — bulk update for template
  - [ ] "Regenerate selected" — mark selected items as STUB, trigger re-generation
  - [ ] Checkbox selection in item list (from 12.7a section drill-down)
  - [ ] Server action: `bulkReviewTemplateItems(templateId)`, `bulkRegenerateTemplateItems(templateId, itemIds)`
- [ ] **Task 4: Implement publish workflow state machine** (AC: 2)
  - [ ] Create `lib/admin/template-workflow.ts` with state transition validation:
    - `canTransitionTo(template, newStatus)` → boolean + reason
    - DRAFT → IN_REVIEW: validate no STUB items remain
    - IN_REVIEW → PUBLISHED: validate no STUB items, increment version, set published_at
    - PUBLISHED → ARCHIVED: always allowed
  - [ ] Publish action buttons on template detail page (from 12.7a)
  - [ ] Warning badge: detect items regenerated after last publish
  - [ ] Server actions: `submitForReview(templateId)`, `publishTemplate(templateId)`, `archiveTemplate(templateId)`
- [ ] **Task 5: Build content status dashboard** (AC: 3)
  - [ ] Create `components/admin/template-content-status.tsx`
  - [ ] Progress bar showing count per status: STUB (red), AI_GENERATED (yellow), HUMAN_REVIEWED (blue), APPROVED (green)
  - [ ] Display on template detail page header area
  - [ ] Query: `GROUP BY content_status WHERE template_id = X`
- [ ] **Task 6: Write tests** (AC: all)
  - [ ] Unit test: state machine validates transitions correctly
  - [ ] Unit test: DRAFT → IN_REVIEW blocked when STUB items exist
  - [ ] Unit test: publish increments version
  - [ ] Component test: content status progress bar renders correctly
  - [ ] Component test: review actions update status
  - [ ] Integration test: full publish workflow from DRAFT → PUBLISHED

## Dev Notes

### Implementation Context (Decision B — FE First with Mock Data)

This story is built **before** templates are seeded. Use mock/stub template data during development and testing. The editor and review workflow should be fully functional with manually created test data. Real AI-generated content will appear once seeding stories are completed after ingestion is fixed.

### State Machine Rules

```
DRAFT ──────────────────► IN_REVIEW ──────────────────► PUBLISHED ──► ARCHIVED
  │ Requires: no STUB items  │ Requires: no STUB items  │
  │                           │ Increments version        │
  │                           │ Sets published_at         │
```

Important: `content_status` on items does NOT block publishing. `AI_GENERATED` is the minimum bar. `HUMAN_REVIEWED` and `APPROVED` are quality aspirations tracked per-item but not enforced for publish.

### Post-Publish Regeneration Warning

If an item's `content_status` is reset to `AI_GENERATED` after the template was last published:
- Compare item's `updated_at` against template's `published_at`
- Show warning badge: "X items re-generated since last publish"

### Admin Auth Pattern

All actions require admin session verification. Follow existing pattern from `app/actions/admin-workspaces.ts`.

### Markdown Editor

Consider using a simple `<textarea>` for MVP. The existing codebase doesn't have a markdown editor component. Alternatively, use a lightweight markdown editor package compatible with shadcn/ui.

### Relevant Source Tree

```
app/admin/(dashboard)/templates/[id]/items/[itemId]/   # New item editor
components/admin/template-content-status.tsx             # New status dashboard
lib/admin/template-workflow.ts                           # New state machine
app/actions/admin-templates.ts                           # Extend with review/publish actions
```

### Testing

- **Test framework:** Vitest 1.4+ with React Testing Library
- **Test location:** `tests/unit/lib/admin/`, `tests/unit/components/admin/`
- **Tests needed:**
  - State machine: valid transitions accepted, invalid rejected
  - DRAFT → IN_REVIEW blocked when any item has content_status = STUB
  - Publish increments version and sets published_at
  - Content status progress bar shows correct proportions
  - Review action correctly updates reviewed_by and reviewed_at
  - Bulk "Mark all as reviewed" updates all AI_GENERATED items

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-08 | 1.1     | Added mock data context per Decision B (FE first, seeding deferred) | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
