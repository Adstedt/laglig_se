# Story 9.1: Legal Comment Generation System

## Status

Approved

## Story

**As a** legal researcher, compliance officer, or user receiving email notifications,
**I want** high-quality, contextual comments for law amendments that explain the change, its purpose, and practical implications,
**so that** I can quickly understand what changed and why without reading the full proposition.

## Acceptance Criteria

### Data Model & Integration

1. New `ParliamentaryDocument` model created with fields:
   - `id` (UUID), `type` (PROPOSITION | COMMITTEE_REPORT | PARLIAMENTARY_DECISION)
   - `designation` (e.g., "2025/26:22"), `riksdagen_id` (e.g., "HD0322")
   - `title`, `summary` (extracted/generated), `organ` (department/committee)
   - `published_date`, `decision_date`
   - `html_url`, `pdf_url`, `text_content` (optional, for betänkanden with semantic HTML)
   - `raw_json` (original API response for future needs)
   - `created_at`, `updated_at`

2. Junction table `SfsParliamentaryReference` linking SFS documents to parliamentary documents:
   - `sfs_document_id`, `parliamentary_document_id`, `reference_type` (PRIMARY | RELATED)

3. New `LegalComment` model for generated comments:
   - `id`, `sfs_document_id` (FK to SfsDocument)
   - `summary_short` (~150 words, for UI cards and emails)
   - `summary_detailed` (~800 words, for accordion/SEO)
   - `key_points` (JSON array of 4-6 bullet points)
   - `affected_companies` (string describing who is affected)
   - `political_notes` (reservations, debates)
   - `generated_at`, `context_sources` (JSON: which prop/bet/rskr used)
   - `generation_model` (e.g., "gpt-4-turbo")
   - `version` (integer, for regeneration tracking)

### Riksdagen API Integration

4. Service `lib/riksdagen/client.ts` created with methods:
   - `fetchDocument(riksdagenId: string)` - Get single document metadata
   - `searchDocuments(query: string, type: 'prop' | 'bet' | 'rskr')` - Search documents
   - `fetchDocumentStatus(riksdagenId: string)` - Get related documents chain
   - `fetchDocumentText(riksdagenId: string, format: 'html' | 'text')` - Get content

5. Service implements rate limiting (max 5 req/sec), retry logic (3 attempts), and caching (24h for metadata)

6. Parser `lib/riksdagen/reference-parser.ts` extracts prop/bet/rskr references from SFS footnotes:
   - Input: "Prop. 2025/26:22, bet. 2025/26:SkU5, rskr. 2025/26:95"
   - Output: `{ proposition: "2025/26:22", committee: "2025/26:SkU5", decision: "2025/26:95" }`

### Comment Generation

7. Comment generator `lib/comments/generate-comment.ts`:
   - Fetches parliamentary documents for an amendment
   - Constructs LLM prompt with proposition summary, committee report, and amendment content
   - Generates both short and detailed comments
   - Stores result in `LegalComment` table

8. LLM prompt includes:
   - Amendment full text (HTML/markdown)
   - Proposition summary (from riksdagen.se page or extracted)
   - Committee report summary (semantic HTML from betänkande)
   - Specific instructions for Swedish legal writing style

9. Generated comments include:
   - **Short version** (~150 words): For UI cards and email notifications
   - **Detailed version** (~800 words): For accordion expansion (SEO-indexable)
   - **Key points**: 4-6 bullet points summarizing changes
   - **Affected companies**: Who needs to act on this
   - **Political notes**: Any reservations or debates

### UI Integration

10. Amendment pages display comment sections:
    - Short summary visible by default in a styled card
    - "Läs mer" accordion expands to show detailed analysis
    - Key points displayed as bullet list
    - Source citations shown (Prop. X, Bet. Y)

11. Comments rendered as semantic HTML (not just text) for SEO crawling

12. Email notification template includes short summary + key points + CTA to full page

### Operational

13. Admin action to regenerate comment for specific amendment

14. Batch script to generate comments for amendments without comments:
    - Prioritizes recent amendments (last 6 months)
    - Rate limits to control OpenAI costs
    - Logs progress and errors

15. Cost tracking: Log token usage per comment generation

## Tasks / Subtasks

### Phase 1: Data Model & Riksdagen Integration (AC: 1-6)

- [ ] **Task 1.1: Create database models** (AC: 1, 2, 3)
  - [ ] Add `ParliamentaryDocument` model to Prisma schema
  - [ ] Add `ParliamentaryDocumentType` enum (PROPOSITION, COMMITTEE_REPORT, PARLIAMENTARY_DECISION)
  - [ ] Add `SfsParliamentaryReference` junction table
  - [ ] Add `LegalComment` model with all fields
  - [ ] Create and run migration
  - [ ] Generate Prisma client types

- [ ] **Task 1.2: Build Riksdagen API client** (AC: 4, 5)
  - [ ] Create `lib/riksdagen/client.ts` with typed methods
  - [ ] Create Zod schemas for API responses (`lib/riksdagen/schemas.ts`)
  - [ ] Implement rate limiting using `p-limit` (max 5 req/sec)
  - [ ] Add retry logic with exponential backoff (3 attempts)
  - [ ] Add response caching with Upstash Redis (24h TTL for metadata)
  - [ ] Write unit tests with MSW mocks

- [ ] **Task 1.3: Build reference parser** (AC: 6)
  - [ ] Create `lib/riksdagen/reference-parser.ts`
  - [ ] Parse "Prop. YYYY/YY:NN" format (handle both 4-digit and 2-digit years)
  - [ ] Parse "bet. YYYY/YY:XXN" format (committee codes: SkU, FiU, JuU, etc.)
  - [ ] Parse "rskr. YYYY/YY:NN" format
  - [ ] Handle edge cases: missing references, malformed text, multiple formats
  - [ ] Write comprehensive unit tests with real examples from SFS footnotes

### Phase 2: Comment Generation (AC: 7-9)

- [ ] **Task 2.1: Create comment generation service** (AC: 7)
  - [ ] Create `lib/comments/generate-comment.ts`
  - [ ] Build context fetching: fetch prop + bet for an amendment
  - [ ] Extract proposition summary from riksdagen.se page (not PDF)
  - [ ] Extract betänkande summary from semantic HTML (CSS classes .Avsnittsrubrik, .R1, etc.)
  - [ ] Combine with amendment HTML content

- [ ] **Task 2.2: Design and test LLM prompts** (AC: 8, 9)
  - [ ] Create `lib/comments/prompts/legal-comment-prompt.ts`
  - [ ] Design prompt for short summary (~150 words, Swedish)
  - [ ] Design prompt for detailed analysis (~800 words, structured)
  - [ ] Design prompt for key points extraction (4-6 bullets)
  - [ ] Test with 5 sample amendments from test-results/pdf-batch-comparison/
  - [ ] Iterate on prompt based on output quality
  - [ ] Document token usage per section

- [ ] **Task 2.3: Implement comment storage** (AC: 3, 7)
  - [ ] Save generated comments to `LegalComment` table
  - [ ] Track generation metadata: model, tokens, sources, timestamp
  - [ ] Handle regeneration: increment version, optionally keep history
  - [ ] Add unique constraint on sfs_document_id (one comment per amendment)

### Phase 3: UI Integration (AC: 10-12)

- [ ] **Task 3.1: Create comment display components** (AC: 10, 11)
  - [ ] Create `components/features/comments/CommentCard.tsx` - short summary card
  - [ ] Create `components/features/comments/CommentAccordion.tsx` - expandable detailed view
  - [ ] Create `components/features/comments/KeyPointsList.tsx` - bullet points
  - [ ] Create `components/features/comments/SourceCitations.tsx` - prop/bet links
  - [ ] Style with Tailwind, use shadcn/ui Accordion and Card components
  - [ ] Ensure semantic HTML for SEO (use proper heading hierarchy)

- [ ] **Task 3.2: Integrate into amendment pages** (AC: 10)
  - [ ] Update `app/(public)/lagar/andringar/[id]/page.tsx`
  - [ ] Update `app/(workspace)/browse/lagar/andringar/[id]/page.tsx`
  - [ ] Fetch comment data in server component (getAmendmentComment)
  - [ ] Handle case where comment doesn't exist yet (show placeholder or nothing)
  - [ ] Add loading state with Suspense

- [ ] **Task 3.3: Email notification template** (AC: 12)
  - [ ] Create `emails/AmendmentNotification.tsx` using React Email
  - [ ] Include: short summary, key points (max 4), CTA button to full page
  - [ ] Style consistent with existing email templates
  - [ ] Test rendering in major email clients

### Phase 4: Operational Tools (AC: 13-15)

- [ ] **Task 4.1: Admin regeneration action** (AC: 13)
  - [ ] Create Server Action `regenerateComment(sfsDocumentId: string)`
  - [ ] Add permission check (admin only)
  - [ ] Return new comment or error

- [ ] **Task 4.2: Batch generation script** (AC: 14)
  - [ ] Create `scripts/generate-missing-comments.ts`
  - [ ] Query amendments without comments, ordered by publication_date DESC
  - [ ] Filter to only lagar (not förordningar - they have no propositions)
  - [ ] Process with configurable batch size (default 10) and delay (default 2s)
  - [ ] Log progress: "Generated 45/120 comments..."
  - [ ] Log errors to console and optionally Sentry
  - [ ] Support --dry-run flag for testing

- [ ] **Task 4.3: Cost tracking** (AC: 15)
  - [ ] Log OpenAI token usage per generation (input + output tokens)
  - [ ] Calculate estimated cost per comment
  - [ ] Store in LegalComment.metadata or separate analytics table
  - [ ] Output summary at end of batch run

## Dev Notes

### Previous Story Context
- Story 2.29 established amendment page routing (`/lagar/andringar/[id]`) and display infrastructure
- Story 2.28 created `AmendmentDocument` model with `htmlContent` and `markdownContent` fields
- Amendment HTML content is already LLM-parsed from PDFs and available for use

### Story 2.29 Pre-work Complete
Story 2.29 Phase 2 added legislative reference extraction to `LegalDocument.json_content`:

**Extraction already implemented in `lib/transforms/html-to-json.ts`:**
- `LegislativeReference` interface with types: `prop | bet | rskr | sou | ds`
- `extractLegislativeReferences()` function parses footnote content
- `legislativeReferences` field aggregates all refs from footnotes
- Example output:
```json
{
  "legislativeReferences": [
    { "type": "prop", "reference": "Prop. 2024/25:63", "year": "2024/25", "number": "63" },
    { "type": "bet", "reference": "bet. 2024/25:SoU25", "year": "2024/25", "number": "SoU25" },
    { "type": "rskr", "reference": "rskr. 2024/25:126", "year": "2024/25", "number": "126" }
  ]
}
```

**Data availability after 2.29 completion:**
- ~15,231 lagar (44% of amendments) will have prop/bet/rskr refs
- ~19,259 förordningar (56%) have no parliamentary refs (expected)
- Refs stored in `legal_documents.json_content.legislativeReferences`

### Riksdag API Query Formats (Verified)

| Type | Query Parameters | doc_id | Reference |
|------|-----------------|--------|-----------|
| **Prop** | `doktyp=prop&rm=2024/25&nr=63` | HC0363 | 2024/25:63 |
| **Bet** | `doktyp=bet&rm=2024/25&bet=SoU25` | HC01SoU25 | 2024/25:SoU25 |
| **Rskr** | `doktyp=rskr&rm=2024/25&nr=126` | HC0K126 | 2024/25:126 |

**Base URL:** `https://data.riksdagen.se/dokumentlista/?doktyp={type}&rm={year}&nr={num}&utformat=json`

### Backfill & Ongoing Sync Strategy

**Phase 0 (prerequisite from 2.29):**
1. Complete LLM batch processing of all 34k amendments
2. All `json_content.legislativeReferences` populated

**Phase 1 (backfill):**
1. Query all `LegalDocument` where `content_type = 'SFS_AMENDMENT'` and `json_content.legislativeReferences` is not empty
2. Extract unique prop/bet/rskr references across all documents
3. Batch fetch from Riksdag API (with rate limiting)
4. Insert into `ParliamentaryDocument` table
5. Create `LegalDocumentSource` junction records

**Phase 2 (ongoing):**
1. When sync-sfs-updates cron processes new amendments:
   - Parse `json_content.legislativeReferences`
   - Check if parliamentary docs exist in DB
   - Fetch missing ones from Riksdag API
   - Create junction records

### Data Models
[Source: prisma/schema.prisma]

**Existing models to reference:**
- `SfsDocument`: `id`, `sfsNumber`, `title`, `documentType` (BASE_LAW | AMENDMENT | ORDINANCE)
- `AmendmentDocument`: `htmlContent`, `markdownContent`, `affectedSections`, `sourceLawId`
- `LegalDocument`: Polymorphic model for all legal content types

**New models to create:**
```prisma
enum ParliamentaryDocumentType {
  PROPOSITION
  COMMITTEE_REPORT
  PARLIAMENTARY_DECISION
}

model ParliamentaryDocument {
  id             String                    @id @default(uuid())
  type           ParliamentaryDocumentType
  designation    String                    // "2025/26:22"
  riksdagen_id   String                    @unique // "HD0322"
  title          String
  summary        String?                   @db.Text
  organ          String?                   // "Finansdepartementet" or "Skatteutskottet"
  published_date DateTime?
  decision_date  DateTime?
  html_url       String?
  pdf_url        String?
  text_content   String?                   @db.Text // For betänkanden with good HTML
  raw_json       Json?
  created_at     DateTime                  @default(now())
  updated_at     DateTime                  @updatedAt

  sfs_references SfsParliamentaryReference[]

  @@index([designation])
  @@index([type])
  @@map("parliamentary_documents")
}

model SfsParliamentaryReference {
  id                        String                @id @default(uuid())
  sfs_document_id           String
  parliamentary_document_id String
  reference_type            String                @default("PRIMARY") // PRIMARY or RELATED

  sfs_document              SfsDocument           @relation(fields: [sfs_document_id], references: [id])
  parliamentary_document    ParliamentaryDocument @relation(fields: [parliamentary_document_id], references: [id])

  @@unique([sfs_document_id, parliamentary_document_id])
  @@map("sfs_parliamentary_references")
}

model LegalComment {
  id                String   @id @default(uuid())
  sfs_document_id   String   @unique
  summary_short     String   @db.Text // ~150 words
  summary_detailed  String   @db.Text // ~800 words
  key_points        Json     // ["Point 1", "Point 2", ...]
  affected_companies String?
  political_notes   String?  @db.Text
  context_sources   Json     // { proposition: "2025/26:22", committee: "2025/26:SkU5" }
  generation_model  String   // "gpt-4-turbo"
  version           Int      @default(1)
  generated_at      DateTime @default(now())
  metadata          Json?    // Token counts, costs, etc.

  sfs_document      SfsDocument @relation(fields: [sfs_document_id], references: [id])

  @@map("legal_comments")
}
```

### API Specifications
[Source: Riksdagen Open Data - data.riksdagen.se]

**Endpoints:**
| Endpoint | Purpose | Example |
|----------|---------|---------|
| `/dokumentlista/?doktyp=prop&sok=X` | Search propositions | `&rm=2025/26&sz=20` |
| `/dokument/{id}.json` | Get document metadata | `/dokument/HD0322.json` |
| `/dokument/{id}.html` | Get HTML content | `/dokument/HD0322.html` |
| `/dokumentstatus/{id}.json` | Get related documents | Links to bet, rskr |

**Response structure (proposition):**
```json
{
  "dokumentstatus": {
    "dokument": {
      "dok_id": "HD0322",
      "rm": "2025/26",
      "beteckning": "22",
      "typ": "prop",
      "titel": "Ytterligare kompletteringar till bestämmelserna om tilläggsskatt",
      "organ": "Finansdepartementet",
      "publicerad": "2025-10-14"
    }
  }
}
```

**HTML Quality Notes:**
- **Propositions:** PDF-converted HTML with absolute positioning - NOT semantic, extract summary from riksdagen.se webpage instead
- **Betänkanden:** Word-generated semantic HTML with CSS classes:
  - `.Avsnittsrubrik` - Section headings
  - `.R1`, `.R2`, `.R3` - Heading levels
  - `.Frslagstext` - Proposal text
  - Good for parsing and extracting summaries

**Riksdagen ID Format:**
- Format: `{rm_code}{document_number}` where rm_code = riksmöte code
- 2025/26 → "HD", 2024/25 → "HC", 2023/24 → "HA"
- Example: Prop. 2025/26:22 → `HD0322`

### Component Specifications
[Source: docs/architecture/5-components.md]

- Use `shadcn/ui` Accordion for expandable detailed comment
- Use `shadcn/ui` Card for summary display
- Use `shadcn/ui` Badge for source citations (Prop., Bet., Rskr.)
- Follow existing design system colors and spacing

### File Locations
[Source: docs/architecture/12-unified-project-structure.md]

```
lib/
├── riksdagen/
│   ├── client.ts           # API client with rate limiting
│   ├── schemas.ts          # Zod schemas for API responses
│   └── reference-parser.ts # Parse prop/bet/rskr from footnotes
├── comments/
│   ├── generate-comment.ts # Main generation service
│   └── prompts/
│       └── legal-comment-prompt.ts
components/
└── features/
    └── comments/
        ├── CommentCard.tsx
        ├── CommentAccordion.tsx
        ├── KeyPointsList.tsx
        └── SourceCitations.tsx
emails/
└── AmendmentNotification.tsx
scripts/
└── generate-missing-comments.ts
```

### Environment Variables
[Source: docs/architecture/3-tech-stack.md]

| Variable | Purpose | Required |
|----------|---------|----------|
| `OPENAI_API_KEY` | LLM comment generation | Yes |
| `UPSTASH_REDIS_REST_URL` | Caching Riksdagen responses | Yes |
| `UPSTASH_REDIS_REST_TOKEN` | Redis authentication | Yes |
| `DATABASE_URL` | Prisma database connection | Yes (existing) |

### Error Handling & Graceful Degradation

**Riksdagen API failures:**
- Retry 3 times with exponential backoff (1s, 2s, 4s)
- If still failing, log error and skip document (don't block batch)
- Cache successful responses for 24h to reduce API dependency

**Missing parliamentary documents:**
- Some older amendments may lack proposition references in footnotes
- If prop/bet/rskr cannot be parsed: generate comment with amendment content only
- Mark comment as `context_sources: { partial: true }` for later enrichment

**OpenAI API failures:**
- Retry 2 times with 5s delay
- If failing, skip and continue batch (log for manual review)
- Don't store partial/failed comments

**UI graceful degradation:**
- If `LegalComment` doesn't exist for an amendment: show amendment without comment section
- Don't show empty/broken UI - simply omit the comment card

### Testing Requirements
[Source: docs/architecture/13-testing-strategy.md]

**Unit tests (Vitest):**
- `lib/riksdagen/client.test.ts` - Mock API responses with MSW
- `lib/riksdagen/reference-parser.test.ts` - Test all regex patterns
- `lib/comments/generate-comment.test.ts` - Mock OpenAI responses

**Test file location:** Co-located with source files or in `__tests__/` subdirectory

**Test patterns:**
```typescript
import { describe, it, expect, vi } from 'vitest'
import { parseParliamentaryReferences } from './reference-parser'

describe('parseParliamentaryReferences', () => {
  it('parses standard prop/bet/rskr format', () => {
    const input = 'Prop. 2025/26:22, bet. 2025/26:SkU5, rskr. 2025/26:95'
    const result = parseParliamentaryReferences(input)
    expect(result).toEqual({
      proposition: '2025/26:22',
      committee: '2025/26:SkU5',
      decision: '2025/26:95'
    })
  })
})
```

**E2E test (Playwright):**
- Test amendment page displays comment when available
- Test accordion expands/collapses
- Test source citation links work

### Technical Constraints

- **Rate limit Riksdagen API:** max 5 req/sec (conservative, no official limit published)
- **OpenAI cost:** ~$0.05-0.10 per comment (estimate: 2-3K input tokens, 1K output tokens)
- **Cache Riksdagen responses:** 24h TTL for metadata (rarely changes)
- **Only lagar have propositions:** Förordningar (~60% of SFS) have no parliamentary process - skip them
- **Comment structure:**
  - Short: ~150 words, scannable, for UI cards and email
  - Detailed: ~800 words, structured sections, for accordion/SEO

### Cost Estimation
- ~4,700 lagar (laws) in database (2018-2025)
- Average ~3 amendments per law = ~14,000 amendments needing comments
- At $0.08/comment = ~$1,120 one-time cost for full backfill
- Ongoing: ~500 new amendments/year = ~$40/year

### Reference: Sample Generated Comment Structure

**Short version (UI card + email):**
```markdown
SFS 2025:1461 kompletterar tilläggsskattelagen med nya regler för hur
skatter ska fördelas mellan koncernenheter. Ändringarna anpassar svensk
lag till OECD:s senaste riktlinjer för global minimibeskattning.

**Viktigaste nyheterna:**
- 21 nya paragrafer om skattefördelning vid CFC-beskattning
- Ny definition av "hybridenhet"
- Ikraftträdande: 1 januari 2026

**Berörda:** Multinationella koncerner med omsättning >750 MEUR
```

**Detailed version (accordion/SEO):** 800 words with sections:
- Bakgrund och internationell kontext
- Centrala ändringar i detalj
- Riksdagsbehandling
- Praktisk vägledning
- Rättskällor

## Testing

### Unit Tests
- [ ] `lib/riksdagen/client.test.ts` - API client with mocked responses
- [ ] `lib/riksdagen/reference-parser.test.ts` - All regex patterns and edge cases
- [ ] `lib/comments/generate-comment.test.ts` - Generation flow with mocked OpenAI

### Integration Tests
- [ ] Full flow: parse references → fetch docs → generate comment → store
- [ ] Test with real amendment data from database

### E2E Tests
- [ ] Amendment page displays comment card
- [ ] Accordion expands to show detailed view
- [ ] Source citation links navigate correctly
- [ ] Mobile responsive layout

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 0.1 | Initial draft created from discussion | Bob (SM) |
| 2025-01-05 | 0.2 | Added Environment Variables and Error Handling sections per checklist review | Bob (SM) |
| 2025-01-05 | 1.0 | PO validation passed (9/10), status changed to Approved | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*To be filled after QA review*
