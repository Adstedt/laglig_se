# Story 6.8: Add Bulk Actions to Kanban

## Status

Draft

## Story

**As a** user,
**I want** to perform bulk actions on multiple laws,
**so that** I update many laws at once.

## Acceptance Criteria

1. Checkbox on each law card
2. "Select All" checkbox in column header
3. Bulk actions toolbar appears when â‰¥1 card selected
4. Actions available:
   - Move to column (dropdown)
   - Set priority (dropdown)
   - Assign to employee (dropdown)
   - Add tag (input)
   - Delete from list (confirmation)
5. Bulk action applied to all selected cards
6. Success toast: "5 laws moved to In Progress"
7. Deselect all after action completes

## Tasks / Subtasks

- [ ] Add checkbox to law cards
- [ ] Add "Select All" checkbox to column headers
- [ ] Create bulk actions toolbar component
- [ ] Implement bulk move to column action
- [ ] Implement bulk set priority action
- [ ] Implement bulk assign employee action
- [ ] Implement bulk add tag action
- [ ] Implement bulk delete action with confirmation
- [ ] Create bulk update API endpoint
- [ ] Add success toast notifications
- [ ] Deselect all cards after action completes
- [ ] Test bulk actions with various selections

## Dev Notes

**Law Card with Checkbox:**

```typescript
// components/kanban/law-card.tsx (updated)
'use client'

interface LawCardProps {
  law: any
  isSelected: boolean
  onToggleSelect: (lawId: string) => void
  isDragging?: boolean
}

export function LawCard({ law, isSelected, onToggleSelect, isDragging = false }: LawCardProps) {
  // ... existing drag logic ...

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...dragProps}
      className={`bg-white rounded-lg border-2 p-4 transition-all relative ${
        isSelected
          ? 'border-blue-500 ring-2 ring-blue-200'
          : 'border-gray-200 hover:border-blue-300'
      }`}
    >
      {/* Selection Checkbox */}
      <div className="absolute top-2 left-2 z-10">
        <input
          type="checkbox"
          checked={isSelected}
          onChange={(e) => {
            e.stopPropagation()
            onToggleSelect(law.id)
          }}
          className="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer"
          onClick={(e) => e.stopPropagation()}
        />
      </div>

      {/* Rest of card content with left padding for checkbox */}
      <div className="pl-6">
        {/* ... existing card content ... */}
      </div>
    </div>
  )
}
```

**Column with Select All:**

```typescript
// components/kanban/kanban-column.tsx (updated)
interface KanbanColumnProps {
  id: string
  label: string
  color: string
  laws: any[]
  selectedLawIds: Set<string>
  onToggleSelect: (lawId: string) => void
  onToggleSelectAll: (columnId: string) => void
}

export function KanbanColumn({
  id,
  label,
  color,
  laws,
  selectedLawIds,
  onToggleSelect,
  onToggleSelectAll
}: KanbanColumnProps) {
  const allSelected = laws.length > 0 && laws.every((law) => selectedLawIds.has(law.id))
  const someSelected = laws.some((law) => selectedLawIds.has(law.id)) && !allSelected

  return (
    <div className="flex flex-col w-80 bg-gray-100 rounded-lg flex-shrink-0">
      {/* Column Header */}
      <div className="p-4 border-b border-gray-200">
        <div className="flex items-center justify-between mb-2">
          {/* Select All Checkbox */}
          <div className="flex items-center gap-2">
            {laws.length > 0 && (
              <input
                type="checkbox"
                checked={allSelected}
                ref={(input) => {
                  if (input) input.indeterminate = someSelected
                }}
                onChange={() => onToggleSelectAll(id)}
                className="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer"
              />
            )}
            <h2 className="font-semibold text-gray-900">{label}</h2>
          </div>
          <span className={`px-2 py-1 text-sm font-medium rounded bg-${color}-100 text-${color}-700`}>
            {laws.length}
          </span>
        </div>
        <AddLawButton columnId={id} />
      </div>

      {/* Column Body */}
      <div className="flex-1 p-3 space-y-3 overflow-y-auto">
        {laws.length === 0 ? (
          <EmptyColumn />
        ) : (
          laws.map((law) => (
            <LawCard
              key={law.id}
              law={law}
              isSelected={selectedLawIds.has(law.id)}
              onToggleSelect={onToggleSelect}
            />
          ))
        )}
      </div>
    </div>
  )
}
```

**Bulk Actions Toolbar:**

```typescript
// components/kanban/bulk-actions-toolbar.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface BulkActionsToolbarProps {
  selectedCount: number
  selectedLawIds: string[]
  onClearSelection: () => void
}

export function BulkActionsToolbar({
  selectedCount,
  selectedLawIds,
  onClearSelection
}: BulkActionsToolbarProps) {
  const router = useRouter()
  const [isProcessing, setIsProcessing] = useState(false)

  async function handleBulkAction(action: string, value?: string) {
    setIsProcessing(true)
    try {
      const response = await fetch('/api/workspace-laws/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          lawIds: selectedLawIds,
          action,
          value
        })
      })

      if (response.ok) {
        showToast(`${selectedCount} laws updated successfully`)
        onClearSelection()
        router.refresh()
      } else {
        alert('Failed to update laws')
      }
    } catch (error) {
      alert('Failed to update laws')
    } finally {
      setIsProcessing(false)
    }
  }

  async function handleBulkDelete() {
    if (
      !confirm(
        `Are you sure you want to remove ${selectedCount} law${
          selectedCount > 1 ? 's' : ''
        } from your workspace?`
      )
    ) {
      return
    }

    setIsProcessing(true)
    try {
      const response = await fetch('/api/workspace-laws/bulk', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lawIds: selectedLawIds })
      })

      if (response.ok) {
        showToast(`${selectedCount} laws removed from workspace`)
        onClearSelection()
        router.refresh()
      } else {
        alert('Failed to delete laws')
      }
    } catch (error) {
      alert('Failed to delete laws')
    } finally {
      setIsProcessing(false)
    }
  }

  if (selectedCount === 0) return null

  return (
    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
      <div className="bg-white border border-gray-300 rounded-lg shadow-xl p-4 flex items-center gap-4 min-w-[600px]">
        {/* Selection Count */}
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
            {selectedCount}
          </div>
          <span className="text-sm font-medium text-gray-900">
            {selectedCount} law{selectedCount > 1 ? 's' : ''} selected
          </span>
        </div>

        <div className="h-6 w-px bg-gray-300"></div>

        {/* Actions */}
        <div className="flex items-center gap-2">
          {/* Move to Column */}
          <BulkActionDropdown
            label="Move to"
            icon={<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>}
            options={[
              { value: 'not_started', label: 'Not Started' },
              { value: 'in_progress', label: 'In Progress' },
              { value: 'blocked', label: 'Blocked' },
              { value: 'review', label: 'Review' },
              { value: 'compliant', label: 'Compliant' }
            ]}
            onSelect={(value) => handleBulkAction('move_to_column', value)}
            disabled={isProcessing}
          />

          {/* Set Priority */}
          <BulkActionDropdown
            label="Priority"
            icon={<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 11l5-5m0 0l5 5m-5-5v12" /></svg>}
            options={[
              { value: 'high', label: 'High' },
              { value: 'medium', label: 'Medium' },
              { value: 'low', label: 'Low' }
            ]}
            onSelect={(value) => handleBulkAction('set_priority', value)}
            disabled={isProcessing}
          />

          {/* Assign Employee (simplified for now) */}
          <button
            onClick={() => {
              const employeeId = prompt('Enter employee ID to assign:')
              if (employeeId) {
                handleBulkAction('assign_employee', employeeId)
              }
            }}
            disabled={isProcessing}
            className="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 flex items-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            Assign
          </button>

          {/* Add Tag */}
          <button
            onClick={() => {
              const tag = prompt('Enter tag to add:')
              if (tag) {
                handleBulkAction('add_tag', tag)
              }
            }}
            disabled={isProcessing}
            className="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 flex items-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
            Tag
          </button>

          {/* Delete */}
          <button
            onClick={handleBulkDelete}
            disabled={isProcessing}
            className="px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 flex items-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
          </button>
        </div>

        <div className="h-6 w-px bg-gray-300"></div>

        {/* Clear Selection */}
        <button
          onClick={onClearSelection}
          disabled={isProcessing}
          className="text-sm text-gray-600 hover:text-gray-900 disabled:opacity-50"
        >
          Clear
        </button>
      </div>
    </div>
  )
}
```

**Bulk Action Dropdown Component:**

```typescript
// components/kanban/bulk-action-dropdown.tsx
'use client'

import { useState, useRef, useEffect } from 'react'

interface BulkActionDropdownProps {
  label: string
  icon: React.ReactNode
  options: { value: string; label: string }[]
  onSelect: (value: string) => void
  disabled: boolean
}

export function BulkActionDropdown({
  label,
  icon,
  options,
  onSelect,
  disabled
}: BulkActionDropdownProps) {
  const [isOpen, setIsOpen] = useState(false)
  const dropdownRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  function handleSelect(value: string) {
    onSelect(value)
    setIsOpen(false)
  }

  return (
    <div ref={dropdownRef} className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        disabled={disabled}
        className="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 flex items-center gap-2"
      >
        {icon}
        {label}
        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute bottom-full mb-2 w-40 bg-white border border-gray-300 rounded-lg shadow-lg z-10">
          {options.map((option) => (
            <button
              key={option.value}
              onClick={() => handleSelect(option.value)}
              className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg"
            >
              {option.label}
            </button>
          ))}
        </div>
      )}
    </div>
  )
}
```

**Kanban Board with Selection State:**

```typescript
// components/kanban/kanban-board-client.tsx (updated)
'use client'

import { useState } from 'react'
import { BulkActionsToolbar } from './bulk-actions-toolbar'

export function KanbanBoardClient({ initialLawsByStatus }: any) {
  const [selectedLawIds, setSelectedLawIds] = useState<Set<string>>(new Set())

  function toggleSelect(lawId: string) {
    const newSelected = new Set(selectedLawIds)
    if (newSelected.has(lawId)) {
      newSelected.delete(lawId)
    } else {
      newSelected.add(lawId)
    }
    setSelectedLawIds(newSelected)
  }

  function toggleSelectAll(columnId: string) {
    const columnLaws = lawsByStatus[columnId] || []
    const allSelected = columnLaws.every((law: any) => selectedLawIds.has(law.id))

    const newSelected = new Set(selectedLawIds)
    if (allSelected) {
      // Deselect all in column
      columnLaws.forEach((law: any) => newSelected.delete(law.id))
    } else {
      // Select all in column
      columnLaws.forEach((law: any) => newSelected.add(law.id))
    }
    setSelectedLawIds(newSelected)
  }

  function clearSelection() {
    setSelectedLawIds(new Set())
  }

  return (
    <>
      {/* Kanban board with selection props passed to columns and cards */}
      <div className="h-full p-6 overflow-x-auto">
        {/* ... render columns with selection props ... */}
      </div>

      {/* Bulk Actions Toolbar */}
      <BulkActionsToolbar
        selectedCount={selectedLawIds.size}
        selectedLawIds={Array.from(selectedLawIds)}
        onClearSelection={clearSelection}
      />
    </>
  )
}
```

**Bulk Actions API:**

```typescript
// app/api/workspace-laws/bulk/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_LAWS)

    const { lawIds, action, value } = await request.json()

    // Verify all laws belong to workspace
    const count = await prisma.workspaceLaw.count({
      where: {
        id: { in: lawIds },
        workspaceId,
      },
    })

    if (count !== lawIds.length) {
      return NextResponse.json(
        { error: 'Invalid law selection' },
        { status: 400 }
      )
    }

    // Perform bulk action
    switch (action) {
      case 'move_to_column':
        await prisma.workspaceLaw.updateMany({
          where: { id: { in: lawIds } },
          data: { status: value },
        })
        break

      case 'set_priority':
        await prisma.workspaceLaw.updateMany({
          where: { id: { in: lawIds } },
          data: { priority: value },
        })
        break

      case 'assign_employee':
        // Delete existing assignments
        await prisma.workspaceLawEmployee.deleteMany({
          where: { workspaceLawId: { in: lawIds } },
        })
        // Create new assignments
        await prisma.workspaceLawEmployee.createMany({
          data: lawIds.map((lawId: string) => ({
            workspaceLawId: lawId,
            employeeId: value,
          })),
        })
        break

      case 'add_tag':
        // Add tag to each law (append to existing tags)
        for (const lawId of lawIds) {
          const law = await prisma.workspaceLaw.findUnique({
            where: { id: lawId },
            select: { tags: true },
          })
          if (law) {
            const existingTags = law.tags || []
            if (!existingTags.includes(value)) {
              await prisma.workspaceLaw.update({
                where: { id: lawId },
                data: { tags: [...existingTags, value] },
              })
            }
          }
        }
        break

      default:
        return NextResponse.json({ error: 'Invalid action' }, { status: 400 })
    }

    // Log activity
    await logActivity({
      workspaceId,
      userId,
      action: ActivityAction.LAW_STATUS_CHANGED,
      resourceType: 'bulk_laws',
      metadata: {
        lawCount: lawIds.length,
        bulkAction: action,
        value,
      },
    })

    return NextResponse.json({ success: true })
  })
}

export async function DELETE(request: Request) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_LAWS)

    const { lawIds } = await request.json()

    // Delete laws from workspace
    await prisma.workspaceLaw.deleteMany({
      where: {
        id: { in: lawIds },
        workspaceId,
      },
    })

    // Log activity
    await logActivity({
      workspaceId,
      userId,
      action: ActivityAction.LAW_REMOVED,
      resourceType: 'bulk_laws',
      metadata: {
        lawCount: lawIds.length,
      },
    })

    return NextResponse.json({ success: true })
  })
}
```

**Toast Notification Helper:**

```typescript
// lib/toast.ts
export function showToast(message: string) {
  // Simple implementation - can be replaced with library like react-hot-toast
  const toast = document.createElement('div')
  toast.className =
    'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in'
  toast.textContent = message

  document.body.appendChild(toast)

  setTimeout(() => {
    toast.classList.add('animate-slide-out')
    setTimeout(() => toast.remove(), 300)
  }, 3000)
}
```

**Reference:** PRD Epic 6 Story 6.8, Architecture Section 14 (Compliance Workspace)

## Testing

**Unit Tests:**

- Select single law, verify checkbox checked
- Select all laws in column, verify all checked
- Bulk move to column, verify all laws moved
- Bulk set priority, verify all priorities updated
- Bulk delete, verify all laws removed

**Integration Tests:**

- Select 5 laws, move to "In Progress", verify all moved in database
- Select laws across multiple columns, apply bulk action, verify all updated
- Delete selected laws, verify removed from workspace
- Add tag to 10 laws, verify tag added to all

**Manual Testing:**

- Select laws with checkboxes, verify selection state
- Click "Select All" in column, verify all selected
- Apply bulk action, verify success toast appears
- Verify selection cleared after action completes
- Test each bulk action (move, priority, assign, tag, delete)

**Performance Testing:**

- Bulk action on 50 laws completes <1 second
- Selection state updates without lag

**Accessibility Testing:**

- Checkboxes accessible via keyboard (Tab, Space)
- Bulk actions toolbar accessible via keyboard
- Screen reader announces selection count
- Focus visible on all controls

**Test File:** `__tests__/features/kanban/bulk-actions.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Select laws to apply bulk actions
- Choose appropriate bulk action
- Confirm bulk delete operations

**Developer Responsibility:**

- Implement selection state management
- Persist bulk actions to database
- Show success feedback (toast)
- Validate all laws belong to workspace before bulk action
- Clear selection after action completes
- Log bulk actions for audit trail

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
