# Story 6.9: Implement Global Search (Cmd+K)

## Status

Draft

## Story

**As a** user,
**I want** to search across laws, tasks, employees, and comments,
**so that** I quickly find anything in my workspace.

## Acceptance Criteria

1. Keyboard shortcut `/` or `Cmd+K` (Mac) or `Ctrl+K` (Windows) opens search modal
2. Search input with autofocus
3. As user types, results appear instantly
4. Results grouped by type: Laws (5), Tasks (3), Employees (2), Comments (1)
5. Each result shows: title, snippet, breadcrumb (where it's from)
6. Arrow keys navigate results, Enter opens selected result
7. Search uses full-text search on database or client-side search
8. Recent searches shown when input empty
9. ESC closes modal

## Tasks / Subtasks

- [ ] Create global search modal component
- [ ] Implement keyboard shortcuts (/, Cmd+K, Ctrl+K)
- [ ] Add search input with autofocus
- [ ] Implement search API endpoint
- [ ] Group results by type (laws, tasks, employees, comments)
- [ ] Add keyboard navigation (Arrow keys, Enter)
- [ ] Store and display recent searches
- [ ] Implement ESC key to close modal
- [ ] Add result snippets and breadcrumbs
- [ ] Test search across all resource types

## Dev Notes

**Global Search Modal:**

```typescript
// components/search/global-search-modal.tsx
'use client'

import { useState, useEffect, useRef } from 'react'
import { useRouter } from 'next/navigation'
import { useDebounce } from '@/hooks/use-debounce'

export function GlobalSearchModal({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) {
  const router = useRouter()
  const [query, setQuery] = useState('')
  const [results, setResults] = useState<any>({
    laws: [],
    tasks: [],
    employees: [],
    comments: []
  })
  const [selectedIndex, setSelectedIndex] = useState(0)
  const [isLoading, setIsLoading] = useState(false)
  const inputRef = useRef<HTMLInputElement>(null)

  const debouncedQuery = useDebounce(query, 300)

  useEffect(() => {
    if (isOpen) {
      inputRef.current?.focus()
      loadRecentSearches()
    }
  }, [isOpen])

  useEffect(() => {
    if (debouncedQuery) {
      performSearch(debouncedQuery)
    } else {
      loadRecentSearches()
    }
  }, [debouncedQuery])

  async function performSearch(searchQuery: string) {
    setIsLoading(true)
    try {
      const response = await fetch(`/api/search?q=${encodeURIComponent(searchQuery)}`)
      const data = await response.json()
      setResults(data.results)
      setSelectedIndex(0)
    } catch (error) {
      console.error('Search failed:', error)
    } finally {
      setIsLoading(false)
    }
  }

  function loadRecentSearches() {
    const recent = localStorage.getItem('recent_searches')
    if (recent) {
      const searches = JSON.parse(recent)
      // Show recent searches as "Laws" results for now
      setResults({
        laws: searches.map((s: string, i: number) => ({
          id: `recent_${i}`,
          title: s,
          type: 'recent',
          snippet: 'Recent search'
        })),
        tasks: [],
        employees: [],
        comments: []
      })
    }
  }

  function saveRecentSearch(searchQuery: string) {
    const recent = localStorage.getItem('recent_searches')
    const searches = recent ? JSON.parse(recent) : []
    const updated = [searchQuery, ...searches.filter((s: string) => s !== searchQuery)].slice(0, 10)
    localStorage.setItem('recent_searches', JSON.stringify(updated))
  }

  function handleKeyDown(e: React.KeyboardEvent) {
    const totalResults = [
      ...results.laws,
      ...results.tasks,
      ...results.employees,
      ...results.comments
    ].length

    if (e.key === 'ArrowDown') {
      e.preventDefault()
      setSelectedIndex((prev) => (prev + 1) % totalResults)
    } else if (e.key === 'ArrowUp') {
      e.preventDefault()
      setSelectedIndex((prev) => (prev - 1 + totalResults) % totalResults)
    } else if (e.key === 'Enter') {
      e.preventDefault()
      handleSelectResult(selectedIndex)
    } else if (e.key === 'Escape') {
      e.preventDefault()
      onClose()
    }
  }

  function handleSelectResult(index: number) {
    const allResults = [
      ...results.laws,
      ...results.tasks,
      ...results.employees,
      ...results.comments
    ]
    const result = allResults[index]

    if (!result) return

    if (result.type === 'recent') {
      setQuery(result.title)
      return
    }

    // Save to recent searches
    saveRecentSearch(query)

    // Navigate to result
    switch (result.type) {
      case 'law':
        router.push(`/laws/${result.lawId}`)
        break
      case 'task':
        router.push(`/workspace?highlightTask=${result.id}`)
        break
      case 'employee':
        router.push(`/hr/employees/${result.id}`)
        break
      case 'comment':
        router.push(`/laws/${result.lawId}#comment-${result.id}`)
        break
    }

    onClose()
  }

  if (!isOpen) return null

  const totalResults = [
    ...results.laws,
    ...results.tasks,
    ...results.employees,
    ...results.comments
  ].length

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 bg-black bg-opacity-50 z-50"
        onClick={onClose}
      />

      {/* Modal */}
      <div className="fixed top-1/4 left-1/2 transform -translate-x-1/2 w-full max-w-2xl z-50">
        <div className="bg-white rounded-lg shadow-2xl overflow-hidden">
          {/* Search Input */}
          <div className="p-4 border-b border-gray-200">
            <div className="relative">
              <svg
                className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              <input
                ref={inputRef}
                type="text"
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Search laws, tasks, employees..."
                className="w-full pl-10 pr-4 py-3 text-lg focus:outline-none"
              />
              {isLoading && (
                <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
                  <svg className="animate-spin h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
              )}
            </div>
          </div>

          {/* Results */}
          <div className="max-h-96 overflow-y-auto">
            {totalResults === 0 && query && !isLoading ? (
              <div className="p-8 text-center">
                <svg
                  className="w-12 h-12 text-gray-300 mx-auto mb-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <p className="text-gray-600">No results found for "{query}"</p>
              </div>
            ) : (
              <>
                {results.laws.length > 0 && (
                  <ResultGroup
                    title="Laws"
                    results={results.laws}
                    startIndex={0}
                    selectedIndex={selectedIndex}
                    onSelect={handleSelectResult}
                  />
                )}

                {results.tasks.length > 0 && (
                  <ResultGroup
                    title="Tasks"
                    results={results.tasks}
                    startIndex={results.laws.length}
                    selectedIndex={selectedIndex}
                    onSelect={handleSelectResult}
                  />
                )}

                {results.employees.length > 0 && (
                  <ResultGroup
                    title="Employees"
                    results={results.employees}
                    startIndex={results.laws.length + results.tasks.length}
                    selectedIndex={selectedIndex}
                    onSelect={handleSelectResult}
                  />
                )}

                {results.comments.length > 0 && (
                  <ResultGroup
                    title="Comments"
                    results={results.comments}
                    startIndex={results.laws.length + results.tasks.length + results.employees.length}
                    selectedIndex={selectedIndex}
                    onSelect={handleSelectResult}
                  />
                )}
              </>
            )}
          </div>

          {/* Footer */}
          <div className="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-1">
                <kbd className="px-2 py-1 bg-white border border-gray-300 rounded text-xs">â†‘â†“</kbd>
                <span>Navigate</span>
              </div>
              <div className="flex items-center gap-1">
                <kbd className="px-2 py-1 bg-white border border-gray-300 rounded text-xs">â†µ</kbd>
                <span>Open</span>
              </div>
              <div className="flex items-center gap-1">
                <kbd className="px-2 py-1 bg-white border border-gray-300 rounded text-xs">Esc</kbd>
                <span>Close</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  )
}
```

**Result Group Component:**

```typescript
// components/search/result-group.tsx
interface ResultGroupProps {
  title: string
  results: any[]
  startIndex: number
  selectedIndex: number
  onSelect: (index: number) => void
}

export function ResultGroup({ title, results, startIndex, selectedIndex, onSelect }: ResultGroupProps) {
  return (
    <div className="py-2">
      <div className="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">{title}</div>
      {results.map((result, i) => {
        const index = startIndex + i
        const isSelected = index === selectedIndex

        return (
          <button
            key={result.id}
            onClick={() => onSelect(index)}
            className={`w-full px-4 py-3 text-left hover:bg-gray-100 ${
              isSelected ? 'bg-blue-50 border-l-2 border-blue-500' : ''
            }`}
          >
            <div className="flex items-start gap-3">
              <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${getIconBg(result.type)}`}>
                {getIcon(result.type)}
              </div>
              <div className="flex-1 min-w-0">
                <p className="font-medium text-gray-900 truncate">{result.title}</p>
                {result.snippet && (
                  <p className="text-sm text-gray-600 truncate">{result.snippet}</p>
                )}
                {result.breadcrumb && (
                  <p className="text-xs text-gray-500 mt-1">{result.breadcrumb}</p>
                )}
              </div>
            </div>
          </button>
        )
      })}
    </div>
  )
}

function getIconBg(type: string) {
  const colors: Record<string, string> = {
    law: 'bg-blue-100',
    task: 'bg-green-100',
    employee: 'bg-purple-100',
    comment: 'bg-yellow-100',
    recent: 'bg-gray-100'
  }
  return colors[type] || colors.recent
}

function getIcon(type: string) {
  // SVG icons for each type...
  // Simplified for brevity
  return <span className="text-sm">ðŸ“„</span>
}
```

**Keyboard Shortcut Hook:**

```typescript
// hooks/use-global-search.ts
'use client'

import { useEffect, useState } from 'react'

export function useGlobalSearch() {
  const [isOpen, setIsOpen] = useState(false)

  useEffect(() => {
    function handleKeyDown(e: KeyboardEvent) {
      // Cmd+K (Mac) or Ctrl+K (Windows)
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        setIsOpen(true)
      }
      // / key
      else if (e.key === '/' && !isInputFocused()) {
        e.preventDefault()
        setIsOpen(true)
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [])

  function isInputFocused() {
    const activeElement = document.activeElement
    return (
      activeElement?.tagName === 'INPUT' ||
      activeElement?.tagName === 'TEXTAREA' ||
      activeElement?.getAttribute('contenteditable') === 'true'
    )
  }

  return { isOpen, setIsOpen }
}
```

**Global Search Provider:**

```typescript
// components/search/global-search-provider.tsx
'use client'

import { GlobalSearchModal } from './global-search-modal'
import { useGlobalSearch } from '@/hooks/use-global-search'

export function GlobalSearchProvider({ children }: { children: React.ReactNode }) {
  const { isOpen, setIsOpen } = useGlobalSearch()

  return (
    <>
      {children}
      <GlobalSearchModal isOpen={isOpen} onClose={() => setIsOpen(false)} />
    </>
  )
}
```

**Search API:**

```typescript
// app/api/search/route.ts
export async function GET(request: Request) {
  return withWorkspace(async ({ workspaceId }) => {
    const { searchParams } = new URL(request.url)
    const query = searchParams.get('q')

    if (!query) {
      return NextResponse.json({
        results: { laws: [], tasks: [], employees: [], comments: [] },
      })
    }

    // Search laws (using full-text search or LIKE)
    const laws = await prisma.workspaceLaw.findMany({
      where: {
        workspaceId,
        law: {
          OR: [
            { title: { contains: query, mode: 'insensitive' } },
            { sfsNumber: { contains: query, mode: 'insensitive' } },
            { content: { contains: query, mode: 'insensitive' } },
          ],
        },
      },
      include: {
        law: {
          select: {
            id: true,
            title: true,
            sfsNumber: true,
            content: true,
          },
        },
      },
      take: 5,
    })

    // Search tasks
    const tasks = await prisma.lawTask.findMany({
      where: {
        workspaceLaw: {
          workspaceId,
        },
        OR: [
          { title: { contains: query, mode: 'insensitive' } },
          { description: { contains: query, mode: 'insensitive' } },
        ],
      },
      include: {
        workspaceLaw: {
          include: {
            law: {
              select: {
                title: true,
              },
            },
          },
        },
      },
      take: 3,
    })

    // Search employees
    const employees = await prisma.employee.findMany({
      where: {
        workspaceId,
        OR: [
          { name: { contains: query, mode: 'insensitive' } },
          { email: { contains: query, mode: 'insensitive' } },
          { role: { contains: query, mode: 'insensitive' } },
        ],
      },
      take: 2,
    })

    // Format results
    const results = {
      laws: laws.map((wl) => ({
        id: wl.id,
        lawId: wl.lawId,
        type: 'law',
        title: wl.law.title,
        snippet: wl.law.sfsNumber,
        breadcrumb: `Laws â€º ${wl.status.replace(/_/g, ' ')}`,
      })),
      tasks: tasks.map((task) => ({
        id: task.id,
        lawId: task.workspaceLaw.lawId,
        type: 'task',
        title: task.title,
        snippet: task.description?.substring(0, 100),
        breadcrumb: `Tasks â€º ${task.workspaceLaw.law.title}`,
      })),
      employees: employees.map((emp) => ({
        id: emp.id,
        type: 'employee',
        title: emp.name || emp.email,
        snippet: emp.role,
        breadcrumb: 'Employees',
      })),
      comments: [], // Implement if comments feature exists
    }

    return NextResponse.json({ results })
  })
}
```

**Debounce Hook:**

```typescript
// hooks/use-debounce.ts
import { useState, useEffect } from 'react'

export function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value)
    }, delay)

    return () => {
      clearTimeout(handler)
    }
  }, [value, delay])

  return debouncedValue
}
```

**Reference:** PRD Epic 6 Story 6.9, Architecture Section 16 (Search)

## Testing

**Unit Tests:**

- Keyboard shortcut (Cmd+K) opens modal
- Search query debounced (300ms delay)
- Results grouped by type correctly
- Arrow keys navigate results
- Enter opens selected result
- ESC closes modal

**Integration Tests:**

- Search for law title, verify law results returned
- Search for task title, verify task results returned
- Search for employee name, verify employee results returned
- Navigate with arrow keys, select with Enter, verify navigates to correct page
- Recent searches stored in localStorage and displayed when input empty

**Manual Testing:**

- Press Cmd+K (Mac) or Ctrl+K (Windows), verify modal opens
- Press / key, verify modal opens
- Type search query, verify results appear instantly
- Use arrow keys to navigate, verify selection highlights
- Press Enter, verify navigates to selected result
- Press ESC, verify modal closes
- Clear search input, verify recent searches shown

**Performance Testing:**

- Search completes <300ms
- No lag while typing in search input
- Modal opens/closes instantly

**Accessibility Testing:**

- Modal traps focus (Tab cycles within modal)
- Keyboard navigation works (Arrow keys, Enter, ESC)
- Screen reader announces search results count
- Focus visible on selected result

**Test File:** `__tests__/features/search/global-search.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Use keyboard shortcuts to open search quickly (Cmd+K or /)
- Type search queries to find resources
- Navigate results with arrow keys
- Select result with Enter

**Developer Responsibility:**

- Implement fast, responsive search (<300ms)
- Group results by type for clarity
- Support keyboard navigation
- Store recent searches for quick access
- Provide breadcrumbs to show context
- Handle empty states gracefully

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
