# Story 6.4: Add Task Management to Law Cards

## Status

Draft

## Story

**As a** user,
**I want** to create tasks within each law card,
**so that** I break down compliance into actionable steps.

## Acceptance Criteria

1. Law card modal includes "Tasks" section
2. Task list shows existing tasks with checkboxes
3. "Add Task" button creates new task
4. Task fields: Title, Description (optional), Assigned to (team member), Due date
5. Checking task marks it complete
6. Task completion % shown on law card: "3/5 tasks complete"
7. Tasks stored in `law_tasks` table: id, law_id, workspace_id, title, assigned_to, due_date, completed
8. Kanban card shows task progress bar
9. Overdue tasks highlighted in red

## Tasks / Subtasks

- [ ] Add "Tasks" section to law card modal
- [ ] Create task list component with checkboxes
- [ ] Implement "Add Task" button and form
- [ ] Build task creation modal/inline form
- [ ] Add task update API endpoint
- [ ] Implement task completion toggle
- [ ] Calculate task completion percentage
- [ ] Display task progress on Kanban law card
- [ ] Highlight overdue tasks in red
- [ ] Add task deletion functionality
- [ ] Test task CRUD operations

## Dev Notes

**Tasks Section in Law Card Modal:**

```typescript
// components/kanban/law-card-modal.tsx (updated)
'use client'

import { useState, useEffect } from 'react'
import { TaskList } from './task-list'
import { AddTaskForm } from './add-task-form'

export function LawCardModal({ workspaceLawId, onClose }: LawCardModalProps) {
  const [lawData, setLawData] = useState<any>(null)
  const [tasks, setTasks] = useState<any[]>([])
  const [isAddingTask, setIsAddingTask] = useState(false)

  useEffect(() => {
    fetchLawData()
    fetchTasks()
  }, [workspaceLawId])

  async function fetchTasks() {
    try {
      const response = await fetch(`/api/workspace-laws/${workspaceLawId}/tasks`)
      const data = await response.json()
      setTasks(data.tasks)
    } catch (error) {
      console.error('Failed to fetch tasks:', error)
    }
  }

  function handleTaskCreated(newTask: any) {
    setTasks([...tasks, newTask])
    setIsAddingTask(false)
  }

  function handleTaskUpdated(updatedTask: any) {
    setTasks(tasks.map((t) => (t.id === updatedTask.id ? updatedTask : t)))
  }

  function handleTaskDeleted(taskId: string) {
    setTasks(tasks.filter((t) => t.id !== taskId))
  }

  const completedCount = tasks.filter((t) => t.completed).length
  const totalCount = tasks.length

  return (
    <>
      {/* ... existing modal header and body ... */}

      <div className="flex-1 overflow-y-auto px-6 py-6">
        <div className="space-y-6">
          {/* ... existing sections ... */}

          {/* Tasks Section */}
          <div>
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="text-sm font-semibold text-gray-900">Tasks</h3>
                {totalCount > 0 && (
                  <p className="text-xs text-gray-600 mt-1">
                    {completedCount}/{totalCount} completed ({Math.round((completedCount / totalCount) * 100)}%)
                  </p>
                )}
              </div>
              <button
                onClick={() => setIsAddingTask(true)}
                className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-1"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Add Task
              </button>
            </div>

            {/* Progress Bar */}
            {totalCount > 0 && (
              <div className="mb-4">
                <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-blue-500 transition-all duration-300"
                    style={{ width: `${(completedCount / totalCount) * 100}%` }}
                  />
                </div>
              </div>
            )}

            {/* Add Task Form */}
            {isAddingTask && (
              <AddTaskForm
                workspaceLawId={workspaceLawId}
                onTaskCreated={handleTaskCreated}
                onCancel={() => setIsAddingTask(false)}
              />
            )}

            {/* Task List */}
            {tasks.length === 0 && !isAddingTask ? (
              <div className="text-center py-8 border border-dashed border-gray-300 rounded-lg">
                <svg
                  className="w-12 h-12 text-gray-300 mx-auto mb-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                  />
                </svg>
                <p className="text-sm text-gray-500">
                  No tasks yet. Break down compliance into actionable steps.
                </p>
              </div>
            ) : (
              <TaskList
                tasks={tasks}
                onTaskUpdated={handleTaskUpdated}
                onTaskDeleted={handleTaskDeleted}
              />
            )}
          </div>
        </div>
      </div>
    </>
  )
}
```

**Task List Component:**

```typescript
// components/kanban/task-list.tsx
'use client'

import { useState } from 'react'
import { format } from 'date-fns'
import { sv } from 'date-fns/locale'

interface TaskListProps {
  tasks: any[]
  onTaskUpdated: (task: any) => void
  onTaskDeleted: (taskId: string) => void
}

export function TaskList({ tasks, onTaskUpdated, onTaskDeleted }: TaskListProps) {
  const [expandedTasks, setExpandedTasks] = useState<Set<string>>(new Set())

  async function toggleTaskComplete(task: any) {
    try {
      const response = await fetch(`/api/tasks/${task.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          completed: !task.completed,
          completedAt: !task.completed ? new Date().toISOString() : null
        })
      })

      if (response.ok) {
        const updated = await response.json()
        onTaskUpdated(updated.task)
      }
    } catch (error) {
      console.error('Failed to update task:', error)
    }
  }

  async function deleteTask(taskId: string) {
    if (!confirm('Are you sure you want to delete this task?')) return

    try {
      const response = await fetch(`/api/tasks/${taskId}`, {
        method: 'DELETE'
      })

      if (response.ok) {
        onTaskDeleted(taskId)
      }
    } catch (error) {
      console.error('Failed to delete task:', error)
    }
  }

  function toggleExpand(taskId: string) {
    const newExpanded = new Set(expandedTasks)
    if (newExpanded.has(taskId)) {
      newExpanded.delete(taskId)
    } else {
      newExpanded.add(taskId)
    }
    setExpandedTasks(newExpanded)
  }

  function isOverdue(task: any): boolean {
    if (!task.dueDate || task.completed) return false
    return new Date(task.dueDate) < new Date()
  }

  return (
    <div className="space-y-3">
      {tasks.map((task) => {
        const expanded = expandedTasks.has(task.id)
        const overdue = isOverdue(task)

        return (
          <div
            key={task.id}
            className={`border rounded-lg p-3 ${
              task.completed
                ? 'bg-gray-50 border-gray-200'
                : overdue
                ? 'bg-red-50 border-red-200'
                : 'bg-white border-gray-200'
            }`}
          >
            <div className="flex items-start gap-3">
              {/* Checkbox */}
              <input
                type="checkbox"
                checked={task.completed}
                onChange={() => toggleTaskComplete(task)}
                className="w-5 h-5 mt-0.5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />

              {/* Task Content */}
              <div className="flex-1 min-w-0">
                <div className="flex items-start justify-between gap-2">
                  <h4
                    className={`text-sm font-medium ${
                      task.completed
                        ? 'text-gray-500 line-through'
                        : overdue
                        ? 'text-red-700'
                        : 'text-gray-900'
                    }`}
                  >
                    {task.title}
                  </h4>

                  {/* Actions */}
                  <div className="flex items-center gap-1 flex-shrink-0">
                    {task.description && (
                      <button
                        onClick={() => toggleExpand(task.id)}
                        className="p-1 text-gray-400 hover:text-gray-600"
                        title={expanded ? 'Collapse' : 'Expand'}
                      >
                        <svg
                          className={`w-4 h-4 transition-transform ${expanded ? 'rotate-180' : ''}`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                    )}
                    <button
                      onClick={() => deleteTask(task.id)}
                      className="p-1 text-gray-400 hover:text-red-600"
                      title="Delete task"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                </div>

                {/* Task Metadata */}
                <div className="flex items-center gap-3 mt-2 text-xs text-gray-600">
                  {task.assignedEmployee && (
                    <div className="flex items-center gap-1">
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                      <span>{task.assignedEmployee.name || task.assignedEmployee.email}</span>
                    </div>
                  )}

                  {task.dueDate && (
                    <div className={`flex items-center gap-1 ${overdue ? 'text-red-600 font-medium' : ''}`}>
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span>
                        {overdue && '⚠️ '}
                        {format(new Date(task.dueDate), 'MMM d', { locale: sv })}
                      </span>
                    </div>
                  )}

                  {task.completed && task.completedAt && (
                    <div className="flex items-center gap-1 text-green-600">
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                      </svg>
                      <span>
                        Completed {format(new Date(task.completedAt), 'MMM d', { locale: sv })}
                      </span>
                    </div>
                  )}
                </div>

                {/* Expanded Description */}
                {expanded && task.description && (
                  <p className="mt-2 text-sm text-gray-700 whitespace-pre-wrap">
                    {task.description}
                  </p>
                )}
              </div>
            </div>
          </div>
        )
      })}
    </div>
  )
}
```

**Add Task Form Component:**

```typescript
// components/kanban/add-task-form.tsx
'use client'

import { useState } from 'react'

interface AddTaskFormProps {
  workspaceLawId: string
  onTaskCreated: (task: any) => void
  onCancel: () => void
}

export function AddTaskForm({ workspaceLawId, onTaskCreated, onCancel }: AddTaskFormProps) {
  const [title, setTitle] = useState('')
  const [description, setDescription] = useState('')
  const [assignedTo, setAssignedTo] = useState('')
  const [dueDate, setDueDate] = useState('')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [employees, setEmployees] = useState<any[]>([])

  useEffect(() => {
    fetchEmployees()
  }, [])

  async function fetchEmployees() {
    try {
      const response = await fetch('/api/employees')
      const data = await response.json()
      setEmployees(data.employees)
    } catch (error) {
      console.error('Failed to fetch employees:', error)
    }
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()

    if (!title.trim()) {
      alert('Please enter a task title')
      return
    }

    setIsSubmitting(true)
    try {
      const response = await fetch(`/api/workspace-laws/${workspaceLawId}/tasks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title.trim(),
          description: description.trim() || null,
          assignedTo: assignedTo || null,
          dueDate: dueDate || null
        })
      })

      if (response.ok) {
        const data = await response.json()
        onTaskCreated(data.task)
      } else {
        alert('Failed to create task')
      }
    } catch (error) {
      alert('Failed to create task')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <form onSubmit={handleSubmit} className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 space-y-3">
      {/* Title */}
      <div>
        <label className="block text-sm font-medium text-gray-900 mb-1">
          Task Title *
        </label>
        <input
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="What needs to be done?"
          autoFocus
        />
      </div>

      {/* Description */}
      <div>
        <label className="block text-sm font-medium text-gray-900 mb-1">
          Description (optional)
        </label>
        <textarea
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          rows={2}
          placeholder="Add details..."
        />
      </div>

      {/* Assigned To & Due Date */}
      <div className="grid grid-cols-2 gap-3">
        <div>
          <label className="block text-sm font-medium text-gray-900 mb-1">
            Assign to
          </label>
          <select
            value={assignedTo}
            onChange={(e) => setAssignedTo(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">Unassigned</option>
            {employees.map((emp) => (
              <option key={emp.id} value={emp.id}>
                {emp.name || emp.email}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-900 mb-1">
            Due date
          </label>
          <input
            type="date"
            value={dueDate}
            onChange={(e) => setDueDate(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      {/* Actions */}
      <div className="flex gap-2">
        <button
          type="submit"
          disabled={isSubmitting || !title.trim()}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium"
        >
          {isSubmitting ? 'Creating...' : 'Create Task'}
        </button>
        <button
          type="button"
          onClick={onCancel}
          disabled={isSubmitting}
          className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium"
        >
          Cancel
        </button>
      </div>
    </form>
  )
}
```

**Get Tasks API:**

```typescript
// app/api/workspace-laws/[id]/tasks/route.ts
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId }) => {
    // Verify law belongs to workspace
    const workspaceLaw = await prisma.workspaceLaw.findFirst({
      where: {
        id: params.id,
        workspaceId,
      },
    })

    if (!workspaceLaw) {
      return NextResponse.json({ error: 'Law not found' }, { status: 404 })
    }

    // Get tasks
    const tasks = await prisma.lawTask.findMany({
      where: { workspaceLawId: params.id },
      include: {
        assignedEmployee: {
          select: {
            id: true,
            name: true,
            email: true,
          },
        },
      },
      orderBy: [
        { completed: 'asc' }, // Incomplete tasks first
        { dueDate: 'asc' },
        { createdAt: 'desc' },
      ],
    })

    return NextResponse.json({ tasks })
  })
}
```

**Create Task API:**

```typescript
// app/api/workspace-laws/[id]/tasks/route.ts (POST)
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_LAWS)

    // Verify law belongs to workspace
    const workspaceLaw = await prisma.workspaceLaw.findFirst({
      where: {
        id: params.id,
        workspaceId,
      },
    })

    if (!workspaceLaw) {
      return NextResponse.json({ error: 'Law not found' }, { status: 404 })
    }

    const { title, description, assignedTo, dueDate } = await request.json()

    const task = await prisma.lawTask.create({
      data: {
        workspaceLawId: params.id,
        title,
        description,
        assignedTo,
        dueDate: dueDate ? new Date(dueDate) : null,
      },
      include: {
        assignedEmployee: {
          select: {
            id: true,
            name: true,
            email: true,
          },
        },
      },
    })

    return NextResponse.json({ task })
  })
}
```

**Update Task API:**

```typescript
// app/api/tasks/[id]/route.ts
export async function PATCH(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_LAWS)

    const data = await request.json()

    const task = await prisma.lawTask.update({
      where: { id: params.id },
      data: {
        ...data,
        completedAt: data.completed ? new Date() : null,
      },
      include: {
        assignedEmployee: {
          select: {
            id: true,
            name: true,
            email: true,
          },
        },
      },
    })

    return NextResponse.json({ task })
  })
}
```

**Delete Task API:**

```typescript
// app/api/tasks/[id]/route.ts (DELETE)
export async function DELETE(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_LAWS)

    await prisma.lawTask.delete({
      where: { id: params.id },
    })

    return NextResponse.json({ success: true })
  })
}
```

**Updated Law Card with Task Progress:**

```typescript
// components/kanban/law-card.tsx (updated to show progress)
export function LawCard({ law }: LawCardProps) {
  return (
    <div className="bg-white rounded-lg border-2 border-gray-200 p-4 cursor-pointer">
      {/* ... existing card content ... */}

      {/* Task Progress Bar */}
      {law.taskProgress && law.taskProgress.total > 0 && (
        <div className="mt-3">
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs text-gray-600">Tasks</span>
            <span className="text-xs text-gray-600">
              {law.taskProgress.completed}/{law.taskProgress.total}
            </span>
          </div>
          <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
            <div
              className={`h-full transition-all duration-300 ${
                law.taskProgress.completed === law.taskProgress.total
                  ? 'bg-green-500'
                  : 'bg-blue-500'
              }`}
              style={{
                width: `${(law.taskProgress.completed / law.taskProgress.total) * 100}%`
              }}
            />
          </div>
        </div>
      )}
    </div>
  )
}
```

**Reference:** PRD Epic 6 Story 6.4, Architecture Section 14 (Compliance Workspace)

## Testing

**Unit Tests:**

- Task creation adds task to list
- Task toggle updates completed status
- Task deletion removes from list
- Task progress calculation is accurate
- Overdue tasks identified correctly (dueDate < now && !completed)

**Integration Tests:**

- Create task, verify appears in list
- Complete task, verify checkbox checked and progress bar updates
- Delete task, verify removed from list
- Assign employee to task, verify shows in metadata
- Set due date in past, verify highlighted as overdue
- Complete all tasks, verify progress bar turns green

**Manual Testing:**

- Open law modal, add 5 tasks
- Complete 3 tasks, verify progress shows "3/5 (60%)"
- Set due date yesterday, verify task highlighted red
- Expand task with description, verify shows full text
- Delete task, verify confirmation modal appears
- Verify progress bar on Kanban card matches modal

**Performance Testing:**

- Law card modal with 50+ tasks loads <500ms
- Task completion toggles without lag
- Task list scrolls smoothly

**Accessibility Testing:**

- Checkbox accessible via keyboard (Space to toggle)
- Task actions accessible via Tab navigation
- Screen reader announces task completion status
- Color not sole indicator of overdue (also has ⚠️ icon)

**Test File:** `__tests__/features/kanban/task-management.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Break down laws into actionable tasks
- Assign tasks to team members
- Set realistic due dates
- Mark tasks complete as they finish
- Add descriptions for clarity

**Developer Responsibility:**

- Persist tasks accurately
- Calculate progress percentage correctly
- Highlight overdue tasks visibly
- Update Kanban card progress bar in real-time
- Handle task CRUD operations
- Validate required fields (title)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
