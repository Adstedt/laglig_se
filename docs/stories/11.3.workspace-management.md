# Story 11.3: Workspace Management

## Status

Draft

## Story

**As an** admin,
**I want** to browse, search, and manage all workspaces on the platform,
**so that** I can handle customer support tasks and subscription changes.

## Acceptance Criteria

1. Workspace list page at `/admin/workspaces`
2. Searchable data table (TanStack Table) with columns: Name, Slug, Owner (email), Subscription Tier, Status, Member Count, Created Date
3. Search by workspace name, slug, or owner email (server-side filtering via query params)
4. Filter by subscription tier (dropdown) and status (dropdown)
5. Sortable by any column (server-side sorting)
6. Paginated (25 per page, server-side)
7. Click a workspace row to navigate to detail view at `/admin/workspaces/[id]`
8. Detail view shows:
   - Workspace info (name, slug, org number, status, tier, created date)
   - Company profile (company name, SNI code, legal form, employee count, address)
   - Member list (name, email, role, joined date)
   - Quick stats (law list count, task count)
9. Actions available on detail view:
   - Change subscription tier (dropdown + "Spara" button with confirmation)
   - Change status: Pause / Unpause / Mark Deleted (with confirmation dialog)
10. All mutations logged in `ActivityLog` with `entity_type: 'ADMIN_ACTION'`

## Tasks / Subtasks

- [ ] **Task 1: Create workspace list query** (AC: 2, 3, 4, 5, 6)
  - [ ] Add to `lib/admin/queries.ts`:
  - [ ] `getWorkspaceList(params)` — accepts `{ search?: string, tier?: SubscriptionTier, status?: WorkspaceStatus, sortBy?: string, sortDir?: 'asc' | 'desc', page?: number, pageSize?: number }`
  - [ ] Build dynamic Prisma `where` clause:
    - If `search`: match against `name`, `slug`, or `owner.email` using `contains` (case-insensitive via `mode: 'insensitive'`)
    - If `tier`: filter by `subscription_tier`
    - If `status`: filter by `status`
  - [ ] Return `{ data: WorkspaceListItem[], total: number, page: number, pageSize: number }` for pagination
  - [ ] Use `select` to fetch only needed fields + `_count` for member count
  - [ ] Default sort: `created_at` desc

- [ ] **Task 2: Create workspace detail query** (AC: 8)
  - [ ] Add to `lib/admin/queries.ts`:
  - [ ] `getWorkspaceDetail(id: string)` — returns workspace with:
    - Full workspace fields (name, slug, status, tier, created_at)
    - Company profile (via `companyProfile` relation)
    - Members list (via `members` relation → include user name, email, role, created_at)
    - Counts: `_count` for `lawLists`, `tasks`

- [ ] **Task 3: Create admin workspace actions** (AC: 9, 10)
  - [ ] Create `app/actions/admin-workspaces.ts` with `'use server'` directive
  - [ ] `updateWorkspaceTier(workspaceId: string, tier: SubscriptionTier)`:
    - Verify admin session via `getAdminSession()`
    - Update `prisma.workspace.update({ where: { id }, data: { subscription_tier: tier } })`
    - Log to ActivityLog: `{ entity_type: 'ADMIN_ACTION', entity_id: workspaceId, action: 'CHANGE_TIER', old_value: oldTier, new_value: tier, user_id: adminUserId }`
    - Return `{ success: true }`
  - [ ] `updateWorkspaceStatus(workspaceId: string, status: WorkspaceStatus)`:
    - Verify admin session
    - Prevent deleting workspace that is already DELETED
    - Update `prisma.workspace.update({ where: { id }, data: { status } })`
    - Log to ActivityLog
    - Return `{ success: true }`

- [ ] **Task 4: Create workspace list page** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create `app/admin/(dashboard)/workspaces/page.tsx` — Server Component
  - [ ] Read search/filter/sort/page from `searchParams`
  - [ ] Call `getWorkspaceList()` with parsed params
  - [ ] Render `WorkspaceTable` client component with data
  - [ ] Create `components/admin/workspace-table.tsx` — `'use client'` component:
    - TanStack Table with columns defined for all fields
    - Search input at top — debounced, updates URL search params via `useRouter().push()`
    - Filter dropdowns for tier and status — update URL search params
    - Column header sorting — update URL search params
    - Pagination controls at bottom — update URL search params
    - Row click navigates to `/admin/workspaces/${row.id}`
  - [ ] Badge component for status (green=Active, yellow=Paused, red=Deleted) and tier

- [ ] **Task 5: Create workspace detail page** (AC: 7, 8, 9, 10)
  - [ ] Create `app/admin/(dashboard)/workspaces/[id]/page.tsx` — Server Component
  - [ ] Fetch workspace detail via `getWorkspaceDetail(id)`
  - [ ] Show 404 if workspace not found
  - [ ] Render workspace info section (Card with key-value pairs)
  - [ ] Render company profile section (Card) — show "Ingen företagsprofil" if null
  - [ ] Render members table (simple shadcn/ui Table, not TanStack — typically <20 members)
  - [ ] Render quick stats (law list count, task count)
  - [ ] Create `'use client'` action components:
    - Tier selector: `<Select>` with current tier pre-selected + "Spara" button
    - Status actions: Buttons for "Pausa" / "Aktivera" / "Radera" depending on current status, each with `AlertDialog` confirmation
  - [ ] Show success/error toast after mutations
  - [ ] Use `revalidatePath()` after successful mutations to refresh data

- [ ] **Task 6: Testing** (AC: all)
  - **Automated (Vitest)** — write in `tests/unit/lib/admin/queries.test.ts` (extend from 11.2):
  - [ ] Test: `getWorkspaceList()` with no filters returns paginated results
  - [ ] Test: `getWorkspaceList()` with search filters by name/slug/email
  - [ ] Test: `getWorkspaceList()` with tier filter
  - [ ] Test: `getWorkspaceList()` with status filter
  - [ ] Test: `getWorkspaceList()` pagination returns correct total and page
  - [ ] Test: `getWorkspaceDetail()` returns full workspace with relations
  - Write in `tests/unit/actions/admin-workspaces.test.ts`:
  - [ ] Test: `updateWorkspaceTier()` updates tier and logs ActivityLog
  - [ ] Test: `updateWorkspaceStatus()` updates status and logs ActivityLog
  - [ ] Test: mutations reject without admin session
  - **Manual:**
  - [ ] Test: search, filter, sort, paginate workspace list
  - [ ] Test: click workspace → detail view loads
  - [ ] Test: change tier → tier updated, page refreshes
  - [ ] Test: pause/unpause workspace → status changes

## Dev Notes

### Dependencies

- **Blocked by:** Story 11.1 (Admin Auth & Shell Layout) — requires admin auth and layout shell
- **Independent of:** Stories 11.4, 11.5, 11.6, 11.7

### Architecture Context

This is the first admin page with TanStack Table. The table pattern established here (server-side filtering/sorting/pagination via URL search params) will be reused in Story 11.4 (User Management).

**Server-side table pattern:** All filtering, sorting, and pagination happen on the server via Prisma queries. The client component reads data as props and uses URL search params to control the server query. This avoids loading all workspaces into the client.

### Relevant Source Tree

```
app/admin/(dashboard)/
  workspaces/
    page.tsx                          # NEW: Workspace list page
    [id]/
      page.tsx                        # NEW: Workspace detail page

components/admin/
  workspace-table.tsx                 # NEW: 'use client' TanStack Table

lib/admin/
  queries.ts                          # EXTEND: Add getWorkspaceList(), getWorkspaceDetail()
  auth.ts                             # READ: getAdminSession() for action auth

app/actions/
  admin-workspaces.ts                 # NEW: updateWorkspaceTier(), updateWorkspaceStatus()

# REFERENCE FILES:
prisma/schema.prisma
  - Workspace model (line ~57): id, name, slug, status, subscription_tier, owner_id, created_at
  - CompanyProfile model: company_name, sni_code, legal_form, employee_count, address fields
  - WorkspaceMember model (line ~103): user_id, workspace_id, role, created_at
  - ActivityLog model: entity_type, entity_id, action, old_value, new_value, user_id
  - SubscriptionTier enum: TRIAL, SOLO, TEAM, ENTERPRISE
  - WorkspaceStatus enum: ACTIVE, PAUSED, DELETED
```

### Key Implementation Details

1. **TanStack Table setup.** Install if not already available:

   ```bash
   pnpm add @tanstack/react-table
   ```

   TanStack React Table (`@tanstack/react-table` 8.21.3) is already in the project dependencies.

2. **URL search params pattern for server-side tables:**

   ```typescript
   // In page.tsx (Server Component):
   export default async function WorkspacesPage({
     searchParams,
   }: {
     searchParams: Promise<Record<string, string | string[] | undefined>>
   }) {
     const params = await searchParams
     const search = typeof params.search === 'string' ? params.search : undefined
     const tier = typeof params.tier === 'string' ? params.tier as SubscriptionTier : undefined
     const page = typeof params.page === 'string' ? parseInt(params.page, 10) : 1

     const result = await getWorkspaceList({ search, tier, page, pageSize: 25 })
     return <WorkspaceTable data={result.data} total={result.total} page={page} />
   }
   ```

3. **ActivityLog pattern.** Check existing usage in the codebase. The ActivityLog model has:

   ```prisma
   model ActivityLog {
     id          String   @id @default(uuid())
     entity_type String
     entity_id   String
     action      String
     old_value   String?
     new_value   String?
     user_id     String?
     workspace_id String?
     created_at  DateTime @default(now())
   }
   ```

   For admin actions, set `entity_type: 'ADMIN_ACTION'` and `user_id` to the admin's user ID (looked up from email).

4. **Status badge colors:**

   ```typescript
   const STATUS_COLORS: Record<WorkspaceStatus, string> = {
     ACTIVE: 'bg-green-100 text-green-800',
     PAUSED: 'bg-yellow-100 text-yellow-800',
     DELETED: 'bg-red-100 text-red-800',
   }
   ```

5. **Tier badge colors:**

   ```typescript
   const TIER_COLORS: Record<SubscriptionTier, string> = {
     TRIAL: 'bg-gray-100 text-gray-800',
     SOLO: 'bg-blue-100 text-blue-800',
     TEAM: 'bg-purple-100 text-purple-800',
     ENTERPRISE: 'bg-amber-100 text-amber-800',
   }
   ```

### Coding Standards

- Server-side data fetching in Server Components [Source: architecture/17-coding-standards.md#17.3]
- TanStack Table for complex data tables [Source: architecture/3-tech-stack.md — @tanstack/react-table 8.21.3]
- shadcn/ui components: Card, Table, Select, Badge, AlertDialog, Button [Source: architecture/17-coding-standards.md#17.3]
- Prisma `select` for selective field fetching [Source: architecture/17-coding-standards.md#17.7]
- Parallel data fetching with `Promise.all()` [Source: architecture/17-coding-standards.md#17.7]
- URL search params for server-side filtering/pagination (no client state for table params)

### Testing

- **Test file locations**: `tests/unit/lib/admin/queries.test.ts`, `tests/unit/actions/admin-workspaces.test.ts`
- **Testing framework**: Vitest [Source: architecture/17-coding-standards.md]
- **Mock strategy**: Mock `prisma` for query tests, mock `getAdminSession` for action tests
- **Manual**: Full table interaction (search, filter, sort, paginate), workspace detail view, tier/status mutations

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-02-02 | 1.0     | Initial story creation | Sarah (PO) |
