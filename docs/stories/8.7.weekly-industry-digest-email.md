# Story 8.7: Implement Weekly Industry Digest Email

## Status

Draft

## Story

**As a** user,
**I want** to receive a weekly email with law changes relevant to my industry,
**so that** I discover changes to laws not yet in my list.

## Acceptance Criteria

1. Sent every Sunday at 18:00 CET

2. **Email Structure:**
   - Section 1: "√Ñndringar i dina lagar" (Changes to workspace laws)
   - Section 2: "Uppt√§ck relevanta lagar" (Industry starter pack laws NOT in workspace)
   - Section 3: "AI-rekommendationer" (New laws you might need, based on AI analysis)

3. **Section 1 Content:**
   - All changes from the past week to laws in workspace
   - Grouped by priority (High ‚Üí Low)
   - AI summary + business impact for each

4. **Section 2 Content:**
   - Laws from industry starter pack (based on workspace SNI code) NOT already in workspace
   - Show if any of these laws changed this week
   - CTA: "L√§gg till i min laglista"

5. **Section 3 Content:**
   - AI analyzes workspace (industry, employee roles, existing laws)
   - Suggests 3-5 additional laws user might need
   - Brief explanation for each recommendation
   - CTA: "L√§s mer om denna lag"

6. Email sent only if ‚â•1 change occurred that week (Sections 1 or 2)

7. Subject: "Vecko√∂versikt: [N] lag√§ndringar + nya rekommendationer"

8. Users can disable in notification preferences

9. Track engagement (opens, clicks on recommendations)

## Tasks / Subtasks

- [ ] Create weekly digest email template
- [ ] Implement cron job for Sunday 18:00 CET
- [ ] Query all changes from past 7 days
- [ ] Filter workspace laws vs industry starter pack laws
- [ ] Implement AI recommendation logic
- [ ] Add "Add to My List" functionality for Section 2
- [ ] Track engagement metrics
- [ ] Respect user notification preferences
- [ ] Test email rendering
- [ ] Test cron job execution
- [ ] Verify AI recommendations are relevant

## Dev Notes

**Weekly Digest Email Template:**

```typescript
// emails/weekly-industry-digest.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Button,
  Hr,
  Link
} from '@react-email/components'

interface Change {
  id: string
  priority: 'high' | 'medium' | 'low'
  lawTitle: string
  lawSfsNummer: string
  aiSummary: string
  businessImpact: string
  diffUrl: string
}

interface DiscoveryLaw {
  id: string
  sfsNummer: string
  rubrik: string
  changeCount: number
  addToListUrl: string
}

interface AIRecommendation {
  lawId: string
  sfsNummer: string
  rubrik: string
  reason: string
  readMoreUrl: string
}

interface WeeklyDigestProps {
  userName: string
  workspaceName: string
  workspaceChanges: Change[]
  discoveryLaws: DiscoveryLaw[]
  aiRecommendations: AIRecommendation[]
  unsubscribeUrl: string
}

export function WeeklyIndustryDigest({
  userName,
  workspaceName,
  workspaceChanges,
  discoveryLaws,
  aiRecommendations,
  unsubscribeUrl
}: WeeklyDigestProps) {
  const PRIORITY_EMOJI = {
    high: 'üî¥',
    medium: 'üü°',
    low: 'üü¢'
  }

  const totalChanges = workspaceChanges.length + discoveryLaws.reduce((sum, law) => sum + law.changeCount, 0)

  return (
    <Html>
      <Head />
      <Body style={{ fontFamily: 'sans-serif', backgroundColor: '#f9fafb' }}>
        <Container style={{ maxWidth: '600px', margin: '0 auto', backgroundColor: '#ffffff' }}>
          {/* Header */}
          <Section style={{ backgroundColor: '#3b82f6', padding: '24px', textAlign: 'center' }}>
            <Text style={{ color: '#ffffff', fontSize: '24px', fontWeight: 'bold', margin: '0' }}>
              üìÖ Vecko√∂versikt
            </Text>
          </Section>

          {/* Greeting */}
          <Section style={{ padding: '24px' }}>
            <Text style={{ fontSize: '16px', color: '#111827', margin: '0 0 16px 0' }}>
              Hej {userName},
            </Text>
            <Text style={{ fontSize: '14px', color: '#6b7280', margin: '0' }}>
              H√§r √§r vad som h√§nt den senaste veckan inom <strong>{workspaceName}</strong> och din bransch.
            </Text>
          </Section>

          {/* Section 1: Workspace Changes */}
          {workspaceChanges.length > 0 && (
            <>
              <Section style={{ padding: '0 24px' }}>
                <Text style={{ fontSize: '18px', fontWeight: 'bold', color: '#111827', margin: '0 0 16px 0' }}>
                  üìã √Ñndringar i dina lagar
                </Text>
              </Section>

              {workspaceChanges.map((change) => (
                <Section
                  key={change.id}
                  style={{
                    margin: '0 24px 16px 24px',
                    borderLeft: '4px solid #3b82f6',
                    padding: '16px',
                    backgroundColor: '#f9fafb',
                    borderRadius: '8px'
                  }}
                >
                  <Text style={{ fontSize: '14px', fontWeight: 'bold', color: '#111827', margin: '0 0 8px 0' }}>
                    {PRIORITY_EMOJI[change.priority]} {change.lawSfsNummer}: {change.lawTitle}
                  </Text>
                  <Text style={{ fontSize: '14px', color: '#374151', margin: '0 0 12px 0' }}>
                    {change.aiSummary}
                  </Text>
                  <Text
                    style={{
                      fontSize: '13px',
                      color: '#1e40af',
                      backgroundColor: '#dbeafe',
                      padding: '8px 12px',
                      borderRadius: '6px',
                      margin: '0 0 12px 0'
                    }}
                  >
                    <strong>P√•verkan:</strong> {change.businessImpact}
                  </Text>
                  <Link
                    href={change.diffUrl}
                    style={{
                      color: '#3b82f6',
                      fontSize: '13px',
                      textDecoration: 'none',
                      fontWeight: '500'
                    }}
                  >
                    Granska √§ndring ‚Üí
                  </Link>
                </Section>
              ))}
            </>
          )}

          {/* Section 2: Discovery Laws */}
          {discoveryLaws.length > 0 && (
            <>
              <Hr style={{ borderColor: '#e5e7eb', margin: '24px' }} />

              <Section style={{ padding: '0 24px' }}>
                <Text style={{ fontSize: '18px', fontWeight: 'bold', color: '#111827', margin: '0 0 8px 0' }}>
                  üîç Uppt√§ck relevanta lagar
                </Text>
                <Text style={{ fontSize: '14px', color: '#6b7280', margin: '0 0 16px 0' }}>
                  Dessa lagar √§r relevanta f√∂r din bransch men finns inte i din lista √§n.
                </Text>
              </Section>

              {discoveryLaws.map((law) => (
                <Section
                  key={law.id}
                  style={{
                    margin: '0 24px 16px 24px',
                    border: '1px solid #e5e7eb',
                    padding: '16px',
                    backgroundColor: '#fefce8',
                    borderRadius: '8px'
                  }}
                >
                  <Text style={{ fontSize: '14px', fontWeight: 'bold', color: '#111827', margin: '0 0 8px 0' }}>
                    {law.sfsNummer}: {law.rubrik}
                  </Text>
                  <Text style={{ fontSize: '13px', color: '#854d0e', margin: '0 0 12px 0' }}>
                    {law.changeCount} {law.changeCount === 1 ? '√§ndring' : '√§ndringar'} den senaste veckan
                  </Text>
                  <Button
                    href={law.addToListUrl}
                    style={{
                      backgroundColor: '#eab308',
                      color: '#ffffff',
                      padding: '8px 16px',
                      borderRadius: '6px',
                      textDecoration: 'none',
                      fontSize: '13px',
                      fontWeight: '500'
                    }}
                  >
                    L√§gg till i min laglista
                  </Button>
                </Section>
              ))}
            </>
          )}

          {/* Section 3: AI Recommendations */}
          {aiRecommendations.length > 0 && (
            <>
              <Hr style={{ borderColor: '#e5e7eb', margin: '24px' }} />

              <Section style={{ padding: '0 24px' }}>
                <Text style={{ fontSize: '18px', fontWeight: 'bold', color: '#111827', margin: '0 0 8px 0' }}>
                  ü§ñ AI-rekommendationer
                </Text>
                <Text style={{ fontSize: '14px', color: '#6b7280', margin: '0 0 16px 0' }}>
                  Baserat p√• din verksamhet rekommenderar vi dessa lagar:
                </Text>
              </Section>

              {aiRecommendations.map((rec) => (
                <Section
                  key={rec.lawId}
                  style={{
                    margin: '0 24px 16px 24px',
                    border: '1px solid #e5e7eb',
                    padding: '16px',
                    backgroundColor: '#f0fdf4',
                    borderRadius: '8px'
                  }}
                >
                  <Text style={{ fontSize: '14px', fontWeight: 'bold', color: '#111827', margin: '0 0 8px 0' }}>
                    {rec.sfsNummer}: {rec.rubrik}
                  </Text>
                  <Text style={{ fontSize: '13px', color: '#166534', margin: '0 0 12px 0' }}>
                    <strong>Varf√∂r:</strong> {rec.reason}
                  </Text>
                  <Link
                    href={rec.readMoreUrl}
                    style={{
                      color: '#16a34a',
                      fontSize: '13px',
                      textDecoration: 'none',
                      fontWeight: '500'
                    }}
                  >
                    L√§s mer om denna lag ‚Üí
                  </Link>
                </Section>
              ))}
            </>
          )}

          {/* CTA */}
          <Section style={{ padding: '24px', textAlign: 'center' }}>
            <Button
              href={`https://laglig.se/laws?utm_source=email&utm_medium=weekly_digest&utm_campaign=weekly_digest`}
              style={{
                backgroundColor: '#3b82f6',
                color: '#ffffff',
                padding: '12px 24px',
                borderRadius: '8px',
                textDecoration: 'none',
                fontSize: '14px',
                fontWeight: '600',
                display: 'inline-block'
              }}
            >
              G√• till mina lagar
            </Button>
          </Section>

          <Hr style={{ borderColor: '#e5e7eb', margin: '0 24px' }} />

          {/* Footer */}
          <Section style={{ padding: '16px 24px', fontSize: '12px', color: '#6b7280', textAlign: 'center' }}>
            <Text style={{ margin: '0 0 8px 0' }}>
              Vecko√∂versikt fr√•n Laglig.se
            </Text>
            <Link href={unsubscribeUrl} style={{ color: '#3b82f6', textDecoration: 'none' }}>
              Avbest√§ll vecko√∂versikt
            </Link>
          </Section>
        </Container>
      </Body>
    </Html>
  )
}
```

**AI Recommendation Logic:**

```typescript
// lib/law-recommendations/generate-weekly-recommendations.ts
import OpenAI from 'openai'
import { prisma } from '@/lib/prisma'

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

interface Recommendation {
  lawId: string
  sfsNummer: string
  rubrik: string
  reason: string
  readMoreUrl: string
}

export async function generateWeeklyRecommendations(
  workspaceId: string
): Promise<Recommendation[]> {
  // Get workspace context
  const workspace = await prisma.workspace.findUnique({
    where: { id: workspaceId },
    include: {
      workspaceLaws: {
        include: {
          law: {
            select: {
              id: true,
              sfsNummer: true,
              rubrik: true,
              categories: true,
            },
          },
        },
      },
      employees: {
        select: {
          role: true,
          department: true,
        },
      },
    },
  })

  if (!workspace) return []

  // Build context for AI
  const existingLawCategories = workspace.workspaceLaws
    .flatMap((wl) => wl.law.categories)
    .filter((cat, index, self) => self.indexOf(cat) === index) // unique

  const employeeRoles = workspace.employees
    .map((e) => e.role)
    .filter((role, index, self) => self.indexOf(role) === index) // unique

  const employeeDepartments = workspace.employees
    .map((e) => e.department)
    .filter((dept, index, self) => dept && self.indexOf(dept) === index) // unique

  // Get all laws NOT in workspace
  const candidateLaws = await prisma.law.findMany({
    where: {
      NOT: {
        id: {
          in: workspace.workspaceLaws.map((wl) => wl.law.id),
        },
      },
    },
    select: {
      id: true,
      sfsNummer: true,
      rubrik: true,
      categories: true,
    },
    take: 100, // Limit to reasonable size for AI prompt
  })

  // Ask AI to recommend laws
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      {
        role: 'system',
        content: `You are an expert in Swedish law and business compliance. Recommend 3-5 additional laws that would be relevant for this business, based on their existing laws, employee roles, and departments. Provide a brief reason for each recommendation in Swedish.`,
      },
      {
        role: 'user',
        content: `Business Context:
- Industry (SNI code): ${workspace.sniCode || 'Unknown'}
- Existing law categories: ${existingLawCategories.join(', ')}
- Employee roles: ${employeeRoles.join(', ')}
- Departments: ${employeeDepartments.join(', ')}

Candidate laws to consider:
${candidateLaws.map((law) => `- ${law.sfsNummer}: ${law.rubrik} (Categories: ${law.categories.join(', ')})`).join('\n')}

Recommend 3-5 laws from the candidate list that would be most relevant for this business. For each, provide a brief reason in Swedish (1-2 sentences).

Respond in JSON format:
[
  {
    "lawId": "uuid",
    "sfsNummer": "SFS number",
    "rubrik": "Law title",
    "reason": "Reason in Swedish"
  }
]`,
      },
    ],
    temperature: 0.5,
    max_tokens: 500,
  })

  try {
    const recommendations = JSON.parse(
      response.choices[0].message.content || '[]'
    )

    return recommendations.map((rec: any) => ({
      lawId: rec.lawId,
      sfsNummer: rec.sfsNummer,
      rubrik: rec.rubrik,
      reason: rec.reason,
      readMoreUrl: `https://laglig.se/laws/${rec.lawId}?utm_source=email&utm_medium=weekly_digest&utm_campaign=ai_recommendation`,
    }))
  } catch (error) {
    console.error('Failed to parse AI recommendations:', error)
    return []
  }
}
```

**Weekly Digest Cron Job:**

```typescript
// app/api/cron/send-weekly-digest/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { sendEmail } from '@/lib/email/send-email'
import { WeeklyIndustryDigest } from '@/emails/weekly-industry-digest'
import { generateWeeklyRecommendations } from '@/lib/law-recommendations/generate-weekly-recommendations'

export async function GET(request: Request) {
  // Verify Vercel Cron secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const startTime = Date.now()
  const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)

  let emailsSent = 0
  let skipped = 0

  try {
    // Get all workspaces
    const workspaces = await prisma.workspace.findMany({
      include: {
        owner: {
          select: { id: true, name: true, email: true },
        },
        workspaceLaws: {
          include: {
            law: {
              select: {
                id: true,
                sfsNummer: true,
                rubrik: true,
              },
              include: {
                lawChanges: {
                  where: {
                    detectedAt: { gte: oneWeekAgo },
                    acknowledgedAt: null,
                  },
                  orderBy: [{ priority: 'desc' }, { detectedAt: 'desc' }],
                },
              },
            },
          },
        },
      },
    })

    for (const workspace of workspaces) {
      // Check user preferences
      const preferences = await prisma.userNotificationPreferences.findUnique({
        where: { userId: workspace.owner.id },
      })

      if (preferences && !preferences.emailWeeklyDigest) {
        skipped++
        continue
      }

      // Section 1: Workspace changes
      const workspaceChanges = workspace.workspaceLaws.flatMap((wl) =>
        wl.law.lawChanges.map((change) => ({
          id: change.id,
          priority: change.priority as 'high' | 'medium' | 'low',
          lawTitle: wl.law.rubrik,
          lawSfsNummer: wl.law.sfsNummer,
          aiSummary: change.aiSummary || '√Ñndring uppt√§ckt.',
          businessImpact: change.businessImpact || 'Kr√§ver granskning',
          diffUrl: `https://laglig.se/laws/${wl.law.id}/changes/${change.id}?utm_source=email&utm_medium=weekly_digest&utm_campaign=weekly_digest`,
        }))
      )

      // Section 2: Discovery laws (industry starter pack NOT in workspace)
      const starterPackLaws = await prisma.law.findMany({
        where: {
          sniCodes: { has: workspace.sniCode },
          NOT: {
            id: {
              in: workspace.workspaceLaws.map((wl) => wl.law.id),
            },
          },
        },
        include: {
          lawChanges: {
            where: {
              detectedAt: { gte: oneWeekAgo },
            },
          },
        },
        take: 5,
      })

      const discoveryLaws = starterPackLaws
        .filter((law) => law.lawChanges.length > 0)
        .map((law) => ({
          id: law.id,
          sfsNummer: law.sfsNummer,
          rubrik: law.rubrik,
          changeCount: law.lawChanges.length,
          addToListUrl: `https://laglig.se/laws/${law.id}?action=add&utm_source=email&utm_medium=weekly_digest&utm_campaign=discovery`,
        }))

      // Skip if no changes in Sections 1 or 2
      if (workspaceChanges.length === 0 && discoveryLaws.length === 0) {
        skipped++
        continue
      }

      // Section 3: AI recommendations
      const aiRecommendations = await generateWeeklyRecommendations(
        workspace.id
      )

      // Send email
      try {
        await sendEmail({
          to: workspace.owner.email,
          subject: `Vecko√∂versikt: ${workspaceChanges.length + discoveryLaws.reduce((sum, law) => sum + law.changeCount, 0)} lag√§ndringar + nya rekommendationer`,
          react: WeeklyIndustryDigest({
            userName: workspace.owner.name || 'd√§r',
            workspaceName: workspace.name,
            workspaceChanges,
            discoveryLaws,
            aiRecommendations,
            unsubscribeUrl: `https://laglig.se/settings/notifications?unsubscribe=weekly_digest`,
          }),
        })

        emailsSent++
      } catch (error) {
        console.error(
          `Failed to send weekly digest to ${workspace.owner.email}:`,
          error
        )
      }
    }

    const duration = Date.now() - startTime

    return NextResponse.json({
      success: true,
      emailsSent,
      skipped,
      durationMs: duration,
    })
  } catch (error) {
    console.error('Weekly digest cron job failed:', error)
    return NextResponse.json(
      {
        error: 'Cron job failed',
        message: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    )
  }
}
```

**Vercel Cron Configuration:**

```json
// vercel.json (add to existing crons)
{
  "crons": [
    {
      "path": "/api/cron/send-weekly-digest",
      "schedule": "0 18 * * 0"
    }
  ]
}
```

**Reference:** PRD Epic 8 Story 8.7

## Testing

**Unit Tests:**

- Email template renders all 3 sections correctly
- Section 1 displays workspace changes
- Section 2 displays discovery laws with "Add to List" CTA
- Section 3 displays AI recommendations with reasons
- Empty sections are hidden gracefully

**Integration Tests:**

- Cron job queries changes from past 7 days
- Discovery laws filtered by SNI code
- AI recommendations generated with relevant laws
- Email sent only if ‚â•1 change in Sections 1 or 2
- Respects user notification preferences

**Manual Testing:**

- Create workspace with SNI code
- Add laws to workspace
- Create changes for workspace laws and starter pack laws
- Trigger cron job
- Verify email received with all 3 sections
- Click "Add to List" button, verify law added to workspace
- Click recommendation link, verify opens law page

**AI Testing:**

- Verify AI recommendations are relevant to workspace context
- Verify recommendations are not already in workspace
- Verify reasons are in Swedish and make sense
- Test with different industries (construction, healthcare, retail)

**Deliverability Testing:**

- Test email in Gmail, Outlook, Apple Mail
- Verify 3 sections visually distinct (different colors)
- Check spam score

**Performance Testing:**

- Cron job completes <10 minutes for 500 workspaces
- AI recommendation generation <5 seconds per workspace
- Email sending completes <1 second per email

**Edge Cases:**

- Workspace with no SNI code (skip Section 2)
- Workspace with all laws from starter pack (Section 2 empty)
- AI fails to generate recommendations (Section 3 empty)
- No changes in past week (skip email)

**Test File:** `__tests__/features/email-notifications/weekly-digest.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Review weekly digest to stay informed
- Click "Add to List" for relevant discovery laws
- Explore AI recommendations for missed laws
- Configure notification preferences if unwanted

**Developer Responsibility:**

- Send weekly digest every Sunday at consistent time
- Generate accurate AI recommendations based on context
- Filter discovery laws by industry (SNI code)
- Only send if changes occurred that week (avoid spam)
- Make email scannable with clear sections
- Provide actionable CTAs ("Add to List", "Read More")
- Track engagement on recommendations
- Respect user notification preferences
- Optimize AI calls for large user volumes
- Handle AI failures gracefully (empty Section 3)
- Ensure email renders correctly across clients
- Log sent emails for analytics

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
