# Story 8.7: Implement Weekly Industry Digest Email

## Status

Draft (v2 — rewritten to align with actual data model, LawList structure, and Claude AI)

## Story

**As a** workspace member,
**I want** to receive a weekly email summarizing law changes relevant to my workspace and industry,
**so that** I discover amendments to laws not yet in my list and get AI recommendations.

## Context & Dependencies

**Builds on:**

- Story 8.4 (Email Notifications) — daily digest pattern, Resend infrastructure
- `LawList` / `LawListItem` / `LegalDocument` — workspace law tracking
- `ChangeEvent` model — detected amendments
- `LawListTemplate` / `TemplateItem` — system templates per industry/domain (could serve as "starter pack" reference)
- `NotificationPreference` model — email preferences
- `lib/email/cron-notifications.ts` — existing Resend email patterns
- `lib/ai/prompts/document-content.ts` — proven Claude prompt patterns

**Depends on:**

- Story 8.4 (daily notification cron must exist as pattern reference)
- Story 8.8 (amendments should have summering/kommentar before weekly digest)

## Acceptance Criteria

### Weekly Digest Cron

1. New cron endpoint at `/api/cron/send-weekly-digest` runs Sundays at 17:00 UTC (18:00 CET)
2. `maxDuration = 300` with 30s timeout buffer
3. Email sent only if >= 1 relevant change detected that week

### Email Structure

4. **Section 1: "Aendringar i dina lagar"** — changes to laws in the workspace's LawLists this week
   - Each amendment: title, SFS number, summering (from LegalDocument.summary), kommentar
   - Grouped by priority (High -> Low)
   - Link to amendment page on Laglig.se
5. **Section 2: "Upptaeck relevanta lagar"** — amendments to laws from matching `LawListTemplate`s that are NOT in the workspace's LawLists
   - Show amendment count and law title
   - CTA: "Laegg till i min laglista"
6. **Section 3: "AI-rekommendationer"** — Claude-generated suggestions for 3-5 additional laws the workspace might need
   - Based on workspace's existing law list + domain context
   - Brief reason for each recommendation in Swedish
   - CTA: "Laes mer om denna lag"
7. Subject: "Veckooversikt: {N} lagaendringar + nya rekommendationer"
8. Unsubscribe link → notification preferences page

### Recipient Resolution

9. Query path: LawList → Workspace → WorkspaceMember → User
10. One email per workspace (not per user — workspace-level digest)
11. Skip if `NotificationPreference.email_enabled = false` for the user
12. Skip workspaces with no active members

### AI Recommendations (Section 3)

13. Use Anthropic Claude (Sonnet for speed) to generate recommendations
14. Context: workspace's existing law document_numbers, workspace domain/description
15. Candidate pool: LegalDocuments of type SFS_LAW not in workspace's LawLists
16. Output: 3-5 recommendations with Swedish-language reasons

## Tasks / Subtasks

- [ ] **Task 1: Create weekly digest cron route** (AC: 1, 2)
  - [ ] Create `app/api/cron/send-weekly-digest/route.ts`
  - [ ] Add to `vercel.json` crons: `"0 17 * * 0"` (17:00 UTC Sundays)
  - [ ] Auth check + timeout protection
- [ ] **Task 2: Section 1 — Workspace amendment changes query** (AC: 4)
  - [ ] Query ChangeEvents from past 7 days where document is in workspace's LawLists
  - [ ] Include amendment LegalDocument for summering/kommentar
- [ ] **Task 3: Section 2 — Template-based discovery** (AC: 5)
  - [ ] Find LawListTemplates matching workspace domain
  - [ ] Get TemplateItem documents NOT in workspace's LawLists
  - [ ] Check if any of those have ChangeEvents from past 7 days
- [ ] **Task 4: Section 3 — AI recommendations** (AC: 13, 14, 15, 16)
  - [ ] Build context from workspace's existing laws
  - [ ] Call Claude Sonnet with recommendation prompt
  - [ ] Parse 3-5 recommendations with reasons
- [ ] **Task 5: Build email template** (AC: 4, 5, 6, 7, 8)
  - [ ] HTML email with 3 sections
  - [ ] Follow existing email pattern from `lib/email/cron-notifications.ts`
- [ ] **Task 6: Recipient resolution + send** (AC: 9, 10, 11, 12, 3)
  - [ ] Query workspaces with relevant changes
  - [ ] Check NotificationPreference
  - [ ] Send via Resend
  - [ ] CronJobRun tracking

## Dev Notes

### Source Tree (relevant files)

```
app/api/cron/notify-amendment-changes/       — Story 8.4 daily cron (pattern reference)
lib/ai/prompts/document-content.ts           — Claude prompt patterns
lib/email/cron-notifications.ts              — Resend email infrastructure
prisma/schema.prisma                         — LawList, LawListItem, LawListTemplate, TemplateItem, ChangeEvent
```

### Key Data Models

```
Section 1 query:
  ChangeEvent (detected_at >= 7 days ago)
    → document_id → LegalDocument (base law)
      → LawListItem.document_id
        → LawList.workspace_id = current workspace

Section 2 query:
  LawListTemplate (domain matches workspace)
    → TemplateItem.document_id → LegalDocument
      → NOT IN workspace's LawListItem.document_id
      → HAS ChangeEvent in past 7 days

Section 3:
  Claude Sonnet prompt with workspace law context
  → Returns JSON: [{ document_number, title, reason }]
```

### AI Recommendation Prompt Pattern

```typescript
import Anthropic from '@anthropic-ai/sdk'

const response = await client.messages.create({
  model: 'claude-sonnet-4-20250514',
  max_tokens: 1024,
  messages: [{
    role: 'user',
    content: `Du ar en expert pa svensk lagstiftning. Baserat pa detta foretags laglista,
    rekommendera 3-5 ytterligare lagar de kan behova.

    Befintliga lagar: ${existingLaws.map(l => l.document_number + ': ' + l.title).join('\n')}

    Svara i JSON: [{ "document_number": "SFS ...", "title": "...", "reason": "..." }]`
  }]
})
```

### Timing Budget (5 min total)

- Section 1+2 queries: <10s
- AI recommendations: ~5s per workspace x max ~20 workspaces = ~100s
- Email rendering + sending: ~1s per workspace x ~20 = ~20s
- Buffer: 30s
- Total: well within 300s

## Testing

**Test location:** `tests/unit/lib/cron/send-weekly-digest.test.ts`

**Test framework:** Vitest with `vi.mock()` for Anthropic, Prisma, Resend

**Unit tests:**
- Section 1 correctly finds ChangeEvents for workspace laws from past 7 days
- Section 2 finds template laws NOT in workspace with recent changes
- Section 3 AI recommendations return valid JSON with reasons
- Email skipped if no changes in Sections 1 or 2
- NotificationPreference respected
- CronJobRun record created

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with LawList/TemplateItem models, Claude not OpenAI, actual email infra | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
