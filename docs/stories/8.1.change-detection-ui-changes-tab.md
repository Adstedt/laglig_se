# Story 8.1: Build Change Detection UI (Changes Tab)

## Status

Draft (v2 — rewritten to align with actual data model and amendment pipeline)

## Story

**As a** workspace member with laws in my law list,
**I want** a "Changes" tab showing all unacknowledged amendment changes to laws I track,
**so that** I can review updates, understand their impact, and stay compliant.

## Context & Dependencies

**Builds on:**

- `sync-sfs-updates` cron (runs 4:30 AM UTC) — detects amendments, creates `ChangeEvent` records with `change_type = AMENDMENT`
- `ChangeEvent` model — stores detected changes with `document_id` (base law), `amendment_sfs`, `ai_summary`, `diff_summary`, `notification_sent`
- `LawListItem` model — has `last_change_acknowledged_at` and `last_change_acknowledged_by` fields for tracking acknowledgment
- Story 8.8 (AI Content Enrichment) — ensures amendment LegalDocuments have summering + kommentar
- Story 12.3 content generation pipeline — `lib/ai/prompts/document-content.ts`

**Depends on:**

- Story 8.8 (for AI summaries and kommentar to display on cards)
- Story 8.3 (for "Mark as Reviewed" functionality — this story only renders the button, 8.3 wires it up)

## Acceptance Criteria

1. Law List page shows a "Changes" tab next to existing tabs
2. Changes tab shows all unacknowledged `ChangeEvent` records for `LegalDocument`s in the workspace's law lists
3. Each change displayed as a card:
   - Priority badge (High/Medium/Low) — derived from `ChangeEvent` or amendment metadata
   - Base law title + document number (from `LegalDocument`)
   - Amendment SFS number (from `ChangeEvent.amendment_sfs`)
   - Change detected date (from `ChangeEvent.detected_at`)
   - Change type badge (Amendment, Repeal, New Law, Metadata Update — from `ChangeEvent.change_type`)
   - AI Summering (from amendment's `LegalDocument.summary`) — neutral 2-3 sentence summary
   - Kommentar (from amendment's `LegalDocument.kommentar`) — "Vi ska..." compliance voice
   - "View Details" button → navigates to diff view (Story 8.2)
   - "Mark as Reviewed" button (Story 8.3 wires this up)
4. Changes sorted by priority (High → Medium → Low), then by `detected_at` desc
5. Unacknowledged count badge on "Changes" tab: "Changes (3)"
6. Empty state: "Inga olästa lagändringar" with checkmark
7. Filter by priority: "Show: All | High Priority | Medium | Low"

## Tasks / Subtasks

- [ ] **Task 1: Add "Changes" tab to Law List page** (AC: 1, 5)
  - [ ] Add tab navigation component with unacknowledged count badge
  - [ ] Query unacknowledged ChangeEvent count for badge
- [ ] **Task 2: Build ChangeEvent query for workspace** (AC: 2, 4)
  - [ ] Query path: `ChangeEvent` → `LegalDocument` (base law) → `LawListItem` → `LawList` (where workspace_id matches)
  - [ ] Filter: `ChangeEvent.detected_at > LawListItem.last_change_acknowledged_at` (or `last_change_acknowledged_at IS NULL`)
  - [ ] Include amendment's `LegalDocument` (via `ChangeEvent.amendment_sfs` → `LegalDocument.document_number`)
  - [ ] Sort by priority desc, detected_at desc
- [ ] **Task 3: Build ChangeCard component** (AC: 3)
  - [ ] Priority badge with color coding (shadcn/ui Badge)
  - [ ] Law title, document number, amendment SFS number
  - [ ] Detected date display
  - [ ] Change type badge
  - [ ] AI Summering paragraph (from amendment LegalDocument.summary)
  - [ ] Kommentar paragraph in highlighted box (from amendment LegalDocument.kommentar)
  - [ ] "View Details" and "Mark as Reviewed" action buttons
- [ ] **Task 4: Priority filter component** (AC: 7)
  - [ ] Client-side filter using URL search params
  - [ ] Filter options: All, High, Medium, Low
- [ ] **Task 5: Empty state component** (AC: 6)

## Dev Notes

### Source Tree (relevant files)

```
app/api/cron/sync-sfs-updates/route.ts     — Creates ChangeEvents (upstream)
lib/ai/prompts/document-content.ts          — Summering/kommentar generation
prisma/schema.prisma                        — ChangeEvent, LegalDocument, LawListItem, LawList models
```

### Key Data Models

```
ChangeEvent
  ├─ document_id → LegalDocument (BASE LAW)
  ├─ change_type: AMENDMENT | REPEAL | NEW_LAW | METADATA_UPDATE
  ├─ amendment_sfs: "SFS 2026:145"
  ├─ ai_summary, diff_summary
  ├─ detected_at
  └─ notification_sent: boolean

LegalDocument (amendment, content_type=SFS_AMENDMENT)
  ├─ document_number: "SFS 2026:145"
  ├─ title, summary (summering), kommentar
  └─ effective_date

Workspace resolution path:
  LegalDocument(base law).id
    → LawListItem.document_id
      → LawList.workspace_id
        → current workspace
```

### Priority Derivation

`ChangeEvent` currently has no `priority` field. Options for the dev agent:
1. **Add `priority` field to ChangeEvent** (ENUM: HIGH, MEDIUM, LOW) — set by sync-sfs-updates based on change_type + section count
2. **Derive at query time** from change_type (REPEAL=HIGH, AMENDMENT=MEDIUM, METADATA_UPDATE=LOW) and/or section change count

Recommendation: Add `priority` field to `ChangeEvent` schema for sort/filter performance.

### Unacknowledged Logic

A `ChangeEvent` is "unacknowledged" for a workspace if:
- `ChangeEvent.detected_at > LawListItem.last_change_acknowledged_at` (for the relevant LawListItem), OR
- `LawListItem.last_change_acknowledged_at IS NULL`

### UI Standards

- **shadcn/ui** for all components (mandatory per coding standards)
- Server component for data fetching, client component only for interactive filter
- Zod validation for any filter params

## Testing

**Test location:** `tests/unit/components/laws/changes-tab.test.tsx`

**Test framework:** Vitest with React Testing Library

**Unit tests:**
- ChangeCard renders priority badge with correct color
- ChangeCard displays summering and kommentar from amendment LegalDocument
- Priority filter updates URL search params
- Empty state renders when no unacknowledged changes
- Unacknowledged count badge displays correct number

**Integration tests:**
- Query correctly resolves ChangeEvents through LawListItem → LawList → Workspace path
- Filter by priority returns only matching changes
- Sort order: priority desc, then detected_at desc

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with actual data model (ChangeEvent, LegalDocument, LawListItem path), match 8.4 v2 style | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
