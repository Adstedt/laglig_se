# Story 8.1: Build Change Detection UI (Changes Tab)

## Status

Draft

## Story

**As a** user,
**I want** to see which laws in my list have changed,
**so that** I review updates and stay compliant.

## Acceptance Criteria

1. Law List page â†’ "Changes" tab (next to "All Laws" tab)
2. Changes tab shows all unacknowledged changes for laws in workspace
3. Each change displayed as card:
   - ðŸ”´/ðŸŸ¡/ðŸŸ¢ Priority badge (High/Medium/Low)
   - Law title, SFS number
   - Change detected date
   - Change type badge (Amendment, New Section, Repeal, Metadata Update)
   - AI Summary (1-2 sentences in plain Swedish): "This amendment extends parental leave to 18 months"
   - Business Impact (1 sentence): "Action required by Dec 1" or "FYI only - reference update"
   - "View Details" button â†’ Opens diff view
   - "Mark as Reviewed" button
4. Changes sorted by priority (High â†’ Medium â†’ Low), then by date
5. Unacknowledged count badge on "Changes" tab: "Changes (3)"
6. Empty state: "No unacknowledged changes âœ…"
7. Filter by priority: "Show: All | High Priority | Medium | Low"

## Tasks / Subtasks

- [ ] Create "Changes" tab in Law List page
- [ ] Build change card component
- [ ] Implement priority badge with colors
- [ ] Display AI summary and business impact
- [ ] Add "View Details" and "Mark as Reviewed" buttons
- [ ] Implement sorting by priority and date
- [ ] Add unacknowledged count badge to tab
- [ ] Create empty state component
- [ ] Implement priority filter
- [ ] Test with various change types
- [ ] Test mobile responsiveness

## Dev Notes

**Changes Tab Page:**

```typescript
// app/laws/changes/page.tsx
import { Suspense } from 'react'
import { Can } from '@/components/permissions/can'
import { Permission } from '@/lib/permissions/roles'
import { ChangesTab } from '@/components/laws/changes-tab'

export default function ChangesPage() {
  return (
    <Can permission={Permission.VIEW_LAWS}>
      <div className="max-w-7xl mx-auto p-6">
        <div className="mb-6">
          <h1 className="text-2xl font-bold">Law Changes</h1>
          <p className="text-sm text-gray-600 mt-1">
            Review updates to laws in your workspace
          </p>
        </div>

        <Suspense fallback={<ChangesSkeleton />}>
          <ChangesTab />
        </Suspense>
      </div>
    </Can>
  )
}
```

**Changes Tab Component:**

```typescript
// components/laws/changes-tab.tsx
import { prisma } from '@/lib/prisma'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { ChangeCard } from './change-card'
import { PriorityFilter } from './priority-filter'

export async function ChangesTab() {
  const changes = await withWorkspace(async ({ workspaceId }) => {
    return await prisma.lawChange.findMany({
      where: {
        law: {
          workspaceLaws: {
            some: { workspaceId }
          }
        },
        acknowledgedAt: null
      },
      include: {
        law: {
          select: {
            id: true,
            sfsNummer: true,
            rubrik: true
          }
        }
      },
      orderBy: [
        { priority: 'desc' }, // High -> Medium -> Low (asc would be opposite)
        { detectedAt: 'desc' }
      ]
    })
  })

  if (changes.length === 0) {
    return (
      <div className="text-center py-12 bg-white rounded-lg shadow">
        <svg className="mx-auto h-16 w-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <p className="mt-4 text-lg font-medium text-gray-900">No unacknowledged changes âœ…</p>
        <p className="text-sm text-gray-600 mt-1">
          All law changes have been reviewed. Check back later for updates.
        </p>
      </div>
    )
  }

  return (
    <div>
      {/* Priority Filter */}
      <PriorityFilter />

      {/* Changes List */}
      <div className="space-y-4 mt-6">
        {changes.map((change) => (
          <ChangeCard key={change.id} change={change} />
        ))}
      </div>
    </div>
  )
}
```

**Change Card Component:**

```typescript
// components/laws/change-card.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface ChangeCardProps {
  change: any
}

const PRIORITY_CONFIG = {
  high: { color: 'bg-red-100 text-red-800', icon: 'ðŸ”´', label: 'High Priority' },
  medium: { color: 'bg-yellow-100 text-yellow-800', icon: 'ðŸŸ¡', label: 'Medium Priority' },
  low: { color: 'bg-green-100 text-green-800', icon: 'ðŸŸ¢', label: 'Low Priority' }
}

const CHANGE_TYPE_CONFIG = {
  amendment: { label: 'Amendment', color: 'bg-blue-100 text-blue-800' },
  new_section: { label: 'New Section', color: 'bg-purple-100 text-purple-800' },
  repeal: { label: 'Repeal', color: 'bg-gray-100 text-gray-800' },
  metadata: { label: 'Metadata Update', color: 'bg-gray-100 text-gray-600' }
}

export function ChangeCard({ change }: ChangeCardProps) {
  const router = useRouter()
  const [isMarking, setIsMarking] = useState(false)

  const priorityConfig = PRIORITY_CONFIG[change.priority as keyof typeof PRIORITY_CONFIG]
  const typeConfig = CHANGE_TYPE_CONFIG[change.changeType as keyof typeof CHANGE_TYPE_CONFIG]

  async function handleMarkAsReviewed() {
    if (!confirm('Mark this change as reviewed?')) return

    setIsMarking(true)
    try {
      const response = await fetch(`/api/law-changes/${change.id}/acknowledge`, {
        method: 'POST'
      })

      if (response.ok) {
        router.refresh()
      } else {
        alert('Failed to mark as reviewed')
      }
    } catch (error) {
      alert('Failed to mark as reviewed')
    } finally {
      setIsMarking(false)
    }
  }

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
      {/* Header */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            {/* Priority Badge */}
            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityConfig.color}`}>
              <span className="mr-1">{priorityConfig.icon}</span>
              {priorityConfig.label}
            </span>

            {/* Change Type Badge */}
            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeConfig.color}`}>
              {typeConfig.label}
            </span>
          </div>

          <h3 className="text-lg font-semibold text-gray-900">
            {change.law.sfsNummer}: {change.law.rubrik}
          </h3>

          <p className="text-sm text-gray-500 mt-1">
            Detected {new Date(change.detectedAt).toLocaleDateString('sv-SE')}
          </p>
        </div>
      </div>

      {/* AI Summary */}
      <div className="mb-4">
        <p className="text-sm text-gray-900">{change.aiSummary}</p>
      </div>

      {/* Business Impact */}
      <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <p className="text-sm font-medium text-blue-900">
          <span className="font-semibold">Business Impact:</span> {change.businessImpact}
        </p>
      </div>

      {/* Actions */}
      <div className="flex gap-3">
        <button
          onClick={() => router.push(`/laws/${change.lawId}/changes/${change.id}`)}
          className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
        >
          View Details
        </button>
        <button
          onClick={handleMarkAsReviewed}
          disabled={isMarking}
          className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm disabled:bg-gray-100"
        >
          {isMarking ? 'Marking...' : 'Mark as Reviewed'}
        </button>
      </div>
    </div>
  )
}
```

**Priority Filter Component:**

```typescript
// components/laws/priority-filter.tsx
'use client'

import { useRouter, useSearchParams } from 'next/navigation'

export function PriorityFilter() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const currentFilter = searchParams.get('priority') || 'all'

  const filters = [
    { value: 'all', label: 'All' },
    { value: 'high', label: 'High Priority' },
    { value: 'medium', label: 'Medium' },
    { value: 'low', label: 'Low' }
  ]

  function handleFilterChange(value: string) {
    const params = new URLSearchParams(searchParams)
    if (value === 'all') {
      params.delete('priority')
    } else {
      params.set('priority', value)
    }
    router.push(`/laws/changes?${params.toString()}`)
  }

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div className="flex items-center gap-4">
        <span className="text-sm font-medium text-gray-700">Show:</span>
        <div className="flex gap-2">
          {filters.map((filter) => (
            <button
              key={filter.value}
              onClick={() => handleFilterChange(filter.value)}
              className={`px-3 py-1.5 rounded-lg text-sm ${
                currentFilter === filter.value
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {filter.label}
            </button>
          ))}
        </div>
      </div>
    </div>
  )
}
```

**Update Law List Navigation:**

```typescript
// components/laws/law-list-navigation.tsx
'use client'

import { usePathname } from 'next/navigation'
import Link from 'next/link'

export function LawListNavigation({ unacknowledgedCount }: { unacknowledgedCount: number }) {
  const pathname = usePathname()

  const tabs = [
    { href: '/laws', label: 'All Laws' },
    { href: '/laws/changes', label: 'Changes', badge: unacknowledgedCount }
  ]

  return (
    <div className="border-b border-gray-200 mb-6">
      <nav className="-mb-px flex gap-8">
        {tabs.map((tab) => (
          <Link
            key={tab.href}
            href={tab.href}
            className={`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${
              pathname === tab.href
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            {tab.label}
            {tab.badge !== undefined && tab.badge > 0 && (
              <span className="ml-2 bg-red-100 text-red-600 py-0.5 px-2 rounded-full text-xs font-medium">
                {tab.badge}
              </span>
            )}
          </Link>
        ))}
      </nav>
    </div>
  )
}
```

**Acknowledge API:**

```typescript
// app/api/law-changes/[id]/acknowledge/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'

export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  return withWorkspace(async ({ userId }) => {
    const lawChange = await prisma.lawChange.update({
      where: { id: params.id },
      data: {
        acknowledgedAt: new Date(),
        acknowledgedBy: userId,
      },
    })

    // Log activity (Epic 5.11)
    await prisma.workspaceActivity.create({
      data: {
        workspaceId: lawChange.law.workspaceLaws[0].workspaceId,
        userId,
        action: 'law_change_reviewed',
        resourceType: 'law_change',
        resourceId: lawChange.id,
      },
    })

    return NextResponse.json({ success: true })
  })
}
```

**Reference:** PRD Epic 8 Story 8.1, Competitive analysis (Notisum differentiators)

## Testing

**Unit Tests:**

- Priority badge displays correct color and icon
- Change type badge displays correct label
- AI summary renders correctly
- Business impact displays in highlighted box

**Integration Tests:**

- Changes tab shows only unacknowledged changes
- Changes sorted by priority (High â†’ Medium â†’ Low), then date
- Filter by priority works correctly
- Mark as reviewed removes change from list
- Unacknowledged count badge updates after marking reviewed

**Manual Testing:**

- View Changes tab, verify unacknowledged changes displayed
- Click "View Details", verify navigates to diff view
- Click "Mark as Reviewed", verify confirmation prompt
- Confirm marking, verify change disappears from list
- Filter by "High Priority", verify only high-priority changes shown
- Verify empty state displays when no unacknowledged changes
- Test on mobile, verify cards stack vertically

**Edge Cases:**

- No changes in workspace (empty state)
- 100+ unacknowledged changes (pagination needed?)
- Very long AI summary (truncate or wrap?)
- Change with no business impact (fallback text)

**Performance Testing:**

- Changes tab loads <500ms with 50 changes
- Marking as reviewed completes <300ms
- Priority filter instant (no API call)

**Test File:** `__tests__/features/law-changes/changes-tab.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Review changes regularly to stay informed
- Mark changes as reviewed after understanding impact
- Use priority filter to focus on urgent changes
- Escalate high-priority changes to relevant stakeholders

**Developer Responsibility:**

- Display changes clearly with priority and type indicators
- Generate accurate AI summaries and business impact assessments
- Sort changes by priority and date for easy review
- Provide "Mark as Reviewed" workflow to clear acknowledged changes
- Optimize query performance for large change volumes
- Make UI responsive and accessible
- Log all review actions for audit trail

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
