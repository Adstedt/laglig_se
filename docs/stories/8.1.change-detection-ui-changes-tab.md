# Story 8.1: Build Change Detection UI (Changes Tab)

## Status

Draft

## Story

**As a** workspace member with laws in my law lists,
**I want** a "Changes" tab on my law lists page showing all unacknowledged amendment changes to laws I track,
**so that** I can review updates, understand their impact, and stay compliant.

## Context & Dependencies

**Builds on:**

- `sync-sfs-updates` cron (04:30 UTC) — detects SFS amendments via publication monitoring, creates `ChangeEvent` records with `change_type` = AMENDMENT, REPEAL, NEW_LAW, or METADATA_UPDATE
- `ChangeEvent` model — stores detected changes with `document_id` (base law), `amendment_sfs`, `ai_summary`, `detected_at`, `notification_sent` [Source: prisma/schema.prisma:806]
- `LawListItem` model — has `last_change_acknowledged_at` and `last_change_acknowledged_by` fields for tracking acknowledgment [Source: prisma/schema.prisma:251-252]
- Story 8.15 (Done) — `createChangeNotifications()` creates `Notification` records per affected user, recipient resolution via `ChangeEvent.document_id` → `LawListItem` → `LawList` → `Workspace` → `WorkspaceMember` → `User` [Source: lib/notifications/amendment-notifications.ts]
- Story 8.4 (Done) — Daily email digest cron creates `Notification` records alongside emails
- Story 8.5 (Done) — In-app notification bell reads `Notification` records, marks as read
- Story 12.3 content generation pipeline — `lib/ai/prompts/document-content.ts` provides summering + kommentar on amendment `LegalDocument` records

**Depends on:**

- Story 8.15 (Done) — Notification infrastructure and recipient resolution
- Story 8.4 (Done) — ChangeEvent records are created and notification_sent is tracked

**Depended on by:**

- Story 8.3 (Mark as Reviewed) — wires up "Mark as Reviewed" button rendered by this story
- Story 8.10 (Effective Date Tracking) — adds effective date badges to the cards this story creates

**Epic 13 compatibility note:**

Epic 13 (SFS Sync Refactor) replaces the poll-and-diff sync mechanism with a publication-monitor approach. This story is unaffected — it consumes `ChangeEvent` records regardless of how they're created. The only documentation change: `diff_summary` on `ChangeEvent` will no longer be populated after Epic 13. This story never displays `diff_summary`, so no code impact. [Source: docs/epics/epic-13-sync-refactor.md, line 65-67]

## Acceptance Criteria

1. Law List page (`/laglistor`) shows a "Ändringar" tab next to the existing list tabs
2. Ändringar tab shows all unacknowledged `ChangeEvent` records for `LegalDocument`s in the workspace's law lists
3. Each change displayed as a card:
   - Priority badge (High/Medium/Low) — derived from `ChangeEvent.change_type` (see Priority Derivation below)
   - Base law title + document number (from `LegalDocument`)
   - Amendment SFS number (from `ChangeEvent.amendment_sfs`)
   - Change detected date (from `ChangeEvent.detected_at`)
   - Change type badge (Ändring, Upphävande, Ny lag, Metadata — from `ChangeEvent.change_type`)
   - AI Summering (from amendment's `LegalDocument.summary`) — neutral 2-3 sentence summary
   - Kommentar (from amendment's `LegalDocument.kommentar`) — "Vi ska..." compliance voice
   - "Visa detaljer" button → navigates to diff view (Story 8.2 — placeholder link for now)
   - "Markera som granskad" button (Story 8.3 wires this up — render disabled for now)
4. Changes sorted by priority (High → Medium → Low), then by `detected_at` desc
5. Unacknowledged count badge on "Ändringar" tab: "Ändringar (3)"
6. Empty state: "Inga olästa lagändringar" with checkmark icon
7. Filter by priority: "Visa: Alla | Hög prioritet | Medel | Låg"

## Tasks / Subtasks

- [ ] **Task 1: Add "Ändringar" tab to law list page** (AC: 1, 5)
  - [ ] Add tab navigation to `document-list-page-content.tsx` (or a new parent wrapper) with "Mina listor" (existing) and "Ändringar" tabs
  - [ ] Use shadcn/ui `Tabs` component for tab navigation
  - [ ] Query unacknowledged ChangeEvent count for badge using server action
  - [ ] Store active tab in URL search params (`?tab=changes`) for deep linking
  - [ ] Unit test: Tab renders, badge count displays correctly
- [ ] **Task 2: Build ChangeEvent query (server action)** (AC: 2, 4)
  - [ ] Create `app/actions/change-events.ts` with `getUnacknowledgedChanges(workspaceId)` server action
  - [ ] Query path: `ChangeEvent` → `LegalDocument` (base law) → `LawListItem` → `LawList` (where workspace_id matches)
  - [ ] Filter: `ChangeEvent.detected_at > LawListItem.last_change_acknowledged_at` (or `last_change_acknowledged_at IS NULL`)
  - [ ] Include amendment's `LegalDocument` (via `ChangeEvent.amendment_sfs` → `LegalDocument.document_number`) for summering/kommentar
  - [ ] Derive priority from change_type (REPEAL=HIGH, AMENDMENT=MEDIUM, NEW_LAW=MEDIUM, METADATA_UPDATE=LOW)
  - [ ] Sort by derived priority desc, detected_at desc
  - [ ] Create `getUnacknowledgedChangeCount(workspaceId)` for badge
  - [ ] Validate workspace access (auth check)
  - [ ] Unit test: Query logic with various filter combinations
- [ ] **Task 3: Build ChangeCard component** (AC: 3)
  - [ ] Create `components/features/changes/change-card.tsx`
  - [ ] Priority badge with color coding (shadcn/ui `Badge` — destructive for HIGH, default for MEDIUM, secondary for LOW)
  - [ ] Base law title + document number
  - [ ] Amendment SFS number
  - [ ] Detected date display using `date-fns` `formatDistanceToNow` with `sv` locale
  - [ ] Change type badge (map ChangeType enum → Swedish labels: AMENDMENT→"Ändring", REPEAL→"Upphävande", NEW_LAW→"Ny lag", METADATA_UPDATE→"Metadata")
  - [ ] AI Summering paragraph (from amendment `LegalDocument.summary`)
  - [ ] Kommentar paragraph in highlighted box (from amendment `LegalDocument.kommentar`)
  - [ ] "Visa detaljer" button (placeholder href to `/laglistor?tab=changes&diff={changeEventId}` — Story 8.2 wires this)
  - [ ] "Markera som granskad" button (rendered but `disabled` — Story 8.3 wires this)
  - [ ] Unit test: Card renders all fields correctly, priority badge colors
- [ ] **Task 4: Build ChangesTab container component** (AC: 2, 4, 6, 7)
  - [ ] Create `components/features/changes/changes-tab.tsx`
  - [ ] Fetch changes via server action
  - [ ] Render list of `ChangeCard` components
  - [ ] Empty state: "Inga olästa lagändringar" with `CheckCircle` icon (Lucide)
  - [ ] Loading state with shadcn/ui `Skeleton`
  - [ ] Unit test: Empty state renders, loading state renders
- [ ] **Task 5: Priority filter component** (AC: 7)
  - [ ] Create `components/features/changes/priority-filter.tsx`
  - [ ] Client-side filter using URL search params (`?priority=HIGH`)
  - [ ] Filter options: Alla, Hög, Medel, Låg
  - [ ] Use shadcn/ui `ToggleGroup` for filter buttons
  - [ ] Unit test: Filter updates URL params, correct items shown

## Dev Notes

### Source Tree (relevant files)

```
prisma/schema.prisma                                    — ChangeEvent (line 806), LawListItem (line 211), Notification (line 1042)
app/(workspace)/laglistor/page.tsx                      — Law list page (integration point for tabs)
components/features/document-list/document-list-page-content.tsx — Main client orchestrator for law list UI
components/features/document-list/document-list-switcher.tsx     — List selector (tab will sit alongside)
lib/notifications/amendment-notifications.ts             — Existing notification service (8.15)
app/api/cron/notify-amendment-changes/route.ts           — Cron that creates ChangeEvent + Notification records
lib/ai/prompts/document-content.ts                       — Summering/kommentar generation prompts
```

### Key Data Models

[Source: prisma/schema.prisma]

```
ChangeEvent (line 806)
  ├─ id: cuid
  ├─ document_id → LegalDocument (BASE LAW)
  ├─ content_type: ContentType
  ├─ change_type: ChangeType (AMENDMENT | REPEAL | NEW_LAW | METADATA_UPDATE)
  ├─ amendment_sfs: String? ("SFS 2026:145")
  ├─ ai_summary: Text?
  ├─ diff_summary: Text? (will stop being populated after Epic 13 — do NOT use)
  ├─ detected_at: DateTime
  ├─ processed_at: DateTime?
  └─ notification_sent: Boolean

LawListItem (line 211)
  ├─ id: uuid
  ├─ law_list_id → LawList
  ├─ document_id → LegalDocument
  ├─ last_change_acknowledged_at: DateTime? (line 251)
  └─ last_change_acknowledged_by: String? (line 252)

LegalDocument (amendment, looked up via ChangeEvent.amendment_sfs → LegalDocument.document_number)
  ├─ document_number: "SFS 2026:145"
  ├─ title, summary (summering), kommentar
  └─ effective_date

Workspace resolution path:
  ChangeEvent.document_id
    → LegalDocument(base law).id
      → LawListItem.document_id
        → LawList.workspace_id
          → current workspace
```

### Priority Derivation

[Source: docs/epics/epic-8-notifications.md, Phase 2 section]

`ChangeEvent` has no `priority` field. Derive at query time from `change_type`:

| change_type      | Priority | Rationale                              |
|------------------|----------|----------------------------------------|
| REPEAL           | HIGH     | Law no longer exists — urgent action   |
| AMENDMENT        | MEDIUM   | Sections changed — review needed       |
| NEW_LAW          | MEDIUM   | New law affecting tracked area         |
| METADATA_UPDATE  | LOW      | Minor metadata change                  |

Dev agent should add this as a computed field in the server action response, not a DB column. This keeps the query simple and avoids a schema migration. Story 8.12 (performance) can revisit if sorting at scale becomes an issue.

### Unacknowledged Logic

A `ChangeEvent` is "unacknowledged" for a workspace if:
- `ChangeEvent.detected_at > LawListItem.last_change_acknowledged_at` (for the relevant `LawListItem`), OR
- `LawListItem.last_change_acknowledged_at IS NULL`

The query joins through `ChangeEvent.document_id = LawListItem.document_id` to find law list items tracking the affected base law, then checks the acknowledgment timestamp.

### UI Integration Point

The law list page is at `app/(workspace)/laglistor/page.tsx`. It renders `DocumentListPageContent` which is a complex client component at `components/features/document-list/document-list-page-content.tsx`.

**Approach:** Add a tab wrapper above `DocumentListPageContent`. When "Ändringar" tab is active, render the new `ChangesTab` component instead of `DocumentListPageContent`. Use shadcn/ui `Tabs` with URL-driven state (`?tab=changes`).

### Previous Story Insights (8.5)

Story 8.5 (notification bell) established patterns for:
- Querying `Notification` records scoped to workspace + user [Source: completed/8.5]
- Using `date-fns` `formatDistanceToNow` with `{ locale: sv, addSuffix: true }` for Swedish relative times
- Using shadcn/ui `Popover` for dropdown UI
- Marking entities as read via server action

### Coding Standards

[Source: architecture/17-coding-standards.md]

- **shadcn/ui mandatory** for all UI components (Badge, Card, Tabs, Skeleton, ToggleGroup, Button)
- **Server Component for data fetching**, Client Component only for interactive filter
- **Zod validation** for any filter params
- **TypeScript strict mode** — no `any` types
- **Workspace isolation** — all queries must filter by workspace_id
- **Server Actions for mutations** — use `app/actions/` pattern
- **Import aliases** — use `@/components/`, `@/lib/`, `@/app/` paths

### Project Structure

[Source: architecture/12-unified-project-structure.md]

New files should follow feature-based organization:

```
components/features/changes/           — New feature folder
  ├─ change-card.tsx                   — Individual change card component
  ├─ changes-tab.tsx                   — Container for the changes list
  └─ priority-filter.tsx               — Priority filter toggle group
app/actions/change-events.ts           — Server actions for change queries
```

## Testing

**Test location:** `tests/unit/components/features/changes/`

**Test framework:** Vitest with React Testing Library [Source: architecture/3-tech-stack.md]

**Unit tests:**
- `change-card.test.tsx`:
  - ChangeCard renders priority badge with correct color (destructive for HIGH, default for MEDIUM, secondary for LOW)
  - ChangeCard displays summering and kommentar from amendment LegalDocument
  - ChangeCard shows correct Swedish change type label
  - ChangeCard renders detected date as relative Swedish time
  - "Markera som granskad" button renders disabled
- `changes-tab.test.tsx`:
  - Empty state renders "Inga olästa lagändringar" when no unacknowledged changes
  - Loading skeleton renders during data fetch
  - Changes sorted by priority then detected_at
  - Unacknowledged count badge displays correct number
- `priority-filter.test.tsx`:
  - Priority filter updates URL search params
  - Filter by HIGH returns only high-priority changes
  - "Alla" filter shows all changes

**Integration tests:**
- `tests/integration/actions/change-events.test.ts`:
  - `getUnacknowledgedChanges` correctly resolves ChangeEvents through LawListItem → LawList → Workspace path
  - Returns empty array when all changes acknowledged
  - Excludes ChangeEvents for documents not in any workspace law list
  - Sort order: priority desc, then detected_at desc

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with actual data model (ChangeEvent, LegalDocument, LawListItem path), match 8.4 v2 style | Sarah (PO) |
| 2026-02-17 | 3.0     | Full rewrite per create-next-story task: Epic 13 alignment (removed diff_summary references, broadened change_type context), enriched dev notes with actual schema line refs, integration point analysis, testing section, previous story insights from 8.5, architecture source references throughout | Bob (SM) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
