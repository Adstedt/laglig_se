# Story 6.11: Implement Notifications System

## Status

Draft

## Story

**As a** user,
**I want** to receive notifications for relevant compliance activities,
**so that** I stay informed and don't miss deadlines.

## Acceptance Criteria

**Notification Triggers:**

1. Task assigned to me
2. Task I'm assigned to is due in 3 days (configurable)
3. Task I'm assigned to is overdue
4. Comment on task I created or am assigned to
5. @mention in any comment
6. Status change on task I created
7. Weekly digest: "Du har 5 uppgifter att slutfora denna vecka"

**In-App Notifications:**

8. Bell icon in header with unread count badge
9. Dropdown panel shows recent notifications
10. Click notification -> Navigate to relevant modal
11. "Markera alla som lasta" action
12. Notifications persist for 30 days

**Email Notifications:**

13. Same triggers as in-app (user configurable)
14. Email template with action button (deep link)
15. Unsubscribe per notification type
16. Digest option: Immediate / Daily / Weekly / Off

**Settings:**

17. User preferences page for notification configuration
18. Toggle each notification type on/off
19. Choose email frequency per type

## Tasks / Subtasks

_To be detailed during sprint planning_

- [ ] Create notifications table
- [ ] Build notification service to create notifications
- [ ] Implement notification triggers in relevant actions
- [ ] Add bell icon to header with badge
- [ ] Build notification dropdown panel
- [ ] Implement "mark as read" functionality
- [ ] Create email notification templates
- [ ] Build notification preferences page
- [ ] Set up scheduled jobs for digest emails
- [ ] Implement due date reminders

## Dev Notes

### Data Model

```sql
notifications
  - id UUID PRIMARY KEY
  - user_id UUID REFERENCES users(id)
  - type VARCHAR(50)  -- 'task_assigned', 'due_soon', 'overdue', 'comment', 'mention', 'status_change'
  - title VARCHAR(255)
  - body TEXT
  - entity_type VARCHAR(50)
  - entity_id UUID
  - read_at TIMESTAMP
  - created_at TIMESTAMP

notification_preferences
  - id UUID PRIMARY KEY
  - user_id UUID REFERENCES users(id)
  - notification_type VARCHAR(50)
  - in_app_enabled BOOLEAN DEFAULT true
  - email_enabled BOOLEAN DEFAULT true
  - email_frequency VARCHAR(20)  -- 'immediate', 'daily', 'weekly', 'off'
```

### Email Templates

Use React Email templates in `emails/` directory:

- `task-assigned.tsx`
- `task-due-reminder.tsx`
- `comment-notification.tsx`
- `weekly-digest.tsx`

### File Locations

```
components/features/notifications/
  notification-bell.tsx
  notification-dropdown.tsx
  notification-item.tsx
app/(workspace)/settings/notifications/
  page.tsx
lib/services/
  notification-service.ts
emails/
  task-assigned.tsx
  ...
```

### Scheduled Jobs

Use Vercel Cron for:

- Daily due date check (3 days warning)
- Daily overdue check
- Weekly digest (Sunday 18:00 CET)

## Testing

- Unit tests for notification service
- E2E tests for bell icon and dropdown
- Test email delivery
- Test notification preferences

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-01-08 | 1.0     | Initial story creation | Sarah (PO) |
