# Story 11.2: Customer Overview Dashboard

## Status

Draft

## Story

**As an** admin,
**I want** to see a high-level overview of the platform's customers,
**so that** I can quickly understand platform health and growth.

## Acceptance Criteria

1. Dashboard page at `/admin/dashboard`
2. Metric cards displayed:
   - Total workspaces (with breakdown: Active, Paused, Deleted)
   - Total users
   - Subscription tier distribution (Trial, Solo, Team, Enterprise) as count per tier
   - New signups in the last 7 and 30 days (users created in those periods)
3. Recent workspaces table: last 10 created workspaces showing name, owner email, tier, status, created date
4. Recent users table: last 10 registered users showing name, email, last login, workspace count
5. Data fetched server-side via Prisma aggregate queries (no client-side fetching)
6. Page refreshes data on each visit (no caching — use `export const dynamic = 'force-dynamic'`)

## Tasks / Subtasks

- [ ] **Task 1: Create admin query utilities** (AC: 2, 3, 4, 5)
  - [ ] Create `lib/admin/queries.ts` with the following functions:
  - [ ] `getWorkspaceMetrics()` — returns `{ total, active, paused, deleted, byTier: Record<SubscriptionTier, number> }` using `prisma.workspace.groupBy()` and `prisma.workspace.count()`
  - [ ] `getUserMetrics()` — returns `{ total, newLast7Days, newLast30Days }` using `prisma.user.count()` with date filters
  - [ ] `getRecentWorkspaces(limit: number)` — returns last N workspaces with owner info:
    ```typescript
    prisma.workspace.findMany({
      take: limit,
      orderBy: { created_at: 'desc' },
      select: {
        id: true,
        name: true,
        slug: true,
        subscription_tier: true,
        status: true,
        created_at: true,
        owner: { select: { email: true, name: true } },
        _count: { select: { members: true } },
      },
    })
    ```
  - [ ] `getRecentUsers(limit: number)` — returns last N users with workspace count:
    ```typescript
    prisma.user.findMany({
      take: limit,
      orderBy: { created_at: 'desc' },
      select: {
        id: true,
        name: true,
        email: true,
        last_login_at: true,
        created_at: true,
        _count: { select: { workspaces: true } },
      },
    })
    ```

- [ ] **Task 2: Create metric card component** (AC: 2)
  - [ ] Create `components/admin/metric-card.tsx` — Server Component
  - [ ] Props: `title: string`, `value: number | string`, `description?: string`, `children?: React.ReactNode` (for sub-metrics)
  - [ ] Use shadcn/ui `Card`, `CardHeader`, `CardTitle`, `CardContent`
  - [ ] Support sub-items display (e.g. breakdown by status or tier) rendered as a small list inside the card

- [ ] **Task 3: Create dashboard page** (AC: 1, 2, 3, 4, 6)
  - [ ] Create `app/admin/(dashboard)/dashboard/page.tsx` — Server Component
  - [ ] Set `export const dynamic = 'force-dynamic'`
  - [ ] Fetch all metrics in parallel using `Promise.all()`:
    ```typescript
    const [workspaceMetrics, userMetrics, recentWorkspaces, recentUsers] =
      await Promise.all([
        getWorkspaceMetrics(),
        getUserMetrics(),
        getRecentWorkspaces(10),
        getRecentUsers(10),
      ])
    ```
  - [ ] Render metric cards in a responsive grid (2 cols on desktop, 1 on mobile)
  - [ ] Render recent workspaces as a simple HTML table (no TanStack Table needed for 10 rows)
  - [ ] Render recent users as a simple HTML table
  - [ ] Format dates using `date-fns` with Swedish locale (`sv`)
  - [ ] Format "last login" as relative time ("3 timmar sedan", "igår") using `formatDistanceToNow`

- [ ] **Task 4: Testing** (AC: all)
  - **Automated (Vitest)** — write in `tests/unit/lib/admin/queries.test.ts`:
  - [ ] Test: `getWorkspaceMetrics()` returns correct shape with groupBy counts
  - [ ] Test: `getUserMetrics()` returns correct date-filtered counts
  - [ ] Test: `getRecentWorkspaces()` returns workspaces ordered by created_at desc with owner info
  - [ ] Test: `getRecentUsers()` returns users ordered by created_at desc with workspace count
  - **Manual:**
  - [ ] Test: dashboard page loads with real data
  - [ ] Test: metrics are accurate against database
  - [ ] Test: page is responsive (mobile/desktop)

## Dev Notes

### Dependencies

- **Blocked by:** Story 11.1 (Admin Auth & Shell Layout) — requires admin auth and layout shell

### Architecture Context

This is a read-only dashboard page. All data is fetched server-side in a Server Component — no client-side state management needed. The admin query functions in `lib/admin/queries.ts` will be extended by Stories 11.3, 11.4, 11.6, and 11.7.

### Relevant Source Tree

```
app/admin/(dashboard)/
  dashboard/
    page.tsx                          # NEW: Dashboard page (replace placeholder from 11.1)

lib/admin/
  queries.ts                          # NEW: Admin Prisma query functions

components/admin/
  metric-card.tsx                     # NEW: Reusable metric display card

# REFERENCE FILES:
prisma/schema.prisma                  # Workspace model (line ~57): status, subscription_tier, owner relation
                                      # User model (line ~20): created_at, last_login_at
                                      # WorkspaceMember model (line ~103): user_id, workspace_id
lib/prisma.ts                         # Prisma client singleton — import { prisma } from '@/lib/prisma'
```

### Key Implementation Details

1. **Workspace metrics query.** Use two queries — `groupBy` for status breakdown and tier breakdown:

   ```typescript
   const [statusCounts, tierCounts, total] = await Promise.all([
     prisma.workspace.groupBy({ by: ['status'], _count: true }),
     prisma.workspace.groupBy({ by: ['subscription_tier'], _count: true }),
     prisma.workspace.count(),
   ])
   ```

2. **User date filtering.** Calculate dates server-side:

   ```typescript
   const now = new Date()
   const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
   const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)
   ```

3. **Date formatting.** Use `date-fns` with Swedish locale:

   ```typescript
   import { formatDistanceToNow, format } from 'date-fns'
   import { sv } from 'date-fns/locale'

   formatDistanceToNow(date, { addSuffix: true, locale: sv }) // "3 timmar sedan"
   format(date, 'yyyy-MM-dd', { locale: sv }) // "2026-01-31"
   ```

4. **Responsive grid.** Use Tailwind grid:

   ```tsx
   <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4">
     {/* metric cards */}
   </div>
   ```

5. **Simple tables.** For 10-row tables, use shadcn/ui `Table` component directly — no need for TanStack Table (that comes in 11.3/11.4).

### Coding Standards

- Server Components by default — no `'use client'` needed for this page [Source: architecture/17-coding-standards.md#17.3]
- Parallel data fetching with `Promise.all()` [Source: architecture/17-coding-standards.md#17.7]
- Selective field fetching with `select` (not `include` with all fields) [Source: architecture/17-coding-standards.md#17.7]
- shadcn/ui components for cards and tables [Source: architecture/17-coding-standards.md#17.3]
- Import path aliases: `@/lib/admin/queries`, `@/components/admin/metric-card` [Source: architecture/12-unified-project-structure.md#12.5]

### Testing

- **Test file location**: `tests/unit/lib/admin/queries.test.ts`
- **Testing framework**: Vitest [Source: architecture/17-coding-standards.md]
- **Mock strategy**: Mock `prisma` using Vitest mocks (`vi.mock('@/lib/prisma')`)
- **Manual**: Verify dashboard renders with real data, metrics are accurate

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-02-02 | 1.0     | Initial story creation | Sarah (PO) |
