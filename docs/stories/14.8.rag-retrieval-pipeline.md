# Story 14.8: RAG Retrieval Pipeline

## Status

Draft

## Story

As a compliance partner agent, I want to retrieve the most relevant context from all knowledge sources in a single query, so that my responses are grounded in accurate, company-specific information.

## Context & Dependencies

The retrieval pipeline is the core of the agent's intelligence. It combines vector similarity search with keyword matching, assembles context from multiple sources (laws, files, assessments), and manages the token budget to maximize relevance within model context limits. Workspace scoping is non-negotiable — never return another workspace's private data.

- **Builds on:** ContentChunk model (14.2) and embeddings pipeline (14.3) provide the searchable vector store, tool definitions (14.7) expose retrieval as agent tools
- **Depends on:** 14.2 (ContentChunk), 14.3 (embeddings), 14.7 (tools use retrieval)
- **Depended on by:** 14.9 (system prompt uses retrieval), 14.10 + 14.11 (UX surfaces retrieved context)

## Acceptance Criteria

### Core Retrieval

1. Unified retrieval function `retrieveContext(query, workspaceId, options)` in `lib/agent/retrieval.ts`
2. Vector similarity search across ContentChunk table using pgvector cosine distance
3. Workspace scoping: `WHERE (workspace_id IS NULL OR workspace_id = $workspaceId)` — never returns other workspace's private chunks
4. Returns chunks ranked by similarity score with metadata (sourceType, documentNumber, contextualHeader, path)
5. Supports filtering by sourceType (e.g., only LEGAL_DOCUMENT, only USER_FILE)
6. Supports filtering by contentType (e.g., only SFS_LAW, only AGENCY_REGULATION) via join to LegalDocument

### Hybrid Search

7. Optional keyword boost: when query contains specific legal references (e.g., "SFS 1977:1160", "3 kap. 5 §"), add exact-match keyword filter
8. Legal reference detection regex for Swedish law references

### Context Assembly

9. Context assembly function `assembleAgentContext(chunks, options)` — formats retrieved chunks into a prompt-ready context block
10. Token budget management: configurable max tokens (default 8000), prioritize highest-relevance chunks
11. Deduplication: if multiple chunks from the same document are retrieved, group them and sort by path (preserve document order)
12. Source attribution: each chunk in the assembled context includes its source reference for citation

### Performance

13. Retrieval latency < 500ms for top-20 chunks (measured via logging)
14. Query embedding cached for identical queries within same session (avoid redundant embedding calls)

### Testing

15. At least 10 unit tests covering retrieval, workspace scoping, context assembly, token budget

## Tasks / Subtasks

- [ ] **Task 1: Core retrieval** (AC: 1-6)
  - [ ] Create `lib/agent/retrieval.ts` with `retrieveContext()` function
  - [ ] Implement vector search via `prisma.$queryRaw` with parameterized templates
  - [ ] Add workspace scoping to all queries
  - [ ] Add sourceType and contentType filtering options
  - [ ] Return ranked results with similarity scores and full metadata

- [ ] **Task 2: Hybrid search** (AC: 7-8)
  - [ ] Create `lib/agent/legal-ref-detector.ts` with regex patterns for Swedish law references
  - [ ] Detect SFS numbers (e.g., "SFS 1977:1160", "1977:1160")
  - [ ] Detect chapter/section references (e.g., "3 kap. 5 §", "5 §")
  - [ ] When references detected, add keyword boost to retrieval query

- [ ] **Task 3: Context assembly** (AC: 9-12)
  - [ ] Create `lib/agent/context-assembly.ts` with `assembleAgentContext()` function
  - [ ] Implement token budget management (configurable max, default 8000)
  - [ ] Implement deduplication — group chunks from same document, sort by path
  - [ ] Format source attribution for each chunk in the assembled context
  - [ ] Output prompt-ready context block with Swedish source labels

- [ ] **Task 4: Performance** (AC: 13-14)
  - [ ] Add timing instrumentation to `retrieveContext()` with structured logging
  - [ ] Implement embedding cache (simple Map scoped to request lifecycle)
  - [ ] Verify latency target via logged timings

- [ ] **Task 5: Tests** (AC: 15)
  - [ ] Create `tests/unit/agent/retrieval.test.ts` — mock pgvector queries, test filtering, test workspace scoping
  - [ ] Create `tests/unit/agent/context-assembly.test.ts` — test token budget, deduplication, formatting
  - [ ] Create `tests/unit/agent/legal-ref-detector.test.ts` — test regex detection for various reference formats
  - [ ] Verify no cross-workspace data leakage in tests

## Dev Notes

- pgvector query pattern:
```sql
SELECT cc.*, 1 - (cc.embedding <=> $1::vector) AS similarity
FROM content_chunks cc
LEFT JOIN legal_documents ld ON cc.source_type = 'LEGAL_DOCUMENT' AND cc.source_id = ld.id::text
WHERE (cc.workspace_id IS NULL OR cc.workspace_id = $2)
  AND similarity > 0.5
ORDER BY similarity DESC
LIMIT $3
```
- Use `prisma.$queryRaw` with parameterized templates (same pattern as `change-events.ts`)
- Token counting: approximate with chars/4 or use `js-tiktoken` for accuracy
- Context assembly output format:
```
--- Kalla: Arbetsmiljolagen (SFS 1977:1160) > Kap 2 > 3 ss ---
Arbetsforhallandena skall anpassas till manniskans forutsattningar...

--- Kalla: Foretagets arbetsmiljopolicy.pdf > Sida 3 ---
Var policy for systematiskt arbetsmiljoarbete inkluderar...
```
- Legal reference regex: `/(?:SFS\s+)?(\d{4}:\d+)/g`, `/(\d+)\s*kap\.\s*(\d+[a-z]?)\s*§/g`
- Embedding the query: use same OpenAI text-embedding-3-small model as document embeddings (from `lib/chunks/embed-chunks.ts`)
- Source tree: `lib/agent/retrieval.ts` (new), `lib/agent/context-assembly.ts` (new), `lib/agent/legal-ref-detector.ts` (new), references `lib/chunks/embed-chunks.ts` (from 14.3)

## Testing

- Test files: `tests/unit/agent/retrieval.test.ts`, `tests/unit/agent/context-assembly.test.ts`, `tests/unit/agent/legal-ref-detector.test.ts`
- Mock `prisma.$queryRaw` for vector queries
- Test workspace scoping: verify no cross-workspace leakage
- Test token budget: 20 chunks at 500 tokens each should trim to fit 8000 budget
- Test deduplication: 5 chunks from same document should be grouped and ordered by path
- Vitest

## Change Log

| Date       | Version | Description                     | Author     |
| ---------- | ------- | ------------------------------- | ---------- |
| 2026-02-18 | 0.1     | Initial draft — story creation  | Dev Agent  |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
