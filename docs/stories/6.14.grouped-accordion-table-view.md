# Story 6.14: Grouped Accordion Tables for List View

## Status

Ready for Review

## Story

**As a** user viewing my law lists in table mode,
**I want** collapsible accordion sections grouping my documents just like in card view,
**so that** I can organize and navigate large lists efficiently while keeping the tabular data format I prefer.

## Acceptance Criteria

**Grouped Table Display:**

1. When table view is active and groups exist (no filters/search), render grouped accordion sections
2. Each group displays as a collapsible section with header containing: chevron toggle, folder icon, group name (clickable to filter), item count
3. Each collapsed group shows only the header row
4. Each expanded group shows a DocumentListTable with that group's items
5. "Ogrupperade" section appears at bottom for ungrouped items
6. Empty groups (0 items) still display as collapsible accordion headers with "0 dokument" badge
7. Fallback to flat table when: no groups exist, filters are active, search is active, or filtering by specific group

**Expand/Collapse Controls:**

8. Clicking chevron toggles individual group expand/collapse
9. "Visa alla" button expands all groups
10. "Dolj alla" button collapses all groups
11. Expand/collapse state persists using existing `expandedGroups` store state
12. State shared between card and table views (switching view preserves expand state)

**Drag-and-Drop Between Groups:**

13. Items can be dragged from one group's table to another group's header
14. Group header highlights when valid drop target during drag
15. Dropping on group header moves item to that group
16. Reordering within same group works via existing table row drag
17. Single outer DndContext wraps all sections (prevents nested DndContext issues)

**Column Visibility:**

18. "Grupp" column auto-hidden in grouped table mode (redundant information)
19. All other column visibility settings preserved
20. When falling back to flat table, "Grupp" column reappears if user had it enabled

**Bulk Actions:**

21. Bulk selection (checkboxes) works within each expanded group section independently
22. BulkActionBar appears when items selected within a section
23. Selecting items in multiple groups shows combined BulkActionBar

**Mobile Responsive:**

24. Group headers have 44px minimum touch targets
25. Expand/collapse buttons remain accessible on mobile
26. Table horizontally scrolls within each accordion section if needed

## Tasks / Subtasks

### Component Creation

- [x] **Task 1: Create GroupedDocumentListTable wrapper** (AC: 1, 7, 13, 16, 17, 21-23)
  - [x] Create `components/features/document-list/grouped-document-list-table.tsx`
  - [x] Accept same props as DocumentListTable plus group-related props
  - [x] Single outer DndContext for cross-group drag-and-drop
  - [x] Expand All / Collapse All header buttons
  - [x] Map groups to GroupTableSection components
  - [x] Ungrouped section at bottom with UNGROUPED_ID constant
  - [x] useMemo to compute groupedItems and ungroupedItems (reuse pattern from grouped-document-list.tsx)
  - [x] Track bulk selection state across sections for combined BulkActionBar

- [x] **Task 2: Create GroupTableSection component** (AC: 2, 3, 4, 5, 6, 8, 13, 14, 15, 24, 25)
  - [x] Create `components/features/document-list/group-table-section.tsx`
  - [x] Use Collapsible from shadcn/ui (consistent with card view)
  - [x] Header: chevron toggle, folder icon, group name (button to filter), item count badge
  - [x] Show empty groups with "0 dokument" badge and empty state message in content
  - [x] useDroppable on header for drag target (id: `group-header-{groupId}`)
  - [x] Visual feedback: `border-primary bg-primary/5` when drop target active
  - [x] CollapsibleContent renders DocumentListTable with filtered items (or empty state)
  - [x] Forward necessary table props (columnVisibility, onUpdateItem, etc.)
  - [x] 44px minimum touch targets for mobile accessibility

### Component Modifications

- [x] **Task 3: Update DocumentListTable for nested usage** (AC: 17, 18, 19, 20)
  - [x] Add optional `hideGroupColumn` prop (default: false)
  - [x] Add optional `disableDndContext` prop (default: false)
  - [x] When `disableDndContext=true`, skip DndContext wrapper (use parent's context)
  - [x] When `hideGroupColumn=true`, force group column visibility to false in effectiveColumnVisibility
  - [x] Ensure table still works standalone (backward compatible)

- [x] **Task 4: Update document-list-page-content.tsx** (AC: 1, 7, 11, 12)
  - Depends on: Tasks 1, 2, 3
  - [x] Import new GroupedDocumentListTable component
  - [x] Add conditional rendering logic:
    ```typescript
    const showGroupedTable =
      viewMode === 'table' &&
      groups.length > 0 &&
      !hasFiltersOrSearch &&
      !activeGroupFilter
    ```
  - [x] Render GroupedDocumentListTable when showGroupedTable is true
  - [x] Pass all required props: items, groups, expandedGroups, toggle/expand/collapse handlers
  - [x] Forward table-specific props (columnVisibility, onUpdateItem, workspaceMembers, etc.)
  - [x] Existing flat DocumentListTable renders when showGroupedTable is false

### Styling & UX

- [x] **Task 5: Ensure visual consistency with card view** (AC: 2, 9, 10, 24)
  - [x] Match GroupAccordion header styling from grouped-document-list.tsx
  - [x] Use same icons: ChevronDown/ChevronRight, Folder, FolderX (ungrouped)
  - [x] Same expand/collapse button styling and position
  - [x] Same item count badge format: "{n} dokument"
  - [x] Consistent spacing and responsive breakpoints

### Testing

- [x] **Task 6: Unit tests** (All ACs)
  - Depends on: Tasks 1-5
  - [x] Test GroupedDocumentListTable renders groups correctly
  - [x] Test empty groups display with "0 dokument" badge
  - [x] Test expand/collapse toggle works per group
  - [x] Test expand all / collapse all buttons
  - [x] Test column visibility respects hideGroupColumn
  - [x] Test fallback to flat table when conditions not met
  - [x] Test drag-and-drop between groups updates correctly
  - [x] Test bulk selection across multiple groups
  - [x] Target: 60-70% coverage for new components

## Dev Notes

### Existing Pattern Reference

The card view (`grouped-document-list.tsx`) provides the exact pattern to follow:

**Group computation (reuse this logic):**

```typescript
const { groupedItems, ungroupedItems, hasGroups } = useMemo(() => {
  const grouped: Record<string, DocumentListItem[]> = {}
  const ungrouped: DocumentListItem[] = []

  groups.forEach((group) => {
    grouped[group.id] = []
  })

  localItems.forEach((item) => {
    const groupItems = item.groupId ? grouped[item.groupId] : undefined
    if (groupItems) {
      groupItems.push(item)
    } else {
      ungrouped.push(item)
    }
  })

  return {
    groupedItems: grouped,
    ungroupedItems: ungrouped,
    hasGroups: groups.length > 0,
  }
}, [localItems, groups])
```

**Drop target for group headers:**

```typescript
const { setNodeRef } = useDroppable({
  id: `group-header-${groupId}`,
})
```

**Drag over tracking:**

```typescript
const handleDragOver = useCallback((event: DragOverEvent) => {
  const { over, active } = event
  if (!over) {
    setOverGroupId(null)
    return
  }

  const overId = over.id as string
  if (overId.startsWith('group-header-')) {
    const groupId = overId.replace('group-header-', '')
    setOverGroupId(groupId)
  }
}, [])
```

[Source: components/features/document-list/grouped-document-list.tsx]

### Store State (Already Available)

The document-list-store already has all needed state:

- `expandedGroups: Record<string, boolean>` - per-group expand state
- `toggleGroupExpanded(groupId)` - toggle single group
- `expandAllGroups()` - expand all
- `collapseAllGroups()` - collapse all
- `groups: ListGroupSummary[]` - group definitions with id, name, color

[Source: lib/stores/document-list-store.ts]

### DndContext Nesting Prevention

DocumentListTable currently wraps content in its own DndContext. When used inside GroupedDocumentListTable:

1. GroupedDocumentListTable provides the outer DndContext
2. DocumentListTable receives `disableDndContext={true}` to skip its wrapper
3. SortableContext per group still works (it doesn't create a new DndContext)

### File Locations

**New Files:**

```
components/features/document-list/
  grouped-document-list-table.tsx    # Main wrapper component
  group-table-section.tsx            # Collapsible section component
```

**Files to Modify:**

```
components/features/document-list/
  document-list-table.tsx            # Add hideGroupColumn, disableDndContext props
  document-list-page-content.tsx     # Add conditional rendering
```

### Conditional Rendering Logic

```typescript
// document-list-page-content.tsx (around line 683)
const showGroupedTable = viewMode === 'table' &&
  groups.length > 0 &&
  !hasFiltersOrSearch &&
  !activeGroupFilter

// In render:
{showGroupedTable ? (
  <GroupedDocumentListTable
    items={listItems}
    groups={groups}
    expandedGroups={expandedGroups}
    total={total}
    hasMore={hasMore}
    isLoading={isLoadingItems}
    columnVisibility={columnVisibility}
    onColumnVisibilityChange={setColumnVisibility}
    onLoadMore={loadMoreItems}
    onUpdateItem={handleUpdateItem}
    onBulkUpdate={handleTableBulkUpdate}
    onRemoveItem={removeItem}
    onReorderItems={reorderItems}
    onMoveToGroup={moveToGroup}
    onToggleGroup={toggleGroupExpanded}
    onExpandAll={expandAllGroups}
    onCollapseAll={collapseAllGroups}
    onFilterByGroup={handleFilterByGroup}
    onRowClick={handleOpenModal}
    workspaceMembers={workspaceMembers}
  />
) : viewMode === 'table' ? (
  <DocumentListTable ... />  // Existing flat table
) : (
  <GroupedDocumentList ... />  // Card view
)}
```

### Virtualization Consideration

- DocumentListTable has virtualization for >100 items (Story P.4)
- When grouped, each section will likely have <100 items
- Virtualization will activate per-section if a single group exceeds 100 items
- No changes needed to virtualization logic

## Testing

### Test File Location

```
tests/unit/components/features/document-list/
  grouped-document-list-table.test.tsx
  group-table-section.test.tsx
```

### Testing Standards

**Coverage Target:** 60-70% for new components (per architecture standards)

**Unit Tests (Vitest + React Testing Library):**

```typescript
describe('GroupedDocumentListTable', () => {
  it('renders group sections for each group', () => {
    const groups = [
      { id: '1', name: 'GDPR', color: 'blue' },
      { id: '2', name: 'Arbetsmiljo', color: 'green' },
    ]
    render(<GroupedDocumentListTable groups={groups} items={[]} ... />)
    expect(screen.getByText('GDPR')).toBeInTheDocument()
    expect(screen.getByText('Arbetsmiljo')).toBeInTheDocument()
  })

  it('renders empty groups with 0 dokument badge', () => {
    const groups = [{ id: '1', name: 'Empty Group', color: 'blue' }]
    render(<GroupedDocumentListTable groups={groups} items={[]} ... />)
    expect(screen.getByText('Empty Group')).toBeInTheDocument()
    expect(screen.getByText('0 dokument')).toBeInTheDocument()
  })

  it('toggles section expand/collapse on chevron click', async () => {
    render(<GroupedDocumentListTable ... />)
    const chevron = screen.getAllByRole('button', { name: /expandera|fÃ¤ll ihop/i })[0]
    await userEvent.click(chevron)
    expect(mockOnToggleGroup).toHaveBeenCalledWith('group-id')
  })

  it('falls back to flat table when no groups exist', () => {
    render(<GroupedDocumentListTable groups={[]} ... />)
    // Should render flat DocumentListTable, not grouped sections
    expect(screen.queryByText('Ogrupperade')).not.toBeInTheDocument()
  })

  it('shows combined BulkActionBar when items selected across groups', () => {
    // Test bulk selection spanning multiple groups
  })
})
```

### Manual Testing Checklist

1. Navigate to /laglistor with a list that has groups
2. Toggle to table view
3. Verify grouped sections appear with correct headers
4. Verify empty groups show with "0 dokument" badge
5. Test expand/collapse individual groups
6. Test "Visa alla" / "Dolj alla" buttons
7. Drag item from one group to another group's header
8. Click group name to filter to that group
9. Apply a search query - verify falls back to flat table
10. Clear search - verify grouped view returns
11. Switch to card view and back - verify expand state preserved
12. Select items in multiple groups - verify combined BulkActionBar appears
13. Test on mobile viewport (responsive headers, touch targets)

## Change Log

| Date       | Version | Description                                                                                                   | Author     |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------- | ---------- |
| 2026-01-27 | 1.0     | Initial story creation                                                                                        | Sarah (PO) |
| 2026-01-27 | 1.1     | Validation fixes: Added AC 6 (empty groups), AC 21-23 (bulk actions), task dependencies, test coverage target | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**New Files:**

- `components/features/document-list/grouped-document-list-table.tsx` - Main wrapper component for grouped table view
- `components/features/document-list/group-table-section.tsx` - Collapsible accordion section for individual groups
- `tests/unit/components/features/document-list/grouped-document-list-table.test.tsx` - Unit tests for GroupedDocumentListTable
- `tests/unit/components/features/document-list/group-table-section.test.tsx` - Unit tests for GroupTableSection

**Modified Files:**

- `components/features/document-list/document-list-table.tsx` - Added hideGroupColumn and disableDndContext props
- `components/features/document-list/document-list-page-content.tsx` - Added conditional rendering for grouped table view

### Debug Log References

N/A - No significant issues encountered during implementation.

### Completion Notes

- All 6 tasks completed successfully
- TypeScript compiles without errors
- 31 new unit tests pass (15 for GroupedDocumentListTable, 16 for GroupTableSection)
- Existing document-list tests pass (115 passed, 16 pre-existing failures unrelated to this story)
- Styling reuses exact patterns from grouped-document-list.tsx for consistency
- DndContext nesting issue solved via disableDndContext prop
- Column visibility automatically hides group column in grouped mode
