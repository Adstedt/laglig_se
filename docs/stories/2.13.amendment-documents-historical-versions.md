# Story 2.13: Amendment Documents & Historical Versions

## Status

In Progress

## Story

**As a** legal professional or citizen,
**I want** to see the complete amendment history of a law and view how it looked at any point in time,
**so that** I can understand how legislation has evolved and reference the correct version for a specific date.

## Background / Investigation Summary

### The Problem

Currently, Laglig.se only shows the **consolidated (gällande) version** of laws from Riksdagen's SFST database. However:

1. **Ändringsförfattningar** (amendment statutes like "SFS 2024:123 om ändring i...") are published as **separate documents** but don't exist as individual records in our database
2. **Historical versions** cannot be reconstructed because we only have the current consolidated text
3. The `Amendment` table has `amending_document_id` but it's often NULL because the amending document doesn't exist as a `LegalDocument`

### Key Discovery: Where Amendment Documents Live

| Source | Content | Format | Coverage |
|--------|---------|--------|----------|
| **rkrattsdb.gov.se** | Individual amendment PDFs | PDF | 1998-2018 |
| **svenskforfattningssamling.se** | Individual amendment PDFs | PDF | 2018→ |
| **Riksdagen SFS API** | Only consolidated text | HTML | Current only |
| **SFSR Register** | Metadata about amendments | - | All |

**Critical insight:** Amendment statutes (ändringsförfattningar) contain the **exact text changes** - e.g., "2 § ska ha följande lydelse: [new text]". By parsing these, we can:
1. Store amendment documents as proper `LegalDocument` records
2. Reconstruct historical versions by "undoing" amendments backwards

### SE-Lex Reference

The [SE-Lex project](https://github.com/se-lex) (MIT licensed) has solved this by:
- Downloading all amendment PDFs
- Parsing which paragraphs changed
- Building Git history where each commit = one amendment
- Result: Full historical versions back to 1998

## Acceptance Criteria

### Phase 1: Investigation & Data Model (Sprint 1)

1. **AC1:** Document the exact structure of amendment PDFs from rkrattsdb.gov.se and svenskforfattningssamling.se
2. **AC2:** Implement approved schema changes (per Architect Decision 2025-12-10):
   - Add `SFS_AMENDMENT` to `ContentType` enum in `prisma/schema.prisma`
   - Run Prisma migration to apply the change
   - Amendment documents stored as `LegalDocument` records with `content_type: SFS_AMENDMENT`
   - Link to base law via existing `Amendment.amending_document_id` FK
3. **AC3:** Prototype PDF parsing for 5 sample amendments to extract:
   - Which paragraphs are amended/repealed/added
   - The old vs new text for each paragraph
   - Effective date (ikraftträdande)
4. **AC4:** Reference SE-Lex parsing patterns for insights on amendment structure detection (own pipeline, no data import per Architect Decision 3)

### Phase 2: Amendment Document Ingestion (Sprint 2)

5. **AC5:** Crawl ALL SFS documents from both sources (not just amendments):
   - svenskforfattningssamling.se (2018+): ~10,500 documents
   - rkrattsbaser.gov.se/sfsr (1998-2017): ~30,000 documents
   - Extract: SFS number, title, PDF URL for each document
6. **AC6:** Classify documents by title pattern:
   - **Amendment:** title contains `om ändring i` → parse with LLM
   - **Repeal:** title contains `om upphävande av` → parse to identify what's repealed
   - **New law:** no amendment pattern → store PDF only, skip section parsing
   - Expected ratio: ~85% amendments, ~15% new laws
7. **AC7:** Store ALL PDFs in **Supabase Storage** bucket (`sfs-pdfs/`):
   - Path format: `sfs-pdfs/{YYYY}/SFS{YYYY}-{NNNN}.pdf`
   - Store both amendments AND new laws (completeness, user downloads)
   - Enable signed URLs for user downloads
8. **AC8:** LLM-assisted parsing for amendments only:
   - Use `unpdf` for text extraction
   - Use Claude (claude-sonnet-4) for complex pattern recognition
   - Handle: section ranges, multi-section lists, renumbering
   - Expected accuracy: 90%+ section detection
9. **AC9:** Implement normalized data model:
   - `AmendmentDocument` table: PDF metadata, full text, processing status
   - `SectionChange` table: Individual section changes with chapter/section/changeType
   - Link amendments to base laws via `baseLawSfs` field

### Phase 3: Historical Version Reconstruction (Sprint 3)

10. **AC10:** Implement algorithm to reconstruct law text at any historical date by:
    - Starting with current consolidated text
    - "Undoing" each amendment backwards to target date
11. **AC11:** Store reconstructed versions in `DocumentVersion` table
12. **AC12:** Create UI component: "Visa version från [datum]" date picker
13. **AC13:** Create UI component: Diff view comparing two versions

### Phase 4: Markdown Generation (Optional/Parallel)

14. **AC14:** Create HTML → Markdown converter following SE-Lex format conventions:
    - YAML frontmatter (beteckning, rubrik, departement, etc.)
    - Heading hierarchy: `## Kap`, `### Avdelning`, `#### §`
    - Internal links: `[2 §](#kap1.2)`
    - External links: Swedish laws to selex.se/eli, EU laws to eur-lex.europa.eu
15. **AC15:** Store markdown in new `markdown_content` column for RAG optimization

## Tasks / Subtasks

### Phase 1: Investigation

- [x] **Task 1.1:** Download and analyze 10 sample amendment PDFs from different years (AC: 1)
  - [x] 5 from rkrattsdb.gov.se (1998-2018 era)
  - [x] 5 from svenskforfattningssamling.se (2018+ era)
  - [x] Document structure variations in `docs/research/amendment-pdf-structure.md`
  - [x] Create `tests/fixtures/amendment-pdfs/` directory with sample PDFs for unit tests

- [x] **Task 1.2:** Implement data model changes (AC: 2)
  - [x] Add `SFS_AMENDMENT` to ContentType enum in schema.prisma
  - [x] Run migration
  - [x] Document: Amendment SFS numbers (e.g., SFS 2024:123) stored as `document_number` with `content_type: SFS_AMENDMENT`

- [x] **Task 1.3:** Prototype PDF parsing (AC: 3)
  - [x] Test pdf-parse, pdf2json, or similar libraries → Used `unpdf` library
  - [x] Handle OCR for older scanned PDFs (tesseract.js?) → Not needed, text-based PDFs work well
  - [x] Extract structured change information → Created `lib/external/pdf-parser.ts`

- [x] **Task 1.4:** SE-Lex pattern research (AC: 4)
  - [x] Review SE-Lex parsing approach for amendment detection patterns
  - [x] Document useful regex/heuristics for Swedish amendment formats
  - [x] No data import - insights only for own pipeline

### Phase 2: Ingestion Pipeline

- [ ] **Task 2.1:** Build index crawler (AC: 5)
  - [ ] svenskforfattningssamling.se crawler (2018+):
    - Browse `https://svenskforfattningssamling.se/regulations/{YYYY}/index.html`
    - Extract: SFS number, title, PDF URL
  - [ ] rkrattsbaser.gov.se/sfsr crawler (1998-2017):
    - Query `?LimitSFSNUM={YYYY}:1&LimitSFSNUM2={YYYY}:9999`
    - Extract: SFS number, title
    - Construct PDF URL from SFS number
  - [ ] Rate limiting (1 req/sec) and error handling
  - [ ] Store crawl results in database or JSON for processing

- [ ] **Task 2.2:** Document classifier (AC: 6)
  - [ ] Implement `classifyDocument(title: string)` function:
    ```typescript
    type DocType = 'amendment' | 'repeal' | 'new_law'
    // "om ändring i" → amendment
    // "om upphävande av" → repeal
    // else → new_law
    ```
  - [ ] Unit tests for classification patterns

- [ ] **Task 2.3:** Supabase Storage setup (AC: 7)
  - [ ] Create `sfs-pdfs` bucket (all documents, not just amendments)
  - [ ] Implement upload function with path: `{YYYY}/SFS{YYYY}-{NNNN}.pdf`
  - [ ] Generate signed URLs for user downloads
  - [ ] Estimated storage: ~40,000 PDFs × 500KB = ~20GB

- [ ] **Task 2.4:** PDF downloader (AC: 5, 7)
  - [ ] Download PDFs from both sources
  - [ ] Upload to Supabase Storage
  - [ ] Track download status in database
  - [ ] Resume capability for interrupted downloads

- [ ] **Task 2.5:** LLM-assisted parsing pipeline (AC: 8)
  - [ ] **Only parse amendments** (skip new laws)
  - [ ] Use existing `lib/external/llm-amendment-parser.ts`
  - [ ] Handle section ranges (e.g., "15–20 §§" → 6 entries)
  - [ ] Handle multi-section lists (e.g., "2 och 5 §§" → 2 entries)
  - [ ] Handle renumbering (e.g., "X § blir Y §")
  - [ ] Batch processing with rate limiting (5 concurrent, 1s pause)
  - [ ] Confidence scoring for review flagging
  - [ ] Estimated: ~34,000 amendments × $0.017 = ~$580 LLM cost

- [ ] **Task 2.6:** Database schema migration (AC: 9)
  - [ ] Add `AmendmentDocument` model (see `docs/research/amendment-data-model.md`)
  - [ ] Add `SectionChange` model with normalized structure
  - [ ] Add enums: `ParseStatus`, `ChangeType`
  - [ ] Run Prisma migration

- [ ] **Task 2.7:** Ingestion orchestration script
  - [ ] `scripts/ingest-sfs-documents.ts` - Full pipeline
  - [ ] Progress tracking and logging
  - [ ] Error recovery and retry logic
  - [ ] Separate modes: `--crawl`, `--download`, `--parse`

### Phase 3: Historical Versions

- [ ] **Task 3.1:** Version reconstruction algorithm (AC: 10)
  - [ ] Implement `getLawVersionAtDate(baseLawSfs, asOfDate)` function
  - [ ] Start with current consolidated text from Riksdagen API
  - [ ] Query `SectionChange` table for amendments after target date
  - [ ] Apply reverse changes (see `docs/research/amendment-data-model.md`):
    - `new` → remove section
    - `repealed` → restore section (using oldText)
    - `amended` → restore old version (using oldText)
    - `renumbered` → reverse the renumbering
  - [ ] Handle edge cases: transitional provisions, future effective dates

- [ ] **Task 3.2:** Section history queries (AC: 10, 11)
  - [ ] Implement `getSectionHistory(baseLawSfs, chapter, section)` function
  - [ ] Return chronological list of changes with dates and descriptions
  - [ ] Support for "show me all changes to 7 kap. 15 §" queries

- [ ] **Task 3.3:** Diff generation (AC: 10)
  - [ ] Implement `generateDiff(baseLawSfs, fromDate, toDate)` function
  - [ ] Identify added, removed, and changed sections
  - [ ] Use `diff` npm package for line-level comparison

- [ ] **Task 3.4:** Store reconstructed versions (AC: 11)
  - [ ] Write key historical versions to `DocumentVersion` table
  - [ ] Link versions to source amendments via `amendment_sfs` field
  - [ ] Batch processing script: `scripts/generate-historical-versions.ts`
  - [ ] Consider materialized vs on-demand tradeoff (per Architect Decision 4)

- [ ] **Task 3.5:** UI Components (AC: 12, 13) - Depends on Task 3.4 completion
  - [ ] Date picker for historical view (`VersionDatePicker.tsx`)
  - [ ] Diff viewer component (`VersionDiffView.tsx`)
  - [ ] Version timeline component (`VersionTimeline.tsx`)
  - [ ] Section history panel component
  - [ ] Integration with law page at `/lagar/[id]/version/[date]`

### Phase 4: Markdown (Parallel track)

- [ ] **Task 4.1:** HTML → Markdown converter (AC: 14)
  - [ ] YAML frontmatter generation
  - [ ] Heading hierarchy conversion
  - [ ] Internal/external link generation

- [ ] **Task 4.2:** Schema + storage (AC: 15)
  - [ ] Add `markdown_content` column to `LegalDocument` (if not exists)
  - [ ] Store markdown alongside HTML for RAG optimization

## Dev Notes

### Relevant Source Tree

```
laglig_se/
├── lib/
│   └── external/
│       ├── riksdagen.ts          # Existing - extend for amendment parsing
│       ├── pdf-parser.ts         # NEW - PDF text extraction
│       ├── amendment-extractor.ts # NEW - Parse amendment structure
│       └── historical-versions.ts # NEW - Version reconstruction logic
├── scripts/
│   ├── ingest-amendment-pdfs.ts  # NEW - PDF download & ingestion
│   └── generate-historical-versions.ts # NEW - Batch reconstruction
├── components/
│   └── features/
│       └── law-versions/         # NEW - UI components (Phase 3)
│           ├── VersionDatePicker.tsx
│           ├── VersionDiffView.tsx
│           └── VersionTimeline.tsx
├── docs/
│   └── research/
│       └── amendment-pdf-structure.md  # NEW - Phase 1 deliverable
├── app/
│   └── (public)/
│       └── lagar/
│           └── [id]/
│               └── version/      # NEW ROUTE - Phase 3
│                   └── [date]/
│                       └── page.tsx  # NEW FILE
└── tests/
    ├── unit/lib/external/
    │   ├── pdf-parser.test.ts
    │   └── amendment-extractor.test.ts
    ├── integration/scripts/
    │   └── amendment-ingestion.test.ts
    ├── e2e/
    │   └── historical-versions.spec.ts
    └── fixtures/
        └── amendment-pdfs/       # Sample PDFs for testing
```

### Data Sources (Verified 2025-12-10)

**Primary - svenskforfattningssamling.se (2018+):**
- **Index page:** `https://svenskforfattningssamling.se/`
- **Document HTML:** `https://svenskforfattningssamling.se/doc/{YYYYNNNN}.html` (e.g., `doc/20251461.html`)
- **PDF download:** `https://svenskforfattningssamling.se/sites/default/files/sfs/{YYYY-MM}/SFS{YYYY}-{NNNN}.pdf`
  - Example: `https://svenskforfattningssamling.se/sites/default/files/sfs/2025-12/SFS2025-1461.pdf`
- **File size:** ~455KB average per PDF
- **Rate limit:** No official limit documented; use 1 req/sec (conservative, respectful)
- **Authentication:** None required (public access)

**Primary - rkrattsbaser.gov.se (1998-2018):**
- **Note:** Migrating from rkrattsdb.gov.se to rkrattsbaser.gov.se
- **PDF collection:** `/sfspdf` path (structure TBD in Phase 1 investigation)
- **Rate limit:** Use 1 req/sec (conservative)
- **Authentication:** None required

**Metadata:**
- SFSR register for amendment metadata (cross-reference validation)

**Reference (MIT Licensed - Verified):**
- SE-Lex GitHub: https://github.com/se-lex/sfs (MIT license, copyright Martin Rimskog 2025)
- Their markdown format is well-structured for RAG
- Reference only - no data import per Architect Decision 3

### Document Discovery Strategy

**Problem:** How do we find ALL SFS documents (amendments + new laws)?

**Solution:** Crawl index pages from both sources, classify by title pattern.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  SOURCES                                                                     │
│                                                                             │
│  svenskforfattningssamling.se (2018-2025)                                   │
│  └─ /regulations/{YYYY}/index.html → HTML table with SFS#, title, PDF URL  │
│  └─ ~1,500 documents/year × 7 years = ~10,500 documents                    │
│                                                                             │
│  rkrattsbaser.gov.se/sfsr (1998-2017)                                       │
│  └─ ?LimitSFSNUM={YYYY}:1&LimitSFSNUM2={YYYY}:9999 → Search results        │
│  └─ ~1,500 documents/year × 20 years = ~30,000 documents                   │
│                                                                             │
│  TOTAL: ~40,000 documents                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  CLASSIFICATION (by title pattern)                                          │
│                                                                             │
│  function classifyDocument(title: string): DocType {                        │
│    if (title.includes('om ändring i')) return 'amendment'    // ~85%       │
│    if (title.includes('om upphävande av')) return 'repeal'   // ~2%        │
│    return 'new_law'                                          // ~13%       │
│  }                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
              ┌──────────┐   ┌──────────┐   ┌──────────┐
              │ AMENDMENT│   │  REPEAL  │   │ NEW LAW  │
              │ ~34,000  │   │  ~800    │   │ ~5,200   │
              └────┬─────┘   └────┬─────┘   └────┬─────┘
                   │              │              │
                   ▼              ▼              ▼
              ┌──────────────────────────────────────┐
              │ ALL: Download PDF → Supabase Storage │
              │ Path: sfs-pdfs/{YYYY}/SFS{YYYY}-{N}.pdf │
              └──────────────────────────────────────┘
                   │              │              │
                   ▼              ▼              │
              ┌────────────────────────┐         │
              │ PARSE with LLM         │         │
              │ → Extract sections     │    ┌────┴────┐
              │ → Store in database    │    │ SKIP    │
              │ Cost: ~$580 total      │    │ parsing │
              └────────────────────────┘    └─────────┘
```

**Key Insight:** ~85% of SFS documents are amendments. We store ALL PDFs for completeness and user downloads, but only parse amendments with the LLM.

### Amendment Ingestion Pipeline (Detailed Flow)

**Example: Processing SFS 2022:1109 (amendment to Arbetsmiljölagen)**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: Crawl Index Page                                                   │
│                                                                             │
│  svenskforfattningssamling.se/regulations/2022/index.html                   │
│                                                                             │
│  Extract row:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ SFS Number │ Title                                        │ PDF URL │   │
│  │────────────│──────────────────────────────────────────────│─────────│   │
│  │ 2022:1109  │ Lag om ändring i arbetsmiljölagen (1977:1160)│ [link]  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: Classify by Title                                                  │
│                                                                             │
│  classifyDocument("Lag om ändring i arbetsmiljölagen (1977:1160)")         │
│                                                                             │
│  Title contains "om ändring i" → type: 'amendment'                         │
│  Extract base law: "1977:1160" (arbetsmiljölagen)                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: Download PDF & Store in Supabase                                   │
│                                                                             │
│  Source: https://svenskforfattningssamling.se/sites/default/files/sfs/     │
│          2022-06/SFS2022-1109.pdf                                          │
│                                                                             │
│  Upload to Supabase Storage:                                                │
│  Bucket: sfs-pdfs                                                           │
│  Path:   2022/SFS2022-1109.pdf                                             │
│  URL:    https://xxx.supabase.co/storage/v1/object/public/sfs-pdfs/...     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 4: Extract Text (unpdf)                                               │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ "Härigenom föreskrivs i fråga om arbetsmiljölagen (1977:1160)      │   │
│  │  dels att 1 kap. 2 § och 9 kap. 2 och 5 §§ ska ha följande        │   │
│  │  lydelse, dels att det ska införas ett nytt kapitel, 7 kap.,       │   │
│  │  med följande lydelse. ...                                         │   │
│  │                                                                      │   │
│  │  Denna lag träder i kraft den 25 juli 2022."                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 5: LLM-Assisted Parsing (Claude)                                      │
│                                                                             │
│  Send to Claude with structured prompt → Returns JSON:                      │
│                                                                             │
│  {                                                                          │
│    "baseLaw": { "name": "arbetsmiljölagen", "sfsNumber": "1977:1160" },    │
│    "effectiveDate": "2022-07-25",                                          │
│    "affectedSections": [                                                    │
│      { "chapter": "1", "section": "2", "changeType": "amended" },          │
│      { "chapter": "9", "section": "2", "changeType": "amended" },          │
│      { "chapter": "9", "section": "5", "changeType": "amended" },          │
│      { "chapter": "7", "section": "15", "changeType": "new" },             │
│      { "chapter": "7", "section": "16", "changeType": "new" },             │
│      { "chapter": "7", "section": "17", "changeType": "new" },             │
│      { "chapter": "7", "section": "18", "changeType": "new" },             │
│      { "chapter": "7", "section": "19", "changeType": "new" },             │
│      { "chapter": "7", "section": "20", "changeType": "new" }              │
│    ],                                                                       │
│    "confidence": 0.95                                                       │
│  }                                                                          │
│                                                                             │
│  Note: LLM correctly expands "7 kap." into 6 individual sections!          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 6: Database Storage (Normalized)                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ AmendmentDocument                                                    │   │
│  │ - id: "clx123abc"                                                   │   │
│  │ - sfsNumber: "2022:1109"                                            │   │
│  │ - baseLawSfs: "1977:1160"                                           │   │
│  │ - baseLawName: "arbetsmiljölagen"                                   │   │
│  │ - title: "Lag om ändring i arbetsmiljölagen (1977:1160)"           │   │
│  │ - effectiveDate: 2022-07-25                                         │   │
│  │ - storagePath: "2022/SFS2022-1109.pdf"                              │   │
│  │ - fullText: [extracted text]                                        │   │
│  │ - parseStatus: COMPLETED                                            │   │
│  │ - confidence: 0.95                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                         │                                                   │
│                         ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ SectionChange (9 rows)                                               │   │
│  │                                                                      │   │
│  │ │ chapter │ section │ changeType │ description                    │ │   │
│  │ │─────────│─────────│────────────│────────────────────────────────│ │   │
│  │ │ 1       │ 2       │ amended    │ Scope extended                 │ │   │
│  │ │ 9       │ 2       │ amended    │ Appeal procedures modified     │ │   │
│  │ │ 9       │ 5       │ amended    │ Immediate effect extended      │ │   │
│  │ │ 7       │ 15      │ new        │ Market surveillance provisions │ │   │
│  │ │ 7       │ 16      │ new        │ Authority powers               │ │   │
│  │ │ 7       │ 17      │ new        │ Injunctions                    │ │   │
│  │ │ 7       │ 18      │ new        │ Penalty fees                   │ │   │
│  │ │ 7       │ 19      │ new        │ Police assistance              │ │   │
│  │ │ 7       │ 20      │ new        │ Confidentiality                │ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 7: Link to Base Law                                                   │
│                                                                             │
│  Update existing Amendment record (from SFSR metadata):                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Amendment                                                            │   │
│  │ - base_document_id: [1977:1160 LegalDocument.id]                    │   │
│  │ - amending_document_id: NULL → [link to AmendmentDocument]          │   │
│  │ - effective_date: 2022-07-25                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Now we can query: "Show all amendments to arbetsmiljölagen" or            │
│  "What changed in 7 kap. 15 §?" with full section-level detail.            │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Key Points:**
- **Crawl first, download second** - we build an index of all documents before downloading
- **Classify by title** - "om ändring i" = amendment, skip LLM parsing for new laws
- **Store ALL PDFs** - in Supabase for reliability and user downloads
- **LLM parsing** - handles complex patterns regex can't (ranges, multi-section, new chapters)
- **Normalized storage** - `AmendmentDocument` + `SectionChange` tables for efficient queries

### Current Schema Context

```prisma
model Amendment {
  id                   String    @id
  base_document_id     String    // Law being amended
  amending_document_id String?   // Currently NULL for most - this story fixes that
  amending_law_title   String    // "Lag (2025:732) om ändring..."
  effective_date       DateTime?
  affected_sections    Json?     // {amended: ["6:17"], repealed: ["8:4"]}
  // ...
}

model DocumentVersion {
  id             String  @id
  document_id    String
  version_number Int
  full_text      String
  html_content   String?
  amendment_sfs  String? // "SFS 2025:732"
  // ...
}
```

### Technical Considerations

1. **PDF Parsing Challenges:**
   - Older PDFs (pre-2000) may be scanned images → need OCR
   - Layout varies between years
   - Tables and special formatting

2. **PDF Libraries (Recommended):**
   - **Text-based PDFs:** `pdf-parse` (npm) - lightweight, fast
   - **OCR for scanned PDFs:** `tesseract.js` (client-side) or consider `@google-cloud/vision` for higher accuracy if needed
   - **Decision:** Start with `pdf-parse` + `tesseract.js`; evaluate accuracy in Phase 1 prototyping

3. **Amendment Identification:**
   - Pattern: "X § ska ha följande lydelse:"
   - Pattern: "X § upphävs"
   - Pattern: "Närmast före X § ska ny paragraf ... införas"

4. **Version Reconstruction:**
   - Must handle: amendments, repeals, additions, renumbering
   - Need to track effective dates carefully
   - Some amendments have future effective dates

### UI Component Specifications (Phase 3)

**Version Date Picker (`VersionDatePicker.tsx`):**
- Swedish locale date format: `YYYY-MM-DD` (e.g., "2024-01-15")
- Calendar picker with shadcn/ui `<Calendar>` component
- Disable dates before law's original publication date
- Disable dates after today
- Show amendment markers on dates where versions exist
- Mobile: Full-width bottom sheet picker

**Version Diff View (`VersionDiffView.tsx`):**
- Default: **Inline unified diff** (single column, additions/deletions highlighted)
- Optional toggle: Side-by-side view for desktop (>1024px)
- Color coding: Green for additions, red for deletions, yellow for modifications
- Line numbers for both old and new text
- Collapsible unchanged sections (show context of 3 lines)
- Use `diff` npm package for diff generation

**Version Timeline (`VersionTimeline.tsx`):**
- Vertical timeline on desktop (left rail)
- Horizontal scrollable timeline on mobile
- Each node shows: SFS amendment number, effective date, brief description
- Click node to load that version
- Current version highlighted

### Security Considerations

1. **PDF Sanitization:**
   - Validate PDF structure before processing (reject malformed files)
   - Use pdf-parse or similar in sandboxed mode if available
   - Limit maximum file size (e.g., 50MB) to prevent DoS
   - Strip JavaScript and embedded objects from PDFs before storage

2. **External Source Rate Limiting:**
   - rkrattsdb.gov.se: 1 request/second (conservative, respectful)
   - svenskforfattningssamling.se: 1 request/second
   - Implement exponential backoff on 429/503 responses
   - Log all scraping activity for audit purposes

3. **Input Validation:**
   - Validate date parameters in historical version routes (prevent injection)
   - Sanitize extracted text before database storage
   - Use parameterized queries for all database operations

4. **Storage Security:**
   - Store raw PDFs in secure blob storage (Supabase Storage)
   - Extracted text only - no executable content stored
   - Implement access logging for audit trails

### Testing

**Test Framework:** Vitest (per coding standards)

**Test File Locations:**
- `tests/unit/lib/external/pdf-parser.test.ts` - PDF parsing unit tests
- `tests/unit/lib/external/amendment-extractor.test.ts` - Amendment structure extraction
- `tests/integration/scripts/amendment-ingestion.test.ts` - Integration tests for ingestion pipeline
- `tests/e2e/historical-versions.spec.ts` - E2E tests for historical version UI

**Test Data:**
- Use well-known laws with many amendments: Arbetsmiljölagen (SFS 1977:1160), Miljöbalken (SFS 1998:808)
- Store 5-10 sample amendment PDFs in `tests/fixtures/amendment-pdfs/` for unit tests

**Test Scenarios:**
- PDF text extraction accuracy (text-based vs OCR)
- Amendment pattern detection (§ changes, repeals, additions)
- Effective date parsing from transition provisions
- Historical version reconstruction correctness
- UI date picker interaction and diff view rendering

## Dependencies

### This Story Depends On:

| Dependency | Status | Required For |
|------------|--------|--------------|
| Story 2.2 (SFS ingestion) | **Completed** - SFS laws in database | Phase 2+ (need base laws to link amendments to) |
| Story 2.11 (Change history tracking) | **Completed** - `DocumentVersion` model deployed | Phase 3 (store reconstructed versions) |

### Other Stories Depend On This:

| Dependent Story | Requires | Details |
|-----------------|----------|---------|
| Story 2.18 (Amendment PDF Integration) | Phase 2 infrastructure | Change monitoring enhancement uses `pdf-parser.ts` and `amendment-extractor.ts` to fetch/parse new amendment PDFs when detected |

**Pre-implementation checklist:**
- [ ] Verify `DocumentVersion` table exists in production database
- [ ] Verify SFS laws are populated (at least 1,000+ for meaningful testing)
- [ ] Confirm `Amendment` table has records to validate linking

## Scope Notes

This story is structured in 4 sequential phases. Phase 1 (Investigation) should be completed first to validate the approach before proceeding with implementation phases. Phase 4 can run in parallel with Phase 3.

## Architect Decisions (Resolved 2025-12-10)

| # | Question | Decision | Rationale |
|---|----------|----------|-----------|
| 1 | Data model for amendments | `LegalDocument` + new `SFS_AMENDMENT` ContentType | Follows existing pattern (CourtCase, EuDocument extend LegalDocument). Reuses search_vector, embedding, CrossReference infrastructure. Amendment.amending_document_id already expects LegalDocument FK. |
| 2 | Historical depth | **1998+ only** (PDF era). Pre-1998 deferred to backlog. | PDF availability confirmed for 1998+. Most SMB compliance concerns are with laws amended in last 25 years. Pre-1998 amendments often superseded. |
| 3 | SE-Lex integration | **Build own pipeline only**. May reference SE-Lex for parsing insights but no data import. | Full control over data quality and updates. No external dependency. Builds institutional knowledge for future enhancements. |
| 4 | Version storage | **Materialized** - store all versions, not on-demand reconstruction | Performance: O(1) lookup vs O(n) amendment chain. Storage is cheap (~8GB = $0.17/month). Eliminates reconstruction errors. Enables pre-computed embeddings for RAG. |

### Schema Change Required

Add to `ContentType` enum in `prisma/schema.prisma`:
```prisma
enum ContentType {
  SFS_LAW
  SFS_AMENDMENT      // NEW - for ändringsförfattningar
  COURT_CASE_AD
  // ... rest unchanged
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-10 | 0.1 | Initial draft from investigation session | Quinn (QA) |
| 2025-12-10 | 0.2 | Added to Epic 2, removed time estimates, added Testing/Source Tree/Security sections, verified external sources | Sarah (PO) |
| 2025-12-10 | 0.3 | Architect review: Resolved 4 open questions (SFS_AMENDMENT ContentType, 1998+ scope, own pipeline, materialized versions) | Winston (Architect) |
| 2025-12-10 | 0.4 | Validation fixes: Clarified schema migration in AC2, documented PDF URL patterns with examples, added UI component specs, explicit Task-AC mapping, verified dependencies, confirmed SE-Lex MIT license | Sarah (PO) |
| 2025-12-10 | 0.5 | Added comprehensive "Amendment Discovery Data Flow" diagram showing 7-step process from base law → SFSR query → PDF download → database storage | Sarah (PO) |
| 2025-12-10 | 0.6 | Added bidirectional dependency documentation: Story 2.18 depends on this story's Phase 2 infrastructure for ongoing change monitoring | Sarah (PO) |
| 2025-12-10 | 0.7 | PO Validation fixes: Updated component file names to PascalCase per coding standards, added documentation output location to Task 1.1, added test fixture directory creation, added Task 3.3 dependency note, marked NEW routes explicitly in source tree | Sarah (PO) |
| 2025-12-11 | 0.8 | Phase 2 refinement: Added LLM-assisted parsing (hybrid regex + Claude), Supabase PDF storage, normalized data model (AmendmentDocument + SectionChange). Deferred RAG chunking to separate story. Updated tasks with detailed subtasks. | Dev Agent |
| 2025-12-11 | 0.9 | Crawl-everything strategy: Crawl ALL ~40,000 SFS docs from both sources, classify by title pattern (amendment/repeal/new_law), store ALL PDFs in Supabase, parse only amendments with LLM. Added Document Discovery Strategy diagram, cost estimates (~$580 LLM, ~20GB storage). | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No blocking issues encountered
- PDF parsing initially failed with `pdf-parse` v2 and `pdfjs-dist` due to worker configuration issues
- Resolved by switching to `unpdf` library which handles Node.js environments correctly
- One invalid PDF (SFS1994-579-rkrattsdb.pdf) had structural issues; 12/13 PDFs parsed successfully

### Completion Notes

**Phase 1 completed successfully (2025-12-11):**

1. **Task 1.1:** Downloaded 13 sample PDFs (8 from svenskforfattningssamling.se 2018+, 5 from rkrattsdb.gov.se 1998-2018). Detection rates: 100% base law, 100% effective date, 92% chapter numbers.

2. **Task 1.2:** Added `SFS_AMENDMENT` to ContentType enum. Migration created and applied via `prisma db push`.

3. **Task 1.3:** Created `lib/external/pdf-parser.ts` with functions:
   - `parsePdf()` - main parsing function
   - `extractBaseLaw()` - detects base law being amended
   - `extractEffectiveDate()` - parses Swedish dates
   - `extractAffectedSections()` - identifies amended/repealed/new sections
   - 31 unit tests passing

4. **Task 1.4:** Documented SE-Lex approach (Git-based version history, MIT licensed) and ELI standard patterns. No data import - insights only.

**Ready for Phase 2 when approved.**

### File List

**Created:**
- `lib/external/pdf-parser.ts` - PDF parsing library for amendment documents
- `lib/external/llm-amendment-parser.ts` - LLM-assisted parser using Claude for complex patterns
- `lib/__tests__/pdf-parser.test.ts` - Unit tests (25 tests)
- `lib/__tests__/pdf-parser.integration.test.ts` - Integration tests (6 tests)
- `docs/research/amendment-pdf-structure.md` - Research documentation
- `docs/research/amendment-data-model.md` - Data model and version reconstruction algorithm
- `tests/fixtures/amendment-pdfs/` - 13 sample PDFs for testing
- `tests/fixtures/amendment-pdfs/text-samples/` - Extracted text for debugging
- `scripts/analyze-amendment-pdfs.ts` - Analysis script used during investigation
- `scripts/test-llm-parse.ts` - LLM parsing test script
- `scripts/show-llm-prompt-response.ts` - Debug script showing prompt/response
- `prisma/migrations/20251211_add_sfs_amendment_content_type/migration.sql` - Schema migration

**Modified:**
- `prisma/schema.prisma` - Added `SFS_AMENDMENT` to ContentType enum
- `package.json` - Added `unpdf` and `@anthropic-ai/sdk` dependencies
- `.env.local` - Added `ANTHROPIC_API_KEY` field

### Change Log

| Date | Change | Files |
|------|--------|-------|
| 2025-12-11 | Phase 1: Investigation complete | Multiple (see File List) |

## QA Results

_To be filled by QA agent_
