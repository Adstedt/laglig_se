# Story 14.9: Agent System Prompt & Behavioral Design

## Status

Draft

## Story

As a platform operator, I want the compliance partner to behave consistently, transparently, and safely, so that users trust its guidance and it doesn't take inappropriate actions.

## Context & Dependencies

The system prompt is the agent's "personality and rules." Following Anthropic's safety framework, the agent must: cite sources, never fabricate legal text, distinguish fact from advice, show its reasoning, and pause before state-changing actions. The prompt is in Swedish.

- **Builds on:** Tool definitions (14.7) define what the agent can do, RAG pipeline (14.8) defines how the agent retrieves knowledge
- **Depends on:** 14.7 (references tool behavior), 14.8 (references retrieval behavior)
- **Depended on by:** 14.10 + 14.11 (UX uses this prompt)

## Acceptance Criteria

### System Prompt

1. System prompt defined in `lib/agent/system-prompt.ts` as an exported constant
2. Prompt written in Swedish — agent communicates in Swedish by default
3. Role definition: "Du ar en compliance-partner som hjalper anvandare att forsta och hantera lagandringar"
4. Knowledge boundary: "Du baserar dina svar pa de lagar och dokument som finns i systemet. Om du inte hittar relevant information, sag det tydligt."
5. Citation requirement: always reference specific document numbers, chapters, and sections when quoting law text
6. Distinction between fact and advice: use "Lagen sager..." for factual, "Ni bor overvaga..." for advisory
7. Prompt includes company context injection point: `{{companyContext}}` placeholder that gets filled with WorkspaceProfile data
8. Prompt includes tool usage instructions for the agent

### Behavioral Guardrails

9. Never fabricate legal text — only quote from retrieved chunks
10. Never invent requirements that aren't in the law
11. When uncertain, explicitly say: "Jag ar inte saker om detta — jag rekommenderar att ni konsulterar en jurist"
12. No legal advice disclaimer: "Jag ger vagledning baserat pa lagtext, men detta ersatter inte juridisk radgivning"

### Transparency Protocol

13. Function `formatTransparencyBlock(searchResults)` — generates a collapsible "Jag sokte i..." block showing which documents were searched
14. Retrieved chunks referenced inline with `[Kalla: SFS 1977:1160, Kap 2, 3 ss]` format

### Human-in-the-Loop

15. Write tool instructions in prompt: "Innan du utfor en atgard (skapar uppgift, andrar status), beskriv vad du planerar gora och invanta anvandarens godkannande"
16. Read-only tool instructions: "Du kan fritt soka i lagar och dokument utan att fraga forst"

### Fallback Behavior

17. When company profile is incomplete: "Jag ser att er foretagsprofil saknar [field]. Vill ni beratta mer om er verksamhet sa att jag kan ge mer relevanta rad?"
18. When no relevant chunks found: "Jag hittade ingen relevant information i vart register om detta. Kan ni formulera fragan annorlunda?"

### Testing

19. At least 6 unit tests for system prompt construction and transparency formatting

## Tasks / Subtasks

- [ ] **Task 1: System prompt** (AC: 1-8)
  - [ ] Create `lib/agent/system-prompt.ts` with exported `buildSystemPrompt(workspaceProfile?)` function
  - [ ] Write the full system prompt in Swedish
  - [ ] Define role, knowledge boundary, citation rules, fact-vs-advice distinction
  - [ ] Implement `{{companyContext}}` placeholder injection from WorkspaceProfile
  - [ ] Add tool usage instructions section to the prompt

- [ ] **Task 2: Guardrails** (AC: 9-12)
  - [ ] Embed guardrail instructions in the system prompt
  - [ ] Create `lib/agent/guardrails.ts` with testable guardrail rule definitions
  - [ ] Include legal disclaimer text
  - [ ] Include uncertainty acknowledgment instructions

- [ ] **Task 3: Transparency** (AC: 13-14)
  - [ ] Create `lib/agent/transparency.ts` with `formatTransparencyBlock(searchResults)` function
  - [ ] Format search results into collapsible "Jag sokte i..." blocks
  - [ ] Implement source citation formatter for inline references
  - [ ] Support different source types (LegalDocument, UserFile, ChangeEvent)

- [ ] **Task 4: Human-in-the-loop rules** (AC: 15-16)
  - [ ] Add write tool instructions to the system prompt — describe-then-wait pattern
  - [ ] Add read-only tool instructions — free to search without asking
  - [ ] Document the confirmation flow expected from the UI layer

- [ ] **Task 5: Fallback behavior** (AC: 17-18)
  - [ ] Add fallback instructions to the system prompt for incomplete profiles
  - [ ] Add fallback instructions for empty search results
  - [ ] Create profile completeness check function in `lib/agent/system-prompt.ts`

- [ ] **Task 6: Tests** (AC: 19)
  - [ ] Create `tests/unit/agent/system-prompt.test.ts`
  - [ ] Create `tests/unit/agent/transparency.test.ts`
  - [ ] Test prompt construction with full WorkspaceProfile
  - [ ] Test prompt construction without profile (graceful fallback)
  - [ ] Test transparency block formatting for different source types
  - [ ] Test citation formatting for legal documents, files, and change events

## Dev Notes

- System prompt is a function, not a static string — it takes optional WorkspaceProfile and injects company context
- The prompt should be comprehensive but not overwhelming — aim for ~800-1200 tokens
- Company context injection example:
```
## Om foretaget
- Foretag: Byggbolaget AB
- Bransch: Byggverksamhet (SNI 41.200)
- Antal anstallda: 50-249
- Certifieringar: ISO 45001, ISO 14001
- Hanterar kemikalier: Ja
- Compliance-mognad: Utvecklande
```
- Transparency block format (shown to user in collapsible panel):
```
Sokte i: Arbetsmiljolagen (SFS 1977:1160), AFS 2023:1, Foretagets arbetsmiljopolicy.pdf
Hittade 8 relevanta avsnitt
```
- Source tree: `lib/agent/system-prompt.ts` (new), `lib/agent/guardrails.ts` (new), `lib/agent/transparency.ts` (new)
- References: `lib/agent/tools/` (from 14.7), `lib/agent/retrieval.ts` (from 14.8)

## Testing

- Test files: `tests/unit/agent/system-prompt.test.ts`, `tests/unit/agent/transparency.test.ts`
- Test prompt includes company context when profile provided
- Test prompt handles missing profile gracefully
- Test transparency block formatting
- Test citation formatting for different source types
- Vitest

## Change Log

| Date       | Version | Description                     | Author     |
| ---------- | ------- | ------------------------------- | ---------- |
| 2026-02-18 | 0.1     | Initial draft — story creation  | Dev Agent  |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
