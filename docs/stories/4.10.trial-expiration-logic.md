# Story 4.10: Implement Free Trial Expiration Logic

## Status
Draft

## Story

**As a** system,
**I want** to automatically expire free trials after 14 days,
**so that** users must upgrade to continue using the product.

## Acceptance Criteria

1. User accounts have `trial_ends_at` field (set to signup_date + 14 days)
2. Daily cron job checks for expired trials (runs 00:00 UTC)
3. Expired trial users: Access blocked, workspace set to "paused" status
4. Paused workspace shows banner: "Your trial has ended. Upgrade to continue."
5. User can click "Upgrade" → Redirects to billing page (Epic 5)
6. Data preserved for 30 days after trial expiration (Epic 5 soft-delete)
7. Email sent on day 14: "Your trial has ended" + upgrade CTA
8. Expired users cannot login (redirect to upgrade page)
9. Analytics tracking: Trial → Paid conversion rate (target >25%)

## Tasks / Subtasks

- [ ] Add `trial_ends_at` field to workspace schema
- [ ] Create daily cron job for trial expiration check
- [ ] Implement workspace "paused" status
- [ ] Add trial expiration middleware to block access
- [ ] Create trial expired banner/page
- [ ] Send trial expiration email
- [ ] Implement 30-day data retention before deletion
- [ ] Track trial-to-paid conversion analytics
- [ ] Test complete trial expiration flow

## Dev Notes

**Database Schema Updates:**
```prisma
model Workspace {
  id               String   @id @default(uuid())
  name             String
  ownerId          String
  subscriptionTier String   @default("trial") // trial, solo, team, enterprise
  trialEndsAt      DateTime?
  status           String   @default("active") // active, paused, deleted
  pausedAt         DateTime?
  deletedAt        DateTime?
  // ... other fields
}
```

**Daily Cron Job:**
```typescript
// lib/cron/expire-trials.ts
import cron from 'node-cron'

// Run every day at 00:00 UTC
export function scheduleTrialExpirationJob() {
  cron.schedule('0 0 * * *', async () => {
    console.log('Running trial expiration job...')

    try {
      const now = new Date()

      // Find all expired trials
      const expiredWorkspaces = await prisma.workspace.findMany({
        where: {
          subscriptionTier: 'trial',
          trialEndsAt: {
            lte: now
          },
          status: 'active'
        },
        include: {
          owner: true
        }
      })

      console.log(`Found ${expiredWorkspaces.length} expired trials`)

      for (const workspace of expiredWorkspaces) {
        // Pause workspace
        await prisma.workspace.update({
          where: { id: workspace.id },
          data: {
            status: 'paused',
            pausedAt: now
          }
        })

        // Send expiration email
        await sendTrialExpiredEmail(
          workspace.owner.email,
          workspace.name,
          workspace.id
        )

        // Track analytics
        await trackEvent('trial_expired', {
          workspaceId: workspace.id,
          userId: workspace.ownerId,
          trialDuration: 14
        })

        console.log(`Paused workspace: ${workspace.id}`)
      }

      // Schedule deletion for workspaces paused 30 days ago
      const deletionCutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)

      const workspacesToDelete = await prisma.workspace.findMany({
        where: {
          status: 'paused',
          pausedAt: {
            lte: deletionCutoff
          }
        }
      })

      console.log(`Found ${workspacesToDelete.length} workspaces to soft-delete`)

      for (const workspace of workspacesToDelete) {
        // Soft delete workspace (mark as deleted, don't actually delete data yet)
        await prisma.workspace.update({
          where: { id: workspace.id },
          data: {
            status: 'deleted',
            deletedAt: now
          }
        })

        console.log(`Soft-deleted workspace: ${workspace.id}`)
      }

      console.log('Trial expiration job completed')
    } catch (error) {
      console.error('Trial expiration job failed:', error)
      // Report to Sentry
      captureException(error)
    }
  })
}
```

**Trial Expiration Middleware:**
```typescript
// middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  // Get user session
  const session = await getSession(request)

  if (!session) {
    return NextResponse.next()
  }

  // Check workspace status
  const workspace = await prisma.workspace.findFirst({
    where: {
      members: {
        some: {
          userId: session.userId
        }
      }
    },
    select: {
      id: true,
      status: true,
      subscriptionTier: true,
      trialEndsAt: true
    }
  })

  if (!workspace) {
    return NextResponse.next()
  }

  // If workspace is paused (trial expired), redirect to upgrade page
  if (workspace.status === 'paused') {
    const url = request.nextUrl.clone()

    // Allow access to upgrade page and billing
    if (
      url.pathname.startsWith('/billing') ||
      url.pathname === '/trial-expired'
    ) {
      return NextResponse.next()
    }

    // Redirect to trial expired page
    url.pathname = '/trial-expired'
    return NextResponse.redirect(url)
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/dashboard/:path*', '/workspace/:path*', '/employees/:path*']
}
```

**Trial Expired Page:**
```typescript
// app/trial-expired/page.tsx
'use client'

import { useRouter } from 'next/navigation'
import { useEffect, useState } from 'react'

export default function TrialExpiredPage() {
  const router = useRouter()
  const [workspace, setWorkspace] = useState<any>(null)

  useEffect(() => {
    async function fetchWorkspace() {
      const response = await fetch('/api/workspace/current')
      const data = await response.json()
      setWorkspace(data)
    }

    fetchWorkspace()
  }, [])

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-2xl w-full bg-white rounded-lg shadow-lg p-8">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 rounded-full mb-4">
            <svg
              className="w-8 h-8 text-yellow-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            Din provperiod har gått ut
          </h1>
          <p className="text-lg text-gray-600">
            För att fortsätta använda Laglig.se, uppgradera till en betald plan.
          </p>
        </div>

        {/* What you'll keep */}
        <div className="mb-8">
          <h2 className="text-xl font-bold text-gray-900 mb-4">
            När du uppgraderar får du tillgång till:
          </h2>
          <ul className="space-y-3">
            <li className="flex items-start">
              <svg
                className="w-6 h-6 text-green-500 mr-3 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fillRule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clipRule="evenodd"
                />
              </svg>
              <span className="text-gray-700">
                Din personliga laglista med alla {workspace?.lawCount || 68} lagar
              </span>
            </li>
            <li className="flex items-start">
              <svg
                className="w-6 h-6 text-green-500 mr-3 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fillRule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clipRule="evenodd"
                />
              </svg>
              <span className="text-gray-700">
                Automatisk ändringsbevakning och notiser
              </span>
            </li>
            <li className="flex items-start">
              <svg
                className="w-6 h-6 text-green-500 mr-3 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fillRule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clipRule="evenodd"
                />
              </svg>
              <span className="text-gray-700">
                Obegränsade AI-frågor med källhänvisningar
              </span>
            </li>
            <li className="flex items-start">
              <svg
                className="w-6 h-6 text-green-500 mr-3 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fillRule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clipRule="evenodd"
                />
              </svg>
              <span className="text-gray-700">
                Kanban-tavla för compliance-spårning
              </span>
            </li>
            <li className="flex items-start">
              <svg
                className="w-6 h-6 text-green-500 mr-3 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fillRule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clipRule="evenodd"
                />
              </svg>
              <span className="text-gray-700">HR-modul med anställningshantering</span>
            </li>
          </ul>
        </div>

        {/* Pricing */}
        <div className="grid md:grid-cols-2 gap-4 mb-8">
          <div className="border-2 border-gray-200 rounded-lg p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-2">Solo</h3>
            <p className="text-3xl font-bold text-gray-900 mb-2">
              €399<span className="text-lg font-normal text-gray-600">/månad</span>
            </p>
            <p className="text-sm text-gray-600 mb-4">
              Perfekt för enmansföretag och småbolag
            </p>
            <button
              onClick={() => router.push('/billing/upgrade?plan=solo')}
              className="w-full py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"
            >
              Välj Solo
            </button>
          </div>

          <div className="border-2 border-blue-600 rounded-lg p-6 relative">
            <div className="absolute top-0 right-0 bg-blue-600 text-white text-xs font-semibold px-3 py-1 rounded-bl-lg">
              POPULÄRAST
            </div>
            <h3 className="text-lg font-bold text-gray-900 mb-2">Team</h3>
            <p className="text-3xl font-bold text-gray-900 mb-2">
              €899<span className="text-lg font-normal text-gray-600">/månad</span>
            </p>
            <p className="text-sm text-gray-600 mb-4">
              För team upp till 5 användare
            </p>
            <button
              onClick={() => router.push('/billing/upgrade?plan=team')}
              className="w-full py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"
            >
              Välj Team
            </button>
          </div>
        </div>

        <p className="text-center text-sm text-gray-600">
          Dina data sparas i 30 dagar. Efter det raderas de permanent.
        </p>
      </div>
    </div>
  )
}
```

**Trial Expiration Email:**
```typescript
// components/emails/trial-expired.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Text,
  Heading,
  Button,
  Hr
} from '@react-email/components'

export function TrialExpiredEmail({
  companyName,
  workspaceId
}: {
  companyName: string
  workspaceId: string
}) {
  const upgradeUrl = `https://laglig.se/billing/upgrade?workspace=${workspaceId}&utm_source=email&utm_medium=trial&utm_campaign=expired`

  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>Din provperiod har gått ut</Heading>

          <Text style={styles.text}>Hej {companyName},</Text>

          <Text style={styles.text}>
            Din 14-dagars gratisperiod för Laglig.se har gått ut idag.
          </Text>

          <Text style={styles.text}>
            För att fortsätta använda Laglig.se och behålla tillgång till din
            laglista, uppgradera till en betald plan:
          </Text>

          <Section style={styles.buttonSection}>
            <Button href={upgradeUrl} style={styles.button}>
              Uppgradera nu
            </Button>
          </Section>

          <Hr style={styles.hr} />

          <Text style={styles.text}>
            <strong>Vad händer nu?</strong>
          </Text>

          <ul style={styles.list}>
            <li>Din laglista är tillfälligt pausad</li>
            <li>Dina data sparas i 30 dagar</li>
            <li>Efter 30 dagar raderas din data permanent</li>
          </ul>

          <Text style={styles.text}>
            Uppgradera inom 30 dagar för att återfå tillgång till allt.
          </Text>

          <Hr style={styles.hr} />

          <Text style={styles.smallText}>
            Har du frågor? Svara på detta mejl så hjälper vi dig.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

const styles = {
  body: {
    backgroundColor: '#f6f9fc',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
  },
  container: {
    margin: '0 auto',
    padding: '40px 20px',
    maxWidth: '600px'
  },
  heading: {
    fontSize: '24px',
    fontWeight: 'bold',
    color: '#1a202c',
    marginBottom: '20px'
  },
  text: {
    fontSize: '16px',
    color: '#4a5568',
    lineHeight: '1.6',
    marginBottom: '16px'
  },
  buttonSection: {
    textAlign: 'center' as const,
    margin: '32px 0'
  },
  button: {
    backgroundColor: '#3182ce',
    color: '#fff',
    padding: '14px 32px',
    borderRadius: '8px',
    textDecoration: 'none',
    fontWeight: 'bold',
    fontSize: '16px'
  },
  hr: {
    borderColor: '#e2e8f0',
    margin: '24px 0'
  },
  list: {
    paddingLeft: '20px',
    marginBottom: '16px'
  },
  smallText: {
    fontSize: '14px',
    color: '#718096',
    lineHeight: '1.5'
  }
}
```

**Analytics Tracking:**
```typescript
// lib/analytics/track-trial-conversion.ts
export async function trackTrialConversion(workspaceId: string, tier: string) {
  await prisma.analyticsEvent.create({
    data: {
      event: 'trial_converted',
      workspaceId,
      properties: {
        tier,
        trialDuration: 14
      }
    }
  })

  // Also track in external analytics (Mixpanel, Amplitude, etc.)
  await mixpanel.track('Trial Converted', {
    workspace_id: workspaceId,
    tier,
    trial_duration: 14
  })
}

export async function calculateConversionRate() {
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)

  const totalTrials = await prisma.workspace.count({
    where: {
      subscriptionTier: 'trial',
      createdAt: {
        gte: thirtyDaysAgo
      }
    }
  })

  const convertedTrials = await prisma.analyticsEvent.count({
    where: {
      event: 'trial_converted',
      createdAt: {
        gte: thirtyDaysAgo
      }
    }
  })

  const conversionRate = (convertedTrials / totalTrials) * 100

  return {
    totalTrials,
    convertedTrials,
    conversionRate: conversionRate.toFixed(2)
  }
}
```

**Reference:** PRD Epic 4 Story 4.8, Architecture Section 14 (Subscription Management), Cron job best practices

## Testing

**Unit Tests:**
- Cron job identifies expired trials correctly
- Middleware blocks access for paused workspaces
- 30-day deletion window calculated correctly
- Trial expiration email sent correctly

**Integration Tests:**
- Complete trial expiration flow from day 14 to paused state
- User cannot access dashboard after trial expires
- User can access upgrade page after trial expires
- Data preserved for 30 days after expiration
- Soft-delete occurs 30 days after pause

**Manual Testing:**
- Manually trigger cron job to test expiration
- Create trial workspace, set `trialEndsAt` to yesterday
- Run cron job, verify workspace paused
- Verify trial expired email sent
- Try to login as expired user (should redirect to upgrade page)
- Verify analytics event tracked

**Performance Testing:**
- Cron job completes in <5 minutes for 1,000 expired trials
- Middleware check adds <50ms latency

**Test File:** `__tests__/features/billing/trial-expiration.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**
- Upgrade before trial expires to maintain access
- Check email for trial expiration notice
- Choose appropriate subscription tier

**Developer Responsibility:**
- Run daily cron job to check expired trials
- Pause workspace access for expired trials
- Send trial expiration email
- Preserve data for 30 days before deletion
- Block login for expired trial users
- Track trial-to-paid conversion rate
- Ensure cron job reliability (retry on failure)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
