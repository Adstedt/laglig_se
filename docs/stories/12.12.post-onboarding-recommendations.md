# Story 12.12: Post-Onboarding Template Recommendations

## Status

Draft

## Story

**As a** user who has completed onboarding,
**I want** to see recommended templates based on my company profile,
**so that** I can expand my compliance coverage beyond the AI-generated list.

## Acceptance Criteria

1. After onboarding completion, dashboard shows "Rekommenderade mallar" section
2. Recommendations based on: SNI code → domain matching, employee count → variant selection, laws already in workspace → templates with significant overlap
3. Each recommendation card shows: template name, "X lagar som kan gälla dig", preview CTA
4. "Lägg till" button triggers adoption flow (Story 12.10)
5. Dismissible: user can hide recommendations
6. Maximum 3 recommendations shown

## Tasks / Subtasks

- [ ] **Task 1: Build recommendation engine** (AC: 2)
  - [ ] Create `lib/ai/template-recommender.ts`
  - [ ] Input: workspace company profile (SNI code, employee count, existing law list items)
  - [ ] Matching logic:
    - SNI code → relevant domain templates (reuse template matcher from 12.11)
    - Employee count → variant selection
    - Overlap analysis: compare workspace items against template items, calculate coverage %
  - [ ] Output: top 3 recommendations with relevance metadata
  - [ ] Exclude templates already adopted (check LawList.metadata.source_template_id)
- [ ] **Task 2: Create recommendations component** (AC: 1, 3)
  - [ ] Create `components/features/templates/template-recommendations.tsx`
  - [ ] Render up to 3 recommendation cards
  - [ ] Each card: template name, "X lagar som kan gälla dig" count, description excerpt
  - [ ] "Förhandsgranska" link → template preview page (Story 12.9)
  - [ ] "Lägg till" button → triggers adoption (Story 12.10)
  - [ ] Use shadcn/ui Card component
- [ ] **Task 3: Add to dashboard** (AC: 1)
  - [ ] Add "Rekommenderade mallar" section to `app/(app)/dashboard/page.tsx`
  - [ ] Fetch recommendations server-side
  - [ ] Only show section if recommendations exist
  - [ ] Place after main content (law list overview, tasks, etc.)
- [ ] **Task 4: Implement dismiss functionality** (AC: 5)
  - [ ] "Dölj" button on recommendations section
  - [ ] Store dismissal in user preferences or workspace settings
  - [ ] Server action: `dismissTemplateRecommendations(workspaceId)`
  - [ ] Don't show again for this workspace after dismissal
- [ ] **Task 5: Write tests** (AC: all)
  - [ ] Unit test: recommender returns correct templates for SNI code
  - [ ] Unit test: already-adopted templates excluded
  - [ ] Unit test: max 3 recommendations
  - [ ] Unit test: empty result when all relevant templates already adopted
  - [ ] Component test: cards render with correct info
  - [ ] Component test: dismiss hides section
  - [ ] Integration test: dashboard shows recommendations after onboarding

## Dev Notes

### Dashboard Location

**File:** `app/(app)/dashboard/page.tsx`

Add the recommendations section after existing dashboard content. Wrap in `<Suspense>` for streaming SSR.

### Recommendation Logic

Reuse the template matching logic from Story 12.11 (`lib/ai/template-matcher.ts`). Additional logic:
- Filter out templates already adopted by checking `LawList` records with `metadata.source_template_id`
- Calculate "X lagar som kan gälla dig" count from template's `document_count`
- Sort by relevance score

### Dismiss Storage Options

1. **JSONB field on CompanyProfile:** `dismissed_template_recommendations: true`
2. **Separate preferences table:** More flexible but more complex
3. **LocalStorage:** Simpler but per-device, not per-workspace

Recommend option 1 for simplicity.

### Company Profile Model

**File:** `prisma/schema.prisma` line 156

```prisma
model CompanyProfile {
  id                 String  @id @default(uuid())
  workspace_id       String  @unique
  company_name       String
  sni_code           String?
  employee_count     Int?
  // ... other fields
  contextual_answers Json?
}
```

The `sni_code` and `employee_count` fields are available for recommendation matching. `contextual_answers` contains onboarding Q&A data.

### Dependencies

- **Blocked by:** Story 12.10 (adoption flow must exist)
- **Uses:** Story 12.11 template matcher (can be developed in parallel with shared logic)

### Relevant Source Tree

```
lib/ai/template-recommender.ts                          # New: recommendation engine
components/features/templates/template-recommendations.tsx # New: recommendations UI
app/(app)/dashboard/page.tsx                              # Update: add recommendations
lib/ai/template-matcher.ts                                # Reuse from Story 12.11
prisma/schema.prisma                                      # CompanyProfile for SNI/employee data
```

### Testing

- **Test framework:** Vitest 1.4+ with React Testing Library
- **Test location:** `tests/unit/lib/ai/`, `tests/unit/components/features/templates/`
- **Tests needed:**
  - Recommender: returns relevant templates for SNI code
  - Recommender: excludes already-adopted templates
  - Recommender: returns max 3
  - Recommender: returns empty when all adopted
  - Component: renders recommendation cards
  - Component: dismiss hides section
  - Dashboard: recommendations section shows after onboarding

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
