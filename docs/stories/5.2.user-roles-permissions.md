# Story 5.2: Implement Five User Roles with Permissions

## Status

Draft

## Story

**As a** workspace owner,
**I want** to assign different roles to team members,
**so that** I control who can access sensitive HR data and billing.

## Acceptance Criteria

1. Five roles defined: Owner, Admin, HR Manager, Member, Auditor
2. **Owner:** Full access + billing + workspace deletion
3. **Admin:** Full access except billing and deletion
4. **HR Manager:** Full access to HR Module + employee data, read-only law lists
5. **Member:** Read-only law lists, can use AI chat, cannot see employees
6. **Auditor:** Read-only access to multiple workspaces (for ISO consultants)
7. Permissions checked at API route level (middleware)
8. Permissions checked at UI level (hide/disable actions)
9. Permission matrix documented in code comments
10. Test: Member cannot access HR Module, HR Manager cannot change billing

## Tasks / Subtasks

- [ ] Define role enum and permission matrix
- [ ] Create permission check middleware
- [ ] Implement role-based access control helpers
- [ ] Add UI-level permission checks (hide/show buttons)
- [ ] Document permission matrix in code
- [ ] Test each role's permissions
- [ ] Create permission denied page

## Dev Notes

**Role Definitions:**

```typescript
// lib/permissions/roles.ts

export enum WorkspaceRole {
  OWNER = 'owner',
  ADMIN = 'admin',
  HR_MANAGER = 'hr_manager',
  MEMBER = 'member',
  AUDITOR = 'auditor',
}

export enum Permission {
  // Workspace
  VIEW_WORKSPACE = 'workspace:view',
  MANAGE_WORKSPACE_SETTINGS = 'workspace:manage_settings',
  DELETE_WORKSPACE = 'workspace:delete',

  // Team
  VIEW_TEAM = 'team:view',
  INVITE_MEMBERS = 'team:invite',
  MANAGE_MEMBERS = 'team:manage',
  REMOVE_MEMBERS = 'team:remove',

  // Billing
  VIEW_BILLING = 'billing:view',
  MANAGE_BILLING = 'billing:manage',

  // Laws
  VIEW_LAWS = 'laws:view',
  MANAGE_LAWS = 'laws:manage',
  ADD_LAWS = 'laws:add',
  REMOVE_LAWS = 'laws:remove',

  // Employees
  VIEW_EMPLOYEES = 'employees:view',
  MANAGE_EMPLOYEES = 'employees:manage',

  // AI Chat
  USE_AI_CHAT = 'ai:chat',

  // Kanban
  VIEW_KANBAN = 'kanban:view',
  MANAGE_KANBAN = 'kanban:manage',

  // Activity Log
  VIEW_ACTIVITY_LOG = 'activity_log:view',
}

/**
 * Permission Matrix
 *
 * | Permission              | Owner | Admin | HR Manager | Member | Auditor |
 * |-------------------------|-------|-------|------------|--------|---------|
 * | workspace:view          | ✓     | ✓     | ✓          | ✓      | ✓       |
 * | workspace:manage        | ✓     | ✓     | ✗          | ✗      | ✗       |
 * | workspace:delete        | ✓     | ✗     | ✗          | ✗      | ✗       |
 * | team:view               | ✓     | ✓     | ✓          | ✓      | ✓       |
 * | team:invite             | ✓     | ✓     | ✗          | ✗      | ✗       |
 * | team:manage             | ✓     | ✓     | ✗          | ✗      | ✗       |
 * | billing:view            | ✓     | ✗     | ✗          | ✗      | ✗       |
 * | billing:manage          | ✓     | ✗     | ✗          | ✗      | ✗       |
 * | laws:view               | ✓     | ✓     | ✓          | ✓      | ✓       |
 * | laws:manage             | ✓     | ✓     | ✗          | ✗      | ✗       |
 * | employees:view          | ✓     | ✓     | ✓          | ✗      | ✓       |
 * | employees:manage        | ✓     | ✓     | ✓          | ✗      | ✗       |
 * | ai:chat                 | ✓     | ✓     | ✓          | ✓      | ✓       |
 * | kanban:view             | ✓     | ✓     | ✓          | ✓      | ✓       |
 * | kanban:manage           | ✓     | ✓     | ✗          | ✗      | ✗       |
 * | activity_log:view       | ✓     | ✓     | ✗          | ✗      | ✓       |
 */

const ROLE_PERMISSIONS: Record<WorkspaceRole, Permission[]> = {
  [WorkspaceRole.OWNER]: [
    Permission.VIEW_WORKSPACE,
    Permission.MANAGE_WORKSPACE_SETTINGS,
    Permission.DELETE_WORKSPACE,
    Permission.VIEW_TEAM,
    Permission.INVITE_MEMBERS,
    Permission.MANAGE_MEMBERS,
    Permission.REMOVE_MEMBERS,
    Permission.VIEW_BILLING,
    Permission.MANAGE_BILLING,
    Permission.VIEW_LAWS,
    Permission.MANAGE_LAWS,
    Permission.ADD_LAWS,
    Permission.REMOVE_LAWS,
    Permission.VIEW_EMPLOYEES,
    Permission.MANAGE_EMPLOYEES,
    Permission.USE_AI_CHAT,
    Permission.VIEW_KANBAN,
    Permission.MANAGE_KANBAN,
    Permission.VIEW_ACTIVITY_LOG,
  ],

  [WorkspaceRole.ADMIN]: [
    Permission.VIEW_WORKSPACE,
    Permission.MANAGE_WORKSPACE_SETTINGS,
    // NO DELETE_WORKSPACE
    Permission.VIEW_TEAM,
    Permission.INVITE_MEMBERS,
    Permission.MANAGE_MEMBERS,
    Permission.REMOVE_MEMBERS,
    // NO BILLING
    Permission.VIEW_LAWS,
    Permission.MANAGE_LAWS,
    Permission.ADD_LAWS,
    Permission.REMOVE_LAWS,
    Permission.VIEW_EMPLOYEES,
    Permission.MANAGE_EMPLOYEES,
    Permission.USE_AI_CHAT,
    Permission.VIEW_KANBAN,
    Permission.MANAGE_KANBAN,
    Permission.VIEW_ACTIVITY_LOG,
  ],

  [WorkspaceRole.HR_MANAGER]: [
    Permission.VIEW_WORKSPACE,
    // NO MANAGE_WORKSPACE_SETTINGS
    Permission.VIEW_TEAM,
    // NO TEAM MANAGEMENT
    Permission.VIEW_LAWS,
    // NO MANAGE_LAWS (read-only law lists)
    Permission.VIEW_EMPLOYEES,
    Permission.MANAGE_EMPLOYEES,
    Permission.USE_AI_CHAT,
    Permission.VIEW_KANBAN,
    // NO MANAGE_KANBAN
  ],

  [WorkspaceRole.MEMBER]: [
    Permission.VIEW_WORKSPACE,
    Permission.VIEW_TEAM,
    Permission.VIEW_LAWS,
    // NO EMPLOYEES
    Permission.USE_AI_CHAT,
    Permission.VIEW_KANBAN,
  ],

  [WorkspaceRole.AUDITOR]: [
    // Auditor has read-only access to multiple workspaces
    Permission.VIEW_WORKSPACE,
    Permission.VIEW_TEAM,
    Permission.VIEW_LAWS,
    Permission.VIEW_EMPLOYEES,
    Permission.USE_AI_CHAT,
    Permission.VIEW_KANBAN,
    Permission.VIEW_ACTIVITY_LOG,
    // NO MANAGE permissions
  ],
}

export function hasPermission(
  role: WorkspaceRole,
  permission: Permission
): boolean {
  return ROLE_PERMISSIONS[role]?.includes(permission) || false
}

export function checkPermission(role: WorkspaceRole, permission: Permission) {
  if (!hasPermission(role, permission)) {
    throw new Error(`Permission denied: ${permission}`)
  }
}
```

**Permission Check Middleware:**

```typescript
// middleware/permissions.ts
import { NextResponse } from 'next/server'

export function requirePermission(...permissions: Permission[]) {
  return async (request: Request) => {
    const { role } = await getWorkspaceContext()

    for (const permission of permissions) {
      if (!hasPermission(role as WorkspaceRole, permission)) {
        return NextResponse.json(
          {
            error: 'Permission denied',
            required: permission,
            userRole: role,
          },
          { status: 403 }
        )
      }
    }

    return null // Allow request to proceed
  }
}

// Usage in API routes
export async function POST(request: Request) {
  const permissionError = await requirePermission(Permission.MANAGE_LAWS)(
    request
  )
  if (permissionError) return permissionError

  // ... proceed with route logic
}
```

**Higher-Level Permission Helpers:**

```typescript
// lib/permissions/helpers.ts

export async function canManageBilling(): Promise<boolean> {
  const { role } = await getWorkspaceContext()
  return hasPermission(role as WorkspaceRole, Permission.MANAGE_BILLING)
}

export async function canViewEmployees(): Promise<boolean> {
  const { role } = await getWorkspaceContext()
  return hasPermission(role as WorkspaceRole, Permission.VIEW_EMPLOYEES)
}

export async function canManageEmployees(): Promise<boolean> {
  const { role } = await getWorkspaceContext()
  return hasPermission(role as WorkspaceRole, Permission.MANAGE_EMPLOYEES)
}

export async function canInviteMembers(): Promise<boolean> {
  const { role } = await getWorkspaceContext()
  return hasPermission(role as WorkspaceRole, Permission.INVITE_MEMBERS)
}

export async function canDeleteWorkspace(): Promise<boolean> {
  const { role } = await getWorkspaceContext()
  return hasPermission(role as WorkspaceRole, Permission.DELETE_WORKSPACE)
}

// ... more helpers
```

**UI-Level Permission Checks:**

```typescript
// components/permissions/can.tsx
'use client'

import { useWorkspace } from '@/hooks/use-workspace'
import { hasPermission, Permission, WorkspaceRole } from '@/lib/permissions/roles'

interface CanProps {
  permission: Permission
  children: React.ReactNode
  fallback?: React.ReactNode
}

export function Can({ permission, children, fallback = null }: CanProps) {
  const { role } = useWorkspace()

  if (!hasPermission(role as WorkspaceRole, permission)) {
    return <>{fallback}</>
  }

  return <>{children}</>
}

// Usage:
// <Can permission={Permission.MANAGE_BILLING}>
//   <button>Manage Billing</button>
// </Can>
```

**Permission Denied Page:**

```typescript
// app/permission-denied/page.tsx
export default function PermissionDeniedPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8 text-center">
        <div className="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
          <svg
            className="w-8 h-8 text-red-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
        </div>
        <h1 className="text-2xl font-bold text-gray-900 mb-2">
          Åtkomst nekad
        </h1>
        <p className="text-gray-600 mb-6">
          Du har inte behörighet att utföra denna åtgärd. Kontakta din
          workspace-ägare för att få tillgång.
        </p>
        <button
          onClick={() => window.history.back()}
          className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          Gå tillbaka
        </button>
      </div>
    </div>
  )
}
```

**Example API Route with Permission Check:**

```typescript
// app/api/employees/route.ts
export async function GET(request: Request) {
  return withWorkspace(async ({ workspaceId, role }) => {
    // Check permission
    checkPermission(role as WorkspaceRole, Permission.VIEW_EMPLOYEES)

    const employees = await prisma.employee.findMany({
      where: { workspaceId },
    })

    return NextResponse.json(employees)
  })
}

export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, role }) => {
    // Check permission
    checkPermission(role as WorkspaceRole, Permission.MANAGE_EMPLOYEES)

    const data = await request.json()

    const employee = await prisma.employee.create({
      data: {
        ...data,
        workspaceId,
      },
    })

    return NextResponse.json(employee)
  })
}
```

**Example UI Component:**

```typescript
// components/settings/team-tab.tsx
'use client'

export function TeamTab() {
  const { role } = useWorkspace()

  return (
    <div>
      <h2>Team Members</h2>

      {/* Only show invite button for Owner/Admin */}
      <Can permission={Permission.INVITE_MEMBERS}>
        <button>Invite Member</button>
      </Can>

      {/* Member list */}
      <MemberList>
        {members.map((member) => (
          <MemberCard key={member.id}>
            {/* Only show remove button for Owner/Admin */}
            <Can permission={Permission.REMOVE_MEMBERS}>
              <button onClick={() => removeMember(member.id)}>
                Remove
              </button>
            </Can>
          </MemberCard>
        ))}
      </MemberList>
    </div>
  )
}
```

**Reference:** PRD Epic 5 Story 5.2, Architecture Section 12 (Multi-Tenancy), RBAC best practices

## Testing

**Unit Tests:**

- `hasPermission()` returns correct result for each role
- `checkPermission()` throws error when permission denied
- Permission helpers return correct boolean

**Integration Tests:**

- Owner can access all features
- Admin cannot access billing
- HR Manager can view/manage employees, cannot manage laws
- Member cannot view employees
- Auditor has read-only access to multiple workspaces
- API routes block unauthorized access

**Manual Testing:**

- Login as Owner, verify full access
- Login as Admin, verify cannot access billing
- Login as HR Manager, verify can manage employees, cannot manage laws
- Login as Member, verify cannot see employees
- Login as Auditor, verify read-only access

**Security Testing:**

- Attempt to access employees API as Member (should fail)
- Attempt to access billing API as Admin (should fail)
- Attempt to delete workspace as Admin (should fail)

**Test File:** `__tests__/features/permissions/roles.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**

- Assign appropriate roles to team members
- Understand role limitations
- Contact Owner for permissions if needed

**Developer Responsibility:**

- Define clear permission matrix
- Enforce permissions at API level (critical)
- Enforce permissions at UI level (UX)
- Document permissions in code
- Test all role combinations
- Return 403 Forbidden for permission errors

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
