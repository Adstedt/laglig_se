# Story 5.2: Implement User Roles and Permissions System

## Status

Draft

## Story

**As a** workspace owner,
**I want** to assign different roles to team members,
**so that** I control who can manage law lists, access HR data, and handle billing.

## Acceptance Criteria

1. Five roles defined: Owner, Admin, HR Manager, Member, Auditor
2. **Owner:** Full access including billing, workspace deletion, and all features
3. **Admin:** Full access except billing, workspace deletion, and employee data
4. **HR Manager:** Can manage law lists, invite members, and has full HR/employee access
5. **Member:** Can view lists, edit tasks/status, mark changes as reviewed, use AI chat
6. **Auditor:** Read-only access across all features (for ISO consultants, external reviewers)
7. Permissions enforced at API route level (middleware) - critical for security
8. Permissions enforced at UI level (hide/disable actions) - for UX
9. Permission matrix aligned with Story 5.1 workspace data model
10. Test: Each role's permissions verified against matrix

## Role Permissions Matrix

This matrix is the **source of truth** (aligned with Story 5.1):

| Action                          | Owner | Admin | HR Manager | Member | Auditor |
| ------------------------------- | :---: | :---: | :--------: | :----: | :-----: |
| Delete workspace                |  ✅   |  ❌   |     ❌     |   ❌   |   ❌    |
| Manage billing/subscription     |  ✅   |  ❌   |     ❌     |   ❌   |   ❌    |
| Manage workspace settings       |  ✅   |  ✅   |     ❌     |   ❌   |   ❌    |
| Invite/remove members           |  ✅   |  ✅   |     ✅     |   ❌   |   ❌    |
| Change member roles             |  ✅   |  ✅   |     ❌     |   ❌   |   ❌    |
| Create/delete law lists         |  ✅   |  ✅   |     ✅     |   ❌   |   ❌    |
| Add/remove documents from lists |  ✅   |  ✅   |     ✅     |   ❌   |   ❌    |
| Edit tasks/compliance status    |  ✅   |  ✅   |     ✅     |   ✅   |   ❌    |
| Mark changes as reviewed        |  ✅   |  ✅   |     ✅     |   ✅   |   ❌    |
| View employee data              |  ✅   |  ❌   |     ✅     |   ❌   |   ❌    |
| Manage employees                |  ✅   |  ❌   |     ✅     |   ❌   |   ❌    |
| Use AI chat                     |  ✅   |  ✅   |     ✅     |   ✅   |   ✅    |
| View lists/documents/kanban     |  ✅   |  ✅   |     ✅     |   ✅   |   ✅    |
| View activity log               |  ✅   |  ✅   |     ❌     |   ❌   |   ✅    |

### Role Descriptions

| Role           | Description                                                                                                    | Typical User                                   |
| -------------- | -------------------------------------------------------------------------------------------------------------- | ---------------------------------------------- |
| **Owner**      | Full control. Can delete workspace, manage billing, transfer ownership. Only one per workspace.                | Company founder, CEO                           |
| **Admin**      | Day-to-day management. Can manage team and law lists, but no billing or employee data access.                  | Compliance officer, Office manager             |
| **HR Manager** | HR-focused role. Full employee access, can manage law lists and invite team members.                           | HR director, People ops                        |
| **Member**     | Contributor role. Can work on tasks, mark changes reviewed, use AI chat. Cannot modify lists or invite others. | Team member, Department head                   |
| **Auditor**    | Read-only observer. Can view everything for audit purposes but cannot modify anything.                         | ISO consultant, External auditor, Board member |

## Tasks / Subtasks

- [ ] Define Role enum and Permission enum in TypeScript
- [ ] Create ROLE_PERMISSIONS mapping (source of truth)
- [ ] Implement `hasPermission(role, permission)` utility
- [ ] Create `requirePermission()` middleware for API routes
- [ ] Create `<Can permission={}>` component for UI
- [ ] Create `usePermissions()` hook for client-side checks
- [ ] Implement permission denied page (Swedish copy)
- [ ] Add permission checks to all existing API routes
- [ ] Add permission checks to all UI components with actions
- [ ] Write tests for all role/permission combinations

## Dev Notes

### Permission Definitions

```typescript
// lib/permissions.ts

export type Role = 'owner' | 'admin' | 'hr_manager' | 'member' | 'auditor'

export type Permission =
  // Workspace
  | 'workspace:delete'
  | 'workspace:billing'
  | 'workspace:settings'
  // Members
  | 'members:invite'
  | 'members:remove'
  | 'members:change_role'
  // Law Lists
  | 'lists:create'
  | 'lists:delete'
  | 'documents:add'
  | 'documents:remove'
  // Tasks & Changes
  | 'tasks:edit'
  | 'changes:acknowledge'
  // Employees
  | 'employees:view'
  | 'employees:manage'
  // General
  | 'ai:chat'
  | 'activity:view'
  | 'read' // Base read access

/**
 * Role Permissions Matrix - Source of Truth
 *
 * This must match Story 5.1 exactly.
 */
const ROLE_PERMISSIONS: Record<Role, Permission[]> = {
  owner: [
    // Full access
    'workspace:delete',
    'workspace:billing',
    'workspace:settings',
    'members:invite',
    'members:remove',
    'members:change_role',
    'lists:create',
    'lists:delete',
    'documents:add',
    'documents:remove',
    'tasks:edit',
    'changes:acknowledge',
    'employees:view',
    'employees:manage',
    'ai:chat',
    'activity:view',
    'read',
  ],

  admin: [
    // No: workspace:delete, workspace:billing, employees:*
    'workspace:settings',
    'members:invite',
    'members:remove',
    'members:change_role',
    'lists:create',
    'lists:delete',
    'documents:add',
    'documents:remove',
    'tasks:edit',
    'changes:acknowledge',
    'ai:chat',
    'activity:view',
    'read',
  ],

  hr_manager: [
    // No: workspace:*, members:change_role, activity:view
    'members:invite',
    'members:remove',
    'lists:create',
    'lists:delete',
    'documents:add',
    'documents:remove',
    'tasks:edit',
    'changes:acknowledge',
    'employees:view',
    'employees:manage',
    'ai:chat',
    'read',
  ],

  member: [
    // Limited: tasks, changes, ai, read
    'tasks:edit',
    'changes:acknowledge',
    'ai:chat',
    'read',
  ],

  auditor: [
    // Read-only + activity log
    'ai:chat',
    'activity:view',
    'read',
  ],
}

export function hasPermission(role: Role, permission: Permission): boolean {
  return ROLE_PERMISSIONS[role]?.includes(permission) ?? false
}

export function getAllPermissions(role: Role): Permission[] {
  return ROLE_PERMISSIONS[role] ?? []
}

// Convenience helpers
export const can = {
  deleteWorkspace: (role: Role) => hasPermission(role, 'workspace:delete'),
  manageBilling: (role: Role) => hasPermission(role, 'workspace:billing'),
  inviteMembers: (role: Role) => hasPermission(role, 'members:invite'),
  changeRoles: (role: Role) => hasPermission(role, 'members:change_role'),
  manageLists: (role: Role) => hasPermission(role, 'lists:create'),
  manageDocuments: (role: Role) => hasPermission(role, 'documents:add'),
  editTasks: (role: Role) => hasPermission(role, 'tasks:edit'),
  acknowledgeChanges: (role: Role) =>
    hasPermission(role, 'changes:acknowledge'),
  viewEmployees: (role: Role) => hasPermission(role, 'employees:view'),
  manageEmployees: (role: Role) => hasPermission(role, 'employees:manage'),
}
```

### API Middleware

```typescript
// lib/api/require-permission.ts

import { NextResponse } from 'next/server'
import { getWorkspaceContext } from '@/lib/workspace-context'
import { hasPermission, type Permission, type Role } from '@/lib/permissions'

export function requirePermission(...permissions: Permission[]) {
  return async function checkPermission() {
    const context = await getWorkspaceContext()
    const role = context.role as Role

    for (const permission of permissions) {
      if (!hasPermission(role, permission)) {
        return NextResponse.json(
          {
            error: 'Åtkomst nekad',
            message: 'Du har inte behörighet att utföra denna åtgärd',
            required: permission,
            userRole: role,
          },
          { status: 403 }
        )
      }
    }

    return null // Permission granted, continue
  }
}

// Usage in API routes
export async function POST(request: Request) {
  // Check permission first
  const denied = await requirePermission('documents:add')()
  if (denied) return denied

  // Permission granted, proceed with logic
  const context = await getWorkspaceContext()
  // ...
}
```

### React Components for UI Permission Checks

```typescript
// components/permissions/can.tsx
'use client'

import { useWorkspace } from '@/hooks/use-workspace'
import { hasPermission, type Permission, type Role } from '@/lib/permissions'

interface CanProps {
  permission: Permission | Permission[]
  children: React.ReactNode
  fallback?: React.ReactNode
  /** If true, requires ALL permissions. If false (default), requires ANY. */
  requireAll?: boolean
}

export function Can({
  permission,
  children,
  fallback = null,
  requireAll = false
}: CanProps) {
  const { role } = useWorkspace()

  const permissions = Array.isArray(permission) ? permission : [permission]

  const hasAccess = requireAll
    ? permissions.every(p => hasPermission(role as Role, p))
    : permissions.some(p => hasPermission(role as Role, p))

  if (!hasAccess) {
    return <>{fallback}</>
  }

  return <>{children}</>
}

// Usage examples:
// <Can permission="documents:add">
//   <Button>Lägg till lag</Button>
// </Can>
//
// <Can permission={['documents:add', 'lists:create']} requireAll>
//   <Button>Skapa lista med lagar</Button>
// </Can>
//
// <Can permission="employees:view" fallback={<LockedBadge />}>
//   <EmployeeList />
// </Can>
```

```typescript
// hooks/use-permissions.ts
'use client'

import { useWorkspace } from '@/hooks/use-workspace'
import {
  hasPermission,
  can,
  type Permission,
  type Role,
} from '@/lib/permissions'

export function usePermissions() {
  const { role } = useWorkspace()
  const typedRole = role as Role

  return {
    role: typedRole,
    has: (permission: Permission) => hasPermission(typedRole, permission),
    can: {
      deleteWorkspace: can.deleteWorkspace(typedRole),
      manageBilling: can.manageBilling(typedRole),
      inviteMembers: can.inviteMembers(typedRole),
      changeRoles: can.changeRoles(typedRole),
      manageLists: can.manageLists(typedRole),
      manageDocuments: can.manageDocuments(typedRole),
      editTasks: can.editTasks(typedRole),
      acknowledgeChanges: can.acknowledgeChanges(typedRole),
      viewEmployees: can.viewEmployees(typedRole),
      manageEmployees: can.manageEmployees(typedRole),
    },
  }
}

// Usage:
// const { can } = usePermissions()
// if (can.manageDocuments) { ... }
```

### Permission Denied Page

```typescript
// app/(workspace)/permission-denied/page.tsx

import Link from 'next/link'
import { ShieldX } from 'lucide-react'
import { Button } from '@/components/ui/button'

export default function PermissionDeniedPage() {
  return (
    <div className="flex min-h-[60vh] flex-col items-center justify-center text-center">
      <div className="mb-6 flex h-20 w-20 items-center justify-center rounded-full bg-destructive/10">
        <ShieldX className="h-10 w-10 text-destructive" />
      </div>

      <h1 className="mb-2 text-2xl font-bold">Åtkomst nekad</h1>

      <p className="mb-6 max-w-md text-muted-foreground">
        Du har inte behörighet att utföra denna åtgärd.
        Kontakta din workspace-ägare om du behöver utökad åtkomst.
      </p>

      <div className="flex gap-3">
        <Button variant="outline" asChild>
          <Link href="/dashboard">Tillbaka till dashboard</Link>
        </Button>
        <Button asChild>
          <Link href="/settings/team">Visa teammedlemmar</Link>
        </Button>
      </div>
    </div>
  )
}
```

### Example: Law List API with Permissions

```typescript
// app/api/law-lists/route.ts

import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { getWorkspaceContext } from '@/lib/workspace-context'
import { requirePermission } from '@/lib/api/require-permission'

// GET - Anyone with read access can list law lists
export async function GET() {
  const { workspaceId } = await getWorkspaceContext()

  const lists = await prisma.lawList.findMany({
    where: { workspace_id: workspaceId },
    include: {
      _count: { select: { items: true } },
    },
    orderBy: { created_at: 'desc' },
  })

  return NextResponse.json(lists)
}

// POST - Only users with lists:create can create new lists
export async function POST(request: Request) {
  const denied = await requirePermission('lists:create')()
  if (denied) return denied

  const { workspaceId, userId } = await getWorkspaceContext()
  const { name, description } = await request.json()

  const list = await prisma.lawList.create({
    data: {
      workspace_id: workspaceId,
      name,
      description,
      created_by: userId,
    },
  })

  return NextResponse.json(list, { status: 201 })
}
```

### Example: UI Component with Permissions

```typescript
// components/law-lists/law-list-header.tsx
'use client'

import { Can } from '@/components/permissions/can'
import { Button } from '@/components/ui/button'
import { Plus, Trash2 } from 'lucide-react'

interface LawListHeaderProps {
  listName: string
  onAddDocument: () => void
  onDeleteList: () => void
}

export function LawListHeader({
  listName,
  onAddDocument,
  onDeleteList
}: LawListHeaderProps) {
  return (
    <div className="flex items-center justify-between">
      <h1 className="text-2xl font-bold">{listName}</h1>

      <div className="flex gap-2">
        <Can permission="documents:add">
          <Button onClick={onAddDocument}>
            <Plus className="mr-2 h-4 w-4" />
            Lägg till lag
          </Button>
        </Can>

        <Can permission="lists:delete">
          <Button variant="destructive" onClick={onDeleteList}>
            <Trash2 className="mr-2 h-4 w-4" />
            Ta bort lista
          </Button>
        </Can>
      </div>
    </div>
  )
}
```

**Reference:** Story 5.1 (Workspace Data Model), PRD Epic 5

## Testing

### Unit Tests

```typescript
// __tests__/lib/permissions.test.ts

describe('permissions', () => {
  describe('owner', () => {
    it('has all permissions', () => {
      expect(hasPermission('owner', 'workspace:delete')).toBe(true)
      expect(hasPermission('owner', 'workspace:billing')).toBe(true)
      expect(hasPermission('owner', 'employees:manage')).toBe(true)
    })
  })

  describe('admin', () => {
    it('cannot delete workspace or manage billing', () => {
      expect(hasPermission('admin', 'workspace:delete')).toBe(false)
      expect(hasPermission('admin', 'workspace:billing')).toBe(false)
    })

    it('cannot view or manage employees', () => {
      expect(hasPermission('admin', 'employees:view')).toBe(false)
      expect(hasPermission('admin', 'employees:manage')).toBe(false)
    })

    it('can manage lists and documents', () => {
      expect(hasPermission('admin', 'lists:create')).toBe(true)
      expect(hasPermission('admin', 'documents:add')).toBe(true)
    })
  })

  describe('hr_manager', () => {
    it('can manage employees', () => {
      expect(hasPermission('hr_manager', 'employees:view')).toBe(true)
      expect(hasPermission('hr_manager', 'employees:manage')).toBe(true)
    })

    it('can manage lists and invite members', () => {
      expect(hasPermission('hr_manager', 'lists:create')).toBe(true)
      expect(hasPermission('hr_manager', 'members:invite')).toBe(true)
    })

    it('cannot change member roles', () => {
      expect(hasPermission('hr_manager', 'members:change_role')).toBe(false)
    })
  })

  describe('member', () => {
    it('can edit tasks and acknowledge changes', () => {
      expect(hasPermission('member', 'tasks:edit')).toBe(true)
      expect(hasPermission('member', 'changes:acknowledge')).toBe(true)
    })

    it('cannot manage lists or documents', () => {
      expect(hasPermission('member', 'lists:create')).toBe(false)
      expect(hasPermission('member', 'documents:add')).toBe(false)
    })

    it('cannot view employees', () => {
      expect(hasPermission('member', 'employees:view')).toBe(false)
    })
  })

  describe('auditor', () => {
    it('has read-only access', () => {
      expect(hasPermission('auditor', 'read')).toBe(true)
      expect(hasPermission('auditor', 'activity:view')).toBe(true)
    })

    it('cannot modify anything', () => {
      expect(hasPermission('auditor', 'tasks:edit')).toBe(false)
      expect(hasPermission('auditor', 'documents:add')).toBe(false)
      expect(hasPermission('auditor', 'changes:acknowledge')).toBe(false)
    })
  })
})
```

### Integration Tests

- Owner can access all API endpoints
- Admin receives 403 on billing and employee endpoints
- HR Manager can access employee endpoints, receives 403 on billing
- Member receives 403 on list management endpoints
- Auditor receives 403 on all POST/PUT/DELETE endpoints

### Manual Testing

- Login as each role and verify:
  - Owner: All buttons/actions visible and functional
  - Admin: No billing tab, no employee section
  - HR Manager: Full employee access, can manage lists
  - Member: Only task editing, no list management buttons
  - Auditor: Everything disabled/hidden except viewing

**Test File:** `__tests__/lib/permissions.test.ts`

## Change Log

| Date       | Version | Description                                                                                              | Author     |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                                                                   | Sarah (PO) |
| 2025-12-19 | 2.0     | Aligned with Story 5.1 permissions matrix, added law list permissions, fixed HR Manager and Admin access | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
