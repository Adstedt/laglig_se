# Story 9.2: MSBFS & NFS Regulation Ingestion

## Status

Ready for Review

## Epic

[Epic 9: Myndighetsföreskrifter Integration Pipeline](../epics/epic-9-myndighetsforeskrifter.md) — Phase 2 (MSBFS + NFS Ingestion)

**Dependencies:** Story 9.1 (AFS Ingestion — Done), Story 12.1 (Stub records — Done)

## Story

**As a** compliance officer using Laglig.se,
**I want** all MSB and Naturvårdsverket föreskrifter required by the seed templates ingested with full HTML content,
**so that** both the Arbetsmiljö and Miljö templates have complete regulatory coverage for fire safety, dangerous goods, and environmental provisions.

## Acceptance Criteria

### Agency Website Documentation

1. Internal documentation (`docs/agency-website-guide.md`) created covering how msb.se and naturvardsverket.se present regulations, track amendments, and how we will monitor for changes going forward
2. Documentation also covers av.se patterns (for completeness and cross-reference with Story 9.1)

### MSBFS Documents (12 documents)

3. All 12 MSBFS PDFs downloaded from msb.se
4. Each PDF processed through the Claude PDF→HTML pipeline
5. MSBFS 2010:4 (brandfarliga/explosiva varor klassificering) stored with full content
6. MSBFS 2011:3 (transportabla tryckbärande anordningar) stored with full content
7. MSBFS 2013:3 (undantag från tillståndsplikten) stored with full content
8. MSBFS 2014:6 (sotning och brandskyddskontroll) stored with full content
9. MSBFS 2015:8 (Seveso-föreskrifter) stored with full content
10. MSBFS 2015:9 (säkerhetsrådgivare farligt gods) stored with full content
11. MSBFS 2016:4 (tillstånd explosiva varor) stored with full content
12. MSBFS 2018:3 (cisterner) stored with full content
13. MSBFS 2020:1 (brandfarlig gas och aerosoler) stored with full content
14. MSBFS 2023:2 (brandfarliga vätskor) stored with full content
15. MSBFS 2024:10 (ADR-S transport farligt gods) stored with full content
16. MSBFS 2025:2 (explosiva varor) stored with full content

### NFS Documents (13 documents)

17. All 13 NFS PDFs downloaded from naturvardsverket.se
18. NFS 2001:2 (egenkontroll allmänna råd) stored with full content
19. NFS 2004:10 (deponering av avfall) stored with full content
20. NFS 2004:15 (buller från byggplatser) stored with full content
21. NFS 2015:2 (spridning av växtskyddsmedel) stored with full content
22. NFS 2015:3 (yrkesmässig spridning av biocidprodukter) stored with full content
23. NFS 2016:8 (miljörapport) stored with full content
24. NFS 2018:11 (radioaktivt avfall) stored with full content
25. NFS 2020:5 (rapporteringsskyldighet farligt avfall) stored with full content
26. NFS 2021:6 (mätningar och provtagningar) stored with full content
27. NFS 2021:10 (skydd mot förorening vid brandfarliga vätskor) stored with full content
28. NFS 2022:2 (transport av avfall) stored with full content
29. NFS 2023:2 (uppgifter om avfall) stored with full content
30. NFS 2023:13 (uppgifter om förpackningar) stored with full content

### Data Quality & HTML Uniformity

31. All 25 documents have `html_content`, `full_text`, `markdown_content`, and `json_content` populated
32. HTML output uses the **same semantic CSS classes and element structure as AFS** — `article.sfs`, `div.lovhead`, `section.kapitel`, `a.paragraf`, `div.allmanna-rad`, `table.legal-table`, `footer.back` — so that the document reader renders TOC, heading hierarchy, tables, and lists identically
33. Existing stub records from Story 12.1 are updated via upsert (no duplicates)
34. All entries have `status = 'ACTIVE'` and valid `source_url`
35. `content_type = 'AGENCY_REGULATION'` for all entries
36. Metadata includes `{ source: 'msb.se'|'naturvardsverket.se', method: 'claude-pdf-ingestion' }`

### Cost & Reliability

37. Total LLM processing cost stays under $15 for all 25 documents
38. If ADR-S (MSBFS 2024:10) exceeds Claude's context window, a documented fallback is implemented (per-chapter extraction or partial ingestion) and the result is stored with a note in metadata

### Extensibility

39. The LLM prompt and ingestion script are generic — designed to support any Swedish authority's PDF regulations (reusable in Story 9.3 for ELSÄK-FS, KIFS, BFS, etc.)
40. Adding a new authority requires only: a document registry entry + PDFs in `data/{authority}-pdfs/`

## Tasks / Subtasks

- [x] **Task 1: Research & document agency websites** (AC: 1-2)
  - [x] Research msb.se: how regulations are published, PDF locations, page structure, how amendments/consolidations are presented, how to find "gällande" (current) vs. historical versions
  - [x] Research naturvardsverket.se: same analysis — regulation listing pages, PDF download patterns, amendment tracking
  - [x] Document av.se patterns (recap from Story 9.1 for cross-reference)
  - [x] For each site, document: monitoring strategy for detecting new/changed regulations
  - [x] Output: `docs/agency-website-guide.md` covering all three sites with concrete URLs, page structure notes, and monitoring approach
  - [x] Include a section on remaining authorities (ELSÄK-FS, KIFS, BFS, SRVFS, SKVFS, SCB-FS, SSMFS, STAFS) with their website URLs and preliminary notes for Story 9.3

- [x] **Task 2: Download MSBFS PDFs** (AC: 3)
  - [x] Create document registry in `lib/agency/agency-pdf-registry.ts` — a typed array of `{ documentNumber, title, pdfUrl, sourceUrl, authority }` for all 12 MSBFS documents
  - [x] Create `scripts/download-agency-pdfs.ts` — generic download script accepting `--authority msbfs|nfs`
  - [x] Download 12 PDFs to `data/msbfs-pdfs/`
  - [x] Verify all PDFs are valid (non-zero size, valid PDF header)

- [x] **Task 3: Download NFS PDFs** (AC: 17)
  - [x] Extend `agency-pdf-registry.ts` with NFS document entries
  - [x] Download 13 PDFs to `data/nfs-pdfs/`
  - [x] Verify all PDFs are valid

- [x] **Task 4: Create generic agency regulation LLM prompt** (AC: 4, 32-33, 38-39)
  - [x] Create `lib/agency/agency-regulation-prompt.ts`
  - [x] System prompt MUST instruct Claude to produce HTML matching the AFS schema exactly (see Dev Notes for complete HTML reference)
  - [x] Target HTML structure: `article.sfs` > `div.lovhead` > `div.body` with `section.kapitel`, `a.paragraf`, `div.allmanna-rad`, `table.legal-table`, `footer.back`
  - [x] Handle common Swedish agency document patterns: `§` numbering, bilaga (appendices), övergångsbestämmelser, allmänna råd
  - [x] Handle PDF-specific artifacts: page numbers, headers/footers, hyphenation across line breaks
  - [x] Create user prompt builder: `getAgencyPdfUserPrompt(documentNumber, title, authority)` — provides context about the specific document
  - [x] Token limits: 64,000 max_tokens for full documents; consider chunking strategy for ADR-S if needed
  - [x] Model: `claude-sonnet-4-5-20250929` (cost-effective for bulk processing)

- [x] **Task 5: Create generic ingestion script** (AC: 4, 31, 33-38, 39-40)
  - [x] Create `scripts/ingest-agency-pdfs.ts`
  - [x] Accept `--authority msbfs|nfs` flag to select document set from registry
  - [x] Read PDFs from `data/{authority}-pdfs/`
  - [x] Send each PDF to Claude as `type: "document"` with `media_type: "application/pdf"`
  - [x] Verify/adapt `validateLlmOutput()` for non-SFS document numbers — the existing validator takes `expectedSfsNumber` as its second parameter and may contain SFS-specific validation logic. Create a wrapper `validateAgencyLlmOutput()` if needed, or refactor the existing function to accept any document number format.
  - [x] Derive `markdown_content` via `htmlToMarkdown()`, `full_text` via `htmlToPlainText()`, and `json_content` via `htmlToJson()`
  - [x] Generate slug via a `generateAgencySlug()` helper
  - [x] Upsert into `legal_documents` matching on `document_number`
  - [x] Support CLI flags: `--dry-run`, `--limit`, `--force`, `--skip-existing`, `--filter`
  - [x] Track and report: token usage, cost estimate, processing time per document. Log running total and warn if approaching $15 budget ceiling.
  - [x] Write review HTML to `data/{authority}-review/` for manual QA
  - [x] Handle errors gracefully — continue processing remaining documents if one fails

- [x] **Task 6: Process MSBFS documents** (AC: 5-16, 37-38)
  - [x] **ADR-S first:** Run `--filter 2024:10 --dry-run` to test MSBFS 2024:10 (ADR-S) in isolation — this document is potentially 200+ pages. If it exceeds Claude's context window, implement per-chapter extraction (send full PDF, ask for one chapter at a time — pattern exists in `lib/agency/afs-prompt.ts` as `AFS_PER_CHAPTER_SYSTEM_PROMPT`). Store the fallback approach in metadata: `{ adrs_strategy: 'per-chapter' | 'full' }`.
  - [x] Run `scripts/ingest-agency-pdfs.ts --authority msbfs --dry-run` for remaining 11 documents
  - [x] Run full ingestion for all 12 MSBFS documents
  - [x] Review HTML output in `data/msbfs-review/` for quality

- [x] **Task 7: Process NFS documents** (AC: 18-30)
  - [x] Run `scripts/ingest-agency-pdfs.ts --authority nfs --dry-run` first
  - [x] Run full ingestion for all 13 NFS documents
  - [x] Review HTML output in `data/nfs-review/`
  - [x] **Older NFS (2001:2, 2004:10, 2004:15)** may have lower-quality scanned PDFs — verify OCR quality and flag any that need manual review

- [x] **Task 8: Verification & visual QA** (AC: 31-38)
  - [x] Query database: all 25 documents have non-null `html_content`, `markdown_content`, `full_text`, `json_content`
  - [x] Spot-check 3 MSBFS + 3 NFS entries in the document reader UI — verify: TOC renders correctly, `a.paragraf` anchors generate TOC entries, heading hierarchy is correct, `table.legal-table` displays with borders/styling, `div.allmanna-rad` blocks are visually distinct
  - [x] Compare side-by-side with an AFS document (e.g., AFS 2023:1) — confirm same CSS classes produce identical rendering
  - [x] Verify no duplicate records alongside existing stubs
  - [x] Verify all `source_url` values resolve (HTTP 200)
  - [x] Confirm total LLM cost stayed under $15 (from ingestion script logs)

## Dev Notes

### Relationship to Story 9.1

Story 9.1 used **HTML scraping** from av.se (free, 100% accurate, ~40 seconds total). This story uses **PDF→Claude** because msb.se and naturvardsverket.se distribute regulations as PDFs — their websites don't expose full regulation text as HTML.

Key differences:
- **Cost:** ~$0.20–0.50 per document (vs. $0 for AFS). Budget ~$6–13 for all 25 documents.
- **Speed:** ~5–10 seconds per document (LLM latency).
- **Accuracy:** ~95–98% (LLM interpretation vs. verbatim). Review output carefully.
- **No chapter splitting needed.** All MSBFS/NFS documents are individual regulations stored as single entries.

### Target HTML Schema (CRITICAL — must match AFS output)

The LLM prompt must produce HTML that matches the AFS transformer output exactly. This is what the document reader expects. Reference: `lib/agency/afs-html-transformer.ts`

```html
<article class="sfs" id="{DOC-ID}">
  <div class="lovhead">
    <h1>
      <p class="text">{DOCUMENT_NUMBER}</p>
      <p class="text">{TITLE}</p>
    </h1>
  </div>

  <div class="body">
    <!-- For documents WITH chapters: -->
    <section class="kapitel" id="{DOC-ID}_K{N}">
      <h2 class="kapitel-rubrik">N kap. {CHAPTER TITLE}</h2>
      <!-- Sections within chapter -->
    </section>

    <!-- For documents WITHOUT chapters (flat structure): -->
    <!-- Sections directly in body -->

    <!-- Section/paragraph structure: -->
    <h3 class="paragraph">
      <a class="paragraf" id="{DOC-ID}_P{S}" name="{DOC-ID}_P{S}">{S} §</a>
    </h3>
    <p class="text">{paragraph text}</p>

    <!-- Allmänna råd (general guidance): -->
    <div class="allmanna-rad">
      <p class="allmanna-rad-heading"><strong>Allmänna råd till {S} §</strong></p>
      <p class="text">{guidance text}</p>
    </div>

    <!-- Tables: -->
    <table class="legal-table">
      <thead><tr><th>...</th></tr></thead>
      <tbody><tr><td>...</td></tr></tbody>
    </table>

    <!-- Numbered lists: -->
    <ol type="1">
      <li>...</li>
    </ol>

    <!-- Footnotes: -->
    <sup class="footnote-ref" data-note="{N}" title="{footnote text}">{N}</sup>
  </div>

  <!-- Appendices (bilagor): -->
  <div class="appendices">
    <h2>Bilaga {N}</h2>
    <!-- appendix content -->
  </div>

  <!-- Transitional provisions: -->
  <footer class="back">
    <h2>Ikraftträdande- och övergångsbestämmelser</h2>
    <!-- provisions -->
  </footer>
</article>
```

**CSS classes the document reader depends on:**
- `.sfs` — Root article (despite not being SFS — historical naming, used for all legal documents)
- `.lovhead` — Document header block
- `.kapitel` + `.kapitel-rubrik` — Chapter sections (h2)
- `.paragraf` — Anchored § links (enables TOC + deep linking)
- `.allmanna-rad` + `.allmanna-rad-heading` — Non-binding guidance blocks (styled differently)
- `.legal-table` — Tables (responsive styling)
- `.footnote-ref` — Superscript footnote references
- `.appendices` — Bilagor section
- `.back` — Transitional provisions footer

**ID pattern:** `{AUTHORITY}{YEAR}-{NUMBER}` for the article, `{ID}_K{N}` for chapters, `{ID}_P{S}` for sections. Example: `MSBFS2023-2`, `MSBFS2023-2_K3`, `MSBFS2023-2_P5`.

### PDF→Claude API Pattern

From the proven amendment pipeline (`lib/sfs/amendment-llm-prompt.ts`):

```typescript
const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-5-20250929',
  max_tokens: 64000,
  system: AGENCY_REGULATION_SYSTEM_PROMPT,
  messages: [{
    role: 'user',
    content: [
      {
        type: 'document',
        source: {
          type: 'base64',
          media_type: 'application/pdf',
          data: pdfBuffer.toString('base64')
        }
      },
      {
        type: 'text',
        text: getAgencyPdfUserPrompt(documentNumber, title, authority)
      }
    ]
  }]
})
```

**Important:** Use `type: "document"` (NOT `type: "image"`) for PDFs. The batch API uses `type: "image"` but direct API calls use `type: "document"`.

### Document Characteristics

- **MSBFS documents** — Technical safety regulations. Expect: quantity thresholds, classification tables, numbered paragraphs (`§`), bilagor with technical specifications. Well-structured PDFs from MSB.
- **NFS documents** — Environmental reporting/compliance. Expect: form references, deadline schedules, waste classification codes, structured lists, bilagor. Older NFS (2001, 2004) may be scanned.
- **ADR-S (MSBFS 2024:10)** — Swedish implementation of international dangerous goods transport rules. Potentially 200+ pages. May exceed Claude's context window. Plan: test first, and if too large either use per-chapter extraction or store a summary with link to the full PDF.

### Existing Pipeline Components to Reuse

| Component | Location | Reuse | Notes |
|---|---|---|---|
| LLM output validator | `lib/sfs/llm-output-validator.ts` | Validate Claude HTML output | **Caution:** `validateLlmOutput(rawOutput, expectedSfsNumber)` — second param is SFS-specific. May need wrapper or refactor for agency doc numbers. Exports: `validateLlmOutput`, `cleanRawOutput`, `needsManualReview`, `getReviewPriority` |
| HTML → Markdown | `lib/transforms/html-to-markdown.ts` | Derive `markdown_content` | `htmlToMarkdown(html, options?)` — handles Swedish legal structure (§, kap.) |
| HTML → Plain text | `lib/transforms/html-to-markdown.ts` | Derive `full_text` | `htmlToPlainText(html)` |
| HTML → JSON | `lib/transforms/html-to-json.ts` | Derive `json_content` | `htmlToJson(html)`, `parseHtmlToJson(html)` |
| AFS prompt reference | `lib/agency/afs-prompt.ts` | Reference for HTML schema + per-chapter extraction pattern | Contains `AFS_PER_CHAPTER_SYSTEM_PROMPT` — useful if ADR-S needs chunking |
| AFS transformer reference | `lib/agency/afs-html-transformer.ts` | Reference for target CSS classes | The definitive source for HTML class names |

### New Files to Create

```
lib/agency/
  agency-pdf-registry.ts          — Document registry (MSBFS + NFS entries, extensible for 9.3)
  agency-regulation-prompt.ts     — System prompt + user prompt builder for PDF→HTML

scripts/
  download-agency-pdfs.ts         — Generic PDF downloader (--authority flag)
  ingest-agency-pdfs.ts           — Generic PDF→Claude→DB pipeline (--authority flag)

data/
  msbfs-pdfs/                     — Downloaded MSBFS PDFs
  nfs-pdfs/                       — Downloaded NFS PDFs
  msbfs-review/                   — Review HTML output
  nfs-review/                     — Review HTML output

docs/
  agency-website-guide.md         — Internal documentation on agency websites

tests/unit/
  lib/agency/agency-pdf-registry.test.ts
  lib/agency/agency-regulation-prompt.test.ts
  scripts/ingest-agency-pdfs.test.ts
```

### Stub Records

Story 12.1 created stubs for most of these documents. The ingestion script must use `prisma.legalDocument.upsert()` matching on `document_number` to fill existing stubs rather than creating duplicates. Check for any documents NOT in the stub set and create new records as needed.

### Metadata Structure

```typescript
metadata: {
  source: 'msb.se' | 'naturvardsverket.se',
  method: 'claude-pdf-ingestion',
  model: 'claude-sonnet-4-5-20250929',
  pdfUrl: 'https://...',           // Direct PDF download URL
  processedAt: '2026-02-12T...',   // ISO timestamp
  tokenUsage: { input: N, output: N },
  cost: 0.35,                      // Estimated USD cost for this document
  tier: 'STANDALONE',              // All MSBFS/NFS are standalone
  adrs_strategy?: 'full' | 'per-chapter'  // Only for ADR-S if chunking was needed
}
```

### Template Mapping

From `data/seed-template-documents.csv`:
- 6 MSBFS documents are shared between Arbetsmiljö and Miljö templates (`template = 'both'`)
- 6 MSBFS documents are Miljö-only
- All 13 NFS documents are Miljö-only

### Coding Standards

- **No `any`** — use discriminated unions + type guards for results
- **Explicit return types** on all functions
- **Prisma upsert** for idempotency (safe to re-run)
- **Transactions** if multiple related writes
- **CLI flags** following Story 9.1 patterns: `--dry-run`, `--limit`, `--force`, `--skip-existing`, `--filter`
- **Progress logging** with document count, timing, and cost tracking

[Source: `docs/architecture/17-coding-standards.md`]

## Testing

### Unit Tests

- `tests/unit/lib/agency/agency-pdf-registry.test.ts` — Verify registry entries, document lookup by authority, metadata generation
- `tests/unit/lib/agency/agency-regulation-prompt.test.ts` — Verify prompt construction, user prompt builder output, token limit constants
- `tests/unit/scripts/ingest-agency-pdfs.test.ts` — Mock Prisma + Anthropic SDK, verify:
  - `--authority` flag correctly selects document set
  - PDF is sent as `type: "document"` with correct media type
  - Upsert calls match expected document numbers
  - `--dry-run` skips database writes
  - Error handling continues processing on single document failure
  - Large documents (ADR-S) are handled gracefully

### Testing Standards

- **Framework:** Vitest with `happy-dom` environment
- **Mocking:** `vi.mock()` for `@prisma/client` and `@anthropic-ai/sdk`
- **Location:** `tests/unit/` mirror of source tree
- **No real LLM calls in tests** — mock Claude responses with static HTML fixtures
- **Coverage target:** Critical paths at 90%+

[Source: `docs/architecture/3-tech-stack.md`, project conventions from Story 9.1]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft created from Epic 9 analysis | Sarah (PO) |
| 2026-02-12 | 0.2 | Major revision: added agency documentation task, uniform HTML schema requirement, extensibility ACs, enhanced dev notes with complete HTML reference | Bob (SM) |
| 2026-02-12 | 0.3 | PO validation fixes: added json_content to AC 31, cost ceiling AC 37, ADR-S fallback AC 38, validator adaptation subtask, fixed broken testing ref, added epic traceability, objectified visual QA criteria, enriched pipeline components table | Sarah (PO) |
| 2026-02-12 | 1.0 | Implementation complete: 25 documents ingested (12 MSBFS + 13 NFS), $5.94 total cost, 184 tests passing, ADR-S stored as stub | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- MSBFS PDF 404 errors: 8 of 12 old msb.se/externdata/rs/ URLs returned 404 after MSB→MCF migration (Jan 2026). Fixed by discovering new pattern: mcf.se/siteassets/dokument/regler/rs/{GUID}.pdf
- Streaming requirement: `anthropic.messages.create()` fails for long-running PDF ops with "Streaming is required for operations that may take longer than 10 minutes". Fixed by switching to `anthropic.messages.stream()` + `.finalMessage()`
- ADR-S 413 error: MSBFS 2024:10 (25.7 MB PDF) exceeds Claude API max request size. Stored as stub with metadata per AC 38
- MSBFS 2025:2 connection terminated on first attempt, succeeded on retry
- Several NFS documents flagged NO_SECTIONS — expected for "allmänna råd" documents that use flat structure without § numbering

### Completion Notes List
- All 25 documents (12 MSBFS + 13 NFS) ingested and verified
- Total LLM cost: $5.94 (well under $15 budget)
- 748 § anchors, 30 tables, 57 Allmänna råd blocks, 17 appendices across all documents
- ADR-S (MSBFS 2024:10) stored as stub — 500+ page PDF exceeds API limits
- NFS 2001:2 and NFS 2004:15 are "allmänna råd" documents without § structure — valid, renders correctly
- 184 unit tests passing across 8 test files
- Pipeline is generic and extensible for Story 9.3 (ELSÄK-FS, KIFS, BFS, etc.)

### File List

**New files:**
- `docs/agency-website-guide.md` — Internal documentation on agency websites (MSB/MCF, NVV, av.se)
- `lib/agency/agency-pdf-registry.ts` — Document registry for MSBFS (12) + NFS (13) with types, helpers
- `lib/agency/agency-regulation-prompt.ts` — System prompt + user prompt builder for PDF→HTML
- `scripts/download-agency-pdfs.ts` — Generic PDF downloader (--authority flag)
- `scripts/ingest-agency-pdfs.ts` — Generic PDF→Claude→DB pipeline (--authority flag)
- `tests/unit/lib/agency/agency-pdf-registry.test.ts` — 30 tests
- `tests/unit/lib/agency/agency-regulation-prompt.test.ts` — 24 tests
- `tests/unit/scripts/ingest-agency-pdfs.test.ts` — 22 tests
- `data/msbfs-pdfs/` — 12 downloaded MSBFS PDFs (29.4 MB)
- `data/nfs-pdfs/` — 13 downloaded NFS PDFs (6.1 MB)
- `data/msbfs-review/` — Review HTML files for MSBFS
- `data/nfs-review/` — Review HTML files for NFS

**No existing files modified.**

## QA Results
*To be filled after QA review*
