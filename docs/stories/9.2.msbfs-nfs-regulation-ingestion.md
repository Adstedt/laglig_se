# Story 9.2: MSBFS & NFS Regulation Ingestion

## Status

Draft

## Story

**As a** compliance officer using Laglig.se,
**I want** all MSB and Naturvårdsverket föreskrifter required by the seed templates ingested with full HTML content,
**so that** both the Arbetsmiljö and Miljö templates have complete regulatory coverage for fire safety, dangerous goods, and environmental provisions.

## Acceptance Criteria

### MSBFS Documents (12 documents)

1. All 12 MSBFS PDFs downloaded from msb.se
2. Each PDF processed through the Claude PDF→HTML pipeline
3. MSBFS 2010:4 (brandfarliga/explosiva varor klassificering) stored with full content
4. MSBFS 2011:3 (transportabla tryckbärande anordningar) stored with full content
5. MSBFS 2013:3 (undantag från tillståndsplikten) stored with full content
6. MSBFS 2014:6 (sotning och brandskyddskontroll) stored with full content
7. MSBFS 2015:8 (Seveso-föreskrifter) stored with full content
8. MSBFS 2015:9 (säkerhetsrådgivare farligt gods) stored with full content
9. MSBFS 2016:4 (tillstånd explosiva varor) stored with full content
10. MSBFS 2018:3 (cisterner) stored with full content
11. MSBFS 2020:1 (brandfarlig gas och aerosoler) stored with full content
12. MSBFS 2023:2 (brandfarliga vätskor) stored with full content
13. MSBFS 2024:10 (ADR-S transport farligt gods) stored with full content
14. MSBFS 2025:2 (explosiva varor) stored with full content

### NFS Documents (13 documents)

15. All 13 NFS PDFs downloaded from naturvardsverket.se
16. NFS 2001:2 (egenkontroll allmänna råd) stored with full content
17. NFS 2004:10 (deponering av avfall) stored with full content
18. NFS 2004:15 (buller från byggplatser) stored with full content
19. NFS 2015:2 (spridning av växtskyddsmedel) stored with full content
20. NFS 2015:3 (yrkesmässig spridning av biocidprodukter) stored with full content
21. NFS 2016:8 (miljörapport) stored with full content
22. NFS 2018:11 (radioaktivt avfall) stored with full content
23. NFS 2020:5 (rapporteringsskyldighet farligt avfall) stored with full content
24. NFS 2021:6 (mätningar och provtagningar) stored with full content
25. NFS 2021:10 (skydd mot förorening vid brandfarliga vätskor) stored with full content
26. NFS 2022:2 (transport av avfall) stored with full content
27. NFS 2023:2 (uppgifter om avfall) stored with full content
28. NFS 2023:13 (uppgifter om förpackningar) stored with full content

### Data Quality

29. All 25 documents have `html_content`, `full_text`, and `markdown_content` populated
30. HTML uses `.legal-document` CSS structure consistent with existing documents
31. Existing stub records from Story 12.1 are updated via upsert (no duplicates)
32. All entries have `status = 'ACTIVE'` and valid `source_url`
33. `content_type = 'AGENCY_REGULATION'` for all entries

## Tasks / Subtasks

- [ ] **Task 1: Download MSBFS PDFs** (AC: 1)
  - [ ] Create `scripts/download-msbfs-pdfs.ts` (or extend a shared download utility)
  - [ ] Navigate msb.se/sv/regler/foreskrifter/ to locate each PDF
  - [ ] Download 12 PDFs to `data/msbfs-pdfs/`
  - [ ] Log source URL for each document

- [ ] **Task 2: Download NFS PDFs** (AC: 15)
  - [ ] Create `scripts/download-nfs-pdfs.ts` (or extend shared utility)
  - [ ] Navigate naturvardsverket.se/om-oss/foreskrifter/ to locate each PDF
  - [ ] Download 13 PDFs to `data/nfs-pdfs/`
  - [ ] Log source URL for each document

- [ ] **Task 3: Create agency regulation LLM prompt** (AC: 2, 30)
  - [ ] Create `lib/agency/agency-regulation-prompt.ts` (generic, reusable for all non-AFS agencies)
  - [ ] Base on `AMENDMENT_PDF_SYSTEM_PROMPT` adapted for föreskrifter format
  - [ ] Handle common agency document patterns: paragraf numbering, bilaga (appendices), transitional provisions
  - [ ] Reuse from Story 9.1 if a suitable generic prompt was created there

- [ ] **Task 4: Create MSBFS/NFS ingestion script** (AC: 1-33)
  - [ ] Create `scripts/ingest-agency-regulations.ts` (generic for any authority)
  - [ ] Accept `--authority msbfs` or `--authority nfs` flag to select document set
  - [ ] Read PDFs from `data/{authority}-pdfs/`
  - [ ] Process each through Claude PDF→HTML pipeline
  - [ ] Validate with `validateLlmOutput()` or equivalent
  - [ ] Derive `markdown_content` and `full_text` from HTML
  - [ ] Upsert into `legal_documents` matching on `document_number`
  - [ ] Support `--dry-run`, `--limit`, `--force` flags
  - [ ] Track token usage and costs

- [ ] **Task 5: Process MSBFS documents** (AC: 3-14)
  - [ ] Run ingestion pipeline for all 12 MSBFS documents
  - [ ] Validate HTML output quality
  - [ ] Note: MSBFS 2024:10 (ADR-S) may be very large — verify it fits within Claude's context window

- [ ] **Task 6: Process NFS documents** (AC: 16-28)
  - [ ] Run ingestion pipeline for all 13 NFS documents
  - [ ] Validate HTML output quality
  - [ ] Note: Older NFS (2001, 2004) may have lower-quality PDF scans — verify OCR quality

- [ ] **Task 7: Verification** (AC: 29-33)
  - [ ] Query database: all 25 documents have non-null content fields
  - [ ] Spot-check 3 MSBFS + 3 NFS entries for HTML quality
  - [ ] Verify no duplicate records created alongside existing stubs

## Dev Notes

### Pipeline Reuse from Story 9.1

Story 9.1 establishes the AFS ingestion pipeline. This story reuses the same core approach but is simpler — no chapter splitting needed. MSBFS and NFS documents are individual regulations, each stored as a single `legal_document` entry.

If Story 9.1 creates a generic `scripts/ingest-agency-regulations.ts`, this story simply runs it with different authority flags.

### Source Websites

- **MSBFS:** [msb.se/sv/regler/foreskrifter/](https://www.msb.se/sv/regler/foreskrifter/) — Well-organized, PDFs available directly
- **NFS:** [naturvardsverket.se/om-oss/foreskrifter/](https://www.naturvardsverket.se/om-oss/foreskrifter/) — Searchable by NFS number
- **Legacy SRVFS:** Some older MSB documents may be under legacy Räddningsverket URLs — check msb.se first

### Document Characteristics

- **MSBFS documents** tend to be technical safety regulations with specific quantity thresholds, classification tables, and handling requirements. Expect tables and numbered paragraphs.
- **NFS documents** tend to be environmental reporting requirements with form references, deadline schedules, and waste classification codes. Expect structured lists and appendices.
- **ADR-S (MSBFS 2024:10)** is the Swedish implementation of international dangerous goods transport rules — potentially very large (hundreds of pages). May need special handling or partial extraction.

### Stub Records

Story 12.1 created stubs for most of these documents. The ingestion script must use `prisma.legalDocument.upsert()` on `document_number` to fill existing stubs. Check for any documents NOT in the stub set and create new records as needed.

### LegalDocument Fields to Populate

Same as Story 9.1:
```
html_content      — LLM-generated semantic HTML
markdown_content  — Derived via htmlToMarkdown()
full_text         — Plain text for search/RAG
source_url        — Direct URL to PDF on authority website
metadata          — { source: 'msb.se'|'naturvardsverket.se', method: 'claude-pdf-ingestion' }
status            — 'ACTIVE'
```

### Template Mapping

From `data/seed-template-documents.csv`:
- 6 MSBFS documents are shared between Arbetsmiljö and Miljö templates (`template = 'both'`)
- 6 MSBFS documents are Miljö-only
- All 13 NFS documents are Miljö-only

### Data Reference

Complete document inventory: `data/seed-template-documents.csv`

## Testing

### Unit Tests

- `tests/unit/scripts/ingest-agency-regulations.test.ts` — Mock Prisma + Anthropic SDK, verify upsert calls for MSBFS and NFS document numbers
- Verify `--authority` flag correctly selects document set
- Verify large documents (ADR-S) are handled gracefully

### Testing Standards

- **Framework:** Vitest with `happy-dom` environment
- **Mocking:** `vi.mock()` for `@prisma/client` and `@anthropic-ai/sdk`
- **Location:** `tests/unit/` mirror of source tree
- **No real LLM calls in tests**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft created from Epic 9 analysis | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*To be filled after QA review*
