# Story 6.9: Implement Threaded Comments

## Status

Draft

## Story

**As a** user,
**I want** to have threaded discussions on tasks,
**so that** I can collaborate with my team on compliance work.

## Acceptance Criteria

1. Comments section in Task Modal
2. Root comments displayed chronologically
3. "Svara" button on each comment creates nested reply
4. Thread depth: Max 3 levels (root -> reply -> reply-to-reply)
5. Collapsed threads: "Visa 3 svar" expander
6. **Comment format:**
   - User avatar
   - User name
   - Timestamp (relative: "for 2 timmar sedan")
   - Comment text (markdown rendered)
   - "Svara" button
   - "Redigera" (own comments only)
   - "Radera" (own comments only, with confirmation)
7. Rich text: Bold, italic, links, code blocks, bullet lists
8. @mentions: Type @ to search team members, sends notification
9. Edit history: "Redigerad" indicator, click to see original
10. Real-time updates: New comments appear without refresh (WebSocket or polling)

## Tasks / Subtasks

_To be detailed during sprint planning_

- [ ] Create comments table with parent_comment_id for threading
- [ ] Build comment display component with nesting
- [ ] Implement comment input with markdown support
- [ ] Add reply functionality with thread nesting
- [ ] Build @mention autocomplete
- [ ] Implement edit/delete for own comments
- [ ] Add "Redigerad" indicator and edit history
- [ ] Implement real-time updates (polling or WebSocket)
- [ ] Add thread collapse/expand

## Dev Notes

### Data Model

```sql
comments
  - id UUID PRIMARY KEY
  - task_id UUID REFERENCES tasks(id)
  - parent_comment_id UUID REFERENCES comments(id) -- NULL for root comments
  - user_id UUID REFERENCES users(id)
  - content TEXT NOT NULL
  - original_content TEXT -- stored when edited
  - edited_at TIMESTAMP
  - created_at TIMESTAMP
  - updated_at TIMESTAMP
```

### Thread Depth Enforcement

Max 3 levels enforced in UI - reply button hidden at level 3.

### File Locations

```
components/features/tasks/
  comments/
    comment-list.tsx
    comment-item.tsx
    comment-input.tsx
    mention-autocomplete.tsx
    thread-collapse.tsx
```

### Real-time Options

1. **Polling:** Fetch new comments every 30 seconds
2. **Supabase Realtime:** Subscribe to comments table changes

Recommend polling for MVP simplicity.

## Testing

- Unit tests for comment nesting logic
- E2E tests for comment CRUD
- Test @mention autocomplete
- Test thread collapse/expand

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-01-08 | 1.0     | Initial story creation | Sarah (PO) |
