# Story 4.6: Build Post-Signup Phase 2 Completion UI

## Status

Draft

## Story

**As a** new user,
**I want** to see my law list complete in the background after signup,
**so that** I have comprehensive 60-80 law coverage without waiting.

## Acceptance Criteria

### Dashboard Progress Indicator

1. After signup, user lands on Dashboard with 15-30 Phase 1 laws visible immediately
2. Progress bar displayed at top of Dashboard:
   - "Kompletterar din laglista... 23/68 lagar"
   - Animated progress bar fills as laws generate
   - Estimated time remaining: "~45 sekunder kvar"
   - Dismissible: Small [X] button hides bar, but generation continues in background
3. Progress bar color: Primary brand color with subtle animation (shimmer or pulse)
4. Mobile-responsive: Full-width on mobile, partial-width on desktop

### Real-Time Law Streaming

5. New laws from Phase 2 appear with fade-in animation as they're generated
6. Each new law card tagged with "‚ú® NY GENERERAD" badge (disappears after 3 seconds)
7. Laws auto-organize into categories as they populate:
   - Grundl√§ggande (23) - already populated from Phase 1
   - Arbetsmilj√∂ (12) - populates as generated
   - Branschspecifika (8) - populates as generated
   - GDPR & Data (5) - populates as generated
   - Ekonomi (8) - populates as generated
   - Milj√∂ (3) - populates as generated
   - √ñvrigt (2) - populates as generated
8. Category counts update in real-time: "Arbetsmilj√∂ (8)" ‚Üí "Arbetsmilj√∂ (9)" ‚Üí "Arbetsmilj√∂ (12)"
9. Smooth transitions: No jarring reordering, laws append to bottom of each category

### User Interaction During Generation

10. User can interact with Dashboard during Phase 2 generation (NOT blocked)
11. User can click law cards to view details (opens in new tab/modal, doesn't interrupt generation)
12. User can set notification preferences while generation runs
13. User can start AI chat while generation runs (Phase 1 laws already available as context)
14. If user navigates away from Dashboard, generation continues in background
15. Progress bar reappears if user returns to Dashboard before completion

### Completion Experience

16. When Phase 2 completes, show toast notification (top-right or center):
    - "‚úÖ Klar! 68 lagar i din lista √§r nu kompletta och aktiverade f√∂r √§ndringsbevakning"
    - Auto-dismisses after 8 seconds
    - Subtle confetti animation (optional, can be disabled in user settings)
17. Progress bar transitions to success state: "‚úÖ Din laglista √§r komplett med 68 lagar"
18. Success banner auto-dismisses after 10 seconds or on manual close
19. Database updates: workspace.phase2_generation_status = 'complete'
20. Analytics event tracked: `phase2_generation_complete` with duration and law count

### Error Handling

21. If Phase 2 generation fails (API error, timeout):
    - Progress bar shows: "‚è∏Ô∏è Kompletterar din laglista, tar lite l√§ngre tid √§n f√∂rv√§ntat..."
    - Retry mechanism: Automatic retry up to 3 times with exponential backoff
    - If all retries fail: "Vi slutf√∂r din laglista snart. Du f√•r ett mejl n√§r det √§r klart."
22. User can continue using app with Phase 1 laws while Phase 2 retries
23. Email sent when Phase 2 eventually completes: "Din laglista med 68 lagar √§r nu klar!"

### Frontend Polling

24. Dashboard polls `GET /api/onboarding/phase2-status/{workspaceId}` every 2 seconds during generation
25. Response format: `{ progress: 45, total: 68, complete: false, newLaws: [{law_id, title, ...}] }`
26. Polling stops when `complete: true` or user navigates away (resumes on return)
27. Efficient polling: Only fetch new laws since last poll (not full list every time)

### Testing

28. Test with slow network: Verify UI doesn't break, progress bar shows accurately
29. Test browser close during Phase 2: Verify generation continues server-side, resumes UI on return
30. Test with Phase 2 failure: Verify retry logic works, user isn't blocked

### Performance

31. Phase 2 generation target: <60 seconds for 45-65 laws
32. Dashboard remains responsive (<100ms interactions) during background generation
33. Category reorganization uses CSS transitions (smooth, not jarring)

## Tasks / Subtasks

- [ ] Create progress bar component
- [ ] Implement polling mechanism for Phase 2 status
- [ ] Build real-time law streaming with fade-in animations
- [ ] Add "NY GENERERAD" badge to new laws
- [ ] Implement category auto-organization
- [ ] Create completion toast notification
- [ ] Add confetti animation (optional)
- [ ] Implement error handling UI
- [ ] Test polling efficiency (only fetch new laws)
- [ ] Test browser navigation and return behavior

## Dev Notes

**Progress Bar Component:**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { motion } from 'framer-motion'

export function Phase2ProgressBar({ workspaceId }: { workspaceId: string }) {
  const [status, setStatus] = useState<{
    progress: number
    total: number
    complete: boolean
    status: string
  } | null>(null)
  const [isDismissed, setIsDismissed] = useState(false)
  const [estimatedTime, setEstimatedTime] = useState<number | null>(null)

  useEffect(() => {
    let intervalId: NodeJS.Timeout

    async function pollStatus() {
      const response = await fetch(`/api/onboarding/phase2-status/${workspaceId}`)
      const data = await response.json()

      setStatus(data)

      // Calculate estimated time remaining
      if (data.status === 'in_progress') {
        const remaining = data.total - data.progress
        // Assume 1 law per second
        setEstimatedTime(remaining)
      }

      // Stop polling when complete
      if (data.complete) {
        clearInterval(intervalId)
        // Show completion toast
        showCompletionToast(data.progress)
      }
    }

    // Poll every 2 seconds
    if (!status?.complete) {
      pollStatus()
      intervalId = setInterval(pollStatus, 2000)
    }

    return () => {
      if (intervalId) clearInterval(intervalId)
    }
  }, [workspaceId, status?.complete])

  // Don't show if dismissed or complete
  if (isDismissed || !status || status.complete) return null

  const percentage = (status.progress / status.total) * 100

  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      className="mb-6 p-4 bg-white border border-gray-200 rounded-lg shadow-sm"
    >
      <div className="flex items-center justify-between mb-2">
        <div>
          <h3 className="text-sm font-semibold text-gray-900">
            {status.status === 'in_progress'
              ? 'Kompletterar din laglista...'
              : status.status === 'failed'
              ? '‚è∏Ô∏è Kompletterar din laglista, tar lite l√§ngre tid √§n f√∂rv√§ntat...'
              : 'Kompletterar din laglista...'}
          </h3>
          <p className="text-xs text-gray-600">
            {status.progress}/{status.total} lagar
            {estimatedTime && estimatedTime > 0 && (
              <span className="ml-2">‚Ä¢ ~{estimatedTime} sekunder kvar</span>
            )}
          </p>
        </div>
        <button
          onClick={() => setIsDismissed(true)}
          className="text-gray-400 hover:text-gray-600"
          aria-label="D√∂lj"
        >
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      {/* Animated progress bar */}
      <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
        <motion.div
          className="h-full bg-gradient-to-r from-blue-500 to-blue-600"
          style={{
            backgroundSize: '200% 100%',
            animation: 'shimmer 2s infinite'
          }}
          initial={{ width: 0 }}
          animate={{ width: `${percentage}%` }}
          transition={{ duration: 0.5, ease: 'easeOut' }}
        />
      </div>

      <style jsx>{`
        @keyframes shimmer {
          0% {
            background-position: 100% 0;
          }
          100% {
            background-position: -100% 0;
          }
        }
      `}</style>
    </motion.div>
  )
}
```

**Real-Time Law Streaming:**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { motion, AnimatePresence } from 'framer-motion'

export function LawListWithRealTimeUpdates({ workspaceId }: Props) {
  const [laws, setLaws] = useState<Law[]>([])
  const [newLawIds, setNewLawIds] = useState<Set<string>>(new Set())
  const [lastFetchTime, setLastFetchTime] = useState<Date>(new Date())

  useEffect(() => {
    let intervalId: NodeJS.Timeout

    async function fetchNewLaws() {
      // Only fetch laws added since last poll
      const response = await fetch(
        `/api/workspace/${workspaceId}/laws?since=${lastFetchTime.toISOString()}`
      )
      const data = await response.json()

      if (data.newLaws && data.newLaws.length > 0) {
        setLaws((prev) => [...prev, ...data.newLaws])

        // Track new law IDs for badge display
        const newIds = new Set(data.newLaws.map((law: Law) => law.id))
        setNewLawIds(newIds)

        // Remove badges after 3 seconds
        setTimeout(() => {
          setNewLawIds(new Set())
        }, 3000)

        setLastFetchTime(new Date())
      }
    }

    // Poll every 2 seconds during Phase 2
    intervalId = setInterval(fetchNewLaws, 2000)

    return () => {
      if (intervalId) clearInterval(intervalId)
    }
  }, [workspaceId, lastFetchTime])

  // Group laws by category
  const lawsByCategory = laws.reduce((acc, law) => {
    if (!acc[law.category]) acc[law.category] = []
    acc[law.category].push(law)
    return acc
  }, {} as Record<string, Law[]>)

  return (
    <div className="space-y-8">
      {Object.entries(lawsByCategory).map(([category, categoryLaws]) => (
        <div key={category}>
          <h2 className="text-xl font-bold mb-4">
            {category}{' '}
            <motion.span
              key={categoryLaws.length}
              initial={{ scale: 1.2 }}
              animate={{ scale: 1 }}
              className="text-gray-500"
            >
              ({categoryLaws.length})
            </motion.span>
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <AnimatePresence>
              {categoryLaws.map((law) => (
                <motion.div
                  key={law.id}
                  initial={{ opacity: 0, scale: 0.95 }}
                  animate={{ opacity: 1, scale: 1 }}
                  transition={{ duration: 0.3 }}
                  layout
                >
                  <LawCard
                    law={law}
                    isNew={newLawIds.has(law.id)}
                  />
                </motion.div>
              ))}
            </AnimatePresence>
          </div>
        </div>
      ))}
    </div>
  )
}

function LawCard({ law, isNew }: { law: Law; isNew: boolean }) {
  return (
    <div className="relative p-4 border border-gray-200 rounded-lg hover:border-gray-300 hover:shadow-md transition-all">
      {/* New badge */}
      {isNew && (
        <motion.div
          initial={{ opacity: 0, scale: 0.8 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.8 }}
          className="absolute top-2 right-2 px-2 py-1 bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-xs font-semibold rounded"
        >
          ‚ú® NY GENERERAD
        </motion.div>
      )}

      <CategoryBadge category={law.category} />
      <h3 className="font-semibold text-gray-900 mt-2 line-clamp-2">
        {law.title}
      </h3>
      <p className="text-sm text-gray-600 mt-1">{law.sfs_number}</p>

      {law.commentary && (
        <div className="mt-3 p-3 bg-blue-50 rounded text-sm text-blue-900">
          <p className="flex items-start">
            <span className="mr-2">üí°</span>
            <span>{law.commentary}</span>
          </p>
        </div>
      )}
    </div>
  )
}
```

**Completion Toast:**

```typescript
import { toast } from 'sonner'
import confetti from 'canvas-confetti'

function showCompletionToast(totalLaws: number) {
  // Optional confetti animation
  confetti({
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 },
  })

  toast.success(
    `Klar! ${totalLaws} lagar i din lista √§r nu kompletta och aktiverade f√∂r √§ndringsbevakning`,
    {
      duration: 8000,
      position: 'top-center',
    }
  )
}
```

**Efficient Polling Endpoint:**

```typescript
// app/api/workspace/[workspaceId]/laws/route.ts
export async function GET(
  request: Request,
  { params }: { params: { workspaceId: string } }
) {
  const { searchParams } = new URL(request.url)
  const since = searchParams.get('since')

  let whereClause: any = { workspaceId: params.workspaceId }

  // Only fetch laws added since last poll
  if (since) {
    whereClause.addedAt = {
      gt: new Date(since),
    }
  }

  const newLaws = await prisma.workspaceLaw.findMany({
    where: whereClause,
    include: {
      law: true,
    },
    orderBy: { addedAt: 'asc' },
  })

  return NextResponse.json({
    newLaws: newLaws.map((wl) => ({
      id: wl.law.id,
      title: wl.law.title,
      sfs_number: wl.law.document_number,
      category: wl.category,
      commentary: wl.commentary,
      addedAt: wl.addedAt,
    })),
  })
}
```

**Error Handling:**

```typescript
function Phase2ErrorState({ workspaceId }: { workspaceId: string }) {
  return (
    <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <div className="flex items-start">
        <svg
          className="w-5 h-5 text-yellow-600 mr-3 mt-0.5"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fillRule="evenodd"
            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
            clipRule="evenodd"
          />
        </svg>
        <div>
          <h3 className="text-sm font-semibold text-yellow-900">
            Vi slutf√∂r din laglista snart
          </h3>
          <p className="text-sm text-yellow-800 mt-1">
            Det tar lite l√§ngre tid √§n f√∂rv√§ntat, men vi jobbar p√• det! Du f√•r ett
            mejl n√§r din laglista √§r komplett.
          </p>
          <p className="text-xs text-yellow-700 mt-2">
            Du kan forts√§tta anv√§nda applikationen med de lagar som redan √§r
            genererade.
          </p>
        </div>
      </div>
    </div>
  )
}
```

**Reference:** PRD Epic 4 Story 4.4b, Architecture Section 8 (Onboarding), Background job implementation (Story 4.4)

## Testing

**Unit Tests:**

- Progress bar calculates percentage correctly
- Polling stops when Phase 2 complete
- New law badge disappears after 3 seconds
- Category counts update correctly
- Estimated time calculation is accurate

**Integration Tests:**

- Complete Phase 2 flow from start to finish
- Polling fetches only new laws since last poll
- Progress bar dismissal doesn't stop generation
- User navigation away and back resumes UI correctly
- Completion toast appears with correct law count
- Error state displays when Phase 2 fails

**Manual Testing:**

- Test with actual Phase 2 generation (60 second duration)
- Verify laws stream smoothly without layout jumps
- Verify "NY GENERERAD" badge appears and disappears
- Test dismissing progress bar (generation continues)
- Navigate away and return (UI resumes correctly)
- Test with slow network (UI doesn't break)
- Test browser close and reopen (server-side generation continues)
- Verify confetti animation on completion

**Performance Testing:**

- Dashboard remains responsive during streaming
- Category reorganization is smooth (no jarring reorders)
- Polling doesn't cause performance issues
- Memory usage stays stable during 60-second generation

**Test File:** `__tests__/features/onboarding/phase2-completion.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Wait for Phase 2 completion (or continue using app with Phase 1 laws)
- Can dismiss progress bar to reduce visual clutter
- Can navigate away from Dashboard (generation continues)

**Developer Responsibility:**

- Implement efficient polling (only fetch new laws)
- Ensure smooth real-time law streaming
- Handle network interruptions gracefully
- Provide clear error messaging
- Make Dashboard fully interactive during generation
- Implement retry logic for failed generations
- Send email notification if Phase 2 fails after retries

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
