# Story 4.9: Create Welcome Email Sequence (Trial Nurturing)

## Status

Draft

## Story

**As a** product owner,
**I want** to send automated emails during the trial period,
**so that** I increase trial-to-paid conversion.

## Acceptance Criteria

1. Email automation set up with Resend/SendGrid/Loops
2. **Day 1 (Welcome):** "Welcome to Laglig.se! Here's your law list." + feature overview
3. **Day 3 (Feature tips):** "5 ways to get the most from Laglig.se" (AI chat, drag-and-drop, change monitoring teaser)
4. **Day 7 (Engagement check):** "How's it going? Need help?" + link to support
5. **Day 12 (Conversion push):** "Your trial ends in 2 days - Upgrade now!" + pricing, testimonials, urgency
6. Emails track open rates, click rates (UTM parameters)
7. Unsubscribe link in every email
8. A/B testing capability (subject lines, CTAs)
9. Email content in Swedish
10. Templates use React Email for easy editing

## Tasks / Subtasks

- [ ] Set up email automation service (Resend/SendGrid/Loops)
- [ ] Create Day 1 welcome email template
- [ ] Create Day 3 feature tips email template
- [ ] Create Day 7 engagement check email template
- [ ] Create Day 12 conversion push email template
- [ ] Implement email scheduling logic
- [ ] Add UTM tracking parameters
- [ ] Implement unsubscribe functionality
- [ ] Set up open/click rate tracking
- [ ] Configure A/B testing for subject lines
- [ ] Test all email templates

## Dev Notes

**Email Scheduling System:**

```typescript
// lib/email/schedule-trial-emails.ts
import { Queue } from 'bullmq'

const emailQueue = new Queue('trial-emails', {
  connection: {
    host: process.env.REDIS_HOST,
    port: parseInt(process.env.REDIS_PORT || '6379'),
  },
})

export async function scheduleTrialEmails(userId: string, email: string) {
  const now = Date.now()

  // Day 1: Welcome email (send immediately)
  await emailQueue.add(
    'welcome',
    { userId, email, template: 'trial-welcome' },
    { delay: 0 }
  )

  // Day 3: Feature tips
  await emailQueue.add(
    'feature-tips',
    { userId, email, template: 'trial-feature-tips' },
    { delay: 3 * 24 * 60 * 60 * 1000 } // 3 days
  )

  // Day 7: Engagement check
  await emailQueue.add(
    'engagement-check',
    { userId, email, template: 'trial-engagement' },
    { delay: 7 * 24 * 60 * 60 * 1000 } // 7 days
  )

  // Day 12: Conversion push
  await emailQueue.add(
    'conversion-push',
    { userId, email, template: 'trial-conversion' },
    { delay: 12 * 24 * 60 * 60 * 1000 } // 12 days
  )
}

// Worker to process email queue
const worker = new Worker(
  'trial-emails',
  async (job) => {
    const { userId, email, template } = job.data

    // Check if user has upgraded or cancelled
    const user = await prisma.user.findUnique({
      where: { id: userId },
      include: {
        workspace: true,
      },
    })

    if (!user || user.workspace.subscriptionTier !== 'trial') {
      // User has upgraded or cancelled - don't send email
      return { skipped: true }
    }

    // Check if user has unsubscribed
    const preferences = await prisma.emailPreferences.findUnique({
      where: { userId },
    })

    if (preferences?.unsubscribed) {
      return { skipped: true }
    }

    // Send email
    await sendTrialEmail(email, template, {
      userId,
      companyName: user.workspace.name,
    })

    // Track email sent
    await prisma.emailLog.create({
      data: {
        userId,
        template,
        sentAt: new Date(),
      },
    })

    return { success: true }
  },
  {
    connection: {
      host: process.env.REDIS_HOST,
      port: parseInt(process.env.REDIS_PORT || '6379'),
    },
  }
)
```

**Day 1: Welcome Email Template:**

```typescript
// components/emails/trial-welcome.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Heading,
  Button,
  Hr,
  Link
} from '@react-email/components'

export function TrialWelcomeEmail({
  companyName,
  lawCount,
  userId
}: {
  companyName: string
  lawCount: number
  userId: string
}) {
  const dashboardUrl = `https://laglig.se/dashboard?utm_source=email&utm_medium=trial&utm_campaign=welcome&user_id=${userId}`
  const unsubscribeUrl = `https://laglig.se/unsubscribe?user_id=${userId}`

  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>
            V√§lkommen till Laglig.se! üéâ
          </Heading>

          <Text style={styles.text}>Hej {companyName},</Text>

          <Text style={styles.text}>
            Tack f√∂r att du registrerade dig! Din personliga laglista med{' '}
            {lawCount} lagar √§r nu klar och v√§ntar p√• dig.
          </Text>

          <Section style={styles.buttonSection}>
            <Button href={dashboardUrl} style={styles.button}>
              √ñppna din laglista
            </Button>
          </Section>

          <Hr style={styles.hr} />

          <Heading as="h2" style={styles.subheading}>
            S√• h√§r kommer du ig√•ng:
          </Heading>

          <Section style={styles.featureList}>
            <div style={styles.feature}>
              <Text style={styles.featureTitle}>üìã Utforska din laglista</Text>
              <Text style={styles.featureText}>
                Vi har valt {lawCount} lagar som √§r relevanta f√∂r din verksamhet.
                Klicka p√• varje lag f√∂r att l√§sa mer.
              </Text>
            </div>

            <div style={styles.feature}>
              <Text style={styles.featureTitle}>üí¨ St√§ll fr√•gor till AI</Text>
              <Text style={styles.featureText}>
                Dra lagar till AI-chatten och f√• svar p√• dina juridiska fr√•gor.
                Alla svar √§r gruntade i svensk lag.
              </Text>
            </div>

            <div style={styles.feature}>
              <Text style={styles.featureTitle}>üîî Aktivera √§ndringsbevakning</Text>
              <Text style={styles.featureText}>
                Vi bevakar lag√§ndringar √•t dig och skickar notiser n√§r n√•got
                √§ndras.
              </Text>
            </div>
          </Section>

          <Hr style={styles.hr} />

          <Text style={styles.text}>
            Din 14-dagars gratisperiod har startat. Inget kreditkort kr√§vs.
          </Text>

          <Text style={styles.smallText}>
            Beh√∂ver du hj√§lp? Svara p√• detta mejl s√• hj√§lper vi dig.
          </Text>

          <Hr style={styles.hr} />

          <Text style={styles.footer}>
            <Link href={unsubscribeUrl} style={styles.link}>
              Avsluta prenumeration
            </Link>
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

const styles = {
  body: {
    backgroundColor: '#f6f9fc',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
  },
  container: {
    margin: '0 auto',
    padding: '40px 20px',
    maxWidth: '600px'
  },
  heading: {
    fontSize: '28px',
    fontWeight: 'bold',
    color: '#1a202c',
    marginBottom: '24px'
  },
  subheading: {
    fontSize: '20px',
    fontWeight: 'bold',
    color: '#1a202c',
    marginTop: '24px',
    marginBottom: '16px'
  },
  text: {
    fontSize: '16px',
    color: '#4a5568',
    lineHeight: '1.6',
    marginBottom: '16px'
  },
  buttonSection: {
    textAlign: 'center' as const,
    margin: '32px 0'
  },
  button: {
    backgroundColor: '#3182ce',
    color: '#fff',
    padding: '14px 32px',
    borderRadius: '8px',
    textDecoration: 'none',
    fontWeight: 'bold',
    fontSize: '16px'
  },
  hr: {
    borderColor: '#e2e8f0',
    margin: '24px 0'
  },
  featureList: {
    marginTop: '16px'
  },
  feature: {
    marginBottom: '20px'
  },
  featureTitle: {
    fontSize: '16px',
    fontWeight: 'bold',
    color: '#2d3748',
    marginBottom: '4px'
  },
  featureText: {
    fontSize: '14px',
    color: '#718096',
    lineHeight: '1.5',
    marginTop: '0'
  },
  smallText: {
    fontSize: '14px',
    color: '#718096',
    lineHeight: '1.5'
  },
  footer: {
    fontSize: '12px',
    color: '#a0aec0',
    textAlign: 'center' as const
  },
  link: {
    color: '#3182ce',
    textDecoration: 'underline'
  }
}
```

**Day 3: Feature Tips Email Template:**

```typescript
// components/emails/trial-feature-tips.tsx
export function TrialFeatureTipsEmail({
  companyName,
  userId
}: {
  companyName: string
  userId: string
}) {
  const chatUrl = `https://laglig.se/dashboard?utm_source=email&utm_medium=trial&utm_campaign=feature-tips&open=chat&user_id=${userId}`
  const kanbanUrl = `https://laglig.se/workspace?utm_source=email&utm_medium=trial&utm_campaign=feature-tips&user_id=${userId}`

  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>
            5 s√§tt att f√• ut mest av Laglig.se
          </Heading>

          <Text style={styles.text}>Hej {companyName},</Text>

          <Text style={styles.text}>
            Nu n√§r du har utforskat din laglista, h√§r √§r 5 tips f√∂r att f√• √§nnu
            mer v√§rde:
          </Text>

          <Section style={styles.tipList}>
            <div style={styles.tip}>
              <Text style={styles.tipNumber}>1.</Text>
              <div>
                <Text style={styles.tipTitle}>
                  Dra lagar till AI-chatten f√∂r kontextuella svar
                </Text>
                <Text style={styles.tipText}>
                  Vill du veta hur Arbetsmilj√∂lagen p√•verkar din verksamhet? Dra
                  lagen till chatten och st√§ll din fr√•ga. AI:n svarar baserat p√•
                  exakt den lagen.
                </Text>
                <Link href={chatUrl} style={styles.link}>
                  Prova AI-chatten ‚Üí
                </Link>
              </div>
            </div>

            <div style={styles.tip}>
              <Text style={styles.tipNumber}>2.</Text>
              <div>
                <Text style={styles.tipTitle}>
                  Anv√§nd Kanban-tavlan f√∂r att sp√•ra compliance
                </Text>
                <Text style={styles.tipText}>
                  Organisera dina lagar i "Inte p√•b√∂rjad", "P√•g√•ende", "Blockerad",
                  "Granskning", "Efterlevd". Perfekt f√∂r att h√•lla koll p√• vad som
                  beh√∂ver g√∂ras.
                </Text>
                <Link href={kanbanUrl} style={styles.link}>
                  √ñppna Kanban ‚Üí
                </Link>
              </div>
            </div>

            <div style={styles.tip}>
              <Text style={styles.tipNumber}>3.</Text>
              <div>
                <Text style={styles.tipTitle}>
                  Bjud in ditt team (om du har Team-plan)
                </Text>
                <Text style={styles.tipText}>
                  Dela ansvaret f√∂r compliance. Bjud in kollegor och tilldela lagar
                  och uppgifter.
                </Text>
              </div>
            </div>

            <div style={styles.tip}>
              <Text style={styles.tipNumber}>4.</Text>
              <div>
                <Text style={styles.tipTitle}>
                  Aktivera √§ndringsbevakning (kommer snart!)
                </Text>
                <Text style={styles.tipText}>
                  Vi jobbar p√• att bevaka lag√§ndringar √•t dig. Snart f√•r du notiser
                  n√§r n√•gon av dina lagar √§ndras.
                </Text>
              </div>
            </div>

            <div style={styles.tip}>
              <Text style={styles.tipNumber}>5.</Text>
              <div>
                <Text style={styles.tipTitle}>
                  L√§gg till anst√§llda i HR-modulen
                </Text>
                <Text style={styles.tipText}>
                  Koppla lagar till specifika anst√§llda. F√• p√•minnelser om
                  arbetsr√§ttsliga deadlines.
                </Text>
              </div>
            </div>
          </Section>

          <Hr style={styles.hr} />

          <Text style={styles.text}>
            Har du fr√•gor? Svara p√• detta mejl s√• hj√§lper vi dig!
          </Text>

          <Text style={styles.footer}>
            <Link href={`https://laglig.se/unsubscribe?user_id=${userId}`} style={styles.link}>
              Avsluta prenumeration
            </Link>
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

const styles = {
  // ... similar styles as welcome email
  tipList: {
    marginTop: '24px'
  },
  tip: {
    display: 'flex' as const,
    marginBottom: '24px'
  },
  tipNumber: {
    fontSize: '24px',
    fontWeight: 'bold',
    color: '#3182ce',
    marginRight: '16px',
    minWidth: '32px'
  },
  tipTitle: {
    fontSize: '16px',
    fontWeight: 'bold',
    color: '#2d3748',
    marginBottom: '4px'
  },
  tipText: {
    fontSize: '14px',
    color: '#718096',
    lineHeight: '1.5',
    marginBottom: '8px'
  }
}
```

**Day 7: Engagement Check Email:**

```typescript
// components/emails/trial-engagement.tsx
export function TrialEngagementEmail({
  companyName,
  userId,
  daysActive
}: {
  companyName: string
  userId: string
  daysActive: number
}) {
  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>Hur g√•r det?</Heading>

          <Text style={styles.text}>Hej {companyName},</Text>

          <Text style={styles.text}>
            Du har anv√§nt Laglig.se i {daysActive} dagar nu. Hur g√•r det?
          </Text>

          <Text style={styles.text}>Vi skulle √§lska att h√∂ra din feedback:</Text>

          <ul style={styles.list}>
            <li>Har du hittat vad du beh√∂ver?</li>
            <li>Finns det funktioner du saknar?</li>
            <li>Beh√∂ver du hj√§lp med n√•got?</li>
          </ul>

          <Section style={styles.buttonSection}>
            <Button
              href={`mailto:support@laglig.se?subject=Feedback fr√•n ${companyName}`}
              style={styles.button}
            >
              Skicka feedback
            </Button>
          </Section>

          <Hr style={styles.hr} />

          <Text style={styles.text}>
            <strong>Vanliga fr√•gor fr√•n nya anv√§ndare:</strong>
          </Text>

          <Section style={styles.faqList}>
            <div style={styles.faq}>
              <Text style={styles.faqQuestion}>
                Q: Kan jag l√§gga till fler lagar i min lista?
              </Text>
              <Text style={styles.faqAnswer}>
                A: Ja! Klicka p√• "L√§gg till lag" och s√∂k bland 10,000+ lagar.
              </Text>
            </div>

            <div style={styles.faq}>
              <Text style={styles.faqQuestion}>
                Q: √Ñr AI:ns svar juridiskt bindande?
              </Text>
              <Text style={styles.faqAnswer}>
                A: Nej, AI:n ger v√§gledning baserad p√• svensk lag, men √§r inte
                juridisk r√•dgivning. Konsultera advokat f√∂r specifika fall.
              </Text>
            </div>

            <div style={styles.faq}>
              <Text style={styles.faqQuestion}>
                Q: Kan jag exportera min laglista?
              </Text>
              <Text style={styles.faqAnswer}>
                A: Ja, klicka p√• "Exportera" i din laglista f√∂r PDF eller CSV.
              </Text>
            </div>
          </Section>

          <Text style={styles.text}>
            Din provperiod g√•r ut om {14 - daysActive} dagar.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}
```

**Day 12: Conversion Push Email:**

```typescript
// components/emails/trial-conversion.tsx
export function TrialConversionEmail({
  companyName,
  userId
}: {
  companyName: string
  userId: string
}) {
  const upgradeUrl = `https://laglig.se/billing/upgrade?utm_source=email&utm_medium=trial&utm_campaign=conversion&user_id=${userId}`

  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>
            Din provperiod g√•r ut om 2 dagar
          </Heading>

          <Text style={styles.text}>Hej {companyName},</Text>

          <Text style={styles.text}>
            Din 14-dagars gratisperiod g√•r ut <strong>om 2 dagar</strong>.
          </Text>

          <Text style={styles.text}>
            F√∂r att forts√§tta anv√§nda Laglig.se och f√• tillg√•ng till:
          </Text>

          <ul style={styles.list}>
            <li>‚úÖ Din personliga laglista med √§ndringsbevakning</li>
            <li>‚úÖ AI-chat med obegr√§nsade fr√•gor</li>
            <li>‚úÖ Kanban f√∂r compliance-sp√•rning</li>
            <li>‚úÖ HR-modul med anst√§llningshantering</li>
            <li>‚úÖ F√∂rarbeten och r√§ttsfall (Premium)</li>
          </ul>

          <Section style={styles.pricingSection}>
            <div style={styles.pricingCard}>
              <Text style={styles.planName}>Solo</Text>
              <Text style={styles.planPrice}>‚Ç¨399/m√•nad</Text>
              <Text style={styles.planDescription}>
                Perfekt f√∂r enmansf√∂retag och sm√•bolag
              </Text>
            </div>

            <div style={styles.pricingCard}>
              <Text style={styles.planName}>Team</Text>
              <Text style={styles.planPrice}>‚Ç¨899/m√•nad</Text>
              <Text style={styles.planDescription}>
                F√∂r team upp till 5 anv√§ndare
              </Text>
            </div>
          </Section>

          <Section style={styles.buttonSection}>
            <Button href={upgradeUrl} style={styles.button}>
              Uppgradera nu
            </Button>
          </Section>

          <Hr style={styles.hr} />

          <Section style={styles.testimonial}>
            <Text style={styles.testimonialText}>
              "Laglig.se har sparat oss flera timmar varje vecka. AI-chatten ger
              snabba svar p√• v√•ra arbetsmilj√∂fr√•gor."
            </Text>
            <Text style={styles.testimonialAuthor}>
              ‚Äî Sara Andersson, VD, Byggbolaget AB
            </Text>
          </Section>

          <Text style={styles.text}>
            Tack f√∂r att du provat Laglig.se. Vi hoppas att du v√§ljer att
            forts√§tta!
          </Text>
        </Container>
      </Body>
    </Html>
  )
}
```

**Unsubscribe Functionality:**

```typescript
// app/api/unsubscribe/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const userId = searchParams.get('user_id')

  if (!userId) {
    return NextResponse.json({ error: 'Invalid request' }, { status: 400 })
  }

  // Update email preferences
  await prisma.emailPreferences.upsert({
    where: { userId },
    update: { unsubscribed: true },
    create: { userId, unsubscribed: true },
  })

  return NextResponse.redirect('/unsubscribe-success')
}
```

**Reference:** PRD Epic 4 Story 4.7, Email marketing best practices, Resend documentation

## Testing

**Unit Tests:**

- Email scheduling creates jobs at correct delays
- Email templates render correctly
- UTM parameters added correctly
- Unsubscribe link works

**Integration Tests:**

- Complete email sequence sent over 12 days
- Emails skip if user upgrades
- Emails skip if user unsubscribes
- Open/click rates tracked correctly

**Manual Testing:**

- Review all 4 email templates
- Verify Swedish translations are correct
- Test unsubscribe functionality
- Check UTM tracking in analytics
- Verify emails display correctly in Gmail, Outlook, Apple Mail
- Test on mobile email clients

**A/B Testing:**

- Test 2 subject lines for Day 1 email
- Measure open rates and dashboard visits

**Test File:** `__tests__/features/email/trial-sequence.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**

- Read emails to learn about features
- Provide feedback if requested
- Decide whether to upgrade before trial ends

**Developer Responsibility:**

- Send emails at correct intervals (Day 1, 3, 7, 12)
- Track open/click rates with UTM parameters
- Implement unsubscribe functionality
- Skip emails if user upgrades or unsubscribes
- Ensure emails display correctly across clients
- A/B test subject lines to optimize engagement

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
