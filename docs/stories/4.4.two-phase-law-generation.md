# Story 4.4: Implement Two-Phase AI-Powered Law List Generation

## Status

Draft

## Story

**As a** visitor,
**I want** the system to generate a comprehensive personalized law list in two phases,
**so that** I see value quickly (Phase 1) and get complete coverage after signup (Phase 2).

## Acceptance Criteria

### Phase 1 (Pre-Signup - High-Priority Laws)

1. API endpoint created: `POST /api/onboarding/generate-law-list-phase1`
2. Request body: `{ sniCode, legalForm, employeeCount, companyName, contextualAnswers }`
3. Backend retrieves industry starter pack (from Epic 2) based on SNI code
4. GPT-4 prompt: "Given [company data + contextual answers], select 15-30 HIGHEST-PRIORITY laws, prioritize by: (1) change frequency, (2) fine risk, (3) business-criticality, (4) industry-specificity"
5. AI returns ranked law list with contextual commentary per law
6. Commentary format: "Gäller eftersom ni har 12 anställda" or "Gäller eftersom ni serverar alkohol"
7. Response format: `{ phase: 1, totalEstimated: 68, laws: [{ law_id, title, sfs_number, commentary, priority, category }] }`
8. Generation time <3 minutes (including streaming during question answering)
9. Laws categorized: Grundläggande, Arbetsmiljö, Branschspecifika (Phase 1 focuses on these 3)
10. Fallback: If SNI code not in starter packs, use general "SMB starter pack"

### Phase 2 (Post-Signup - Comprehensive Coverage)

11. API endpoint created: `POST /api/onboarding/generate-law-list-phase2`
12. Triggered automatically after account creation, runs as background job
13. Request body: `{ userId, workspaceId, phase1LawIds, contextualAnswers }`
14. GPT-4 prompt: "Given [company data], generate REMAINING 45-65 laws for comprehensive 60-80 total coverage. Exclude Phase 1 laws. Include: nice-to-know laws, tangential regulations, environmental laws, specialized contexts."
15. Categories added: GDPR & Data, Ekonomi, Miljö, Övrigt
16. Generation time <60 seconds for 45-65 laws
17. Laws stream into user's workspace in real-time (background process, non-blocking)
18. Progress tracking: Database stores `phase2_generation_status` (pending/in_progress/complete)
19. Frontend polls: `GET /api/onboarding/phase2-status/{workspaceId}` returns `{ progress: 45/68, complete: false }`
20. Upon completion: Database marks `phase2_generation_status = complete`, sends completion event
21. Error handling: If Phase 2 fails, retry up to 3 times, then notify user "Vi slutför din laglista, det kan ta några minuter till"

### Testing

22. Test Phase 1 with 15 different industries (manual review: >95% relevant for immediate compliance)
23. Test Phase 2 with same industries (manual review: comprehensive coverage, minimal duplication)
24. Verify Phase 1 + Phase 2 totals 60-80 laws per industry
25. Compare generated lists against Notisum's industry lists (coverage parity check)

## Tasks / Subtasks

- [ ] Create Phase 1 API endpoint and GPT-4 integration
- [ ] Implement industry starter pack retrieval
- [ ] Build contextual commentary generation
- [ ] Create Phase 2 API endpoint with background job
- [ ] Implement job queue (BullMQ) for Phase 2
- [ ] Add progress tracking to database
- [ ] Create phase2-status polling endpoint
- [ ] Implement retry logic for failed generations
- [ ] Test with 15 different industries
- [ ] Compare coverage against Notisum

## Dev Notes

**Phase 1 Implementation:**

```typescript
// app/api/onboarding/generate-law-list-phase1/route.ts
export async function POST(request: Request) {
  const { sniCode, legalForm, employeeCount, companyName, contextualAnswers } =
    await request.json()

  // Retrieve industry starter pack from database
  const starterPack = await getIndustryStarterPack(sniCode)

  if (!starterPack) {
    // Fallback to SMB starter pack
    starterPack = await getSMBStarterPack()
  }

  // Build GPT-4 prompt with company context
  const prompt = buildPhase1Prompt({
    starterPack,
    companyName,
    sniCode,
    legalForm,
    employeeCount,
    contextualAnswers,
  })

  // Call GPT-4 to select and prioritize 15-30 laws
  const completion = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      {
        role: 'system',
        content: `Du är en juridisk expert som hjälper företag identifiera relevanta lagar.

Din uppgift: Från en lista av möjliga lagar för denna bransch, välj de 15-30 VIKTIGASTE lagarna för detta specifika företag.

Prioritera lagar baserat på:
1. Ändringsfrekvens (lagar som ändras ofta är kritiska att bevaka)
2. Böterisker (lagar med höga böter vid överträdelse)
3. Affärskritikalitet (lagar som direkt påverkar verksamheten)
4. Branschspecificitet (lagar specifika för denna industri)

För varje lag, ge en kortfattad kommentar (1 mening) på svenska som förklarar VARFÖR den gäller för detta företag.

Returnera JSON: { "totalEstimated": 68, "laws": [{ "law_id": "uuid", "title": "...", "sfs_number": "...", "commentary": "...", "priority": "high|medium", "category": "..." }] }`,
      },
      {
        role: 'user',
        content: prompt,
      },
    ],
    response_format: { type: 'json_object' },
    temperature: 0.3,
  })

  const response = JSON.parse(completion.choices[0].message.content)

  // Add phase indicator
  response.phase = 1

  return NextResponse.json(response)
}

function buildPhase1Prompt(context: any): string {
  return `
Företagsinformation:
- Namn: ${context.companyName}
- SNI-kod: ${context.sniCode}
- Bolagsform: ${context.legalForm}
- Antal anställda: ${context.employeeCount}

Kontextuella svar från företaget:
${Object.entries(context.contextualAnswers)
  .map(([key, value]) => `- ${key}: ${value}`)
  .join('\n')}

Möjliga lagar för denna bransch (${context.starterPack.laws.length} lagar):
${context.starterPack.laws
  .map(
    (law: any) =>
      `- ${law.sfs_number}: ${law.title} (Kategori: ${law.category})`
  )
  .join('\n')}

Välj de 15-30 viktigaste lagarna för detta företag och förklara varför varje lag gäller.
`
}
```

**Phase 2 Background Job:**

```typescript
// lib/jobs/phase2-law-generation.ts
import { Queue, Worker } from 'bullmq'

const phase2Queue = new Queue('phase2-law-generation', {
  connection: {
    host: process.env.REDIS_HOST,
    port: parseInt(process.env.REDIS_PORT || '6379'),
  },
})

export async function enqueuePhase2Generation(data: {
  userId: string
  workspaceId: string
  phase1LawIds: string[]
  contextualAnswers: Record<string, string>
}) {
  await phase2Queue.add('generate', data, {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 5000,
    },
  })
}

// Worker to process Phase 2 generation
const worker = new Worker(
  'phase2-law-generation',
  async (job) => {
    const { userId, workspaceId, phase1LawIds, contextualAnswers } = job.data

    // Update status to in_progress
    await prisma.workspace.update({
      where: { id: workspaceId },
      data: { phase2_generation_status: 'in_progress' },
    })

    // Get full company context
    const workspace = await prisma.workspace.findUnique({
      where: { id: workspaceId },
      include: { companyProfile: true },
    })

    // Retrieve all laws from starter pack
    const starterPack = await getIndustryStarterPack(
      workspace.companyProfile.sniCode
    )

    // Filter out Phase 1 laws
    const remainingLaws = starterPack.laws.filter(
      (law) => !phase1LawIds.includes(law.id)
    )

    // Build GPT-4 prompt for comprehensive coverage
    const prompt = buildPhase2Prompt({
      workspace,
      contextualAnswers,
      phase1LawIds,
      remainingLaws,
    })

    // Call GPT-4 to select remaining 45-65 laws
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        {
          role: 'system',
          content: `Du är en juridisk expert som hjälper företag identifiera alla relevanta lagar.

Din uppgift: Från de återstående lagarna, välj ytterligare 45-65 lagar för KOMPLETT täckning.

Inkludera:
- GDPR och dataskydd
- Ekonomiska lagar (bokföring, skatt, fakturering)
- Miljölagar
- Nischade och specialiserade lagar
- "Nice-to-know" lagar som inte är kritiska men bra att känna till

För varje lag, ge en kortfattad kommentar (1 mening) på svenska som förklarar varför den kan vara relevant.

Returnera JSON: { "laws": [{ "law_id": "uuid", "title": "...", "sfs_number": "...", "commentary": "...", "category": "..." }] }`,
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      response_format: { type: 'json_object' },
      temperature: 0.3,
    })

    const response = JSON.parse(completion.choices[0].message.content)

    // Store laws in workspace (batch insert)
    const lawsToInsert = response.laws.map((law: any) => ({
      workspaceId,
      lawId: law.law_id,
      commentary: law.commentary,
      category: law.category,
      phase: 2,
      addedAt: new Date(),
    }))

    await prisma.workspaceLaw.createMany({
      data: lawsToInsert,
    })

    // Update status to complete
    await prisma.workspace.update({
      where: { id: workspaceId },
      data: {
        phase2_generation_status: 'complete',
        phase2_completed_at: new Date(),
      },
    })

    // Send completion event (for real-time UI update)
    await sendPhase2CompleteEvent(workspaceId)

    return { success: true, lawsGenerated: response.laws.length }
  },
  {
    connection: {
      host: process.env.REDIS_HOST,
      port: parseInt(process.env.REDIS_PORT || '6379'),
    },
  }
)

function buildPhase2Prompt(context: any): string {
  return `
Företagsinformation:
- Namn: ${context.workspace.companyProfile.companyName}
- SNI-kod: ${context.workspace.companyProfile.sniCode}
- Bolagsform: ${context.workspace.companyProfile.legalForm}
- Antal anställda: ${context.workspace.companyProfile.employeeCount}

Kontextuella svar från företaget:
${Object.entries(context.contextualAnswers)
  .map(([key, value]) => `- ${key}: ${value}`)
  .join('\n')}

Lagar redan valda i Fas 1 (${context.phase1LawIds.length} lagar):
[Dessa lagar ska INTE inkluderas igen]

Återstående möjliga lagar (${context.remainingLaws.length} lagar):
${context.remainingLaws
  .map(
    (law: any) =>
      `- ${law.sfs_number}: ${law.title} (Kategori: ${law.category})`
  )
  .join('\n')}

Välj ytterligare 45-65 lagar för KOMPLETT täckning. Inkludera:
- GDPR och dataskydd
- Ekonomiska lagar
- Miljölagar
- Specialiserade och nischade lagar
- Nice-to-know lagar

Målet är 60-80 lagar totalt (Fas 1 + Fas 2).
`
}
```

**Phase 2 Status Polling Endpoint:**

```typescript
// app/api/onboarding/phase2-status/[workspaceId]/route.ts
export async function GET(
  request: Request,
  { params }: { params: { workspaceId: string } }
) {
  const workspace = await prisma.workspace.findUnique({
    where: { id: params.workspaceId },
    select: {
      phase2_generation_status: true,
      phase2_completed_at: true,
    },
  })

  if (!workspace) {
    return NextResponse.json({ error: 'Workspace not found' }, { status: 404 })
  }

  // Count current laws
  const lawCount = await prisma.workspaceLaw.count({
    where: { workspaceId: params.workspaceId },
  })

  const phase1Count = await prisma.workspaceLaw.count({
    where: { workspaceId: params.workspaceId, phase: 1 },
  })

  const phase2Count = lawCount - phase1Count

  // Estimate total (could be stored in workspace)
  const totalEstimated = 68 // This should come from Phase 1 response

  return NextResponse.json({
    status: workspace.phase2_generation_status,
    progress: lawCount,
    phase1Count,
    phase2Count,
    total: totalEstimated,
    complete: workspace.phase2_generation_status === 'complete',
    completedAt: workspace.phase2_completed_at,
  })
}
```

**Database Schema Updates:**

```prisma
model Workspace {
  id                       String   @id @default(uuid())
  name                     String
  ownerId                  String
  phase2_generation_status String   @default("pending") // pending, in_progress, complete, failed
  phase2_completed_at      DateTime?
  phase2_total_estimated   Int?
  // ... other fields
}

model WorkspaceLaw {
  id          String   @id @default(uuid())
  workspaceId String
  lawId       String
  commentary  String?  // AI-generated reason why this law applies
  category    String
  phase       Int      // 1 or 2
  addedAt     DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  law       LegalDocument @relation(fields: [lawId], references: [id])

  @@index([workspaceId, phase])
  @@map("workspace_laws")
}
```

**Starter Pack Retrieval:**

```typescript
async function getIndustryStarterPack(sniCode: string) {
  // Try exact SNI match first
  let starterPack = await prisma.industryStarterPack.findFirst({
    where: { sniCode },
    include: { laws: true },
  })

  if (starterPack) return starterPack

  // Try 2-digit SNI match (e.g., 56.10.1 → 56)
  const sniPrefix = sniCode.substring(0, 2)
  starterPack = await prisma.industryStarterPack.findFirst({
    where: { sniCode: { startsWith: sniPrefix } },
    include: { laws: true },
  })

  return starterPack
}

async function getSMBStarterPack() {
  // General SMB starter pack for unknown industries
  return await prisma.industryStarterPack.findFirst({
    where: { sniCode: 'SMB_GENERAL' },
    include: { laws: true },
  })
}
```

**Reference:** PRD Epic 4 Story 4.3, Architecture Section 8 (Onboarding), Feature Spec 01 (Homepage & Onboarding), Epic 2 (Industry Starter Packs)

## Testing

**Unit Tests:**

- `buildPhase1Prompt()` includes all context correctly
- `buildPhase2Prompt()` excludes Phase 1 laws
- Starter pack retrieval falls back to SMB general pack
- Phase 2 job retry logic works correctly

**Integration Tests:**

- Phase 1 generates 15-30 laws within 3 minutes
- Phase 2 generates 45-65 laws within 60 seconds
- Phase 1 + Phase 2 totals 60-80 laws
- Phase 2 background job enqueues correctly
- Phase 2 status polling returns accurate progress
- Retry logic attempts 3 times with exponential backoff
- Failed Phase 2 sends notification to user

**Manual Testing:**

- Test with 15 different industries:
  - Restaurang (SNI 56.x)
  - Bygg (SNI 41-43)
  - E-handel (SNI 47.91)
  - Vårdgivare (SNI 86-88)
  - Hotell (SNI 55.x)
  - Transport (SNI 49.x)
  - Handel (SNI 47.x)
  - Tillverkning (SNI 25.x)
  - IT-konsult (SNI 62.x)
  - Fastighetsskötsel (SNI 81.x)
  - (5 more industries)
- Verify Phase 1 laws are high-priority and relevant (>95% accuracy)
- Verify Phase 2 laws provide comprehensive coverage
- Verify no duplicate laws between Phase 1 and Phase 2
- Compare total coverage against Notisum industry lists

**Test File:** `__tests__/features/onboarding/law-generation.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**

- Provide accurate company information (org-number, contextual answers)
- Review generated law list for relevance and completeness
- Report any missing or irrelevant laws

**Developer Responsibility:**

- Implement GPT-4 prompts that prioritize correctly
- Ensure Phase 1 generation completes within 3 minutes
- Ensure Phase 2 background job is reliable with retry logic
- Prevent duplicate laws between phases
- Provide accurate progress tracking for Phase 2
- Handle edge cases (unknown SNI, API failures, timeout)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
