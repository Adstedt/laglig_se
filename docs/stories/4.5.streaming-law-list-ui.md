# Story 4.5: Build Streaming Law List UI

## Status

Draft

## Story

**As a** visitor,
**I want** to watch my law list generate in real-time,
**so that** I experience the "magic" of AI personalization.

## Acceptance Criteria

1. After submitting org-number, law list streams onto page
2. Streaming animation: Laws appear one-by-one, card-by-card
3. Each law card displays: title, SFS number, category badge, AI commentary (1-2 sentences)
4. Cards have subtle fade-in animation
5. Progress indicator: "12/20 lagar valda..."
6. Streaming uses Vercel AI SDK or Server-Sent Events (SSE)
7. Once complete, show: "Din personliga laglista √§r klar! ‚úÖ"
8. Call-to-action: "Spara och forts√§tt" button (triggers signup)
9. Law cards interactive: Click to expand full details
10. Mobile-responsive card layout (1 column mobile, 2-3 desktop)

## Tasks / Subtasks

- [ ] Implement SSE endpoint for streaming
- [ ] Create law card component with fade-in animation
- [ ] Build progress indicator component
- [ ] Add Vercel AI SDK integration
- [ ] Create expandable law card modal
- [ ] Implement mobile-responsive grid layout
- [ ] Add completion state with CTA button
- [ ] Test streaming performance with different network speeds

## Dev Notes

**SSE Streaming Endpoint:**

```typescript
// app/api/onboarding/stream-laws/route.ts
export async function POST(request: Request) {
  const { sniCode, legalForm, employeeCount, companyName, contextualAnswers } =
    await request.json()

  // Create readable stream for SSE
  const encoder = new TextEncoder()
  const stream = new ReadableStream({
    async start(controller) {
      try {
        // Generate Phase 1 laws
        const phase1Response = await generatePhase1Laws({
          sniCode,
          legalForm,
          employeeCount,
          companyName,
          contextualAnswers,
        })

        const { totalEstimated, laws } = phase1Response

        // Send initial progress
        controller.enqueue(
          encoder.encode(
            `data: ${JSON.stringify({
              type: 'progress',
              progress: 0,
              total: totalEstimated,
            })}\n\n`
          )
        )

        // Stream each law with delay for dramatic effect
        for (let i = 0; i < laws.length; i++) {
          const law = laws[i]

          // Fetch full law details
          const lawDetails = await prisma.legalDocument.findUnique({
            where: { id: law.law_id },
          })

          // Send law card
          controller.enqueue(
            encoder.encode(
              `data: ${JSON.stringify({
                type: 'law',
                law: {
                  id: law.law_id,
                  title: lawDetails.title,
                  sfs_number: lawDetails.document_number,
                  category: law.category,
                  commentary: law.commentary,
                  priority: law.priority,
                },
              })}\n\n`
            )
          )

          // Update progress
          controller.enqueue(
            encoder.encode(
              `data: ${JSON.stringify({
                type: 'progress',
                progress: i + 1,
                total: totalEstimated,
              })}\n\n`
            )
          )

          // Add small delay between cards (200ms for streaming effect)
          await new Promise((resolve) => setTimeout(resolve, 200))
        }

        // Send completion event
        controller.enqueue(
          encoder.encode(
            `data: ${JSON.stringify({
              type: 'complete',
              totalLaws: laws.length,
              estimatedTotal: totalEstimated,
            })}\n\n`
          )
        )

        controller.close()
      } catch (error) {
        controller.enqueue(
          encoder.encode(
            `data: ${JSON.stringify({
              type: 'error',
              error: 'Failed to generate law list',
            })}\n\n`
          )
        )
        controller.close()
      }
    },
  })

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      Connection: 'keep-alive',
    },
  })
}
```

**Streaming Law List Component:**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { motion, AnimatePresence } from 'framer-motion'

interface Law {
  id: string
  title: string
  sfs_number: string
  category: string
  commentary: string
  priority: 'high' | 'medium'
}

export function StreamingLawList({
  sniCode,
  legalForm,
  employeeCount,
  companyName,
  contextualAnswers,
  onComplete
}: StreamingLawListProps) {
  const [laws, setLaws] = useState<Law[]>([])
  const [progress, setProgress] = useState({ current: 0, total: 0 })
  const [isComplete, setIsComplete] = useState(false)
  const [isLoading, setIsLoading] = useState(true)
  const [expandedLawId, setExpandedLawId] = useState<string | null>(null)

  useEffect(() => {
    async function startStreaming() {
      const response = await fetch('/api/onboarding/stream-laws', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sniCode,
          legalForm,
          employeeCount,
          companyName,
          contextualAnswers
        })
      })

      const reader = response.body?.getReader()
      const decoder = new TextDecoder()

      if (!reader) return

      setIsLoading(false)

      while (true) {
        const { done, value } = await reader.read()
        if (done) break

        const chunk = decoder.decode(value)
        const lines = chunk.split('\n\n')

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6))

            switch (data.type) {
              case 'progress':
                setProgress({ current: data.progress, total: data.total })
                break

              case 'law':
                setLaws((prev) => [...prev, data.law])
                break

              case 'complete':
                setIsComplete(true)
                onComplete?.(laws)
                break

              case 'error':
                console.error('Streaming error:', data.error)
                break
            }
          }
        }
      }
    }

    startStreaming()
  }, [])

  if (isLoading) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4" />
        <p className="text-gray-600">H√§mtar f√∂retagsinfo fr√•n Bolagsverket...</p>
      </div>
    )
  }

  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      {/* Progress Indicator */}
      {!isComplete && (
        <div className="mb-8">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-2xl font-bold">Genererar din laglista</h2>
            <span className="text-sm text-gray-600">
              {progress.current}/{progress.total} lagar valda
            </span>
          </div>
          <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
            <motion.div
              className="h-full bg-blue-600"
              initial={{ width: 0 }}
              animate={{ width: `${(progress.current / progress.total) * 100}%` }}
              transition={{ duration: 0.3 }}
            />
          </div>
        </div>
      )}

      {/* Completion Banner */}
      {isComplete && (
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg"
        >
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold text-green-900 mb-2">
                Din personliga laglista √§r klar! ‚úÖ
              </h2>
              <p className="text-green-700">
                Vi har valt {laws.length} lagar som √§r relevanta f√∂r din verksamhet.
                Skapa konto f√∂r att spara listan och f√• tillg√•ng till alla funktioner.
              </p>
            </div>
            <button
              onClick={() => {
                /* Open signup modal */
              }}
              className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 whitespace-nowrap ml-4"
            >
              Spara och forts√§tt
            </button>
          </div>
        </motion.div>
      )}

      {/* Law Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <AnimatePresence>
          {laws.map((law, index) => (
            <motion.div
              key={law.id}
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ duration: 0.3, delay: index * 0.05 }}
              className="relative"
            >
              <LawCard
                law={law}
                isExpanded={expandedLawId === law.id}
                onToggle={() =>
                  setExpandedLawId(expandedLawId === law.id ? null : law.id)
                }
              />
            </motion.div>
          ))}
        </AnimatePresence>
      </div>

      {/* "Spara och forts√§tt" CTA at bottom */}
      {isComplete && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
          className="mt-8 text-center"
        >
          <button
            onClick={() => {
              /* Open signup modal */
            }}
            className="px-8 py-4 bg-blue-600 text-white rounded-lg font-semibold text-lg hover:bg-blue-700 shadow-lg"
          >
            Spara och forts√§tt
          </button>
          <p className="mt-2 text-sm text-gray-600">
            Gratis i 14 dagar. Inget kreditkort kr√§vs.
          </p>
        </motion.div>
      )}
    </div>
  )
}
```

**Law Card Component:**

```typescript
function LawCard({
  law,
  isExpanded,
  onToggle
}: {
  law: Law
  isExpanded: boolean
  onToggle: () => void
}) {
  return (
    <div
      className={`p-4 border rounded-lg cursor-pointer transition-all ${
        isExpanded
          ? 'border-blue-500 shadow-lg'
          : 'border-gray-200 hover:border-gray-300 hover:shadow-md'
      }`}
      onClick={onToggle}
    >
      {/* Header */}
      <div className="flex items-start justify-between mb-2">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <CategoryBadge category={law.category} />
            {law.priority === 'high' && (
              <span className="px-2 py-0.5 text-xs bg-red-100 text-red-700 rounded">
                H√∂g prioritet
              </span>
            )}
          </div>
          <h3 className="font-semibold text-gray-900 line-clamp-2">
            {law.title}
          </h3>
          <p className="text-sm text-gray-600 mt-1">{law.sfs_number}</p>
        </div>
        <button className="ml-2 text-gray-400 hover:text-gray-600">
          {isExpanded ? (
            <ChevronUpIcon className="w-5 h-5" />
          ) : (
            <ChevronDownIcon className="w-5 h-5" />
          )}
        </button>
      </div>

      {/* AI Commentary */}
      <div className="mt-3 p-3 bg-blue-50 rounded text-sm text-blue-900">
        <p className="flex items-start">
          <span className="mr-2">üí°</span>
          <span>{law.commentary}</span>
        </p>
      </div>

      {/* Expanded Content */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="mt-4 pt-4 border-t border-gray-200"
          >
            <div className="space-y-2 text-sm text-gray-700">
              <p>
                <strong>Vad handlar lagen om?</strong>
              </p>
              <p>
                Denna lag reglerar [brief description - could be fetched from
                database or generated]
              </p>
              <a
                href={`/laws/${law.sfs_number}`}
                className="inline-flex items-center text-blue-600 hover:underline"
                onClick={(e) => e.stopPropagation()}
              >
                L√§s mer om lagen ‚Üí
              </a>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  )
}

function CategoryBadge({ category }: { category: string }) {
  const colors: Record<string, string> = {
    Grundl√§ggande: 'bg-purple-100 text-purple-700',
    Arbetsmilj√∂: 'bg-blue-100 text-blue-700',
    Branschspecifika: 'bg-green-100 text-green-700',
    'GDPR & Data': 'bg-yellow-100 text-yellow-700',
    Ekonomi: 'bg-pink-100 text-pink-700',
    Milj√∂: 'bg-teal-100 text-teal-700',
    √ñvrigt: 'bg-gray-100 text-gray-700'
  }

  const color = colors[category] || colors.√ñvrigt

  return (
    <span className={`px-2 py-0.5 text-xs rounded ${color}`}>{category}</span>
  )
}
```

**Alternative: Vercel AI SDK Implementation:**

```typescript
'use client'

import { useCompletion } from 'ai/react'

export function StreamingLawListWithVercelAI({
  sniCode,
  legalForm,
  employeeCount,
  companyName,
  contextualAnswers,
}: Props) {
  const { completion, complete, isLoading } = useCompletion({
    api: '/api/onboarding/generate-laws-stream',
    body: {
      sniCode,
      legalForm,
      employeeCount,
      companyName,
      contextualAnswers,
    },
    onFinish: (prompt, completion) => {
      // Parse completion as JSON array of laws
      const laws = JSON.parse(completion)
      setGeneratedLaws(laws)
      setIsComplete(true)
    },
  })

  useEffect(() => {
    complete('')
  }, [])

  // Parse partial completion as streaming JSON
  const laws = useMemo(() => {
    try {
      return JSON.parse(completion || '[]')
    } catch {
      return []
    }
  }, [completion])

  // Rest of component...
}
```

**Mobile-Responsive Layout:**

```css
/* Tailwind classes already handle mobile responsiveness:
 * - grid-cols-1: 1 column on mobile
 * - md:grid-cols-2: 2 columns on tablet
 * - lg:grid-cols-3: 3 columns on desktop
 */
```

**Reference:** PRD Epic 4 Story 4.4, Architecture Section 8 (Onboarding), Vercel AI SDK documentation

## Testing

**Unit Tests:**

- SSE endpoint streams laws correctly
- Law card component renders all fields
- Fade-in animation triggers correctly
- Progress indicator updates accurately
- Expanded state toggles correctly

**Integration Tests:**

- Complete streaming flow from start to finish
- SSE connection handles disconnection gracefully
- Progress reaches 100% when complete
- "Spara och forts√§tt" button appears after completion
- Clicking law card expands details

**Manual Testing:**

- Test streaming with slow network (throttle to 3G)
- Verify smooth fade-in animations
- Test on mobile (1 column layout)
- Test on tablet (2 column layout)
- Test on desktop (3 column layout)
- Verify law card click expands details
- Verify completion banner appears with correct count
- Test with different law counts (15, 20, 30 laws)

**Performance Testing:**

- Measure streaming latency (<200ms per card)
- Verify no layout shift during streaming
- Test with 30 laws streaming (smooth performance)
- Memory usage stays stable during streaming

**Test File:** `__tests__/features/onboarding/streaming-law-list.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**

- Wait for law list to complete streaming
- Review generated laws for relevance
- Click "Spara och forts√§tt" to proceed with signup

**Developer Responsibility:**

- Implement smooth streaming with SSE or Vercel AI SDK
- Ensure fade-in animations are performant
- Handle network interruptions gracefully
- Provide accurate progress tracking
- Make law cards expandable for quick preview
- Optimize for mobile devices (touch-friendly cards)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
