# Story 5.12: Implement Workspace Onboarding Checklist

## Status

Draft

## Story

**As a** new workspace user,
**I want** to see a checklist of setup steps on my dashboard,
**so that** I know what to do next to get full value from the platform.

## Context & Dependencies

- **Builds on:** Story 10.2 (completed) — workspace creation wizard
- **Relationship to Story 14.5:** Story 14.5 is the AI conversational onboarding that populates the company profile (WorkspaceProfile). This story (5.12) is a **post-setup checklist** displayed on the dashboard after workspace creation — it tracks discrete setup actions (invite team, add employee, try AI chat, etc.). The two are complementary, not overlapping. If 14.5 is implemented first, "Complete company profile" can be added as a checklist item.
- **Note:** Uses `getWorkspaceContext()` for workspace-scoped data, not `getServerSession(authOptions)`.

## Acceptance Criteria

1. After first login to a new workspace, onboarding checklist displayed on Dashboard
2. Checklist items:
   - Law list generated (auto-completed during onboarding)
   - Invite your team
   - Add your first employee
   - Ask AI a question
   - Customize law list
3. Each item links to relevant page
4. Checklist dismissible (persisted in user preferences)
5. Progress % shown: "2/5 completed"
6. Gamification: Confetti animation when 100% complete

## Tasks / Subtasks

- [ ] Create `UserPreferences` Prisma model (if not already exists)
- [ ] Create onboarding checklist component
- [ ] Create checklist status API endpoint
- [ ] Implement progress tracking by querying actual workspace data
- [ ] Add click handlers to navigate to relevant pages
- [ ] Implement dismissible functionality with persistence
- [ ] Add confetti animation for completion (canvas-confetti)
- [ ] Test checklist persistence and completion detection

## Dev Notes

**Database Schema:**

```prisma
model UserPreferences {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  onboardingDismissed     Boolean  @default(false)
  onboardingConfettiShown Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}
```

**Checklist API Endpoint:**

```typescript
// app/api/onboarding/checklist/route.ts
import { NextResponse } from 'next/server'
import { getWorkspaceContext } from '@/lib/auth/workspace-context'
import { prisma } from '@/lib/prisma'

export async function GET() {
  const context = await getWorkspaceContext()

  // Check if dismissed
  const preferences = await prisma.userPreferences.findUnique({
    where: { userId: context.userId },
  })
  if (preferences?.onboardingDismissed) {
    return NextResponse.json({ dismissed: true })
  }

  // Check completion status by querying actual data
  const [lawListItemCount, invitationCount, memberCount, chatCount] = await Promise.all([
    prisma.lawListItem.count({
      where: { law_list: { workspace_id: context.workspaceId } },
    }),
    prisma.workspaceInvitation.count({
      where: { workspace_id: context.workspaceId, invited_by: context.userId },
    }),
    prisma.workspaceMember.count({
      where: { workspace_id: context.workspaceId },
    }),
    prisma.chatMessage.count({
      where: { workspace_id: context.workspaceId, user_id: context.userId, role: 'USER' },
    }),
  ])

  const completed = {
    law_list: lawListItemCount > 0,
    team: invitationCount > 0 || memberCount > 1, // Invited someone or others have joined
    ai_chat: chatCount > 0,
    customize: false, // Tracked separately if user manually added/removed a law
  }

  return NextResponse.json({
    dismissed: false,
    completed,
    confettiShown: preferences?.onboardingConfettiShown ?? false,
  })
}
```

**Dismiss Endpoint:**

```typescript
// app/api/onboarding/checklist/dismiss/route.ts
export async function POST() {
  const context = await getWorkspaceContext()

  await prisma.userPreferences.upsert({
    where: { userId: context.userId },
    update: { onboardingDismissed: true },
    create: { userId: context.userId, onboardingDismissed: true },
  })

  return NextResponse.json({ success: true })
}
```

**Confetti Shown Endpoint:**

```typescript
// app/api/onboarding/checklist/confetti/route.ts
export async function POST() {
  const context = await getWorkspaceContext()

  await prisma.userPreferences.upsert({
    where: { userId: context.userId },
    update: { onboardingConfettiShown: true },
    create: { userId: context.userId, onboardingConfettiShown: true },
  })

  return NextResponse.json({ success: true })
}
```

**Reference:** `lib/auth/workspace-context.ts` (getWorkspaceContext), Story 14.5 (conversational onboarding — complementary)

## Testing

**Unit Tests:**

- Completion detection returns correct status for each item
- Dismissal persists to database
- Confetti-shown flag persists correctly

**Integration Tests:**

- Complete all checklist items, verify all show as completed
- Dismiss checklist, verify does not show on next load
- Confetti only triggers once

**Test File:** `tests/unit/api/onboarding-checklist.test.ts`

## Change Log

| Date       | Version | Description                                              | Author     |
| ---------- | ------- | -------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                   | Sarah (PO) |
| 2026-02-19 | 2.0     | Clarified relationship to 14.5, updated auth/API patterns | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
