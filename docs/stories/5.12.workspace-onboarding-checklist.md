# Story 5.12: Implement Workspace Onboarding Checklist

## Status
Draft

## Story

**As a** new user,
**I want** to see a checklist of setup steps,
**so that** I know how to get started.

## Acceptance Criteria

1. After first login, onboarding checklist displayed in Dashboard
2. Checklist items:
   - âœ… Law list generated (auto-completed during onboarding)
   - â¬œ Invite your team
   - â¬œ Add your first employee
   - â¬œ Ask AI a question
   - â¬œ Customize law list
3. Each item links to relevant page
4. Checklist dismissible (persisted in user preferences)
5. Progress % shown: "2/5 completed"
6. Gamification: Confetti animation when 100% complete

## Tasks / Subtasks

- [ ] Create onboarding checklist component
- [ ] Implement progress tracking
- [ ] Add click handlers to navigate to relevant pages
- [ ] Implement dismissible functionality
- [ ] Add confetti animation for completion
- [ ] Test checklist persistence

## Dev Notes

**Database Schema:**
```prisma
model UserPreferences {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  onboardingDismissed     Boolean  @default(false)
  onboardingCompleted     Json?    // { law_list: true, team: false, ... }
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}
```

**Onboarding Checklist Component:**
```typescript
// components/onboarding/onboarding-checklist.tsx
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import confetti from 'canvas-confetti'

interface ChecklistItem {
  id: string
  label: string
  description: string
  completed: boolean
  link: string
}

export function OnboardingChecklist() {
  const [items, setItems] = useState<ChecklistItem[]>([])
  const [isDismissed, setIsDismissed] = useState(false)
  const [isLoading, setIsLoading] = useState(true)
  const router = useRouter()

  useEffect(() => {
    fetchChecklistStatus()
  }, [])

  async function fetchChecklistStatus() {
    const response = await fetch('/api/onboarding/checklist')
    const data = await response.json()

    if (data.dismissed) {
      setIsDismissed(true)
      setIsLoading(false)
      return
    }

    setItems([
      {
        id: 'law_list',
        label: 'Law list generated',
        description: 'Your personalized law list is ready',
        completed: data.completed.law_list || false,
        link: '/laws'
      },
      {
        id: 'team',
        label: 'Invite your team',
        description: 'Collaborate with team members',
        completed: data.completed.team || false,
        link: '/settings/team'
      },
      {
        id: 'employee',
        label: 'Add your first employee',
        description: 'Start managing your workforce',
        completed: data.completed.employee || false,
        link: '/employees'
      },
      {
        id: 'ai_chat',
        label: 'Ask AI a question',
        description: 'Try the AI-powered legal assistant',
        completed: data.completed.ai_chat || false,
        link: '/dashboard?open=chat'
      },
      {
        id: 'customize',
        label: 'Customize law list',
        description: 'Add or remove laws as needed',
        completed: data.completed.customize || false,
        link: '/laws/manage'
      }
    ])

    setIsLoading(false)

    // Check if all completed
    const allCompleted = Object.values(data.completed).every((v) => v === true)
    if (allCompleted && !data.hasShownConfetti) {
      // Show confetti
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      })

      // Mark confetti as shown
      await fetch('/api/onboarding/checklist', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hasShownConfetti: true })
      })
    }
  }

  async function dismissChecklist() {
    await fetch('/api/onboarding/checklist/dismiss', {
      method: 'POST'
    })

    setIsDismissed(true)
  }

  if (isLoading || isDismissed) return null

  const completedCount = items.filter((item) => item.completed).length
  const totalCount = items.length
  const progress = (completedCount / totalCount) * 100

  return (
    <div className="bg-white rounded-lg shadow p-6 mb-6">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h2 className="text-lg font-semibold">Get Started with Laglig.se</h2>
          <p className="text-sm text-gray-600">
            Complete these steps to get the most out of your workspace
          </p>
        </div>
        <button
          onClick={dismissChecklist}
          className="text-gray-400 hover:text-gray-600"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      {/* Progress Bar */}
      <div className="mb-6">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium text-gray-700">
            {completedCount}/{totalCount} completed
          </span>
          <span className="text-sm text-gray-600">{Math.round(progress)}%</span>
        </div>
        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
          <div
            className="h-full bg-gradient-to-r from-blue-500 to-blue-600 transition-all duration-500"
            style={{ width: `${progress}%` }}
          />
        </div>
      </div>

      {/* Checklist Items */}
      <div className="space-y-3">
        {items.map((item) => (
          <button
            key={item.id}
            onClick={() => router.push(item.link)}
            className="w-full flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left"
          >
            {/* Checkbox */}
            <div className={`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 mt-0.5 ${
              item.completed
                ? 'bg-green-500 border-green-500'
                : 'border-gray-300'
            }`}>
              {item.completed && (
                <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                </svg>
              )}
            </div>

            {/* Content */}
            <div className="flex-1">
              <p className={`font-medium ${item.completed ? 'text-gray-500 line-through' : 'text-gray-900'}`}>
                {item.label}
              </p>
              <p className="text-sm text-gray-600">{item.description}</p>
            </div>

            {/* Arrow */}
            {!item.completed && (
              <svg className="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
              </svg>
            )}
          </button>
        ))}
      </div>

      {/* Completion Message */}
      {completedCount === totalCount && (
        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
          <p className="text-sm text-green-800 font-medium">
            ðŸŽ‰ Congratulations! You've completed the onboarding checklist.
          </p>
        </div>
      )}
    </div>
  )
}
```

**Checklist API:**
```typescript
// app/api/onboarding/checklist/route.ts
export async function GET(request: Request) {
  return withWorkspace(async ({ userId, workspaceId }) => {
    // Get user preferences
    const preferences = await prisma.userPreferences.findUnique({
      where: { userId }
    })

    if (preferences?.onboardingDismissed) {
      return NextResponse.json({ dismissed: true })
    }

    // Check completion status
    const completed = await checkOnboardingCompletion(userId, workspaceId)

    return NextResponse.json({
      dismissed: false,
      completed,
      hasShownConfetti: preferences?.onboardingCompleted?.hasShownConfetti || false
    })
  })
}

export async function PATCH(request: Request) {
  return withWorkspace(async ({ userId }) => {
    const { hasShownConfetti } = await request.json()

    await prisma.userPreferences.upsert({
      where: { userId },
      update: {
        onboardingCompleted: {
          hasShownConfetti
        }
      },
      create: {
        userId,
        onboardingCompleted: {
          hasShownConfetti
        }
      }
    })

    return NextResponse.json({ success: true })
  })
}

async function checkOnboardingCompletion(userId: string, workspaceId: string) {
  // Law list: Check if workspace has laws
  const lawCount = await prisma.workspaceLaw.count({
    where: { workspaceId }
  })

  // Team: Check if invited anyone
  const invitationCount = await prisma.workspaceInvitation.count({
    where: { workspaceId, invitedBy: userId }
  })

  // Employee: Check if added employee
  const employeeCount = await prisma.employee.count({
    where: { workspaceId }
  })

  // AI Chat: Check if sent message
  const chatCount = await prisma.chatMessage.count({
    where: { workspaceId, userId, role: 'user' }
  })

  // Customize: Check if manually added/removed law
  const customizedCount = await prisma.workspaceLaw.count({
    where: {
      workspaceId,
      addedAt: {
        gt: new Date(Date.now() - 24 * 60 * 60 * 1000) // Added in last 24h (after onboarding)
      }
    }
  })

  return {
    law_list: lawCount > 0,
    team: invitationCount > 0,
    employee: employeeCount > 0,
    ai_chat: chatCount > 0,
    customize: customizedCount > 0
  }
}
```

**Dismiss Checklist API:**
```typescript
// app/api/onboarding/checklist/dismiss/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ userId }) => {
    await prisma.userPreferences.upsert({
      where: { userId },
      update: {
        onboardingDismissed: true
      },
      create: {
        userId,
        onboardingDismissed: true
      }
    })

    return NextResponse.json({ success: true })
  })
}
```

**Add to Dashboard:**
```typescript
// app/dashboard/page.tsx
import { OnboardingChecklist } from '@/components/onboarding/onboarding-checklist'

export default function DashboardPage() {
  return (
    <div className="max-w-7xl mx-auto p-6">
      {/* Onboarding Checklist */}
      <OnboardingChecklist />

      {/* Rest of dashboard content */}
      {/* ... */}
    </div>
  )
}
```

**Reference:** PRD Epic 5 Story 5.12, Onboarding best practices

## Testing

**Unit Tests:**
- `checkOnboardingCompletion()` returns correct status
- Progress calculation is accurate
- Dismiss persists to database

**Integration Tests:**
- Complete all checklist items, verify confetti shows
- Dismiss checklist, verify doesn't show on next login
- Click checklist item, verify navigates to correct page

**Manual Testing:**
- Login as new user, verify checklist shows
- Complete each item, verify checked off
- Complete all items, verify confetti animation
- Dismiss checklist, verify hidden
- Login again, verify checklist stays dismissed

**Test File:** `__tests__/features/onboarding/checklist.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Complete checklist items to get started
- Dismiss checklist when no longer needed

**Developer Responsibility:**
- Track completion status automatically
- Show confetti animation once on 100% completion
- Persist dismissal state
- Provide clear navigation to relevant pages
- Make checklist non-intrusive (easy to dismiss)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
