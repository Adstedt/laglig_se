# Story 4.7: Implement Trial Signup Flow

## Status
Draft

## Story

**As a** visitor,
**I want** to sign up for a free trial after seeing my law list,
**so that** I can save it and access full features.

## Acceptance Criteria

1. Clicking "Spara och fortsätt" opens signup modal
2. Signup form fields: Email, Password, Company name (pre-filled from Bolagsverket)
3. Password complexity validation (min 8 chars, 1 number, 1 special char, 1 uppercase)
4. Password breach check via HaveIBeenPwned API
5. Checkbox: "I agree to Terms of Service and Privacy Policy"
6. "Start 14-dagars gratis provperiod" CTA
7. Credit card NOT required for trial
8. Account created → Email verification sent (6-digit code)
9. User redirected to email verification page
10. Generated law list automatically saved to user's workspace
11. Error handling: Email already exists, weak password, API errors

## Tasks / Subtasks

- [ ] Create signup modal component
- [ ] Implement password complexity validation
- [ ] Integrate HaveIBeenPwned API for password breach check
- [ ] Create account creation API endpoint
- [ ] Auto-save generated law list to workspace
- [ ] Implement email verification code sending
- [ ] Add error handling for duplicate emails
- [ ] Create Terms of Service and Privacy Policy pages
- [ ] Test complete signup flow

## Dev Notes

**Signup Modal Component:**
```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'

const signupSchema = z.object({
  email: z.string().email('Ogiltig e-postadress'),
  password: z
    .string()
    .min(8, 'Lösenordet måste vara minst 8 tecken')
    .regex(/[A-Z]/, 'Lösenordet måste innehålla minst en stor bokstav')
    .regex(/[0-9]/, 'Lösenordet måste innehålla minst en siffra')
    .regex(
      /[^A-Za-z0-9]/,
      'Lösenordet måste innehålla minst ett specialtecken'
    ),
  companyName: z.string().min(1, 'Företagsnamn krävs'),
  agreeToTerms: z.boolean().refine((val) => val === true, {
    message: 'Du måste acceptera användarvillkoren'
  })
})

type SignupForm = z.infer<typeof signupSchema>

export function SignupModal({
  isOpen,
  onClose,
  companyData
}: SignupModalProps) {
  const [isLoading, setIsLoading] = useState(false)
  const [passwordStrength, setPasswordStrength] = useState<
    'weak' | 'medium' | 'strong' | null
  >(null)
  const [isPasswordBreached, setIsPasswordBreached] = useState(false)

  const {
    register,
    handleSubmit,
    watch,
    formState: { errors }
  } = useForm<SignupForm>({
    resolver: zodResolver(signupSchema),
    defaultValues: {
      companyName: companyData.companyName,
      agreeToTerms: false
    }
  })

  const password = watch('password')

  // Check password breach on change
  useEffect(() => {
    if (password && password.length >= 8) {
      checkPasswordBreach(password)
    }
  }, [password])

  async function checkPasswordBreach(password: string) {
    const sha1 = await hashPassword(password)
    const prefix = sha1.substring(0, 5)
    const suffix = sha1.substring(5)

    const response = await fetch(
      `https://api.pwnedpasswords.com/range/${prefix}`
    )
    const hashes = await response.text()

    const isBreached = hashes
      .split('\n')
      .some((line) => line.split(':')[0] === suffix.toUpperCase())

    setIsPasswordBreached(isBreached)

    // Calculate password strength
    if (isBreached) {
      setPasswordStrength('weak')
    } else if (password.length >= 12 && /[^A-Za-z0-9]/.test(password)) {
      setPasswordStrength('strong')
    } else {
      setPasswordStrength('medium')
    }
  }

  async function hashPassword(password: string): Promise<string> {
    const encoder = new TextEncoder()
    const data = encoder.encode(password)
    const hashBuffer = await crypto.subtle.digest('SHA-1', data)
    const hashArray = Array.from(new Uint8Array(hashBuffer))
    return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('')
  }

  async function onSubmit(data: SignupForm) {
    if (isPasswordBreached) {
      alert(
        'Detta lösenord har läckt i tidigare dataintrång. Välj ett annat lösenord.'
      )
      return
    }

    setIsLoading(true)

    try {
      const response = await fetch('/api/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: data.email,
          password: data.password,
          companyName: data.companyName,
          companyData: companyData // includes SNI, employee count, etc.
        })
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message)
      }

      const result = await response.json()

      // Redirect to email verification
      window.location.href = `/verify-email?email=${encodeURIComponent(data.email)}`
    } catch (error) {
      alert(error.message || 'Något gick fel. Försök igen.')
    } finally {
      setIsLoading(false)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-2xl font-bold">Skapa konto</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* Email */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              E-postadress
            </label>
            <input
              type="email"
              {...register('email')}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="din@epost.se"
            />
            {errors.email && (
              <p className="mt-1 text-sm text-red-600">{errors.email.message}</p>
            )}
          </div>

          {/* Password */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Lösenord
            </label>
            <input
              type="password"
              {...register('password')}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Minst 8 tecken"
            />
            {errors.password && (
              <p className="mt-1 text-sm text-red-600">{errors.password.message}</p>
            )}

            {/* Password strength indicator */}
            {passwordStrength && (
              <div className="mt-2">
                <div className="flex gap-1 mb-1">
                  <div
                    className={`h-1 flex-1 rounded ${
                      passwordStrength === 'weak'
                        ? 'bg-red-500'
                        : passwordStrength === 'medium'
                        ? 'bg-yellow-500'
                        : 'bg-green-500'
                    }`}
                  />
                  <div
                    className={`h-1 flex-1 rounded ${
                      passwordStrength === 'medium'
                        ? 'bg-yellow-500'
                        : passwordStrength === 'strong'
                        ? 'bg-green-500'
                        : 'bg-gray-200'
                    }`}
                  />
                  <div
                    className={`h-1 flex-1 rounded ${
                      passwordStrength === 'strong' ? 'bg-green-500' : 'bg-gray-200'
                    }`}
                  />
                </div>
                <p
                  className={`text-xs ${
                    passwordStrength === 'weak'
                      ? 'text-red-600'
                      : passwordStrength === 'medium'
                      ? 'text-yellow-600'
                      : 'text-green-600'
                  }`}
                >
                  {passwordStrength === 'weak' && 'Svagt lösenord'}
                  {passwordStrength === 'medium' && 'Medel lösenord'}
                  {passwordStrength === 'strong' && 'Starkt lösenord'}
                </p>
              </div>
            )}

            {isPasswordBreached && (
              <p className="mt-2 text-sm text-red-600">
                ⚠️ Detta lösenord har läckt i tidigare dataintrång. Välj ett annat.
              </p>
            )}
          </div>

          {/* Company Name */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Företagsnamn
            </label>
            <input
              type="text"
              {...register('companyName')}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            {errors.companyName && (
              <p className="mt-1 text-sm text-red-600">
                {errors.companyName.message}
              </p>
            )}
          </div>

          {/* Terms checkbox */}
          <div className="flex items-start">
            <input
              type="checkbox"
              {...register('agreeToTerms')}
              className="mt-1 mr-2"
            />
            <label className="text-sm text-gray-700">
              Jag accepterar{' '}
              <a href="/terms" target="_blank" className="text-blue-600 hover:underline">
                användarvillkoren
              </a>{' '}
              och{' '}
              <a
                href="/privacy"
                target="_blank"
                className="text-blue-600 hover:underline"
              >
                integritetspolicyn
              </a>
            </label>
          </div>
          {errors.agreeToTerms && (
            <p className="text-sm text-red-600">{errors.agreeToTerms.message}</p>
          )}

          {/* Submit button */}
          <button
            type="submit"
            disabled={isLoading || isPasswordBreached}
            className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
          >
            {isLoading ? 'Skapar konto...' : 'Start 14-dagars gratis provperiod'}
          </button>

          <p className="text-xs text-center text-gray-600">
            Inget kreditkort krävs. Avsluta när som helst.
          </p>
        </form>
      </div>
    </div>
  )
}
```

**Signup API Endpoint:**
```typescript
// app/api/auth/signup/route.ts
import { hash } from 'bcryptjs'

export async function POST(request: Request) {
  const { email, password, companyName, companyData } = await request.json()

  // Check if email already exists
  const existingUser = await prisma.user.findUnique({
    where: { email }
  })

  if (existingUser) {
    return NextResponse.json(
      { message: 'E-postadressen används redan' },
      { status: 400 }
    )
  }

  // Hash password
  const hashedPassword = await hash(password, 12)

  // Create user and workspace in transaction
  const result = await prisma.$transaction(async (tx) => {
    // Create user
    const user = await tx.user.create({
      data: {
        email,
        password: hashedPassword,
        emailVerified: false
      }
    })

    // Create workspace
    const workspace = await tx.workspace.create({
      data: {
        name: companyName,
        ownerId: user.id,
        subscriptionTier: 'trial',
        trialEndsAt: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000), // 14 days
        status: 'active'
      }
    })

    // Create company profile
    await tx.companyProfile.create({
      data: {
        workspaceId: workspace.id,
        companyName,
        sniCode: companyData.sniCode,
        legalForm: companyData.legalForm,
        employeeCount: companyData.employeeCount,
        address: companyData.address,
        contextualAnswers: companyData.contextualAnswers
      }
    })

    // Create workspace member
    await tx.workspaceMember.create({
      data: {
        workspaceId: workspace.id,
        userId: user.id,
        role: 'owner'
      }
    })

    // Save Phase 1 laws to workspace
    if (companyData.phase1Laws) {
      await tx.workspaceLaw.createMany({
        data: companyData.phase1Laws.map((law: any) => ({
          workspaceId: workspace.id,
          lawId: law.law_id,
          commentary: law.commentary,
          category: law.category,
          phase: 1
        }))
      })
    }

    return { user, workspace }
  })

  // Generate 6-digit verification code
  const verificationCode = Math.floor(100000 + Math.random() * 900000).toString()

  // Store verification code
  await prisma.verificationCode.create({
    data: {
      userId: result.user.id,
      code: verificationCode,
      expiresAt: new Date(Date.now() + 30 * 60 * 1000) // 30 minutes
    }
  })

  // Send verification email
  await sendVerificationEmail(email, verificationCode, companyName)

  // Enqueue Phase 2 law generation
  await enqueuePhase2Generation({
    userId: result.user.id,
    workspaceId: result.workspace.id,
    phase1LawIds: companyData.phase1Laws.map((l: any) => l.law_id),
    contextualAnswers: companyData.contextualAnswers
  })

  return NextResponse.json({
    success: true,
    userId: result.user.id,
    workspaceId: result.workspace.id
  })
}
```

**Send Verification Email:**
```typescript
// lib/email/send-verification-email.ts
import { Resend } from 'resend'
import { VerificationEmail } from '@/components/emails/verification-email'

const resend = new Resend(process.env.RESEND_API_KEY)

export async function sendVerificationEmail(
  email: string,
  code: string,
  companyName: string
) {
  await resend.emails.send({
    from: 'Laglig.se <no-reply@laglig.se>',
    to: email,
    subject: 'Verifiera din e-postadress',
    react: VerificationEmail({ code, companyName })
  })
}
```

**Reference:** PRD Epic 4 Story 4.5, Architecture Section 9 (Authentication), Supabase Auth documentation

## Testing

**Unit Tests:**
- Password validation rejects weak passwords
- Email validation rejects invalid emails
- Company name validation rejects empty strings
- Terms checkbox validation requires acceptance

**Integration Tests:**
- Complete signup flow creates user, workspace, and company profile
- Phase 1 laws saved to workspace correctly
- Phase 2 generation job enqueued
- Verification code generated and emailed
- Duplicate email returns error

**Manual Testing:**
- Test with valid credentials
- Test with weak password (should reject)
- Test with breached password (should reject)
- Test with duplicate email (should error)
- Test without accepting terms (should error)
- Verify email sent with 6-digit code
- Verify Phase 2 generation starts in background

**Security Testing:**
- Password hashed correctly (bcryptjs)
- HaveIBeenPwned API check works
- Verification code expires after 30 minutes
- SQL injection protection (Prisma ORM)

**Test File:** `__tests__/features/auth/signup.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**
- Provide valid email address
- Choose strong, unique password
- Accept Terms of Service and Privacy Policy
- Provide accurate company information

**Developer Responsibility:**
- Implement password complexity validation
- Check password breaches via HaveIBeenPwned
- Hash passwords securely (bcryptjs)
- Send verification email with 6-digit code
- Create workspace and save Phase 1 laws automatically
- Enqueue Phase 2 generation job
- Handle duplicate email errors gracefully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
