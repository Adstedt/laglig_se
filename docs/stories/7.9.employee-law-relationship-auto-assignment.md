# Story 7.9: Build Employee-Law Relationship (Auto-Assignment)

## Status
Draft

## Story

**As a** system,
**I want** to automatically suggest laws relevant to each employee,
**so that** users see which laws apply to whom.

## Acceptance Criteria

1. When employee created, AI analyzes role + department + kollektivavtal
2. System suggests 5-10 relevant laws (e.g., employee role=construction_worker → suggest Arbetsmiljölagen, Byggarbetskonventionen)
3. Suggested laws shown in Employee Profile → Compliance tab
4. User can accept/reject suggestions
5. Accepted laws linked in `employee_laws` table
6. Law cards in Kanban show assigned employees
7. Filtering Kanban by employee shows only their relevant laws
8. Auto-assignment runs asynchronously (background job)

## Tasks / Subtasks

- [ ] Create `employee_laws` database table
- [ ] Implement AI role-to-law matching logic
- [ ] Build background job for auto-assignment
- [ ] Display suggested laws in Employee Profile
- [ ] Add accept/reject buttons for suggestions
- [ ] Update Kanban law cards to show assigned employees
- [ ] Implement Kanban filter by employee
- [ ] Trigger auto-assignment on employee creation
- [ ] Test AI matching accuracy
- [ ] Test accept/reject functionality

## Dev Notes

**Database Schema:**
```prisma
model EmployeeLaw {
  id         String   @id @default(uuid())
  employeeId String
  lawId      String
  assignedBy String?  // null if AI-assigned
  assignedAt DateTime @default(now())
  source     String   @default("ai") // ai, manual, kollektivavtal

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  law        Law      @relation(fields: [lawId], references: [id], onDelete: Cascade)
  assigner   User?    @relation(fields: [assignedBy], references: [id])

  @@unique([employeeId, lawId])
  @@index([employeeId])
  @@index([lawId])
  @@map("employee_laws")
}

model LawSuggestion {
  id         String   @id @default(uuid())
  employeeId String
  lawId      String
  reason     String   // Why this law was suggested
  status     String   @default("pending") // pending, accepted, rejected
  createdAt  DateTime @default(now())

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  law        Law      @relation(fields: [lawId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@map("law_suggestions")
}
```

**AI Role-to-Law Matching:**
```typescript
// lib/employee-laws/suggest-relevant-laws.ts
import OpenAI from 'openai'
import { prisma } from '@/lib/prisma'

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

export async function suggestRelevantLaws(employee: any): Promise<Array<{ lawId: string; reason: string }>> {
  // Get all laws in workspace
  const workspaceLaws = await prisma.workspaceLaw.findMany({
    where: { workspaceId: employee.workspaceId },
    include: {
      law: {
        select: {
          id: true,
          sfsNummer: true,
          rubrik: true,
          omrade: true
        }
      }
    }
  })

  // Build employee context
  const employeeContext = `
Employee: ${employee.name}
Role: ${employee.role}
Department: ${employee.department || 'Not specified'}
Contract Type: ${employee.contractType}
Kollektivavtal: ${employee.kollektivavtal?.map((k: any) => k.kollektivavtal.name).join(', ') || 'None'}
  `.trim()

  // Build law list
  const lawList = workspaceLaws
    .map((wl) => `- ${wl.law.sfsNummer}: ${wl.law.rubrik} (${wl.law.omrade})`)
    .join('\n')

  // Ask AI to suggest relevant laws
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      {
        role: 'system',
        content: `You are an expert in Swedish labor law. Given an employee's information, suggest which laws from the provided list are most relevant to them.

Consider:
- Job role and associated risks/regulations
- Industry-specific laws
- Contract type requirements
- General employment laws that apply to all employees

Return a JSON array of 5-10 most relevant laws with reasons. Format:
[
  { "sfsNummer": "1977:1160", "reason": "Arbetsmiljölagen applies to all employees regarding workplace safety" },
  ...
]`
      },
      {
        role: 'user',
        content: `${employeeContext}\n\nAvailable laws:\n${lawList}\n\nSuggest 5-10 most relevant laws for this employee.`
      }
    ],
    temperature: 0.3,
    max_tokens: 1000
  })

  const content = response.choices[0].message.content || '[]'
  const suggestions = JSON.parse(content)

  // Map SFS numbers to law IDs
  const result: Array<{ lawId: string; reason: string }> = []
  for (const suggestion of suggestions) {
    const workspaceLaw = workspaceLaws.find((wl) => wl.law.sfsNummer === suggestion.sfsNummer)
    if (workspaceLaw) {
      result.push({
        lawId: workspaceLaw.law.id,
        reason: suggestion.reason
      })
    }
  }

  return result
}
```

**Background Job for Auto-Assignment:**
```typescript
// lib/employee-laws/auto-assign-laws.ts
import { prisma } from '@/lib/prisma'
import { suggestRelevantLaws } from './suggest-relevant-laws'

export async function autoAssignLawsToEmployee(employeeId: string) {
  // Fetch employee with full context
  const employee = await prisma.employee.findUnique({
    where: { id: employeeId },
    include: {
      kollektivavtal: {
        include: {
          kollektivavtal: {
            select: { id: true, name: true }
          }
        }
      }
    }
  })

  if (!employee) {
    throw new Error('Employee not found')
  }

  // Get AI suggestions
  const suggestions = await suggestRelevantLaws(employee)

  // Save suggestions to database
  for (const suggestion of suggestions) {
    await prisma.lawSuggestion.upsert({
      where: {
        employeeId_lawId: {
          employeeId: employee.id,
          lawId: suggestion.lawId
        }
      },
      update: {
        reason: suggestion.reason,
        status: 'pending'
      },
      create: {
        employeeId: employee.id,
        lawId: suggestion.lawId,
        reason: suggestion.reason,
        status: 'pending'
      }
    })
  }

  console.log(`Created ${suggestions.length} law suggestions for employee ${employee.id}`)
}
```

**Trigger Auto-Assignment on Employee Creation:**
```typescript
// app/api/employees/route.ts (updated)
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, userId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_EMPLOYEES)

    const data = await request.json()

    // Create employee
    const employee = await prisma.employee.create({
      data: {
        workspaceId,
        name: data.name,
        // ... other fields
      }
    })

    // Trigger auto-assignment in background
    autoAssignLawsToEmployee(employee.id).catch((error) => {
      console.error('Auto-assignment failed:', error)
    })

    return NextResponse.json({ employee })
  })
}
```

**Display Suggestions in Employee Profile:**
```typescript
// components/hr/tabs/compliance-tab.tsx (updated)
export function ComplianceTab({ employee }: ComplianceTabProps) {
  const [suggestions, setSuggestions] = useState<any[]>([])

  useEffect(() => {
    fetch(`/api/employees/${employee.id}/law-suggestions`)
      .then((res) => res.json())
      .then((data) => setSuggestions(data.suggestions))
  }, [employee.id])

  async function handleAccept(suggestionId: string) {
    const response = await fetch(`/api/employees/${employee.id}/law-suggestions/${suggestionId}/accept`, {
      method: 'POST'
    })

    if (response.ok) {
      setSuggestions((prev) => prev.filter((s) => s.id !== suggestionId))
      router.refresh()
    }
  }

  async function handleReject(suggestionId: string) {
    const response = await fetch(`/api/employees/${employee.id}/law-suggestions/${suggestionId}/reject`, {
      method: 'POST'
    })

    if (response.ok) {
      setSuggestions((prev) => prev.filter((s) => s.id !== suggestionId))
    }
  }

  return (
    <div className="p-6">
      {/* Suggested Laws */}
      {suggestions.length > 0 && (
        <section className="mb-8">
          <h2 className="text-lg font-semibold mb-4">Suggested Laws</h2>
          <p className="text-sm text-gray-600 mb-4">
            Based on {employee.name}'s role and kollektivavtal, we suggest these laws may apply:
          </p>
          <div className="space-y-3">
            {suggestions.map((suggestion) => (
              <div key={suggestion.id} className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <h3 className="font-medium text-gray-900">
                      {suggestion.law.sfsNummer}: {suggestion.law.rubrik}
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">{suggestion.reason}</p>
                  </div>
                  <div className="flex gap-2 ml-4">
                    <button
                      onClick={() => handleAccept(suggestion.id)}
                      className="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
                      title="Accept"
                    >
                      ✓
                    </button>
                    <button
                      onClick={() => handleReject(suggestion.id)}
                      className="px-3 py-1.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm"
                      title="Reject"
                    >
                      ✗
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

      {/* Assigned Laws */}
      <section>
        <h2 className="text-lg font-semibold mb-4">Assigned Laws</h2>
        {employee.assignedLaws && employee.assignedLaws.length > 0 ? (
          <div className="space-y-2">
            {employee.assignedLaws.map((al: any) => (
              <div key={al.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                  <p className="font-medium text-gray-900">
                    {al.law.sfsNummer}: {al.law.rubrik}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    Assigned {al.source === 'ai' ? 'automatically' : 'manually'} on{' '}
                    {new Date(al.assignedAt).toLocaleDateString('sv-SE')}
                  </p>
                </div>
                <button
                  onClick={() => {
                    // TODO: Unassign law
                  }}
                  className="text-sm text-red-600 hover:text-red-700"
                >
                  Remove
                </button>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-sm text-gray-500">No laws assigned yet. Accept suggestions above to get started.</p>
        )}
      </section>
    </div>
  )
}
```

**Accept/Reject Suggestion APIs:**
```typescript
// app/api/employees/[id]/law-suggestions/[suggestionId]/accept/route.ts
export async function POST(request: Request, { params }: { params: { id: string; suggestionId: string } }) {
  return withWorkspace(async ({ userId }) => {
    const suggestion = await prisma.lawSuggestion.findUnique({
      where: { id: params.suggestionId }
    })

    if (!suggestion) {
      return NextResponse.json({ error: 'Suggestion not found' }, { status: 404 })
    }

    // Create employee-law relationship
    await prisma.employeeLaw.create({
      data: {
        employeeId: suggestion.employeeId,
        lawId: suggestion.lawId,
        assignedBy: userId,
        source: 'ai'
      }
    })

    // Update suggestion status
    await prisma.lawSuggestion.update({
      where: { id: params.suggestionId },
      data: { status: 'accepted' }
    })

    return NextResponse.json({ success: true })
  })
}

// app/api/employees/[id]/law-suggestions/[suggestionId]/reject/route.ts
export async function POST(request: Request, { params }: { params: { id: string; suggestionId: string } }) {
  return withWorkspace(async () => {
    await prisma.lawSuggestion.update({
      where: { id: params.suggestionId },
      data: { status: 'rejected' }
    })

    return NextResponse.json({ success: true })
  })
}
```

**Update Kanban Law Card to Show Assigned Employees:**
```typescript
// components/kanban/law-card.tsx (updated)
export function LawCard({ law }: { law: any }) {
  return (
    <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
      {/* ... law details ... */}

      {/* Assigned Employees */}
      {law.assignedEmployees && law.assignedEmployees.length > 0 && (
        <div className="mt-3 pt-3 border-t border-gray-100">
          <p className="text-xs text-gray-500 mb-2">Assigned to:</p>
          <div className="flex -space-x-2">
            {law.assignedEmployees.slice(0, 5).map((emp: any) => (
              <Avatar
                key={emp.employee.id}
                src={emp.employee.photoUrl}
                name={emp.employee.name}
                size="sm"
                className="border-2 border-white"
                title={emp.employee.name}
              />
            ))}
            {law.assignedEmployees.length > 5 && (
              <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-medium text-gray-600 border-2 border-white">
                +{law.assignedEmployees.length - 5}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  )
}
```

**Filter Kanban by Employee:**
```typescript
// components/kanban/kanban-toolbar.tsx (updated)
export function KanbanToolbar() {
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string | null>(null)
  const router = useRouter()

  const employees = await getEmployees() // Fetch employees

  function handleEmployeeFilter(employeeId: string | null) {
    setSelectedEmployeeId(employeeId)
    const params = new URLSearchParams()
    if (employeeId) params.set('employeeId', employeeId)
    router.push(`/workspace?${params.toString()}`)
  }

  return (
    <div className="bg-white border-b border-gray-200 px-6 py-4">
      <div className="flex items-center justify-between">
        {/* ... other controls ... */}

        {/* Employee Filter */}
        <select
          value={selectedEmployeeId || ''}
          onChange={(e) => handleEmployeeFilter(e.target.value || null)}
          className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
        >
          <option value="">All Employees</option>
          {employees.map((emp) => (
            <option key={emp.id} value={emp.id}>
              {emp.name}
            </option>
          ))}
        </select>
      </div>
    </div>
  )
}
```

**Reference:** PRD Epic 7 Story 7.9, OpenAI API documentation

## Testing

**Unit Tests:**
- AI role matching returns relevant laws
- Accept suggestion creates employee-law relationship
- Reject suggestion updates status to "rejected"
- Kanban filter by employee shows only assigned laws

**Integration Tests:**
- Create employee, verify auto-assignment job runs
- Accept suggested law, verify appears in "Assigned Laws"
- Reject suggested law, verify removed from suggestions
- Filter Kanban by employee, verify only their laws displayed
- Law card displays assigned employee avatars correctly

**Manual Testing:**
- Create new employee with role "construction_worker", verify laws like Arbetsmiljölagen suggested
- Accept suggested law, verify appears in Assigned Laws section
- Reject suggested law, verify disappears from suggestions
- View Kanban, verify law cards show assigned employee avatars
- Filter Kanban by employee, verify only their laws shown
- Create employee with no kollektivavtal, verify general laws suggested

**AI Accuracy Testing:**
- Test with role "manager", verify management-related laws suggested
- Test with role "warehouse_worker", verify warehouse safety laws suggested
- Test with kollektivavtal "Byggnads", verify construction laws suggested
- Test with generic role "employee", verify general employment laws suggested

**Performance Testing:**
- Auto-assignment for single employee completes <10 seconds
- Bulk auto-assignment for 100 employees completes <5 minutes
- AI law matching API call completes <3 seconds
- Kanban filter by employee instant (no lag)

**Test File:** `__tests__/features/employee-laws/auto-assignment.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Review AI suggestions critically (don't blindly accept)
- Accept relevant laws, reject irrelevant ones
- Manually assign additional laws if AI misses any
- Keep employee roles and kollektivavtal up-to-date for accurate suggestions

**Developer Responsibility:**
- Train AI prompts to suggest accurate, relevant laws
- Provide clear reasons for each suggestion (transparency)
- Make accept/reject actions intuitive (one-click buttons)
- Run auto-assignment asynchronously (don't block employee creation)
- Store suggestion metadata for future improvement (track acceptance rate)
- Display assigned employees clearly in Kanban law cards
- Optimize Kanban filtering for large datasets (database indexes)
- Handle AI API failures gracefully (retry, fallback, error logging)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
