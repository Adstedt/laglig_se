# Story 9.4: Seed Template Verification & Content Generation

## Status

Draft

## Story

**As a** product owner preparing for beta launch,
**I want** all 188 unique template entries verified to have complete content and AI-generated summaries/compliance guidance,
**so that** Stories 12.4 (Seed Arbetsmiljö) and 12.5 (Seed Miljö) are fully unblocked and templates deliver real value to users.

## Acceptance Criteria

### SFS Gap Fixes

1. SFS 1977:480 (Semesterlag) ingested with full content from Riksdagen API
2. SFS 1999:678 (Lag om utstationering av arbetstagare) ingested with full content from Riksdagen API
3. SFS 1999:381 (Sevesolagen) has `full_text` and `html_content` populated (currently exists but empty)

### EU Regulation Verification

4. All 18 EU regulations required by templates are verified present in database with content (coordinate with Story 2.4)
5. Any missing EU regulations are flagged and ingestion is triggered via the Story 2.4 pipeline
6. EU documents have at minimum `full_text` populated (HTML optional for EU docs from CELLAR API)

### Content Completeness Audit

7. Verification script confirms all 188 unique template entries (from `data/seed-template-documents.csv`) have non-null `html_content` or `full_text`
8. Any documents still missing content are identified and remediated
9. No stub records remain for template-referenced documents (all have real content)

### AI Content Generation

10. Story 12.3 content generation pipeline executed on all newly ingested documents from Stories 9.1-9.3
11. All template-referenced documents have `summary` (summering) populated
12. All template-referenced documents have `kommentar` (compliance guidance) populated
13. AI-generated content passes quality validation (neutral tone for summering, "Vi ska..." voice for kommentar)

### Readiness Gate

14. Automated check confirms: 0 template-referenced documents with null content fields
15. Stories 12.4 and 12.5 are formally unblocked

## Tasks / Subtasks

- [ ] **Task 1: Fix missing SFS documents** (AC: 1-3)
  - [ ] Run existing sync pipeline or manual fetch for SFS 1977:480 from Riksdagen API
  - [ ] Run existing sync pipeline or manual fetch for SFS 1999:678 from Riksdagen API
  - [ ] Investigate why SFS 1999:381 has empty content — re-fetch from Riksdagen API
  - [ ] Verify all 3 documents have `full_text` and `html_content` after fix

- [ ] **Task 2: Verify EU regulation coverage** (AC: 4-6)
  - [ ] Create `scripts/check-eu-template-coverage.ts`
  - [ ] Check all 18 EU doc numbers from the CSV against `legal_documents` table
  - [ ] For any missing: trigger ingestion via Story 2.4 CELLAR API pipeline
  - [ ] List: (EG) 1907/2006, (EG) 1272/2008, (EU) 2019/1021, (EU) 2016/679, (EG) 561/2006, (EU) 165/2014, (EU) 2023/1230, (EG) 166/2006, (EG) 440/2008, (EU) 649/2012, (EU) 852/2020, (EU) 573/2024, (EU) 590/2024, (EU) 956/2023, (EU) 1115/2023, (EU) 1542/2023, (EU) 2772/2023, (EU) 40/2025

- [ ] **Task 3: Create comprehensive audit script** (AC: 7-9, 14)
  - [ ] Create `scripts/audit-template-coverage.ts`
  - [ ] Read all document numbers from `data/seed-template-documents.csv`
  - [ ] For each, check `legal_documents` table for:
    - Record exists (by `document_number`)
    - `html_content` is not null (or `full_text` as fallback)
    - `summary` is not null
    - `kommentar` is not null
  - [ ] Output report: PASS/FAIL per document, grouped by authority
  - [ ] Output summary: total coverage %, missing content list, missing AI content list

- [ ] **Task 4: Run Story 12.3 content generation pipeline** (AC: 10-13)
  - [ ] Execute `scripts/generate-document-content.ts --scope template-docs`
  - [ ] Target: all documents referenced by templates that are missing `summary` or `kommentar`
  - [ ] Use `--force` if needed to regenerate for documents that gained content in Stories 9.1-9.3
  - [ ] Review quality validation output for warnings/errors
  - [ ] Address any hallucination flags from Haiku validation pass

- [ ] **Task 5: Remediate any remaining gaps** (AC: 8, 14)
  - [ ] Re-run audit script after content generation
  - [ ] For any documents still failing: investigate individually
  - [ ] Manual fixes if needed (e.g., PDF not processable, API unavailable)
  - [ ] Document any permanent gaps with justification

- [ ] **Task 6: Final readiness confirmation** (AC: 14-15)
  - [ ] Run audit script one final time — expect 0 failures
  - [ ] Update Epic 9 status
  - [ ] Confirm Stories 12.4 and 12.5 are unblocked in story files/backlog

## Dev Notes

### Dependency Chain

This story depends on Stories 9.1, 9.2, and 9.3 completing first (agency regulation content). It also coordinates with Story 2.4 (EU regulation ingestion) which is independently in progress.

```
Story 9.1 (AFS) ──┐
Story 9.2 (MSBFS/NFS) ──┤── Story 9.4 (Verification) ──► Stories 12.4/12.5 (Template Seeding)
Story 9.3 (Remaining) ──┤
Story 2.4 (EU) ─────────┘
```

### Content Generation Pipeline Reference

Story 12.3 built the pipeline in `scripts/generate-document-content.ts`:

- **Scope flag:** `--scope template-docs` targets ~265 template-referenced documents
- **Batch API:** Uses Anthropic Batch API (50% cost savings) with Claude Opus for generation
- **Validation:** Haiku 4.5 hallucination check as second pass
- **Output fields:** `summary` (neutral voice) and `kommentar` ("Vi ska..." voice)
- **Prompts:** `lib/ai/prompts/document-content.ts`
- **Resumable:** `--batch-id <id>` to resume interrupted batches

### EU Document Number Format

EU documents in the database may use a different format than the CSV. The audit script needs to handle format matching:
- CSV: `(EG) nr 1907/2006`
- DB might have: `EU 2016/679`, `(EU) 2016/679`, or CELEX numbers
- Build flexible matching logic

### SFS Gap Analysis (from check-seed-sfs-coverage.ts)

Already verified:
- **79/81 SFS docs present with content**
- Missing: SFS 1977:480, SFS 1999:678
- Empty content: SFS 1999:381 (record exists, fields null)

These are trivially fixable via the existing `sync-sfs` pipeline or direct Riksdagen API fetch.

### Audit Script Output Format

```
=== TEMPLATE DOCUMENT AUDIT ===

AUTHORITY: SFS (81 documents)
  ✅ 79/81 have content
  ✅ 75/81 have AI summaries
  ❌ SFS 1977:480 — MISSING RECORD
  ❌ SFS 1999:678 — MISSING RECORD
  ⚠️ SFS 1999:381 — EMPTY CONTENT

AUTHORITY: AFS (50 entries)
  ✅ 50/50 have content (after Story 9.1)
  ❌ 50/50 need AI summaries

[... per authority ...]

SUMMARY: 185/188 documents ready (98.4%)
  Missing content: 3
  Missing AI summaries: 65
```

### Data Reference

- Document inventory: `data/seed-template-documents.csv`
- SFS coverage script: `scripts/check-seed-sfs-coverage.ts`

## Testing

### Unit Tests

- `tests/unit/scripts/audit-template-coverage.test.ts` — Mock Prisma, verify audit logic counts correctly
- Test format matching for EU document numbers
- Test CSV parsing handles all authority prefixes

### Testing Standards

- **Framework:** Vitest with `happy-dom` environment
- **Mocking:** `vi.mock()` for `@prisma/client`
- **No real API/DB calls in tests**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft created from Epic 9 analysis | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*To be filled after QA review*
