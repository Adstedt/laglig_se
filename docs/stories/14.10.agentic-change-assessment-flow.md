# Story 14.10: Agentic Change Assessment Flow

## Status

Draft

## Story

As a workspace member who has seen a change notification, I want the compliance partner to guide me through assessing what the change means for my company, so that I can make an informed decision and document my response.

## Context & Dependencies

**Why this story exists:** This is the PRIMARY agent interaction surface — where the compliance partner proves its value. When a user clicks a change from the Changes tab (Story 8.1) or a law list indicator, they land on the assessment page. The agent is pre-loaded with context about the specific change, the affected law, and the company's profile. It walks the user through understanding the change, assessing impact, and taking action.

This story was formerly Epic 8, Story 8.3 ("Agentic Change Assessment Flow" / "Mark as Reviewed Workflow"). It was moved to Epic 14 because the assessment flow IS the agent — it can't be built without the RAG pipeline, tools, and company context.

**Builds on:** Story 8.1 (Changes tab with tab=changes URL param, ChangeRow click navigation). Also absorbs Story 8.10 (Effective Date Tracking) — effective date badges and resolution logic are folded into this story rather than built as a standalone display story.

**Depends on:**
- Story 14.7 (agent tools — read + write)
- Story 14.8 (RAG pipeline)
- Story 14.9 (system prompt with company context)
- Story 14.4 (WorkspaceProfile for company context)

**Depended on by:**
- Story 14.11 (Compliance Partner Chat Interface — reuses agent infrastructure, ToolConfirmationCard, message formatting)

## Acceptance Criteria

### Data Model

1. Prisma model `ChangeAssessment` with fields: id (cuid), changeEventId (String), lawListItemId (String), workspaceId (String), status (AssessmentStatus enum), impactLevel (ImpactLevel enum), aiAnalysis (Text?), aiRecommendations (Json?), userNotes (Text?), userDecision (String?), assessedBy (String, userId), assessedAt (DateTime), createdAt, updatedAt
2. AssessmentStatus enum: IN_PROGRESS, REVIEWED, ACTION_REQUIRED, NOT_APPLICABLE, DEFERRED
3. ImpactLevel enum: HIGH, MEDIUM, LOW, NONE
4. Relations: ChangeAssessment -> ChangeEvent, ChangeAssessment -> LawListItem, ChangeAssessment -> Workspace
5. ComplianceStatusLog model: id, lawListItemId, previousStatus, newStatus, changedBy (userId), reason (String?), changeAssessmentId (nullable), changedAt (DateTime)
6. Migration runs cleanly

### Assessment Page

7. Route: `/laglistor/andringar/[changeEventId]` with `?item=[lawListItemId]` query param
8. Left panel: Change details — amendment document number, affected sections, change type badge, detected date, effective date badge (from 8.10 fold-in)
9. Right panel: Agent conversation — streaming chat with the compliance partner, pre-loaded with change context
10. Agent opens with contextual greeting: "Denna ändring av [lagnamn] genom [amendment SFS] påverkar [sections]. Här är vad som har ändrats och vad det kan innebära för er verksamhet..."
11. Agent has full tool access (all read + write tools from Story 14.7)
12. Agent uses RAG to ground its analysis in actual law text and company context

### Assessment Resolution

13. Resolution panel: user selects assessment status (REVIEWED, ACTION_REQUIRED, NOT_APPLICABLE, DEFERRED) and impact level
14. User can add notes and decision text
15. On save: creates ChangeAssessment record, updates `LawListItem.last_change_acknowledged_at`, logs ComplianceStatusLog if status changed
16. Assessment status visible in Changes tab (replaces the hardcoded "Ny" indicator from Story 8.1)

### Write Tool Confirmation

17. When agent proposes a write action (create task, update status), show a confirmation card in the chat with action details and Approve/Reject buttons
18. On approve: execute the action and show success message
19. On reject: agent acknowledges and continues conversation

### Effective Date Tracking (folded from Story 8.10)

20. Resolve effective date from chain: `ChangeEvent.amendment_sfs` → `AmendmentDocument.effective_date` → `Amendment.effective_date` → `LegalDocument.effective_date` → null
21. Shared utility `getEffectiveDateBadge(date)` returns Swedish-language badge: future (amber "Träder i kraft om N dagar"), today (red), recent past (green "Trädde i kraft"), unknown (gray "Ikraftträdandedatum okänt")
22. Left panel shows effective date badge next to detected date
23. Changes tab cards (Story 8.1) show effective date badge — import shared utility
24. Changes tab supports optional sort by effective date (upcoming first)

### Entry Points

25. Changes tab row click (Story 8.1) -> navigates to assessment page
26. Law list item change indicator click -> navigates to assessment page with pre-filtered context
27. Breadcrumb navigation back to Changes tab

### API Route

28. API route for agent: `app/api/agent/assessment/route.ts` using `streamText()` with all tools
29. Route receives changeEventId and lawListItemId, loads context, constructs system prompt with change details + company profile

### Testing

30. At least 18 unit tests covering: ChangeAssessment CRUD, ComplianceStatusLog, assessment page rendering, tool confirmation flow, effective date badge utility, effective date resolution, API route

## Tasks / Subtasks

- [ ] **Task 1: Schema + migration** (AC: 1-6)
  - [ ] Add `AssessmentStatus` enum to Prisma schema
  - [ ] Add `ImpactLevel` enum to Prisma schema
  - [ ] Add `ChangeAssessment` model with all fields and relations
  - [ ] Add `ComplianceStatusLog` model with all fields and relations
  - [ ] Generate and run migration
  - [ ] Verify migration runs cleanly on fresh and existing databases

- [ ] **Task 2: Server actions** (AC: 13-16)
  - [ ] Create `app/actions/change-assessment.ts`
  - [ ] Implement `createAssessment()` with workspace scoping via `withWorkspace()`
  - [ ] Implement `getAssessment()` by changeEventId + lawListItemId
  - [ ] Implement `updateAssessment()` with status and impact level updates
  - [ ] Update `LawListItem.last_change_acknowledged_at` on assessment save
  - [ ] Create `ComplianceStatusLog` entry when compliance status changes
  - [ ] Handle optimistic updates / error states

- [ ] **Task 3: API route** (AC: 23-24)
  - [ ] Create `app/api/agent/assessment/route.ts`
  - [ ] Load ChangeEvent + AmendmentDocument + SectionChange data for the given changeEventId
  - [ ] Load WorkspaceProfile for company context
  - [ ] Construct augmented system prompt: base prompt (Story 14.9) + change-specific context
  - [ ] Configure `streamText()` with all tools from Story 14.7
  - [ ] Include initial contextual greeting in system prompt

- [ ] **Task 4: Assessment page layout** (AC: 7-9)
  - [ ] Create `app/(workspace)/laglistor/andringar/[changeEventId]/page.tsx`
  - [ ] Server component that loads ChangeEvent, LawListItem, existing ChangeAssessment data
  - [ ] Two-panel layout: left (change details) + right (chat)
  - [ ] Left panel: amendment document number, affected sections, change type badge, detected date, effective date badge
  - [ ] Breadcrumb: Laglistor > Ändringar > [amendment identifier]

- [ ] **Task 5: Agent chat component** (AC: 9-12)
  - [ ] Create `components/features/assessment/assessment-chat.tsx`
  - [ ] Configure `useChat()` with `/api/agent/assessment` endpoint
  - [ ] Pass `changeEventId` and `lawListItemId` in request body
  - [ ] Render streaming messages with proper formatting
  - [ ] Handle tool invocations in message parts
  - [ ] Style agent messages vs user messages

- [ ] **Task 6: Write tool confirmation UI** (AC: 17-19)
  - [ ] Create `components/features/assessment/tool-confirmation-card.tsx`
  - [ ] Render proposed action details (action type, target, parameters)
  - [ ] Approve button: sends confirmation message to agent, executes action
  - [ ] Reject button: sends rejection message to agent, continues conversation
  - [ ] Loading state during action execution
  - [ ] Success/error feedback after execution

- [ ] **Task 7: Resolution panel** (AC: 13-16)
  - [ ] Create `components/features/assessment/resolution-panel.tsx`
  - [ ] AssessmentStatus selector (REVIEWED, ACTION_REQUIRED, NOT_APPLICABLE, DEFERRED)
  - [ ] ImpactLevel selector (HIGH, MEDIUM, LOW, NONE)
  - [ ] Notes textarea
  - [ ] Decision text field
  - [ ] Save button that calls `createAssessment()` / `updateAssessment()`
  - [ ] Visual feedback on save success

- [ ] **Task 8: Effective date utilities** (AC: 20-24)
  - [ ] Create `lib/utils/effective-date-badge.ts` with `getEffectiveDateBadge(date: Date | null)` returning `{ text, variant, className }`
  - [ ] Create `lib/utils/resolve-effective-date.ts` — resolves date from ChangeEvent → AmendmentDocument → Amendment → LegalDocument chain
  - [ ] Badge logic: future >30d (blue), future ≤30d (amber), today (red), recent past <30d (green), far past (no badge), null (gray)
  - [ ] Swedish-language labels throughout
  - [ ] Add effective date badge to assessment page left panel
  - [ ] Add effective date badge to Changes tab ChangeRow (Story 8.1 enhancement)
  - [ ] Add optional effective date sort to Changes tab

- [ ] **Task 9: Entry point integration** (AC: 25-27)
  - [ ] Verify ChangeRow navigation from Story 8.1 routes to assessment page correctly
  - [ ] Add change indicator click handler on law list items
  - [ ] Ensure `?item=[lawListItemId]` query param is passed through

- [ ] **Task 10: Update Changes tab status** (AC: 16)
  - [ ] Query ChangeAssessment status for each change in the Changes tab
  - [ ] Replace hardcoded "Ny" badge with actual assessment status badge
  - [ ] Status badge colors: IN_PROGRESS (yellow), REVIEWED (green), ACTION_REQUIRED (red), NOT_APPLICABLE (gray), DEFERRED (blue)

- [ ] **Task 11: Tests** (AC: 30)
  - [ ] Write tests for `createAssessment()` server action
  - [ ] Write tests for `getAssessment()` server action
  - [ ] Write tests for `updateAssessment()` with ComplianceStatusLog
  - [ ] Write tests for resolution panel rendering and interactions
  - [ ] Write tests for tool confirmation card approve/reject flow
  - [ ] Write tests for assessment page layout rendering
  - [ ] Write tests for `getEffectiveDateBadge()` (future, today, past, null)
  - [ ] Write tests for `resolveEffectiveDate()` chain resolution
  - [ ] Reach minimum 18 unit tests

## Dev Notes

- Story 8.1 already navigates to `/laglistor/andringar/[changeEventId]?item=[lawListItemId]` — this story creates the page at that route.
- The agent's opening message should be generated server-side by pre-constructing the initial context and including it in the system prompt.
- System prompt augmentation for assessment: append change-specific context (the specific law, the amendment details, affected sections) to the base system prompt from Story 14.9.
- `useChat()` hook config:
  ```typescript
  const { messages, input, handleInputChange, handleSubmit } = useChat({
    api: '/api/agent/assessment',
    body: { changeEventId, lawListItemId },
  })
  ```
- Tool confirmation flow: when the agent calls a write tool, the tool returns `{ confirmation_required: true, action: { ... } }`. The chat UI renders this as a ToolConfirmationCard. User clicks Approve -> sends a follow-up message to the agent with the confirmation. Agent then executes.
- ComplianceStatusLog: every time `LawListItem.complianceStatus` changes (either via agent tool or manual), log the transition. This creates the audit trail the agent can reference in future assessments.
- Left panel: use existing ChangeEvent data + join to AmendmentDocument for full amendment text. If SectionChange records exist, show them.
- Source tree:
  - `app/(workspace)/laglistor/andringar/[changeEventId]/page.tsx` (new)
  - `components/features/assessment/assessment-chat.tsx` (new)
  - `components/features/assessment/tool-confirmation-card.tsx` (new)
  - `components/features/assessment/resolution-panel.tsx` (new)
  - `app/api/agent/assessment/route.ts` (new)
  - `app/actions/change-assessment.ts` (new)
  - `lib/utils/effective-date-badge.ts` (new — folded from Story 8.10)
  - `lib/utils/resolve-effective-date.ts` (new — folded from Story 8.10)
- Existing patterns to follow:
  - Story 8.1 components: `components/features/changes/`
  - Server actions: `app/actions/change-events.ts`
  - Workspace scoping: `withWorkspace()` from `lib/auth/workspace-context.ts`
  - Compliance status enum values on LawListItem: UPPFYLLER_KRAV, UPPFYLLER_DELVIS, UPPFYLLER_INTE, UNDER_GRANSKNING, EJ_BEDÖMD

## Testing

- **Test files:**
  - `tests/unit/actions/change-assessment.test.ts`
  - `tests/unit/components/features/assessment/resolution-panel.test.ts`
  - `tests/unit/components/features/assessment/tool-confirmation-card.test.ts`
  - `tests/unit/lib/utils/effective-date-badge.test.ts`
- **What to test:**
  - ChangeAssessment CRUD operations (create, read, update)
  - ComplianceStatusLog creation on compliance status change
  - Resolution panel renders all AssessmentStatus options
  - Resolution panel renders all ImpactLevel options
  - Resolution panel save triggers createAssessment action
  - Tool confirmation card renders action details
  - Tool confirmation card approve triggers action execution
  - Tool confirmation card reject sends rejection message
  - Assessment page layout renders left + right panels
  - Breadcrumb navigation renders correctly
- **Patterns:** Vitest + React Testing Library. Mock Prisma for server action tests. Mock `useChat()` for component tests.

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2026-02-18 | 0.1     | Initial draft              | Claude |
| 2026-02-18 | 0.2     | Folded Story 8.10 (Effective Date Tracking) — added AC 20-24, Task 8, test entries. Removed Story 8.2 references (dropped). | Claude |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
