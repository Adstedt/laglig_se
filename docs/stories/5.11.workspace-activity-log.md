# Story 5.11: Enterprise Activity Log UI & CSV Export

## Status

Draft

## Story

**As an** Enterprise workspace admin,
**I want** to browse and export a filterable audit trail of workspace activity,
**so that** I can demonstrate compliance and investigate incidents.

## Context & Dependencies

- **Builds on:** Existing `ActivityLog` model in `prisma/schema.prisma` (added in Epic 6) — already logs entity changes with `entity_type`, `entity_id`, `action`, `old_value`, `new_value`
- **Builds on:** Story 5.2 (completed) — role-based permissions (`activity:view`)
- **Note:** This story does NOT create a new `WorkspaceActivityLog` model. The existing `ActivityLog` model is the single source of truth. This story adds the Enterprise-tier-gated UI, filtering, and CSV export on top of it.
- **Schema reference:** `prisma/schema.prisma` lines 1143-1167

## Acceptance Criteria

1. Activity Log page accessible at `/settings/activity-log` (or as tab in workspace settings)
2. Page gated to Enterprise tier — non-Enterprise workspaces see upgrade prompt
3. Only users with `activity:view` permission can access (OWNER, ADMIN, AUDITOR per Story 5.2)
4. Activity list shows: timestamp, user email, action description, entity type, entity ID
5. Filterable by: User (dropdown of workspace members), Action type, Date range
6. Paginated (50 items per page) with "Load more" or infinite scroll
7. "Exportera CSV" button exports filtered results as downloadable CSV file
8. Log retention: entries older than 2 years are cleaned up by cron job
9. Performance: queries use existing indexes on `[workspace_id, created_at]` and `[entity_type, entity_id]`

## Tasks / Subtasks

- [ ] Create activity log page at `/settings/activity-log`
- [ ] Add Enterprise tier gate with upgrade prompt
- [ ] Build activity log list with pagination
- [ ] Add filter controls (user, action type, date range)
- [ ] Create activity log API endpoint with filtering support
- [ ] Implement CSV export API endpoint
- [ ] Create Vercel cron route for 2-year retention cleanup
- [ ] Ensure all key workspace actions are logged (audit existing API routes)
- [ ] Test with realistic dataset for performance

## Dev Notes

**Existing `ActivityLog` model (DO NOT recreate):**

```prisma
model ActivityLog {
  id           String @id @default(uuid())
  workspace_id String
  user_id      String

  entity_type String // 'list_item', 'task', 'comment', 'evidence', 'email', 'member', etc.
  entity_id   String
  action      String // 'created', 'updated', 'deleted', 'status_changed', etc.

  old_value Json?
  new_value Json?

  created_at DateTime @default(now())

  workspace Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [user_id], references: [id])

  @@index([workspace_id, created_at])
  @@index([entity_type, entity_id])
  @@index([user_id])
  @@map("activity_logs")
}
```

**Activity Log API Endpoint:**

```typescript
// app/api/workspace/activity-log/route.ts
import { NextResponse } from 'next/server'
import { getWorkspaceContext } from '@/lib/auth/workspace-context'
import { requirePermission } from '@/lib/api/require-permission'
import { prisma } from '@/lib/prisma'

export async function GET(request: Request) {
  const denied = await requirePermission('activity:view')
  if (denied) return denied

  const context = await getWorkspaceContext()

  // Enterprise tier gate
  const workspace = await prisma.workspace.findUnique({
    where: { id: context.workspaceId },
    select: { subscription_tier: true },
  })
  if (workspace?.subscription_tier !== 'ENTERPRISE') {
    return NextResponse.json(
      { error: 'Enterprise-funktion', message: 'Aktivitetslogg kraver Enterprise-plan.' },
      { status: 403 }
    )
  }

  const { searchParams } = new URL(request.url)
  const userId = searchParams.get('userId')
  const entityType = searchParams.get('entityType')
  const action = searchParams.get('action')
  const startDate = searchParams.get('startDate')
  const endDate = searchParams.get('endDate')
  const cursor = searchParams.get('cursor')
  const limit = 50

  const where: any = { workspace_id: context.workspaceId }
  if (userId) where.user_id = userId
  if (entityType) where.entity_type = entityType
  if (action) where.action = action
  if (startDate || endDate) {
    where.created_at = {}
    if (startDate) where.created_at.gte = new Date(startDate)
    if (endDate) where.created_at.lte = new Date(endDate)
  }

  const activities = await prisma.activityLog.findMany({
    where,
    include: { user: { select: { email: true, name: true } } },
    orderBy: { created_at: 'desc' },
    take: limit + 1, // Fetch one extra to check if there are more
    ...(cursor ? { cursor: { id: cursor }, skip: 1 } : {}),
  })

  const hasMore = activities.length > limit
  const items = hasMore ? activities.slice(0, limit) : activities
  const nextCursor = hasMore ? items[items.length - 1].id : null

  return NextResponse.json({ activities: items, nextCursor })
}
```

**CSV Export Endpoint:**

```typescript
// app/api/workspace/activity-log/export/route.ts
export async function GET(request: Request) {
  const denied = await requirePermission('activity:view')
  if (denied) return denied

  const context = await getWorkspaceContext()

  // Enterprise tier gate (same as above)
  // ... build where clause from searchParams ...

  const activities = await prisma.activityLog.findMany({
    where,
    include: { user: { select: { email: true } } },
    orderBy: { created_at: 'desc' },
    take: 10000, // Hard cap for export
  })

  const csvHeader = 'Tidpunkt,Anvandare,Aktion,Entitetstyp,Entitets-ID'
  const csvRows = activities.map((a) =>
    [
      a.created_at.toISOString(),
      `"${a.user.email}"`,
      a.action,
      a.entity_type,
      a.entity_id,
    ].join(',')
  )
  const csv = [csvHeader, ...csvRows].join('\n')

  return new Response(csv, {
    headers: {
      'Content-Type': 'text/csv; charset=utf-8',
      'Content-Disposition': `attachment; filename="aktivitetslogg-${new Date().toISOString().slice(0, 10)}.csv"`,
    },
  })
}
```

**Retention Cleanup (Vercel Cron):**

```typescript
// app/api/cron/cleanup-activity-logs/route.ts
export const dynamic = 'force-dynamic'
export const maxDuration = 120

const CRON_SECRET = process.env.CRON_SECRET

export async function GET(request: Request) {
  const authHeader = request.headers.get('authorization')
  if (process.env.NODE_ENV !== 'development' && CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const twoYearsAgo = new Date()
  twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2)

  const result = await prisma.activityLog.deleteMany({
    where: { created_at: { lt: twoYearsAgo } },
  })

  console.log(`[CLEANUP-ACTIVITY-LOGS] Deleted ${result.count} entries older than 2 years`)

  return NextResponse.json({ success: true, deleted: result.count })
}
```

Add to `vercel.json`:
```json
{ "path": "/api/cron/cleanup-activity-logs", "schedule": "0 4 1 * *" }
```

**Ensuring comprehensive logging:**

Audit existing API routes to ensure all key actions are logged via `prisma.activityLog.create()`. The email service already logs `notification_sent` actions. Key actions to verify coverage:

- `list_item` — created, updated, deleted, status_changed, compliance_status_changed
- `task` — created, updated, deleted, assigned, status_changed
- `member` — invited, joined, role_changed, removed
- `comment` — created, edited, deleted
- `file` — uploaded, deleted, linked
- `workspace` — settings_updated, paused, resumed

**Reference:** `prisma/schema.prisma` (ActivityLog model), `lib/auth/permissions.ts` (activity:view permission), `lib/email/email-service.ts` (existing activity logging on email send)

## Testing

**Unit Tests:**

- Filter query builder produces correct Prisma where clause
- CSV export generates valid CSV with correct headers
- Pagination cursor works correctly

**Integration Tests:**

- Non-Enterprise workspace gets 403
- MEMBER role without `activity:view` gets 403
- AUDITOR role with `activity:view` can access
- Filters (user, action, date range) return correct results
- Pagination returns correct page sizes
- CSV export includes all filtered results
- Retention cron deletes only entries older than 2 years

**Performance Tests:**

- Query 10,000 activity logs with filters (<500ms)
- CSV export of 10,000 entries (<3 seconds)

**Test File:** `tests/unit/api/workspace-activity-log.test.ts`

## Change Log

| Date       | Version | Description                                                      | Author     |
| ---------- | ------- | ---------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                           | Sarah (PO) |
| 2026-02-19 | 2.0     | Rewritten to use existing ActivityLog model, updated all patterns | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
