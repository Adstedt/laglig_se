# Story 5.11: Build Workspace Activity Log (Enterprise Feature)

## Status
Draft

## Story

**As an** Enterprise customer,
**I want** to see an audit trail of who did what,
**so that** I maintain compliance documentation.

## Acceptance Criteria

1. `workspace_activity_log` table: id, workspace_id, user_id, action, resource_type, resource_id, timestamp
2. Actions logged:
   - Law change reviewed
   - Employee added/edited/deleted
   - Team member invited/removed
   - Settings changed
   - File uploaded/deleted
3. Activity Log page (Enterprise tier only)
4. Filterable by: User, Action type, Date range
5. Exportable as CSV
6. Log retention: 2 years
7. Performance: Indexed for fast queries on large datasets

## Tasks / Subtasks

- [ ] Create workspace_activity_log table
- [ ] Implement activity logging helper
- [ ] Log actions across all relevant endpoints
- [ ] Build activity log UI page
- [ ] Add filters (user, action type, date range)
- [ ] Implement CSV export
- [ ] Add 2-year retention policy
- [ ] Test with large datasets (performance)

## Dev Notes

**Database Schema:**
```prisma
model WorkspaceActivityLog {
  id           String   @id @default(uuid())
  workspaceId  String
  userId       String
  action       String   // law_reviewed, employee_added, member_invited, etc.
  resourceType String?  // law, employee, member, setting, file
  resourceId   String?
  metadata     Json?    // Additional context
  timestamp    DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId, timestamp])
  @@index([workspaceId, userId, timestamp])
  @@index([workspaceId, action, timestamp])
  @@map("workspace_activity_log")
}
```

**Activity Logging Helper:**
```typescript
// lib/activity/log.ts

export enum ActivityAction {
  // Laws
  LAW_REVIEWED = 'law_reviewed',
  LAW_ADDED = 'law_added',
  LAW_REMOVED = 'law_removed',
  LAW_STATUS_CHANGED = 'law_status_changed',

  // Employees
  EMPLOYEE_ADDED = 'employee_added',
  EMPLOYEE_UPDATED = 'employee_updated',
  EMPLOYEE_DELETED = 'employee_deleted',

  // Team
  MEMBER_INVITED = 'member_invited',
  MEMBER_JOINED = 'member_joined',
  MEMBER_ROLE_CHANGED = 'member_role_changed',
  MEMBER_REMOVED = 'member_removed',

  // Settings
  SETTINGS_UPDATED = 'settings_updated',
  LOGO_UPLOADED = 'logo_uploaded',

  // Files
  FILE_UPLOADED = 'file_uploaded',
  FILE_DELETED = 'file_deleted',

  // Billing
  SUBSCRIPTION_UPGRADED = 'subscription_upgraded',
  SUBSCRIPTION_DOWNGRADED = 'subscription_downgraded',
  SUBSCRIPTION_CANCELED = 'subscription_canceled',

  // Workspace
  WORKSPACE_PAUSED = 'workspace_paused',
  WORKSPACE_RESUMED = 'workspace_resumed',
  WORKSPACE_DELETED = 'workspace_deleted'
}

export async function logActivity({
  workspaceId,
  userId,
  action,
  resourceType,
  resourceId,
  metadata
}: {
  workspaceId: string
  userId: string
  action: ActivityAction
  resourceType?: string
  resourceId?: string
  metadata?: any
}) {
  await prisma.workspaceActivityLog.create({
    data: {
      workspaceId,
      userId,
      action,
      resourceType,
      resourceId,
      metadata
    }
  })
}
```

**Usage in API Routes:**
```typescript
// app/api/employees/route.ts (example)
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, userId }) => {
    const data = await request.json()

    const employee = await prisma.employee.create({
      data: {
        ...data,
        workspaceId
      }
    })

    // Log activity
    await logActivity({
      workspaceId,
      userId,
      action: ActivityAction.EMPLOYEE_ADDED,
      resourceType: 'employee',
      resourceId: employee.id,
      metadata: {
        employeeName: `${data.firstName} ${data.lastName}`
      }
    })

    return NextResponse.json(employee)
  })
}
```

**Activity Log Page:**
```typescript
// app/activity-log/page.tsx
'use client'

import { useState, useEffect } from 'react'
import { useWorkspace } from '@/hooks/use-workspace'

export default function ActivityLogPage() {
  const { workspace } = useWorkspace()
  const [activities, setActivities] = useState<any[]>([])
  const [filters, setFilters] = useState({
    userId: '',
    action: '',
    startDate: '',
    endDate: ''
  })
  const [isLoading, setIsLoading] = useState(true)

  // Block non-Enterprise workspaces
  if (workspace?.subscriptionTier !== 'enterprise') {
    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
          <h1 className="text-2xl font-bold mb-2">Enterprise Feature</h1>
          <p className="text-gray-700 mb-4">
            Activity Log is only available for Enterprise workspaces.
          </p>
          <button
            onClick={() => (window.location.href = '/billing/upgrade')}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Upgrade to Enterprise
          </button>
        </div>
      </div>
    )
  }

  useEffect(() => {
    fetchActivities()
  }, [filters])

  async function fetchActivities() {
    setIsLoading(true)

    const params = new URLSearchParams()
    if (filters.userId) params.append('userId', filters.userId)
    if (filters.action) params.append('action', filters.action)
    if (filters.startDate) params.append('startDate', filters.startDate)
    if (filters.endDate) params.append('endDate', filters.endDate)

    const response = await fetch(`/api/activity-log?${params}`)
    const data = await response.json()
    setActivities(data.activities)
    setIsLoading(false)
  }

  async function exportCSV() {
    const params = new URLSearchParams()
    if (filters.userId) params.append('userId', filters.userId)
    if (filters.action) params.append('action', filters.action)
    if (filters.startDate) params.append('startDate', filters.startDate)
    if (filters.endDate) params.append('endDate', filters.endDate)

    window.location.href = `/api/activity-log/export?${params}`
  }

  return (
    <div className="max-w-6xl mx-auto p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Activity Log</h1>
        <button
          onClick={exportCSV}
          className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          Export CSV
        </button>
      </div>

      {/* Filters */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-medium mb-2">User</label>
            <select
              value={filters.userId}
              onChange={(e) => setFilters({ ...filters, userId: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            >
              <option value="">All Users</option>
              {/* Populate with workspace members */}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">Action Type</label>
            <select
              value={filters.action}
              onChange={(e) => setFilters({ ...filters, action: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            >
              <option value="">All Actions</option>
              <option value="law_reviewed">Law Reviewed</option>
              <option value="employee_added">Employee Added</option>
              <option value="member_invited">Member Invited</option>
              <option value="settings_updated">Settings Updated</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">Start Date</label>
            <input
              type="date"
              value={filters.startDate}
              onChange={(e) => setFilters({ ...filters, startDate: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">End Date</label>
            <input
              type="date"
              value={filters.endDate}
              onChange={(e) => setFilters({ ...filters, endDate: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            />
          </div>
        </div>
      </div>

      {/* Activity List */}
      <div className="bg-white rounded-lg shadow">
        {isLoading ? (
          <div className="p-6 text-center">Loading...</div>
        ) : activities.length === 0 ? (
          <div className="p-6 text-center text-gray-600">No activities found</div>
        ) : (
          <div className="divide-y">
            {activities.map((activity) => (
              <ActivityRow key={activity.id} activity={activity} />
            ))}
          </div>
        )}
      </div>
    </div>
  )
}

function ActivityRow({ activity }: { activity: any }) {
  return (
    <div className="p-4 hover:bg-gray-50">
      <div className="flex items-start justify-between">
        <div className="flex items-start gap-3">
          <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
            <span className="text-blue-600 text-sm font-semibold">
              {activity.user.email[0].toUpperCase()}
            </span>
          </div>
          <div>
            <p className="text-sm">
              <span className="font-medium">{activity.user.email}</span>
              {' '}
              <span className="text-gray-600">{getActionDescription(activity)}</span>
            </p>
            <p className="text-xs text-gray-500 mt-1">
              {new Date(activity.timestamp).toLocaleString()}
            </p>
          </div>
        </div>
        <span className="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
          {activity.action.replace(/_/g, ' ')}
        </span>
      </div>
    </div>
  )
}

function getActionDescription(activity: any): string {
  switch (activity.action) {
    case 'law_reviewed':
      return `reviewed law "${activity.metadata?.lawTitle}"`
    case 'employee_added':
      return `added employee "${activity.metadata?.employeeName}"`
    case 'member_invited':
      return `invited ${activity.metadata?.inviteeEmail} as ${activity.metadata?.role}`
    case 'settings_updated':
      return 'updated workspace settings'
    default:
      return activity.action.replace(/_/g, ' ')
  }
}
```

**Activity Log API:**
```typescript
// app/api/activity-log/route.ts
export async function GET(request: Request) {
  return withWorkspace(async ({ workspaceId, workspace }) => {
    // Enterprise only
    if (workspace.subscriptionTier !== 'enterprise') {
      return NextResponse.json(
        { error: 'Enterprise feature only' },
        { status: 403 }
      )
    }

    const { searchParams } = new URL(request.url)
    const userId = searchParams.get('userId')
    const action = searchParams.get('action')
    const startDate = searchParams.get('startDate')
    const endDate = searchParams.get('endDate')

    const where: any = { workspaceId }

    if (userId) where.userId = userId
    if (action) where.action = action
    if (startDate || endDate) {
      where.timestamp = {}
      if (startDate) where.timestamp.gte = new Date(startDate)
      if (endDate) where.timestamp.lte = new Date(endDate)
    }

    const activities = await prisma.workspaceActivityLog.findMany({
      where,
      include: {
        user: {
          select: {
            email: true
          }
        }
      },
      orderBy: { timestamp: 'desc' },
      take: 100 // Limit for performance
    })

    return NextResponse.json({ activities })
  })
}
```

**CSV Export API:**
```typescript
// app/api/activity-log/export/route.ts
export async function GET(request: Request) {
  return withWorkspace(async ({ workspaceId, workspace }) => {
    if (workspace.subscriptionTier !== 'enterprise') {
      return NextResponse.json({ error: 'Enterprise only' }, { status: 403 })
    }

    const { searchParams } = new URL(request.url)
    // ... build where clause same as above

    const activities = await prisma.workspaceActivityLog.findMany({
      where,
      include: { user: true },
      orderBy: { timestamp: 'desc' }
    })

    // Generate CSV
    const csv = [
      ['Timestamp', 'User', 'Action', 'Resource Type', 'Resource ID', 'Metadata'].join(','),
      ...activities.map((a) => [
        a.timestamp.toISOString(),
        a.user.email,
        a.action,
        a.resourceType || '',
        a.resourceId || '',
        JSON.stringify(a.metadata || {})
      ].join(','))
    ].join('\n')

    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="activity-log-${Date.now()}.csv"`
      }
    })
  })
}
```

**Retention Policy Cron:**
```typescript
// lib/cron/cleanup-old-activity-logs.ts
export function scheduleActivityLogCleanup() {
  // Run monthly
  cron.schedule('0 4 1 * *', async () => {
    const twoYearsAgo = new Date()
    twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2)

    const deleted = await prisma.workspaceActivityLog.deleteMany({
      where: {
        timestamp: {
          lt: twoYearsAgo
        }
      }
    })

    console.log(`Deleted ${deleted.count} activity logs older than 2 years`)
  })
}
```

**Reference:** PRD Epic 5 Story 5.11, Architecture Section 19 (Monitoring)

## Testing

**Unit Tests:**
- `logActivity()` creates log entry
- CSV export generates correct format
- Filters work correctly

**Integration Tests:**
- Perform action, verify logged
- Filter by user, verify correct results
- Filter by action type, verify correct results
- Export CSV, verify all activities included
- Non-Enterprise workspace blocked from access

**Manual Testing:**
- Perform various actions (add employee, invite member, etc.)
- Verify all actions logged
- Test filters (user, action, date range)
- Export CSV, verify correct data
- Test as non-Enterprise workspace (should block)

**Performance Testing:**
- Query 10,000 activity logs (<500ms)
- Export 10,000 logs to CSV (<3 seconds)

**Test File:** `__tests__/features/activity/activity-log.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**
- (Enterprise only) Review activity logs for compliance
- Export logs as needed for audits
- Filter by user/action to investigate specific events

**Developer Responsibility:**
- Log all relevant actions across the application
- Provide fast, indexed queries for large datasets
- Implement CSV export
- Enforce 2-year retention policy
- Block non-Enterprise workspaces from access

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
