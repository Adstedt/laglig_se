# Story 2.9: Build SNI Code Discovery & Customer Classification System

## Status

Draft

## Story

**As a** visitor or customer,
**I want** to enter my org-number and have the system automatically discover my SNI code(s) and business classification,
**so that** I receive a personalized, accurate law list without manual industry selection.

## Background & Strategic Context

This story establishes the **SNI Discovery System** - a foundational capability that powers personalized law-list generation throughout the product. The system:

1. **Fetches company data from Bolagsverket** via org-number (story 4.2 dependency)
2. **Classifies customers** using SNI 2025 hierarchical codes (22 sections, 5 levels deep)
3. **Maps SNI codes to curated law lists** (industry starter packs + contextual tweaks)
4. **Enables smart suggestions** as the product learns which laws matter for which SNI combinations

### SNI 2025 Update (December 2025)

Sweden transitioned from SNI 2007 to **SNI 2025** in December 2025. Key changes:

- **1,882 total SNI codes** (up from ~1,600 in SNI 2007)
- **22 top-level sections** (A-V) covering all economic activities
- **5-level hierarchy**: Section → Huvudgrupp → Grupp → Undergrupp → Detaljgrupp
- SCB automatically migrates companies who don't update by Nov 21, 2025
- Reference data: `data/sni-2025-struktur.json` (Swedish + English titles)

### SNI 2025 Top-Level Sections

| Code | Swedish Title                                      | English Title                         |
| ---- | -------------------------------------------------- | ------------------------------------- |
| A    | Jordbruk, skogsbruk och fiske                      | Agriculture, forestry and fishing     |
| B    | Utvinning av mineral                               | Mining and quarrying                  |
| C    | Tillverkning                                       | Manufacturing                         |
| D    | Försörjning av el, gas, värme och kyla             | Electricity, gas, steam supply        |
| E    | Vattenförsörjning; avloppsrening, avfallshantering | Water supply; sewerage, waste         |
| F    | Byggverksamhet                                     | Construction                          |
| G    | Handel                                             | Wholesale and retail trade            |
| H    | Transport och magasinering                         | Transportation and storage            |
| I    | Hotell- och restaurangverksamhet                   | Accommodation and food service        |
| J    | Förlagsverksamhet, radio- och TV                   | Publishing, broadcasting, media       |
| K    | Telekommunikation, dataprogrammering               | Telecommunications, IT services       |
| L    | Finansiell verksamhet och försäkring               | Financial and insurance activities    |
| M    | Fastighetsverksamhet                               | Real estate activities                |
| N    | Juridik, ekonomi, vetenskap och teknik             | Professional, scientific, technical   |
| O    | Uthyrning, fastighetsservice, resetjänster         | Administrative and support services   |
| P    | Offentlig förvaltning och försvar                  | Public administration and defence     |
| Q    | Utbildning                                         | Education                             |
| R    | Vård och omsorg; social verksamhet                 | Human health and social work          |
| S    | Kultur, idrott och fritid                          | Arts, entertainment, recreation       |
| T    | Annan serviceverksamhet                            | Other service activities              |
| U    | Förvärvsarbete i hushåll                           | Activities of households as employers |
| V    | Internationella organisationer                     | Extraterritorial organizations        |

## Acceptance Criteria

### SNI Discovery & Classification

1. System stores SNI 2025 reference data (1,882 codes with full hierarchy)
2. SNI lookup API: `GET /api/sni/{code}` returns full hierarchy path + titles (SV/EN)
3. SNI search API: `GET /api/sni/search?q={term}` returns matching codes with relevance scoring
4. Support for multiple SNI codes per company (primary + secondary activities)
5. SNI code validation (format: XX.XXX for detaljgrupp, accepts partial codes)

### Bolagsverket Integration (depends on Story 4.2)

6. Fetch SNI code(s) from Bolagsverket response for org-number lookup
7. Handle SNI 2007 → SNI 2025 migration (map legacy codes if Bolagsverket returns old format)
8. Fallback: Manual SNI selection if Bolagsverket unavailable or SNI missing

### Customer Classification & Labeling

9. Database stores customer SNI codes in `customer_profiles.sni_codes` (JSONB array)
10. Hierarchical classification: Store both specific code (56.101) AND parent categories (56.1, 56, I)
11. Customer labels derived from SNI: `["restaurang", "serveringstillstånd", "livsmedel"]`
12. Labels stored for fast filtering and law-list matching

### Law List Mapping

13. SNI → Law List mapping table: `sni_law_mappings` with `sni_code`, `law_id`, `relevance_score`
14. Industry starter packs (15 initially) mapped to SNI ranges
15. "Base laws" that apply to ALL businesses (arbetsmiljö, GDPR, bokföring, etc.)
16. "Conditional laws" triggered by specific SNI + contextual answers

### Discovery UI (Visitor-Facing)

17. SNI discovery page: `/upptack-lagar/bransch`
18. SNI code input field with autocomplete (search by code OR description)
19. Visual hierarchy browser: Click through sections → grupper → detaljgrupper
20. Industry starter pack cards for common sectors (visual selection alternative)
21. Each pack shows: law count, key categories, "Generera min lista" CTA
22. Mobile-responsive with tab navigation

### Analytics & Learning

23. Track SNI → law list conversions (which SNI codes lead to signups)
24. Track law removals by SNI (learn which auto-suggested laws are irrelevant)
25. Track law additions by SNI (learn which laws are commonly added manually)
26. Feed learnings back into starter pack curation (quarterly review)

## Tasks / Subtasks

- [ ] **SNI 2025 Data Integration** (AC: 1-5)
  - [ ] Create Prisma model for SNI codes with hierarchy
  - [ ] Seed database from `data/sni-2025-struktur.json`
  - [ ] Build SNI lookup API endpoint
  - [ ] Build SNI search API with relevance scoring
  - [ ] Add SNI code validation utilities

- [ ] **Customer Classification System** (AC: 9-12)
  - [ ] Extend `customer_profiles` schema with `sni_codes` JSONB
  - [ ] Create SNI → label derivation logic
  - [ ] Build hierarchical classification storage
  - [ ] Create customer labeling service

- [ ] **Law List Mapping** (AC: 13-16)
  - [ ] Create `sni_law_mappings` table
  - [ ] Design base law set (applies to all)
  - [ ] Create 15 industry starter packs with SNI ranges
  - [ ] Build law suggestion engine based on SNI + context

- [ ] **Discovery UI** (AC: 17-22)
  - [ ] Create discovery page route and layout
  - [ ] Build SNI autocomplete search component
  - [ ] Build visual hierarchy browser
  - [ ] Create industry starter pack cards
  - [ ] Implement responsive design

- [ ] **Analytics** (AC: 23-26)
  - [ ] Track SNI → conversion events
  - [ ] Track law add/remove by SNI
  - [ ] Create analytics dashboard for SNI insights

## Dev Notes

### Data Sources

- **SNI 2025 Reference**: `data/sni-2025-struktur.json` (1,882 entries)
- **Bolagsverket API**: `https://bolagsverket.se/apierochoppnadata/apiforatthamtaforetagsinformation.3988.html`
- **SCB SNI Search**: `https://snisok.scb.se/` (for reference/validation)
- **SNI 2025 Official**: `https://www.scb.se/dokumentation/klassifikationer-och-standarder/standard-for-svensk-naringsgrensindelning-sni/sni-2025/`

### Related Stories

| Story | Dependency Type | Description                                 |
| ----- | --------------- | ------------------------------------------- |
| 4.2   | Upstream        | Bolagsverket API provides SNI codes         |
| 4.2b  | Downstream      | Contextual questions triggered by SNI       |
| 4.3   | Downstream      | Law list generation uses SNI classification |
| 4.4   | Downstream      | Streaming UI displays SNI-based suggestions |

### SNI Code Structure

```
Level 1: Section (letter)     → A (Jordbruk...)
Level 2: Huvudgrupp (2 digits) → 01 (Jordbruk och jakt)
Level 3: Grupp (XX.X)         → 01.1 (Odling av ettåriga)
Level 4: Undergrupp (XX.XX)   → 01.11 (Odling av spannmål)
Level 5: Detaljgrupp (XX.XXX) → 01.110 (Odling av spannmål)
```

### Industry Starter Packs (Initial 15)

Based on Notisum analysis and common Swedish SMB sectors:

1. **Restaurang & Café** (SNI 56.1x) - alkoholservering, livsmedel, arbetsmiljö
2. **Bygg & Entreprenad** (SNI 41-43) - arbetsmiljö höjd, farliga ämnen
3. **E-handel** (SNI 47.91) - konsumentköp, GDPR, marknadsföring
4. **IT & Konsult** (SNI 62.x, 63.x) - GDPR, informationssäkerhet
5. **Vård & Omsorg** (SNI 86-88) - patientdata, hälso- och sjukvård
6. **Transport & Logistik** (SNI 49-53) - kör- och vilotider, ADR
7. **Tillverkning** (SNI 10-33) - produktsäkerhet, CE-märkning
8. **Fastighet** (SNI 68.x) - hyresrätt, bostadsrätt
9. **Utbildning** (SNI 85.x) - skollag, diskriminering
10. **Handel & Butik** (SNI 47.x) - konsumentköp, prismärkning
11. **Hotell & Boende** (SNI 55.x) - brandsäkerhet, tillgänglighet
12. **Friskvård & Gym** (SNI 93.13) - personuppgifter, säkerhet
13. **Ekonomi & Redovisning** (SNI 69.2) - bokföringsbrott, penningtvätt
14. **Juridik** (SNI 69.1) - advokatsekretess, rättegång
15. **Generell SMB** (fallback) - arbetsmiljö, GDPR, bokföring

### Suggested Database Schema

```prisma
model SniCode {
  id          String   @id @default(cuid())
  code        String   @unique // "01.110", "56.101"
  level       Int      // 1-5
  section     String?  // "A", "B", etc.
  titleSv     String
  titleEn     String
  parentCode  String?  // Reference to parent (e.g., "01.11" → "01.1")

  // Relations
  lawMappings SniLawMapping[]

  @@index([level])
  @@index([section])
  @@index([parentCode])
}

model SniLawMapping {
  id             String   @id @default(cuid())
  sniCode        String
  lawId          String
  relevanceScore Float    @default(1.0) // 0.0-1.0, higher = more relevant
  isRequired     Boolean  @default(false) // True = always include
  triggerContext String?  // JSON conditions for conditional laws

  sni SniCode @relation(fields: [sniCode], references: [code])
  law Law     @relation(fields: [lawId], references: [id])

  @@unique([sniCode, lawId])
  @@index([sniCode])
  @@index([lawId])
}

model CustomerProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  orgNumber    String?
  companyName  String?

  // SNI Classification
  sniCodes     Json     // ["56.101", "56.301"] - all SNI codes
  primarySni   String?  // Main business activity
  sniHierarchy Json     // ["I", "56", "56.1", "56.10", "56.101"] - full path
  labels       String[] // Derived labels: ["restaurang", "alkohol", "livsmedel"]

  // Contextual answers from onboarding
  contextAnswers Json?  // From story 4.2b

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([primarySni])
  @@index([labels])
}
```

### Testing

**Test Location**: `tests/unit/services/sni/` and `tests/integration/api/sni/`

**Test Scenarios**:

- SNI lookup returns correct hierarchy for all 5 levels
- SNI search returns relevant results (fuzzy matching on Swedish/English)
- SNI validation accepts valid formats, rejects invalid
- Law mapping returns correct starter pack for SNI ranges
- Customer classification stores full hierarchy
- Analytics events fire correctly

**Test Data**: Use 10 real company org-numbers from different industries to validate end-to-end flow.

## Change Log

| Date       | Version | Description                                                                         | Author     |
| ---------- | ------- | ----------------------------------------------------------------------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation                                                              | Sarah (PO) |
| 2025-12-16 | 2.0     | Expanded with SNI 2025 data, customer classification, law mapping, and full context | Bob (SM)   |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
