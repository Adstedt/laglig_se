# Story 2.6: Implement Hierarchical Content Categorization

## Status

Approved

## Story

**As a** visitor,
**I want** to browse legal content by structured categories with subcategories,
**so that** I can quickly find relevant laws, court cases, and EU regulations for my specific needs.

## Acceptance Criteria

1. 13 top-level categories defined with Swedish-language display names and URL-friendly slugs
2. Each top-level category has 3-6 subcategories (total ~50 subcategories)
3. Category taxonomy stored in `Category` table with parent-child relationships
4. AI categorization uses Haiku/Sonnet for cost-effective classification of 88K+ documents
5. Multi-label support: Each document can have 1 primary category + up to 2 secondary categories
6. Category pages created: `/kategorier/[category]` (overview) and `/kategorier/[category]/[subcategory]` (filtered)
7. Content type tabs on category pages: Lagar | Rattsfall | EU
8. Document counts shown per category/subcategory/type
9. Category pages SEO-optimized with meta tags and JSON-LD BreadcrumbList
10. Verification: Sample run (500 docs) demonstrates >95% categorization success rate
11. Manual review of 50 sample categorizations shows >90% accuracy (full 88K run is post-story)
12. Category filter component for use on listing pages

## Tasks / Subtasks

- [ ] **Task 1: Define Category Taxonomy & Schema Migration** (AC: 1, 2, 3)
  - [ ] Create `lib/categorization/taxonomy.ts` with full category definitions
  - [ ] Add `Category` model to Prisma schema with parent-child support
  - [ ] Create database migration for Category table
  - [ ] **Migration Strategy for DocumentSubject:**
    - [ ] Check if any existing DocumentSubject records exist (query count)
    - [ ] If records exist: Create migration that adds new columns (`category_id`, `is_primary`) as nullable first
    - [ ] If records exist: Run data migration script to map old `subject_code` to new `category_id`
    - [ ] If records exist: Then alter columns to be non-nullable and drop old columns
    - [ ] If no records: Simply replace the model definition (breaking change OK)
  - [ ] Create seed script `scripts/seed-categories.ts`
  - [ ] Update `DocumentSubject` to reference Category (add `category_id` FK, `is_primary` boolean)

- [ ] **Task 2: Build AI Categorization Script** (AC: 4, 5)
  - [ ] Create `scripts/categorize-documents.ts`
  - [ ] Implement content-type-specific prompts:
    - SFS: title + first 500 chars of full_text
    - Court cases: title + summary + court_name
    - EU: title + celex_number pattern + first 500 chars
  - [ ] Use Claude Haiku for bulk categorization (~$0.001/doc)
  - [ ] Batch processing with rate limiting (50 concurrent)
  - [ ] Store primary + secondary categories in DocumentSubject
  - [ ] Add progress logging and checkpoint/resume support

- [ ] **Task 3: Create Category Pages** (AC: 6, 7, 8, 9)
  - [ ] Create `app/(public)/kategorier/page.tsx` (all categories overview)
  - [ ] Create `app/(public)/kategorier/loading.tsx` (loading skeleton)
  - [ ] Create `app/(public)/kategorier/error.tsx` (error boundary)
  - [ ] Create `app/(public)/kategorier/[category]/page.tsx` (category landing)
  - [ ] Create `app/(public)/kategorier/[category]/loading.tsx` (loading skeleton)
  - [ ] Create `app/(public)/kategorier/[category]/error.tsx` (error boundary)
  - [ ] Create `app/(public)/kategorier/[category]/[subcategory]/page.tsx` (filtered)
  - [ ] Create `app/(public)/kategorier/[category]/[subcategory]/loading.tsx` (loading skeleton)
  - [ ] Create `app/(public)/kategorier/[category]/[subcategory]/error.tsx` (error boundary)
  - [ ] Implement content type tabs (Lagar/Rattsfall/EU) with URL params
  - [ ] Add document counts per type
  - [ ] **Add pagination** with cursor-based "Load more" (initial 50, load 50 more)
  - [ ] SEO: generateMetadata, JSON-LD BreadcrumbList
  - [ ] ISR with 1-hour revalidation
  - [ ] Update `app/sitemap.ts` to include `/kategorier/*` routes

- [ ] **Task 4: Create Category Filter Component** (AC: 12)
  - [ ] Create `components/features/categorization/category-filter.tsx`
  - [ ] Two-level dropdown: category → subcategory using shadcn/ui Select
  - [ ] URL-based state persistence (?kategori=arbetsliv-socialt&underkategori=arbetsratt)
  - [ ] **Integration with listing pages (scope limited):**
    - [ ] Add optional `categoryFilter` prop to existing page components
    - [ ] Modify `/lagar/page.tsx`: Add CategoryFilter component above list, filter query by category
    - [ ] Modify `/rattsfall/page.tsx`: Add CategoryFilter component above list, filter query by category
    - [ ] Modify `/eu/page.tsx`: Add CategoryFilter component above list, filter query by category
    - [ ] Note: Full integration tested via E2E, but filter is additive (pages work without filter)

- [ ] **Task 5: Test Categorization Quality (Sample Run)** (AC: 10, 11)
  - [ ] Run categorization script on **500 document sample** (mixed: ~200 SFS, ~200 court cases, ~100 EU)
  - [ ] Create verification script `scripts/verify-categorization.ts`
  - [ ] Manually review 50 random categorizations from sample
  - [ ] Identify and fix prompt issues based on review
  - [ ] Re-run on sample if accuracy <90%, iterate until satisfactory
  - [ ] Document accuracy results and any prompt tweaks in Dev Agent Record
  - [ ] **Note:** Full 88K document run is a post-story task after quality is validated

- [ ] **Task 6: Create E2E Tests** (AC: All)
  - [ ] Create `tests/e2e/pages/category-pages.spec.ts`
  - [ ] Test category overview page
  - [ ] Test category landing with type tabs
  - [ ] Test subcategory filtering
  - [ ] Test meta tags and breadcrumbs
  - [ ] Test category filter component

## Dev Notes

### Full Category Taxonomy (13 Categories)

[Source: User-provided taxonomy document, aligned with Swedish legal practice]

```typescript
// lib/categorization/taxonomy.ts

export interface CategoryDefinition {
  code: string // URL slug: "arbetsliv-socialt"
  name: string // Swedish display: "Arbetsliv & Socialt skydd"
  description: string // Full description for SEO
  subcategories: SubcategoryDefinition[]
}

export interface SubcategoryDefinition {
  code: string // "arbetsratt"
  name: string // "Arbetsratt"
  keywords: string[] // AI prompt keywords
}

export const CATEGORY_TAXONOMY: CategoryDefinition[] = [
  {
    code: 'arbetsliv-socialt',
    name: 'Arbetsliv & Socialt skydd',
    description: 'Arbetsratt, socialforsakring, migration och arbetsmiljo',
    subcategories: [
      {
        code: 'arbetsratt',
        name: 'Arbetsratt',
        keywords: [
          'anstallning',
          'uppsagning',
          'diskriminering',
          'arbetsmiljo',
          'fackliga',
          'kollektivavtal',
        ],
      },
      {
        code: 'socialforsakring',
        name: 'Socialforsakring',
        keywords: ['sjukpenning', 'foraldraforsakring', 'pension', 'a-kassa'],
      },
      {
        code: 'migration-arbete',
        name: 'Migration & arbetskraftsinvandring',
        keywords: ['arbetstillstand', 'uppehallstillstand', 'migration'],
      },
      {
        code: 'utbildning-arbetsliv',
        name: 'Utbildningsratt (arbetsliv)',
        keywords: ['yrkesutbildning', 'praktik', 'laringsjobb'],
      },
    ],
  },
  {
    code: 'foretagande-avtal',
    name: 'Foretagande, Agande & Avtal',
    description: 'Bolagsratt, avtalsratt och affarsverksamhet',
    subcategories: [
      {
        code: 'bolagsratt',
        name: 'Bolagsratt',
        keywords: [
          'aktiebolag',
          'forening',
          'stiftelse',
          'styrelse',
          'bolagsstamma',
        ],
      },
      {
        code: 'avtalsratt',
        name: 'Avtalsratt & kommersiell ratt',
        keywords: ['kop', 'tjanster', 'avtal', 'skadestand'],
      },
      {
        code: 'obestandsratt',
        name: 'Obestandsratt',
        keywords: ['konkurs', 'rekonstruktion', 'ackordering'],
      },
      {
        code: 'corporate-governance',
        name: 'Corporate governance',
        keywords: ['rapportering', 'hallbarhet', 'agarstyrning'],
      },
    ],
  },
  {
    code: 'skatt-ekonomi',
    name: 'Skatt, Ekonomi & Offentlig finans',
    description: 'Skatteratt, redovisning och offentlig ekonomi',
    subcategories: [
      {
        code: 'skatteratt',
        name: 'Skatteratt',
        keywords: ['inkomstskatt', 'moms', 'arbetsgivaravgift', 'punktskatt'],
      },
      {
        code: 'redovisning',
        name: 'Redovisning & bokforing',
        keywords: ['arsredovisning', 'revision', 'k2', 'k3'],
      },
      {
        code: 'tull-handel',
        name: 'Tull & handelsskatter',
        keywords: ['tull', 'import', 'export', 'ursprung'],
      },
      {
        code: 'offentlig-finans',
        name: 'Offentlig finansforvaltning',
        keywords: ['kommunalekonomi', 'statsbudget'],
      },
    ],
  },
  {
    code: 'dataskydd-digitalisering',
    name: 'Dataskydd, Digitalisering & Informationsratt',
    description: 'GDPR, cybersakerhet, AI och digital lagstiftning',
    subcategories: [
      {
        code: 'dataskydd',
        name: 'Dataskydd & integritet',
        keywords: ['gdpr', 'personuppgift', 'kamerabevakning', 'cookies'],
      },
      {
        code: 'cybersakerhet',
        name: 'Cybersakerhet & NIS',
        keywords: ['nis', 'incident', 'informationssakerhet'],
      },
      {
        code: 'e-handel-plattform',
        name: 'E-handel & digitala plattformar',
        keywords: ['dsa', 'dma', 'plattform', 'marknadsplats'],
      },
      {
        code: 'ai-automatisering',
        name: 'AI & automatisering',
        keywords: [
          'ai-forordning',
          'algoritm',
          'automatiserat beslutsfattande',
        ],
      },
      {
        code: 'telekom',
        name: 'Telekom & elektronisk kommunikation',
        keywords: ['lagen om elektronisk kommunikation', 'pts'],
      },
    ],
  },
  {
    code: 'marknad-konsument',
    name: 'Marknad, Konsument & Konkurrens',
    description: 'Konsumentratt, marknadsforing och konkurrenslagstiftning',
    subcategories: [
      {
        code: 'konsumentskydd',
        name: 'Konsumentskydd',
        keywords: ['konsumentkop', 'distansavtal', 'angerratt', 'garanti'],
      },
      {
        code: 'marknadsforing',
        name: 'Marknadsforingsratt',
        keywords: ['reklam', 'vilseledande', 'prissattning'],
      },
      {
        code: 'konkurrensratt',
        name: 'Konkurrensratt',
        keywords: ['missbruk', 'kartell', 'foretagskoncentration'],
      },
      {
        code: 'produktinfo',
        name: 'Produktinformation & markning',
        keywords: ['markning', 'ursprung', 'innehallsforteckning'],
      },
    ],
  },
  {
    code: 'immaterialratt-media',
    name: 'Immaterialratt, Media & Kultur',
    description: 'Patent, varumarke, upphovsratt och medieratt',
    subcategories: [
      {
        code: 'varumarke',
        name: 'Varumarkesratt',
        keywords: ['varumarke', 'registrering', 'intrång'],
      },
      {
        code: 'upphovsratt',
        name: 'Upphovsratt',
        keywords: ['upphovsratt', 'licens', 'kopiering'],
      },
      {
        code: 'patent-design',
        name: 'Patent & design',
        keywords: ['patent', 'design', 'monsterskydd', 'uppfinning'],
      },
      {
        code: 'medieratt',
        name: 'Medieratt',
        keywords: [
          'publicering',
          'tryckfrihet',
          'yttrandefrihet',
          'ansvarig utgivare',
        ],
      },
    ],
  },
  {
    code: 'miljo-fastigheter',
    name: 'Miljo, Planering & Fastigheter',
    description: 'Miljoratt, plan- och byggratt, fastighetsratt',
    subcategories: [
      {
        code: 'miljoratt',
        name: 'Miljoratt',
        keywords: ['utslapp', 'avfall', 'kemikalier', 'miljotillstand'],
      },
      {
        code: 'plan-bygg',
        name: 'Plan- och byggratt',
        keywords: ['bygglov', 'detaljplan', 'byggnorm', 'oversiktsplan'],
      },
      {
        code: 'fastighetsratt',
        name: 'Fastighetsratt',
        keywords: ['hyra', 'arrende', 'fastighetskop', 'nyttjanderatt'],
      },
      {
        code: 'energi-klimat',
        name: 'Energi & klimat',
        keywords: ['ellag', 'fornybar', 'utslapphandel', 'klimat'],
      },
      {
        code: 'naturresurser',
        name: 'Naturresurser',
        keywords: ['vatten', 'skog', 'gruva', 'fiske'],
      },
    ],
  },
  {
    code: 'halsa-livsmedel',
    name: 'Halsa, Vard, Livsmedel & Produktsakerhet',
    description: 'Livsmedelsratt, halsovard, lakemedel och produktsakerhet',
    subcategories: [
      {
        code: 'livsmedel',
        name: 'Livsmedelsratt',
        keywords: ['hygien', 'markning', 'sparbarhet', 'haccp'],
      },
      {
        code: 'halso-sjukvard',
        name: 'Halso- och sjukvardsratt',
        keywords: ['patient', 'vardgivare', 'journalforing'],
      },
      {
        code: 'lakemedel',
        name: 'Lakemedel & medicinteknik',
        keywords: ['lakemedel', 'medicinteknisk', 'apotekstillstand'],
      },
      {
        code: 'produktsakerhet',
        name: 'Produktsakerhet',
        keywords: ['ce-markning', 'recall', 'sakerhetsstandard'],
      },
    ],
  },
  {
    code: 'transport-logistik',
    name: 'Transport, Infrastruktur & Logistik',
    description: 'Transportratt, farligt gods och trafiksakerhet',
    subcategories: [
      {
        code: 'transport',
        name: 'Transportregler',
        keywords: ['vag', 'sjo', 'luft', 'jarnvag', 'transport'],
      },
      {
        code: 'yrkestrafik',
        name: 'Yrkesmassig trafik',
        keywords: ['yrkestrafiktillstand', 'taxitrafik', 'godstransport'],
      },
      {
        code: 'farligt-gods',
        name: 'Farligt gods',
        keywords: ['adr', 'imdg', 'farligt gods', 'transport av farligt'],
      },
      {
        code: 'trafiksakerhet',
        name: 'Trafiksakerhet & fordon',
        keywords: ['korkort', 'fordon', 'trafiksakerhet'],
      },
    ],
  },
  {
    code: 'finans-forsakring',
    name: 'Finans, Forsakring & Kapitalmarknad',
    description: 'Bankratt, forsakring, vardepapper och AML',
    subcategories: [
      {
        code: 'bank-betalning',
        name: 'Bank & betalningar',
        keywords: ['bank', 'betalning', 'betaltjanst', 'psd2'],
      },
      {
        code: 'kredit-konsumentfinans',
        name: 'Kredit & konsumentfinans',
        keywords: ['konsumentkredit', 'lan', 'ranta'],
      },
      {
        code: 'forsakringsratt',
        name: 'Forsakringsratt',
        keywords: ['forsakring', 'ersattning', 'forsakringsavtal'],
      },
      {
        code: 'vardepapper',
        name: 'Vardepapper & kapitalmarknad',
        keywords: ['vardepapper', 'fond', 'aktie', 'bors'],
      },
      {
        code: 'aml-penningtvatt',
        name: 'Penningtvatt & AML',
        keywords: ['penningtvatt', 'kundkanndom', 'aml'],
      },
    ],
  },
  {
    code: 'offentlig-ratt',
    name: 'Offentlig ratt & Forvaltning',
    description: 'Forvaltningsratt, upphandling, kommunalratt',
    subcategories: [
      {
        code: 'forvaltningsratt',
        name: 'Forvaltningsratt',
        keywords: ['myndighetsbeslut', 'overklagan', 'forvaltningslag'],
      },
      {
        code: 'offentlig-upphandling',
        name: 'Offentlig upphandling',
        keywords: ['lou', 'luf', 'upphandling', 'anbud'],
      },
      {
        code: 'kommunalratt',
        name: 'Kommunalratt',
        keywords: ['kommun', 'landsting', 'region', 'kommunallag'],
      },
      {
        code: 'statsstod',
        name: 'Statsstod & bidrag',
        keywords: ['statsstod', 'bidrag', 'eu-stod'],
      },
      {
        code: 'tillsyn-sanktion',
        name: 'Tillsyn & sanktioner',
        keywords: ['tillsyn', 'avgift', 'sanktion', 'vitesforelaggande'],
      },
    ],
  },
  {
    code: 'straffratt-process',
    name: 'Straffratt & Processratt',
    description: 'Brottmalsratt, civilprocess och tvistelösning',
    subcategories: [
      {
        code: 'straffratt',
        name: 'Straffratt',
        keywords: ['brott', 'paföljd', 'fängelse', 'boter'],
      },
      {
        code: 'processratt',
        name: 'Processratt',
        keywords: ['civilprocess', 'forvaltningsprocess', 'brottmalsprocess'],
      },
      {
        code: 'bevisratt',
        name: 'Bevis- & utredningsratt',
        keywords: ['bevisning', 'forundersokning', 'haktning'],
      },
      {
        code: 'alternativ-tvist',
        name: 'Alternativ tvistelösning',
        keywords: ['skiljeförfarande', 'medling', 'arn'],
      },
    ],
  },
  {
    code: 'internationell-eu',
    name: 'Internationell ratt & EU-ratt',
    description:
      'EU-lagstiftning, internationella konventioner och gransöverskridande fragar',
    subcategories: [
      {
        code: 'eu-forordning-direktiv',
        name: 'EU-forordningar & direktiv',
        keywords: ['forordning', 'direktiv', 'eu-ratt'],
      },
      {
        code: 'internationella-konventioner',
        name: 'Internationella konventioner',
        keywords: ['konvention', 'fn', 'wto', 'europadomstolen'],
      },
      {
        code: 'gransoverskridande',
        name: 'Gransöverskridande handel',
        keywords: ['jurisdiktion', 'lagval', 'internationell privatratt'],
      },
    ],
  },
]

// Helper: Get all categories flat
export function getAllCategories(): string[] {
  return CATEGORY_TAXONOMY.map((c) => c.code)
}

// Helper: Get category by code
export function getCategoryByCode(
  code: string
): CategoryDefinition | undefined {
  return CATEGORY_TAXONOMY.find((c) => c.code === code)
}

// Helper: Get subcategory by code
export function getSubcategoryByCode(
  categoryCode: string,
  subcategoryCode: string
): SubcategoryDefinition | undefined {
  const category = getCategoryByCode(categoryCode)
  return category?.subcategories.find((s) => s.code === subcategoryCode)
}
```

### Database Schema Updates

[Source: prisma/schema.prisma - needs update for Category model]

**Add Category Table:**

```prisma
model Category {
  id          String  @id @default(uuid())
  code        String  @unique  // "arbetsliv-socialt"
  name        String           // "Arbetsliv & Socialt skydd"
  description String?
  parent_id   String?          // For subcategories
  sort_order  Int     @default(0)

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children Category[] @relation("CategoryHierarchy")
  documents DocumentSubject[]

  @@index([parent_id])
  @@index([code])
  @@map("categories")
}

// Update DocumentSubject to reference Category
model DocumentSubject {
  id           String   @id @default(uuid())
  document_id  String
  category_id  String   // NEW: FK to Category
  is_primary   Boolean  @default(false)  // NEW: Primary vs secondary category
  created_at   DateTime @default(now())

  // Relations
  document LegalDocument @relation(fields: [document_id], references: [id], onDelete: Cascade)
  category Category      @relation(fields: [category_id], references: [id])

  @@unique([document_id, category_id])
  @@index([document_id])
  @@index([category_id])
  @@map("document_subjects")
}
```

### AI Categorization Strategy

[Source: Cost optimization analysis + Anthropic API pricing]

**Model Selection:**

| Task                    | Model         | Cost/1M tokens            | Est. cost for 88K docs |
| ----------------------- | ------------- | ------------------------- | ---------------------- |
| Initial categorization  | Claude Haiku  | $0.25 input, $1.25 output | ~$88                   |
| Verification/edge cases | Claude Sonnet | $3 input, $15 output      | ~$25 (2K samples)      |
| **Total**               | -             | -                         | **~$113**              |

vs. original GPT-4 estimate of $510 - **78% savings**

**Prompt Strategy (per content type):**

```typescript
// scripts/categorize-documents.ts

const CATEGORIZATION_PROMPT_SFS = `Du ar en juridisk expert som kategoriserar svenska lagar.

KATEGORIER:
${CATEGORY_TAXONOMY.map((c) => `- ${c.code}: ${c.name} (${c.subcategories.map((s) => s.name).join(', ')})`).join('\n')}

INSTRUKTIONER:
1. Las lagen nedan
2. Valj 1 primär kategori (mest relevant)
3. Valj 0-2 sekundära kategorier (om relevant)
4. Valj specifik underkategori inom varje vald kategori

LAG:
Titel: {{title}}
SFS-nummer: {{document_number}}
Innehall (forsta 500 tecken): {{content_preview}}

Svara ENDAST i JSON-format:
{
  "primary": {"category": "kod", "subcategory": "kod"},
  "secondary": [{"category": "kod", "subcategory": "kod"}]
}`

const CATEGORIZATION_PROMPT_COURT = `Du ar en juridisk expert som kategoriserar svenska rattssfall.

[SAME STRUCTURE]

RATTSFALL:
Titel: {{title}}
Domstol: {{court_name}}
Malnummer: {{case_number}}
Sammanfattning: {{summary}}

Svara ENDAST i JSON-format...`

const CATEGORIZATION_PROMPT_EU = `Du ar en juridisk expert som kategoriserar EU-lagstiftning.

[SAME STRUCTURE]

EU-DOKUMENT:
Titel: {{title}}
CELEX: {{celex_number}}
Typ: {{type}} (forordning/direktiv)
Innehall (forsta 500 tecken): {{content_preview}}

Svara ENDAST i JSON-format...`
```

**Rate Limiting & Batching:**

```typescript
import Anthropic from '@anthropic-ai/sdk'
import pLimit from 'p-limit'

const anthropic = new Anthropic()
const limit = pLimit(50) // 50 concurrent requests

async function categorizeAllDocuments() {
  const uncategorized = await prisma.legalDocument.findMany({
    where: {
      subjects: { none: {} },
    },
    select: {
      id: true,
      contentType: true,
      title: true,
      documentNumber: true,
      summary: true,
      fullText: true,
      courtCase: { select: { courtName: true, caseNumber: true } },
      euDocument: { select: { celexNumber: true } },
    },
  })

  console.log(`Categorizing ${uncategorized.length} documents...`)

  let processed = 0
  const BATCH_SIZE = 100

  for (let i = 0; i < uncategorized.length; i += BATCH_SIZE) {
    const batch = uncategorized.slice(i, i + BATCH_SIZE)

    await Promise.all(
      batch.map((doc) =>
        limit(async () => {
          try {
            await categorizeDocument(doc)
            processed++
            if (processed % 100 === 0) {
              console.log(`Progress: ${processed}/${uncategorized.length}`)
            }
          } catch (error) {
            console.error(`Failed: ${doc.id}`, error)
          }
        })
      )
    )

    // Checkpoint every 1000 docs
    if (processed % 1000 === 0) {
      console.log(`Checkpoint: ${processed} documents categorized`)
    }
  }
}

async function categorizeDocument(doc: Document) {
  const prompt = buildPrompt(doc)

  // NOTE: Verify latest Haiku model ID before implementation
  // As of Dec 2024: claude-3-haiku-20240307 or newer claude-3-5-haiku-* may be available
  const response = await anthropic.messages.create({
    model: 'claude-3-5-haiku-20241022', // Use latest Haiku for best cost/performance
    max_tokens: 200,
    messages: [{ role: 'user', content: prompt }],
  })

  const result = JSON.parse(response.content[0].text)

  // Validate categories exist
  const primaryCategory = await prisma.category.findUnique({
    where: { code: result.primary.subcategory },
  })

  if (!primaryCategory) {
    throw new Error(`Invalid category: ${result.primary.subcategory}`)
  }

  // Store primary category
  await prisma.documentSubject.create({
    data: {
      documentId: doc.id,
      categoryId: primaryCategory.id,
      isPrimary: true,
    },
  })

  // Store secondary categories
  for (const secondary of result.secondary || []) {
    const secondaryCategory = await prisma.category.findUnique({
      where: { code: secondary.subcategory },
    })

    if (secondaryCategory) {
      await prisma.documentSubject.create({
        data: {
          documentId: doc.id,
          categoryId: secondaryCategory.id,
          isPrimary: false,
        },
      })
    }
  }
}
```

### Category Page Implementation

[Source: docs/architecture/12-unified-project-structure.md + Story 2.5 patterns]

**File Structure:**

```
app/(public)/kategorier/
├── page.tsx                    # All categories grid
├── loading.tsx                 # Loading skeleton
├── error.tsx                   # Error boundary
├── [category]/
│   ├── page.tsx                # Category landing with type tabs
│   ├── loading.tsx
│   ├── error.tsx               # Error boundary
│   └── [subcategory]/
│       ├── page.tsx            # Subcategory filtered view
│       ├── loading.tsx
│       └── error.tsx           # Error boundary
```

**Category Overview Page:**

```typescript
// app/(public)/kategorier/page.tsx
import { prisma } from '@/lib/prisma'
import { CATEGORY_TAXONOMY } from '@/lib/categorization/taxonomy'
import Link from 'next/link'
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'

export const revalidate = 3600 // ISR 1 hour

export async function generateMetadata() {
  return {
    title: 'Juridiska kategorier | Laglig.se',
    description: 'Utforska svensk lagstiftning, rattsfall och EU-ratt ordnat efter amnesomrade.',
    alternates: {
      canonical: 'https://laglig.se/kategorier',
    },
  }
}

export default async function CategoriesPage() {
  // Get counts per category
  const counts = await prisma.documentSubject.groupBy({
    by: ['categoryId'],
    where: { isPrimary: true },
    _count: { documentId: true },
  })

  const countMap = new Map(counts.map(c => [c.categoryId, c._count.documentId]))

  // Load categories with their IDs
  const dbCategories = await prisma.category.findMany({
    where: { parentId: null },
    orderBy: { sortOrder: 'asc' },
  })

  return (
    <div className="container mx-auto px-4 py-8 max-w-6xl">
      <h1 className="text-3xl font-bold mb-2">Juridiska kategorier</h1>
      <p className="text-muted-foreground mb-8">
        Utforska {CATEGORY_TAXONOMY.length} huvudomraden med over 88 000 rattsliga dokument
      </p>

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {dbCategories.map(category => {
          const taxonomy = CATEGORY_TAXONOMY.find(c => c.code === category.code)
          const count = countMap.get(category.id) || 0

          return (
            <Link key={category.id} href={`/kategorier/${category.code}`}>
              <Card className="h-full hover:shadow-lg transition-shadow" data-testid="category-card">
                <CardHeader>
                  <CardTitle className="text-lg">{category.name}</CardTitle>
                  <CardDescription>
                    {taxonomy?.description}
                  </CardDescription>
                  <p className="text-sm text-muted-foreground mt-2">
                    {count.toLocaleString('sv-SE')} dokument
                  </p>
                </CardHeader>
              </Card>
            </Link>
          )
        })}
      </div>
    </div>
  )
}
```

**Category Landing Page (with tabs):**

```typescript
// app/(public)/kategorier/[category]/page.tsx
import { prisma } from '@/lib/prisma'
import { notFound } from 'next/navigation'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { getCategoryByCode } from '@/lib/categorization/taxonomy'

export const revalidate = 3600

interface Props {
  params: Promise<{ category: string }>
  searchParams: Promise<{ typ?: 'lagar' | 'rattsfall' | 'eu' }>
}

export async function generateMetadata({ params }: Props) {
  const { category } = await params
  const cat = getCategoryByCode(category)

  if (!cat) return {}

  return {
    title: `${cat.name} - Lagar och rattsfall | Laglig.se`,
    description: cat.description,
    alternates: {
      canonical: `https://laglig.se/kategorier/${category}`,
    },
  }
}

export default async function CategoryPage({ params, searchParams }: Props) {
  const { category } = await params
  const { typ = 'lagar' } = await searchParams

  const taxonomy = getCategoryByCode(category)
  if (!taxonomy) notFound()

  const dbCategory = await prisma.category.findUnique({
    where: { code: category },
    include: {
      children: { orderBy: { sortOrder: 'asc' } },
    },
  })

  if (!dbCategory) notFound()

  // Map type to ContentType filter
  const contentTypeFilter = {
    lagar: ['SFS_LAW'],
    rattsfall: ['COURT_CASE_AD', 'COURT_CASE_HD', 'COURT_CASE_HOVR', 'COURT_CASE_HFD', 'COURT_CASE_MOD', 'COURT_CASE_MIG'],
    eu: ['EU_REGULATION', 'EU_DIRECTIVE'],
  }[typ]

  // Get documents in this category
  const documents = await prisma.legalDocument.findMany({
    where: {
      contentType: { in: contentTypeFilter },
      subjects: {
        some: {
          category: {
            OR: [
              { id: dbCategory.id },
              { parentId: dbCategory.id },
            ],
          },
        },
      },
    },
    select: {
      id: true,
      title: true,
      slug: true,
      documentNumber: true,
      contentType: true,
      summary: true,
    },
    orderBy: { publicationDate: 'desc' },
    take: 50,
  })

  // Get counts per type
  const typeCounts = await prisma.legalDocument.groupBy({
    by: ['contentType'],
    where: {
      subjects: {
        some: {
          category: {
            OR: [
              { id: dbCategory.id },
              { parentId: dbCategory.id },
            ],
          },
        },
      },
    },
    _count: true,
  })

  const lagarCount = typeCounts.find(t => t.contentType === 'SFS_LAW')?._count || 0
  const rattsfallCount = typeCounts
    .filter(t => t.contentType.startsWith('COURT_CASE'))
    .reduce((sum, t) => sum + t._count, 0)
  const euCount = typeCounts
    .filter(t => t.contentType.startsWith('EU_'))
    .reduce((sum, t) => sum + t._count, 0)

  return (
    <div className="container mx-auto px-4 py-8 max-w-6xl">
      {/* Breadcrumbs */}
      <nav className="text-sm text-muted-foreground mb-4">
        <a href="/">Hem</a> / <a href="/kategorier">Kategorier</a> / {taxonomy.name}
      </nav>

      <h1 className="text-3xl font-bold mb-2">{taxonomy.name}</h1>
      <p className="text-muted-foreground mb-6">{taxonomy.description}</p>

      {/* Subcategory chips */}
      <div className="flex flex-wrap gap-2 mb-6">
        {dbCategory.children.map(sub => (
          <a
            key={sub.id}
            href={`/kategorier/${category}/${sub.code}`}
            className="px-3 py-1 bg-muted rounded-full text-sm hover:bg-primary hover:text-primary-foreground transition-colors"
          >
            {sub.name}
          </a>
        ))}
      </div>

      {/* Content type tabs */}
      <Tabs defaultValue={typ} className="w-full">
        <TabsList>
          <TabsTrigger value="lagar" asChild>
            <a href={`/kategorier/${category}?typ=lagar`}>
              Lagar ({lagarCount.toLocaleString('sv-SE')})
            </a>
          </TabsTrigger>
          <TabsTrigger value="rattsfall" asChild>
            <a href={`/kategorier/${category}?typ=rattsfall`}>
              Rattsfall ({rattsfallCount.toLocaleString('sv-SE')})
            </a>
          </TabsTrigger>
          <TabsTrigger value="eu" asChild>
            <a href={`/kategorier/${category}?typ=eu`}>
              EU ({euCount.toLocaleString('sv-SE')})
            </a>
          </TabsTrigger>
        </TabsList>

        <TabsContent value={typ} className="mt-6">
          <div className="space-y-4">
            {documents.map(doc => (
              <DocumentCard key={doc.id} document={doc} data-testid="document-card" />
            ))}
          </div>
        </TabsContent>
      </Tabs>
    </div>
  )
}

// DocumentCard component (inline or import from shared)
function DocumentCard({ document, ...props }: { document: typeof documents[0] } & React.HTMLAttributes<HTMLDivElement>) {
  const href = getDocumentHref(document) // Helper to build /lagar/[slug], /rattsfall/[court]/[slug], etc.
  return (
    <Card {...props}>
      <CardHeader className="pb-2">
        <div className="flex items-start justify-between gap-4">
          <CardTitle className="text-lg">
            <Link href={href} className="hover:text-primary hover:underline">
              {document.title}
            </Link>
          </CardTitle>
          <Badge variant="secondary" className="shrink-0 font-mono">
            {document.documentNumber}
          </Badge>
        </div>
      </CardHeader>
      {document.summary && (
        <CardContent>
          <p className="line-clamp-2 text-sm text-muted-foreground">{document.summary}</p>
        </CardContent>
      )}
    </Card>
  )
}
```

### JSON-LD Breadcrumb Structured Data

```typescript
// In category page component
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Hem',
      item: 'https://laglig.se',
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Kategorier',
      item: 'https://laglig.se/kategorier',
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: taxonomy.name,
      item: `https://laglig.se/kategorier/${category}`,
    },
  ],
}
```

### Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**Test File:** `tests/e2e/pages/category-pages.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('Category Pages', () => {
  test('displays all 13 categories on overview page', async ({ page }) => {
    await page.goto('/kategorier')

    const categoryCards = page.locator('[data-testid="category-card"]')
    await expect(categoryCards).toHaveCount(13)
  })

  test('category page shows type tabs with counts', async ({ page }) => {
    await page.goto('/kategorier/arbetsliv-socialt')

    await expect(page.getByRole('tab', { name: /Lagar/ })).toBeVisible()
    await expect(page.getByRole('tab', { name: /Rattsfall/ })).toBeVisible()
    await expect(page.getByRole('tab', { name: /EU/ })).toBeVisible()
  })

  test('subcategory filter works correctly', async ({ page }) => {
    await page.goto('/kategorier/arbetsliv-socialt/arbetsratt')

    await expect(page.getByRole('heading', { level: 1 })).toContainText(
      'Arbetsratt'
    )

    // All documents should be related to arbetsratt
    const documents = page.locator('[data-testid="document-card"]')
    await expect(documents.first()).toBeVisible()
  })

  test('has correct SEO meta tags', async ({ page }) => {
    await page.goto('/kategorier/dataskydd-digitalisering')

    await expect(page).toHaveTitle(/Dataskydd, Digitalisering/)

    const description = page.locator('meta[name="description"]')
    await expect(description).toHaveAttribute('content', /GDPR/)
  })

  test('breadcrumb structured data present', async ({ page }) => {
    await page.goto('/kategorier/skatt-ekonomi')

    const jsonLd = page.locator('script[type="application/ld+json"]')
    const content = await jsonLd.textContent()
    const data = JSON.parse(content!)

    expect(data['@type']).toBe('BreadcrumbList')
    expect(data.itemListElement).toHaveLength(3)
  })
})
```

### Testing

[Source: docs/architecture/17-coding-standards.md]

**Test File Location:** `tests/e2e/pages/category-pages.spec.ts`

**Testing Framework:** Playwright for E2E tests

**Testing Standards:**

- Use `data-testid` attributes for reliable element selection
- Test both happy path and error states
- Verify SEO elements (meta tags, JSON-LD)
- Test responsive behavior across viewports
- Run tests against local dev server: `pnpm test:e2e`

**Required Test Coverage:**

1. Category overview page displays all 13 categories
2. Category landing page shows tabs with correct counts
3. Subcategory filtering narrows results correctly
4. SEO meta tags present and correct
5. JSON-LD BreadcrumbList structured data valid
6. Category filter component on listing pages works
7. Pagination/load more functions correctly
8. Error boundaries display user-friendly messages

**Manual Testing:**

- Verify categorization accuracy on 100 random samples (AC 11)
- Document results in Dev Agent Record

### File Locations Summary

**New Files:**

- `lib/categorization/taxonomy.ts` - Category taxonomy definitions
- `scripts/seed-categories.ts` - Database seeding for categories
- `scripts/categorize-documents.ts` - AI categorization script
- `scripts/verify-categorization.ts` - Coverage and accuracy verification
- `app/(public)/kategorier/page.tsx` - Categories overview
- `app/(public)/kategorier/loading.tsx` - Loading skeleton
- `app/(public)/kategorier/error.tsx` - Error boundary
- `app/(public)/kategorier/[category]/page.tsx` - Category landing
- `app/(public)/kategorier/[category]/loading.tsx` - Loading skeleton
- `app/(public)/kategorier/[category]/error.tsx` - Error boundary
- `app/(public)/kategorier/[category]/[subcategory]/page.tsx` - Subcategory filter
- `app/(public)/kategorier/[category]/[subcategory]/loading.tsx` - Loading skeleton
- `app/(public)/kategorier/[category]/[subcategory]/error.tsx` - Error boundary
- `components/features/categorization/category-filter.tsx` - Reusable filter component
- `tests/e2e/pages/category-pages.spec.ts` - E2E tests

**Modified Files:**

- `prisma/schema.prisma` - Add Category model, update DocumentSubject
- `app/sitemap.ts` - Add /kategorier/\* routes for SEO
- `app/(public)/lagar/page.tsx` - Add CategoryFilter integration
- `app/(public)/rattsfall/page.tsx` - Add CategoryFilter integration
- `app/(public)/eu/page.tsx` - Add CategoryFilter integration

### Environment Variables

No new environment variables required - uses existing `ANTHROPIC_API_KEY`.

### Dependencies

This story DEPENDS ON:

- Story 2.5: SEO pages (DONE) - category pages link to document detail pages
- 88K+ documents in database (SFS, Court Cases, EU)

This story is a BLOCKER for:

- Story 3.x: Search with category filtering
- Story 4.x: Onboarding category selection

### Cost Estimate

| Item                       | Cost      |
| -------------------------- | --------- |
| Claude Haiku (88K docs)    | ~$88      |
| Claude Sonnet (2K samples) | ~$25      |
| Database storage           | Minimal   |
| **Total**                  | **~$113** |

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Author     |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2025-11-11 | 1.0     | Initial story creation                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Sarah (PO) |
| 2025-12-03 | 2.0     | Complete rewrite: (1) Expanded from 10 to 13 hierarchical categories based on user taxonomy, (2) Added subcategory support with ~50 subcategories, (3) Changed AI model from GPT-4 to Claude Haiku for 78% cost savings, (4) Added multi-label support (primary + secondary categories), (5) Redesigned page structure with type tabs, (6) Added comprehensive Dev Notes with full code examples, (7) Updated Prisma schema with Category model, (8) Added verification tasks                       | Bob (SM)   |
| 2025-12-03 | 2.1     | Validation fixes: (1) Added DocumentSubject migration strategy for existing data, (2) Added error.tsx files to all routes for consistency, (3) Fixed import paths to @/lib/prisma, (4) Added data-testid attributes to components, (5) Clarified Task 4 listing page integration scope, (6) Updated Claude model to claude-3-5-haiku-20241022, (7) Added pagination requirement to Task 3, (8) Added sitemap.ts integration, (9) Added Testing section per template, (10) Added modified files list | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
