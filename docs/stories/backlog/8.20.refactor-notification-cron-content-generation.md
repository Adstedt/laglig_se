# Story 8.20: Refactor Notification Cron — Move Content Generation to Ingestion

## Status

Draft

## Story

**As a** developer maintaining the notification pipeline,
**I want** content generation (summering/kommentar) to happen at amendment ingestion time rather than notification time,
**so that** the notification cron is a fast, reliable read-and-send job with no LLM dependency or timeout pressure.

## Context & Background

Story 8.4 implemented the daily amendment email digest. During QA review, several architectural concerns were identified. The most significant: the notification cron (`notify-amendment-changes`) is responsible for both generating AI content (summering/kommentar via Claude Sonnet) AND assembling/sending emails. This couples two distinct concerns and creates avoidable risk:

- LLM calls (~10s each) compete with the 300s cron budget meant for email delivery
- If content generation fails, users get degraded emails (section changes only, no summary)
- Content isn't available for other consumers (document pages, notification bell, weekly digest) until the notification cron runs

The amendment is already fully parsed in `sync-sfs-updates` (runs 04:30 UTC) — that's the natural place to generate content since the full context (PDF, section changes, base law) is available.

This story also addresses query optimization and data flow improvements identified in the same review.

## Acceptance Criteria

### Content Generation at Ingestion

1. `sync-sfs-updates` generates summering + kommentar for each newly created amendment `LegalDocument` immediately after it's created/parsed
2. Uses the same `buildSystemPrompt()` + `buildDocumentContext()` from `lib/ai/prompts/document-content.ts` (no prompt changes)
3. Stores results on `LegalDocument.summary` + `.kommentar` + `summering_generated_by` + `kommentar_generated_by` (same fields as today)
4. On LLM failure: logs error, continues ingestion — the amendment is stored without content (same as today's fallback, just happens earlier)
5. Content generation respects the existing 30s timeout buffer in `sync-sfs-updates`

### Notification Cron Simplification

6. `notify-amendment-changes` no longer imports or calls the Anthropic SDK
7. `notify-amendment-changes` no longer calls `buildSystemPrompt()`, `buildDocumentContext()`, or `getSourceText()`
8. The `generateContent()` helper function is removed from the cron route
9. The cron reads pre-generated summering/kommentar from `LegalDocument` — if null, the email renders without them (existing fallback, now a rare edge case)
10. `contentGenerated` and `contentFailed` stats are removed from the cron response (no longer relevant)

### Query Optimization

11. Replace per-event `legalDocument.findUnique` + `amendmentDocument.findUnique` calls with batched `findMany` queries using `IN` clauses
12. Replace per-document `resolveAffectedRecipients()` calls with a single batched query that resolves all affected workspaces/users for all documents at once
13. Replace per-user `shouldSendEmail()` calls with a batched preference lookup for all user-workspace pairs

### Data Flow Simplification

14. Build workspace batches in a single pass during enrichment instead of the current three-pass approach (flat array → group by document → group by workspace)

## Tasks / Subtasks

- [ ] **Task 1: Add content generation to sync-sfs-updates** (AC: 1-5)
  - [ ] After `createLegalDocumentFromAmendment()` succeeds, call content generation for the new LegalDocument
  - [ ] Extract the `generateContent()` logic from notification cron into a shared utility (e.g., `lib/ai/content-generation.ts`)
  - [ ] Add timeout awareness: skip generation if approaching sync cron's timeout buffer
  - [ ] Add stats tracking: `contentGenerated`, `contentFailed` to sync cron response

- [ ] **Task 2: Simplify notification cron** (AC: 6-10)
  - [ ] Remove Anthropic SDK import and `generateContent()` function
  - [ ] Remove `buildSystemPrompt`, `buildDocumentContext`, `getSourceText` imports
  - [ ] Read summering/kommentar directly from LegalDocument (already in the query)
  - [ ] Remove `contentGenerated`/`contentFailed` from CronStats
  - [ ] Update tests to remove content generation scenarios (or move them to sync cron tests)

- [ ] **Task 3: Batch queries** (AC: 11-13)
  - [ ] Batch amendment LegalDocument lookups: collect all `amendment_sfs` values, do one `findMany({ where: { document_number: { in: [...] } } })`
  - [ ] Batch AmendmentDocument lookups: collect all SFS numbers, do one `findMany({ where: { sfs_number: { in: [...] } } })` with section changes included
  - [ ] Batch recipient resolution: query all workspaces tracking any of the affected documents in one query
  - [ ] Batch preference lookup: query all NotificationPreferences for all user-workspace pairs in one `findMany`

- [ ] **Task 4: Single-pass workspace grouping** (AC: 14)
  - [ ] Refactor to build `Map<workspaceId, WorkspaceBatch>` directly during enrichment instead of enrichedEvents[] → documentIds → workspaceBatches

- [ ] **Task 5: Update tests**
  - [ ] Add content generation tests to `sync-sfs-updates` test suite
  - [ ] Simplify notification cron tests (remove LLM mock, content generation scenarios)
  - [ ] Add tests for batched query behavior
  - [ ] Verify all existing test assertions still hold

## Dev Notes

### Current Flow (Story 8.4)

```
04:30  sync-sfs-updates    → detects amendment, creates ChangeEvent + LegalDocument
07:00  notify-amendments   → generates content (LLM) → resolves recipients → sends emails
```

### Target Flow (This Story)

```
04:30  sync-sfs-updates    → detects amendment, creates ChangeEvent + LegalDocument + generates content (LLM)
07:00  notify-amendments   → reads pre-generated content → resolves recipients → sends emails
```

### Files to Modify

```
app/api/cron/sync-sfs-updates/route.ts        — ADD content generation after amendment creation
app/api/cron/notify-amendment-changes/route.ts — SIMPLIFY: remove LLM, batch queries, single-pass grouping
lib/ai/content-generation.ts                   — NEW: extracted generateContent() shared utility
tests/unit/app/api/cron/notify-amendment-changes.test.ts — SIMPLIFY
tests/unit/app/api/cron/sync-sfs-updates.test.ts        — ADD content generation tests
```

### Current Query Count (N events, D documents, W workspaces, U users)

| Operation | Current | After |
|-----------|---------|-------|
| Amendment LegalDocument lookup | N queries | 1 query |
| AmendmentDocument + SectionChanges | N queries | 1 query |
| Recipient resolution | D queries | 1 query |
| Preference check | U queries | 1 query |
| **Total DB round-trips** | **N + N + D + U** | **4** |

### Risk Notes

- `sync-sfs-updates` already has a tight timeout budget processing multiple amendments — content generation adds ~10s per amendment. Monitor whether this pushes close to the 300s limit.
- If the sync cron times out before generating content, the notification cron gracefully handles missing summering/kommentar (existing fallback path).

## Change Log

| Date       | Version | Description                     | Author           |
| ---------- | ------- | ------------------------------- | ---------------- |
| 2026-02-17 | 1.0     | Initial draft from QA review findings on Story 8.4 | Quinn (QA) |
