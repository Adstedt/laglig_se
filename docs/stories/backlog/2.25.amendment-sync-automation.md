# Story 2.25: Amendment Sync Automation

## Status

Backlog

## Story

**As a** system maintainer,
**I want** new amendments to be automatically processed when they're synced,
**so that** the amendment database stays current without manual intervention.

## Background

Story 2.13 established the infrastructure for parsing amendment PDFs and extracting section changes. However, the current flow is manual - amendments must be ingested via batch scripts. Once historical backlog is complete, we need ongoing automation.

The daily `sync-sfs-updates` cron already fetches new SFS documents. This story extends it to automatically process amendments.

## Dependencies

- **Story 2.13** (Amendment Documents & Historical Versions) - Phase 2 must be complete
  - PDF parsing infrastructure (`lib/external/pdf-parser.ts`)
  - LLM parsing (`lib/external/llm-amendment-parser.ts`)
  - Supabase Storage setup (`lib/supabase/storage.ts`)
  - `AmendmentDocument` and `SectionChange` tables

## Acceptance Criteria

1. **AC1:** When `sync-sfs-updates` detects a new amendment (title contains "om Ã¤ndring i"):
   - Download PDF from svenskforfattningssamling.se
   - Upload to Supabase Storage
   - Extract text using `unpdf`
   - Parse with LLM to extract sections
   - Create `AmendmentDocument` and `SectionChange` records
   - Link to base law via `base_law_sfs`

2. **AC2:** Failed amendments are logged but don't block the sync job

3. **AC3:** Weekly retry of failed amendments (parse_status = 'FAILED')

4. **AC4:** Monitoring/alerting if failure rate exceeds threshold (e.g., >20%)

## Tasks

- [ ] **Task 1:** Extend `sync-sfs-updates` to detect amendments by title pattern
- [ ] **Task 2:** Add PDF download + Supabase upload for new amendments
- [ ] **Task 3:** Add text extraction + LLM parsing inline
- [ ] **Task 4:** Add weekly retry cron for failed amendments (can use existing `--retry-failed` batch)
- [ ] **Task 5:** Add failure rate monitoring/logging

## Technical Notes

**Daily volume:** ~1-5 new amendments per day (small enough for real-time API, no batch needed)

**Existing code to reuse:**

- `lib/supabase/storage.ts` - `uploadPdf()`, `pdfExists()`
- `lib/external/pdf-parser.ts` - `parsePdf()`
- `lib/external/llm-amendment-parser.ts` - `parseAmendmentWithLLM()`
- `scripts/batch-parse-amendments.ts --retry-failed` - retry logic with improved prompt

**PDF source:** `https://svenskforfattningssamling.se/sites/default/files/sfs/{YYYY-MM}/SFS{YYYY}-{NNNN}.pdf`

## Scope Notes

This story is for **ongoing automation** after historical backlog is complete. Do not start until Story 2.13 Phase 2 is fully done.

## Change Log

| Date       | Version | Description                                    | Author    |
| ---------- | ------- | ---------------------------------------------- | --------- |
| 2025-12-11 | 0.1     | Initial draft - extracted from 2.13 discussion | Dev Agent |
