# Story 2.26: SFS Markdown Conversion for RAG

## Overview

Convert all SFS documents (amendments and full law texts) to well-structured Markdown format for RAG (Retrieval-Augmented Generation) use cases. The current PDF extraction produces text with artifacts, broken sentences, and poor structure.

## Background

During Story 2.13 implementation, we added a basic `markdown_content` column to `amendment_documents` and a `generateMarkdown()` function. However, the output quality has issues:

- PDF text extraction produces artifacts (page numbers, SFS markers embedded in text)
- Line breaks occur mid-sentence
- Section markers (`§`) are not properly separated
- No semantic structure (headings, lists) for section content

Example problematic output:

```
6 § Arbetsförmedlingen, Centrala studiestödsnämnden, Försäkringskassan,
Inspektionen för arbetslöshetsförsäkringen, Migrationsverket och Pensions-
myndigheten ska återkommande studera omfattningen av felaktiga utbetal-
ningar.
```

Should be:

```markdown
## 6 §

Arbetsförmedlingen, Centrala studiestödsnämnden, Försäkringskassan,
Inspektionen för arbetslöshetsförsäkringen, Migrationsverket och
Pensionsmyndigheten ska återkommande studera omfattningen av
felaktiga utbetalningar.
```

## Critical Requirement

**NO HALLUCINATIONS**. Legal text must be preserved exactly as written. Any LLM processing must only restructure/format, never modify content. Output must be verifiable against source PDF.

## Scope

### In Scope

- Amendment documents (`amendment_documents.markdown_content`)
- Full law texts (`legal_documents`) - future markdown column
- YAML frontmatter with metadata
- Structured headings for chapters and sections
- Clean paragraph formatting

### Out of Scope

- Semantic analysis or summarization
- Translation
- Legal interpretation

## Implementation Options

### Option A: Enhanced Regex Processing

- Improve `cleanPdfText()` with more sophisticated patterns
- Handle common Swedish legal document patterns
- Pros: No API costs, no hallucination risk
- Cons: May not handle all edge cases, complex regex

### Option B: LLM Structure-Only Pass

- Use LLM to identify structure (chapter/section boundaries)
- Keep original text verbatim
- Validate output length matches input (no additions/deletions)
- Pros: Better structure detection
- Cons: API costs, requires strict validation

### Option C: Hybrid Approach

- Regex for basic cleanup
- LLM for structure identification only
- Strict validation layer
- Checksum verification against source

## Data Model Changes

### Amendment Documents

Already has `markdown_content String? @db.Text` column.

### Legal Documents (future)

```prisma
model LegalDocument {
  // ... existing fields ...
  markdown_content String? @db.Text  // NEW
}
```

## Implementation Steps

1. **Research**: Analyze 50+ amendment documents for common patterns
2. **Regex Library**: Build comprehensive regex patterns for Swedish legal text
3. **Validation Layer**: Create checksum/length validation to detect modifications
4. **Processing Script**: Batch convert all existing documents
5. **Pipeline Integration**: Update ingestion to generate markdown on insert
6. **Quality Audit**: Manual review of sample documents per year

## Validation Requirements

- Character count must match (within tolerance for whitespace normalization)
- All section numbers (`§`) must be preserved
- All dates must be preserved
- No new words introduced
- Diff tool to compare source vs output

## Success Criteria

- [ ] All amendment documents have properly formatted markdown
- [ ] No content modifications (validation passing)
- [ ] Section headings correctly identified
- [ ] YAML frontmatter complete and accurate
- [ ] RAG retrieval quality improved (measured by test queries)

## Dependencies

- Story 2.13 (Amendment Documents) - completed
- Story 2.21 (Section-Level Law Parsing) - could share parsing patterns

## Effort Estimate

- Research & pattern analysis: 2-3 hours
- Regex library development: 3-4 hours
- Validation layer: 2 hours
- Batch processing script: 1-2 hours
- Quality audit & fixes: 2-3 hours

## Notes

- Start with amendments from 2024-2025 (most recent/consistent formatting)
- svenskforfattningssamling.se PDFs have consistent structure
- Consider storing both raw extracted text and formatted markdown
- May need per-year format adjustments for older documents
