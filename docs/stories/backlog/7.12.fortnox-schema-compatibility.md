# Story 7.12: Implement Fortnox Schema Compatibility (FR41)

## Status

Draft

## Story

**As a** product owner,
**I want** to design employee schema to support future Fortnox integration,
**so that** we enable one-click sync post-MVP.

## Acceptance Criteria

1. Employee schema fields mapped to Fortnox API structure:
   - `employee_id` → Fortnox `EmployeeId`
   - `personnummer` → Fortnox `PersonalIdentityNumber`
   - `contract_type` → Fortnox `PersonnelType`
   - `employment_date` → Fortnox `EmploymentDate`
   - `role` → Fortnox `ScheduleId` (mapping table for role → schedule)
2. Database migration adds `fortnox_id` field (null for now)
3. Documentation created: "Fortnox Integration Mapping"
4. No user-facing features in MVP (infrastructure only)
5. Post-MVP: OAuth flow will populate `fortnox_id` and enable sync

## Tasks / Subtasks

- [ ] Add `fortnoxId` field to Employee schema
- [ ] Create Fortnox field mapping table
- [ ] Document Fortnox API field mappings
- [ ] Create placeholder for future OAuth flow
- [ ] Add comments in code for future integration
- [ ] Test schema compatibility with Fortnox API structure
- [ ] Validate data types match Fortnox requirements

## Dev Notes

**Database Schema Update:**

```prisma
model Employee {
  id                     String   @id @default(uuid())
  workspaceId            String
  fortnoxId              String?  // Fortnox EmployeeId (null until synced)
  name                   String
  personnummer           String   // Encrypted - maps to Fortnox PersonalIdentityNumber
  email                  String?
  phone                  String?
  employmentDate         DateTime // Maps to Fortnox EmploymentDate
  contractType           String   // permanent, fixed_term, consultant - maps to Fortnox PersonnelType
  role                   String   // Maps to Fortnox ScheduleId via mapping table
  department             String?
  managerId              String?
  status                 String   @default("active")
  endDate                DateTime?
  photoUrl               String?
  complianceStatus       String   @default("non_compliant")
  complianceScore        Int      @default(0)
  complianceReasons      Json?
  complianceLastChecked  DateTime @default(now())
  fortnoxSyncedAt        DateTime? // Last sync with Fortnox
  fortnoxSyncStatus      String?   // synced, pending, error
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // ... relations ...

  @@unique([workspaceId, fortnoxId])
  @@index([fortnoxId])
  @@map("employees")
}

model FortnoxRoleMapping {
  id              String   @id @default(uuid())
  internalRole    String   @unique // Our internal role (e.g., "construction_worker")
  fortnoxScheduleId String // Fortnox ScheduleId
  description     String?
  createdAt       DateTime @default(now())

  @@map("fortnox_role_mappings")
}
```

**Fortnox API Field Mapping Documentation:**

```markdown
# Fortnox Integration Mapping

## Overview

This document maps Laglig.se employee fields to Fortnox API fields for future integration.

## Field Mappings

### Employee Basic Info

| Laglig.se Field         | Fortnox API Field        | Data Type          | Notes                             |
| ----------------------- | ------------------------ | ------------------ | --------------------------------- |
| `employee.id`           | Not synced               | UUID               | Internal ID only                  |
| `employee.fortnoxId`    | `EmployeeId`             | String             | Fortnox unique ID                 |
| `employee.name`         | `FirstName` + `LastName` | String             | Split name into first/last        |
| `employee.personnummer` | `PersonalIdentityNumber` | String (12 digits) | Decrypt before sending to Fortnox |
| `employee.email`        | `Email`                  | String             | Optional                          |
| `employee.phone`        | `PhoneNumber`            | String             | Optional                          |

### Employment Details

| Laglig.se Field           | Fortnox API Field | Data Type         | Notes                                        |
| ------------------------- | ----------------- | ----------------- | -------------------------------------------- |
| `employee.employmentDate` | `EmploymentDate`  | Date (YYYY-MM-DD) | Required                                     |
| `employee.endDate`        | `EmployedTo`      | Date (YYYY-MM-DD) | Only if fixed-term or terminated             |
| `employee.contractType`   | `PersonnelType`   | Enum              | See mapping below                            |
| `employee.role`           | `ScheduleId`      | String            | Via `FortnoxRoleMapping` table               |
| `employee.department`     | Custom field      | String            | Fortnox doesn't have native department field |

### Contract Type Mapping

| Laglig.se    | Fortnox PersonnelType |
| ------------ | --------------------- |
| `permanent`  | `1` (Permanent)       |
| `fixed_term` | `2` (Temporary)       |
| `consultant` | `3` (Contract)        |

### Role to ScheduleId Mapping

Fortnox uses `ScheduleId` to determine work schedules. This is workspace-specific.

Example mappings (to be configured by user):
| Internal Role | Fortnox ScheduleId | Description |
|--------------|-------------------|-------------|
| `manager` | `SCH001` | Full-time manager schedule |
| `employee` | `SCH002` | Full-time employee schedule |
| `construction_worker` | `SCH003` | Construction site schedule |
| `warehouse_worker` | `SCH004` | Warehouse shift schedule |

**Note:** Users must configure role mappings in settings before Fortnox sync.

## OAuth Flow (Post-MVP)

### Step 1: Connect to Fortnox

1. User clicks "Connect to Fortnox" in Settings
2. Redirect to Fortnox OAuth authorization
3. User authorizes Laglig.se to access their Fortnox account
4. Store access token and refresh token securely

### Step 2: Initial Sync

1. Fetch all employees from Fortnox API
2. Match employees by `personnummer`
3. Populate `fortnoxId` for matched employees
4. Create new employees in Laglig.se for unmatched Fortnox employees (optional)

### Step 3: Ongoing Sync

1. Webhook from Fortnox when employee updated
2. Fetch updated employee data from Fortnox API
3. Update Laglig.se employee record
4. Set `fortnoxSyncedAt` and `fortnoxSyncStatus`

### Step 4: Bidirectional Sync (Advanced)

1. When employee updated in Laglig.se, push update to Fortnox API
2. Handle conflicts (last-write-wins or manual resolution)

## API Endpoints (Fortnox)

### Get Employees
```

GET https://api.fortnox.se/3/employees

```

### Get Single Employee
```

GET https://api.fortnox.se/3/employees/{EmployeeId}

```

### Create Employee
```

POST https://api.fortnox.se/3/employees
{
"Employee": {
"FirstName": "Anna",
"LastName": "Svensson",
"PersonalIdentityNumber": "198001011234",
"Email": "anna@example.com",
"EmploymentDate": "2024-01-15",
"PersonnelType": "1",
"ScheduleId": "SCH002"
}
}

```

### Update Employee
```

PUT https://api.fortnox.se/3/employees/{EmployeeId}
{
"Employee": {
"FirstName": "Anna",
"LastName": "Andersson",
...
}
}

```

## Data Validation

Before syncing to Fortnox, validate:
1. `personnummer` is valid 12-digit Swedish SSN
2. `employmentDate` is not in the future
3. `contractType` maps to valid Fortnox `PersonnelType`
4. `role` has a corresponding `ScheduleId` mapping
5. `name` can be split into first and last name

## Error Handling

Common Fortnox API errors:
- `401 Unauthorized`: Access token expired (refresh token)
- `403 Forbidden`: Missing permissions (re-authorize)
- `404 Not Found`: EmployeeId doesn't exist in Fortnox
- `422 Unprocessable Entity`: Invalid data (check validation)
- `429 Too Many Requests`: Rate limit exceeded (retry with backoff)

## Security

- Store Fortnox OAuth tokens encrypted in database
- Use HTTPS for all Fortnox API calls
- Decrypt `personnummer` only when sending to Fortnox (keep encrypted at rest)
- Log all sync operations for audit trail
- Implement rate limiting to avoid Fortnox API limits

## Testing (Post-MVP)

1. Mock Fortnox API responses for testing
2. Test OAuth flow in staging environment
3. Test initial sync with 100+ employees
4. Test bidirectional sync with conflicts
5. Test error handling (expired token, invalid data)
6. Test webhook processing

## References
- Fortnox API Documentation: https://developer.fortnox.se/documentation/
- Fortnox OAuth Guide: https://developer.fortnox.se/general/authentication/
```

**Database Migration:**

```sql
-- Add Fortnox fields to employees table
ALTER TABLE employees
ADD COLUMN fortnox_id VARCHAR(255),
ADD COLUMN fortnox_synced_at TIMESTAMP,
ADD COLUMN fortnox_sync_status VARCHAR(50);

-- Add unique constraint for workspace + fortnox_id
CREATE UNIQUE INDEX idx_employees_workspace_fortnox
ON employees (workspace_id, fortnox_id)
WHERE fortnox_id IS NOT NULL;

-- Add index for faster lookups
CREATE INDEX idx_employees_fortnox_id ON employees (fortnox_id);
```

**Fortnox Role Mapping Table Seed:**

```typescript
// prisma/seeds/fortnox-role-mappings.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function seedFortnoxRoleMappings() {
  const mappings = [
    {
      internalRole: 'manager',
      fortnoxScheduleId: 'SCH001',
      description: 'Full-time manager schedule (40h/week)',
    },
    {
      internalRole: 'employee',
      fortnoxScheduleId: 'SCH002',
      description: 'Full-time employee schedule (40h/week)',
    },
    {
      internalRole: 'construction_worker',
      fortnoxScheduleId: 'SCH003',
      description: 'Construction site schedule (flexible hours)',
    },
    {
      internalRole: 'warehouse_worker',
      fortnoxScheduleId: 'SCH004',
      description: 'Warehouse shift schedule (3 shifts)',
    },
    {
      internalRole: 'intern',
      fortnoxScheduleId: 'SCH005',
      description: 'Part-time intern schedule (20h/week)',
    },
    {
      internalRole: 'consultant',
      fortnoxScheduleId: 'SCH006',
      description: 'Consultant schedule (project-based)',
    },
  ]

  for (const mapping of mappings) {
    await prisma.fortnoxRoleMapping.upsert({
      where: { internalRole: mapping.internalRole },
      update: mapping,
      create: mapping,
    })
  }

  console.log(`Seeded ${mappings.length} Fortnox role mappings`)
}

seedFortnoxRoleMappings()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

**Placeholder for Future Fortnox Settings:**

```typescript
// app/settings/integrations/page.tsx (placeholder)
export default function IntegrationsPage() {
  return (
    <div className="max-w-7xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">Integrations</h1>

      {/* Fortnox Integration Card */}
      <div className="bg-white rounded-lg shadow p-6 border-2 border-dashed border-gray-300">
        <div className="flex items-start gap-4">
          {/* Fortnox Logo */}
          <div className="w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center">
            <span className="text-2xl font-bold text-blue-600">F</span>
          </div>

          <div className="flex-1">
            <h2 className="text-lg font-semibold mb-2">Fortnox</h2>
            <p className="text-sm text-gray-600 mb-4">
              Sync employee data with your Fortnox account. Two-way sync keeps employee records up-to-date across both platforms.
            </p>

            {/* Coming Soon Badge */}
            <div className="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
              Coming Post-MVP
            </div>
          </div>

          {/* Connect Button (Disabled) */}
          <button
            disabled
            className="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed"
          >
            Connect to Fortnox
          </button>
        </div>

        {/* Info Box */}
        <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <p className="text-sm text-blue-900">
            <strong>Post-MVP Feature:</strong> Fortnox integration will be available after MVP launch.
            Your employee schema is already compatible, so migration will be seamless.
          </p>
        </div>
      </div>
    </div>
  )
}
```

**Code Comments for Future Integration:**

```typescript
// lib/fortnox/sync-employee.ts (placeholder)
/**
 * Fortnox Integration (Post-MVP)
 *
 * This file will handle employee synchronization with Fortnox API.
 *
 * Features:
 * - OAuth 2.0 authentication with Fortnox
 * - Fetch employees from Fortnox API
 * - Match employees by personnummer
 * - Sync employee updates bidirectionally
 * - Handle webhook events from Fortnox
 *
 * Database fields ready for integration:
 * - employee.fortnoxId: Stores Fortnox EmployeeId
 * - employee.fortnoxSyncedAt: Last sync timestamp
 * - employee.fortnoxSyncStatus: Sync status (synced, pending, error)
 *
 * See docs/fortnox-integration-mapping.md for full field mappings.
 */

export async function syncEmployeeWithFortnox(employeeId: string) {
  // TODO: Implement post-MVP
  throw new Error('Fortnox integration not yet implemented')
}

export async function fetchFortnoxEmployees() {
  // TODO: Implement post-MVP
  throw new Error('Fortnox integration not yet implemented')
}

export async function handleFortnoxWebhook(event: any) {
  // TODO: Implement post-MVP
  throw new Error('Fortnox integration not yet implemented')
}
```

**Reference:** PRD Epic 7 Story 7.12, Fortnox API documentation (FR41)

## Testing

**Unit Tests:**

- Field mappings correctly defined in documentation
- Database schema includes all Fortnox fields
- Role mapping seed data valid

**Integration Tests:**

- Database migration adds `fortnoxId` field successfully
- Unique constraint on `(workspaceId, fortnoxId)` works
- Seed script creates role mappings without errors

**Manual Testing:**

- Review Fortnox integration documentation for completeness
- Verify all employee fields have Fortnox mappings
- Check database schema includes `fortnoxId`, `fortnoxSyncedAt`, `fortnoxSyncStatus`
- View Settings > Integrations page, verify "Coming Post-MVP" badge shown
- Verify "Connect to Fortnox" button disabled

**Documentation Review:**

- Field mappings cover all Fortnox API requirements
- OAuth flow clearly documented
- Error handling scenarios covered
- Security considerations documented

**Validation Testing:**

- Personnummer format matches Fortnox requirements (12 digits)
- Contract type mapping complete (permanent, fixed_term, consultant)
- Role mapping table includes common roles

**Test File:** N/A (infrastructure only, no user-facing features in MVP)

## User vs Developer Responsibilities

**User Responsibility:**

- N/A (no user-facing features in MVP)
- Post-MVP: Configure role mappings in settings
- Post-MVP: Authorize Fortnox OAuth connection

**Developer Responsibility:**

- Design schema compatible with Fortnox API
- Document all field mappings thoroughly
- Add database fields for future integration
- Create placeholder UI for integrations page
- Add code comments for future implementers
- Seed role mapping table with defaults
- Validate data types match Fortnox requirements
- Ensure personnummer encryption compatible with Fortnox sync
- Plan OAuth flow and error handling
- Prepare for post-MVP integration work (6-8 weeks estimated)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
