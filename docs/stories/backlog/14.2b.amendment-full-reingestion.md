# Story 14.2b: Full Amendment Re-Ingestion with Canonical Prompt

## Status

Backlog

## Story

**As a** platform serving legal professionals,
**I want** all ~34k existing SFS amendments re-processed through the updated canonical LLM prompt,
**so that** amendment documents have the same high-quality, consistent HTML as newly ingested amendments.

## Context

Story 14.1 rewrote the amendment LLM prompt (`lib/sfs/amendment-llm-prompt.ts`) to produce canonical flat HTML directly — no Notisum-style nesting, proper `a.paragraf` anchors, clean structure.

An A/B test of 10 amendments (2026-02-19) confirmed that re-ingestion with the new prompt produces **significantly better** results than running the structural normalizer on old LLM output. The normalizer can strip wrappers and add anchors, but it cannot fix:

- Inconsistent paragraph breaks from the old prompt
- Missing or malformed content structure
- Poor formatting and layout quirks
- Content quality issues inherent to the old prompt's output

**Conclusion:** There is no shortcut — full re-ingestion is required for quality parity.

## Scope

- ~34,000 SFS amendment documents in `AmendmentDocument` table
- Each requires PDF download from Supabase → Batch API call → result processing → DB update
- Existing pipeline (`scripts/batch-process-amendments.ts`) fully supports this via `prepare` → `submit` → `download` → `process`

## Cost Estimate

- ~34,000 documents × ~12k input tokens + ~3k output tokens each
- Sonnet batch pricing (50% discount): ~$1,400
- Can be split across multiple batch submissions (5,000 docs per batch file)

## Acceptance Criteria

1. All ~34k amendments re-processed through Batch API with current `AMENDMENT_PDF_SYSTEM_PROMPT`
2. `LegalDocument.html_content` updated with new canonical HTML for each amendment
3. Derived fields updated: `markdown_content`, `json_content`, `full_text`
4. `SectionChange` records regenerated from new JSON
5. Linkification applied to new HTML
6. Error rate < 1% (with retry for failures)
7. Before/after quality spot-check on 20 random documents

## Implementation Notes

- Use existing `batch-process-amendments.ts` pipeline — no new code needed
- Process in chunks of 5,000 to stay within Batch API limits
- The `--from-file` flag can target specific subsets for phased rollout
- Consider running a pilot batch of 100-200 first to validate at scale
- Monitor for any prompt edge cases not covered by the A/B test

## Dependencies

- Story 14.1 (canonical prompt) — completed
- Anthropic Batch API access — available
- Supabase storage (PDF source) — available

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-02-19 | 1.0     | Created from 14.1 A/B test finding | Dev team |
