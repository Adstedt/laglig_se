# Story 2.18: Amendment PDF Integration for Change Monitoring

## Status

Backlog

## Story

**As a** product owner,
**I want** the daily change monitoring to fetch actual amendment PDFs when new amendments are detected,
**so that** we capture the precise text changes (not just metadata) and can show users exactly what changed in a law.

## Background

### Current State (Story 2.11 - Complete)

Story 2.11 implemented daily change detection that:
- Detects new/updated SFS laws via `systemdatum` comparison
- Extracts amendment references from consolidated text (e.g., "Lag (2025:732)")
- Parses affected sections from markers like `§ 7 ... Lag (2025:732).`
- Creates `Amendment` records with `amending_document_id = NULL`
- Generates AI summaries of detected changes

**Limitation:** We only capture metadata about amendments, not the actual amendment document text.

### What This Story Adds

When Story 2.11's cron job detects a new amendment (e.g., "SFS 2025:732"):

1. **Fetch the amendment PDF** from svenskforfattningssamling.se (2018+) or rkrattsbaser.gov.se (1998-2017)
2. **Parse the PDF** using Story 2.13's infrastructure
3. **Store as LegalDocument** with `content_type: SFS_AMENDMENT`
4. **Link the amendment** via `Amendment.amending_document_id`
5. **Create DocumentVersion** for the base law at this point in time

This provides the **actual amendment text**, enabling:
- Display of the exact amendment document to users
- Precise diff showing old vs new section text
- Full-text search of amendment documents
- RAG queries that include amendment context

## Acceptance Criteria

1. **AC1:** When change detection identifies a new amendment SFS number, trigger amendment PDF fetch
2. **AC2:** Determine correct PDF source based on amendment year:
   - 2018+ → svenskforfattningssamling.se
   - 1998-2017 → rkrattsbaser.gov.se
3. **AC3:** Use Story 2.13's `pdf-parser.ts` to extract text from amendment PDF
4. **AC4:** Use Story 2.13's `amendment-extractor.ts` to parse amendment structure
5. **AC5:** Create `LegalDocument` record with `content_type: SFS_AMENDMENT`
6. **AC6:** Update `Amendment.amending_document_id` to link to the new document
7. **AC7:** Create `DocumentVersion` for base law capturing state after this amendment
8. **AC8:** Handle PDF fetch failures gracefully (log error, continue with metadata-only amendment)
9. **AC9:** Rate limit PDF fetches to 1 req/sec to respect external sources
10. **AC10:** Log metrics: PDFs fetched, successful parses, failed fetches

## Tasks / Subtasks

- [ ] **Task 1: Extend Change Detection Hook** (AC: 1)
  - [ ] Add hook in `sync-sfs/route.ts` after amendment detection
  - [ ] Call new `fetchAmendmentPdf()` function when amendment detected
  - [ ] Pass amendment SFS number and base law ID

- [ ] **Task 2: Implement PDF Source Router** (AC: 2)
  - [ ] Create `lib/sync/amendment-pdf-fetcher.ts`
  - [ ] Parse year from SFS number (e.g., "2025:732" → 2025)
  - [ ] Route to correct source based on year threshold (2018)
  - [ ] Construct correct URL pattern for each source

- [ ] **Task 3: Integrate PDF Parser** (AC: 3, 4)
  - [ ] Import `pdf-parser.ts` from Story 2.13
  - [ ] Import `amendment-extractor.ts` from Story 2.13
  - [ ] Extract text and parse amendment structure
  - [ ] Handle OCR fallback for older scanned PDFs

- [ ] **Task 4: Store Amendment Document** (AC: 5, 6)
  - [ ] Create `LegalDocument` with `content_type: SFS_AMENDMENT`
  - [ ] Set `document_number` to amendment SFS (e.g., "SFS 2025:732")
  - [ ] Set `title` to "Lag om ändring i [base law name]"
  - [ ] Store `full_text` from PDF extraction
  - [ ] Update `Amendment.amending_document_id` to link

- [ ] **Task 5: Create Historical Version** (AC: 7)
  - [ ] Create `DocumentVersion` for base law
  - [ ] Link to amendment via `amendment_sfs` field
  - [ ] Store reconstructed law text at this version

- [ ] **Task 6: Error Handling & Rate Limiting** (AC: 8, 9, 10)
  - [ ] Implement retry with exponential backoff (3 attempts)
  - [ ] Add 1 second delay between PDF fetches
  - [ ] Log failures to console (Sentry integration separate)
  - [ ] Continue processing even if PDF fetch fails
  - [ ] Track metrics in sync response

- [ ] **Task 7: Unit Tests**
  - [ ] Location: `tests/unit/lib/sync/amendment-pdf-fetcher.test.ts`
  - [ ] Test URL construction for both sources
  - [ ] Test year-based routing logic
  - [ ] Test error handling scenarios

- [ ] **Task 8: Integration Tests**
  - [ ] Location: `tests/integration/sync/amendment-pdf-integration.test.ts`
  - [ ] Test end-to-end flow with mock PDF
  - [ ] Test LegalDocument creation
  - [ ] Test Amendment linking

## Dev Notes

### Source Tree

```
lib/
├── sync/
│   ├── amendment-pdf-fetcher.ts   # NEW - PDF fetch orchestration
│   └── ... (existing 2.11 modules)
├── external/
│   ├── pdf-parser.ts              # FROM 2.13 - PDF text extraction
│   └── amendment-extractor.ts     # FROM 2.13 - Amendment structure parsing

app/api/cron/
└── sync-sfs/route.ts              # MODIFY - Add PDF fetch hook

tests/
├── unit/lib/sync/
│   └── amendment-pdf-fetcher.test.ts  # NEW
└── integration/sync/
    └── amendment-pdf-integration.test.ts  # NEW
```

### Integration Point

In `app/api/cron/sync-sfs/route.ts`, after amendment detection:

```typescript
// Existing code creates Amendment record...
const amendment = await createAmendmentFromChange(...)

// NEW: Fetch amendment PDF if available
if (amendment && isAmendmentPdfAvailable(amendment.sfsNumber)) {
  await fetchAndStoreAmendmentPdf({
    amendmentSfs: amendment.sfsNumber,
    baseDocumentId: document.id,
    amendmentId: amendment.id
  })
}
```

### URL Patterns (from Story 2.13)

**svenskforfattningssamling.se (2018+):**
```
https://svenskforfattningssamling.se/sites/default/files/sfs/{YYYY-MM}/SFS{YYYY}-{NNNN}.pdf
```

**rkrattsbaser.gov.se (1998-2017):**
```
Structure TBD - requires Phase 1 investigation from Story 2.13
```

### Rate Limiting Strategy

```typescript
const PDF_FETCH_DELAY_MS = 1000  // 1 second between requests

async function fetchAmendmentPdfs(amendments: Amendment[]) {
  for (const amendment of amendments) {
    await fetchAndStoreAmendmentPdf(amendment)
    await delay(PDF_FETCH_DELAY_MS)
  }
}
```

### Error Handling

PDF fetch failures should NOT block change detection:
- Log the error
- Keep `Amendment.amending_document_id` as NULL
- Continue with next amendment
- Report in sync metrics: `{ pdfsFetched: 5, pdfsFailed: 1 }`

## Dependencies

### This Story Depends On:

| Dependency | Status | Required For |
|------------|--------|--------------|
| Story 2.11 (Change History Tracking) | **Complete** | Change detection infrastructure, cron jobs |
| Story 2.13 Phase 2 (Amendment Ingestion) | **Pending** | `pdf-parser.ts`, `amendment-extractor.ts` |

### Implementation Sequence:

```
Story 2.13 Phase 1 (Investigation)
        │
        ▼
Story 2.13 Phase 2 (Ingestion Pipeline) ─── Creates PDF parsing infrastructure
        │
        ▼
Story 2.18 (This Story) ─── Uses infrastructure for ongoing monitoring
```

**Note:** This story cannot begin until Story 2.13 Phase 2 is complete.

## Scope Notes

This story enhances existing change monitoring (2.11) with PDF fetching capabilities built by Story 2.13. It does NOT include:
- Historical backfill (covered by Story 2.13)
- UI for viewing amendment documents (separate story)
- EU legislation amendments (separate content type)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-10 | 0.1 | Initial story creation - enhancement to change monitoring using 2.13 infrastructure | Sarah (PO) |

## Dev Agent Record

_To be filled during implementation_

## QA Results

_To be filled by QA agent_
