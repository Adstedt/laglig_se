# Story 2.21: Section-Level Law Parsing

## Overview

Parse Swedish laws (SFS) into individual sections to enable:

- Section-level history tracking
- Automatic `old_text` population for amendments
- Direct linking to specific sections
- Granular search and cross-referencing

## Background

Currently `legal_documents.full_text` stores the entire law as one blob. To reconstruct historical versions when amendments are applied, we need to know what each section looked like _before_ the amendment. This requires parsing laws into their constituent sections.

## Dependencies

- Story 2.13 (Amendment Documents) - provides the amendment pipeline that will consume section data

## Data Model

### New Table: `legal_document_sections`

```prisma
model LegalDocumentSection {
  id              String   @id @default(cuid())
  document_id     String   // FK to legal_documents

  // Section reference
  chapter         String?  // "7" for "7 kap." or null
  section         String   // "15" or "2a"

  // Content
  heading         String?  // Section heading if present
  text            String   @db.Text

  // Metadata
  last_amended_by String?  // SFS number of last amendment, e.g., "2024:804"
  effective_from  DateTime?

  // Ordering
  sort_order      Int      @default(0)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  document        LegalDocument @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@unique([document_id, chapter, section])
  @@index([document_id])
  @@index([chapter, section])
  @@map("legal_document_sections")
}
```

## Implementation Phases

### Phase 1: HTML Structure Analysis

- Analyze Riksdagen API HTML structure for section markers
- Document parsing patterns for different law formats
- Handle edge cases (bilaga, övergångsbestämmelser, etc.)

### Phase 2: Section Parser

- Build parser that extracts sections from `html_content`
- Handle chapter structure (`X kap.`)
- Handle section numbering (`15 §`, `15 a §`, `15 b §`)
- Extract section headings where present

### Phase 3: Database Population

- Create migration for `legal_document_sections` table
- Script to parse existing laws and populate sections
- Start with high-priority laws (arbetsmiljölagen, etc.)

### Phase 4: Amendment Integration

- Update amendment ingestion to look up current section text
- Populate `old_text` in `section_changes` automatically
- Enable full version reconstruction

## Parsing Patterns

### Riksdagen HTML Structure (typical)

```html
<p class="LedKapitel">7 kap. Tillsyn</p>
<p class="LedParagraf">15 §</p>
<p class="LedParagrafText">Bestämmelser om marknadskontroll finns i...</p>
<p class="LedParagrafText">Den myndighet som regeringen bestämmer är...</p>
<p class="LedParagraf">16 §</p>
...
```

### Section Reference Patterns

| Pattern     | Example       | Chapter | Section   |
| ----------- | ------------- | ------- | --------- |
| Simple      | `15 §`        | null    | "15"      |
| With letter | `15 a §`      | null    | "15a"     |
| In chapter  | `7 kap. 15 §` | "7"     | "15"      |
| Bilaga      | `bilaga 2`    | null    | "bilaga2" |

## Edge Cases

1. **Transitional provisions** (Övergångsbestämmelser) - often unnumbered
2. **Appendices** (Bilagor) - tables, lists with special formatting
3. **Rubrics** - some sections have headings, others don't
4. **Historical formatting** - older laws may have different HTML structure
5. **Consolidated vs original** - Riksdagen provides consolidated (current) text

## Success Criteria

- [ ] 90%+ of sections correctly parsed for top 100 laws
- [ ] Section lookup by chapter + section number works
- [ ] Amendment ingestion automatically populates `old_text`
- [ ] Version reconstruction for any date possible

## Effort Estimate

- Phase 1: Research - 1-2 hours
- Phase 2: Parser - 3-4 hours
- Phase 3: Population - 2-3 hours
- Phase 4: Integration - 2-3 hours

## Future Enhancements

- Section-level embeddings for semantic search
- Direct URL linking to sections (e.g., `/lagar/1977:1160#7-15`)
- Section-level change notifications
- Cross-reference graph at section level

## Notes

- Start with laws that have amendments in our `amendment_documents` table
- arbetsmiljölagen (1977:1160) is a good test case - we have multiple amendments for it
- Consider caching parsed sections to avoid re-parsing on every sync
