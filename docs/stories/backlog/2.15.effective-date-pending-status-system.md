# Story 2.15: Effective Date & PENDING Status System

## Status

Draft

## Story

**As a** user viewing legal documents,
**I want** to see when laws enter into force and their current applicability status,
**So that** I understand whether a law's provisions are currently applicable or upcoming, and can prepare for future legal changes.

## Context

**Merged from:**

- `backlog/2.12.pending-law-status.md` (PENDING status enum, transition cron)
- `backlog/effective-date-badge-notifications.md` (effective date parsing, badges, notifications)

### Current State

- `LegalDocument.effective_date` field exists but is NOT populated during SFS ingestion
  - `scripts/ingest-sfs-laws.ts:345`: `effective_date: null, // TODO: Parse from transition provisions`
- `Amendment.effective_date` IS being parsed and populated
- All laws are ingested with `ACTIVE` status regardless of effective date
- `DocumentStatus` enum currently has: `ACTIVE`, `REPEALED`, `DRAFT`, `ARCHIVED`
- No `PENDING` status exists

### Riksdagen API Findings

The Riksdagen API does NOT have a dedicated `effective_date` field. Information is embedded in content:

**Modern documents (2024+):**

```
/Träder i kraft I:2026-03-18/
```

- Machine-readable ISO format in `summary`, `notis`, and full text
- Regex: `/Träder i kraft I:(\d{4}-\d{2}-\d{2})/`

**Older documents (pre-2024):**

```
Denna lag träder i kraft den 1 juli 1985.
```

- Natural language Swedish in "Övergångsbestämmelser" section
- Regex: `/träder i kraft den (\d{1,2}) (\w+) (\d{4})/i`

### API Fields Clarification

| Field        | Purpose                        | NOT effective date            |
| ------------ | ------------------------------ | ----------------------------- |
| `datum`      | SFS issue date (when numbered) | Different from effective date |
| `publicerad` | Database entry/update date     | Different from effective date |

## Acceptance Criteria

### AC1: Add PENDING Status to Enum

- [ ] Add `PENDING` to `DocumentStatus` enum in Prisma schema
- [ ] Run migration successfully
- [ ] Verify TypeScript types regenerated

### AC2: Parse Effective Date During Ingestion

- [ ] Update `scripts/ingest-sfs-laws.ts` to parse `effective_date` for new laws
- [ ] Try modern format first (`/Träder i kraft I:YYYY-MM-DD/`)
- [ ] Fall back to legacy Swedish format with month name parsing
- [ ] Handle Swedish month names (januari, februari, mars, april, maj, juni, juli, augusti, september, oktober, november, december)

### AC3: Set Status Based on Effective Date

- [ ] Set status to `PENDING` if `effective_date > today`
- [ ] Set status to `ACTIVE` if `effective_date <= today` (or null)
- [ ] Existing `REPEALED` detection unchanged

### AC4: Backfill Existing Laws

- [ ] Create script to parse effective dates for existing SFS laws
- [ ] Update status to `PENDING` for laws with future effective dates
- [ ] Verify example: "Subventionsbrottslag (2025:1267)" gets `PENDING` status

### AC5: UI Status Badge (SFS Law Pages)

- [ ] Update existing `StatusBadge` component to handle `PENDING` enum value
- [ ] Reuse existing blue "Ikraft {date}" styling (already implemented for `isNotYetInForce`)
- [ ] Remove runtime `isNotYetInForce` prop - use database `status === 'PENDING'` instead
- [ ] Badge shown on law detail pages and browse/catalogue cards

### AC6: Amendment History Badges

- [ ] Show "Träder i kraft {date}" badge on amendment rows when `Amendment.effective_date > today`
- [ ] Reuse existing badge styling pattern
- [ ] Hide badge when date has passed

### AC7: Automated Status Transition Cron

- [ ] Create Vercel cron job (runs daily at 00:00 UTC)
- [ ] Query `PENDING` laws where `effective_date <= today`
- [ ] Transition matching laws to `ACTIVE` status
- [ ] Log transitions for audit trail
- [ ] Monitor via Sentry Cron Monitoring

### AC8: Search/Browse Filter

- [ ] Add filter option "Kommande lagar" in browse/catalogue pages
- [ ] Filter shows only `status = PENDING` documents
- [ ] Default view includes all statuses

### AC9: Notification Hooks (Epic 8 Preparation)

- [ ] Create database query functions for upcoming effective dates
- [ ] Query laws in user's law lists with `effective_date` within configurable window (7, 30 days)
- [ ] Query amendments to followed laws with upcoming effective dates
- [ ] These queries will be used by Epic 8 notification system

## Tasks / Subtasks

- [ ] **Task 1: Schema Update** (AC: 1)
  - [ ] Add `PENDING` to `DocumentStatus` enum in `prisma/schema.prisma`
  - [ ] Run `pnpm prisma migrate dev --name add-pending-status`
  - [ ] Run `pnpm prisma generate` to update TypeScript types
  - [ ] Verify types in `@prisma/client`

- [ ] **Task 2: Create Effective Date Parser Utility** (AC: 2)
  - [ ] Create `lib/legal-document/effective-date-parser.ts`
  - [ ] Implement `parseEffectiveDate(fullText: string, summary?: string): Date | null`
  - [ ] Create Swedish month name mapping constant
  - [ ] Add unit tests in `tests/unit/lib/legal-document/effective-date-parser.test.ts`

- [ ] **Task 3: Update SFS Ingestion Script** (AC: 2, 3)
  - [ ] Import parser into `scripts/ingest-sfs-laws.ts`
  - [ ] Call parser with `fullText` and `summary` from API response
  - [ ] Set `effective_date` field in upsert
  - [ ] Set `status` based on effective date comparison

- [ ] **Task 4: Create Backfill Script** (AC: 4)
  - [ ] Create `scripts/backfill-effective-dates.ts`
  - [ ] Query all SFS laws with `effective_date: null`
  - [ ] Parse effective date from `full_text` or `html_content`
  - [ ] Update `effective_date` and `status` fields
  - [ ] Add progress logging and error handling
  - [ ] Test on "Subventionsbrottslag (2025:1267)"

- [ ] **Task 5: Refactor StatusBadge Component** (AC: 5)
  - [ ] Extract inline `StatusBadge` from `app/(workspace)/browse/lagar/[id]/page.tsx` to shared component
  - [ ] Add `PENDING` to statusConfig (reuse existing blue "Ikraft" styling)
  - [ ] Change logic: use `status === 'PENDING'` instead of `isNotYetInForce` prop
  - [ ] Remove `isNotYetInForce` prop from component signature
  - [ ] Update both workspace and public law pages to use refactored component

- [ ] **Task 6: Update Browse/Catalogue Cards** (AC: 5)
  - [ ] Import shared `StatusBadge` component
  - [ ] Pass `status` and `effective_date` from database (no runtime parsing)

- [ ] **Task 7: Amendment History Badges** (AC: 6)
  - [ ] Add effective date badge to amendment rows (reuse existing pattern)
  - [ ] Display only when `effective_date > today`
  - [ ] Existing amendment section already has date display - add badge styling

- [ ] **Task 8: Create Status Transition Cron** (AC: 7)
  - [ ] Create `app/api/cron/transition-pending-laws/route.ts`
  - [ ] Query: `WHERE status = 'PENDING' AND effective_date <= NOW()`
  - [ ] Update status to `ACTIVE`
  - [ ] Log transitions with Sentry
  - [ ] Add to `vercel.json` cron configuration

- [ ] **Task 9: Add Browse Filter** (AC: 8)
  - [ ] Add "Kommande lagar" filter option to catalogue filters
  - [ ] Update filter state and query logic
  - [ ] Test filter functionality

- [ ] **Task 10: Create Notification Query Functions** (AC: 9)
  - [ ] Create `lib/db/queries/upcoming-effective-dates.ts`
  - [ ] Implement `getUpcomingLawsForWorkspace(workspaceId, daysAhead)`
  - [ ] Implement `getUpcomingAmendmentsForWorkspace(workspaceId, daysAhead)`
  - [ ] Add JSDoc documentation for Epic 8 usage

## Dev Notes

### Existing Code to Reuse

**StatusBadge (inline in law page):**
Location: `app/(workspace)/browse/lagar/[id]/page.tsx:524-560`

Already handles "not yet in force" with blue styling:

```typescript
if (isNotYetInForce && effectiveDate) {
  return (
    <Badge variant="outline" className="border-blue-200 text-blue-700...">
      Ikraft {effectiveDate}
    </Badge>
  )
}
```

**Effective Date Parsing (runtime):**
Location: `app/(workspace)/browse/lagar/[id]/page.tsx:140-161`

Already extracts from HTML:

```typescript
const effectiveDateMatch = firstSection.match(
  /\/Träder i kraft I:(\d{4})-(\d{2})-(\d{2})(?:\/|<)/
)
```

**NotYetInForceBanner:**
Location: `components/features/law/index.ts` (exported)

Shows prominent banner for upcoming laws - can continue to use alongside badge.

**Refactoring Strategy:**

1. Extract parsing logic to `lib/legal-document/effective-date-parser.ts` for reuse in ingestion
2. Extract `StatusBadge` to shared component
3. Add `PENDING` to enum and use database status instead of runtime `isNotYetInForce`
4. Keep `NotYetInForceBanner` as-is (it reads from HTML metadata, can migrate later)

### Schema Changes

[Source: prisma/schema.prisma:226]

```prisma
enum DocumentStatus {
  ACTIVE
  PENDING    // NEW - law not yet in force
  REPEALED
  DRAFT
  ARCHIVED
}
```

The `LegalDocument` model already has:

- `effective_date DateTime?` - Currently NULL for SFS laws
- `status DocumentStatus @default(ACTIVE)` - Needs PENDING option

### Effective Date Parser Implementation

[Source: backlog/effective-date-badge-notifications.md]

```typescript
// lib/legal-document/effective-date-parser.ts
const SWEDISH_MONTHS: Record<string, number> = {
  januari: 0,
  februari: 1,
  mars: 2,
  april: 3,
  maj: 4,
  juni: 5,
  juli: 6,
  augusti: 7,
  september: 8,
  oktober: 9,
  november: 10,
  december: 11,
}

export function parseEffectiveDate(
  fullText: string,
  summary?: string
): Date | null {
  const textToSearch = `${summary || ''} ${fullText}`

  // Modern format (2024+): "/Träder i kraft I:2026-03-18/"
  const modernMatch = textToSearch.match(/Träder i kraft I:(\d{4}-\d{2}-\d{2})/)
  if (modernMatch) {
    return new Date(modernMatch[1])
  }

  // Legacy format: "träder i kraft den 1 juli 1985"
  const legacyMatch = textToSearch.match(
    /träder i kraft den (\d{1,2}) (\w+) (\d{4})/i
  )
  if (legacyMatch) {
    const day = parseInt(legacyMatch[1], 10)
    const month = SWEDISH_MONTHS[legacyMatch[2].toLowerCase()]
    const year = parseInt(legacyMatch[3], 10)

    if (month !== undefined) {
      return new Date(year, month, day)
    }
  }

  return null
}
```

### File Locations

[Source: architecture/12-unified-project-structure.md]

| File                                            | Status | Purpose                                                           |
| ----------------------------------------------- | ------ | ----------------------------------------------------------------- |
| `prisma/schema.prisma`                          | MODIFY | Add PENDING to LawStatus enum                                     |
| `lib/legal-document/effective-date-parser.ts`   | NEW    | Extract parsing logic from page component                         |
| `scripts/ingest-sfs-laws.ts`                    | MODIFY | Use parser, set effective_date and status                         |
| `scripts/backfill-effective-dates.ts`           | NEW    | Backfill existing laws                                            |
| `components/features/law/status-badge.tsx`      | NEW    | Extract from `app/(workspace)/browse/lagar/[id]/page.tsx:524-560` |
| `app/(workspace)/browse/lagar/[id]/page.tsx`    | MODIFY | Import shared StatusBadge, remove inline version                  |
| `app/(public)/lagar/[id]/page.tsx`              | MODIFY | Import shared StatusBadge                                         |
| `app/api/cron/transition-pending-laws/route.ts` | NEW    | Status transition cron                                            |
| `lib/db/queries/upcoming-effective-dates.ts`    | NEW    | Notification queries for Epic 8                                   |

### Cron Job Configuration

[Source: architecture/3-tech-stack.md#Background Jobs]

```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/transition-pending-laws",
      "schedule": "0 0 * * *"
    }
  ]
}
```

### UI Component Styling

[Source: app/(workspace)/browse/lagar/[id]/page.tsx:536-541]

Use existing blue styling from current `isNotYetInForce` implementation (keep for consistency):

```typescript
// PENDING status badge - reuse existing blue styling
<Badge variant="outline" className="border-blue-200 text-blue-700 dark:border-blue-800 dark:text-blue-400">
  Ikraft {formatDate(effectiveDate, 'sv-SE')}
</Badge>
```

**Note:** Existing implementation uses blue styling. Keep this for visual consistency with current law pages.

### Date Formatting

[Source: architecture/3-tech-stack.md#Date/Time Formatting]

Use `date-fns` with Swedish locale:

```typescript
import { format } from 'date-fns'
import { sv } from 'date-fns/locale'

format(effectiveDate, 'd MMMM yyyy', { locale: sv })
// Output: "1 juli 2026"
```

### Notification Query Pattern

[Source: architecture/9-database-schema.md#9.9]

```typescript
// Upcoming laws entering force (for law list items)
const upcomingLaws = await prisma.legalDocument.findMany({
  where: {
    effective_date: {
      gt: new Date(),
      lte: addDays(new Date(), 30),
    },
    law_list_items: {
      some: {
        law_list: {
          workspace_id: workspaceId,
        },
      },
    },
  },
})
```

### Testing

**Test File Locations:**

- `tests/unit/lib/legal-document/effective-date-parser.test.ts` - Parser unit tests
- `tests/unit/api/cron/transition-pending-laws.test.ts` - Cron job unit tests

**Test Framework:** Vitest
[Source: architecture/3-tech-stack.md#Frontend Testing]

**Parser Tests:**

```typescript
// tests/unit/lib/legal-document/effective-date-parser.test.ts
import { describe, it, expect } from 'vitest'
import { parseEffectiveDate } from '@/lib/legal-document/effective-date-parser'

describe('parseEffectiveDate', () => {
  it('parses modern ISO format', () => {
    const text = '/Träder i kraft I:2026-03-18/'
    expect(parseEffectiveDate(text)).toEqual(new Date(2026, 2, 18))
  })

  it('parses legacy Swedish format', () => {
    const text = 'Denna lag träder i kraft den 1 juli 1985.'
    expect(parseEffectiveDate(text)).toEqual(new Date(1985, 6, 1))
  })

  it('returns null when no date found', () => {
    expect(parseEffectiveDate('No date here')).toBeNull()
  })

  it('handles edge case: invalid month name', () => {
    const text = 'träder i kraft den 1 foobar 2025'
    expect(parseEffectiveDate(text)).toBeNull()
  })
})
```

**Cron Job Tests:**

```typescript
// tests/unit/api/cron/transition-pending-laws.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { prisma } from '@/lib/db'

describe('transition-pending-laws cron', () => {
  beforeEach(() => {
    vi.useFakeTimers()
    vi.setSystemTime(new Date('2025-07-01'))
  })

  it('transitions PENDING laws with past effective_date to ACTIVE', async () => {
    // Mock prisma.legalDocument.updateMany
    const updateManySpy = vi.spyOn(prisma.legalDocument, 'updateMany')

    // Execute cron logic
    // ... test implementation

    expect(updateManySpy).toHaveBeenCalledWith({
      where: {
        status: 'PENDING',
        effective_date: { lte: expect.any(Date) },
      },
      data: { status: 'ACTIVE' },
    })
  })

  it('does not transition laws with future effective_date', async () => {
    // Test that laws with effective_date > today remain PENDING
  })
})
```

**Test Patterns:**

- Unit tests for `parseEffectiveDate()` with both formats
- Edge cases: missing dates, malformed dates, invalid month names
- Cron job: mock Prisma, verify correct WHERE clause and status update
- Integration: verify end-to-end flow with test database (optional)

## Dependencies

- **Depends on:** Story 2.2 (SFS Ingestion) - Complete
- **Blocks:** Epic 8 (Change Monitoring & Notifications) - notification triggers depend on this data

## Estimation

**Story Points:** 2 (Reduced from 3 - significant code reuse from existing implementation)

## Change Log

| Date       | Version | Description                                                                             | Author     |
| ---------- | ------- | --------------------------------------------------------------------------------------- | ---------- |
| 2025-12-25 | 1.0     | Merged from 2.12.pending-law-status.md and effective-date-badge-notifications.md        | Bob (SM)   |
| 2025-12-25 | 1.1     | Updated to leverage existing StatusBadge and parsing code; reduced scope                | Bob (SM)   |
| 2025-12-25 | 1.2     | PO validation fixes: LawStatus→DocumentStatus, clarified blue styling, added cron tests | Sarah (PO) |
