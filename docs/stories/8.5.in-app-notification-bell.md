# Story 8.5: Implement In-App Notification Bell

## Status
Draft

## Story

**As a** user,
**I want** to see a notification bell with unacknowledged change count,
**so that** I know at a glance if there are updates.

## Acceptance Criteria

1. Bell icon in top navigation bar (next to profile menu)
2. Red badge with unacknowledged count (e.g., "3")
3. Badge disappears when count = 0
4. Clicking bell opens dropdown showing last 5 changes
5. Dropdown displays for each change:
   - Priority badge (ðŸ”´/ðŸŸ¡/ðŸŸ¢)
   - Law title (truncated to 50 chars)
   - "Detected [X] days ago"
   - Hover to see full law title
6. Click on change â†’ Opens Changes tab, scrolls to that change
7. "View All Changes" link at bottom of dropdown
8. Real-time updates: Poll every 5 minutes for new changes
9. Dropdown closes when clicking outside
10. Empty state: "No new changes âœ…"
11. Badge color: Red (urgent, >3 high-priority), Orange (medium-priority), Blue (low-priority only)

## Tasks / Subtasks

- [ ] Create NotificationBell component
- [ ] Implement unacknowledged count API endpoint
- [ ] Build dropdown with last 5 changes
- [ ] Add polling logic (every 5 minutes)
- [ ] Implement click-to-open change link
- [ ] Style badge with dynamic color based on priority
- [ ] Add "View All Changes" link
- [ ] Handle empty state
- [ ] Implement click-outside-to-close behavior
- [ ] Test real-time updates
- [ ] Test on mobile (drawer instead of dropdown)
- [ ] Add loading skeleton while fetching

## Dev Notes

**API Endpoint for Unacknowledged Count:**
```typescript
// app/api/law-changes/unacknowledged-count/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'

export async function GET(request: Request) {
  return withWorkspace(async ({ workspaceId }) => {
    const count = await prisma.lawChange.count({
      where: {
        law: {
          workspaceLaws: {
            some: { workspaceId }
          }
        },
        acknowledgedAt: null
      }
    })

    // Count by priority for badge color logic
    const priorityCounts = await prisma.lawChange.groupBy({
      by: ['priority'],
      where: {
        law: {
          workspaceLaws: {
            some: { workspaceId }
          }
        },
        acknowledgedAt: null
      },
      _count: true
    })

    const highPriorityCount = priorityCounts.find((p) => p.priority === 'high')?._count || 0
    const mediumPriorityCount = priorityCounts.find((p) => p.priority === 'medium')?._count || 0

    return NextResponse.json({
      total: count,
      highPriority: highPriorityCount,
      mediumPriority: mediumPriorityCount
    })
  })
}
```

**API Endpoint for Recent Changes:**
```typescript
// app/api/law-changes/recent/route.ts
import { NextResponse } from 'next/server'
import { withWorkspace } from '@/lib/auth/with-workspace'
import { prisma } from '@/lib/prisma'

export async function GET(request: Request) {
  return withWorkspace(async ({ workspaceId }) => {
    const changes = await prisma.lawChange.findMany({
      where: {
        law: {
          workspaceLaws: {
            some: { workspaceId }
          }
        },
        acknowledgedAt: null
      },
      include: {
        law: {
          select: {
            id: true,
            sfsNummer: true,
            rubrik: true
          }
        }
      },
      orderBy: [
        { priority: 'desc' },
        { detectedAt: 'desc' }
      ],
      take: 5
    })

    return NextResponse.json(changes)
  })
}
```

**NotificationBell Component:**
```typescript
// components/layout/notification-bell.tsx
'use client'

import { useEffect, useState, useRef } from 'react'
import { useRouter } from 'next/navigation'

interface NotificationCounts {
  total: number
  highPriority: number
  mediumPriority: number
}

interface RecentChange {
  id: string
  priority: 'high' | 'medium' | 'low'
  detectedAt: string
  law: {
    id: string
    sfsNummer: string
    rubrik: string
  }
}

const PRIORITY_EMOJI = {
  high: 'ðŸ”´',
  medium: 'ðŸŸ¡',
  low: 'ðŸŸ¢'
}

export function NotificationBell() {
  const [isOpen, setIsOpen] = useState(false)
  const [counts, setCounts] = useState<NotificationCounts | null>(null)
  const [recentChanges, setRecentChanges] = useState<RecentChange[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const dropdownRef = useRef<HTMLDivElement>(null)
  const router = useRouter()

  // Fetch counts
  async function fetchCounts() {
    try {
      const response = await fetch('/api/law-changes/unacknowledged-count')
      const data = await response.json()
      setCounts(data)
    } catch (error) {
      console.error('Failed to fetch notification counts:', error)
    }
  }

  // Fetch recent changes when dropdown opens
  async function fetchRecentChanges() {
    setIsLoading(true)
    try {
      const response = await fetch('/api/law-changes/recent')
      const data = await response.json()
      setRecentChanges(data)
    } catch (error) {
      console.error('Failed to fetch recent changes:', error)
    } finally {
      setIsLoading(false)
    }
  }

  // Poll every 5 minutes
  useEffect(() => {
    fetchCounts()
    const interval = setInterval(fetchCounts, 5 * 60 * 1000) // 5 minutes
    return () => clearInterval(interval)
  }, [])

  // Fetch recent changes when opening dropdown
  useEffect(() => {
    if (isOpen) {
      fetchRecentChanges()
    }
  }, [isOpen])

  // Click outside to close
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside)
    }

    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [isOpen])

  // Determine badge color
  const badgeColor =
    counts && counts.highPriority > 3
      ? 'bg-red-600'
      : counts && counts.mediumPriority > 0
      ? 'bg-orange-500'
      : 'bg-blue-600'

  function handleChangeClick(changeId: string, lawId: string) {
    setIsOpen(false)
    router.push(`/laws/${lawId}/changes/${changeId}`)
  }

  function formatRelativeTime(dateString: string): string {
    const date = new Date(dateString)
    const now = new Date()
    const diffMs = now.getTime() - date.getTime()
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

    if (diffDays === 0) return 'Today'
    if (diffDays === 1) return 'Yesterday'
    return `${diffDays} days ago`
  }

  if (counts === null) return null // Still loading

  return (
    <div className="relative" ref={dropdownRef}>
      {/* Bell Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="relative p-2 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"
        aria-label="Notifications"
      >
        {/* Bell Icon */}
        <svg
          className="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
          />
        </svg>

        {/* Badge */}
        {counts.total > 0 && (
          <span
            className={`absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 ${badgeColor} rounded-full`}
          >
            {counts.total > 99 ? '99+' : counts.total}
          </span>
        )}
      </button>

      {/* Dropdown */}
      {isOpen && (
        <div className="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
          {/* Header */}
          <div className="px-4 py-3 border-b border-gray-200">
            <h3 className="text-sm font-semibold text-gray-900">Notifications</h3>
            {counts.total > 0 && (
              <p className="text-xs text-gray-600 mt-1">
                {counts.total} unacknowledged {counts.total === 1 ? 'change' : 'changes'}
              </p>
            )}
          </div>

          {/* Changes List */}
          <div className="max-h-96 overflow-y-auto">
            {isLoading ? (
              <div className="px-4 py-8 text-center">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
              </div>
            ) : recentChanges.length === 0 ? (
              <div className="px-4 py-8 text-center">
                <svg
                  className="mx-auto h-12 w-12 text-green-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <p className="text-sm text-gray-600 mt-2">No new changes âœ…</p>
              </div>
            ) : (
              recentChanges.map((change) => (
                <button
                  key={change.id}
                  onClick={() => handleChangeClick(change.id, change.law.id)}
                  className="w-full px-4 py-3 hover:bg-gray-50 border-b border-gray-100 text-left transition-colors"
                >
                  <div className="flex items-start gap-3">
                    <span className="text-lg flex-shrink-0">
                      {PRIORITY_EMOJI[change.priority]}
                    </span>
                    <div className="flex-1 min-w-0">
                      <p
                        className="text-sm font-medium text-gray-900 truncate"
                        title={`${change.law.sfsNummer}: ${change.law.rubrik}`}
                      >
                        {change.law.sfsNummer}: {change.law.rubrik}
                      </p>
                      <p className="text-xs text-gray-500 mt-1">
                        Detected {formatRelativeTime(change.detectedAt)}
                      </p>
                    </div>
                  </div>
                </button>
              ))
            )}
          </div>

          {/* Footer */}
          {counts.total > 0 && (
            <div className="px-4 py-3 border-t border-gray-200">
              <button
                onClick={() => {
                  setIsOpen(false)
                  router.push('/laws/changes')
                }}
                className="w-full text-center text-sm font-medium text-blue-600 hover:text-blue-700"
              >
                View All Changes
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  )
}
```

**Add to Layout:**
```typescript
// components/layout/header.tsx
import { NotificationBell } from './notification-bell'

export function Header() {
  return (
    <header className="bg-white border-b border-gray-200">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-center h-16">
          {/* Logo */}
          <div className="flex items-center">
            <h1 className="text-xl font-bold text-blue-600">Laglig.se</h1>
          </div>

          {/* Right Side: Notification Bell + Profile */}
          <div className="flex items-center gap-4">
            <NotificationBell />
            <ProfileMenu />
          </div>
        </div>
      </div>
    </header>
  )
}
```

**Mobile Version (Drawer):**
```typescript
// For mobile, replace dropdown with full-screen drawer
// Use media query or window width detection

{isMobile ? (
  <div className="fixed inset-0 bg-black bg-opacity-50 z-50">
    <div className="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[80vh] overflow-y-auto">
      {/* Same content as dropdown */}
    </div>
  </div>
) : (
  <div className="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
    {/* Desktop dropdown */}
  </div>
)}
```

**Reference:** PRD Epic 8 Story 8.5

## Testing

**Unit Tests:**
- Badge displays correct count
- Badge disappears when count = 0
- Badge color changes based on priority (red/orange/blue)
- Dropdown shows last 5 changes
- Empty state displays when no changes
- Click outside closes dropdown

**Integration Tests:**
- API returns correct unacknowledged count
- API returns last 5 changes ordered by priority
- Polling fetches new counts every 5 minutes
- Click on change navigates to diff view
- "View All Changes" navigates to Changes tab

**Manual Testing:**
- Create unacknowledged changes, verify badge shows count
- Click bell, verify dropdown opens
- Click outside, verify dropdown closes
- Acknowledge all changes, verify badge disappears
- Wait 5 minutes, verify badge updates with new changes
- Test on mobile, verify drawer behavior
- Hover on truncated law title, verify full title shows

**Performance Testing:**
- Count API responds <300ms
- Recent changes API responds <500ms
- Polling doesn't cause UI lag
- Dropdown opens smoothly (<100ms)

**Edge Cases:**
- 0 unacknowledged changes (no badge, empty state)
- 100+ unacknowledged changes (badge shows "99+")
- Very long law titles (truncate to 50 chars)
- Polling fails (show cached count, retry)
- User with no workspace (hide bell)

**Accessibility Testing:**
- Bell button has aria-label
- Keyboard navigation works (Tab, Enter, Escape)
- Screen reader announces badge count
- Focus management when opening/closing dropdown

**Test File:** `__tests__/features/notifications/notification-bell.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Check notification bell regularly for new changes
- Click to review changes promptly
- Mark changes as reviewed to clear notifications

**Developer Responsibility:**
- Display accurate unacknowledged count in real-time
- Poll for updates every 5 minutes without impacting performance
- Show last 5 most important changes (prioritized)
- Provide clear navigation to full Changes tab
- Make dropdown accessible and keyboard-navigable
- Handle loading states gracefully
- Implement click-outside-to-close behavior
- Optimize API calls to avoid rate limiting
- Cache counts between polls
- Provide visual feedback for priority urgency (badge colors)
- Make mobile-friendly with drawer instead of dropdown

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
