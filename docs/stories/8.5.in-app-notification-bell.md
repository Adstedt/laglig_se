# Story 8.5: Implement In-App Notification Bell

## Status

Draft (v2 — rewritten to align with actual data model and notification infrastructure)

## Story

**As a** workspace member,
**I want** to see a notification bell with a count of unacknowledged law changes,
**so that** I know at a glance if there are amendment updates requiring my review.

## Context & Dependencies

**Builds on:**

- `Notification` model — existing in-app notification system with `type`, `entity_type`, `entity_id`, `read_at`
- `NotificationType` enum — existing: TASK_ASSIGNED, TASK_DUE_SOON, COMMENT_ADDED, MENTION, etc.
- `ChangeEvent` model — amendment changes detected by `sync-sfs-updates`
- `NotificationPreference` model — per-workspace notification settings with `email_enabled`, per-type toggles
- Story 8.1 (Changes Tab) — the destination when clicking through from bell

**Depends on:**

- Story 8.4 (notify-amendment-changes cron creates Notification records as part of email flow)
- Story 8.1 (Changes Tab must exist as navigation target)

**Deferred from Story 8.4:**

Story 8.4 noted: "Story 8.5: In-app notification bell (needs same data model alignment)" — this story now provides that alignment.

## Acceptance Criteria

### Notification Bell Component

1. Bell icon in top navigation bar (right side, next to profile menu)
2. Red badge showing unread notification count (from `Notification` where `read_at IS NULL`)
3. Badge disappears when count = 0
4. Clicking bell opens dropdown showing last 5 unread notifications
5. Each notification in dropdown shows:
   - Change type icon (amendment, repeal, etc.)
   - Base law title (truncated to 50 chars, full title on hover)
   - Amendment SFS number
   - Relative time: "2 timmar sedan"
6. Click on notification → navigates to Changes tab, marks notification as read (`read_at = NOW()`)
7. "Visa alla ändringar" link at bottom → navigates to Changes tab
8. Dropdown closes when clicking outside
9. Empty state: "Inga nya ändringar"

### Notification Creation

10. When `notify-amendment-changes` cron (Story 8.4) sends emails, also create `Notification` records for each affected user:
    - `type: 'LAW_CHANGE'` (new enum value to add to `NotificationType`)
    - `entity_type: 'change_event'`, `entity_id: changeEvent.id`
    - `title`: Amendment title
    - `message`: Summering snippet (first 100 chars)
11. Respect `NotificationPreference` — skip notification creation if user has disabled amendment notifications

### Real-Time Updates

12. Poll for new notification count every 5 minutes (simple `setInterval` fetch)
13. Update badge count without full page reload

## Tasks / Subtasks

- [ ] **Task 1: Add LAW_CHANGE to NotificationType enum** (AC: 10)
  - [ ] Prisma schema migration
- [ ] **Task 2: Create Notification records in notification cron** (AC: 10, 11)
  - [ ] Extend `notify-amendment-changes` cron (Story 8.4) to create `Notification` records alongside emails
  - [ ] Check `NotificationPreference` before creating
- [ ] **Task 3: Build NotificationBell component** (AC: 1, 2, 3, 8, 9)
  - [ ] Bell icon with badge (shadcn/ui)
  - [ ] Unread count query: `Notification.count({ where: { user_id, read_at: null } })`
  - [ ] Click-outside-to-close behavior
- [ ] **Task 4: Build notification dropdown** (AC: 4, 5, 6, 7)
  - [ ] Fetch last 5 unread notifications
  - [ ] Render notification items with law title, SFS number, relative time
  - [ ] Click handler: mark as read + navigate
  - [ ] "View All" link
- [ ] **Task 5: Polling for real-time updates** (AC: 12, 13)
  - [ ] API route for unread count: `app/api/notifications/unread-count/route.ts`
  - [ ] Client-side polling every 5 minutes
- [ ] **Task 6: Add bell to layout** (AC: 1)
  - [ ] Insert NotificationBell into existing header/nav component

## Dev Notes

### Source Tree (relevant files)

```
prisma/schema.prisma                         — Notification, NotificationType, NotificationPreference
app/api/cron/notify-amendment-changes/       — Story 8.4 cron (extend to create Notification records)
components/layout/                           — Existing header/nav components
```

### Key Data Models

```
Notification (existing)
  ├─ user_id → User
  ├─ workspace_id → Workspace
  ├─ type: NotificationType (add LAW_CHANGE)
  ├─ title: String
  ├─ message: String?
  ├─ entity_type: String   ("change_event")
  ├─ entity_id: String     (ChangeEvent.id)
  ├─ read_at: DateTime?    ← null = unread
  └─ created_at

NotificationPreference (existing, per workspace)
  ├─ user_id, workspace_id
  ├─ email_enabled: Boolean
  └─ (extend with amendment-specific toggle in Story 8.11)
```

### Unread Count API

```typescript
// app/api/notifications/unread-count/route.ts
// Simple count query for polling
const count = await prisma.notification.count({
  where: { user_id: session.user.id, read_at: null }
})
```

### Notification Creation in Cron

```typescript
// In notify-amendment-changes cron, after sending email:
await prisma.notification.create({
  data: {
    user_id: user.id,
    workspace_id: workspace.id,
    type: 'LAW_CHANGE',
    title: amendment.title,
    message: amendmentLegalDoc.summary?.substring(0, 100),
    entity_type: 'change_event',
    entity_id: changeEvent.id,
  }
})
```

### UI Standards

- shadcn/ui DropdownMenu or Popover for bell dropdown
- shadcn/ui Badge for count
- Client component (needs polling + click handlers)
- Use `useSWR` or `useEffect` + `fetch` for polling

## Testing

**Test location:** `tests/unit/components/layout/notification-bell.test.tsx`

**Test framework:** Vitest with React Testing Library

**Unit tests:**
- Badge displays correct unread count
- Badge hidden when count = 0
- Dropdown shows last 5 notifications
- Click on notification marks as read
- Empty state renders correctly
- Click-outside closes dropdown

**Integration tests:**
- Notification cron creates Notification records for affected users
- Unread count API returns correct number
- Polling updates count without page reload

## Change Log

| Date       | Version | Description                                                    | Author     |
| ---------- | ------- | -------------------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                                         | Sarah (PO) |
| 2026-02-09 | 2.0     | Major rewrite: align with existing Notification model, ChangeEvent, NotificationPreference | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
