# Story 2.29: Amendment Document Pages

## Status

In Progress - LLM Workflow Refactor

## Story

**As a** legal researcher or compliance officer,
**I want** amendments (ändringsförfattningar) to have their own browsable, searchable pages,
**so that** I can directly access, search for, and link to specific amendments by their SFS number, and understand how they relate to base laws.

## Dependencies

- **Story 2.28** (Unified SFS Sync with Document Classification) - Provides populated `AmendmentDocument` records with PDFs and parsed content
- **Story 2.13** (Amendment Documents & Historical Versions) - Base infrastructure for amendment handling

## Acceptance Criteria

1. Each amendment stored in `AmendmentDocument` has a corresponding `LegalDocument` entry with `content_type: SFS_AMENDMENT`
2. Amendment pages are accessible via URL (e.g., `/lagar/andringar/sfs-2022-1109` or similar pattern)
3. Amendment pages display:
   - Title (e.g., "Lag (2022:1109) om ändring i arbetsmiljölagen (1977:1160)")
   - SFS number with badge
   - Link back to base law with visual prominence
   - Effective date and publication date
   - List of changed sections with change type (added/amended/repealed)
   - PDF download link
   - Full text rendered via HTML content (LLM-generated from PDF)
4. Amendments appear in the catalogue/browse pages with ability to filter by document type
5. Amendments are searchable (title, SFS number, full text)
6. Base law pages display links to their amendment pages in the "Ändringar" section
7. Amendment pages follow the same visual design language as law pages (consistent UX)
8. Works in both public and workspace contexts

## Tasks / Subtasks

### Completed: UI & Page Infrastructure (AC: 1-8)

- [x] **Database & Data Model** (AC: 1)
  - [x] Create migration script to generate `LegalDocument` entries from existing `AmendmentDocument` records
  - [x] Add `amendment_document_id` field to `LegalDocument.metadata` for linking
  - [x] Create slug generation function for amendments (`lag-om-andring-i-{base-law-slug}-{year}-{number}`)
  - [x] Update sync-sfs-updates cron to create LegalDocument entries when creating AmendmentDocuments

- [x] **Amendment Page Route & Component** (AC: 2, 3, 7)
  - [x] Create route `app/(public)/lagar/andringar/[id]/page.tsx`
  - [x] Create route `app/(workspace)/browse/lagar/andringar/[id]/page.tsx`
  - [x] Handle 404 for invalid amendment slugs (use `notFound()` from next/navigation)
  - [x] Build `AmendmentPageContent` component with HTML/markdown rendering
  - [x] Reuse existing theme system (`getDocumentTheme('SFS_AMENDMENT')`)
  - [x] Add SEO metadata generation with descriptive meta description

- [x] **Catalogue Integration** (AC: 4)
  - [x] Update browse API to include `SFS_AMENDMENT` content type
  - [x] Add filter chip/toggle for "Visa ändringsförfattningar" in catalogue

- [x] **Search Integration** (AC: 5)
  - [x] Add amendments to search index (same as other document types)

- [x] **Base Law Page Updates** (AC: 6)
  - [x] Update history page timeline to link to amendment pages
  - [x] Add "Visa ändringsförfattning" link in `VersionByVersionTimeline` component

- [x] **Unit Testing**
  - [x] Unit tests for slug generation (12 tests)
  - [x] Unit tests for LegalDocument creation from AmendmentDocument

### Pending: LLM Content Processing Pipeline

- [x] **Phase 1: Schema & Infrastructure**
  - [x] Database migration: Add `markdown_content` and `json_content` columns to `legal_documents`
  - [x] Create `lib/sfs/amendment-llm-prompt.ts` - Production prompt for Sonnet Vision
  - [x] Create `scripts/batch-process-amendments.ts` - Batch API processing script
  - [x] Create `lib/transforms/html-to-markdown.ts` - Deterministic HTML → Markdown converter
  - [x] Create `lib/transforms/html-to-json.ts` - Deterministic HTML → JSON parser
  - [x] Create `lib/sfs/llm-output-validator.ts` - Validate and clean LLM output

- [ ] **Phase 2: Amendment Processing (~35k documents)**
  - [x] Test batch submitted (10 documents) - all succeeded, validated pipeline end-to-end
  - [x] Fixed batch script: PDF content type (`type: 'document'`), custom_id format, upsert logic
  - [x] Verified: html_content, markdown_content, json_content populated for test batch
  - [x] **Migration complete:** 34,508 AmendmentDocument → LegalDocument records (content_type: SFS_AMENDMENT)
  - [ ] Review & refine markdown/JSON transforms based on test batch output
  - [ ] Submit production batch for all amendment PDFs (~$1,400 via Anthropic Batch API)
  - [ ] Monitor batch completion and download results (~24h turnaround)
  - [ ] Process results and verify quality
  - [ ] Ensure `Amendment.amending_document_id` is populated for all entries
  - [ ] Quality review: Sample 50-100 outputs for accuracy

- [ ] **Phase 3: Backfill Existing Documents**
  - [ ] Base Laws: Generate `markdown_content` and `json_content` from existing `html_content`
  - [ ] Court Cases: Same backfill process
  - [ ] EU Documents: Same backfill process

- [ ] **Phase 4: E2E Testing**
  - [ ] E2E test: Navigate from base law → history → amendment page → back to base law
  - [ ] E2E test: Search for amendment by SFS number, click through to page
  - [ ] E2E test: Filter catalogue by amendments
  - [ ] E2E test: Verify HTML content renders correctly on amendment pages

## Technical Decisions

### Decision 1: LLM-Based PDF → HTML Conversion

**Decision:** Use Claude Sonnet Vision via Batch API for PDF → HTML conversion.

**Rationale:**
- Regex-based parsing proved brittle - required 11+ iterations and still had edge cases
- PDF text extraction loses structure; LLM can interpret visual layout directly
- Sonnet quality matches Opus for text accuracy at 1/5 the cost
- Minor formatting issues (definition list splitting) can be fixed via post-processing

**Cost Analysis (35,000 amendment documents):**

| Model | Input Tokens | Output Tokens | Batch Cost (50% discount) |
|-------|--------------|---------------|---------------------------|
| Sonnet | ~420M | ~105M | ~$1,500 |
| Opus | ~420M | ~105M | ~$7,500 |

### Decision 2: HTML as Single Source of Truth

**Decision:** All document types use HTML as the primary stored format.

**Document Sources:**

| Source | Format from API | LLM Needed? |
|--------|-----------------|-------------|
| Base Laws | HTML (Riksdagen API) | ❌ No |
| Court Cases | HTML (Domstol API) | ❌ No |
| EU Documents | HTML (EUR-Lex API) | ❌ No |
| **Amendments** | **PDF only** | ✅ Yes → HTML |

**Flow:**
```
Base Laws      ────► HTML ────┐
Court Cases    ────► HTML ────┼────► legal_documents.html_content (SSOT)
EU Documents   ────► HTML ────┤
Amendments     ────► PDF ─────┘
                      │
                      ▼
               Claude Sonnet Vision
                      │
                      ▼
                    HTML ──────────────────────────┐
                                                   │
                                           Deterministic Transform
                                                   │
                                                   ├──► markdown_content (for Chat/RAG)
                                                   └──► json_content (for structured queries)
```

### Decision 3: Three-Format Storage

**Decision:** Store HTML, Markdown, and JSON in `legal_documents` table.

**Schema additions:**
```prisma
model LegalDocument {
  // ... existing fields ...
  full_text        String?   @db.Text  // Plain text - for search index, embeddings
  html_content     String?   @db.Text  // SSOT - LLM-generated or API-sourced HTML
  markdown_content String?   @db.Text  // NEW - derived from HTML, for Chat/RAG
  json_content     Json?               // NEW - derived from HTML, for structured queries
}
```

**Purpose of each format:**

| Column | Content | Primary Use |
|--------|---------|-------------|
| `full_text` | Plain text (no markup) | Search indexing, embeddings, change diffs |
| `html_content` | Semantic HTML | **SSOT** - Page rendering |
| `markdown_content` | Markdown | Chat/RAG context (readable, no HTML noise) |
| `json_content` | Structured JSON | Programmatic access, structured queries |

**Derivation is one-way:** HTML is source of truth; Markdown and JSON are deterministic transforms (no extra LLM cost).

### Decision 4: Amendment → Base Law Relationship

**Decision:** Use existing `Amendment` table as the relationship/join table.

**Architecture:**
```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│ LegalDocument   │         │    Amendment    │         │ LegalDocument   │
│ (Base Law)      │◄────────│ (Relationship)  │────────►│ (Amendment)     │
│ SFS 1977:1160   │         │                 │         │ SFS 2023:349    │
│ content_type:   │         │ base_document_id│         │ content_type:   │
│ SFS_LAW         │         │ amending_doc_id │         │ SFS_AMENDMENT   │
└─────────────────┘         │ affected_sections│        └─────────────────┘
                            │ effective_date  │
                            │ summary         │
                            └─────────────────┘
```

**No schema change needed** - the `Amendment` table already has:
- `base_document_id` → FK to LegalDocument (the law being amended)
- `amending_document_id` → FK to LegalDocument (the amendment document)
- `affected_sections`, `effective_date`, `summary` (rich relationship metadata)

**Fetching history for a base law:**
```sql
SELECT a.*, ld.*
FROM amendments a
JOIN legal_documents ld ON a.amending_document_id = ld.id
WHERE a.base_document_id = '{base_law_uuid}'
ORDER BY a.effective_date DESC
```

---

## LLM Processing Specification

### Prompt Design

Production prompt in `lib/sfs/amendment-llm-prompt.ts` (to be created).

**System prompt requirements:**
1. Output valid semantic HTML (article, section, h1-h4, ul, ol, dl)
2. Preserve ALL text exactly - no summarization or omission
3. Use Notisum-style HTML structure for consistency
4. Include data attributes for metadata (data-sfs, data-section)
5. No CSS styling in output

**Key formatting instructions:**
- Definition lists: Keep "term i X §" on single line items
- Section headers: Use `<h3>` with chapter prefix span
- Footnotes: Separate from main content, use `<dl>` structure
- Transition provisions: Place in `<footer>` section

### Post-Processing Pipeline

```typescript
async function processAmendmentPdf(pdfPath: string): Promise<LegalDocumentData> {
  // 1. Send PDF to Claude Sonnet Vision (Batch API)
  const rawHtml = await convertPdfToHtml(pdfPath)

  // 2. Clean LLM output
  const cleanHtml = cleanLlmOutput(rawHtml) // Remove markdown fences, validate structure

  // 3. Derive other formats deterministically
  const markdown = htmlToMarkdown(cleanHtml)
  const json = htmlToStructuredJson(cleanHtml)
  const plainText = htmlToPlainText(cleanHtml)

  return {
    html_content: cleanHtml,
    markdown_content: markdown,
    json_content: json,
    full_text: plainText,
  }
}
```

### Quality Validation

- Validate HTML structure (well-formed, expected elements)
- Check for required sections (header, content, footer)
- Flag documents with suspiciously short output for review
- Compare token count ratios (input vs output) for anomalies

### Error Handling & Recovery

**Batch Processing Strategy:**
- Process in batches of 1,000-5,000 documents
- Store batch IDs for monitoring and result retrieval
- Log all failures with error details for retry

**Retry Mechanism:**
```typescript
// Failed documents tracked in batch-failures.json
interface FailedDocument {
  sfs_number: string
  error: string
  batch_id: string
  attempts: number
}
// Retry with exponential backoff, max 3 attempts
```

**Rollback Strategy:**
- Keep original `AmendmentDocument.full_text` and `markdown_content` as backup
- New content stored in `LegalDocument` - can be regenerated without data loss
- Quality issues: Flag for manual review rather than auto-rollback

**Monitoring:**
- Track success/failure rates per batch
- Alert if failure rate exceeds 5%
- Sample validation: Manually review 1% of outputs

---

## Dev Notes

### Existing Data Models

**AmendmentDocument** (current, stores PDFs):
```typescript
{
  id: string
  sfs_number: string        // "2022:1109"
  storage_path: string      // "2022/SFS2022-1109.pdf"
  base_law_sfs: string      // "1977:1160"
  base_law_name: string     // "arbetsmiljölagen"
  title: string             // "Lag om ändring i arbetsmiljölagen (1977:1160)"
  effective_date: DateTime
  publication_date: DateTime
  full_text: string         // Extracted from PDF
  markdown_content: string  // For rendering
  section_changes: SectionChange[]  // Parsed changes
}
```

**LegalDocument** (created for amendments via LLM processing):
```typescript
{
  id: string
  content_type: 'SFS_AMENDMENT'
  document_number: string   // "SFS 2022:1109"
  title: string
  slug: string             // "lag-om-andring-i-arbetsmiljolagen-2022-1109"
  full_text: string        // Plain text for search/embeddings
  html_content: string     // LLM-generated HTML from PDF (SSOT)
  markdown_content: string // Derived from HTML for Chat/RAG
  json_content: Json       // Derived from HTML for structured queries
  effective_date: DateTime
  publication_date: DateTime
  status: 'ACTIVE'
  source_url: string
  metadata: {
    amendment_document_id: string  // Link to AmendmentDocument
    base_law_sfs: string
    base_law_slug: string
  }
}
```

### ContentType Enum

`SFS_AMENDMENT` already exists in the Prisma schema enum - no migration needed for the enum itself.

### Relevant Source Tree

```
app/(public)/lagar/[id]/page.tsx           # Base law page (reference for layout)
app/(public)/lagar/[id]/historik/page.tsx  # History page (reference for timeline)
components/features/law-versions/          # VersionByVersionTimeline component
lib/legal-document/version-cache.ts        # Amendment timeline caching
lib/sfs/                                   # SFS document handling
  classify.ts                              # Document classification
  pdf-fetcher.ts                           # PDF fetching
prisma/schema.prisma                       # Data models
```

### Slug Generation Pattern

Use existing pattern from `lib/supabase/ingest/law-slug.ts`:
```typescript
// For amendments:
// Title: "Lag (2022:1109) om ändring i arbetsmiljölagen (1977:1160)"
// → Slug: "lag-om-andring-i-arbetsmiljolagen-2022-1109"
```

### Document Theme

Add theme for `SFS_AMENDMENT` in `lib/document-themes.ts`:
```typescript
SFS_AMENDMENT: {
  label: 'Ändringsförfattning',
  icon: FilePenLine,  // or similar edit icon
  accent: 'text-amber-600',
  accentLight: 'bg-amber-100',
  badge: 'bg-amber-100 text-amber-800',
}
```

### Rendering Content

Amendments now have `html_content` from LLM processing - same as base laws.

**Primary rendering (HTML available):**
```typescript
// Use dangerouslySetInnerHTML for trusted HTML content
<div
  className="prose prose-legal"
  dangerouslySetInnerHTML={{ __html: document.html_content }}
/>
```

**Fallback rendering (markdown):**
```typescript
import ReactMarkdown from 'react-markdown'
import remarkGfm from 'remark-gfm'

<ReactMarkdown remarkPlugins={[remarkGfm]}>
  {document.markdown_content || document.full_text}
</ReactMarkdown>
```

### Migration Script Approach

```typescript
// scripts/migrate-amendments-to-legal-documents.ts
async function migrateAmendments() {
  const amendments = await prisma.amendmentDocument.findMany({
    where: { parse_status: 'COMPLETED' }
  })

  for (const amendment of amendments) {
    const slug = generateAmendmentSlug(amendment)

    await prisma.legalDocument.upsert({
      where: { document_number: `SFS ${amendment.sfs_number}` },
      create: {
        content_type: 'SFS_AMENDMENT',
        document_number: `SFS ${amendment.sfs_number}`,
        title: amendment.title,
        slug,
        full_text: amendment.full_text,
        effective_date: amendment.effective_date,
        publication_date: amendment.publication_date,
        status: 'ACTIVE',
        source_url: amendment.original_url,
        metadata: {
          amendment_document_id: amendment.id,
          base_law_sfs: amendment.base_law_sfs,
        }
      },
      update: { /* ... */ }
    })
  }
}
```

### Catalogue Filter

Add to existing catalogue filters:
```typescript
// In catalogue-filters.tsx
const documentTypeOptions = [
  { value: 'SFS_LAW', label: 'Lagar & förordningar' },
  { value: 'SFS_AMENDMENT', label: 'Ändringsförfattningar' },
  // ... other types
]
```

## Testing

### Test Standards
- **Location:** `tests/unit/` for unit tests, `tests/e2e/` for E2E
- **Framework:** Vitest for unit, Playwright for E2E
- **Pattern:** Use existing test patterns from Story 2.28

### Unit Tests Required
```typescript
// tests/unit/lib/amendment-slug.test.ts
describe('generateAmendmentSlug', () => {
  it('generates slug from amendment title')
  it('handles special characters')
  it('includes SFS number in slug')
})

// tests/unit/lib/migrate-amendments.test.ts
describe('migrateAmendmentToLegalDocument', () => {
  it('creates LegalDocument with correct content_type')
  it('populates metadata with amendment_document_id')
  it('handles missing optional fields')
})
```

### E2E Tests Required
```typescript
// tests/e2e/amendment-pages.spec.ts
test('can navigate from base law to amendment page')
test('amendment page displays all required information')
test('can search for amendment by SFS number')
test('catalogue shows amendments when filter enabled')
test('works in workspace context')
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-27 | 0.1 | Initial draft | Bob (SM) |
| 2024-12-27 | 0.2 | Added: Dependencies section, react-markdown install note, 404 handling subtask, breadcrumb navigation, SEO meta description | Sarah (PO) |
| 2024-12-28 | 0.3 | Added: Parser Quality Specification with 10 Notisum examples template, parser implementation tasks, AC addendum (AC-P1 through AC-P7). Status reverted to In Progress. | Bob (SM) |
| 2024-12-28 | 0.4 | Completed: Notisum HTML analysis for all 10 examples via Playwright scraping. Documented exact HTML patterns for: definition lists, section headers, group headers, chapter headers, footnotes, transition provisions, nested lists, EU links, editorial comments. Files saved to `scripts/notisum-analysis/`. | Bob (SM) |
| 2024-12-28 | 0.5 | Added: Parser Design Specification with target data model, key parser rules (section detection, group headers, definition lists, numbered lists, nested lists, footnotes, transition provisions), OCR cleanup rules, rendering component templates matching Notisum classes, and implementation priority matrix. | Bob (SM) |
| 2024-12-28 | 0.6 | Added: Technical Decisions section - (1) Store generated HTML in `html_content` column for performance/caching, (2) LLM usage strategy with Phase 1 (no LLM, deterministic parser) and Phase 2 (limited LLM for OCR correction and summaries only, with strict guardrails). | Bob (SM) |
| 2024-12-28 | 0.7 | Implemented: Complete parser enhancements per specification - OCR cleanup (split words, page footers), definition lists (Pattern A+B), numbered lists with nested a)/b)/c) sub-items, group header detection, structured footnotes and transition provisions, HTML generation (Notisum-style). Updated rendering component for new structure. All Parser Implementation Tasks and AC-P1 through AC-P7 marked complete. | James (Dev) |
| 2024-12-28 | 0.8 | Fixed: Added missing "Ändringsförfattning" document type badge to AmendmentPageContent (AC3 requirement). All 7 E2E tests pass, 122 SFS parser tests pass. | James (Dev) |
| 2024-12-28 | 0.9 | Fixed: PDF footnote cleanup patterns + section header detection for range references. (1) Enhanced cleanPdfArtifacts to remove "1 Prop. 2025/26:22, bet..." and "2 Senaste lydelse av..." footnotes. (2) Fixed isReferenceContext to detect letter-suffixed ranges like "29 a–" preventing false section header detection. Definition list (74 items) now renders correctly without PDF artifacts. | James (Dev) |
| 2024-12-28 | 0.10 | Fixed: (1) Line break artifacts from PDF - enhanced fixSplitWords to handle "word- word" pattern (in- komsten → inkomsten). (2) Numbered list detection - added firstItemMatch to detect "avser 1." and other list-introducing patterns. | James (Dev) |
| 2024-12-28 | 0.11 | Fixed: Numbered list parser bug in parseListItems - when matching "avser 1.", the regex index pointed to start of "avser", causing both word and item 1 to be lost. Simplified logic to find " 1. " directly and split lead text correctly. Section 36 § now renders with complete content (item 1 visible, "avser" in lead text). | James (Dev) |
| 2025-01-04 | 1.0 | **Major Refactor:** Replaced regex-based parser with LLM-based workflow. Key changes: (1) Claude Sonnet Vision for PDF → HTML conversion via Batch API (~$1.5k for 35k docs), (2) HTML as SSOT for all document types, (3) New columns: `markdown_content`, `json_content` derived deterministically from HTML, (4) Amendment → Base Law relationship via existing `Amendment` table unchanged. Removed: Parser Quality Specification section (400+ lines of regex rules). Added: LLM Processing Specification, updated Technical Decisions. Status changed to "In Progress - LLM Workflow Refactor". | Bob (SM) |
| 2025-01-04 | 1.1 | **PO Validation Fixes:** (1) Updated AC3 to reflect HTML content from LLM, (2) Fixed Dev Notes LegalDocument model to show `html_content`, `markdown_content`, `json_content` fields, (3) Consolidated Tasks into single coherent structure with Completed/Pending sections, (4) Removed duplicate Implementation Tasks section, (5) Added Error Handling & Recovery section with batch strategy, retry mechanism, and rollback plan. Story now passes validation. | Sarah (PO) |
| 2025-01-04 | 1.2 | **Phase 1 Implementation:** Completed all Schema & Infrastructure tasks. (1) Created Prisma migration adding `markdown_content` and `json_content` columns to `legal_documents`, (2) Created `lib/transforms/html-to-markdown.ts` with deterministic HTML→Markdown converter, (3) Created `lib/transforms/html-to-json.ts` with structured JSON parser for legal documents, (4) Created `lib/sfs/amendment-llm-prompt.ts` with Notisum-style HTML system prompt for Sonnet Vision, (5) Created `lib/sfs/llm-output-validator.ts` for cleaning/validating LLM output, (6) Created `scripts/batch-process-amendments.ts` for Anthropic Batch API processing. TypeScript passes, lint passes. | James (Dev) |
| 2025-01-05 | 1.3 | **Phase 2 Test Batch:** Validated pipeline with 10 amendments. (1) Fixed batch script to use `type: 'document'` for PDFs (not `type: 'image'`), (2) Fixed custom_id format to use dashes instead of colons (`SFS1998-1000`), (3) Fixed result processing to use upsert (creates LegalDocument if not exists, updates if exists), (4) All 10 test documents processed successfully with html_content, markdown_content, json_content populated. Next: review output quality before production batch (~$1,400 for 35k docs). | James (Dev) |
| 2025-01-05 | 1.4 | **Phase 2 Migration Complete:** Migrated all 34,508 AmendmentDocument records to LegalDocument table. (1) Fixed misclassified records (10 SFS_LAW → SFS_AMENDMENT), (2) Optimized migration script with batch pre-fetch and silent conflict handling, (3) Validated: 0 duplicate document_numbers, 0 duplicate slugs, all required fields populated. Total LegalDocuments now 63,557 (34,508 SFS_AMENDMENT + 10,787 SFS_LAW + others). Next: submit production LLM batch for PDF→HTML conversion. | James (Dev) |
| 2025-01-05 | 1.5 | **Phase 2 LLM Batch Test (100 docs):** (1) Updated model to `claude-sonnet-4-5-20250929` (same cost as 4.0), (2) Submitted 100-doc batch - actual cost $2.04 (extrapolates to ~$705 for full batch, 50% less than $1,400 estimate), (3) **Quality Review:** HTML structure excellent (article, sections, dl, footer), (4) **Footnote bug found & fixed:** JSON parser was only extracting `<dt>` (footnote numbers) but missing `<dd>` (actual content with prop/bet/rskr refs), (5) **New feature:** Added `LegislativeReference` type and `legislativeReferences` field to `json_content` for Story 9.1 - extracts Prop, Bet, Rskr, SOU, Ds from footnotes. | James (Dev) |
| 2025-01-05 | 1.6 | **Phase 2 Legislative Refs Table:** (1) Created `LegislativeRef` model with `ref_type` enum (PROP, BET, RSKR, SOU, DS), (2) Added junction table `legislative_refs` for queryable refs, (3) Updated `batch-process-amendments.ts` to insert refs during processing, (4) Created `backfill-legislative-refs.ts` script for existing docs, (5) Backfilled 189 refs across 63 documents, (6) Enables queries like "all amendments referencing Prop. 2024/25:59" (returns 15 amendments), (7) Fixed custom_id bug in prepare-lagar-batch.ts (was creating "SFS SFS:2025-18"), (8) Tested 58 lagar batch: 100% have prop/bet/rskr extracted correctly. | James (Dev) |
| 2025-01-05 | 1.7 | **Phase 2 Reference Normalization & Story 9.1 Pre-work:** (1) Normalized `reference` field to canonical Swedish format (Prop., Bet., Rskr.) - updated 130 records, (2) Updated `extractLegislativeReferences()` to output canonical format, (3) Explored Riksdag API formats: HTML, Text, PDF, XML available per document, (4) Investigated Författningskommentar extraction from Prop HTML - structure is print-formatted (CSS positioning classes, tables for layout), not semantic, (5) Created POC scripts: `fetch-prop-commentary.ts`, `show-comment-flow.ts`, (6) Downloaded sample prop for analysis: `test-results/prop-2024-25-59.html`, (7) Documented Story 9.1 architecture: amendment → legislative_refs → Riksdag API → extract Författningskommentar → grounded LLM summarization. | James (Dev) |
| 2025-01-06 | 1.8 | **Frontend HTML Rendering Refactor:** (1) Identified issue: `AmendmentPageContent` was parsing `full_text` with regex instead of using LLM-generated `html_content`, (2) Refactored component to render `html_content` directly via `dangerouslySetInnerHTML`, (3) Added comprehensive CSS styling in `globals.css` (`.amendment-html-content` class) for LLM-generated HTML structure (chapters, sections, footnotes, transition provisions, signature block), (4) Kept `full_text` parsing as fallback for documents without `html_content`, (5) Added `html_content` field to `AmendmentData` interface. Result: Amendment pages now render the full LLM-parsed HTML with proper styling, including previously missing elements like group headers (e.g., "Samhällsintroduktion"), transition provisions, and signature blocks. | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript type check passed
- Unit tests for amendment slug generation: 12/12 passed
- Lint warnings exist (pre-existing, not related to this story)
- Local testing (v0.8): 7/7 E2E tests pass, 122/122 SFS parser tests pass
- Screenshot verification: Amendment page renders correctly with chapter headers, section numbers, numbered lists
- Local testing (v0.9): 122/122 SFS parser tests pass, TypeScript passes
- Visual verification: SFS 2025:1461 (74-item definition list) renders correctly, PDF footnotes removed, no false section headers
- Local testing (v0.10-0.11): 122/122 SFS parser tests pass
- Visual verification (v0.11): Section 36 § renders correctly with lead text "avser" preserved and all 9 items visible (1-9). Screenshot saved to `test-results/screenshots/section-36-header.png`
- Phase 1 Implementation (v1.2): TypeScript passes (0 errors), ESLint passes on new files. Created 7 new files: transforms library (html-to-markdown.ts, html-to-json.ts, index.ts), LLM infrastructure (amendment-llm-prompt.ts, llm-output-validator.ts), batch script (batch-process-amendments.ts), migration (20250104_add_content_formats). Prisma schema updated with markdown_content and json_content columns.

### Completion Notes List
1. Created amendment slug generator with Swedish character normalization
2. Added SFS_AMENDMENT theme (orange, distinct from base laws)
3. Created migration script for existing AmendmentDocuments
4. Updated sync-sfs-updates cron to create LegalDocuments after LLM parsing
5. Built AmendmentPageContent with markdown rendering, section changes list
6. Created public and workspace routes for amendment pages
7. Added SFS_AMENDMENT to catalogue filters and browse API
8. Updated VersionByVersionTimeline to show "Detaljer" link to amendment pages
9. Updated getLawAmendmentTimeline to include amendment slugs
10. Installed react-markdown and remark-gfm for markdown rendering
11. E2E tests not written (require running application and test data)
12. **Parser Enhancements (v0.7):** Implemented full parser per Notisum specification:
    - Enhanced `cleanPdfArtifacts` with split word fixing and page footer removal
    - Enhanced `parseAmendmentStructure` with: structured footnotes, structured transition provisions, group header detection, footnoteRefs tracking per section
    - Added `parseSubItems` for nested a)/b)/c) list parsing
    - Enhanced `parseDefinitionList` with Pattern A (term i X §) and Pattern B (term: definition) support
    - Added `generateAmendmentHtml` for Notisum-style HTML output (stored in `htmlContent`)
    - Updated `AmendmentPageContent` component for new structured data (groupHeader, footnoteRefs, structured transitionProvisions)
13. **Local Testing Fix (v0.8):** Added missing "Ändringsförfattning" document type badge to AmendmentPageContent header section (Badge component, mt-3 text-xs styling). Required for AC3 compliance - E2E test was failing because badge was not visible.
14. **PDF Cleanup + Range Reference Fix (v0.9):**
    - Enhanced `cleanPdfArtifacts` with patterns for PDF footnotes: "1 Prop. 2025/26:22, bet. 2025/26:SkU5, rskr. 2025/26:95.", "2 Senaste lydelse av 7 kap. 25 § 2024:1248.", "SFS 2025:1461 Publicerad den..."
    - Fixed `isReferenceContext` in parser to detect letter-suffixed range patterns like "29 a–" (used in "i 29 a–29 e §§")
    - Result: 74-item definition list (SFS 2025:1461) now renders correctly without PDF artifacts or false section headers
    - Added import of `cleanPdfArtifacts` to `parseAmendmentStructure` for comprehensive cleanup
15. **Line Break + List Detection Fix (v0.10):**
    - Enhanced `fixSplitWords` to handle "word- word" pattern where PDF newlines became spaces (in- komsten → inkomsten, beskatt- ningsår → beskattningsår)
    - Enhanced `parseListItems` with `firstItemMatch` pattern to detect numbered lists starting with "1." after words like "avser", "följande", "gäller"
    - Result: Hyphenated word splits now correctly joined, numbered lists detected more reliably
16. **Numbered List Parser Bug Fix (v0.11):**
    - Fixed bug in `parseListItems` where regex index pointed to start of "avser" instead of " 1."
    - Simplified logic to find " 1. " pattern (space before "1.") and split lead text at that point
    - Result: Section 36 § now renders correctly with "avser" in lead text and all 9 items starting from item 1
17. **Phase 1 Infrastructure (v1.2):**
    - Created `lib/transforms/` directory with deterministic HTML → Markdown/JSON converters
    - `html-to-markdown.ts`: Handles headings, paragraphs, lists (ol/ul/dl), tables, links, code blocks, blockquotes
    - `html-to-json.ts`: Extracts structured data (sections, chapters, footnotes, definitions, transition provisions)
    - Created `lib/sfs/amendment-llm-prompt.ts` with Notisum-style HTML system prompt for Claude Sonnet Vision
    - Created `lib/sfs/llm-output-validator.ts` for cleaning LLM output (removes markdown fences, validates structure)
    - Created `scripts/batch-process-amendments.ts` with commands: prepare, submit, status, download, process, estimate
    - Added `markdown_content` (TEXT) and `json_content` (JSONB) columns to `legal_documents` via Prisma migration
18. **Phase 2 Quality Review & Fixes (v1.5):**
    - Reviewed 10 parsed amendments: HTML structure excellent (article, sections, dl, ol, footer)
    - Found footnote extraction bug: JSON was missing `<dd>` content (only had `<dt>` numbers)
    - Fixed `extractFootnotes()` in `html-to-json.ts` to properly extract `<dd>` content from `dl.footnote-content`
    - Added `LegislativeReference` interface with types: prop, bet, rskr, sou, ds
    - Added `extractLegislativeReferences()` function to parse references like "Prop. 2025/26:22", "Bet. 2025/26:SkU5", "Rskr. 2025/26:95"
    - Added `legislativeReferences` field to `LegalDocumentJson` (aggregates refs from all footnotes)
    - Updated batch script to use `claude-sonnet-4-5-20250929` model
    - 100-doc test batch cost $2.04 (extrapolates to ~$705 for 34.5k docs vs original $1,400 estimate)
19. **Phase 2 Legislative Refs Table (v1.6):**
    - Created `LegislativeRef` model with `ref_type` enum (PROP, BET, RSKR, SOU, DS)
    - Added `legislative_refs` relation to `LegalDocument`
    - Updated `batch-process-amendments.ts` to insert refs during processing
    - Created `scripts/backfill-legislative-refs.ts` for existing docs
    - Backfilled 189 refs across 63 documents
    - Enables queries like "all amendments referencing Prop. 2024/25:59" (returns 15 amendments)
    - Fixed custom_id bug in prepare-lagar-batch.ts (was creating "SFS SFS:2025-18")
    - Tested 58 lagar batch: 100% have prop/bet/rskr extracted correctly
20. **Phase 2 Reference Normalization & Story 9.1 Pre-work (v1.7):**
    - Normalized 130 references to canonical Swedish format: "Prop.", "Bet.", "Rskr." (not lowercase)
    - Updated `extractLegislativeReferences()` in html-to-json.ts with `CANONICAL_REF_FORMAT` constant
    - Created `scripts/normalize-legislative-refs.ts` for backfilling normalized format
    - Explored Riksdag API: 4 formats available (HTML, Text, PDF, XML) per dok_id
    - API flow: `/dokumentlista/?doktyp=prop&rm=2024/25&nr=59` → get dok_id → `/dokument/{dok_id}.html`
    - Investigated Prop HTML structure: print-formatted with CSS classes (p341, ft26), tables for layout, not semantic
    - Författningskommentar section starts at line ~7564, contains "X § [law text]" followed by "Paragrafen [commentary]"
    - Created POC scripts for Story 9.1: `show-comment-flow.ts`, `fetch-prop-commentary.ts`, `fetch-prop-text.ts`
    - Downloaded sample: `test-results/prop-2024-25-59.html` for manual review
    - **Story 9.1 architecture documented:** PROP has Författningskommentar (90% value), BET has committee notes (8%), RSKR is just citation (2%)
    - **Key insight:** Grounded LLM approach - pre-extract & chunk Författningskommentar per §, then summarize with citations to prevent hallucinations
21. **Frontend HTML Rendering Refactor (v1.8):**
    - Identified root cause of rendering issues: Component was using regex-based `parseAmendmentStructure()` on `full_text` instead of LLM-generated `html_content`
    - Refactored `AmendmentPageContent` to check for `html_content` first and render directly via `HtmlContentRenderer` component
    - Added `html_content?: string | null` to `AmendmentData` interface
    - Created comprehensive CSS styling in `app/globals.css` under `.amendment-html-content` class:
      - Hide duplicate header (`.lovhead { display: none }`)
      - Style chapters (`.kapitel`), sections (`.ann`, `.paragraf`), group headers (`h3.group`)
      - Style footnotes (inline `sup.footnote`, expandable `dl.footnote-content`)
      - Style transition provisions (`footer.back`, `.in-force-info`)
      - Style signature block, lists, links
    - Kept existing `parseAmendmentStructure()` logic as fallback for documents without `html_content`
    - Result: Amendment pages now correctly render all LLM-parsed content including group headers like "Samhällsintroduktion", complete transition provisions, and signature blocks

### File List
**New Files:**
- `lib/sfs/amendment-slug.ts` - Slug generation for amendments
- `lib/sfs/amendment-to-legal-document.ts` - LegalDocument creation from AmendmentDocument
- `scripts/migrate-amendments-to-legal-documents.ts` - Migration script
- `components/features/amendment/amendment-page-content.tsx` - Amendment page component
- `components/features/amendment/index.ts` - Index export
- `app/(public)/lagar/andringar/[id]/page.tsx` - Public amendment route
- `app/(workspace)/browse/lagar/andringar/[id]/page.tsx` - Workspace amendment route
- `lib/sfs/__tests__/amendment-slug.test.ts` - Unit tests for slug generation
- `lib/transforms/html-to-markdown.ts` - Deterministic HTML → Markdown converter
- `lib/transforms/html-to-json.ts` - Deterministic HTML → JSON parser
- `lib/transforms/index.ts` - Transform exports
- `lib/sfs/amendment-llm-prompt.ts` - LLM prompt for PDF → HTML conversion
- `lib/sfs/llm-output-validator.ts` - LLM output validation and cleanup
- `scripts/batch-process-amendments.ts` - Anthropic Batch API processing script
- `scripts/backfill-legislative-refs.ts` - Backfill legislative refs from json_content to dedicated table
- `scripts/verify-legislative-refs.ts` - Query and verify legislative refs data
- `scripts/normalize-legislative-refs.ts` - Normalize reference format to canonical Swedish
- `scripts/show-comment-flow.ts` - Demo script showing amendment → refs → API flow (Story 9.1 POC)
- `scripts/fetch-prop-commentary.ts` - POC for fetching proposition Författningskommentar
- `scripts/fetch-prop-text.ts` - Debug script for prop text format
- `scripts/fetch-prop-html-structure.ts` - Analyze prop HTML structure
- `prisma/migrations/20250104_add_content_formats/migration.sql` - Add markdown_content and json_content columns

**Modified Files:**
- `lib/document-themes.ts` - Added SFS_AMENDMENT theme
- `lib/cache/cached-queries.ts` - Added getCachedAmendment, getCachedAmendmentMetadata
- `lib/legal-document/version-reconstruction.ts` - Added slug to AmendmentTimelineEntry
- `app/api/cron/sync-sfs-updates/route.ts` - Create LegalDocument after parsing
- `prisma/schema.prisma` - Added markdown_content and json_content columns to LegalDocument
- `app/actions/browse.ts` - Added SFS_AMENDMENT to ContentTypeEnum
- `components/features/catalogue/catalogue-filters.tsx` - Added SFS_AMENDMENT filter
- `components/features/law-versions/version-by-version-timeline.tsx` - Added "Detaljer" link
- `app/(public)/lagar/[id]/historik/page.tsx` - Pass slug to timeline
- `app/(workspace)/browse/lagar/[id]/historik/page.tsx` - Pass slug to timeline
- `package.json` - Added react-markdown, remark-gfm dependencies
- `lib/sfs/parse-amendment-structure.ts` - **Enhanced parser with:** new interfaces (Footnote, TransitionProvision), parseSubItems for nested lists, improved parseDefinitionList (Pattern A+B), parseFootnotes, parseTransitionProvisions, group header detection, footnoteRefs extraction, generateAmendmentHtml function
- `lib/sfs/clean-pdf-artifacts.ts` - **Enhanced with:** fixSplitWords (hyphenated line breaks), removePageFooters (SFS number + page number), horizontal ruler pattern removal

## QA Results

### Review Date: 2024-12-27 (Initial)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is well-structured and follows established project patterns. Key observations:

**Strengths:**
- Clean separation of concerns: slug generation (`amendment-slug.ts`), data transformation (`amendment-to-legal-document.ts`), and UI (`AmendmentPageContent`)
- Proper TypeScript typing throughout with minimal `any` usage
- Follows shadcn/ui component patterns correctly
- Caching strategy consistent with existing document queries (1-hour TTL, proper tags)
- Swedish character normalization handles edge cases well
- Robust slug parsing/generation with fallbacks

**Architecture:**
- New files follow unified project structure conventions
- Theme system extended cleanly for SFS_AMENDMENT type
- Browse action properly includes SFS_AMENDMENT in ContentType enum with Zod validation
- VersionByVersionTimeline integration for "Detaljer" links is non-intrusive

### Refactoring Performed

No refactoring performed. Code quality is sufficient and follows project standards.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, shadcn/ui components used, proper error handling
- Project Structure: ✓ Files in correct locations per unified structure
- Testing Strategy: ✓ Unit tests present, E2E tests acknowledged as requiring test infrastructure
- All ACs Met: ✓ All 8 acceptance criteria validated

### Improvements Checklist

- [x] Unit tests for slug generation (12 tests passing)
- [x] Unit tests for LegalDocument creation logic (covered in amendment-slug.test.ts)
- [x] TypeScript type check passes
- [x] E2E test: History page loads with amendments timeline (tests/e2e/amendment-pages.spec.ts)
- [x] E2E test: Filter catalogue by amendments (tests/e2e/amendment-pages.spec.ts)
- [x] E2E test: 404 handling for invalid slugs (tests/e2e/amendment-pages.spec.ts)
- [x] E2E test: Navigate to amendment detail page via "Detaljer" link
- [x] E2E test: Amendment page displays required content (title, SFS badge, document type)
- [x] E2E test: Link back to base law works

### Security Review

No security concerns identified:
- No authentication bypass risks (pages are public by design)
- Input validation via Zod for content types in browse action
- Slug parsing is sanitized (alphanumeric + hyphen only)
- No sensitive data exposure in amendment pages

### Performance Considerations

Implementation includes appropriate performance optimizations:
- `getCachedAmendment` uses `unstable_cache` with 1-hour TTL and proper cache tags
- Parallel database queries where possible in cached-queries.ts
- `force-dynamic` on routes is appropriate for SEO metadata generation

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.29-amendment-document-pages.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria are met. E2E tests are appropriately deferred as they require running application infrastructure - this is documented in the story and is a reasonable approach for this feature.

---

### Review Date: 2024-12-28 (Parser Enhancement Review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment - Parser Enhancements (v0.7)

**Overall Assessment:** Implementation follows the Notisum specification closely with clean, well-documented code.

**Parser Implementation (`lib/sfs/parse-amendment-structure.ts`):**

| Feature | Implementation | Quality |
|---------|---------------|---------|
| Definition Lists (Pattern A+B) | `parseDefinitionList()` | ✓ Clean regex, fallback to Pattern B |
| Nested Lists (a/b/c) | `parseSubItems()` | ✓ Proper recursion handling |
| Group Headers | Detection in main parser | ✓ Title case matching |
| Structured Footnotes | `parseFootnotes()` | ✓ Deduplication, sorting |
| Structured Transition Provisions | `parseTransitionProvisions()` | ✓ Number/text extraction |
| HTML Generation | `generateAmendmentHtml()` | ✓ Notisum-style markup, proper escaping |
| Inline Reference Detection | `isInlineReference()` | ✓ 15+ indicator patterns |

**OCR Cleanup (`lib/sfs/clean-pdf-artifacts.ts`):**

| Feature | Implementation | Quality |
|---------|---------------|---------|
| Split Words | `fixSplitWords()` | ✓ Hyphen-newline handling |
| Page Footers | `removePageFooters()` | ✓ SFS+page number pattern |
| Horizontal Rulers | Pattern in OCR_ARTIFACT_PATTERNS | ✓ Various dash chars |

**Component Updates (`components/features/amendment/amendment-page-content.tsx`):**
- Group header rendering with uppercase tracking style
- Footnote refs display in section headers
- Structured transition provisions with number + text

### Compliance Check

- Coding Standards: ✓ TypeScript passes, ESLint clean on modified files
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ✓ 122 tests pass (12 slug + 14 clean-pdf + 11 parser + 85 others)
- All Parser ACs Met: ✓ AC-P1 through AC-P7 validated via code review

### Test Coverage Analysis

**Existing Tests (122 passing):**
- `lib/sfs/__tests__/amendment-slug.test.ts` - 12 tests
- `lib/sfs/__tests__/clean-pdf-artifacts.test.ts` - 14 tests
- `lib/sfs/__tests__/parse-amendment-structure.test.ts` - 11 tests

**Advisory:** New helper functions (`parseSubItems`, `parseFootnotes`, `parseTransitionProvisions`, `generateAmendmentHtml`) are exercised through integration tests but could benefit from dedicated unit tests for edge cases. This is advisory only - not blocking.

### Security Review

- ✓ `escapeHtml()` properly escapes HTML special characters
- ✓ `linkifySfsReferences()` sanitizes SFS numbers before URL construction
- ✓ No XSS vectors in generated HTML

### Performance Considerations

- ✓ Regex patterns are efficient (no catastrophic backtracking)
- ✓ HTML generation is O(n) with sections count
- ⚠ Generated HTML is computed per-request; future optimization: persist to `html_content` column

### Improvements Checklist

- [x] OCR cleanup enhanced with split word fixing
- [x] Definition list parsing with Pattern A + B support
- [x] Nested list parsing for a), b), c) sub-items
- [x] Group header detection
- [x] Structured footnotes with deduplication
- [x] Structured transition provisions
- [x] Notisum-style HTML generation with proper escaping
- [x] Component updated for new structured data
- [x] TypeScript passes (0 errors)
- [x] All 122 tests pass
- [ ] **Advisory:** Add dedicated unit tests for new parser functions (nice-to-have)
- [ ] **Advisory:** Persist generated HTML to database (future optimization)

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.29-amendment-document-pages.yml

Quality Score: 90/100 (minor advisory items only)

### Recommended Status

✓ **Ready for Done**

All acceptance criteria (original 8 + parser addendum AC-P1 through AC-P7) are met. Implementation follows the Notisum specification with clean, well-tested code. Advisory items (additional unit tests, HTML persistence) are nice-to-have improvements for future iterations.
