# Story 12.11: Template-Powered AI List Assembly

## Status

Draft

## Story

**As a** new user going through onboarding,
**I want** the AI to assemble my personalized law list from expert-curated templates rather than inventing laws from scratch,
**so that** my generated list includes structured sections, compliance summaries, and expert commentary from day one.

## Acceptance Criteria

1. Refactor Epic 4 Story 4.3 (AI law list generation) to use templates as source data:
   - Phase 1 (pre-signup): AI selects 15-30 highest-priority items from matching templates
   - Phase 2 (post-signup): AI fills remaining 45-65 items from templates + supplementary laws
2. Template matching logic based on onboarding context:
   - SNI code → relevant domain templates (e.g., construction → Arbetsmiljö + Miljö + Fastighet)
   - Employee count → tjänsteföretag variant vs. full template
   - Contextual answers → specific section emphasis
3. Items drawn from templates retain: compliance summaries (as commentary), expert commentary (as ai_commentary), section structure (as LawListGroup), SSDD ordering (as position)
4. AI adds personalized context commentary: "Gäller eftersom ni har 12 anställda"
5. Laws not covered by any template are still AI-generated (fallback to current behavior)
6. Generated list source tracking: TEMPLATE for template-sourced items, AI_GENERATED for others
7. Template coverage metric: % of generated items sourced from templates vs. AI-invented

## Tasks / Subtasks

- [ ] **Task 1: Analyze existing onboarding generation flow** (AC: 1)
  - [ ] Read existing Story 4.3 implementation in `app/(app)/onboarding/`
  - [ ] Identify the two-phase generation: Phase 1 (pre-signup, 15-30 items) and Phase 2 (post-signup, 45-65 items)
  - [ ] Map the current AI generation touchpoints
- [ ] **Task 2: Build template matching logic** (AC: 2)
  - [ ] Create `lib/ai/template-matcher.ts`
  - [ ] SNI code → domain mapping (e.g., SNI 41-43 → ["arbetsmiljo", "miljo", "fastighet"])
  - [ ] Employee count → variant selection (small service company → tjänsteföretag variant)
  - [ ] Contextual answer → section emphasis (e.g., "we handle chemicals" → emphasize section 08)
  - [ ] Return: ordered list of matching templates with relevance scores
- [ ] **Task 3: Build template-sourced item selector** (AC: 1, 3)
  - [ ] Create `lib/ai/template-assembler.ts`
  - [ ] Phase 1: select 15-30 highest-priority items from matching templates
  - [ ] Priority heuristic: Section 01 (Grundläggande) items first, then based on contextual relevance
  - [ ] Phase 2: fill remaining 45-65 items from templates
  - [ ] Preserve template section structure in output (for LawListGroup creation)
  - [ ] Preserve compliance summaries and expert commentary
- [ ] **Task 4: Refactor onboarding generation to use templates** (AC: 1)
  - [ ] Modify the AI generation flow to call template matcher first
  - [ ] Template-sourced items → bulk create with `source = TEMPLATE`
  - [ ] Non-template items → existing AI generation with `source = ONBOARDING`
  - [ ] Ensure smooth fallback: if no templates match, use existing AI-only flow
- [ ] **Task 5: Add personalized context** (AC: 4)
  - [ ] For template-sourced items, AI adds personalized context based on company profile
  - [ ] Examples: "Gäller eftersom ni har 12 anställda", "Relevant för er bransch (SNI 41)"
  - [ ] Append to or store alongside compliance summary
- [ ] **Task 6: Implement source tracking** (AC: 6, 7)
  - [ ] Template-sourced items: `source = TEMPLATE`
  - [ ] AI-generated items: `source = ONBOARDING` (existing behavior)
  - [ ] Track coverage metric: count template-sourced / total items
  - [ ] Log metric for analytics
- [ ] **Task 7: Write tests** (AC: all)
  - [ ] Unit test: template matching returns correct templates for SNI codes
  - [ ] Unit test: employee count selects variant vs. full template
  - [ ] Unit test: Phase 1 selects 15-30 items
  - [ ] Unit test: Phase 2 fills to target count
  - [ ] Unit test: fallback to AI-only when no templates match
  - [ ] Integration test: full onboarding flow with template assembly

## Dev Notes

### Existing Onboarding Flow

**Epic 4 implementation locations:**
- `app/(app)/onboarding/` — onboarding pages
- `components/features/onboarding/` — onboarding components
- `lib/ai/prompts/` — AI generation prompts
- `app/actions/` — server actions for generation

The current flow:
1. Company lookup (Bolagsverket API → SNI code, employee count)
2. Dynamic contextual questions
3. Two-phase AI law list generation (Phase 1: pre-signup preview, Phase 2: full list)

### Template Matching Heuristics

**SNI → Domain Mapping (initial):**
| SNI Range | Domain Templates |
|-----------|-----------------|
| All | Arbetsmiljö (universal) |
| 41-43 (Construction) | + Fastighet-Bygg (Phase 2) |
| 01-03 (Agriculture) | + Miljö |
| 10-33 (Manufacturing) | + Miljö, + Kemiska risker emphasis |
| 62-63 (IT/Software) | Arbetsmiljö tjänsteföretag variant |

**Employee count:**
- < 50 employees + service sector → tjänsteföretag variant
- ≥ 50 or industrial sector → full template

### This Story Activates Only for Domains with Published Templates

During Phase 1, only Arbetsmiljö and Miljö templates exist. The template-powered assembly only activates for domains covered by templates. For uncovered domains, the existing AI-only generation continues.

### Dependencies

- **Blocked by:** Story 12.4 or 12.5 (needs published templates)
- **Modifies:** Epic 4 Story 4.3 implementation

### Relevant Source Tree

```
lib/ai/template-matcher.ts                  # New: template matching logic
lib/ai/template-assembler.ts                # New: template-sourced item assembly
app/(app)/onboarding/                        # Existing: onboarding pages
components/features/onboarding/              # Existing: onboarding components
lib/ai/prompts/                              # Existing: AI prompts (may need updates)
app/actions/                                 # Existing: generation server actions
```

### Testing

- **Test framework:** Vitest 1.4+
- **Test location:** `tests/unit/lib/ai/`, `tests/integration/`
- **Tests needed:**
  - Template matcher: SNI code 41 returns Arbetsmiljö + Miljö
  - Template matcher: small service company → tjänsteföretag variant
  - Assembler: Phase 1 returns 15-30 items with correct source = TEMPLATE
  - Assembler: fallback to AI-only when no templates exist
  - Coverage metric: correctly counts template vs. AI-generated items
  - No regression: existing onboarding still works for domains without templates

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
