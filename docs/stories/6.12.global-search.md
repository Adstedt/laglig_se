# Story 6.12: Implement Global Search (Cmd+K)

## Status

Draft

## Story

**As a** user,
**I want** to search across all compliance data,
**so that** I quickly find laws, tasks, or evidence.

## Acceptance Criteria

1. Keyboard shortcut `/` or `Cmd+K` (Mac) / `Ctrl+K` (Windows)
2. Search modal with autofocus input
3. **Search scope:**
   - Legal documents (title, SFS number)
   - Tasks (title, description)
   - Comments (text content)
   - Evidence (filename)
4. Results grouped by type with counts
5. Each result shows: title, snippet, breadcrumb
6. Arrow keys navigate, Enter opens result
7. Recent searches shown when input empty
8. ESC closes modal
9. Results appear as user types (<200ms)

## Tasks / Subtasks

_To be detailed during sprint planning_

- [ ] Create global search modal component
- [ ] Implement keyboard shortcut listener
- [ ] Build search API endpoint
- [ ] Index legal documents for search
- [ ] Index tasks for search
- [ ] Index comments for search
- [ ] Index evidence filenames
- [ ] Build result grouping and display
- [ ] Add recent searches (localStorage)
- [ ] Implement keyboard navigation
- [ ] Optimize for <200ms response

## Dev Notes

### Search Implementation Options

1. **PostgreSQL Full-Text Search:** Built-in, good for MVP
2. **Meilisearch:** Better UX, requires separate service
3. **Algolia:** Excellent but paid

Recommend PostgreSQL FTS for MVP.

### PostgreSQL Full-Text Search Setup

```sql
-- Add tsvector columns
ALTER TABLE legal_documents ADD COLUMN search_vector tsvector;
ALTER TABLE tasks ADD COLUMN search_vector tsvector;

-- Create indexes
CREATE INDEX idx_legal_documents_search ON legal_documents USING GIN(search_vector);
CREATE INDEX idx_tasks_search ON tasks USING GIN(search_vector);

-- Trigger to update search vector
CREATE TRIGGER legal_documents_search_update
BEFORE INSERT OR UPDATE ON legal_documents
FOR EACH ROW EXECUTE FUNCTION
tsvector_update_trigger(search_vector, 'pg_catalog.swedish', title, document_number);
```

### File Locations

```
components/features/search/
  global-search-modal.tsx
  search-results.tsx
  search-result-item.tsx
  recent-searches.tsx
app/api/search/
  route.ts
lib/hooks/
  use-global-search.ts
```

### Keyboard Shortcut

```typescript
// Use cmdk library or custom hook
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault()
      openSearchModal()
    }
    if (e.key === '/') {
      // Only if not in input/textarea
      if (!['INPUT', 'TEXTAREA'].includes((e.target as HTMLElement).tagName)) {
        e.preventDefault()
        openSearchModal()
      }
    }
  }
  window.addEventListener('keydown', handleKeyDown)
  return () => window.removeEventListener('keydown', handleKeyDown)
}, [])
```

## Testing

- Unit tests for search logic
- E2E tests for keyboard shortcut
- E2E tests for search flow
- Performance tests for <200ms

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-01-08 | 1.0     | Initial story creation | Sarah (PO) |
