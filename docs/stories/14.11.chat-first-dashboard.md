# Story 14.11: Chat-First Dashboard ("Hem")

## Status

Draft

## Story

**As a** workspace member,
**I want** the dashboard to be a chat-first agent interface with contextual compliance cards,
**so that** I can interact with my compliance partner naturally as my primary workspace experience.

## Context & Dependencies

**Why this story exists:** The traditional widget-grid dashboard is passive — users look at numbers but don't act on them. By making the dashboard a conversational interface (inspired by Claude Cowork/Chat), users land on an active surface where the agent surfaces what matters and they can immediately ask questions or trigger actions. The same conversation persists into the sidebar on other pages, creating a seamless work session.

This **replaces** the previous 14.11 concept of a separate `/compliance-partner` chat page. The dashboard *is* the compliance partner.

**Builds on:** Existing chat infrastructure from Story 3.3 (`useChatInterface`, `ChatPanel`, `RightSidebar`, `ChatMessage` model), dashboard data queries (`getDashboardData`)

**Depends on:** Nothing — this is the foundational surface for the compliance agent.

**Depended on by:**
- Story 14.5 (onboarding conversation happens *in* this interface)
- Story 14.7 (agent tools wire into this chat)
- Story 14.9 (system prompt enriches this agent)
- Story 14.10 (assessment flow surfaces here)

## Acceptance Criteria

### Dashboard to Hem Transformation

1. Sidebar nav item renamed from "Dashboard" to "Hem" with appropriate icon (e.g., Home from Lucide)
2. Route remains `/dashboard` (no URL breaking change)
3. Two layout states — **home state** (centered) and **conversation state** (chat):
   - **Home state:** Full-screen centered layout. Greeting heading, context cards, chat input, and suggested prompts all vertically centered. Same layout on desktop and mobile.
   - **Conversation state:** On first user input, layout shifts — messages scroll from top, chat input pinned at bottom. Greeting/cards disappear. Same layout on desktop and mobile.
   - Clicking "Ny konversation" or returning to Hem with no active conversation shows home state.
4. Chat input prominently centered in home state (similar to Claude Cowork's layout)
5. Branded greeting heading using the Safiro font (`font-safiro` class) — e.g., "Hur kan jag hjälpa dig idag?"

### Context Cards

6. Dynamic context cards displayed **above** the chat input (home state only) showing current compliance state
7. Cards pull from existing `getDashboardData()`: compliance %, pending amendments count, overdue tasks, tasks this week
8. Cards are clickable — clicking one pre-fills or sends a relevant prompt (e.g., clicking "3 väntande ändringar" sends "Visa mina väntande ändringar")
9. Cards update when returning to Hem (reflect latest state)
10. If `getDashboardData()` fails, show cards with subtle muted "–" placeholder values — never block the chat experience

### Conversation Persistence

11. Conversation persists within a work session — navigating away from Hem and returning shows the ongoing conversation (conversation state)
12. Same conversation is shared between Hem and the right sidebar on other pages
13. "Ny konversation" button that saves the current conversation and starts fresh (returns to home state with context cards)
14. Saved conversations accessible via a "Tidigare konversationer" list (timestamp + first message preview, click to load)
15. New login/session starts fresh with updated context cards (home state)

### Sidebar Behavior

16. Right sidebar AI chat toggle hidden when on the `/dashboard` route (Hem IS the chat)
17. On all other routes, sidebar works as before but shares the same global conversation from Hem
18. Sidebar input and message rendering uses the same underlying chat component

### Testing

19. At least 12 unit tests covering layout states, context cards, conversation persistence, sidebar sync, navigation changes

## Tasks / Subtasks

- [ ] **Task 1: Hem page layout** (AC: 1-5)
  - [ ] Replace content in `app/(workspace)/dashboard/page.tsx` with new chat-first layout
  - [ ] **Home state** (no active conversation): full-screen centered vertically — greeting heading (`font-safiro`), context cards, chat input, suggested prompts. Same layout desktop and mobile.
  - [ ] **Conversation state** (after first input): layout shifts — messages scroll from top, chat input pinned at bottom. Greeting/cards/prompts disappear. Same layout desktop and mobile.
  - [ ] Rename "Dashboard" → "Hem" in `components/layout/left-sidebar.tsx` (icon: Home from Lucide)
  - [ ] Rename in `components/layout/mobile-sidebar.tsx` to match

- [ ] **Task 2: Context cards** (AC: 6-10)
  - [ ] Create `components/features/dashboard/context-cards.tsx`
  - [ ] Fetch data via existing `getDashboardData()` query
  - [ ] Card types: compliance % ring/badge, pending amendments count, overdue tasks, tasks this week
  - [ ] Horizontal card row above chat input (scrollable on mobile)
  - [ ] Each card is clickable — clicking sends a pre-defined prompt to the chat
  - [ ] Cards re-fetch when navigating back to Hem
  - [ ] Loading state: skeleton placeholders while fetching
  - [ ] Error state: show cards with muted "–" values if `getDashboardData()` fails — never block chat
  - [ ] Old dashboard widget components (`ComplianceProgressRing`, `TaskSummaryCards`, etc.) may be referenced for data patterns but are not reused directly — keep or remove at dev agent discretion

- [ ] **Task 3: Unified chat component** (AC: 3-4, 12, 18)
  - [ ] Create `components/features/dashboard/hem-chat.tsx` — the core chat component
  - [ ] Two render modes: `full` (Hem page) and `panel` (right sidebar)
  - [ ] Uses existing `useChatInterface({ contextType: 'global' })` hook
  - [ ] Message list with streaming support (reuse `ChatMessageList`)
  - [ ] Input field with Swedish placeholder
  - [ ] **Home state** (empty/new): greeting + context cards + suggested prompts, all centered
  - [ ] **Conversation state** (has messages): messages top-down, input pinned at bottom — transition on first input
  - [ ] Suggested prompts in home state (below chat input): "Visa en översikt av min efterlevnad", "Vilka ändringar har jag missat?", "Hjälp mig granska en lagändring", "Vad behöver jag göra denna vecka?"

- [ ] **Task 4: Schema migration & conversation grouping** (AC: 13-14, prerequisite for Tasks 5-6)
  - [ ] Add `conversation_id String?` field to `ChatMessage` in `prisma/schema.prisma`
  - [ ] Add index: `@@index([conversation_id])` on `ChatMessage`
  - [ ] Generate and run Prisma migration
  - [ ] Server actions in `app/actions/ai-chat.ts`: `archiveConversation()` (tags current GLOBAL messages with a new conversation_id), `getConversationHistory()` (returns distinct archived conversations with first message + timestamp), `loadConversation()` (loads messages for a given conversation_id)

- [ ] **Task 5: Session-scoped conversation persistence** (AC: 11, 15)
  - [ ] Conversation state persists across page navigations within a session
  - [ ] Active conversation uses `conversation_id = null` with `contextType: 'global'`
  - [ ] On new login/session, start fresh (archive any stale null-conversation_id messages from previous sessions)
  - [ ] Leverage existing `useChatInterface` auto-save behavior

- [ ] **Task 6: Conversation history UI** (AC: 13-14)
  - [ ] "Ny konversation" button visible during active conversation
  - [ ] Clicking calls `archiveConversation()` then resets to home state
  - [ ] Create `components/features/dashboard/conversation-history.tsx`
  - [ ] Simple list UI: timestamp + first message preview for each saved conversation
  - [ ] Click to load a past conversation (resumable)
  - [ ] Accessible from a "Tidigare konversationer" link on the Hem home state

- [ ] **Task 7: Sidebar integration** (AC: 16-18, depends on Task 3)
  - [ ] Hide right sidebar toggle button on `/dashboard` route in `components/layout/left-sidebar.tsx`
  - [ ] Replace `RightSidebar` chat content with the unified `HemChat` component in `panel` mode
  - [ ] Ensure shared message state between Hem and sidebar (same `useChatInterface` instance via context/store)
  - [ ] When sidebar is opened on non-dashboard routes, it shows the ongoing global conversation

- [ ] **Task 8: Tests** (AC: 19)
  - [ ] Test Hem page renders greeting with Safiro font class
  - [ ] Test context cards render with mock dashboard data
  - [ ] Test context card click sends prompt to chat
  - [ ] Test empty context cards show loading/empty state
  - [ ] Test chat input renders with Swedish placeholder
  - [ ] Test conversation persists across simulated navigation
  - [ ] Test "Ny konversation" saves and resets
  - [ ] Test conversation history list renders saved conversations
  - [ ] Test sidebar toggle hidden on /dashboard route
  - [ ] Test sidebar shows same conversation as Hem
  - [ ] Test nav item shows "Hem" with Home icon
  - [ ] Test mobile nav item shows "Hem"
  - [ ] Minimum 12 unit tests

## Dev Notes

### Previous Story Insights

No previous story in this sequence — 14.11 is the foundational UI surface for the compliance agent. Stories 14.2 (ContentChunk), 14.3 (embeddings), and 14.4 (WorkspaceProfile) are infrastructure stories; this is the first user-facing agent story.

### Data Models

**Existing — ChatMessage** [Source: `prisma/schema.prisma` lines 1174-1203]
```
model ChatMessage {
  id           String          @id @default(uuid())
  workspace_id String
  user_id      String
  role         ChatMessageRole  // USER | ASSISTANT
  content      String          @db.Text
  context_type ChatContextType @default(GLOBAL)  // GLOBAL | TASK | LAW
  context_id   String?
  created_at   DateTime        @default(now())
}
```

**Schema change required:** Add `conversation_id String?` field to `ChatMessage` to support conversation grouping. When "Ny konversation" is clicked, the current set of GLOBAL messages gets tagged with a `conversation_id` (cuid), and a new conversation starts with `conversation_id = null` (active). The history list queries distinct non-null `conversation_id` values with their first message and timestamp.

**Migration:**
```sql
ALTER TABLE "chat_messages" ADD COLUMN "conversation_id" TEXT;
CREATE INDEX "chat_messages_conversation_id_idx" ON "chat_messages"("conversation_id");
```

### Layout Reference (Cowork-inspired)

**Home state** (no conversation / new chat):
```
┌─────────────────────────────────────────┐
│                                         │
│                                         │
│                                         │
│        Hur kan jag hjälpa dig          │
│             idag, Alex?                 │  ← font-safiro, centered
│                                         │
│   ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ │
│   │ 5%   │ │ 3    │ │ 1    │ │ 7    │ │  ← context cards (clickable)
│   │Eftrle│ │Ändr. │ │Förfa.│ │Uppg. │ │
│   └──────┘ └──────┘ └──────┘ └──────┘ │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │ Vad kan jag hjälpa dig med?     │   │  ← chat input, centered
│   │                          [Send] │   │
│   └─────────────────────────────────┘   │
│                                         │
│   [Översikt]  [Ändringar]  [Granska]   │  ← suggested prompts
│   [Denna vecka]                         │
│                                         │
│   Tidigare konversationer >             │  ← history link
│                                         │
└─────────────────────────────────────────┘
```

**Conversation state** (after first input):
```
┌─────────────────────────────────────────┐
│                                         │
│  User: Visa mina väntande ändringar     │
│                                         │
│  Agent: Ni har 3 väntande ändringar...  │
│  [citations]                            │
│                                         │
│                                         │
│                                         │
│                                         │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │ Svara...                        │   │  ← input pinned at bottom
│   │                          [Send] │   │
│   └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

Transition: on first user message, home state content (greeting, cards, prompts) disappears and the conversation layout takes over. "Ny konversation" returns to home state.

### Component Specifications

**Existing dashboard** [Source: `app/(workspace)/dashboard/page.tsx`]:
- Server component calling `getDashboardData()` from `lib/db/queries/dashboard`
- Returns: `{ complianceStats, taskCounts, recentActivity, topLists }`
- Renders widget grid: `ComplianceProgressRing`, `QuickActions`, `TaskSummaryCards`, `RecentActivityFeed`, `ListOverview`
- All widgets wrapped in `WidgetErrorBoundary`

**Existing chat components** [Source: `components/features/ai-chat/`]:
- `ChatPanel` — flexible chat container for modals/flyouts (props: contextType, contextId, suggestedQuestions, etc.)
- `ChatMessageList` — renders conversation messages with citations
- `ChatInputModern` — advanced input with model selector, attachment button, quick actions, character counter (max 2000)
- `ChatInput` — simpler input variant (used in mobile modal)
- `ChatError` — error display with retry logic

**Existing right sidebar** [Source: `components/layout/right-sidebar.tsx`]:
- Fixed sidebar: 480px normal, 960px expanded
- Uses `useLayoutStore()` (Zustand + localStorage) for open/collapsed state
- Uses `useChatInterface({ contextType: 'global' })` for messages
- Header: Lexa icon + title, expand/collapse, close button
- 4 hardcoded suggested questions in empty state
- Keyboard shortcuts: `Cmd/Ctrl + K` or `/` opens sidebar

**Existing left sidebar** [Source: `components/layout/left-sidebar.tsx`]:
- 240px expanded / 16px collapsed
- "AI Chat" item calls `toggleRightSidebar()` — this needs conditional hide on `/dashboard`
- Uses `usePathname()` for `isActive` matching
- Collapsed mode uses `CollapsedAccordionItem` with tooltip/popover management

**Existing layout** [Source: `components/layout/workspace-shell.tsx`]:
- Wraps all workspace pages: LeftSidebar + Header + main content + RightSidebar
- `RightSidebar isOpen={!rightSidebarFolded}`
- ChatModal for mobile (<1024px)

**New components to create:**
- `components/features/dashboard/hem-chat.tsx` — core unified chat component with `full` and `panel` render modes
- `components/features/dashboard/context-cards.tsx` — clickable compliance context cards
- `components/features/dashboard/conversation-history.tsx` — saved conversation list

### Shared Conversation State

The key technical challenge is ensuring Hem and sidebar share the same conversation. [Source: architecture/3-tech-stack.md#state-management]

**Recommended approach:** Both use `useChatInterface({ contextType: 'global' })` which reads from the same DB records (simplest, already works). Zustand store option available if real-time sync between simultaneously open sidebar and Hem is needed, but DB-backed approach is sufficient for v1 since users won't see both at the same time (sidebar hidden on dashboard).

### Safiro Font

[Source: `app/globals.css` lines 1-9, 121-123]
- `@font-face` declaration: font-family 'Safiro', weight 500, woff2/woff formats from `/public/fonts/`
- Tailwind utility: `.font-safiro { font-family: 'Safiro', system-ui, sans-serif !important; }`
- Usage pattern from landing page: `className="font-safiro"` + inline `style={{ fontFamily: "'Safiro', system-ui, sans-serif" }}` for redundancy

### File Locations

[Source: architecture/12-unified-project-structure.md]
- Dashboard page: `app/(workspace)/dashboard/page.tsx` (modify)
- Left sidebar: `components/layout/left-sidebar.tsx` (modify)
- Mobile sidebar: `components/layout/mobile-sidebar.tsx` (modify)
- Right sidebar: `components/layout/right-sidebar.tsx` (modify)
- Workspace shell: `components/layout/workspace-shell.tsx` (modify)
- Chat hook: `lib/hooks/use-chat-interface.ts` (may need minor changes)
- Chat actions: `app/actions/ai-chat.ts` (extend with archive/history actions)
- Dashboard queries: `lib/db/queries/dashboard.ts` (reuse)
- New: `components/features/dashboard/hem-chat.tsx`
- New: `components/features/dashboard/context-cards.tsx`
- New: `components/features/dashboard/conversation-history.tsx`
- Prisma schema: `prisma/schema.prisma` (add conversation_id)

### Technical Constraints

- **UI library**: shadcn/ui components mandatory for all interactive elements [Source: architecture/17-coding-standards.md#17.3]
- **Icons**: Lucide Icons (2px stroke, rounded caps) [Source: architecture/3-tech-stack.md]
- **State management**: Zustand for layout state, Vercel AI SDK for chat state, React Context for session [Source: architecture/3-tech-stack.md]
- **Server Components by default**: Only use `"use client"` where interactivity requires it [Source: architecture/17-coding-standards.md#17.3]
- **Workspace isolation**: All DB queries must include `workspaceId` filter [Source: architecture/17-coding-standards.md#17.4]
- **Keyboard shortcut**: `Cmd/Ctrl + K` currently opens sidebar — on `/dashboard`, should focus the Hem chat input instead

### Testing Requirements

[Source: architecture/17-coding-standards.md, architecture/3-tech-stack.md#testing]

## Testing

- **Framework:** Vitest 1.4+ with React Testing Library 14.2+
- **Test files:**
  - `tests/unit/components/features/dashboard/hem-chat.test.ts`
  - `tests/unit/components/features/dashboard/context-cards.test.ts`
  - `tests/unit/components/features/dashboard/conversation-history.test.ts`
- **What to test:**
  - Hem page renders home state: greeting heading with `font-safiro` class, centered layout
  - Hem page transitions to conversation state on first message (input pinned at bottom, greeting disappears)
  - Context cards render compliance %, amendments, overdue tasks from mock data
  - Clicking a context card triggers sendMessage with correct prompt
  - Context cards show muted "–" values when getDashboardData fails (subtle error)
  - Context cards show skeleton placeholders while loading
  - Chat input renders with Swedish placeholder text
  - Suggested prompts render in home state and trigger sendMessage on click
  - Conversation messages persist and display after simulated navigation
  - "Ny konversation" button archives current conversation and returns to home state
  - Conversation history list renders saved conversations with timestamp + preview
  - Clicking a saved conversation loads its messages
  - Sidebar toggle is hidden when pathname is `/dashboard`
  - Sidebar renders same conversation content as Hem (shared contextType: 'global')
  - Nav item displays "Hem" label with Home icon in left sidebar
  - Nav item displays "Hem" in mobile sidebar
- **Patterns:** Vitest + React Testing Library. Mock `useChatInterface` hook from `lib/hooks/use-chat-interface.ts`. Mock `getDashboardData` for context cards. Mock `usePathname` from `next/navigation` for sidebar visibility tests. Follow existing test patterns in `tests/unit/`. Use MSW for API mocking if needed [Source: architecture/3-tech-stack.md].

## Change Log

| Date       | Version | Description                                              | Author |
| ---------- | ------- | -------------------------------------------------------- | ------ |
| 2026-02-18 | 0.1     | Initial draft (separate compliance partner page)         | Claude |
| 2026-02-25 | 1.0     | Complete rewrite: chat-first dashboard ("Hem") vision    | Claude |
| 2026-02-25 | 1.1     | SM enrichment: architecture refs, schema change, dev notes | Bob    |
| 2026-02-25 | 1.2     | PO validation fixes: layout states, error handling, wireframe, suggested prompts | Sarah  |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
