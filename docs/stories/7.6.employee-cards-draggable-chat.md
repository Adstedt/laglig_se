# Story 7.6: Implement Employee Cards (Draggable to Chat)

## Status
Draft

## Story

**As a** user,
**I want** to drag employee cards into AI chat,
**so that** I ask HR questions specific to that employee.

## Acceptance Criteria

1. Employee List view includes card layout option (toggle: Table/Cards)
2. Each card shows: Name, role, photo (if uploaded), compliance status badge
3. Cards draggable (already implemented in Epic 3.5)
4. Dragging into chat adds employee context
5. AI uses employee metadata: role, kollektivavtal, employment date
6. Example: Drag "Anna Svensson" → Ask "How many vacation days does Anna have?" → AI checks her kollektivavtal
7. Privacy: Only HR Manager/Admin/Owner can drag employee cards
8. Employee context pill shown in chat input with remove button
9. Mobile: Tap employee card to add to chat (no drag-and-drop on mobile)

## Tasks / Subtasks

- [ ] Add table/card view toggle to Employee List
- [ ] Build employee card component
- [ ] Make cards draggable (reuse DnD from Epic 3.5)
- [ ] Add drop zone in chat interface
- [ ] Handle employee card drop in chat
- [ ] Display employee context pill in chat input
- [ ] Update AI prompt to include employee context
- [ ] Test AI responses with employee-specific questions
- [ ] Add mobile tap-to-add functionality
- [ ] Test privacy restrictions
- [ ] Test drag-and-drop across browsers

## Dev Notes

**Employee List with View Toggle:**
```typescript
// app/hr/employees/page.tsx (updated)
'use client'

import { useState } from 'react'
import { EmployeeTable } from '@/components/hr/employee-table'
import { EmployeeCards } from '@/components/hr/employee-cards'

export default function EmployeesPage() {
  const [view, setView] = useState<'table' | 'cards'>('table')

  return (
    <Can permission={Permission.VIEW_EMPLOYEES}>
      <div className="max-w-7xl mx-auto p-6">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-bold">Employees</h1>

          {/* View Toggle */}
          <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => setView('table')}
              className={`px-3 py-1.5 rounded-md text-sm ${
                view === 'table'
                  ? 'bg-white text-gray-900 shadow'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              <svg className="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fillRule="evenodd"
                  d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                  clipRule="evenodd"
                />
              </svg>
              Table
            </button>
            <button
              onClick={() => setView('cards')}
              className={`px-3 py-1.5 rounded-md text-sm ${
                view === 'cards'
                  ? 'bg-white text-gray-900 shadow'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              <svg className="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 12a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1v-4zM11 4a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V4zM11 12a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
              </svg>
              Cards
            </button>
          </div>
        </div>

        <Suspense fallback={<Skeleton />}>
          {view === 'table' ? <EmployeeTable /> : <EmployeeCards />}
        </Suspense>
      </div>
    </Can>
  )
}
```

**Employee Cards Component:**
```typescript
// components/hr/employee-cards.tsx
'use client'

import { useDraggable } from '@dnd-kit/core'
import { Can } from '@/components/permissions/can'
import { Permission } from '@/lib/permissions/roles'

interface EmployeeCardsProps {
  employees: any[]
}

export function EmployeeCards({ employees }: EmployeeCardsProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {employees.map((employee) => (
        <Can
          key={employee.id}
          permission={Permission.MANAGE_EMPLOYEES}
          fallback={<EmployeeCardStatic employee={employee} />}
        >
          <DraggableEmployeeCard employee={employee} />
        </Can>
      ))}
    </div>
  )
}

function DraggableEmployeeCard({ employee }: { employee: any }) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: `employee-${employee.id}`,
    data: {
      type: 'employee',
      employee: {
        id: employee.id,
        name: employee.name,
        role: employee.role,
        department: employee.department,
        employmentDate: employee.employmentDate,
        contractType: employee.contractType,
        kollektivavtal: employee.kollektivavtal?.map((ek: any) => ({
          id: ek.kollektivavtal.id,
          name: ek.kollektivavtal.name
        }))
      }
    }
  })

  const style = transform
    ? {
        transform: `translate3d(${transform.x}px, ${transform.y}px, 0)`,
        opacity: isDragging ? 0.5 : 1
      }
    : undefined

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...listeners}
      {...attributes}
      className="cursor-grab active:cursor-grabbing"
    >
      <EmployeeCard employee={employee} />
    </div>
  )
}

function EmployeeCardStatic({ employee }: { employee: any }) {
  return <EmployeeCard employee={employee} />
}

function EmployeeCard({ employee }: { employee: any }) {
  return (
    <div className="bg-white rounded-lg shadow hover:shadow-md transition-shadow p-4 border border-gray-200">
      {/* Header with Photo */}
      <div className="flex items-center gap-3 mb-3">
        <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-lg font-bold text-gray-600 flex-shrink-0">
          {employee.photoUrl ? (
            <img
              src={employee.photoUrl}
              alt={employee.name}
              className="w-12 h-12 rounded-full object-cover"
            />
          ) : (
            employee.name
              .split(' ')
              .map((n: string) => n[0])
              .join('')
              .toUpperCase()
          )}
        </div>
        <div className="flex-1 min-w-0">
          <h3 className="font-semibold text-gray-900 truncate">{employee.name}</h3>
          <p className="text-sm text-gray-600 truncate">{employee.role}</p>
        </div>
      </div>

      {/* Department */}
      {employee.department && (
        <div className="flex items-center gap-2 text-sm text-gray-600 mb-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
            />
          </svg>
          <span className="truncate">{employee.department}</span>
        </div>
      )}

      {/* Compliance Status */}
      <div className="mb-3">
        <ComplianceStatusBadge
          status={employee.complianceStatus}
          score={employee.complianceScore}
        />
      </div>

      {/* Employment Date */}
      <div className="text-xs text-gray-500">
        Employed since {new Date(employee.employmentDate).toLocaleDateString('sv-SE')}
      </div>

      {/* Drag Hint */}
      <div className="mt-3 pt-3 border-t border-gray-100 flex items-center gap-2 text-xs text-gray-400">
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
        </svg>
        <span>Drag to chat for employee-specific questions</span>
      </div>
    </div>
  )
}
```

**Chat Interface with Drop Zone:**
```typescript
// components/chat/chat-interface.tsx (updated)
'use client'

import { useState } from 'react'
import { useDroppable } from '@dnd-kit/core'
import { ChatMessages } from './chat-messages'
import { ChatInput } from './chat-input'

export function ChatInterface() {
  const [employeeContext, setEmployeeContext] = useState<any>(null)

  const { setNodeRef, isOver } = useDroppable({
    id: 'chat-drop-zone',
    data: { accepts: ['employee', 'law'] }
  })

  return (
    <div
      ref={setNodeRef}
      className={`flex flex-col h-full ${
        isOver ? 'bg-blue-50 border-2 border-blue-500 border-dashed' : ''
      }`}
    >
      {/* Drop Zone Overlay */}
      {isOver && (
        <div className="absolute inset-0 flex items-center justify-center bg-blue-50 bg-opacity-90 z-10 pointer-events-none">
          <div className="bg-blue-600 text-white px-6 py-4 rounded-lg shadow-lg">
            <p className="text-lg font-medium">Drop to add employee context</p>
          </div>
        </div>
      )}

      {/* Messages */}
      <div className="flex-1 overflow-y-auto">
        <ChatMessages />
      </div>

      {/* Input with Context */}
      <div className="border-t border-gray-200 p-4">
        {/* Employee Context Pill */}
        {employeeContext && (
          <div className="mb-3 flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <svg className="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
              <path
                fillRule="evenodd"
                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                clipRule="evenodd"
              />
            </svg>
            <div className="flex-1">
              <p className="text-sm font-medium text-blue-900">
                Employee Context: {employeeContext.name}
              </p>
              <p className="text-xs text-blue-700">
                {employeeContext.role} • {employeeContext.department}
              </p>
            </div>
            <button
              onClick={() => setEmployeeContext(null)}
              className="text-blue-600 hover:text-blue-800"
            >
              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fillRule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clipRule="evenodd"
                />
              </svg>
            </button>
          </div>
        )}

        <ChatInput employeeContext={employeeContext} onEmployeeContextChange={setEmployeeContext} />
      </div>
    </div>
  )
}
```

**DnD Context Provider:**
```typescript
// app/layout.tsx or providers.tsx (updated)
'use client'

import { DndContext, DragEndEvent, DragOverlay } from '@dnd-kit/core'
import { useState } from 'react'

export function DnDProvider({ children }: { children: React.ReactNode }) {
  const [activeId, setActiveId] = useState<string | null>(null)

  function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event

    if (!over) {
      setActiveId(null)
      return
    }

    // Handle employee drop to chat
    if (active.data.current?.type === 'employee' && over.id === 'chat-drop-zone') {
      const employeeData = active.data.current.employee
      // Trigger employee context update (via custom event or state management)
      window.dispatchEvent(
        new CustomEvent('add-employee-context', {
          detail: employeeData
        })
      )
    }

    setActiveId(null)
  }

  return (
    <DndContext onDragStart={(e) => setActiveId(e.active.id as string)} onDragEnd={handleDragEnd}>
      {children}
      <DragOverlay>
        {activeId && activeId.startsWith('employee-') && (
          <div className="bg-white rounded-lg shadow-xl p-4 border-2 border-blue-500 opacity-90">
            <p className="font-semibold">Dragging employee...</p>
          </div>
        )}
      </DragOverlay>
    </DndContext>
  )
}
```

**Update AI Prompt with Employee Context:**
```typescript
// lib/chat/generate-response.ts (updated)
export async function generateResponse({
  query,
  context,
  employeeContext
}: {
  query: string
  context: ContextChunk[]
  employeeContext?: any
}) {
  let systemPrompt = `You are Laglig.se AI assistant helping Swedish companies understand labor laws and collective agreements.

Context from laws and collective agreements:
${context.map((c) => `[${c.source}] ${c.content}`).join('\n\n')}
`

  // Add employee context if provided
  if (employeeContext) {
    systemPrompt += `

EMPLOYEE CONTEXT:
You are answering a question about this specific employee:
- Name: ${employeeContext.name}
- Role: ${employeeContext.role}
- Department: ${employeeContext.department || 'Not specified'}
- Employment Date: ${new Date(employeeContext.employmentDate).toLocaleDateString('sv-SE')}
- Contract Type: ${employeeContext.contractType}
- Kollektivavtal: ${employeeContext.kollektivavtal?.map((k: any) => k.name).join(', ') || 'None assigned'}

When answering, reference this employee's specific information. For example:
- "Based on ${employeeContext.name}'s kollektivavtal (${employeeContext.kollektivavtal?.[0]?.name})..."
- "Since ${employeeContext.name} is employed as ${employeeContext.role}..."
- "According to the collective agreement assigned to ${employeeContext.name}..."
`
  }

  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: query }
    ],
    temperature: 0.7,
    max_tokens: 1000
  })

  return response.choices[0].message.content || 'Sorry, I could not generate a response.'
}
```

**Mobile Tap-to-Add:**
```typescript
// components/hr/employee-card.tsx (updated)
'use client'

import { useIsMobile } from '@/hooks/use-is-mobile'

function EmployeeCard({ employee }: { employee: any }) {
  const isMobile = useIsMobile()

  function handleMobileTap() {
    if (isMobile) {
      window.dispatchEvent(
        new CustomEvent('add-employee-context', {
          detail: {
            id: employee.id,
            name: employee.name,
            role: employee.role,
            department: employee.department,
            employmentDate: employee.employmentDate,
            contractType: employee.contractType,
            kollektivavtal: employee.kollektivavtal?.map((ek: any) => ({
              id: ek.kollektivavtal.id,
              name: ek.kollektivavtal.name
            }))
          }
        })
      )

      // Navigate to chat
      window.location.href = '/chat'
    }
  }

  return (
    <div
      className={`bg-white rounded-lg shadow hover:shadow-md transition-shadow p-4 border border-gray-200 ${
        isMobile ? 'cursor-pointer' : ''
      }`}
      onClick={isMobile ? handleMobileTap : undefined}
    >
      {/* ... card content ... */}

      {/* Mobile Hint */}
      {isMobile && (
        <div className="mt-3 pt-3 border-t border-gray-100 flex items-center gap-2 text-xs text-gray-400">
          <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M6.672 1.911a1 1 0 10-1.932.518l.259.966a1 1 0 001.932-.518l-.26-.966zM2.429 4.74a1 1 0 10-.517 1.932l.966.259a1 1 0 00.517-1.932l-.966-.26zm8.814-.569a1 1 0 00-1.415-1.414l-.707.707a1 1 0 101.415 1.415l.707-.708zm-7.071 7.072l.707-.707A1 1 0 003.465 9.12l-.708.707a1 1 0 001.415 1.415zm3.2-5.171a1 1 0 00-1.3 1.3l4 10a1 1 0 001.823.075l1.38-2.759 3.018 3.02a1 1 0 001.414-1.415l-3.019-3.02 2.76-1.379a1 1 0 00-.076-1.822l-10-4z" />
          </svg>
          <span>Tap to add to chat</span>
        </div>
      )}
    </div>
  )
}
```

**Reference:** PRD Epic 7 Story 7.6, @dnd-kit documentation, Epic 3.5 drag-and-drop implementation

## Testing

**Unit Tests:**
- Employee card renders correctly with all fields
- Draggable employee card has correct data payload
- Drop zone accepts employee cards
- Employee context pill displays correctly
- Remove button clears employee context

**Integration Tests:**
- Drag employee card to chat, verify context added
- Ask question with employee context, verify AI response includes employee-specific information
- Remove employee context, verify subsequent questions have no employee context
- Mobile: Tap employee card, verify navigates to chat with context

**Manual Testing:**
- Toggle between table and cards view, verify both work
- Drag employee card to chat, verify drop zone highlights
- Drop employee card, verify context pill appears
- Ask "How many vacation days does [employee] have?", verify AI references their kollektivavtal
- Click remove button on context pill, verify context cleared
- Test on mobile device, verify tap-to-add functionality
- Test as non-HR Manager role, verify cards not draggable
- Test drag-and-drop in Chrome, Firefox, Safari

**Cross-Browser Testing:**
- Chrome: Drag-and-drop works smoothly
- Firefox: Drag-and-drop works smoothly
- Safari: Drag-and-drop works smoothly (test webkit-specific issues)
- Mobile Safari: Tap-to-add works correctly
- Mobile Chrome: Tap-to-add works correctly

**Privacy Testing:**
- Non-HR Manager cannot drag employee cards
- Non-HR Manager cannot see sensitive employee data in card view
- Employee context only visible to authorized roles

**Performance Testing:**
- Rendering 100 employee cards <2 seconds
- Drag-and-drop smooth (60fps)
- Context updates instant (no lag)

**Test File:** `__tests__/features/hr/employee-cards.test.tsx`

## User vs Developer Responsibilities

**User Responsibility:**
- Understand that dragging employee adds context to AI chat
- Ask employee-specific questions after adding context
- Remove employee context when switching to different questions
- Respect employee privacy (don't share sensitive information)

**Developer Responsibility:**
- Make drag-and-drop intuitive with visual feedback
- Display employee context clearly in chat interface
- Include relevant employee metadata in AI prompt (role, kollektivavtal, etc.)
- Ensure AI responses leverage employee context appropriately
- Implement privacy restrictions (only authorized roles can drag employees)
- Optimize card rendering for large employee lists
- Handle mobile tap-to-add gracefully (no drag-and-drop on mobile)
- Test across browsers and devices for consistent UX

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
