# Story 9.1: AFS Ingestion & Chapter Splitting

## Status

Draft

## Story

**As a** compliance officer using Laglig.se,
**I want** all Arbetsmiljöverket föreskrifter (AFS 2023-series) ingested with full HTML content and split into chapter-level entries for omnibus documents,
**so that** the Arbetsmiljö seed template can reference complete, browsable regulatory content for each topic area.

## Acceptance Criteria

### PDF Download & Processing

1. All 12 AFS 2023-series PDFs are downloaded from av.se
2. Each PDF is processed through the Claude PDF→HTML pipeline (same approach as amendment processing)
3. Generated HTML uses the `.legal-document` CSS structure consistent with existing SFS laws
4. HTML output passes the `validateLlmOutput()` quality checks (no errors, warnings acceptable)
5. Each processed document is stored in `legal_documents` with `content_type = 'AGENCY_REGULATION'`

### Standalone AFS Documents (6 documents)

6. AFS 2023:1 (SAM) stored as single `legal_document` entry
7. AFS 2023:3 (Construction coordination) stored as single entry
8. AFS 2023:4 (Machinery) stored as single entry
9. AFS 2023:5 (Pressure equipment) stored as single entry
10. AFS 2023:14 (Air quality limits) stored as single entry
11. AFS 2023:15 (Medical examinations) stored as single entry

### Omnibus AFS Chapter Splitting (6 documents → ~43 entries)

12. AFS 2023:2 split into 8 chapter-level entries (OSA, första hjälpen, arbetstidsanteckningar, gravida, ensamarbete, minderåriga, arbetsanpassning, våld och hot)
13. AFS 2023:9 split into 2 chapter-level entries (stegar/arbetsbockar, trycksatta anordningar)
14. AFS 2023:10 split into 17 chapter-level entries (fall, ras, ergonomi, buller, vibrationer, EMF, kemiska risker, blybatterier, smittrisker, gränsvärden, kvarts, optisk strålning, syntetiska fibrer, explosion, bekämpningsmedel, gaser, smältsvetsning)
15. AFS 2023:11 split into 12 chapter-level entries (PPE, arbetsutrustning, bildskärm, truckar, stegar, trycksatta, ställningar, motorsågar, personlyft, lyftanordningar, besiktning, pressar)
16. AFS 2023:12 split into 2 chapter-level entries (arbetsplatsutformning, belysning vid bildskärm)
17. AFS 2023:13 split into 2 chapter-level entries (byggnads-/anläggningsarbete, asbest)

### Data Quality

18. `document_number` format for chapters: `AFS 2023:10 kap. {N}` (e.g., `AFS 2023:10 kap. 3`)
19. Each entry has `full_text`, `html_content`, and `markdown_content` populated (not null)
20. Metadata includes `parent_afs` field linking chapter entries back to the full AFS document number
21. Existing stub records from Story 12.1 are updated (upsert), not duplicated
22. All entries have `status = 'ACTIVE'` and a valid `source_url` pointing to av.se

## Tasks / Subtasks

- [ ] **Task 1: Create AFS PDF download script** (AC: 1)
  - [ ] Create `scripts/download-afs-pdfs.ts`
  - [ ] Fetch PDF listing page from av.se/lag-och-ratt/foreskrifter/
  - [ ] Download all 12 AFS 2023-series PDFs to `data/afs-pdfs/` directory
  - [ ] Verify all 12 files downloaded successfully (checksum or size check)

- [ ] **Task 2: Create AFS-specific LLM prompt** (AC: 2, 3, 4)
  - [ ] Create `lib/agency/afs-prompt.ts` with system prompt for AFS→HTML conversion
  - [ ] Base on `AMENDMENT_PDF_SYSTEM_PROMPT` from `lib/sfs/amendment-llm-prompt.ts`
  - [ ] Adapt structure rules for AFS format (kapitel, paragraf, allmänna råd sections)
  - [ ] Include instructions to preserve chapter boundaries clearly in HTML output

- [ ] **Task 3: Create chapter splitting prompt** (AC: 12-17)
  - [ ] Create `lib/agency/afs-chapter-split-prompt.ts`
  - [ ] Design prompt that takes full AFS PDF and extracts a specific chapter as standalone HTML
  - [ ] Include chapter identification rules (kapitel numbering, topic boundaries)
  - [ ] Test with AFS 2023:10 (largest, 17 chapters) as validation case

- [ ] **Task 4: Create AFS ingestion pipeline script** (AC: 1-22)
  - [ ] Create `scripts/ingest-afs-regulations.ts`
  - [ ] Read PDF files from `data/afs-pdfs/`
  - [ ] For standalone AFS: send full PDF to Claude, validate HTML, store as single entry
  - [ ] For omnibus AFS: send PDF + chapter prompt to Claude for each chapter, validate, store
  - [ ] Use `prisma.legalDocument.upsert()` on `document_number` for idempotency
  - [ ] Derive `markdown_content` from HTML using `htmlToMarkdown()` transform
  - [ ] Derive `full_text` by stripping HTML tags
  - [ ] Set metadata with `parent_afs`, `source`, `chapter_number` fields
  - [ ] Add `--dry-run`, `--limit`, `--force` flags following existing script patterns
  - [ ] Log progress and cost tracking (token usage per document)

- [ ] **Task 5: Process standalone AFS documents** (AC: 6-11)
  - [ ] Run pipeline for AFS 2023:1, 2023:3, 2023:4, 2023:5, 2023:14, 2023:15
  - [ ] Validate HTML output for each
  - [ ] Verify documents render correctly with existing CSS

- [ ] **Task 6: Process omnibus AFS documents with chapter splitting** (AC: 12-17)
  - [ ] Run chapter extraction for AFS 2023:2 (8 chapters)
  - [ ] Run chapter extraction for AFS 2023:9 (2 chapters)
  - [ ] Run chapter extraction for AFS 2023:10 (17 chapters)
  - [ ] Run chapter extraction for AFS 2023:11 (12 chapters)
  - [ ] Run chapter extraction for AFS 2023:12 (2 chapters)
  - [ ] Run chapter extraction for AFS 2023:13 (2 chapters)
  - [ ] Validate all chapter entries have complete content

- [ ] **Task 7: Verification** (AC: 18-22)
  - [ ] Query database to confirm ~50 AFS entries exist with content
  - [ ] Verify no duplicate `document_number` values
  - [ ] Spot-check 5 chapter entries for HTML quality and completeness
  - [ ] Verify existing stub records were updated (not new records created alongside stubs)

## Dev Notes

### Existing Pipeline Reference

The amendment PDF→HTML pipeline is the proven foundation:

- **Prompt:** `lib/sfs/amendment-llm-prompt.ts` — `AMENDMENT_PDF_SYSTEM_PROMPT` defines HTML structure rules
- **Batch API:** `createBatchRequest()` sends PDF as base64 with `type: 'image'`, `media_type: 'application/pdf'`
- **Validation:** `lib/sfs/llm-output-validator.ts` — `validateLlmOutput()` returns `ValidationResult` with cleaned HTML
- **Transforms:** `lib/transforms/html-to-markdown.ts` for deriving markdown from HTML

For direct API calls (non-batch), PDFs use `type: 'document'` instead of `type: 'image'`.

### ContentType & Stub Records

Story 12.1 created ~51 stub records with `content_type = 'AGENCY_REGULATION'`. These have `document_number` and `title` but null `html_content`/`full_text`. The ingestion script must **upsert** to fill these stubs rather than creating duplicates.

Stubs are filtered from search/browse via `excludeStubDocuments` filter in `lib/db/queries/document-filters.ts`.

### AFS Chapter Splitting Context

Arbetsmiljöverket consolidated all provisions into 15 AFS documents effective Jan 1, 2025. Key omnibus documents:

- **AFS 2023:2** — 8 topic chapters (OSA, pregnancy, lone work, youth, adaptation, violence, first aid, working time records)
- **AFS 2023:10** — 17 topic chapters covering physical/chemical/biological hazards
- **AFS 2023:11** — 12 topic chapters covering work equipment and PPE
- **AFS 2023:13** — 2 chapters (construction work, asbestos)

Each chapter covers a distinct regulatory domain and should be a separate `legal_document` so templates can reference individual topics.

### Document Number Format

- Standalone: `AFS 2023:1`
- Chapter-level: `AFS 2023:10 kap. 3` (matching the pattern users would recognize from the AFS document structure)

### LegalDocument Schema Fields to Populate

```
html_content      — LLM-generated semantic HTML (SSOT)
markdown_content  — Derived from html_content via htmlToMarkdown()
full_text         — Plain text stripped from HTML (for search/RAG)
source_url        — URL to av.se PDF or page
metadata          — { parent_afs, chapter_number, source: 'av.se', method: 'claude-pdf-ingestion' }
status            — 'ACTIVE'
```

### Script Pattern Reference

Follow `scripts/ingest-agency-stubs.ts` and `scripts/generate-document-content.ts` for:
- CLI argument parsing (`--dry-run`, `--limit`, `--force`)
- Progress logging with counts
- Prisma upsert for idempotency
- Cost/token tracking from Anthropic API responses

### Source File

Complete document inventory: `data/seed-template-documents.csv`

## Testing

### Unit Tests

- `tests/unit/lib/agency/afs-prompt.test.ts` — Verify prompt templates produce valid system messages
- `tests/unit/lib/agency/afs-chapter-split-prompt.test.ts` — Verify chapter extraction prompt structure
- `tests/unit/scripts/ingest-afs-regulations.test.ts` — Mock Prisma + Anthropic SDK, verify upsert calls and document_number format

### Testing Standards

- **Framework:** Vitest with `happy-dom` environment
- **Mocking:** Use `vi.mock()` for `@prisma/client` and `@anthropic-ai/sdk`
- **Location:** `tests/unit/` mirror of source tree
- **No real LLM calls in tests** — mock all Anthropic SDK interactions
- **Verify idempotency:** Running script twice should not create duplicate records

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft created from Epic 9 analysis | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*To be filled after QA review*
