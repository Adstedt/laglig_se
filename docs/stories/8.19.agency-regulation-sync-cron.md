# Story 8.19: Agency Regulation Sync Cron

## Status

Draft (v1 — new story, created 2026-02-17)

## Story

**As a** platform,
**I need** a scheduled cron job that runs agency adapters and processes detected changes into the notification pipeline,
**so that** agency regulation amendments are detected and communicated to users just like SFS amendments.

## Context & Dependencies

**Why this story exists:**

Stories 8.17 and 8.18 give us ingested agency documents and adapters that can detect changes. This story is the orchestration layer — the cron job that runs those adapters on a schedule, processes detected changes, and feeds them into the same `ChangeEvent` → `Notification` → email pipeline built in Phase 1.

**Builds on:**

- Story 8.17 (Expand Ingestion) — baseline documents with content hashes
- Story 8.18 (Adapter Pattern) — per-agency adapters that detect changes
- Story 8.15 (Notification Service) — `createChangeNotifications()` for user notification
- Story 8.16 (Template Propagation) — `propagateAmendmentToTemplates()` for template sync
- Story 8.4 (Daily Email Digest) — picks up `ChangeEvent.notification_sent = false` for email delivery
- `sync-sfs-updates` cron — pattern reference for cron structure, timeout handling, stats

**Depends on:**

- Story 8.17 + 8.18 (must be complete — need documents + adapters)
- Story 8.15 (notification service must exist to wire into)

**Depended on by:** Nothing — this completes the Phase 3 pipeline.

## Acceptance Criteria

### Cron Job

1. New cron endpoint at `/api/cron/sync-agency-regulations`
2. Schedule: Weekly on Monday at 06:00 UTC (before daily digest at 07:00)
3. `maxDuration = 300` with 30s timeout buffer (same pattern as SFS crons)
4. Auth check: verify `CRON_SECRET` header (same pattern as existing crons)

### Orchestration

5. Iterate all implemented adapters from Story 8.18's registry (`getImplementedAdapters()`)
6. For each adapter, call `checkForUpdates()` with timeout protection (max 60s per agency)
7. Collect all `AgencyUpdateResult` entries across all agencies
8. Process each update based on `changeType`:

### Processing — UPDATED Documents

9. For `changeType = 'UPDATED'`:
   - Fetch new content via adapter's `fetchDocumentContent()`
   - Archive previous version via `DocumentVersion` (same pattern as `sync-sfs-updates`)
   - Update `LegalDocument` with new content (html, markdown, json, full_text)
   - Update `metadata.contentHash` with new hash
   - Update `metadata.lastIngested` timestamp
   - Create `ChangeEvent` record:
     - `document_id`: the LegalDocument ID
     - `content_type: AGENCY_REGULATION`
     - `change_type: AMENDMENT` (or `METADATA_UPDATE` if only minor changes)
     - `diff_summary`: generated from old vs. new content
     - `notification_sent: false` (picked up by Story 8.4 daily digest)
   - Call `propagateAmendmentToTemplates()` (Story 8.16) if applicable
   - Call `createChangeNotifications()` (Story 8.15) to create Notification records

### Processing — NEW Documents

10. For `changeType = 'NEW'`:
    - Fetch content via adapter's `fetchDocumentContent()`
    - Create new `LegalDocument` record with `content_type: AGENCY_REGULATION`
    - Process content through appropriate pipeline (HTML transform or PDF-direct LLM)
    - Compute and store content hash
    - Create `ChangeEvent` with `change_type: NEW_LAW`
    - Generate summering + kommentar inline (Sonnet) if within timeout budget
    - Create Notification records for workspaces that might care (via template domain matching)

### Processing — REMOVED Documents

11. For `changeType = 'REMOVED'`:
    - Update `LegalDocument.status = ARCHIVED`
    - Create `ChangeEvent` with `change_type: REPEAL`
    - Create Notification records for affected workspaces
    - Do NOT delete the document (preserve for historical reference)

### Stats & Monitoring

12. Cron returns JSON stats:
    ```json
    {
      "agenciesChecked": 3,
      "agenciesFailed": 0,
      "updatesDetected": 2,
      "documentsUpdated": 1,
      "documentsNew": 1,
      "documentsRemoved": 0,
      "changeEventsCreated": 2,
      "notificationsCreated": 8,
      "templateItemsUpdated": 3,
      "contentGenerated": 1,
      "duration": 145000,
      "perAgency": {
        "afs": { "checked": 81, "updates": 1, "errors": 0 },
        "nfs": { "checked": 13, "updates": 1, "errors": 0 },
        "msbfs": { "checked": 12, "updates": 0, "errors": 0 }
      }
    }
    ```
13. Admin notification email sent after completion (reuse `sendSfsSyncEmail` pattern)
14. Include per-agency breakdown in admin email

### Error Handling

15. Adapter failure for one agency does not block processing of other agencies
16. Document processing failure for one document does not block other documents
17. All errors logged with agency code, document number, and error details
18. Failed documents tracked in stats: `{ failed: [{ documentNumber, error }] }`

### LLM Processing (for content updates)

19. When a document's content has changed and needs re-processing through LLM:
    - For HTML-scrapable (AFS): use existing `afs-html-transformer.ts` (no LLM needed)
    - For PDF-based: use adapted PDF-direct pipeline from Story 8.17
    - Validate output, derive markdown/json/plaintext
20. If LLM processing fails, store raw content and mark for manual review:
    - `metadata.needsReview = true`
    - `metadata.reviewReason = "LLM processing failed: {error}"`

## Tasks / Subtasks

- [ ] **Task 1: Create cron route** (AC: 1-4)
  - [ ] Create `app/api/cron/sync-agency-regulations/route.ts`
  - [ ] Add to `vercel.json` crons: `"0 6 * * 1"` (Monday 06:00 UTC)
  - [ ] Implement auth check, timeout protection pattern
- [ ] **Task 2: Build orchestration loop** (AC: 5-8)
  - [ ] Iterate adapters from registry
  - [ ] Per-adapter timeout protection (60s)
  - [ ] Collect and merge update results
  - [ ] Route to appropriate processing handler by changeType
- [ ] **Task 3: Build UPDATED handler** (AC: 9)
  - [ ] Fetch new content from adapter
  - [ ] Archive previous version (DocumentVersion)
  - [ ] Update LegalDocument with new content
  - [ ] Update metadata (contentHash, lastIngested)
  - [ ] Generate diff summary
  - [ ] Create ChangeEvent
  - [ ] Call template propagation (Story 8.16)
  - [ ] Call notification service (Story 8.15)
- [ ] **Task 4: Build NEW handler** (AC: 10)
  - [ ] Fetch content from adapter
  - [ ] Create LegalDocument record
  - [ ] Process through content pipeline
  - [ ] Create ChangeEvent
  - [ ] Optional: inline summering/kommentar generation
- [ ] **Task 5: Build REMOVED handler** (AC: 11)
  - [ ] Update document status to ARCHIVED
  - [ ] Create ChangeEvent with REPEAL type
  - [ ] Create notifications
- [ ] **Task 6: Stats tracking and admin email** (AC: 12-14)
  - [ ] Build stats accumulator
  - [ ] Per-agency tracking
  - [ ] Send admin email on completion
- [ ] **Task 7: Error handling** (AC: 15-18)
  - [ ] Per-agency try/catch with continue
  - [ ] Per-document try/catch with continue
  - [ ] Error logging with context
  - [ ] Failed documents in stats
- [ ] **Task 8: LLM processing for content updates** (AC: 19-20)
  - [ ] Route to HTML transform or PDF-direct based on agency type
  - [ ] Failure handling: store raw content, mark for review

## Dev Notes

### Source Tree

```
app/api/cron/sync-agency-regulations/
  └── route.ts                              — NEW: weekly cron

lib/agency/adapters/                        — Story 8.18
  ├── types.ts
  ├── index.ts
  ├── afs-adapter.ts
  ├── nfs-adapter.ts
  └── msbfs-adapter.ts

lib/notifications/                          — Story 8.15
  ├── amendment-notifications.ts            — createChangeNotifications()
  ├── template-propagation.ts              — Story 8.16: propagateAmendmentToTemplates()
  └── recipient-resolution.ts              — resolveAffectedRecipients()

lib/sync/
  ├── change-detection.ts                   — Existing: diff analysis, ChangeEvent creation
  └── version-archive.ts                    — Existing: DocumentVersion archival

lib/email/
  └── cron-notifications.ts                 — Existing: admin notification email
```

### Key Data Models

```
AgencyUpdateResult (from adapter)
  ├─ documentNumber: "NFS 2016:8"
  ├─ changeType: "UPDATED"
  ├─ currentUrl: "https://naturvardsverket.se/..."
  └─ detectedAt: Date

Processing flow:
  AgencyAdapter.checkForUpdates()
    → AgencyUpdateResult[]
      → For UPDATED:
          ├─ Archive DocumentVersion
          ├─ Update LegalDocument (content, hash)
          ├─ Create ChangeEvent (content_type: AGENCY_REGULATION)
          ├─ propagateAmendmentToTemplates()
          └─ createChangeNotifications()
      → Flows into Story 8.4 daily digest via ChangeEvent.notification_sent = false

ChangeEvent (created)
  ├─ document_id → LegalDocument (the agency regulation)
  ├─ content_type: AGENCY_REGULATION
  ├─ change_type: AMENDMENT | NEW_LAW | REPEAL
  ├─ diff_summary: "+15 lines, -3 lines"
  ├─ notification_sent: false        ← picked up by Story 8.4
  └─ detected_at: now()
```

### Cron Timing

```
Monday schedule:
  06:00 UTC — sync-agency-regulations (this cron)    ← weekly

Daily schedule:
  04:00 UTC — sync-sfs (new laws)
  04:30 UTC — sync-sfs-updates (amendments)
  05:00 UTC — sync-court-cases
  07:00 UTC — notify-amendment-changes (Story 8.4)   ← picks up ALL ChangeEvents
```

The Monday agency sync at 06:00 runs before the daily digest at 07:00, so agency regulation changes detected on Monday morning will be included in that day's email digest.

### Cron Route Pattern

```typescript
// app/api/cron/sync-agency-regulations/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { getImplementedAdapters } from '@/lib/agency/adapters'

export const maxDuration = 300

export async function GET(req: NextRequest) {
  // Auth check
  const authHeader = req.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const startTime = Date.now()
  const maxRuntime = maxDuration * 1000 - 30000 // 270s safe
  const stats = { agenciesChecked: 0, /* ... */ }

  const adapters = getImplementedAdapters()

  for (const adapter of adapters) {
    if (Date.now() - startTime > maxRuntime) {
      console.log('Approaching timeout, stopping')
      break
    }

    try {
      const updates = await Promise.race([
        adapter.checkForUpdates(),
        new Promise<never>((_, reject) =>
          setTimeout(() => reject(new Error('Adapter timeout')), 60000)
        )
      ])

      stats.agenciesChecked++

      for (const update of updates) {
        // Process each update...
      }
    } catch (err) {
      console.error(`Agency ${adapter.agencyCode} failed:`, err)
      stats.agenciesFailed++
    }
  }

  // Send admin email
  // Return stats
  return NextResponse.json(stats)
}
```

### Change Detection vs. False Positives

Agency websites may change HTML structure (layout updates, CSS changes) without the regulation content actually changing. To avoid false positives:

1. Content hash is computed on **normalized** HTML (whitespace-collapsed, stripped of non-content elements)
2. For HTML-scrapable agencies: hash only the `div.provision` (regulation text), not the full page
3. For PDF-based agencies: hash the PDF URL + any version metadata, not the landing page HTML
4. When a change is detected, generate a diff summary — if diff is empty/trivial, skip notification

## Testing

**Test location:** `app/api/cron/sync-agency-regulations/__tests__/route.test.ts`

**Test framework:** Vitest with `vi.mock()` for adapters, Prisma, fetch

**Unit tests:**
- Orchestration: iterates all implemented adapters
- Orchestration: adapter failure doesn't block other agencies
- Orchestration: timeout protection stops loop near maxDuration
- UPDATED handler: archives version, updates document, creates ChangeEvent
- UPDATED handler: calls template propagation and notification service
- NEW handler: creates LegalDocument, ChangeEvent
- REMOVED handler: archives document, creates REPEAL ChangeEvent
- Stats: correct per-agency breakdown
- Error handling: failed document tracked in stats, processing continues

**Integration test (manual):**
```bash
# Test locally
curl -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/cron/sync-agency-regulations
```

## Change Log

| Date       | Version | Description                  | Author     |
| ---------- | ------- | ---------------------------- | ---------- |
| 2026-02-17 | 1.0     | Initial story creation       | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
