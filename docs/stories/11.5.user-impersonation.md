# Story 11.5: User Impersonation

## Status

Draft

## Story

**As an** admin,
**I want** to log in as any user to see exactly what they see,
**so that** I can debug issues and provide effective customer support.

## Acceptance Criteria

1. "Logga in som [user name]" button on user detail page (`/admin/users/[id]`) — replaces the disabled placeholder from Story 11.4
2. Clicking the button shows a confirmation dialog: "Du kommer att logga in som [name] ([email]). Din admin-session behålls."
3. On confirm: server action creates a valid NextAuth-compatible JWT for the target user and sets it as the `next-auth.session-token` cookie
4. Admin is redirected to `/dashboard` as the impersonated user
5. A fixed banner is shown at the top of all workspace pages during impersonation: "Du är inloggad som [name] ([email])" with a "Tillbaka till admin" link
6. The `admin_session` cookie is preserved during impersonation — it is NOT cleared
7. Clicking "Tillbaka till admin" clears the impersonated NextAuth session cookie and redirects to `/admin/users/[id]`
8. Impersonation events are logged in `ActivityLog` with `entity_type: 'IMPERSONATION'` and action `START` or `END`
9. Impersonation works across all workspace routes the target user has access to
10. If the target user has no workspaces, impersonation still works (they'll be redirected to `/onboarding` as expected)

## Tasks / Subtasks

- [ ] **Task 1: Create impersonation server actions** (AC: 3, 6, 7, 8)
  - [ ] Create `app/actions/admin-impersonate.ts` with `'use server'` directive
  - [ ] `startImpersonation(userId: string)`:
    - Verify admin session via `getAdminSession()` — reject if not admin
    - Look up target user in Prisma by ID — reject if not found
    - Create a NextAuth-compatible JWT using `jose`:
      ```typescript
      const token = await new SignJWT({
        id: targetUser.id,
        email: targetUser.email,
        name: targetUser.name,
        sub: targetUser.id,
      })
        .setProtectedHeader({ alg: 'HS256' })
        .setIssuedAt()
        .setExpirationTime('1h') // Short-lived for security
        .sign(new TextEncoder().encode(process.env.NEXTAUTH_SECRET))
      ```
    - Set `next-auth.session-token` cookie with the generated JWT (match NextAuth cookie settings: HttpOnly, Secure, SameSite=Lax, path=/)
    - Do NOT clear `admin_session` cookie
    - Log to ActivityLog: `{ entity_type: 'IMPERSONATION', action: 'START', old_value: adminEmail, new_value: targetUser.email }`
    - Return `{ success: true }`
  - [ ] `endImpersonation()`:
    - Verify admin session via `getAdminSession()` — must still be present
    - Read the current NextAuth session to get the impersonated user's ID (for redirect)
    - Clear `next-auth.session-token` cookie (set to empty, maxAge=0)
    - Also clear `active_workspace_id` cookie to reset workspace context
    - Log to ActivityLog: `{ entity_type: 'IMPERSONATION', action: 'END' }`
    - Return `{ success: true, userId }` (the impersonated user's ID, for redirect back to detail page)

- [ ] **Task 2: Create impersonation banner component** (AC: 5, 7)
  - [ ] Create `components/admin/impersonation-banner.tsx` — `'use client'` component
  - [ ] Fixed position banner at the very top of the viewport (above everything, z-50)
  - [ ] Background: red/orange gradient or solid warning color
  - [ ] Text: "Du är inloggad som [name] ([email])"
  - [ ] "Tillbaka till admin" link/button on the right side
  - [ ] Clicking "Tillbaka till admin" calls `endImpersonation()` action, then redirects to `/admin/users/[userId]`
  - [ ] The banner must be visible on ALL pages during impersonation — so it's rendered conditionally in the workspace layout

- [ ] **Task 3: Integrate banner into workspace layout** (AC: 5, 9)
  - [ ] Modify `app/(workspace)/layout.tsx`:
    - Import and check for `admin_session` cookie presence
    - If `admin_session` cookie exists AND `next-auth.session-token` cookie exists (impersonation in progress):
      - Read admin session email and current user session email
      - If they differ → render `ImpersonationBanner` above the workspace shell
    - This adds minimal overhead: just a cookie read, no DB query
  - [ ] The banner should push down the rest of the page content (not overlap)

- [ ] **Task 4: Enable impersonate button on user detail page** (AC: 1, 2)
  - [ ] Modify `app/admin/(dashboard)/users/[id]/page.tsx`:
    - Replace the disabled placeholder button with an active `'use client'` component
  - [ ] Create `components/admin/impersonate-button.tsx` — `'use client'` component:
    - Props: `userId: string`, `userName: string`, `userEmail: string`
    - Button: "Logga in som [userName]" with `variant="outline"`
    - On click: show `AlertDialog` with confirmation text
    - On confirm: call `startImpersonation(userId)`, then `router.push('/dashboard')`
    - Loading state during action execution

- [ ] **Task 5: Handle impersonation detection helper** (AC: 5, 6)
  - [ ] Add to `lib/admin/auth.ts`:
  - [ ] `isImpersonating(): Promise<boolean>` — checks if both `admin_session` and `next-auth.session-token` cookies are present and the admin session is valid
  - [ ] `getImpersonationInfo(): Promise<{ adminEmail: string; impersonatedEmail: string } | null>` — returns info about the current impersonation, or null if not impersonating

- [ ] **Task 6: Testing** (AC: all)
  - **Automated (Vitest)** — write in `tests/unit/actions/admin-impersonate.test.ts`:
  - [ ] Test: `startImpersonation()` rejects without admin session
  - [ ] Test: `startImpersonation()` rejects for non-existent user
  - [ ] Test: `startImpersonation()` creates a valid JWT with target user's data
  - [ ] Test: `startImpersonation()` logs IMPERSONATION START to ActivityLog
  - [ ] Test: `endImpersonation()` rejects without admin session
  - [ ] Test: `endImpersonation()` clears next-auth session cookie
  - [ ] Test: `endImpersonation()` logs IMPERSONATION END to ActivityLog
  - **Manual (critical — must test full flow):**
  - [ ] Test: admin clicks impersonate → sees confirmation dialog → confirms → lands on dashboard as target user
  - [ ] Test: impersonation banner visible on all workspace pages
  - [ ] Test: click "Tillbaka till admin" → returned to admin panel, no longer impersonating
  - [ ] Test: admin session persists throughout impersonation (can return to admin)
  - [ ] Test: impersonating user with no workspaces → redirected to /onboarding
  - [ ] Test: impersonating user with multiple workspaces → workspace selector works normally
  - [ ] Test: original user session is not affected (they're not logged out)

## Dev Notes

### Dependencies

- **Blocked by:** Story 11.4 (User Management) — impersonate button on user detail page
- **Blocked by:** Story 11.1 (Admin Auth & Shell Layout) — admin session utilities

### Architecture Context

This is the most security-sensitive story in Epic 11. The impersonation creates a real NextAuth session — the system cannot distinguish an impersonated session from a real one (by design, so the admin sees exactly what the user sees). The safety mechanisms are:

1. **Short-lived JWT** (1 hour) — impersonation sessions auto-expire
2. **Admin session preservation** — the `admin_session` cookie is never cleared, so the admin can always return
3. **Audit logging** — every impersonation start/end is logged with timestamps and emails
4. **Banner visibility** — the impersonation banner cannot be dismissed, ensuring the admin knows they're impersonating

### Relevant Source Tree

```
app/actions/
  admin-impersonate.ts                # NEW: startImpersonation(), endImpersonation()

components/admin/
  impersonation-banner.tsx            # NEW: Fixed top banner during impersonation
  impersonate-button.tsx              # NEW: Button + AlertDialog on user detail page

lib/admin/
  auth.ts                             # EXTEND: isImpersonating(), getImpersonationInfo()

app/(workspace)/layout.tsx            # MODIFY: Add impersonation banner rendering
  - Line 1-12: Existing imports
  - Line 40-89: WorkspaceLayout function — add banner check before <WorkspaceShell>

app/admin/(dashboard)/users/[id]/page.tsx  # MODIFY: Replace disabled button with ImpersonateButton

# REFERENCE FILES:
app/api/auth/[...nextauth]/route.ts   # NextAuth config — Line 62-64: JWT strategy, NEXTAUTH_SECRET
  - Line 72-78: jwt callback — token shape: { id, email, name, sub }
  - Line 80-87: session callback — session.user shape
lib/auth/workspace-context.ts         # ACTIVE_WORKSPACE_COOKIE constant — clear on end impersonation
```

### Key Implementation Details

1. **NextAuth JWT format.** The JWT created for impersonation must match what NextAuth expects. From `route.ts:72-78`, the JWT callback sets `token.id`, `token.email`, `token.name`. The JWT must include `sub` (NextAuth convention) and these fields.

2. **Cookie name for NextAuth.** In development it's `next-auth.session-token`. In production (HTTPS) it's `__Secure-next-auth.session-token`. Handle both:

   ```typescript
   const cookieName =
     process.env.NODE_ENV === 'production'
       ? '__Secure-next-auth.session-token'
       : 'next-auth.session-token'
   ```

3. **NEXTAUTH_SECRET.** The impersonation JWT MUST be signed with `process.env.NEXTAUTH_SECRET` (not `ADMIN_JWT_SECRET`) because NextAuth will verify it using that secret.

4. **Workspace cookie cleanup.** When ending impersonation, clear `active_workspace_id` cookie (from `lib/auth/workspace-context.ts`, constant `ACTIVE_WORKSPACE_COOKIE`) so the admin doesn't accidentally remain in the impersonated user's workspace context.

5. **Banner positioning.** The impersonation banner must be above the `PausedWorkspaceBanner` (from `layout.tsx:80-86`). Insert it as the very first child:

   ```tsx
   return (
     <>
       {isImpersonating && <ImpersonationBanner adminEmail={...} userName={...} userEmail={...} userId={...} />}
       {workspaceContext.workspaceStatus === 'PAUSED' && <PausedWorkspaceBanner ... />}
       <WorkspaceShell user={user}>{children}</WorkspaceShell>
     </>
   )
   ```

6. **Security consideration.** The impersonation JWT has a 1-hour expiry. If the admin forgets to end impersonation, the session will expire naturally and the admin will be redirected to the login page. The `admin_session` cookie (24h expiry) will still be valid, so they can navigate back to `/admin`.

### Coding Standards

- Server actions with `'use server'` directive [Source: architecture/17-coding-standards.md#17.5]
- `jose` library for JWT operations (already available) [Source: NextAuth dependency]
- shadcn/ui AlertDialog for confirmation [Source: architecture/17-coding-standards.md#17.3]
- ActivityLog for audit trail [Source: prisma/schema.prisma — ActivityLog model]
- Minimal changes to existing layout — only add conditional banner render

### Testing

- **Test file location**: `tests/unit/actions/admin-impersonate.test.ts`
- **Testing framework**: Vitest [Source: architecture/17-coding-standards.md]
- **Mock strategy**: Mock `cookies()`, `getAdminSession()`, `prisma`, `SignJWT`
- **Critical manual tests**: Full impersonation flow (start → navigate as user → return to admin), cookie coexistence, banner visibility across routes

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-02-02 | 1.0     | Initial story creation | Sarah (PO) |
