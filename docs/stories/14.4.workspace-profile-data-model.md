# Story 14.4: WorkspaceProfile Data Model & Settings UI

## Status

Draft

## Story

**As a** workspace admin,
**I want** to maintain structured information about my company,
**so that** the compliance partner can give me relevant, company-specific guidance.

## Context & Dependencies

This is the first company context story in Epic 14 Phase 2. The WorkspaceProfile stores structured data about the company — industry, size, activities, certifications. The conversational onboarding flow (Story 14.5) will auto-populate these fields, but users can also edit them directly via settings.

- **Builds on:** Existing Workspace model in `prisma/schema.prisma`
- **Depends on:** Nothing (can start independently)
- **Depended on by:** 14.5 (onboarding populates profile), 14.7 (agent tools read profile), 14.9 (system prompt references profile)

## Acceptance Criteria

### Schema

1. Prisma model `WorkspaceProfile` with 1:1 relation to Workspace
2. Fields: companyName (String?), orgNumber (String?), organizationType (enum), sniCode (String?), industryLabel (String?), employeeCountRange (enum), activityFlags (Json), certifications (String[]), complianceMaturity (enum), hasComplianceOfficer (Boolean, default false), profileCompleteness (Int, default 0), lastOnboardingAt (DateTime?)
3. OrganizationType enum: AB, HB, KOMMUN, REGION, STATLIG_MYNDIGHET, ENSKILD_FIRMA, EKONOMISK_FORENING, OTHER
4. EmployeeCountRange enum: RANGE_1_9, RANGE_10_49, RANGE_50_249, RANGE_250_PLUS, UNKNOWN
5. ComplianceMaturity enum: BASIC, DEVELOPING, ESTABLISHED, ADVANCED
6. Database migration runs cleanly, non-breaking (all fields nullable or with defaults)
7. Existing workspaces get auto-created empty WorkspaceProfile on first access (lazy creation pattern)

### Server Actions

8. `getWorkspaceProfile()` — returns profile for current workspace, creates if not exists
9. `updateWorkspaceProfile(data)` — updates profile fields, recalculates profileCompleteness
10. Profile completeness calculated based on filled fields (each non-null field contributes points)

### Settings UI

11. New section in workspace settings page: "Foretagsprofil" (Company Profile)
12. Form with fields for all profile data, using shadcn/ui form components
13. Activity flags displayed as toggle switches (chemicals, construction, food, personalData, publicSector, heavyMachinery)
14. Certifications as a tag input (add/remove ISO standards)
15. Save button with optimistic update and Swedish success/error messages
16. Profile completeness shown as progress bar with percentage

### Testing

17. At least 10 unit tests covering server actions and completeness calculation

## Tasks / Subtasks

- [ ] **Task 1: Prisma schema + migration** (AC: 1-6)
  - [ ] Add `WorkspaceProfile` model to `prisma/schema.prisma`
  - [ ] Add `OrganizationType` enum with all values
  - [ ] Add `EmployeeCountRange` enum with all values
  - [ ] Add `ComplianceMaturity` enum with all values
  - [ ] Add 1:1 relation: `Workspace.profile` <-> `WorkspaceProfile.workspace`
  - [ ] All fields nullable or with defaults to ensure non-breaking migration
  - [ ] Generate and run migration
  - [ ] Verify migration runs cleanly on existing database

- [ ] **Task 2: Server actions** (AC: 7-10)
  - [ ] Create `app/actions/workspace-profile.ts`
  - [ ] Implement `getWorkspaceProfile()` with lazy creation via upsert
  - [ ] Implement `updateWorkspaceProfile(data)` with Zod validation
  - [ ] Implement `calculateProfileCompleteness()` helper
  - [ ] Core fields (companyName, organizationType, industryLabel, employeeCountRange) = 60% weight
  - [ ] Extended fields (sniCode, activityFlags, certifications, complianceMaturity) = 40% weight
  - [ ] Use `withWorkspace(callback, 'read')` for reads, `withWorkspace(callback, 'write')` for mutations

- [ ] **Task 3: Settings UI** (AC: 11-16)
  - [ ] Add "Foretagsprofil" section/tab to `app/(workspace)/installningar/page.tsx`
  - [ ] Company name and org number text inputs
  - [ ] Organization type select dropdown
  - [ ] SNI code + industry label inputs
  - [ ] Employee count range select dropdown
  - [ ] Activity flags as toggle switches (chemicals, construction, food, personalData, publicSector, heavyMachinery)
  - [ ] Certifications tag input component (add/remove)
  - [ ] Compliance maturity select dropdown
  - [ ] Has compliance officer toggle
  - [ ] Profile completeness progress bar with percentage
  - [ ] Save button with optimistic update
  - [ ] Swedish success/error toast messages

- [ ] **Task 4: Tests** (AC: 17)
  - [ ] Write unit tests for `getWorkspaceProfile()` lazy creation
  - [ ] Write unit tests for `updateWorkspaceProfile()` validation
  - [ ] Write unit tests for completeness calculation (all empty, partially filled, fully filled)
  - [ ] Write unit tests for core vs extended field weighting
  - [ ] Minimum 10 tests total

## Dev Notes

- Settings page route: `app/(workspace)/installningar/page.tsx` — add a new section or tab for company profile
- Use `withWorkspace(callback, 'read')` for reads, `withWorkspace(callback, 'write')` for mutations (from `lib/auth/workspace-context.ts`)
- Activity flags JSON shape: `{ chemicals: boolean, construction: boolean, food: boolean, personalData: boolean, publicSector: boolean, heavyMachinery: boolean }`
- Profile completeness weighting:
  - Core fields (companyName, organizationType, industryLabel, employeeCountRange) = 60% total (15% each)
  - Extended fields (sniCode, activityFlags, certifications, complianceMaturity) = 40% total (10% each)
- Lazy creation: when `getWorkspaceProfile()` is called and no profile exists, create one with all defaults and return it. Use Prisma `upsert` with empty `create` and no-op `update`.
- Zod validation schema for `updateWorkspaceProfile` input — validate enum values, string lengths, JSON shape
- Source tree:
  - `prisma/schema.prisma` — add WorkspaceProfile model and enums
  - `app/actions/workspace-profile.ts` (new) — server actions
  - `app/(workspace)/installningar/` — existing settings page to extend

## Testing

- **Test file:** `tests/unit/actions/workspace-profile.test.ts`
- **What to test:**
  - Lazy creation: calling `getWorkspaceProfile()` when no profile exists creates one
  - Lazy creation: calling `getWorkspaceProfile()` when profile exists returns it
  - `updateWorkspaceProfile()` with valid data updates fields
  - `updateWorkspaceProfile()` with invalid enum value rejects
  - Completeness: all fields empty = 0%
  - Completeness: only core fields filled = 60%
  - Completeness: only extended fields filled = 40%
  - Completeness: all fields filled = 100%
  - Completeness: partial fill calculates correctly
  - Activity flags JSON validation
- **Patterns to follow:** Mock Prisma client, mock `withWorkspace()` wrapper. Use `vi.mock` for dependencies. Follow existing test patterns in `tests/unit/actions/`.

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2026-02-18 | 0.1     | Initial draft                  | Claude |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
