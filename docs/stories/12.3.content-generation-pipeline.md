# Story 12.3: Build Content Generation Pipeline (Summering + Kommentar)

## Status

Draft

## Story

**As a** content creator,
**I want** an AI pipeline that generates a neutral summary ("Summering") and actionable compliance commentary ("Kommentar") for legal documents, grounded in actual legal source text,
**so that** every document in the system has consistent, high-quality, dual-voice content that can be displayed on law pages, in templates, and throughout the platform.

## Acceptance Criteria

1. Schema migration: add `kommentar` (`String? @db.Text`), `summering_generated_by` (`String?`), and `kommentar_generated_by` (`String?`) fields to `LegalDocument` model
2. Existing `LegalDocument.summary` field is repurposed as "Summering" (no rename — already used in ~14 files). Comment updated in schema to clarify purpose.
3. Node script created: `scripts/generate-document-content.ts` that processes legal documents and generates both Summering and Kommentar
4. **Summering prompt** (neutral voice): generates a descriptive summary of what the law regulates — scope, purpose, key provisions. 3-5 sentences, third-person, factual tone. Few-shot examples sourced from `notisumComment` field in `data/notisum-amnesfokus/notisum-full-data.json`
5. **Kommentar prompt** (laglig.se voice): generates actionable compliance commentary — what the organization must do. "Vi ska...", "Vi behöver..." phrasing, obligation-focused, 2-4 sentences/bullets. Few-shot examples sourced from `summaryText` field in `data/notisum-amnesfokus/notisum-full-data.json`
6. Per-document LLM context includes: `LegalDocument.html_content` (SSOT) with HTML stripped/converted for LLM input, falling back to `markdown_content` then `full_text` if unavailable. Plus related amendments from `Amendment` model, document metadata (SFS/AFS number, content_type, effective_date, status)
7. Quality validation: Summering is neutral/factual (no "Vi ska..."), Kommentar starts with obligation-focused phrasing, both are appropriate length, no hallucinated content
8. Documents updated with generated content + `summering_generated_by` / `kommentar_generated_by` = model identifier
9. Batch processing with rate limiting, resumable (skips documents that already have content unless `--force` flag)
10. Cost tracking: tokens used and cost per document logged
11. Script supports `--scope` flag: `template-docs` (only documents referenced by TemplateItems, ~265 docs) or `all` (all LegalDocuments with source text)
12. `TemplateItem.compliance_summary` and `expert_commentary` remain as optional template-specific overrides — display logic: show TemplateItem override if present, otherwise fall back to LegalDocument fields

## Tasks / Subtasks

- [ ] **Task 1: Schema migration — add fields to LegalDocument** (AC: 1, 2)
  - [ ] Add `kommentar String? @db.Text` to LegalDocument model
  - [ ] Add `summering_generated_by String?` to LegalDocument model
  - [ ] Add `kommentar_generated_by String?` to LegalDocument model
  - [ ] Update `summary` field comment: `// Summering — neutral description of what the law regulates`
  - [ ] Run `pnpm prisma db push` and `pnpm prisma generate`
  - [ ] Verify `tsc --noEmit` passes
- [ ] **Task 2: Build Summering system prompt** (AC: 4)
  - [ ] Extract 5-8 representative `notisumComment` examples from `notisum-full-data.json` as few-shot style references
  - [ ] Extract relevant style guidance from `11-agent-training-guide.md` (neutral voice patterns)
  - [ ] Compose Summering system prompt: instruct LLM to summarize scope, purpose, and key provisions in neutral third-person voice, 3-5 sentences
  - [ ] Store prompt template in `scripts/prompts/` or `lib/ai/prompts/`
- [ ] **Task 3: Build Kommentar system prompt** (AC: 5)
  - [ ] Extract 5-8 representative `summaryText` examples from `notisum-full-data.json` as few-shot style references
  - [ ] Extract Section 5 (Compliance Summary Style Guide), Section 10 (DO/DON'T patterns) from `11-agent-training-guide.md`
  - [ ] Compose Kommentar system prompt: instruct LLM to describe what the organization must do, "Vi ska..." voice, obligation-focused, 2-4 sentences
  - [ ] Store prompt template alongside Summering prompt
- [ ] **Task 4: Build per-document context assembly** (AC: 6)
  - [ ] Fetch `LegalDocument` with `html_content` (SSOT), falling back to `markdown_content` then `full_text`
  - [ ] Fetch related amendments via `Amendment` model (base_document_id → amending_law_title, effective_date, affected_sections)
  - [ ] Build context object: document_number, title, content_type, effective_date, source text, amendment history
  - [ ] Strip/convert HTML to plain text or markdown for LLM input (use `html_content` → strip tags)
  - [ ] Handle documents without html_content gracefully (fall back to markdown_content → full_text; log warning and skip if none available)
  - [ ] For AFS 2023 consolidated provisions, include "ersätter" mapping context from metadata
- [ ] **Task 5: Implement LLM generation** (AC: 3)
  - [ ] Create `scripts/generate-document-content.ts`
  - [ ] Use AI SDK (`@ai-sdk/openai` or configurable provider) for LLM calls
  - [ ] Two generation calls per document: one for Summering, one for Kommentar
  - [ ] Consider single combined call with structured output (may be cheaper) — benchmark both approaches
  - [ ] Define structured output schema for both fields
- [ ] **Task 6: Implement quality validation** (AC: 7)
  - [ ] Validate Summering: neutral tone (no "Vi ska...", no first-person plural), 3-5 sentences, factual
  - [ ] Validate Kommentar: starts with obligation-focused phrasing ("Vi ska...", "Vi behöver..."), 2-4 sentences/bullets, active voice
  - [ ] Validate both: appropriate length, no obviously hallucinated references
  - [ ] Log validation warnings per document (don't block, but flag)
- [ ] **Task 7: Implement batch processing** (AC: 9, 11)
  - [ ] `--scope template-docs`: query documents referenced by TemplateItems (~265 documents)
  - [ ] `--scope all`: query all LegalDocuments with non-null html_content (or markdown_content/full_text fallback)
  - [ ] Process sequentially with configurable delay between calls
  - [ ] Rate limiting (respect LLM provider limits)
  - [ ] Skip documents where summary/kommentar already exists unless `--force` flag
  - [ ] Log progress: "Processing 42/265: SFS 1977:1160 Arbetsmiljölag..."
  - [ ] Handle errors gracefully — log failure and continue
- [ ] **Task 8: Update database records** (AC: 8)
  - [ ] After successful generation, update `LegalDocument.summary` and `kommentar`
  - [ ] Set `summering_generated_by` / `kommentar_generated_by` to model identifier (e.g., "gpt-4o")
  - [ ] Update within transaction to keep both fields in sync
- [ ] **Task 9: Implement cost tracking** (AC: 10)
  - [ ] Track input/output tokens per LLM call
  - [ ] Calculate cost based on model pricing
  - [ ] Output summary: total tokens, total cost, average cost per document, breakdown by Summering vs Kommentar
- [ ] **Task 10: Write tests** (AC: all)
  - [ ] Unit test: schema migration — new fields exist on LegalDocument
  - [ ] Unit test: Summering system prompt construction (includes few-shot examples, neutral voice instruction)
  - [ ] Unit test: Kommentar system prompt construction (includes few-shot examples, "Vi ska..." instruction)
  - [ ] Unit test: quality validation catches wrong voice (Summering with "Vi ska..." fails, Kommentar without it fails)
  - [ ] Unit test: context assembly includes document text + amendments
  - [ ] Unit test: resumable behavior (skips already-generated documents)
  - [ ] Unit test: cost tracking accumulates correctly
  - [ ] Integration test: end-to-end generation for a single document (mocked LLM)

## Dev Notes

### Content Strategy: Summering + Kommentar

Every `LegalDocument` gets two pieces of AI-generated content:

| Field | UI Label | Voice | Purpose | Example style source |
|-------|----------|-------|---------|---------------------|
| `summary` | Summering | Neutral, descriptive, third-person | What the law regulates | `notisumComment` in `notisum-full-data.json` |
| `kommentar` | Kommentar | "Vi ska...", obligation-focused, first-person plural | What the organization must do | `summaryText` in `notisum-full-data.json` |

**Both are grounded in actual legal source text** — the LLM receives `html_content` (SSOT, stripped to plain text) from the `LegalDocument` record plus related amendments. Fallback chain: `html_content` → `markdown_content` → `full_text`. The Notisum comments and existing laglig.se summaries serve as **few-shot style examples** in the prompts, NOT as source content.

### Relationship to TemplateItem Fields

`TemplateItem.compliance_summary` and `expert_commentary` (from Story 12.2) are **optional overrides** for template-specific nuance. Display logic in future UI stories (12.7+):

```typescript
// Pseudocode for template item display
const summering = templateItem.compliance_summary ?? document.summary
const kommentar = templateItem.expert_commentary ?? document.kommentar
```

### Existing Data Inventory

**Source data for few-shot examples** (`data/notisum-amnesfokus/notisum-full-data.json`):
- `notisumComment`: 353/356 documents have Notisum's original explanations (neutral, descriptive voice) → style reference for Summering prompt
- `summaryText`: 353/356 documents have laglig.se's compliance summaries ("Vi ska..." voice) → style reference for Kommentar prompt

**Existing `LegalDocument.summary` field:**
- Already used in ~14 source files (search results, browse pages, document modals, caching)
- Currently sparsely populated — this pipeline will fill it for template-referenced documents
- Field is NOT renamed — "summary" maps conceptually to "Summering"

### LLM Context Per Document

```
┌──────────────────────────────────────────────────┐
│ Context sent to LLM                              │
│                                                  │
│  1. LegalDocument.html_content (SSOT, stripped)   │
│  2. Related amendments (title, date, sections)   │
│  3. Document metadata (SFS/AFS number, type)     │
│  4. effective_date, publication_date              │
│  5. Few-shot style examples from training data   │
└─────────────┬──────────────┬─────────────────────┘
              │              │
      Summering prompt   Kommentar prompt
              │              │
              ▼              ▼
    "What does this      "What must the
     law regulate?"       organization do?"
              │              │
              ▼              ▼
       Neutral,          "Vi ska...",
       descriptive       action-oriented
```

### Scope and Prioritization

- `--scope template-docs`: ~265 documents referenced by TemplateItems across all templates. Run this first.
- `--scope all`: All LegalDocuments with source text. Can be run incrementally over time.
- Estimated cost for template-docs scope: ~$20-35 (two generations per document × 265 docs × ~1,500 tokens/generation)

### AI SDK Usage

**Tech stack:** Vercel AI SDK 5.0+ (`ai`, `@ai-sdk/openai`)

```typescript
import { generateText } from 'ai'
import { openai } from '@ai-sdk/openai'

// Option A: Two separate calls
const summering = await generateText({
  model: openai('gpt-4o'),
  system: summeringPrompt,
  prompt: documentContext,
})

const kommentar = await generateText({
  model: openai('gpt-4o'),
  system: kommentarPrompt,
  prompt: documentContext,
})

// Option B: Single call with structured output (benchmark both)
const result = await generateObject({
  model: openai('gpt-4o'),
  system: combinedPrompt,
  prompt: documentContext,
  schema: z.object({
    summering: z.string(),
    kommentar: z.string(),
  }),
})
```

### Agent Training Guide

**File:** `data/notisum-amnesfokus/analysis/11-agent-training-guide.md`

Key sections for prompt construction:
- Section 5: Voice patterns ("Vi ska...", "Vi behöver..."), sentence structure → Kommentar prompt
- Section 8: Quality checklist → validation rules
- Section 10: DO/DON'T examples → both prompts

### Script Location

Create: `scripts/generate-document-content.ts`

Follow existing script patterns from `scripts/ingest-laws.ts` — Prisma client usage, progress logging, error handling.

### Environment Variables

Uses `OPENAI_API_KEY` already configured in the project (see `lib/ai/openai.ts`).

### Relevant Source Tree

```
prisma/schema.prisma                              # Add kommentar + tracking fields to LegalDocument
scripts/generate-document-content.ts              # New script (main pipeline)
scripts/prompts/                                   # New directory for prompt templates
data/notisum-amnesfokus/notisum-full-data.json    # Few-shot example source
data/notisum-amnesfokus/analysis/                 # Training guide for prompt construction
lib/ai/                                            # Existing AI client setup
tests/unit/scripts/                                # Test location
```

### Technical Constraints

- **TypeScript:** 5.5+ strict mode
- **ORM:** Prisma 5.x with type-safe queries
- **Database:** PostgreSQL 15+ via Supabase
- **Package manager:** pnpm
- **Migration:** Use `pnpm prisma db push` (NOT `prisma migrate dev`) — shadow DB issue documented in Story 12.1
- **AI SDK:** Vercel AI SDK 5.0+

### Testing

- **Test framework:** Vitest 1.4+
- **Test location:** `tests/unit/scripts/`
- **Mocking:** Use MSW to mock OpenAI API calls in tests
- **Tests needed:**
  - Schema: new fields exist on LegalDocument
  - Summering prompt: includes neutral voice instruction + few-shot examples
  - Kommentar prompt: includes "Vi ska..." instruction + few-shot examples
  - Validation: catches wrong voice in wrong field
  - Context assembly: includes document text + amendments
  - Resumable: already-generated documents are skipped
  - Cost tracking: accumulates correctly
  - Error handling: failed document doesn't crash batch

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-06 | 2.0     | Rewrite: Summering + Kommentar dual-voice model, generation targets LegalDocument (not TemplateItem), grounded in actual legal source text, schema migration for new fields, TemplateItem fields become optional overrides | Collaborative refinement |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
