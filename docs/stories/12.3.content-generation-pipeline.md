# Story 12.3: Build Content Generation Pipeline (Summering + Kommentar)

## Status

Ready for Review (QA fixes applied — re-review requested)

## Story

**As a** content creator,
**I want** an AI pipeline that generates a neutral summary ("Summering") and actionable compliance commentary ("Kommentar") for legal documents, grounded in actual legal source text,
**so that** every document in the system has consistent, high-quality, dual-voice content that can be displayed on law pages, in templates, and throughout the platform.

## Acceptance Criteria

1. Schema migration: add `kommentar` (`String? @db.Text`), `summering_generated_by` (`String?`), and `kommentar_generated_by` (`String?`) fields to `LegalDocument` model
2. Existing `LegalDocument.summary` field is repurposed as "Summering" (no rename — already used in ~14 files). Comment updated in schema to clarify purpose.
3. Node script created: `scripts/generate-document-content.ts` that processes legal documents and generates both Summering and Kommentar
4. **Summering prompt** (neutral voice): generates a descriptive summary of what the law regulates — scope, purpose, key provisions. 3-5 sentences (soft cap — not strictly enforced), third-person, factual tone. Few-shot examples sourced from `notisumComment` field in `data/notisum-amnesfokus/notisum-full-data.json`
5. **Kommentar prompt** (laglig.se voice): generates actionable compliance commentary — what the organization must do. "Vi ska...", "Vi behöver..." phrasing, obligation-focused, 2-4 sentences and/or bullet points (use whichever format best fits the content). Few-shot examples sourced from `summaryText` field in `data/notisum-amnesfokus/notisum-full-data.json`
6. Per-document LLM context includes: `LegalDocument.html_content` (SSOT) with HTML stripped/converted for LLM input, falling back to `markdown_content` then `full_text` if unavailable. **No truncation** — the LLM must receive the full document text to produce accurate commentary. Plus related amendments from `Amendment` model, document metadata (SFS/AFS number, content_type, effective_date, status). Documents with no source text (all three fields null) are skipped with a warning log for potential future backfill.
7. Quality validation (non-blocking — log warnings only, never reject output): Summering is neutral/factual (no "Vi ska..."), Kommentar starts with obligation-focused phrasing, both are appropriate length. Hallucination check: after generation, use an LLM call to validate generated output against the source input text, flagging any claims not grounded in the source document
8. Documents updated with generated content + `summering_generated_by` / `kommentar_generated_by` = model identifier
9. Batch processing via **Anthropic Message Batches API** (50% cost reduction). Script submits all documents as a batch, polls for completion, then processes results. Resumable: skips documents where both `summary` and `kommentar` are non-null unless `--force` flag is passed
10. Cost tracking: tokens used and cost per document logged
11. Script supports `--scope` flag: `template-docs` (default — only documents referenced by TemplateItems, ~265 docs) or `all` (all LegalDocuments with source text). Defaults to `template-docs` to avoid accidental expensive runs
12. **Constraint:** Existing `TemplateItem.compliance_summary` and `expert_commentary` fields are unchanged by this story. These serve as optional template-specific overrides — future UI stories (12.7+) will implement display logic: show TemplateItem override if present, otherwise fall back to LegalDocument fields

## Tasks / Subtasks

- [x] **Task 1: Schema migration — add fields to LegalDocument** (AC: 1, 2)
  - [x] Add `kommentar String? @db.Text` to LegalDocument model (after `summary` field, ~line 286)
  - [x] Add `summering_generated_by String?` to LegalDocument model
  - [x] Add `kommentar_generated_by String?` to LegalDocument model
  - [x] Update `summary` field comment: `// Summering — neutral description of what the law regulates`
  - [x] Run `pnpm prisma db push` and `pnpm prisma generate`
  - [x] Verify `tsc --noEmit` passes
- [x] **Task 2: Build Summering system prompt** (AC: 4)
  - [x] Extract 5-8 representative `notisumComment` examples from `notisum-full-data.json` as few-shot style references (neutral, descriptive voice)
  - [x] Reference agent training guide Section 6 (Expert Commentary four-part structure: scope, applicability, key requirements, recent changes) for structural guidance
  - [x] Compose Summering system prompt: instruct LLM to describe what the law regulates — scope, purpose, key provisions — in neutral third-person voice, 3-5 sentences
  - [x] Include anti-patterns: no "Vi ska...", no first-person plural, no obligation language
  - [x] Create `lib/ai/prompts/` directory (does not yet exist) and store prompt template in `lib/ai/prompts/document-content.ts`
  - [x] Include explicit JSON output formatting instruction in the combined prompt: instruct the LLM to respond with a JSON object `{ "summering": "...", "kommentar": "..." }` and nothing else (no markdown fences, no preamble)
- [x] **Task 3: Build Kommentar system prompt** (AC: 5)
  - [x] Extract 5-8 representative `summaryText` examples from `notisum-full-data.json` as few-shot style references ("Vi ska..." voice)
  - [x] Extract voice patterns from agent training guide Section 5 (Compliance Summary Style Guide: "Vi ska...", "Vi behöver...", "Vi är skyldiga att...")
  - [x] Extract DO/DON'T patterns from agent training guide Section 10 for both prompts
  - [x] Compose Kommentar system prompt: instruct LLM to describe what the organization must do, "Vi ska..." voice, obligation-focused, 2-4 sentences and/or bullet points (whichever best fits the content)
  - [x] Include structural rules: start with core obligation, mention key thresholds, active voice present tense
  - [x] Store prompt template alongside Summering prompt
  - [x] Include explicit JSON output formatting instruction (same as Summering — combined prompt produces both fields)
- [x] **Task 4: Build per-document context assembly** (AC: 6)
  - [x] Fetch `LegalDocument` with `html_content` (SSOT), falling back to `markdown_content` then `full_text`
  - [x] Strip HTML tags from `html_content` to produce clean text for LLM input (simple regex or use a lightweight library)
  - [x] Fetch related amendments via `Amendment` model (`base_amendments` relation): `amending_law_title`, `effective_date`, `affected_sections_raw`, `summary`
  - [x] Build context object: `document_number`, `title`, `content_type`, `effective_date`, `status`, stripped source text, amendment history
  - [x] Handle documents without `html_content` gracefully (fall back to `markdown_content` → `full_text`; log warning and skip document entirely if all three fields are null — for future backfill)
  - [x] **No truncation** — send full document text to LLM. Opus 4.6's 200K context window accommodates all legal documents
  - [x] For AFS 2023 consolidated provisions, include "ersätter" mapping context from `metadata` field
- [x] **Task 5: Create script skeleton and Anthropic SDK client** (AC: 3)
  - [x] Create `scripts/generate-document-content.ts` (follow pattern from `scripts/ingest-laws.ts`)
  - [x] Use `@anthropic-ai/sdk` directly for Batch API access (Vercel AI SDK does not support batch endpoints)
  - [x] Model: Claude Opus 4.6 (`claude-opus-4-6`), `max_tokens: 2048` (configurable — sufficient for Summering + Kommentar JSON output)
  - [x] Parse CLI args: `--scope` (default: `template-docs`), `--force`, `--limit`, `--batch-id` (resume polling), `--dry-run` (build batch request and log what would be submitted without calling API)
  - [x] Build single batch request per document: combined prompt produces JSON `{ "summering": "...", "kommentar": "..." }` — parse response as JSON (handle parse failures gracefully, log and skip)
  - [x] Use `custom_id` field set to `LegalDocument.id` to map batch results back to documents
- [x] **Task 6: Implement quality validation** (AC: 7)
  - [x] Validate Summering: neutral tone (warn if contains "Vi ska...", "Vi behöver...", or first-person plural), 3-5 sentences (soft cap), factual
  - [x] Validate Kommentar: starts with obligation-focused phrasing ("Vi ska...", "Vi behöver...", "Vi är skyldiga..."), 2-4 sentences/bullets, active voice
  - [x] Validate both: appropriate length (not empty, not excessively long)
  - [x] Hallucination check: submit a **second batch** of validation requests after the main generation batch completes — each validation request sends generated output + source text to a cheaper model (Haiku 4.5, `claude-haiku-4-5-20251001`) asking "Does this output contain any claims not supported by the source text?" — log warnings for flagged documents
  - [x] All validation is **non-blocking** — log warnings per document, never reject output
- [x] **Task 7: Implement batch orchestration and scope queries** (AC: 9, 11)
  - [x] `--scope template-docs` (default): query documents referenced by TemplateItems (~265 documents) via `prisma.legalDocument.findMany({ where: { template_items: { some: {} } } })`
  - [x] `--scope all`: query all LegalDocuments with non-null `html_content` (or `markdown_content`/`full_text` fallback)
  - [x] Skip documents where both `summary` and `kommentar` are non-null unless `--force` flag
  - [x] Skip documents with no source text (all three content fields null) — log warning for future backfill
  - [x] **Phase 1 — Submit:** Assemble batch request array from Task 5's builder, submit via `anthropic.messages.batches.create()`, save batch ID to stdout for resumability. Note: Anthropic Batch API supports up to 100K requests per batch — 265 is well within limits, but `--scope all` runs should be aware of this ceiling.
  - [x] **Phase 2 — Poll & Process:** Poll batch status until complete, retrieve results, map back to documents via `custom_id`, run validation (Task 6), update database (Task 8)
  - [x] `--batch-id` flag: resume Phase 2 for a previously submitted batch (skip Phase 1)
  - [x] `--dry-run` flag: build full batch request array, log document count and estimated batch size, then exit without submitting
  - [x] Log progress: `"Submitting batch: 265 documents..."`, `"Batch status: in_progress (142/265 complete)..."`
  - [x] Handle per-document errors in batch results — log failure with document_number and continue to next
- [x] **Task 8: Update database records** (AC: 8)
  - [x] After successful generation + validation, update `LegalDocument.summary` and `LegalDocument.kommentar`
  - [x] Set `summering_generated_by` / `kommentar_generated_by` to model identifier (e.g., `"claude-opus-4-6"`)
  - [x] Update within Prisma `$transaction` to keep both fields in sync
- [x] **Task 9: Implement cost tracking** (AC: 10)
  - [x] Track input/output tokens per batch result (available from Anthropic API response `usage` object)
  - [x] Calculate cost based on Batch API pricing (50% of standard rate for Opus 4.6)
  - [x] Separately track validation batch costs (Haiku 4.5 Batch API rate — significantly cheaper than Opus generation batch)
  - [x] Output summary at end: total tokens, total cost, average cost per document, breakdown by generation batch vs. validation batch
- [x] **Task 10: Write tests** (AC: all)
  - [x] Unit test: schema migration — new fields exist on LegalDocument (`Prisma.LegalDocumentScalarFieldEnum.kommentar`, etc.)
  - [x] Unit test: Summering system prompt construction (includes few-shot examples, neutral voice instruction, anti-patterns)
  - [x] Unit test: Kommentar system prompt construction (includes few-shot examples, "Vi ska..." instruction, structural rules)
  - [x] Unit test: quality validation catches wrong voice (Summering with "Vi ska..." → warning, Kommentar without it → warning)
  - [x] Unit test: hallucination check LLM call is invoked with generated output + source text
  - [x] Unit test: context assembly includes document text + amendments
  - [x] Unit test: HTML stripping produces clean text from `html_content`
  - [x] Unit test: resumable behavior (skips documents with existing content)
  - [x] Unit test: cost tracking accumulates correctly
  - [x] Unit test: batch submission builds correct request array with custom_id mapping
  - [x] Unit test: `--batch-id` flag skips Phase 1 and resumes at Phase 2
  - [x] Unit test: `--dry-run` flag logs batch request details without submitting
  - [x] Unit test: JSON response parsing handles valid JSON, malformed JSON (logs error and skips document)
  - [x] Unit test: hallucination validation batch uses Haiku 4.5 model and includes generated output + source text
  - [x] Integration test: end-to-end batch flow for a single document (mocked Anthropic SDK via `vi.fn()`)

## Dev Notes

### Previous Story Insights (Story 12.2)

Story 12.2 is complete (commit `ea2054d`). Key learnings relevant to 12.3:

- **Migration approach**: Use `pnpm prisma db push` (NOT `prisma migrate dev`). Shadow database cannot replay historical migrations referencing dropped tables. [Source: Story 12.2 Dev Agent Record]
- **Named relations on User model**: User model already has many relations. New relations must use named `@relation()` to avoid ambiguity. Story 12.3 does NOT add User relations (generated_by fields are plain strings, not FKs). [Source: Story 12.2 Dev Notes]
- **Schema conventions**: `snake_case` fields, `@db.Text` for long text, `String?` for nullable, `@@map("table_name")`. [Source: prisma/schema.prisma]
- **Test patterns**: Tests at `tests/unit/prisma/` import from `@prisma/client` and verify `Prisma.ModelScalarFieldEnum` for field existence. [Source: tests/unit/prisma/template-models.test.ts]

### Architecture Decision: Dual-Voice Content on LegalDocument

This story implements a **refinement** of Epic 12 Decision 5. The original epic targets `TemplateItem.compliance_summary` and `TemplateItem.expert_commentary`. This story places the content on `LegalDocument` instead, making it universal across the platform. `TemplateItem` fields become optional overrides. [Source: docs/epics/epic-12-law-list-templates.md#Decision 5, collaborative refinement 2026-02-06]

**Why LegalDocument, not TemplateItem:**
- Every document gets content once, not per-template-appearance
- Content is available on law pages, search results, and browse views — not just templates
- ~188 unique documents across 265 template items — avoid generating duplicates
- TemplateItem overrides allow template-specific nuance when needed

### LegalDocument Model — Current Schema

[Source: prisma/schema.prisma lines 280-327]

Key fields for this story:

```prisma
model LegalDocument {
  // ...existing fields...
  summary          String?  @db.Text // Currently: "AI-generated summary". This story repurposes as "Summering"
  full_text        String?  @db.Text // Plain text for RAG, search, embeddings
  html_content     String?  @db.Text // SSOT - LLM-generated or API-sourced HTML for rendering
  markdown_content String?  @db.Text // Derived from HTML - for Chat/RAG context
  content_type     ContentType       // SFS_LAW, AGENCY_REGULATION, etc.
  document_number  String   @unique  // "SFS 1977:1160", "AFS 2023:1"
  effective_date   DateTime?
  status           DocumentStatus    // ACTIVE, etc.
  metadata         Json?             // Includes regulatoryBody, sourceType, replacesOldReference

  // NEW FIELDS (this story adds):
  // kommentar              String?  @db.Text  // Kommentar — actionable compliance commentary
  // summering_generated_by String?            // Model identifier (e.g., "claude-opus-4-6")
  // kommentar_generated_by String?            // Model identifier

  // Relations for context assembly:
  base_amendments     Amendment[]  @relation("BaseDocument")  // Amendments TO this document
}
```

**Source text priority**: `html_content` (SSOT) → `markdown_content` → `full_text`. Strip HTML before sending to LLM.

### Amendment Model — For Context Assembly

[Source: prisma/schema.prisma lines 599-629]

```prisma
model Amendment {
  base_document_id      String    // FK to LegalDocument being amended
  amending_law_title    String    // "Lag (2025:732) om ändring i..."
  effective_date        DateTime? // When amendment takes effect
  affected_sections_raw String?   // "ändr. 6 kap. 17 §; upph. 8 kap. 4 §"
  summary               String?   @db.Text // 2-3 sentence summary of what changed
}
```

**Context assembly query** — fetch amendments for each document:

```typescript
const doc = await prisma.legalDocument.findUnique({
  where: { id: documentId },
  include: {
    base_amendments: {
      select: {
        amending_law_title: true,
        effective_date: true,
        affected_sections_raw: true,
        summary: true,
      },
      orderBy: { effective_date: 'desc' },
      take: 10, // Most recent amendments
    },
  },
})
```

### Content Strategy: Summering + Kommentar

Every `LegalDocument` gets two pieces of AI-generated content:

| Field | UI Label | Voice | Purpose | Example style source | Agent Training Guide Section |
|-------|----------|-------|---------|---------------------|------------------------------|
| `summary` | Summering | Neutral, descriptive, third-person | What the law regulates | `notisumComment` in `notisum-full-data.json` | Section 6 (Expert Commentary structure) |
| `kommentar` | Kommentar | "Vi ska...", obligation-focused, first-person plural | What the organization must do | `summaryText` in `notisum-full-data.json` | Section 5 (Compliance Summary voice) |

**Both are grounded in actual legal source text** — the LLM receives `html_content` (SSOT, stripped to plain text) from the `LegalDocument` record plus related amendments. Fallback chain: `html_content` → `markdown_content` → `full_text`. The Notisum comments and existing laglig.se summaries serve as **few-shot style examples** in the prompts, NOT as source content.

### Agent Training Guide — Prompt Construction Reference

**File:** `data/notisum-amnesfokus/analysis/11-agent-training-guide.md` [Source: data/notisum-amnesfokus/analysis/11-agent-training-guide.md]

Key sections to extract for prompt construction:

| Section | Content | Used For |
|---------|---------|----------|
| Section 5 | Compliance Summary Style Guide — voice patterns ("Vi ska...", "Vi behöver..."), structural rules (start with core obligation, 2-4 sentences, active voice) | **Kommentar prompt** |
| Section 5.3 | 10 original compliance summary examples | **Kommentar few-shot examples** (supplement with `summaryText` from JSON) |
| Section 6 | Expert Commentary four-part structure: (1) what the law covers, (2) who it applies to, (3) key requirements, (4) recent changes | **Summering prompt** structural guidance |
| Section 6.2 | 4 original expert commentary examples | **Summering few-shot examples** (supplement with `notisumComment` from JSON) |
| Section 8 | Quality Checklist — content completeness rules, voice validation | **Validation rules** |
| Section 10 | DO/DON'T patterns — active voice, Swedish, no copied text, thresholds | **Both prompts** anti-pattern instructions |

### Relationship to TemplateItem Fields

`TemplateItem.compliance_summary` and `expert_commentary` (from Story 12.2) are **optional overrides** for template-specific nuance. Display logic in future UI stories (12.7+): [Source: docs/epics/epic-12-law-list-templates.md#Story 12.2]

```typescript
// Pseudocode for template item display
const summering = templateItem.compliance_summary ?? document.summary
const kommentar = templateItem.expert_commentary ?? document.kommentar
```

### Existing Data Inventory

**Source data for few-shot examples** (`data/notisum-amnesfokus/notisum-full-data.json`):
- `notisumComment`: 353/356 documents have Notisum's original explanations (neutral, descriptive voice) → style reference for Summering prompt
- `summaryText`: 353/356 documents have laglig.se's compliance summaries ("Vi ska..." voice) → style reference for Kommentar prompt

**JSON structure per document** (for extracting few-shot examples):
```json
{
  "sfsNumber": "SFS 1977:1160",
  "documentName": "Arbetsmiljölag (1977:1160)",
  "notisumComment": "Arbetsmiljölagen reglerar...",  // Neutral voice → Summering examples
  "summaryText": "Vi ska bedriva ett systematiskt...", // Vi ska voice → Kommentar examples
  "sectionName": "Grundläggande regelverk",
  "listId": "arbetsmiljo"
}
```

**Existing `LegalDocument.summary` field:**
- Already used in ~14 source files (search results, browse pages, document modals, caching)
- Currently sparsely populated — this pipeline will fill it for template-referenced documents
- Field is NOT renamed — "summary" maps conceptually to "Summering"

### HTML-to-Text Conversion

`html_content` is the SSOT field but contains full HTML markup. For LLM input, strip to plain text:

```typescript
// Simple approach — strip HTML tags, normalize whitespace
function stripHtml(html: string): string {
  return html
    .replace(/<[^>]*>/g, ' ')     // Remove HTML tags
    .replace(/&nbsp;/g, ' ')       // Replace HTML entities
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/\s+/g, ' ')          // Normalize whitespace
    .trim()
}
```

**No truncation** — the full document text must be sent to the LLM. Accurate commentary requires full context. Opus 4.6 has a 200K context window which accommodates even the longest legal documents.

### LLM Context Per Document

```
┌──────────────────────────────────────────────────┐
│ Context sent to LLM                              │
│                                                  │
│  1. LegalDocument.html_content (SSOT, stripped)   │
│  2. Related amendments (title, date, sections)   │
│  3. Document metadata (SFS/AFS number, type)     │
│  4. effective_date, publication_date              │
│  5. Few-shot style examples from training data   │
└─────────────┬──────────────┬─────────────────────┘
              │              │
      Summering prompt   Kommentar prompt
              │              │
              ▼              ▼
    "What does this      "What must the
     law regulate?"       organization do?"
              │              │
              ▼              ▼
       Neutral,          "Vi ska...",
       descriptive       action-oriented
```

### Scope and Prioritization

- `--scope template-docs` (default): ~265 documents referenced by TemplateItems across all templates. Run this first.
- `--scope all`: All LegalDocuments with source text. Can be run incrementally over time.
- **Batch API pricing**: 50% of standard Opus 4.6 rates. Estimated cost for template-docs scope will depend on document lengths (no truncation — full document text sent).
- **Hallucination validation batch**: Runs as a second batch using Haiku 4.5 (much cheaper). Adds minimal cost on top of the generation batch.
- **Batch size limits**: Anthropic Batch API supports up to 100K requests per batch. The `template-docs` scope (~265 docs) is well within limits. For `--scope all` runs with thousands of documents, the script should be aware of this ceiling but no partitioning is needed for Phase 1.

### Anthropic Batch API Usage

**Model:** Claude Opus 4.6 (`claude-opus-4-6`) via **Anthropic Message Batches API** (50% cost reduction). [Source: docs/architecture/3-tech-stack.md#3.1]

The project already uses `@anthropic-ai/sdk` directly for amendment parsing (see `lib/external/llm-amendment-parser.ts`). This story uses the same SDK for Batch API access — Vercel AI SDK does not support batch endpoints.

**Batch API workflow:**

```typescript
import Anthropic from '@anthropic-ai/sdk'

const anthropic = new Anthropic() // Uses ANTHROPIC_API_KEY

// Phase 1: Submit batch
const batch = await anthropic.messages.batches.create({
  requests: documents.map((doc) => ({
    custom_id: doc.id, // Map results back to documents
    params: {
      model: 'claude-opus-4-6',
      max_tokens: 2048, // Configurable — sufficient for JSON { summering, kommentar }
      system: combinedPrompt, // Instructs LLM to output JSON { "summering": "...", "kommentar": "..." }
      messages: [{ role: 'user', content: buildDocumentContext(doc, amendments) }],
    },
  })),
})

console.log(`Batch submitted: ${batch.id}`)

// Phase 2: Poll for completion
let status = await anthropic.messages.batches.retrieve(batch.id)
while (status.processing_status === 'in_progress') {
  await new Promise((r) => setTimeout(r, 30_000)) // Poll every 30s
  status = await anthropic.messages.batches.retrieve(batch.id)
  console.log(`Batch ${batch.id}: ${status.request_counts.succeeded}/${status.request_counts.total} complete`)
}

// Phase 3: Retrieve results
const results = await anthropic.messages.batches.results(batch.id)
for await (const result of results) {
  if (result.result.type === 'succeeded') {
    const content = result.result.message.content[0].text
    const parsed = JSON.parse(content) // { summering: "...", kommentar: "..." }
    // Validate and update database...
  }
}
```

**Token tracking** from batch results:
```typescript
// Each result includes usage
const { input_tokens, output_tokens } = result.result.message.usage
```

**Resumability:** If the script is interrupted after batch submission, re-run with `--batch-id <id>` to skip Phase 1 and go directly to Phase 2 (poll + process).

**Structured JSON output:** The Anthropic Messages API does not have a native `generateObject` equivalent. Instead, the combined system prompt must explicitly instruct the LLM to respond with only a JSON object `{ "summering": "...", "kommentar": "..." }` — no markdown fences, no preamble. The script must parse the response text as JSON and handle parse failures gracefully (log error, skip document). An alternative approach is to use Anthropic's `tool_use` feature to enforce structured output via a tool schema — benchmark both approaches for reliability.

**Hallucination validation batch:** After the main generation batch completes and results are parsed, submit a second batch using Haiku 4.5 (`claude-haiku-4-5-20251001`) for hallucination checking. Each validation request sends the generated Summering + Kommentar alongside the source document text, asking the model to identify any claims not supported by the source. This runs at Haiku Batch API rates (very cheap). Results are parsed for warnings only — never block the pipeline.

### Existing Script Patterns

**Follow patterns from** `scripts/ingest-laws.ts`: [Source: scripts/ingest-laws.ts]

- Shebang: `#!/usr/bin/env npx tsx`
- Import PrismaClient from `@prisma/client`
- `parseArgs()` function for CLI flags
- Sequential processing with progress logging
- Upsert pattern for idempotent updates
- Error handling per-item with continue on failure
- Summary output at end

```typescript
#!/usr/bin/env npx tsx
/* eslint-disable no-console */

import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

interface Config {
  scope: 'template-docs' | 'all'
  force: boolean
  limit: number
  batchId: string | null  // Resume polling for existing batch
  dryRun: boolean         // Log what would be submitted without calling API
}

function parseArgs(): Config { /* ... */ }

async function main() {
  const config = parseArgs()
  // ... processing logic
  await prisma.$disconnect()
}

main().catch((e) => {
  console.error(e)
  prisma.$disconnect()
  process.exit(1)
})
```

### Prompt File Location

Create `lib/ai/prompts/` directory (does not yet exist) and add `document-content.ts`. This aligns with the project structure convention. [Source: docs/architecture/12-unified-project-structure.md#lib/ai/prompts/]

Export:
- `buildSummeringPrompt(fewShotExamples: string[]): string`
- `buildKommentarPrompt(fewShotExamples: string[]): string`
- `buildDocumentContext(doc: LegalDocument, amendments: Amendment[]): string`

### Environment Variables

Uses `ANTHROPIC_API_KEY` already configured in the project (used by `lib/external/llm-amendment-parser.ts`). [Source: docs/architecture/3-tech-stack.md#3.4]

Default model: `claude-opus-4-6`. Optional: `CONTENT_GENERATION_MODEL` env var to override.

### Relevant Source Tree

```
prisma/schema.prisma                              # Add kommentar + tracking fields to LegalDocument
scripts/generate-document-content.ts              # New script (main pipeline)
lib/ai/prompts/document-content.ts                # New: prompt templates for Summering + Kommentar
data/notisum-amnesfokus/notisum-full-data.json    # Few-shot example source
data/notisum-amnesfokus/analysis/11-agent-training-guide.md  # Voice patterns + quality rules
lib/external/llm-amendment-parser.ts                 # Existing Anthropic SDK usage reference
scripts/ingest-laws.ts                             # Pattern reference for script structure
tests/unit/scripts/                                # Test location
```

### Technical Constraints

- **TypeScript:** 5.5+ strict mode [Source: docs/architecture/17-coding-standards.md#17.2]
- **ORM:** Prisma 5.x with type-safe queries [Source: docs/architecture/3-tech-stack.md#3.1]
- **Database:** PostgreSQL 15+ via Supabase [Source: docs/architecture/9-database-schema.md#9.1]
- **Package manager:** pnpm [Source: docs/architecture/3-tech-stack.md#3.1]
- **Migration:** Use `pnpm prisma db push` (NOT `prisma migrate dev`) — shadow DB issue documented in Story 12.1
- **AI SDK:** Anthropic SDK (`@anthropic-ai/sdk`) with Message Batches API for batch processing [Source: docs/architecture/3-tech-stack.md#3.1]
- **Validation:** Zod 3.22+ for structured output schemas [Source: docs/architecture/3-tech-stack.md#3.1]

### Testing

- **Test framework:** Vitest 1.4+ [Source: docs/architecture/3-tech-stack.md#3.1]
- **Test config:** `vitest.config.mts` — environment: `happy-dom`, setup: `tests/setup.ts` [Source: vitest.config.mts]
- **Test location:** `tests/unit/scripts/generate-document-content.test.ts`
- **Mocking strategy:** Use `vi.fn()` and `vi.mock()` to mock AI SDK calls. Do NOT make real LLM calls in tests. [Source: docs/architecture/section-15-summary.md#16.6]
- **Schema tests:** Follow pattern from `tests/unit/prisma/template-models.test.ts` — verify `Prisma.LegalDocumentScalarFieldEnum` includes new fields

**Mocking example for Anthropic SDK:**
```typescript
vi.mock('@anthropic-ai/sdk', () => ({
  default: vi.fn().mockImplementation(() => ({
    messages: {
      batches: {
        create: vi.fn().mockResolvedValue({
          id: 'batch_test_123',
          processing_status: 'ended',
          request_counts: { total: 1, succeeded: 1, errored: 0 },
        }),
        retrieve: vi.fn().mockResolvedValue({
          processing_status: 'ended',
          request_counts: { total: 1, succeeded: 1, errored: 0 },
        }),
        results: vi.fn().mockReturnValue([{
          custom_id: 'doc-123',
          result: {
            type: 'succeeded',
            message: {
              content: [{ text: '{"summering": "Mocked summering", "kommentar": "Mocked kommentar"}' }],
              usage: { input_tokens: 500, output_tokens: 200 },
            },
          },
        }]),
      },
    },
  })),
}))
```

**Tests needed:**
- Schema: new fields (`kommentar`, `summering_generated_by`, `kommentar_generated_by`) exist on LegalDocument
- Summering prompt: includes neutral voice instruction + few-shot examples from `notisumComment` + JSON output instruction
- Kommentar prompt: includes "Vi ska..." instruction + few-shot examples from `summaryText` + JSON output instruction
- Validation: catches wrong voice in wrong field (Summering with "Vi ska..." → warning, Kommentar without obligation phrasing → warning)
- Hallucination check: validation batch uses Haiku 4.5 model, includes generated output + source text, warnings logged
- Context assembly: includes document text + amendments, respects html_content → markdown_content → full_text fallback, no truncation
- Context assembly: documents with all three content fields null are skipped with warning
- HTML stripping: produces clean text from HTML input
- JSON response parsing: valid JSON parsed correctly; malformed JSON logged and document skipped
- Batch submission: builds correct Anthropic Batch API request with custom_id mapping to document IDs
- Batch resumability: `--batch-id` flag resumes polling for existing batch
- Dry run: `--dry-run` flag logs batch details without submitting
- Resumable: already-generated documents (both fields non-null) are skipped (unless `--force`)
- Cost tracking: accumulates tokens and cost correctly across both generation batch (Opus 4.6 Batch rate) and validation batch (Haiku 4.5 Batch rate)
- Error handling: failed document in batch results doesn't crash processing, error is logged and next result processed

## Change Log

| Date       | Version | Description            | Author     |
|------------|---------|------------------------|------------|
| 2026-02-06 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-06 | 2.0     | Rewrite: Summering + Kommentar dual-voice model, generation targets LegalDocument (not TemplateItem), grounded in actual legal source text, schema migration for new fields, TemplateItem fields become optional overrides | Collaborative refinement |
| 2026-02-06 | 3.0     | SM enrichment: full architecture context, source references, Previous Story Insights, LegalDocument/Amendment model definitions, agent training guide section mapping, script patterns, testing strategy, HTML-to-text conversion notes, AI SDK mock patterns | Bob (SM) |
| 2026-02-07 | 4.0     | AC refinement: Anthropic Batch API + Opus 4.6 (replaces OpenAI/Vercel AI SDK), no truncation (full document context), soft cap on sentence counts, LLM-based hallucination validation (non-blocking), default scope to template-docs, AC 12 reworded as constraint, batch resumability via --batch-id, updated tasks/tests/dev notes | Bob (SM) + PO review |
| 2026-02-07 | 5.0     | PO validation fixes: fixed stale gpt-4o reference, resolved Task 5/7 overlap (Task 5 = script skeleton + SDK client, Task 7 = batch orchestration + scope), added lib/ai/prompts/ directory creation note, aligned Task 3 wording with AC 5 (sentences/bullets), hallucination check uses Haiku 4.5 as second batch, JSON output strategy documented (prompt instruction + parse handling), --dry-run flag added, batch size limits noted, Config interface updated, all test cases updated | Sarah (PO) validation |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (`claude-opus-4-6`)

### File List

| File | Action | Description |
|------|--------|-------------|
| `prisma/schema.prisma` | Modified | Added `kommentar`, `summering_generated_by`, `kommentar_generated_by` fields to LegalDocument; updated `summary` field comment |
| `lib/ai/prompts/document-content.ts` | Created | Prompt templates for Summering + Kommentar, context assembly, HTML stripping, hallucination check prompts |
| `scripts/generate-document-content.ts` | Created | Main pipeline script: Anthropic Batch API orchestration, quality validation, cost tracking, CLI args, database updates |
| `tests/unit/scripts/generate-document-content.test.ts` | Created | 55 unit tests covering schema, prompts, validation, context assembly, HTML stripping, CLI args, JSON parsing, batch building, cost tracking, hallucination checks, stripMarkdownCodeBlock helper |

### Debug Log References
No blocking issues encountered during implementation.
QA fix validation: `tsc --noEmit` clean, 55/55 tests pass.

### Completion Notes
- All 10 tasks completed with subtasks checked off
- 55 tests pass (schema: 4, prompt: 7, validation: 9, context: 8, CLI: 8, JSON: 6, batch: 2, cost: 4, hallucination: 3, stripMarkdownCodeBlock: 4)
- TypeScript compiles clean (`tsc --noEmit` passes)
- Pre-existing integration test failures (16) are unrelated to this story — FK constraint issues in ingestion/sync tests
- Migration applied via `pnpm prisma db push` per Story 12.2 insight (NOT `prisma migrate dev`)
- Script guarded with `fileURLToPath(import.meta.url)` for robust direct-execution detection
- QA fixes applied: LOGIC-001 (resume re-fetches documents for hallucination validation), MAINT-002 (shared `stripMarkdownCodeBlock` helper), MAINT-001 (robust `import.meta.url` guard)

### Change Log

| Date | Change | Files |
|------|--------|-------|
| 2026-02-07 | Schema migration: 3 new fields on LegalDocument | `prisma/schema.prisma` |
| 2026-02-07 | Prompt templates with few-shot examples from notisum-full-data.json | `lib/ai/prompts/document-content.ts` |
| 2026-02-07 | Content generation pipeline script with Batch API | `scripts/generate-document-content.ts` |
| 2026-02-07 | 51 unit tests | `tests/unit/scripts/generate-document-content.test.ts` |
| 2026-02-07 | QA fix: LOGIC-001 resume re-fetches docs for hallucination validation; MAINT-002 extracted stripMarkdownCodeBlock helper; MAINT-001 robust import.meta.url guard; +4 tests | `scripts/generate-document-content.ts`, `tests/unit/scripts/generate-document-content.test.ts` |

## QA Results

### Review Date: 2026-02-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is solid and well-structured. The codebase follows established project patterns (matches `ingest-laws.ts` script structure, `llm-amendment-parser.ts` SDK usage). Clean separation of concerns: prompts in `lib/ai/prompts/`, pipeline logic in `scripts/`, tests co-located in `tests/unit/scripts/`. All 51 tests pass, TypeScript compiles clean. All 12 acceptance criteria are traceable to implementation and tests.

Key strengths:
- Excellent prompt engineering: dual-voice system with clear Swedish instructions, anti-patterns, and 6 few-shot examples per voice
- Robust batch pipeline: Phase 1/2 separation, resumability via `--batch-id`, `--dry-run` safety net, `--scope template-docs` default
- Comprehensive error handling: per-document graceful failures, JSON parse fallbacks, transaction-wrapped DB updates
- Cost-conscious: Batch API (50% savings), Haiku 4.5 for validation (much cheaper), cost tracking with detailed summary

### Refactoring Performed

No refactoring performed — code quality is sufficient for story scope.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, explicit types, error handling per-item, transactions for related ops
- Project Structure: ✓ `lib/ai/prompts/` matches documented structure, `scripts/` for maintenance, `tests/unit/scripts/` for tests
- Testing Strategy: ✓ Vitest with `vi.fn()`, no real LLM calls, good edge case coverage
- All ACs Met: ✓ All 12 acceptance criteria verified against implementation and tests

### Improvements Checklist

- [x] Schema migration adds 3 new fields + updated comment (AC 1, 2)
- [x] Summering prompt includes neutral voice, few-shot examples, anti-patterns (AC 4)
- [x] Kommentar prompt includes "Vi ska..." voice, few-shot examples, structural rules (AC 5)
- [x] Context assembly with html_content fallback chain, no truncation, "ersätter" mapping (AC 6)
- [x] Quality validation: tone checking, length checking, hallucination batch with Haiku 4.5 (AC 7)
- [x] Batch API orchestration with resume, dry-run, scope flags (AC 9, 11)
- [x] Cost tracking with separate generation/validation accounting (AC 10)
- [x] 51 unit tests covering all major code paths (AC all)
- [ ] **MEDIUM**: `--batch-id` resume path silently skips hallucination validation because `documentMap` is empty — consider re-fetching documents on resume or logging that hallucination validation is skipped
- [ ] **LOW**: `isDirectExecution` guard (line 775-779) relies on `process.argv[1]` string matching — consider using `import.meta.url` comparison or `require.main === module` for more robust detection
- [ ] **LOW**: Hallucination validation JSON parsing (lines 596-601) duplicates the markdown-stripping logic from `parseGeneratedContent` — consider extracting to a shared helper

### Security Review

No security concerns. Script runs locally using existing `ANTHROPIC_API_KEY`. No user input exposure (CLI flags are internal). Database access via Prisma prevents SQL injection. No auth/authorization surface.

### Performance Considerations

No performance concerns. Design is cost-optimized: Batch API (50% savings), default `--scope template-docs` prevents expensive runs, `--limit` and `--dry-run` provide safety. Haiku 4.5 for validation minimizes secondary batch cost.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: CONCERNS → docs/qa/gates/12.3-content-generation-pipeline.yml
Risk profile: Not generated (no critical risks identified)
NFR assessment: Inline (all PASS)

### Recommended Status

✗ Changes Required — See unchecked items above (1 medium item: resume hallucination validation gap)
(Story owner decides final status)

---

### Review Date: 2026-02-07 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Re-review after dev applied fixes for all 3 issues from the initial review. All fixes are correctly implemented, targeted, and minimal. Test count increased from 51 to 55 (4 new tests for the extracted `stripMarkdownCodeBlock` helper). TypeScript compiles clean. All 55 tests pass.

Fix verification:

1. **LOGIC-001 (medium) — RESOLVED**: Resume path now re-fetches documents when `--batch-id` is used and `documentMap` is empty (lines 724-732). Hallucination validation will correctly find documents in the map during resume mode. The condition `config.batchId && documentMap.size === 0` is precise — it only triggers on resume, not on fresh runs.

2. **MAINT-002 (low) — RESOLVED**: `stripMarkdownCodeBlock()` helper extracted (lines 387-395) and used in both `parseGeneratedContent` (line 406) and hallucination validation JSON parsing (line 605). Eliminates duplicated markdown-stripping logic. Helper is exported and covered by 4 dedicated tests.

3. **MAINT-001 (low) — RESOLVED**: Direct-execution guard now uses `fileURLToPath(import.meta.url) === resolve(process.argv[1])` (lines 789-792) with proper imports from `node:url` and `node:path` (lines 18-19). This is robust for ESM modules and does not rely on filename string matching.

### Refactoring Performed

No additional refactoring performed — dev fixes were sufficient.

### Compliance Check

- Coding Standards: ✓ All fixes follow TypeScript strict mode, explicit types, clean imports
- Project Structure: ✓ No structural changes — fixes are localized
- Testing Strategy: ✓ 4 new tests added for extracted helper, total 55 passing
- All ACs Met: ✓ All 12 acceptance criteria remain fully covered

### Improvements Checklist

- [x] Schema migration adds 3 new fields + updated comment (AC 1, 2)
- [x] Summering prompt includes neutral voice, few-shot examples, anti-patterns (AC 4)
- [x] Kommentar prompt includes "Vi ska..." voice, few-shot examples, structural rules (AC 5)
- [x] Context assembly with html_content fallback chain, no truncation, "ersätter" mapping (AC 6)
- [x] Quality validation: tone checking, length checking, hallucination batch with Haiku 4.5 (AC 7)
- [x] Batch API orchestration with resume, dry-run, scope flags (AC 9, 11)
- [x] Cost tracking with separate generation/validation accounting (AC 10)
- [x] 55 unit tests covering all major code paths (AC all)
- [x] **RESOLVED**: `--batch-id` resume path now re-fetches documents for hallucination validation (LOGIC-001)
- [x] **RESOLVED**: Extracted `stripMarkdownCodeBlock` shared helper (MAINT-002)
- [x] **RESOLVED**: Robust `import.meta.url` direct-execution guard (MAINT-001)

### Security Review

No new security concerns. Fixes are localized logic changes with no auth/authorization surface.

### Performance Considerations

No performance impact. Resume re-fetch adds one DB query only in `--batch-id` resume mode.

### Files Modified During Review

No files modified during re-review.

### Gate Status

Gate: PASS → docs/qa/gates/12.3-content-generation-pipeline.yml
Risk profile: Not generated (no critical risks identified)
NFR assessment: Inline (all PASS)

### Recommended Status

✓ Ready for Done — All 3 issues from initial review resolved. 55/55 tests pass, tsc clean, all 12 ACs met.
(Story owner decides final status)
