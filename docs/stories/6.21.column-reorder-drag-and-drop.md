# Story 6.21: Drag-to-Reorder Table Columns

## Status

Approved

## Story

**As a** workspace user,
**I want** to rearrange table columns by dragging headers left/right,
**so that** I can customise each view to match my workflow and see the most important data first.

## Acceptance Criteria

1. Users can drag-and-drop column headers to reorder columns in the Tasks Lista view
2. Users can drag-and-drop column headers to reorder columns in the Tasks Alla uppgifter view
3. Users can drag-and-drop column headers to reorder columns in Laglistor document table views (standard + compliance detail)
4. Column order persists across page navigations and browser refresh (localStorage)
5. Pinned columns (select checkbox, drag handle, actions) are not draggable and remain in fixed positions
6. Column reordering works alongside existing column resizing and column visibility without regressions
7. Existing sorting, filtering, and row drag-and-drop continue to work correctly
8. Drag feedback is visually clear (grab cursor on hover, drag overlay with reduced opacity and subtle shadow during drag)

## Tasks / Subtasks

- [ ] Task 1: Extend Zustand layout store with column order state (AC: 4)
  - [ ] 1.1 Add `columnOrders: Record<string, string[]>` to `layout-store.ts` keyed by view name (e.g. `'task-list'`, `'task-all'`, `'doc-list'`, `'compliance-detail'`)
  - [ ] 1.2 Add `setColumnOrder(viewKey, order)` action. Column order is read via selector: `useLayoutStore((s) => s.columnOrders[viewKey] ?? [])`
  - [ ] 1.3 Ensure state persists via existing Zustand `persist` middleware (localStorage)

- [ ] Task 2: Create shared `DraggableColumnHeader` component (AC: 1, 2, 3, 5, 8)
  - [ ] 2.1 Create `components/ui/draggable-column-header.tsx`
  - [ ] 2.2 Use `@dnd-kit/sortable` `useSortable` hook (same library already used for row DnD)
  - [ ] 2.3 Wrap `<TableHead>` children with sortable context
  - [ ] 2.4 Apply `restrictToHorizontalAxis` modifier from `@dnd-kit/modifiers`
  - [ ] 2.5 Add grab cursor on hover (`cursor-grab`), active drag cursor (`cursor-grabbing`)
  - [ ] 2.6 During drag: render overlay with `opacity-50` and `shadow-lg` on the dragged column header, and a subtle placeholder (`bg-muted/30 border-dashed`) in the original position — consistent with existing row DnD styling in the codebase
  - [ ] 2.7 Accept `isPinned` prop to disable drag on pinned columns (select, dragHandle, actions)

- [ ] Task 3: Wire column ordering into Tasks Lista table (AC: 1, 6, 7)
  - [ ] 3.1 In `list-tab.tsx`, read column order from layout store: `useLayoutStore((s) => s.columnOrders['task-list'] ?? [])`
  - [ ] 3.2 Pass `columnOrder` state to `useReactTable()` config
  - [ ] 3.3 Pass `onColumnOrderChange` callback that calls `setColumnOrder('task-list', newOrder)`
  - [ ] 3.4 Wrap table header row with `DndContext` + `SortableContext` using `horizontalListSortingStrategy`
  - [ ] 3.5 Replace `<TableHead>` with `DraggableColumnHeader` for each non-pinned column
  - [ ] 3.6 Verify column resizing, sorting, visibility, and row DnD still work

- [ ] Task 4: Wire column ordering into Tasks Alla uppgifter table (AC: 2, 6, 7)
  - [ ] 4.1 Same pattern as Task 3, applied to `all-work-tab.tsx` with view key `'task-all'`
  - [ ] 4.2 Verify sorting and filtering still work

- [ ] Task 5: Wire column ordering into document list table (AC: 3, 6, 7)
  - [ ] 5.1 In `document-list-table.tsx`, accept `columnOrder` + `onColumnOrderChange` props (same pattern as existing `columnSizing` props)
  - [ ] 5.2 Pass through from `document-list-page-content.tsx` or parent, reading from layout store with view key `'doc-list'`
  - [ ] 5.3 Wrap table header with `DndContext` + `SortableContext`
  - [ ] 5.4 Replace `<TableHead>` with `DraggableColumnHeader`
  - [ ] 5.5 Verify row DnD (between groups), sorting, filtering, resizing, and visibility still work

- [ ] Task 6: Wire column ordering into compliance detail table (AC: 3, 6, 7)
  - [ ] 6.1 Same pattern as Task 5, applied to `compliance-detail-table.tsx` with view key `'compliance-detail'`

- [ ] Task 7: Unit and integration tests (AC: all)
  - [ ] 7.1 Test `DraggableColumnHeader` renders correctly in pinned vs unpinned states
  - [ ] 7.2 Test layout store `setColumnOrder` action and selector reads
  - [ ] 7.3 Test that default column order (empty array) falls back gracefully to original column definition order
  - [ ] 7.4 Integration test: render a table with a custom `columnOrder`, verify DOM column headers appear in the specified sequence

## Dev Notes

### Relevant Source Tree

```
lib/stores/layout-store.ts                    — Zustand store to extend with columnOrders
components/ui/                                — Location for new DraggableColumnHeader
components/features/tasks/task-workspace/
  list-tab.tsx                                — Tasks Lista table (TanStack + @dnd-kit row DnD)
  all-work-tab.tsx                            — Tasks Alla uppgifter table (TanStack)
components/features/document-list/
  document-list-table.tsx                     — Law list table (TanStack + @dnd-kit row DnD)
  compliance-detail-table.tsx                 — Compliance detail view table
  document-list-page-content.tsx              — Parent that passes columnSizing/visibility props
components/features/settings/
  column-manager.tsx                          — EXISTING column reorder DnD (task columns) — reference pattern
  sortable-column-item.tsx                    — EXISTING sortable item — reference pattern
```

[Source: architecture/3-tech-stack.md#31 — @dnd-kit/core + @dnd-kit/sortable 6.1+, TanStack React Table]
[Source: architecture/3-tech-stack.md#32 — Zustand 4.5+ with persistence middleware]
[Source: architecture/12-unified-project-structure.md#122 — components/ui/ for shared UI, components/features/ for feature-specific]
[Source: architecture/17-coding-standards.md#173 — shadcn/ui components, Tailwind styling, 'use client' only when needed]

### TanStack Table Column Ordering API

TanStack Table v8 has native `columnOrder` support:
- Pass `state: { columnOrder: string[] }` to `useReactTable()`
- Pass `onColumnOrderChange` callback
- Column IDs in the array determine render order
- Columns not in the array render after ordered columns
- Empty array = default order from column definitions

### Existing @dnd-kit Patterns in Codebase

The project already uses @dnd-kit extensively:
- **Row reordering**: `document-list-table.tsx` uses `DndContext` + `SortableContext` with `verticalListSortingStrategy` and `restrictToVerticalAxis`
- **Column management**: `column-manager.tsx` uses `DndContext` + `SortableContext` with `arrayMove` from `@dnd-kit/sortable`
- **Kanban**: `kanban-tab.tsx` uses full multi-container DnD

For column header DnD, use the same pattern but with `horizontalListSortingStrategy` and `restrictToHorizontalAxis`.

### Zustand Layout Store

`lib/stores/layout-store.ts` already uses `persist` middleware for localStorage. Extend with:
```typescript
// State
columnOrders: Record<string, string[]>  // keyed by view name, default {}

// Action
setColumnOrder: (viewKey: string, order: string[]) => void

// Reading (selector pattern — NOT a store action):
// useLayoutStore((s) => s.columnOrders[viewKey] ?? [])
```

This matches the existing pattern in the store where `accordionStates` is a `Record<string, boolean>` read via selector and written via action.

### Pinned Columns

The following columns should NOT be draggable (they stay fixed at their positions):
- `select` (checkbox column) — always first
- `dragHandle` (grip icon for row reorder) — always second
- `actions` (row action menu) — always last

### Drag Overlay Styling

During drag, use a `DragOverlay` from `@dnd-kit/core` to render a floating copy of the column header:
- Dragged header: `opacity-50 shadow-lg` with the column's current width preserved
- Original position: `bg-muted/30 border-dashed` placeholder
- This matches the existing visual language used for row reordering in `document-list-table.tsx`

### DnD Nesting Consideration

`document-list-table.tsx` and `list-tab.tsx` already have a `DndContext` for row reordering. Column header DnD needs its own separate `DndContext` to avoid conflicts. Use different `id` props on each `DndContext` and separate `SortableContext` wrappers for row body vs header row.

### Keyboard Accessibility

`@dnd-kit` supports keyboard-based sorting out of the box via `KeyboardSensor`. Consider enabling `useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })` alongside `PointerSensor` in the header `DndContext` so users can reorder columns via keyboard (Tab to focus, Space to pick up, Arrow keys to move). This is a low-effort addition since the sensor setup is the same pattern used in existing row DnD.

### Testing

**Test file locations**:
- `tests/unit/components/ui/draggable-column-header.test.tsx`
- `tests/unit/lib/stores/layout-store.test.ts`

**Framework**: Vitest + React Testing Library
[Source: architecture/section-15-summary.md#162 — Vitest with React Testing Library, test behavior not implementation]

**Test patterns**:
- Unit test the Zustand store actions (setColumnOrder, selector reads, persistence)
- Unit test DraggableColumnHeader rendering (pinned state disables drag, unpinned shows grab cursor)
- Fallback behavior when columnOrder is empty (should render original column definition order)
- Integration test: render a table component with a non-default columnOrder array and assert that DOM `<th>` elements appear in the expected sequence

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-02-12 | 0.1 | Initial draft from rough requirements | SM Agent (Bob) |
| 2025-02-12 | 0.2 | PO validation fixes: drag overlay styling, Zustand selector pattern, keyboard a11y, integration test, template stubs | PO Agent (Sarah) |

## Dev Agent Record

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

_To be filled during implementation_

## QA Results

_To be filled after QA review_
