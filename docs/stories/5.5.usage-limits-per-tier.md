# Story 5.5: Implement Usage Limits Per Tier

## Status

Draft

## Story

**As a** system,
**I want** to enforce usage limits based on subscription tier,
**so that** users must upgrade when they exceed limits.

## Context & Dependencies

- **Depends on:** Story 5.4 (Stripe billing) â€” needs `subscription_tier` on workspace to determine limits
- **Depended on by:** Story 5.6 (add-ons extend these limits)
- **Note:** Uses `getWorkspaceContext()` for workspace-scoped operations. Cron jobs use Vercel route handlers.

## Acceptance Criteria

1. Usage limits defined per tier:
   - Solo: 1 user, 5 employees, 50 AI queries/month, 1GB storage
   - Team: 5 users, 50 employees, 500 AI queries/month, 10GB storage
   - Enterprise: Unlimited users, unlimited employees, unlimited queries, 100GB storage
2. Usage tracked in database: `WorkspaceUsage` table with fields: ai_queries_this_month, employee_count, storage_used_mb
3. Middleware checks usage before allowing actions:
   - Adding user -> Check user limit
   - Adding employee -> Check employee limit
   - Sending AI query -> Check query limit
   - Uploading file -> Check storage limit
4. 10% overage allowance before hard block
5. Soft limit warning at 80%: "Du har anvant 40/50 AI-fragor denna manad. Uppgradera?"
6. Hard limit at 110%: "Du har natt din grans. Uppgradera for att fortsatta."
7. Usage resets monthly (1st of month) via Vercel cron
8. Usage dashboard shows current usage vs limits

## Tasks / Subtasks

- [ ] Define usage limits per tier in `lib/usage/limits.ts`
- [ ] Create `WorkspaceUsage` Prisma model
- [ ] Implement usage tracking for AI queries
- [ ] Implement usage tracking for employees
- [ ] Implement usage tracking for storage
- [ ] Create usage check utility function
- [ ] Add soft limit warnings (80%)
- [ ] Add hard limit blocks (110%)
- [ ] Create monthly reset Vercel cron route
- [ ] Build usage dashboard component
- [ ] Test all usage scenarios

## Dev Notes

**Usage Limits Definition:**

```typescript
// lib/usage/limits.ts
import type { SubscriptionTier } from '@prisma/client'

export interface UsageLimits {
  users: number | null       // null = unlimited
  employees: number | null
  aiQueriesPerMonth: number | null
  storageGB: number | null
}

export const TIER_LIMITS: Record<SubscriptionTier, UsageLimits> = {
  TRIAL: { users: 1, employees: 5, aiQueriesPerMonth: 50, storageGB: 1 },
  SOLO:  { users: 1, employees: 5, aiQueriesPerMonth: 50, storageGB: 1 },
  TEAM:  { users: 5, employees: 50, aiQueriesPerMonth: 500, storageGB: 10 },
  ENTERPRISE: { users: null, employees: null, aiQueriesPerMonth: null, storageGB: 100 },
}

export function getLimits(tier: SubscriptionTier): UsageLimits {
  return TIER_LIMITS[tier] || TIER_LIMITS.SOLO
}

export function isUnlimited(limit: number | null): boolean {
  return limit === null
}

export function calculateUsagePercentage(current: number, limit: number | null): number {
  if (isUnlimited(limit)) return 0
  return (current / limit!) * 100
}

export function hasReachedSoftLimit(current: number, limit: number | null): boolean {
  if (isUnlimited(limit)) return false
  return calculateUsagePercentage(current, limit) >= 80
}

export function hasReachedHardLimit(current: number, limit: number | null): boolean {
  if (isUnlimited(limit)) return false
  return calculateUsagePercentage(current, limit) >= 110
}
```

**Database Schema:**

```prisma
model WorkspaceUsage {
  id                  String   @id @default(uuid())
  workspaceId         String   @unique
  aiQueriesThisMonth  Int      @default(0)
  employeeCount       Int      @default(0)
  storageUsedMb       Int      @default(0)
  lastResetAt         DateTime @default(now())
  updatedAt           DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("workspace_usage")
}
```

**Usage Check Utility:**

```typescript
// lib/usage/check.ts
import { getWorkspaceContext } from '@/lib/auth/workspace-context'
import { prisma } from '@/lib/prisma'
import { getLimits, isUnlimited } from './limits'

export class UsageLimitError extends Error {
  constructor(
    public limitType: 'users' | 'employees' | 'aiQueries' | 'storage',
    public current: number,
    public limit: number,
    public isHardLimit: boolean
  ) {
    super(`Usage limit reached for ${limitType}`)
  }
}

export async function checkUsageLimit(
  workspaceId: string,
  tier: string,
  limitType: 'users' | 'employees' | 'aiQueries' | 'storage',
  additionalUsage: number = 1
): Promise<{ allowed: boolean; warning?: string }> {
  const limits = getLimits(tier as any)
  const usage = await prisma.workspaceUsage.findUnique({
    where: { workspaceId },
  })

  let currentUsage: number
  let limit: number | null

  switch (limitType) {
    case 'users':
      currentUsage = await prisma.workspaceMember.count({ where: { workspace_id: workspaceId } })
      limit = limits.users
      break
    case 'employees':
      currentUsage = usage?.employeeCount ?? 0
      limit = limits.employees
      break
    case 'aiQueries':
      currentUsage = usage?.aiQueriesThisMonth ?? 0
      limit = limits.aiQueriesPerMonth
      break
    case 'storage':
      currentUsage = (usage?.storageUsedMb ?? 0) / 1024
      limit = limits.storageGB
      break
  }

  if (isUnlimited(limit)) return { allowed: true }

  const futureUsage = currentUsage + additionalUsage

  if (futureUsage > limit! * 1.1) {
    throw new UsageLimitError(limitType, currentUsage, limit!, true)
  }

  if (futureUsage >= limit! * 0.8 && currentUsage < limit! * 0.8) {
    return {
      allowed: true,
      warning: `Du har anvant ${currentUsage}/${limit} ${limitType}. Overvag att uppgradera.`,
    }
  }

  return { allowed: true }
}
```

**Monthly Reset (Vercel Cron):**

```typescript
// app/api/cron/reset-usage/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'

export const dynamic = 'force-dynamic'
export const maxDuration = 60

const CRON_SECRET = process.env.CRON_SECRET

export async function GET(request: Request) {
  const authHeader = request.headers.get('authorization')
  if (process.env.NODE_ENV !== 'development' && CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const result = await prisma.workspaceUsage.updateMany({
    data: {
      aiQueriesThisMonth: 0,
      lastResetAt: new Date(),
    },
  })

  console.log(`[RESET-USAGE] Reset monthly usage for ${result.count} workspaces`)

  return NextResponse.json({ success: true, reset: result.count })
}
```

Add to `vercel.json`:
```json
{ "path": "/api/cron/reset-usage", "schedule": "0 0 1 * *" }
```

**Usage in API Routes:**

```typescript
// Example: In chat query route
import { checkUsageLimit, UsageLimitError } from '@/lib/usage/check'
import { getWorkspaceContext } from '@/lib/auth/workspace-context'

export async function POST(request: Request) {
  const context = await getWorkspaceContext()

  try {
    const usageCheck = await checkUsageLimit(
      context.workspaceId,
      'SOLO', // Get from workspace
      'aiQueries'
    )

    // ... process query ...

    return NextResponse.json({ answer, warning: usageCheck.warning })
  } catch (error) {
    if (error instanceof UsageLimitError) {
      return NextResponse.json(
        {
          error: 'Grans uppnadd',
          message: `Du har natt din grans for ${error.limitType} (${error.current}/${error.limit}). Uppgradera din plan.`,
        },
        { status: 429 }
      )
    }
    throw error
  }
}
```

**Reference:** Story 5.4 (subscription tier), `lib/auth/workspace-context.ts`

## Testing

**Unit Tests:**

- `calculateUsagePercentage()` returns correct percentage
- `hasReachedSoftLimit()` returns true at 80%
- `hasReachedHardLimit()` returns true at 110%
- Unlimited limits return false for limit checks

**Integration Tests:**

- AI query at limit (should block at 110%)
- AI query at 79% (should succeed without warning)
- AI query at 80% (should succeed with warning)
- Monthly reset clears AI query count
- Enterprise tier has no limits

**Test File:** `tests/unit/usage/limits.test.ts`

## Change Log

| Date       | Version | Description                             | Author     |
| ---------- | ------- | --------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                  | Sarah (PO) |
| 2026-02-19 | 2.0     | Updated auth/cron patterns, Swedish text | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
