# Story 14.1: Canonical HTML Schema & Standardized JSON Derivation

## Status

Draft v2.2

## Story

**As a** platform building a RAG pipeline,
**I want** all legal documents to conform to a single canonical HTML structure and have a standardized hierarchical JSON representation,
**so that** downstream chunking, retrieval, and rendering work consistently across all content types with a single parser.

## Context & Dependencies

**Why this story exists:**

The existing `html_content` across content types uses 5 different HTML conventions:

| Content Type | Ingestion Technique | Canonical Conformance | Gap |
|---|---|---|---|
| SFS Amendments | PDF → Claude LLM | **Reference standard** | Minor (`_S{N}` IDs on `<p>`) |
| MSBFS/NFS/ELSÄK-FS etc. | PDF → Claude LLM | **~95%** | Minor alignment |
| AFS (av.se scraped) | HTML scraping + transform | **~60%** | No `section.kapitel`, no semantic IDs, flat headings |
| EU Documents | EUR-Lex CELLAR → transform | **~70%** | Different article markup, no `p.text`, no semantic IDs |
| SFS Laws | Riksdag API → minimal cleanup | **~20%** | No wrapper, no structure, raw anchors |

The **amendment LLM prompt** (`lib/sfs/amendment-llm-prompt.ts`) and the **agency regulation LLM prompt** (`lib/agency/agency-regulation-prompt.ts`) already produce nearly identical, high-quality semantic HTML. This proven format becomes the canonical standard. Non-conforming content types need normalizers to match it.

The old approach (Story 14.1 v1) planned 3 separate HTML→JSON parsers. This revision instead:
1. Defines the canonical HTML schema (based on proven LLM output)
2. Renames root wrapper from `<article class="sfs">` to `<article class="legal-document">` — the old class name is SFS-specific but the wrapper is used for all content types (EU, agency, court cases). The CSS/rendering already uses `.legal-document`, so this aligns stored HTML with the rendering class.
3. Builds normalizers for non-conforming types (SFS laws, AFS, EU)
4. Builds **one** canonical HTML→JSON parser that works on all content

**Builds on:**

- `lib/sfs/amendment-llm-prompt.ts` — defines the reference HTML structure (Notisum-inspired semantic HTML)
- `lib/agency/agency-regulation-prompt.ts` — near-identical structure for agency PDFs
- `lib/agency/afs-html-transformer.ts` — AFS scraper (outer shell matches, inner body needs upgrade)
- `lib/eu/eu-html-transformer.ts` — EU transformer (close but uses different article conventions)
- `lib/sfs/clean-law-html.ts` — SFS law cleanup (minimal, needs full normalizer)
- `lib/transforms/html-to-json.ts` — existing flat JSON parser (to be replaced)
- `lib/transforms/html-to-markdown.ts` — existing markdown converter (review needed)

**Depends on:** Nothing. This is the foundation story for Epic 14 Phase 1.

**Depended on by:**

- Story 14.2 (ContentChunk Model & Chunking Pipeline) — consumes `json_content` in canonical schema
- Story 14.3 (Embedding Generation Pipeline) — operates on chunks derived from this schema
- All downstream RAG stories that query structured content

## Acceptance Criteria

### Canonical HTML Schema Specification (AC 1–5)

1. Canonical HTML schema documented in `lib/transforms/canonical-html-schema.md` — defines the exact element/class/ID conventions all `html_content` must follow
2. Root wrapper is `<article class="legal-document">` (renamed from `class="sfs"` to be content-type-agnostic, matching the existing CSS rendering class)
3. Schema covers: document wrapper, header, body, avdelningar (divisions), chapters, sections, paragraphs, allmänna råd, tables, footnotes, transition provisions, preamble (special zone), appendices
4. Semantic ID convention: `{DOC_ID}_K{N}_P{S}_S{T}` for chaptered docs, `{DOC_ID}_P{S}_S{T}` for flat docs, `{DOC_ID}_AVD{N}` for avdelningar (where DOC_ID = document number with spaces removed, colon → hyphen)
5. Avdelning support: documents with divisions use `<section class="avdelning" id="{DOC_ID}_AVD{N}">` wrapping their child `section.kapitel` elements — 3-level hierarchy: Avdelning → Kapitel → §

### HTML Normalizers (AC 6–9)

6. SFS Law normalizer (`lib/transforms/normalizers/sfs-law-normalizer.ts`) converts Riksdag API HTML into canonical structure — wraps in `article.legal-document`, adds `section.kapitel`, converts `<a class="paragraf" name="K1P1">` to `<h3 class="paragraph"><a class="paragraf" id="{DOC_ID}_K1_P1">`, adds `class="text"` to content paragraphs
7. AFS HTML transformer (`lib/agency/afs-html-transformer.ts`) upgraded to produce canonical inner structure — wraps chapter headings in `section.kapitel`, wraps avdelningar in `section.avdelning` with `h2.avdelning-rubrik`, converts section signs to `h3.paragraph > a.paragraf` with semantic IDs, adds `class="text"` to content paragraphs
8. EU HTML transformer (`lib/eu/eu-html-transformer.ts`) aligned — article headings use `h3.paragraph > a.paragraf` pattern, content paragraphs get `class="text"`, preamble uses `div.preamble` (special zone — contents are opaque, not canonicalized to `h3.paragraph` pattern)
9. Each normalizer/upgrade is idempotent — running it on already-conforming HTML produces identical output

### Canonical JSON Schema & Parser (AC 10–16)

10. Canonical JSON schema defined as TypeScript interfaces in `lib/transforms/document-json-schema.ts` — hierarchical: `{ divisions?: [...], chapters: [{ sections: [{ paragraphs: [] }] }] }`
11. Schema supports all content types including EU documents (`EU_REGULATION`, `EU_DIRECTIVE`) and documents with avdelningar (3-level hierarchy: `divisions[].chapters[].sections[]`)
12. Documents without chapters use a single implicit chapter with `number: null`
13. Documents with avdelningar use `divisions` array (each containing its chapters); documents without avdelningar use top-level `chapters` array (`divisions` is `null`). These fields are mutually exclusive: when `divisions` is populated, `chapters` must be `[]`; when `divisions` is `null`, `chapters` holds all chapter data.
14. Each paragraph has a `role` field: `PARAGRAPH`, `ALLMANT_RAD`, `PREAMBLE`, `TABLE`, `HEADING`, `TRANSITION_PROVISION`, `FOOTNOTE`
15. **One** canonical HTML→JSON parser (`lib/transforms/canonical-html-parser.ts`) works on all content types — parses `section.kapitel`, `h3.paragraph`, `a.paragraf`, `p.text` etc. No content-type-specific branching needed
16. Schema validation via Zod in `lib/transforms/validate-document-json.ts`

### Batch Processing (AC 17–19)

17. Batch script `scripts/normalize-and-derive.ts` runs in two phases:
    - Phase A: Normalize `html_content` for SFS laws, AFS docs, EU docs (updates `html_content` in-place)
    - Phase B: Derive `json_content` and `markdown_content` from normalized HTML using the single canonical parser
18. Script has `--dry-run`, `--limit N`, `--content-type`, `--phase A|B|both`, `--resume` flags
19. Progress logging, resume-on-failure, error-and-continue behavior

### Testing (AC 20–25)

20. At least 8 tests for SFS law normalizer (chaptered, flat, `2a §`, multi-stycke, övergångsbestämmelser, tables, empty input, real Riksdag sample)
21. At least 7 tests for AFS transformer upgrade (chaptered with `section.kapitel` output, semantic IDs, allmänna råd, footnotes, flat doc, avdelningar with `section.avdelning > section.kapitel` nesting, avdelning heading levels)
22. At least 4 tests for EU transformer alignment (chaptered with `h3.paragraph`, flat articles, `p.text` classes, preamble as `div.preamble` special zone with opaque content)
23. At least 8 tests for canonical HTML→JSON parser (all content types through single parser, implicit chapter, roles, validation, avdelningar → divisions, preamble as opaque content)
24. At least 4 tests for Zod schema validation
25. All existing tests pass (`afs-html-transformer.test.ts` updated for new output, `eu-html-transformer` tests updated)

## Tasks / Subtasks

### Task 1: Define Canonical HTML Schema Specification (AC: 1–5)

- [ ] Create `lib/transforms/canonical-html-schema.md` documenting the exact HTML contract
- [ ] Document the reference structure (based on amendment + agency-LLM proven output):

```html
<article class="legal-document" id="{DOC_ID}">
  <div class="lovhead">
    <h1>
      <p class="text">{DOCUMENT_NUMBER}</p>
      <p class="text">{TITLE}</p>
    </h1>
  </div>

  <!-- Optional preamble — SPECIAL ZONE (EU docs, some agency regs) -->
  <!-- Preamble content is opaque: not canonicalized to h3.paragraph pattern -->
  <div class="preamble">...</div>

  <div class="body">
    <!-- === 3-level hierarchy (docs with avdelningar) === -->
    <section class="avdelning" id="{DOC_ID}_AVD{N}">
      <h2 class="avdelning-rubrik">Avdelning {N} {TITLE}</h2>
      <section class="kapitel" id="{DOC_ID}_K{M}">
        <h3 class="kapitel-rubrik">{M} kap. {CHAPTER TITLE}</h3>
        <!-- §§ go here (same as 2-level structure below) -->
      </section>
    </section>

    <!-- === 2-level hierarchy (most docs — chapters + §§) === -->
    <section class="kapitel" id="{DOC_ID}_K{N}">
      <h2 class="kapitel-rubrik">{N} kap. {CHAPTER TITLE}</h2>

      <!-- Section headings (non-§ headings within chapter) -->
      <h3 id="{DOC_ID}_{slug}">{Section Title}</h3>

      <!-- § paragraphs -->
      <h3 class="paragraph">
        <a class="paragraf" id="{DOC_ID}_K{N}_P{S}" name="{DOC_ID}_K{N}_P{S}">{S} §</a>
      </h3>
      <p class="text">{paragraph text}</p>
      <p class="text">{second stycke}</p>

      <!-- Allmänna råd -->
      <div class="allmanna-rad">
        <p class="allmanna-rad-heading"><strong>Allmänna råd</strong></p>
        <p class="text">{guidance text}</p>
      </div>

      <!-- Tables -->
      <table class="legal-table">...</table>
    </section>

    <!-- OR: flat structure (no chapters) — sections directly in body -->
    <h3 class="paragraph">
      <a class="paragraf" id="{DOC_ID}_P{S}" name="{DOC_ID}_P{S}">{S} §</a>
    </h3>
    <p class="text">{paragraph text}</p>
  </div>

  <!-- Optional appendices -->
  <div class="appendices">...</div>

  <!-- Optional transition provisions -->
  <footer class="back">
    <h2>Ikraftträdande- och övergångsbestämmelser</h2>
    <p class="text">{provision text}</p>
  </footer>
</article>
```

- [ ] Document ID conventions:
  - `DOC_ID`: document number with spaces removed, colon → hyphen (e.g., `SFS1977-1160`, `MSBFS2020-1`, `eu-32016r0679`)
  - Avdelningar: `{DOC_ID}_AVD{N}` (N = avdelning number, arabic)
  - Chapters: `{DOC_ID}_K{N}` (N = chapter number)
  - Sections: `{DOC_ID}_K{N}_P{S}` (S = section/§ number, including `2a`)
  - Flat docs: `{DOC_ID}_P{S}` (no K prefix)
  - EU articles: `{DOC_ID}_art{N}` (or follow `_P{N}` if we unify)
- [ ] Document which elements are required vs optional
- [ ] Document footnote convention: `<sup class="footnote-ref" data-note="{N}" title="{text}">{N}</sup>`

### Task 1b: Rename `class="sfs"` → `class="legal-document"` (AC: 2)

- [ ] Update `lib/sfs/amendment-llm-prompt.ts` — change `<article class="sfs"` to `<article class="legal-document"` in system prompt
- [ ] Update `lib/agency/agency-regulation-prompt.ts` — same change in system prompt
- [ ] Update `lib/agency/afs-html-transformer.ts` — change wrapper assembly
- [ ] Update `lib/agency/afs-chapter-splitter.ts` — change chapter wrapper assembly
- [ ] Update `lib/agency/afs-prompt.ts` — if it references `class="sfs"`
- [ ] Update `lib/eu/eu-html-transformer.ts` — change `assembleDocument` wrapper
- [ ] Update `lib/sfs/llm-output-validator.ts` — update validation check for `article.sfs` → `article.legal-document`
- [ ] Update all test files asserting `class="sfs"` in output
- [ ] Batch script Phase A handles rename for existing DB records (simple string replace `class="sfs"` → `class="legal-document"` as part of normalization)
- [ ] **No CSS/rendering changes needed** — rendering already uses `.legal-document` class, not `.sfs`
- [ ] **No TOC impact** — `StickyDocNav` queries `section.kapitel`, `h3[id]`, `a.paragraf`, never `article.sfs`

### Task 2: Build SFS Law Normalizer (AC: 6, 9)

- [ ] Create `lib/transforms/normalizers/sfs-law-normalizer.ts`
- [ ] Parse chapter headings from `<h3><a name="K1">1 kap.</a> Title</h3>` → wrap in `<section class="kapitel" id="{DOC_ID}_K1"><h2 class="kapitel-rubrik">1 kap. Title</h2>`
- [ ] Convert `<a class="paragraf" name="K1P1"><b>1 §</b></a>` → `<h3 class="paragraph"><a class="paragraf" id="{DOC_ID}_K1_P1" name="{DOC_ID}_K1_P1">1 §</a></h3>`
- [ ] Convert stycke anchors `<a name="K1P1S2">` → add IDs to following `<p>` tags
- [ ] Add `class="text"` to content paragraphs
- [ ] Wrap full output in `<article class="legal-document" id="{DOC_ID}">` with `<div class="lovhead">` and `<div class="body">`
- [ ] Handle laws without chapters (no `K` anchors) → sections directly in body with `{DOC_ID}_P{S}` IDs
- [ ] Handle `2a §` numbering variants
- [ ] Extract övergångsbestämmelser into `<footer class="back">`
- [ ] Preserve tables, lists, definition lists
- [ ] Accept `documentNumber` and `title` parameters (both from the `LegalDocument` record) — `documentNumber` for DOC_ID generation, `title` for the `div.lovhead` header (Riksdag HTML does not contain the title)
- [ ] Idempotent: detect already-normalized HTML (presence of `article.legal-document`) and return unchanged
- [ ] Use cheerio (already in project dependencies)

### Task 3: Upgrade AFS HTML Transformer (AC: 7, 9)

- [ ] Update `lib/agency/afs-html-transformer.ts` to produce canonical inner structure
- [ ] Wrap chapter headings in `<section class="kapitel" id="{DOC_ID}_K{N}">` with `<h2 class="kapitel-rubrik">`
- [ ] For `avdelningar-chapters` pattern: wrap avdelning headings in `<section class="avdelning" id="{DOC_ID}_AVD{N}">` with `<h2 class="avdelning-rubrik">`, then child `section.kapitel` uses `<h3 class="kapitel-rubrik">` (note: heading level shifts when avdelningar are present)
- [ ] Convert `<a class="paragraf" id="kap1-1">` → `<h3 class="paragraph"><a class="paragraf" id="{DOC_ID}_K{N}_P{S}" name="{DOC_ID}_K{N}_P{S}">`
- [ ] Add `class="text"` to content `<p>` tags that don't already have it
- [ ] Maintain existing transformations: footnotes, allmänna råd, tables, lists, signatures
- [ ] Flat documents: sections get `{DOC_ID}_P{S}` IDs (no chapter prefix)
- [ ] Update `afs-html-transformer.test.ts` — assertions should now expect `section.kapitel`, semantic IDs, `h3.paragraph > a.paragraf`
- [ ] Verify chapter splitter still works with new structure (it splits on heading tags — may need update to split on `section.kapitel` instead)

### Task 4: Align EU HTML Transformer (AC: 8, 9)

- [ ] Update `lib/eu/eu-html-transformer.ts` to use canonical conventions
- [ ] Chaptered articles: `<h3 id="art-1">Artikel 1</h3>` → `<h3 class="paragraph"><a class="paragraf" id="{DOC_ID}_art1" name="{DOC_ID}_art1">Artikel 1</a></h3>`
- [ ] Flat articles: same `h3.paragraph > a.paragraf` pattern
- [ ] Add `class="text"` to article body paragraphs
- [ ] Convert `<details class="preamble-accordion">` → `<div class="preamble">` (keep the content, change the wrapper — preamble is a special zone, its inner content is not canonicalized to `h3.paragraph` pattern)
- [ ] Preserve all existing functionality: chapter detection, footnotes, layout table stripping, recital extraction
- [ ] Update EU transformer tests for new output conventions

### Task 5: Define Canonical JSON Schema (AC: 10–14)

- [ ] Create `lib/transforms/document-json-schema.ts` with TypeScript interfaces:

```typescript
export type ContentRole =
  | 'PARAGRAPH'
  | 'ALLMANT_RAD'
  | 'PREAMBLE'
  | 'TABLE'
  | 'HEADING'
  | 'TRANSITION_PROVISION'
  | 'FOOTNOTE'

export interface CanonicalDocumentJson {
  schemaVersion: '1.0'
  documentType: 'SFS_LAW' | 'SFS_AMENDMENT' | 'AGENCY_REGULATION' | 'EU_REGULATION' | 'EU_DIRECTIVE'
  title: string | null
  documentNumber: string | null
  divisions: CanonicalDivision[] | null  // null when no avdelningar
  chapters: CanonicalChapter[]           // top-level chapters (when no avdelningar)
  metadata: {
    sfsNumber: string | null
    baseLawSfs: string | null
    effectiveDate: string | null
  }
}

export interface CanonicalDivision {
  number: string                 // "1", "2" (arabic, derived from roman if needed)
  title: string | null
  chapters: CanonicalChapter[]
}

export interface CanonicalChapter {
  number: string | null          // null for implicit chapter (flat docs)
  title: string | null
  sections: CanonicalSection[]
}

export interface CanonicalSection {
  number: string                 // "1", "2a", "15b", "art1"
  heading: string | null
  paragraphs: CanonicalParagraph[]
}

export interface CanonicalParagraph {
  number: number | null          // stycke number (1, 2, 3...), null for non-numbered
  text: string                   // plain text
  role: ContentRole
  htmlContent?: string           // raw HTML for rendering (optional)
}
```

**`divisions` / `chapters` mutual exclusivity rule:**
- Document **with** avdelningar: `divisions` is populated (array of `CanonicalDivision`, each containing its chapters), `chapters` is `[]` (empty array)
- Document **without** avdelningar: `divisions` is `null`, `chapters` holds all chapter data
- The parser and Zod validator must enforce this invariant — never both populated simultaneously

### Task 6: Build Canonical HTML→JSON Parser (AC: 15)

- [ ] Create `lib/transforms/canonical-html-parser.ts`
- [ ] Single parser — no content-type branching — works entirely on canonical HTML conventions:
  - `article.legal-document` → document root
  - `div.lovhead > h1 > p.text` → title, document number
  - `section.avdelning` → divisions (3-level hierarchy)
  - `h2.avdelning-rubrik` → division number + title
  - `section.kapitel` → chapters (nested in avdelning or top-level)
  - `h2.kapitel-rubrik` or `h3.kapitel-rubrik` → chapter number + title (h-level depends on avdelning presence)
  - `h3.paragraph > a.paragraf` → section number
  - `p.text` → paragraphs
  - `div.allmanna-rad` → ALLMANT_RAD role
  - `div.preamble` → PREAMBLE role, opaque special zone (store raw HTML as-is, do not decompose into sections)
  - `table.legal-table` → TABLE role
  - `footer.back` → TRANSITION_PROVISION role
  - Flat docs (no `section.kapitel`) → implicit chapter wrapping all sections
- [ ] Refactor `lib/transforms/html-to-json.ts` — replace existing implementation with call to canonical parser, maintain backward compatibility for callers
- [ ] Export canonical schema types from the module

### Task 7: Schema Validation (AC: 16)

- [ ] Create `lib/transforms/validate-document-json.ts`
- [ ] Zod schema matching TypeScript interfaces
- [ ] Export `validateCanonicalJson(json: unknown): { valid: boolean, errors: string[] }`
- [ ] Human-readable error messages identifying path to invalid data

### Task 8: Update Markdown Derivation

- [ ] Review `lib/transforms/html-to-markdown.ts` — since all HTML now follows canonical structure, markdown conversion should be simpler/more consistent
- [ ] Verify output for all content types with sample documents
- [ ] Fix any content-type-specific issues

### Task 9: Build Batch Script (AC: 17–19)

- [ ] Create `scripts/normalize-and-derive.ts`
- [ ] **Phase A** (normalize HTML):
  - SFS_LAW: run SFS law normalizer on `html_content`, update in-place
  - AGENCY_REGULATION where `metadata.method = 'html-scraping'`: re-transform (or build a post-hoc normalizer for existing AFS HTML)
  - EU_REGULATION / EU_DIRECTIVE: re-transform (or build post-hoc normalizer)
  - Skip already-conforming documents (amendments, LLM-ingested agency regs)
- [ ] **Phase B** (derive JSON + markdown):
  - Run canonical HTML→JSON parser on all documents with `html_content`
  - Derive `markdown_content` from HTML
  - Validate JSON with Zod schema
  - Update `json_content` and `markdown_content`
- [ ] CLI flags: `--dry-run`, `--limit N`, `--content-type`, `--phase A|B|both`, `--resume`
- [ ] Progress logging: `"[SFS_LAW] Processed 500/10,803 (4.6%) | Errors: 2"`
- [ ] Resume tracking: `data/derive-progress.json`
- [ ] Error handling: log and continue (never abort batch)
- [ ] Summary report at end

### Task 10: Test Requirements Reference (AC: 20–25)

> **Test cadence:** Write tests alongside each task, not as a final step. This section lists the full test requirements for reference. When implementing Task 2, write its tests immediately. When implementing Task 3, write its tests immediately. And so on. Mark this task complete when all test requirements below are satisfied and all tests pass.

- [ ] `tests/unit/transforms/sfs-law-normalizer.test.ts` (at least 8 tests):
  - Law with chapters + paragraphs → `section.kapitel` wrappers, semantic IDs
  - Law without chapters → sections directly in body with `{DOC_ID}_P{S}` IDs
  - `2a §` numbering → correct ID and section number
  - Multi-stycke paragraph (K1P1, K1P1S2) → `p.text` tags with sequential content
  - Övergångsbestämmelser → `footer.back`
  - Tables preserved
  - Empty/minimal HTML
  - Idempotent: already-normalized HTML returns unchanged
- [ ] `tests/unit/lib/agency/afs-html-transformer.test.ts` updated (at least 6 tests):
  - Chaptered doc → `section.kapitel` in output, semantic IDs
  - Section signs → `h3.paragraph > a.paragraf` with `{DOC_ID}_K{N}_P{S}` IDs
  - Allmänna råd preserved
  - Footnotes preserved
  - Flat doc → `{DOC_ID}_P{S}` IDs
  - Avdelningar + chapters → correct nesting
- [ ] EU transformer tests updated (at least 4 tests):
  - Chaptered → `h3.paragraph > a.paragraf` for articles
  - Flat → same pattern
  - `p.text` classes on body paragraphs
  - Preamble as `div.preamble`
- [ ] `tests/unit/transforms/canonical-html-parser.test.ts` (at least 8 tests):
  - Normalized SFS law HTML → correct JSON structure
  - Amendment HTML (already canonical) → correct JSON
  - Agency LLM HTML → correct JSON
  - EU normalized HTML → correct JSON
  - Flat document → implicit chapter
  - All content roles extracted correctly
  - Document with avdelningar → `divisions` array populated, chapters nested correctly
  - Preamble special zone → stored as opaque content, not decomposed into sections
- [ ] `tests/unit/transforms/validate-document-json.test.ts` (at least 4 tests):
  - Valid JSON passes
  - Missing chapters fails
  - Invalid role fails
  - Error identifies path
- [ ] Verify all existing tests pass (update AFS/EU tests for new output)
- [ ] `npx tsc --noEmit` passes

## Dev Notes

### Source Tree

```
lib/transforms/
  ├── html-to-json.ts                    — EXISTING — refactor to delegate to canonical parser
  ├── html-to-markdown.ts                — EXISTING — review for canonical HTML
  ├── canonical-html-schema.md           — NEW — the HTML contract specification
  ├── document-json-schema.ts            — NEW — canonical JSON TypeScript interfaces
  ├── canonical-html-parser.ts           — NEW — single HTML→JSON parser for canonical HTML
  ├── validate-document-json.ts          — NEW — Zod schema validation
  └── normalizers/
      └── sfs-law-normalizer.ts          — NEW — Riksdag HTML → canonical HTML

lib/agency/
  └── afs-html-transformer.ts            — EXISTING — upgrade inner structure to canonical

lib/eu/
  └── eu-html-transformer.ts             — EXISTING — align to canonical conventions

lib/sfs/
  └── clean-law-html.ts                  — EXISTING — may be absorbed into normalizer

scripts/
  └── normalize-and-derive.ts            — NEW — batch normalization + derivation

data/
  └── derive-progress.json               — NEW — resume cursor (gitignored)
```

### Canonical HTML — Proven Reference (Amendment LLM Output)

```html
<article class="legal-document" id="SFS2025-732">
  <div class="lovhead">
    <h1 id="SFS2025-732_GENH0000">
      <p class="text">SFS 2025:732</p>
      <p class="text">Lag om ändring i arbetsmiljölagen (1977:1160)</p>
    </h1>
  </div>
  <div class="body" id="SFS2025-732_BODY0001">
    <section class="kapitel" id="SFS2025-732_K6">
      <div class="N2">
        <section class="ann">
          <div class="element-body annzone">
            <h3 class="paragraph" id="SFS2025-732_K6_P17">
              <span class="kapitel">6 kap.</span> 17 §
            </h3>
            <p class="text" id="SFS2025-732_K6_P17_S1">First stycke...</p>
            <p class="text" id="SFS2025-732_K6_P17_S2">Second stycke...</p>
          </div>
        </section>
      </div>
    </section>
  </div>
  <footer class="back" id="SFS2025-732_BACK0001">
    <!-- Transition provisions -->
  </footer>
</article>
```

### Canonical HTML — Agency LLM Output (Near-Identical)

```html
<article class="legal-document" id="MSBFS2020-1">
  <div class="lovhead">
    <h1>
      <p class="text">MSBFS 2020:1</p>
      <p class="text">Föreskrifter om hantering av brandfarlig gas</p>
    </h1>
  </div>
  <div class="body">
    <section class="kapitel" id="MSBFS2020-1_K1">
      <h2 class="kapitel-rubrik">1 kap. Inledande bestämmelser</h2>
      <h3 class="paragraph">
        <a class="paragraf" id="MSBFS2020-1_K1_P1" name="MSBFS2020-1_K1_P1">1 §</a>
      </h3>
      <p class="text">Denna författning innehåller bestämmelser...</p>
    </section>
  </div>
</article>
```

### Canonical HTML — Avdelning Structure (3-Level Hierarchy)

Some Swedish regulations (e.g. AFS 2023:1 Risker i arbetsmiljön) group chapters into Avdelningar (divisions). The canonical schema supports this as a 3-level hierarchy:

```html
<article class="legal-document" id="AFS2023-1">
  <div class="lovhead">...</div>
  <div class="body">
    <section class="avdelning" id="AFS2023-1_AVD1">
      <h2 class="avdelning-rubrik">Avdelning 1 Gemensamma bestämmelser</h2>
      <section class="kapitel" id="AFS2023-1_K1">
        <h3 class="kapitel-rubrik">1 kap. Allmänna bestämmelser</h3>
        <h3 class="paragraph">
          <a class="paragraf" id="AFS2023-1_K1_P1" name="AFS2023-1_K1_P1">1 §</a>
        </h3>
        <p class="text">Dessa föreskrifter gäller...</p>
      </section>
    </section>
    <section class="avdelning" id="AFS2023-1_AVD2">
      <h2 class="avdelning-rubrik">Avdelning 2 Fysikaliska riskkällor</h2>
      <section class="kapitel" id="AFS2023-1_K5">
        <h3 class="kapitel-rubrik">5 kap. Buller</h3>
        <!-- ... -->
      </section>
    </section>
  </div>
</article>
```

**Heading level rules:**
- Without avdelningar: `h2` = chapter heading
- With avdelningar: `h2` = avdelning heading, `h3` = chapter heading (level shifts down)
- `h3.paragraph > a.paragraf` always holds §§ regardless of hierarchy depth

**Source:** Already defined in `lib/agency/afs-prompt.ts` (`section.avdelning`, `h2.avdelning-rubrik`)

### EU Preamble — Special Zone

EU documents have a preamble with recitals that does NOT follow the `h3.paragraph > a.paragraf` pattern. It is stored as a `<div class="preamble">` with opaque internal content. The canonical parser should preserve preamble content as-is and not attempt to decompose it into sections/paragraphs.

```html
<div class="preamble">
  <p>EUROPAPARLAMENTET OCH EUROPEISKA UNIONENS RÅD HAR ANTAGIT DENNA FÖRORDNING...</p>
  <p>(1) Med beaktande av...</p>
  <p>(2) Europaparlamentet...</p>
  <!-- ... recitals continue -->
</div>
```

### Key Difference Between Amendment & Agency LLM Output

The amendment prompt uses Notisum-style nesting (`section.ann > div.element-body.annzone`) while the agency prompt uses flat structure within chapters. For the canonical schema, the **agency format is simpler and preferred** — the `ann`/`annzone` wrappers are Notisum legacy. The canonical parser should handle both (ignore wrapper divs, parse the `h3.paragraph` and `p.text` regardless of nesting depth).

### Riksdag HTML — What Needs Normalization

```html
<!-- Current (raw from Riksdag API after cleanLawHtml): -->
<h3><a name="K1">1 kap.</a> Lagens tillämpningsområde</h3>
<a class="paragraf" name="K1P1"><b>1 §</b></a>
<p>Denna lag har till ändamål att förebygga ohälsa...</p>
<a name="K1P1S2"></a>Lagen gäller även...

<!-- Target (after normalization): -->
<article class="legal-document" id="SFS1977-1160">
  <div class="lovhead">
    <h1><p class="text">SFS 1977:1160</p><p class="text">Arbetsmiljölagen</p></h1>
  </div>
  <div class="body">
    <section class="kapitel" id="SFS1977-1160_K1">
      <h2 class="kapitel-rubrik">1 kap. Lagens tillämpningsområde</h2>
      <h3 class="paragraph">
        <a class="paragraf" id="SFS1977-1160_K1_P1" name="SFS1977-1160_K1_P1">1 §</a>
      </h3>
      <p class="text">Denna lag har till ändamål att förebygga ohälsa...</p>
      <p class="text">Lagen gäller även...</p>
    </section>
  </div>
</article>
```

### AFS Transformer — What Needs Upgrading

```html
<!-- Current output (chapters-only): -->
<div class="body">
  <h2>1 kap. Allmänna bestämmelser</h2>
  <a class="paragraf" id="kap1-1" name="kap1-1">1 §</a>
  <p>Dessa föreskrifter gäller.</p>
</div>

<!-- Target output (chapters-only): -->
<div class="body">
  <section class="kapitel" id="AFS2023-1_K1">
    <h2 class="kapitel-rubrik">1 kap. Allmänna bestämmelser</h2>
    <h3 class="paragraph">
      <a class="paragraf" id="AFS2023-1_K1_P1" name="AFS2023-1_K1_P1">1 §</a>
    </h3>
    <p class="text">Dessa föreskrifter gäller.</p>
  </section>
</div>

<!-- Current output (avdelningar-chapters): -->
<div class="body">
  <h2>Avdelning 1 Gemensamma bestämmelser</h2>
  <h3>1 kap. Allmänna bestämmelser</h3>
  <a class="paragraf" id="kap1-1" name="kap1-1">1 §</a>
  <p>Dessa föreskrifter gäller.</p>
</div>

<!-- Target output (avdelningar-chapters): -->
<div class="body">
  <section class="avdelning" id="AFS2023-1_AVD1">
    <h2 class="avdelning-rubrik">Avdelning 1 Gemensamma bestämmelser</h2>
    <section class="kapitel" id="AFS2023-1_K1">
      <h3 class="kapitel-rubrik">1 kap. Allmänna bestämmelser</h3>
      <h3 class="paragraph">
        <a class="paragraf" id="AFS2023-1_K1_P1" name="AFS2023-1_K1_P1">1 §</a>
      </h3>
      <p class="text">Dessa föreskrifter gäller.</p>
    </section>
  </section>
</div>
```

### EU Transformer — What Needs Aligning

```html
<!-- Current output (chaptered): -->
<section class="kapitel" id="chp-i">
  <h2>KAPITEL I — Allmänna bestämmelser</h2>
  <h3 id="art-1">Artikel 1 — <em>Syfte</em></h3>
  <p>This regulation lays down rules...</p>
</section>

<!-- Target output: -->
<section class="kapitel" id="eu-32016r0679_K1">
  <h2 class="kapitel-rubrik">KAPITEL I — Allmänna bestämmelser</h2>
  <h3 class="paragraph">
    <a class="paragraf" id="eu-32016r0679_art1" name="eu-32016r0679_art1">Artikel 1 — Syfte</a>
  </h3>
  <p class="text">This regulation lays down rules...</p>
</section>
```

### Scale & Performance

- **SFS Laws:** ~10,803 documents — Phase A normalization needed
- **SFS Amendments:** ~24,932 — already conforming (skip Phase A)
- **Agency Regs (LLM-ingested):** ~200 — already ~95% conforming (minor Phase A)
- **Agency Regs (AFS scraped):** ~81 — Phase A upgrade needed
- **EU Documents:** ~50-100 — Phase A alignment needed
- **Total Phase A:** ~11,000 documents need normalization
- **Total Phase B:** ~36,000 documents need JSON/MD derivation
- Estimated runtime: Phase A 5-10 min, Phase B 10-20 min (pure CPU, no API calls)

### Integration Notes

- The normalizer updates `html_content` in-place — this is a one-time migration
- After this story, all new documents entering the DB must go through normalization (update ingestion pipelines)
- The `linkifyHtmlContent()` step runs AFTER normalization (order: raw → normalize → linkify → store)
- Existing SFS amendment ingestion (`sync-sfs-updates`) and agency PDF ingestion (`ingest-agency-pdfs.ts`) already produce conforming HTML — no changes needed there
- `sync-sfs/route.ts` (SFS law ingestion) needs to call the normalizer after `cleanLawHtml()`
- `ingest-afs-regulations-v2.ts` uses the upgraded transformer automatically

### LegalDocument Schema Reference

```prisma
model LegalDocument {
  id               String       @id @default(uuid())
  content_type     ContentType  // SFS_LAW, SFS_AMENDMENT, AGENCY_REGULATION, EU_*
  document_number  String       @unique
  title            String
  html_content     String?      @db.Text  // SSOT — normalized canonical HTML
  markdown_content String?      @db.Text  // Derived from canonical HTML
  json_content     Json?                  // Derived from canonical HTML
  // ... other fields
  @@map("legal_documents")
}
```

### Import Aliases

Use `@/lib/transforms/...` for transform modules, `@/lib/prisma` for Prisma client.

## Testing

**Test location:** `tests/unit/transforms/` and `tests/unit/lib/agency/`

**Test framework:** Vitest — pure transform functions (HTML in → HTML/JSON out), no mocking needed.

**Test files:**

- `tests/unit/transforms/sfs-law-normalizer.test.ts` (8+ tests)
- `tests/unit/lib/agency/afs-html-transformer.test.ts` (existing, updated for new output)
- `tests/unit/lib/eu/eu-html-transformer.test.ts` (existing or new, updated)
- `tests/unit/transforms/canonical-html-parser.test.ts` (6+ tests)
- `tests/unit/transforms/validate-document-json.test.ts` (4+ tests)

**Pattern:** Inline HTML fixtures for test inputs. Assert both HTML structure (for normalizers) and JSON structure (for parser). Snapshot tests optional for complex outputs.

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2026-02-18 | 1.0     | Initial story creation | Sarah (PO) |
| 2026-02-18 | 2.0     | Rewrite: canonical HTML schema + normalizers approach (replaces 3-parser approach) | Dev team |
| 2026-02-18 | 2.1     | Add avdelning support (3-level hierarchy), clarify EU preamble as special zone, update JSON schema with divisions | Dev team |
| 2026-02-18 | 2.2     | PO validation fixes: globally unique AC numbering (1-25), fix copy-paste typo, add title param to SFS normalizer, add PREAMBLE role, document divisions/chapters mutual exclusivity, per-task test cadence note | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
