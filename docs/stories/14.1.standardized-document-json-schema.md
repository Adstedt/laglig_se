# Story 14.1: Canonical HTML Schema & JSON Derivation

## Status

**Complete** — HTML normalization done, deterministic JSON parser proven across all document types, Swedish-named schema finalized.

## Story

**As a** platform building a RAG pipeline,
**I want** all Swedish legal documents normalized to canonical HTML and derived into structured JSON,
**so that** downstream chunking, retrieval, and rendering work reliably.

## Architecture

### Two-Group Split

Documents are split into two groups with separate pipelines:

| Group | Content Types | HTML Strategy | JSON Strategy |
|-------|--------------|---------------|---------------|
| **Swedish** | SFS laws, SFS amendments, agency regulations | Canonical HTML schema (`canonical-html-schema.md`) | Deterministic parser → `CanonicalDocumentJson` |
| **EU** | EU regulations, EU directives | Native CELLAR HTML with cleanup | Separate pipeline (own story) |

**Rationale:** EU articles use nested numbered points (1., 2., a, b, c) that don't map to Swedish § structure. Forcing a shared schema caused content loss. Confirmed by testing LLM conformance prompt on 25 docs — Swedish passed reliably, EU failed.

### JSON Derivation: Deterministic Parser

The deterministic HTML→JSON parser (`canonical-html-parser.ts`) was improved to production quality:

- **Heading shift** — post-processing that moves trailing HEADING stycken to the `heading` field of the next paragraf
- **List item detection** — three patterns: numbered (`1. `), dash (`- `), letter (`a) `)
- **Amendment ref extraction** — scans backwards through stycken to pull `Lag (YYYY:NNN)` into `amendedBy` field
- **Stycke numbering** — sequential numbers on real content stycken, `null` for special roles (TABLE, ALLMANT_RAD, etc.)

Originally an LLM-based approach was considered, but testing showed the deterministic parser delivers sufficient quality for RAG chunking at zero marginal cost.

Pipeline:
```
Canonical HTML (normalized, in DB)
    ↓  Deterministic parser (canonical-html-parser.ts)
CanonicalDocumentJson
    ↓  Zod validation
Stored in json_content
```

## What Was Done

### Phase 1: HTML Normalization

- **Canonical HTML schema** — documented in `lib/transforms/canonical-html-schema.md`, covers all Swedish doc patterns (flat, 2-level chapters, 3-level avdelningar)
- **SFS Law normalizer** — `lib/transforms/normalizers/sfs-law-normalizer.ts`, converts Riksdag API HTML to canonical structure. Phase A batch: 8,249 of ~10,800 normalized, 47 partially normalized, 2,538 legitimately simple
- **SFS Amendment normalizer** — `lib/transforms/normalizers/sfs-amendment-normalizer.ts`, converts Notisum-format to canonical structure
- **Amendment LLM prompt rewrite** — `lib/sfs/amendment-llm-prompt.ts`, new amendments produce canonical HTML directly
- **AFS transformer upgrade** — `lib/agency/afs-html-transformer.ts`, canonical inner structure
- **EU transformer alignment** — `lib/eu/eu-html-transformer.ts`, semantic IDs + preamble accordion (separate group, not forced to canonical)
- **Cron integration** — Both `sync-sfs-updates` and `sync-sfs` crons normalize HTML on ingest

### Phase 2: JSON Schema & Parser

- **JSON schema** — `lib/transforms/document-json-schema.ts`, TypeScript interfaces using Swedish legal terminology:
  - `CanonicalParagraf` (§) with `number`, `heading`, `content`, `amendedBy`, `stycken`
  - `CanonicalStycke` with `number`, `text`, `role`, optional `htmlContent`
  - Content roles: `STYCKE`, `LIST_ITEM`, `ALLMANT_RAD`, `TABLE`, `HEADING`, `TRANSITION_PROVISION`, `FOOTNOTE`
- **Deterministic parser** — `lib/transforms/canonical-html-parser.ts`, with heading shift, list detection, amendment ref extraction
- **Zod validation** — `lib/transforms/validate-document-json.ts`
- **Batch script** — `scripts/normalize-and-derive.ts`, Phase A (normalize) + Phase B (derive), with `--dry-run`, `--limit`, `--content-type`, `--phase`, `--resume` flags

### Parser Quality Evaluation

Tested across all three source pipelines:

| Source | HTML origin | Docs tested | Validation | Quality |
|---|---|---|---|---|
| SFS laws (large, chaptered) | Riksdagen API + normalizer | 5 | 100% pass | 88% good, 9% acceptable, 3% edge-case |
| SFS laws (small/flat) | Riksdagen API + normalizer | 5 | 100% pass | Same distribution |
| Agency docs (all prefixes) | LLM-parsed PDF / av.se scraped | 12 | 100% pass | All clean |

Tested agency prefixes: AFS, MSBFS, SSMFS, ELSÄK-FS, BFS, SRVFS, STAFS, NFS, SCB-FS, KIFS, MCFFS.

Key metrics from eval:
- Heading placement: 3,964 headings correctly placed
- List items detected: 7,906 (numbered + dash + letter)
- Amendment refs extracted: 97+ per large law
- Chunk size median: 322 chars (good for RAG)
- Residual noise: 660 residual headings, 894 hyperlink-boundary splits (~3%)

### Per-Content-Type Status

| Content Type | Count | HTML Status | JSON Status |
|---|---|---|---|
| SFS Laws | ~10,800 | 8,249 normalized, 47 need fix, 2,538 simple | Parser ready, derive pending |
| SFS Amendments (new) | going forward | Canonical from LLM prompt | Parser ready |
| SFS Amendments (existing) | ~34,000 | Old Notisum format → Story 14.2b | Blocked on re-ingestion |
| Agency regs (LLM) | ~200 | ~95% canonical | Parser ready, validated on 10 prefixes |
| AFS (scraped) | ~81 | Canonical from av.se transformer | Parser ready, validated |
| EU docs | ~5,600 | Separate pipeline (own story) | N/A |

### Source Tree

```
lib/transforms/
  ├── canonical-html-schema.md         — HTML contract spec
  ├── document-json-schema.ts          — JSON TypeScript interfaces (Swedish naming)
  ├── canonical-html-parser.ts         — Deterministic parser (production)
  ├── validate-document-json.ts        — Zod validation
  ├── conformance-prompt.ts            — LLM conformance prompt for Swedish docs
  ├── html-to-json.ts                  — Legacy parser (preserved)
  ├── html-to-markdown.ts              — Markdown derivation
  └── normalizers/
      ├── sfs-law-normalizer.ts        — Riksdag HTML → canonical
      └── sfs-amendment-normalizer.ts  — Notisum format → canonical

scripts/
  └── normalize-and-derive.ts          — Batch normalize + derive script

tests/unit/transforms/
  ├── canonical-html-parser.test.ts    — Parser tests
  └── validate-document-json.test.ts   — Schema validation tests
```

## Next Steps

1. **Run derive phase** — Execute `normalize-and-derive.ts --phase B` to populate `json_content` for all SFS_LAW + AGENCY_REGULATION docs
2. **Story 14.2** — ContentChunk model & chunking pipeline (consumes `json_content`)
3. **Story 14.3** — Embedding generation pipeline
4. **Story 14.2b** — Amendment re-ingestion via Batch API (~34K amendments, ~$1,400)
5. **EU pipeline** — Separate story for EU doc cleanup + article-level chunking

## Change Log

| Date | Version | Description |
|------|---------|-------------|
| 2026-02-18 | 1.0 | Initial story — canonical HTML schema + normalizers approach |
| 2026-02-18 | 2.0-2.2 | Avdelning support, PO validation, schema refinements |
| 2026-02-19 | 2.3-2.4 | Amendment prompt rewrite, AFS revert, EU fixes |
| 2026-02-20 | 3.0 | Two-group architecture split, conformance prompt, Phase A audit |
| 2026-02-20 | 4.0 | Story rewrite. Phase 1 (HTML normalization) complete. Phase 2 planned as LLM-based JSON derivation. |
| 2026-02-20 | 5.0 | **Phase 2 complete.** Deterministic parser proven sufficient (LLM not needed). Schema renamed to Swedish terminology (Paragraf/Stycke). Parser improved with heading shift, list detection, amendment ref extraction. Validated on 10 SFS laws + 12 agency docs across all prefixes — 100% validation pass rate. |
