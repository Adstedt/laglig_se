# Story 5.8: Implement Workspace Pause and Deletion

## Status
Draft

## Story

**As a** workspace owner,
**I want** to pause or delete my workspace,
**so that** I can stop paying without losing data (pause) or permanently remove everything (delete).

## Acceptance Criteria

### Pause Workspace

1. Settings page → "Pause Workspace" button
2. Confirmation modal: "Your data will be preserved but access blocked until resumed."
3. Workspace status set to "paused"
4. Team members cannot login to workspace
5. Stripe subscription canceled, no future charges
6. Data preserved indefinitely
7. "Resume Workspace" button re-enables access

### Delete Workspace

8. Settings page → "Delete Workspace" button (Owner only)
9. Confirmation modal requires typing workspace name
10. Workspace soft-deleted (status: "deleted")
11. All workspace data hidden from queries
12. Email sent to all team members: "Workspace deleted"
13. 30-day recovery period (Owner can restore)
14. After 30 days, hard delete via cron job (GDPR compliance)
15. Stripe subscription canceled immediately

## Tasks / Subtasks

- [ ] Add pause/delete buttons to settings
- [ ] Create pause confirmation modal
- [ ] Implement pause workspace API
- [ ] Cancel Stripe subscription on pause
- [ ] Create delete confirmation modal with name input
- [ ] Implement soft-delete workspace API
- [ ] Send deletion notification emails
- [ ] Implement 30-day recovery period
- [ ] Create hard-delete cron job
- [ ] Test pause → resume flow
- [ ] Test delete → restore flow

## Dev Notes

**Pause/Delete Buttons:**
```typescript
// components/settings/danger-zone.tsx
'use client'

import { useState } from 'react'
import { Can } from '@/components/permissions/can'
import { Permission } from '@/lib/permissions/roles'

export function DangerZone({ workspace }: { workspace: any }) {
  const [showPauseModal, setShowPauseModal] = useState(false)
  const [showDeleteModal, setShowDeleteModal] = useState(false)

  return (
    <div className="bg-white rounded-lg shadow p-6 border-2 border-red-200">
      <h2 className="text-lg font-semibold text-red-600 mb-4">Danger Zone</h2>

      <div className="space-y-4">
        {/* Pause Workspace */}
        {workspace.status === 'active' && (
          <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
            <div>
              <h3 className="font-semibold">Pause Workspace</h3>
              <p className="text-sm text-gray-600">
                Temporarily disable access while preserving all data
              </p>
            </div>
            <Can permission={Permission.MANAGE_WORKSPACE_SETTINGS}>
              <button
                onClick={() => setShowPauseModal(true)}
                className="px-4 py-2 border border-yellow-600 text-yellow-600 rounded-lg hover:bg-yellow-50"
              >
                Pause Workspace
              </button>
            </Can>
          </div>
        )}

        {/* Resume Workspace */}
        {workspace.status === 'paused' && (
          <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-yellow-50">
            <div>
              <h3 className="font-semibold">Workspace Paused</h3>
              <p className="text-sm text-gray-600">
                This workspace is currently paused. Resume to re-enable access.
              </p>
            </div>
            <Can permission={Permission.MANAGE_WORKSPACE_SETTINGS}>
              <button
                onClick={() => resumeWorkspace()}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
              >
                Resume Workspace
              </button>
            </Can>
          </div>
        )}

        {/* Delete Workspace */}
        <div className="flex items-center justify-between p-4 border border-red-200 rounded-lg">
          <div>
            <h3 className="font-semibold text-red-600">Delete Workspace</h3>
            <p className="text-sm text-gray-600">
              Permanently delete this workspace and all its data after 30 days
            </p>
          </div>
          <Can permission={Permission.DELETE_WORKSPACE}>
            <button
              onClick={() => setShowDeleteModal(true)}
              className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
            >
              Delete Workspace
            </button>
          </Can>
        </div>
      </div>

      {showPauseModal && (
        <PauseWorkspaceModal
          workspace={workspace}
          onClose={() => setShowPauseModal(false)}
        />
      )}

      {showDeleteModal && (
        <DeleteWorkspaceModal
          workspace={workspace}
          onClose={() => setShowDeleteModal(false)}
        />
      )}
    </div>
  )
}
```

**Pause Workspace Modal:**
```typescript
// components/settings/pause-workspace-modal.tsx
export function PauseWorkspaceModal({ workspace, onClose }: Props) {
  const [isLoading, setIsLoading] = useState(false)

  async function handlePause() {
    setIsLoading(true)

    try {
      const response = await fetch('/api/workspace/pause', {
        method: 'POST'
      })

      if (response.ok) {
        alert('Workspace paused successfully')
        window.location.reload()
      } else {
        alert('Failed to pause workspace')
      }
    } catch (error) {
      alert('Failed to pause workspace')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <h2 className="text-xl font-bold mb-4">Pause Workspace?</h2>

        <div className="mb-6 space-y-3">
          <p className="text-gray-700">
            Pausing your workspace will:
          </p>
          <ul className="list-disc pl-5 space-y-2 text-sm text-gray-600">
            <li>Block access for all team members</li>
            <li>Cancel your Stripe subscription (no future charges)</li>
            <li>Preserve all your data</li>
            <li>Allow you to resume anytime</li>
          </ul>

          <p className="text-sm text-gray-600 mt-4">
            You can resume your workspace anytime to restore full access.
          </p>
        </div>

        <div className="flex gap-3">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            onClick={handlePause}
            disabled={isLoading}
            className="flex-1 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:bg-gray-300"
          >
            {isLoading ? 'Pausing...' : 'Pause Workspace'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

**Delete Workspace Modal:**
```typescript
// components/settings/delete-workspace-modal.tsx
export function DeleteWorkspaceModal({ workspace, onClose }: Props) {
  const [confirmText, setConfirmText] = useState('')
  const [isLoading, setIsLoading] = useState(false)

  const canDelete = confirmText === workspace.name

  async function handleDelete() {
    if (!canDelete) return

    setIsLoading(true)

    try {
      const response = await fetch('/api/workspace/delete', {
        method: 'POST'
      })

      if (response.ok) {
        alert('Workspace deleted. You have 30 days to restore it.')
        window.location.href = '/'
      } else {
        alert('Failed to delete workspace')
      }
    } catch (error) {
      alert('Failed to delete workspace')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <h2 className="text-xl font-bold text-red-600 mb-4">
          Delete Workspace?
        </h2>

        <div className="mb-6 space-y-3">
          <p className="text-gray-700 font-semibold">
            This action cannot be undone easily.
          </p>

          <ul className="list-disc pl-5 space-y-2 text-sm text-gray-600">
            <li>All team members will lose access immediately</li>
            <li>Your Stripe subscription will be canceled</li>
            <li>All workspace data will be hidden</li>
            <li>You have 30 days to restore before permanent deletion</li>
          </ul>

          <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded">
            <p className="text-sm text-red-800">
              ⚠️ After 30 days, all data will be permanently deleted and cannot
              be recovered.
            </p>
          </div>

          <div className="mt-4">
            <label className="block text-sm font-medium mb-2">
              Type <span className="font-mono bg-gray-100 px-1">"{workspace.name}"</span> to confirm:
            </label>
            <input
              type="text"
              value={confirmText}
              onChange={(e) => setConfirmText(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
              placeholder={workspace.name}
            />
          </div>
        </div>

        <div className="flex gap-3">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            onClick={handleDelete}
            disabled={!canDelete || isLoading}
            className="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
          >
            {isLoading ? 'Deleting...' : 'Delete Workspace'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

**Pause Workspace API:**
```typescript
// app/api/workspace/pause/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, workspace, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_WORKSPACE_SETTINGS)

    // Pause workspace
    await prisma.workspace.update({
      where: { id: workspaceId },
      data: {
        status: 'paused',
        pausedAt: new Date()
      }
    })

    // Cancel Stripe subscription
    if (workspace.stripeSubscriptionId) {
      await stripe.subscriptions.cancel(workspace.stripeSubscriptionId)
    }

    return NextResponse.json({ success: true })
  })
}
```

**Resume Workspace API:**
```typescript
// app/api/workspace/resume/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, role }) => {
    checkPermission(role as WorkspaceRole, Permission.MANAGE_WORKSPACE_SETTINGS)

    // Resume workspace
    await prisma.workspace.update({
      where: { id: workspaceId },
      data: {
        status: 'active',
        pausedAt: null
      }
    })

    // Note: User must re-subscribe via billing page

    return NextResponse.json({ success: true })
  })
}
```

**Delete Workspace API:**
```typescript
// app/api/workspace/delete/route.ts
export async function POST(request: Request) {
  return withWorkspace(async ({ workspaceId, workspace, role }) => {
    checkPermission(role as WorkspaceRole, Permission.DELETE_WORKSPACE)

    // Soft delete workspace
    await prisma.workspace.update({
      where: { id: workspaceId },
      data: {
        status: 'deleted',
        deletedAt: new Date()
      }
    })

    // Cancel Stripe subscription
    if (workspace.stripeSubscriptionId) {
      await stripe.subscriptions.cancel(workspace.stripeSubscriptionId)
    }

    // Send notification emails to all members
    const members = await prisma.workspaceMember.findMany({
      where: { workspaceId },
      include: { user: true }
    })

    for (const member of members) {
      await sendWorkspaceDeletedEmail(
        member.user.email,
        workspace.name
      )
    }

    return NextResponse.json({ success: true })
  })
}
```

**Restore Workspace API:**
```typescript
// app/api/workspace/restore/route.ts
export async function POST(request: Request) {
  const { workspaceId } = await request.json()

  // Verify user is owner of deleted workspace
  const session = await getServerSession(authOptions)
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const workspace = await prisma.workspace.findFirst({
    where: {
      id: workspaceId,
      ownerId: session.user.id,
      status: 'deleted'
    }
  })

  if (!workspace) {
    return NextResponse.json(
      { error: 'Workspace not found or not owned by you' },
      { status: 404 }
    )
  }

  // Check if within 30-day recovery period
  const daysSinceDeletion = Math.floor(
    (Date.now() - workspace.deletedAt!.getTime()) / (1000 * 60 * 60 * 24)
  )

  if (daysSinceDeletion > 30) {
    return NextResponse.json(
      { error: 'Recovery period expired' },
      { status: 400 }
    )
  }

  // Restore workspace
  await prisma.workspace.update({
    where: { id: workspaceId },
    data: {
      status: 'paused', // Restore to paused state (requires re-subscription)
      deletedAt: null
    }
  })

  return NextResponse.json({ success: true })
}
```

**Hard Delete Cron Job:**
```typescript
// lib/cron/hard-delete-workspaces.ts
import cron from 'node-cron'

export function scheduleWorkspaceHardDelete() {
  // Run daily at 02:00 UTC
  cron.schedule('0 2 * * *', async () => {
    console.log('Running workspace hard delete job...')

    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)

    const workspacesToDelete = await prisma.workspace.findMany({
      where: {
        status: 'deleted',
        deletedAt: {
          lte: thirtyDaysAgo
        }
      }
    })

    console.log(`Found ${workspacesToDelete.length} workspaces to hard delete`)

    for (const workspace of workspacesToDelete) {
      try {
        // Hard delete (cascade deletes all related data)
        await prisma.workspace.delete({
          where: { id: workspace.id }
        })

        console.log(`Hard deleted workspace: ${workspace.id}`)
      } catch (error) {
        console.error(`Failed to delete workspace ${workspace.id}:`, error)
      }
    }

    console.log('Workspace hard delete job completed')
  })
}
```

**Workspace Deleted Email:**
```typescript
// components/emails/workspace-deleted.tsx
export function WorkspaceDeletedEmail({
  workspaceName
}: {
  workspaceName: string
}) {
  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          <Heading style={styles.heading}>Workspace Deleted</Heading>

          <Text style={styles.text}>
            The workspace <strong>{workspaceName}</strong> has been deleted by
            its owner.
          </Text>

          <Text style={styles.text}>
            You no longer have access to this workspace.
          </Text>

          <Hr style={styles.hr} />

          <Text style={styles.smallText}>
            If you believe this was done in error, contact the workspace owner.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}
```

**Reference:** PRD Epic 5 Story 5.8, GDPR compliance requirements, Architecture Section 12 (Multi-Tenancy)

## Testing

**Unit Tests:**
- Pause sets status to 'paused'
- Delete sets status to 'deleted' with timestamp
- Hard delete only affects workspaces deleted >30 days ago

**Integration Tests:**
- Pause workspace, verify Stripe subscription canceled
- Resume workspace, verify status returns to 'active'
- Delete workspace, verify members notified
- Restore within 30 days succeeds
- Restore after 30 days fails
- Hard delete cron removes old deleted workspaces

**Manual Testing:**
- Pause workspace, verify cannot access
- Resume workspace, verify access restored
- Delete workspace, type wrong name (should not delete)
- Delete workspace, type correct name (should delete)
- Verify notification emails sent
- Test restore within 30 days
- Mock date to 31 days later, verify hard delete

**Security Testing:**
- Non-owner cannot pause/delete workspace
- Deleted workspace data hidden from queries
- Hard delete actually removes data

**Test File:** `__tests__/features/workspace/pause-delete.test.ts`

## User vs Developer Responsibilities

**User Responsibility:**
- Understand difference between pause and delete
- Type workspace name correctly to confirm deletion
- Restore within 30-day window if needed

**Developer Responsibility:**
- Implement soft-delete (data hidden, not removed)
- Cancel Stripe subscription on pause/delete
- Send notification emails to all members
- Implement 30-day recovery period
- Hard delete after 30 days (GDPR compliance)
- Block access to paused/deleted workspaces

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
