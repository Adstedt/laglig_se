# Story 5.8: Implement Workspace Pause and Deletion

## Status

Draft

## Story

**As a** workspace owner,
**I want** to pause or delete my workspace,
**so that** I can stop paying without losing data (pause) or permanently remove everything (delete).

## Context & Dependencies

- **Depends on:** Story 5.4 (Stripe billing) — needs Stripe subscription cancellation
- **Builds on:** Story 5.1 (completed) — `WorkspaceStatus` enum (ACTIVE, PAUSED, DELETED), `paused_at`, `deleted_at` fields already exist in schema
- **Builds on:** Story 5.7 (completed) — workspace settings page (danger zone section)
- **Note:** Schema fields already exist. This story adds the UI, API endpoints, Stripe cancellation, notification emails, and GDPR hard-delete cron.

## Acceptance Criteria

### Pause Workspace

1. Settings page -> "Pausa workspace" button (danger zone)
2. Confirmation modal: "Din data bevaras men atkomst blockeras tills du ateruptar."
3. Workspace status set to "PAUSED"
4. Team members cannot access workspace
5. Stripe subscription canceled, no future charges
6. Data preserved indefinitely
7. "Aterupta workspace" button re-enables access

### Delete Workspace

8. Settings page -> "Radera workspace" button (Owner only, `workspace:delete` permission)
9. Confirmation modal requires typing workspace name
10. Workspace soft-deleted (status: "DELETED")
11. All workspace data hidden from queries
12. Email sent to all team members via Resend: "Workspace raderat"
13. 30-day recovery period (Owner can restore)
14. After 30 days, hard delete via Vercel cron job (GDPR compliance)
15. Stripe subscription canceled immediately

## Tasks / Subtasks

- [ ] Add pause/delete buttons to settings danger zone
- [ ] Create pause confirmation modal
- [ ] Implement pause workspace API endpoint
- [ ] Cancel Stripe subscription on pause
- [ ] Create "Aterupta workspace" resume API endpoint
- [ ] Create delete confirmation modal with workspace name input
- [ ] Implement soft-delete workspace API endpoint
- [ ] Send deletion notification emails to all members
- [ ] Implement 30-day recovery (restore) API endpoint
- [ ] Create hard-delete Vercel cron job
- [ ] Create React Email templates for workspace notifications
- [ ] Test pause -> resume flow
- [ ] Test delete -> restore flow

## Dev Notes

**Existing Schema (DO NOT recreate — already in place from 5.1):**

```prisma
enum WorkspaceStatus {
  ACTIVE
  PAUSED
  DELETED
}

// On Workspace model:
  status    WorkspaceStatus @default(ACTIVE)
  paused_at DateTime?
  deleted_at DateTime?
```

**Pause Workspace API:**

```typescript
// app/api/workspace/pause/route.ts
import { NextResponse } from 'next/server'
import { getWorkspaceContext } from '@/lib/auth/workspace-context'
import { requirePermission } from '@/lib/api/require-permission'
import { prisma } from '@/lib/prisma'
import { stripe } from '@/lib/stripe/config'

export async function POST() {
  const denied = await requirePermission('workspace:settings')
  if (denied) return denied

  const context = await getWorkspaceContext()

  const workspace = await prisma.workspace.findUnique({
    where: { id: context.workspaceId },
    select: { stripeSubscriptionId: true },
  })

  // Pause workspace
  await prisma.workspace.update({
    where: { id: context.workspaceId },
    data: { status: 'PAUSED', paused_at: new Date() },
  })

  // Cancel Stripe subscription
  if (workspace?.stripeSubscriptionId) {
    await stripe.subscriptions.cancel(workspace.stripeSubscriptionId)
  }

  // Invalidate Redis cache for all workspace members
  // ... (invalidate auth:context:* keys for this workspace)

  return NextResponse.json({ success: true })
}
```

**Resume Workspace API:**

```typescript
// app/api/workspace/resume/route.ts
export async function POST() {
  const denied = await requirePermission('workspace:settings')
  if (denied) return denied

  const context = await getWorkspaceContext()

  await prisma.workspace.update({
    where: { id: context.workspaceId },
    data: { status: 'ACTIVE', paused_at: null },
  })

  // Note: User must re-subscribe via billing page

  return NextResponse.json({ success: true })
}
```

**Delete Workspace API:**

```typescript
// app/api/workspace/delete/route.ts
import { sendEmail } from '@/lib/email/email-service'
import { WorkspaceDeletedEmail } from '@/components/emails/workspace-deleted'

export async function POST() {
  const denied = await requirePermission('workspace:delete')
  if (denied) return denied

  const context = await getWorkspaceContext()

  const workspace = await prisma.workspace.findUnique({
    where: { id: context.workspaceId },
    select: { stripeSubscriptionId: true, name: true },
  })

  // Soft delete
  await prisma.workspace.update({
    where: { id: context.workspaceId },
    data: { status: 'DELETED', deleted_at: new Date() },
  })

  // Cancel Stripe
  if (workspace?.stripeSubscriptionId) {
    await stripe.subscriptions.cancel(workspace.stripeSubscriptionId)
  }

  // Notify all members
  const members = await prisma.workspaceMember.findMany({
    where: { workspace_id: context.workspaceId },
    include: { user: { select: { email: true } } },
  })

  for (const member of members) {
    await sendEmail({
      to: member.user.email,
      subject: `Workspace raderat: ${workspace!.name}`,
      react: WorkspaceDeletedEmail({ workspaceName: workspace!.name }),
      from: 'notifications',
    })
  }

  return NextResponse.json({ success: true })
}
```

**Restore Workspace API:**

```typescript
// app/api/workspace/restore/route.ts
import { getServerSession } from '@/lib/auth/session'

export async function POST(request: Request) {
  const session = await getServerSession()
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { workspaceId } = await request.json()

  const workspace = await prisma.workspace.findFirst({
    where: { id: workspaceId, owner_id: session.user.id, status: 'DELETED' },
  })

  if (!workspace) {
    return NextResponse.json({ error: 'Workspace hittades inte' }, { status: 404 })
  }

  const daysSinceDeletion = Math.floor(
    (Date.now() - workspace.deleted_at!.getTime()) / (1000 * 60 * 60 * 24)
  )

  if (daysSinceDeletion > 30) {
    return NextResponse.json({ error: 'Aterhamtningsperioden har gatt ut' }, { status: 400 })
  }

  await prisma.workspace.update({
    where: { id: workspaceId },
    data: { status: 'PAUSED', deleted_at: null },
  })

  return NextResponse.json({ success: true })
}
```

**Hard Delete Cron (Vercel):**

```typescript
// app/api/cron/hard-delete-workspaces/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'

export const dynamic = 'force-dynamic'
export const maxDuration = 300

const CRON_SECRET = process.env.CRON_SECRET

export async function GET(request: Request) {
  const authHeader = request.headers.get('authorization')
  if (process.env.NODE_ENV !== 'development' && CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)

  const workspacesToDelete = await prisma.workspace.findMany({
    where: { status: 'DELETED', deleted_at: { lte: thirtyDaysAgo } },
  })

  console.log(`[HARD-DELETE] Found ${workspacesToDelete.length} workspaces to permanently delete`)

  let deleted = 0
  let failed = 0

  for (const workspace of workspacesToDelete) {
    try {
      await prisma.workspace.delete({ where: { id: workspace.id } })
      deleted++
      console.log(`[HARD-DELETE] Deleted workspace: ${workspace.id} (${workspace.name})`)
    } catch (error) {
      failed++
      console.error(`[HARD-DELETE] Failed to delete workspace ${workspace.id}:`, error)
    }
  }

  console.log(`[HARD-DELETE] Completed: ${deleted} deleted, ${failed} failed`)

  return NextResponse.json({ success: true, deleted, failed })
}
```

Add to `vercel.json`:
```json
{ "path": "/api/cron/hard-delete-workspaces", "schedule": "0 2 * * *" }
```

**Reference:** Story 5.1 (workspace status enums), Story 5.4 (Stripe cancellation), `lib/auth/permissions.ts` (`workspace:delete`, `workspace:settings`), `lib/email/email-service.ts`

## Testing

**Unit Tests:**

- Pause sets status to PAUSED with timestamp
- Delete sets status to DELETED with timestamp
- Hard delete only affects workspaces deleted >30 days ago

**Integration Tests:**

- Pause workspace, verify Stripe subscription canceled
- Resume workspace, verify status returns to ACTIVE
- Delete workspace, verify all members notified
- Restore within 30 days succeeds
- Restore after 30 days fails
- Hard delete cron removes old deleted workspaces

**Security Tests:**

- Non-owner cannot delete workspace (needs `workspace:delete`)
- MEMBER cannot pause workspace (needs `workspace:settings`)
- Deleted workspace data hidden from queries

**Test File:** `tests/unit/api/workspace-pause-delete.test.ts`

## Change Log

| Date       | Version | Description                                          | Author     |
| ---------- | ------- | ---------------------------------------------------- | ---------- |
| 2025-11-12 | 1.0     | Initial story creation                               | Sarah (PO) |
| 2026-02-19 | 2.0     | Updated auth/cron/email patterns, noted existing schema | Sarah (PO) |

## Dev Agent Record

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
