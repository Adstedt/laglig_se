schema: 1
story: '14.3'
story_title: 'Embedding Generation Pipeline'
gate: PASS
status_reason: 'All 17 ACs implemented and covered by 40 passing tests. Well-architected embedding pipeline with batch API support, graceful degradation, and strong resume-on-failure semantics. No blocking issues.'
reviewer: 'Quinn (Test Architect)'
updated: '2026-02-26T22:10:00Z'

waiver: { active: false }

top_issues:
  - id: 'CODE-001'
    severity: low
    finding: 'SQL string interpolation via Prisma.raw() in batch script (generate-embeddings.ts lines 315-340, 624). CLI-only so no real attack surface, but violates parameterized query best practice.'
    suggested_owner: dev
    suggested_action: 'Refactor to use Prisma.sql tagged templates with proper parameter binding.'
    refs: ['scripts/generate-embeddings.ts:315-340', 'scripts/generate-embeddings.ts:624']
  - id: 'CODE-002'
    severity: low
    finding: 'Unused batch pricing constants (_HAIKU_BATCH_INPUT_COST_PER_M, _HAIKU_BATCH_OUTPUT_COST_PER_M) are dead code.'
    suggested_owner: dev
    suggested_action: 'Remove or integrate into --estimate mode for batch pricing display.'
    refs: ['scripts/generate-embeddings.ts:79-80']
  - id: 'CODE-003'
    severity: low
    finding: 'SET statement_timeout on pooled connection (line 621) is ineffective without $transaction wrapping, as documented in the operational notes.'
    suggested_owner: dev
    suggested_action: 'Wrap in $transaction or remove if not needed.'
    refs: ['scripts/generate-embeddings.ts:621']

quality_score: 95
expires: '2026-03-12T22:10:00Z'

evidence:
  tests_reviewed: 40
  risks_identified: 0
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17]
    ac_gaps: []

nfr_validation:
  security:
    status: PASS
    notes: 'API keys sourced from environment variables. SQL interpolation only in CLI scripts (not user-facing). Rerank uses Bearer token auth correctly.'
  performance:
    status: PASS
    notes: 'Bulk SQL writes (5x speedup), batch API (50% cost savings), proper rate limiting, HNSW index auto-recreation. Well-optimized for the data scale.'
  reliability:
    status: PASS
    notes: 'Resume-on-failure with crash-safe cursor files. 5-consecutive-failure abort threshold. Non-blocking embedding in sync path. Graceful degradation in rerank.'
  maintainability:
    status: PASS
    notes: 'Clean module separation (context-prefixes, embed-chunks, rerank). DI pattern for testability. Well-documented operational notes. Barrel exports.'

recommendations:
  immediate: []
  future:
    - action: 'Refactor raw SQL string interpolation in batch script to use parameterized queries'
      refs: ['scripts/generate-embeddings.ts:315-340']
    - action: 'Remove unused batch pricing constants or integrate into cost estimation'
      refs: ['scripts/generate-embeddings.ts:79-80']
    - action: 'Add unit test for parsePrefixResponse fallback (malformed JSON line-by-line extraction)'
      refs: ['lib/chunks/generate-context-prefixes.ts:621-635']
    - action: 'Add unit test for buildEmbeddingInput truncation at MAX_EMBEDDING_CHARS boundary'
      refs: ['lib/chunks/embed-chunks.ts:59-61']
