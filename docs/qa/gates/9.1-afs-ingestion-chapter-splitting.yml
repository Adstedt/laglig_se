schema: 1
story: '9.1'
story_title: 'AFS Ingestion & Chapter Splitting'
gate: PASS
status_reason: >
  All 50 ACs verified via 111 passing tests + live ingestion of 81 DB entries.
  Deep code review confirms clean 4-module architecture with no bugs, security issues, or performance concerns.
  TOC sidebar component reviewed as addendum — functional and well-structured but lacks tests (non-blocking, tracked as follow-up).
reviewer: 'Quinn (Test Architect)'
updated: '2026-02-12T14:00:00Z'

waiver: { active: false }

top_issues:
  - id: 'TOC-001'
    severity: medium
    finding: 'StickyDocNav (348 lines) has zero unit tests — heading extraction, visibility logic, and scrollspy are untested'
    suggested_action: 'Add component tests for the three heading strategies, auto-hide logic, and scroll tracking'
    suggested_owner: dev
  - id: 'TOC-002'
    severity: low
    finding: 'Two TOC systems coexist on law pages (LawTableOfContents + StickyDocNav), creating duplicate scroll listeners'
    suggested_action: 'Deprecate LawTableOfContents or scope to mobile-only context'
    suggested_owner: dev
  - id: 'DEBT-001'
    severity: low
    finding: 'Pre-existing afs-prompt.test.ts has 1 failing test on superseded code'
    suggested_action: 'Fix or remove the failing test and superseded afs-prompt.ts module'
    suggested_owner: dev

quality_score: 90
expires: '2026-02-26T14:00:00Z'

evidence:
  tests_reviewed: 111
  risks_identified: 3
  trace:
    ac_covered: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50]
    ac_gaps: []

risk_summary:
  totals: { critical: 0, high: 0, medium: 1, low: 2 }
  recommendations:
    must_fix: []
    monitor:
      - 'StickyDocNav has no tests — track for next UI story'
      - 'Two coexisting TOC systems create redundant scroll overhead'
      - 'Pre-existing afs-prompt.test.ts failing test should be cleaned up'

nfr_validation:
  security:
    status: PASS
    notes: 'Public government data only. Prisma ORM. Rate limiting. HTML escaping. CSS.escape() for TOC selectors.'
  performance:
    status: PASS
    notes: 'Pipeline: 39.7s/$0/idempotent. TOC: RAF debouncing, ResizeObserver appropriate. Minor: duplicate scroll listeners from two TOC components.'
  reliability:
    status: PASS
    notes: 'Retry with exponential backoff. Transaction atomicity. Resumable via --skip-existing. TOC gracefully hides on edge cases.'
  maintainability:
    status: PASS
    notes: 'Clean 4-module pipeline architecture. 111 tests. Registry SSOT. Well-typed. TOC uses 3-strategy pattern with clean fallback chain.'

history:
  - at: '2026-02-12T11:00:00Z'
    gate: PASS
    note: 'Initial review — all 50 ACs verified, 100 tests (corrected to 105/111)'
  - at: '2026-02-12T14:00:00Z'
    gate: PASS
    note: 'Deep second pass — code-level review of all source files + TOC component review. 3 non-blocking issues identified.'

recommendations:
  immediate: []
  future:
    - action: 'Add unit tests for StickyDocNav component (heading strategies, visibility, scrollspy)'
      refs: ['components/features/paragraf-toc.tsx']
    - action: 'Add aria-current to active TOC item for accessibility'
      refs: ['components/features/paragraf-toc.tsx:311']
    - action: 'Consolidate or scope the two TOC systems (LawTableOfContents vs StickyDocNav)'
      refs: ['app/(public)/lagar/[id]/toc-client.tsx', 'components/features/paragraf-toc.tsx']
    - action: 'Fix or remove failing test in superseded afs-prompt.test.ts'
      refs: ['tests/unit/lib/agency/afs-prompt.test.ts']
    - action: 'Remove vestigial extractionStrategy field from AfsDocument type'
      refs: ['lib/agency/afs-registry.ts']
    - action: 'Add general-provisions-preamble CSS class to legal-document stylesheet'
      refs: ['app/globals.css']
    - action: 'Consider typed adapter for pipeline metadata instead of as unknown casts'
      refs: ['scripts/ingest-afs-regulations-v2.ts']
